# ── docker-compose.yml ───────────────────────────────────────
# Full Σ OVERWATCH local stack.
#
#   docker compose up --build              # dashboard + exhaust
#   docker compose up overwatch            # dashboard only
#   docker compose up exhaust              # exhaust service only
#   docker compose --profile cli run \
#     coherence score /data/episodes.json  # one-shot CLI
#
# Mount a local data/ directory to feed real episode/drift JSON
# files to the services, or leave it empty to use mock data.
# ─────────────────────────────────────────────────────────────

services:
  overwatch:
    build:
      context: .
      dockerfile: Dockerfile
    image: ghcr.io/8ryanwh1t3/deepsigma-dashboard:local
    container_name: overwatch-dashboard
    ports:
      - "3000:3000"
    volumes:
      - ./data:/app/data:ro
    environment:
      - PYTHONPATH=/app
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  exhaust:
    build:
      context: .
      dockerfile: Dockerfile.exhaust
    image: ghcr.io/8ryanwh1t3/deepsigma-exhaust:local
    container_name: overwatch-exhaust
    ports:
      - "8001:8001"
    volumes:
      - ./data:/app/data
    environment:
      - PYTHONPATH=/app
      - EXHAUST_USE_LLM=0
      # Uncomment and set to enable LLM-backed extraction:
      # - ANTHROPIC_API_KEY=sk-ant-...
      # - EXHAUST_USE_LLM=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c",
             "import urllib.request; urllib.request.urlopen('http://localhost:8001/healthz')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  coherence:
    build:
      context: .
      dockerfile: Dockerfile.coherence
    image: ghcr.io/8ryanwh1t3/deepsigma-coherence:local
    container_name: overwatch-coherence
    volumes:
      - ./data:/data
    environment:
      - PYTHONPATH=/app
    profiles:
      - cli
    # Override command at runtime:
    #   docker compose --profile cli run coherence score /data/episodes.json --json
    #   docker compose --profile cli run coherence audit /data/
    #   docker compose --profile cli run coherence iris query /data/ --type STATUS
    command: ["--help"]

  otel-sidecar:
    build:
      context: .
      dockerfile: Dockerfile.otel
      args:
        INSTALL_OTLP: grpc
    image: ghcr.io/8ryanwh1t3/deepsigma-otel:local
    container_name: overwatch-otel-sidecar
    volumes:
      - ./data:/app/data
    environment:
      - PYTHONPATH=/app
      - OTEL_SERVICE_NAME=sigma-overwatch
      # Set to your OTLP collector (e.g. http://otel-collector:4317):
      - OTEL_EXPORTER_OTLP_ENDPOINT=
      - SIDECAR_POLL_INTERVAL=5
    profiles:
      - otel
    restart: unless-stopped

  tools:
    build:
      context: .
      dockerfile: Dockerfile.tools
    image: ghcr.io/8ryanwh1t3/deepsigma-tools:local
    container_name: overwatch-tools
    volumes:
      - ./data:/data
      - ./policy_packs:/app/policy_packs:ro
    environment:
      - PYTHONPATH=/app
    profiles:
      - cli
    # Override command at runtime:
    #   docker compose --profile cli run tools overwatch --decisionType X --policy /app/policy_packs/packs/demo_policy_pack_v1.json --out /data
    #   docker compose --profile cli run tools overwatch-validate
    #   docker compose --profile cli run tools overwatch-replay --episode /data/ep_001.json

  golden-path:
    build:
      context: .
      dockerfile: Dockerfile.tools
    image: ghcr.io/8ryanwh1t3/deepsigma-tools:local
    container_name: overwatch-golden-path
    volumes:
      - ./out:/app/out
    environment:
      - PYTHONPATH=/app
    profiles:
      - golden-path
    # Run the fixture Golden Path:
    #   docker compose --profile golden-path run --rm golden-path
    command: ["deepsigma", "golden-path", "sharepoint", "--fixture", "/app/demos/golden_path/fixtures/sharepoint_small", "--out", "/app/out", "--clean"]
