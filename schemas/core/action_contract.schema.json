{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://sigma-overwatch.dev/schemas/action_contract.schema.json",
  "title": "Safe Action Contract",
  "type": "object",
  "additionalProperties": false,
  "required": ["actionId", "actionType", "blastRadiusTier", "targetRefs", "constraints", "authorization", "idempotencyKey", "rollbackPlan"],
  "properties": {
    "actionId": { "type": "string", "minLength": 1 },
    "actionType": { "type": "string", "minLength": 1 },
    "blastRadiusTier": { "type": "string", "enum": ["tiny", "small", "medium", "large"] },
    "targetRefs": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["type", "id"],
        "properties": { "type": { "type": "string" }, "id": { "type": "string" } }
      }
    },
    "preconditions": {
      "type": "array",
      "items": { "type": "object" },
      "description": "Declarative checks that must be satisfied before dispatch (e.g., TTL ok, state matches)."
    },
    "constraints": { "type": "object", "description": "Policy/budget/scope constraints for execution (rate limits, scope bounds, change windows)." },
    "authorization": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode"],
      "properties": {
        "mode": { "type": "string", "enum": ["auto", "hitl", "blocked"] },
        "policyRef": { "type": "string" },
        "approver": { "type": "string" }
      }
    },
    "idempotencyKey": { "type": "string", "minLength": 1 },
    "rollbackPlan": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type"],
      "properties": {
        "type": { "type": "string", "enum": ["none", "compensate", "restore", "revert"] },
        "instructions": { "type": "object" },
        "timeoutMs": { "type": "integer", "minimum": 0 }
      }
    },
    "execution": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "executionSloMs": { "type": "integer", "minimum": 0 },
        "timeoutMs": { "type": "integer", "minimum": 0 },
        "retryPolicy": {
          "type": "object",
          "additionalProperties": false,
          "properties": { "maxRetries": { "type": "integer", "minimum": 0 }, "backoffMs": { "type": "integer", "minimum": 0 } }
        }
      }
    }
  }
}
