# Connector Fixture Library

**Status:** Active
**Since:** v0.6.0

---

## Philosophy

Every connector in DeepSigma has deterministic, offline fixture data that proves the full pipeline without credentials or network access. Fixtures serve three purposes:

1. **CI gates** — run on every PR, catch regressions in connector behavior
2. **Golden-file testing** — expected outputs are committed; any drift is a deliberate change
3. **Onboarding** — new contributors can run the full pipeline in seconds

---

## Structure

```
tests/fixtures/connectors/
├── sharepoint_small/
│   ├── baseline_raw.json          # Raw Graph API list items (5 records)
│   ├── delta_raw.json             # Changed items (for drift testing)
│   └── expected_envelopes.jsonl   # Golden envelopes (generated)
├── dataverse_small/
│   ├── baseline_raw.json          # Raw Dataverse rows (5 records)
│   ├── delta_raw.json             # Changed rows
│   └── expected_envelopes.jsonl
├── snowflake_small/
│   ├── baseline_raw.json          # Raw SQL result rows (5 records)
│   ├── delta_raw.json             # Changed rows
│   └── expected_envelopes.jsonl
└── asksage_small/
    ├── baseline_raw.json          # Canonical records (5 records)
    ├── delta_raw.json             # Changed records
    └── expected_envelopes.jsonl
```

### File Descriptions

| File | Format | Description |
|------|--------|-------------|
| `baseline_raw.json` | JSON array | Raw source data as it would arrive from the API |
| `delta_raw.json` | JSON array | Modified data for drift detection (changed/added/removed records) |
| `expected_envelopes.jsonl` | JSONL | One RecordEnvelope per line, generated by the fixture tool |

---

## Regenerating Fixtures

When connector behavior changes (e.g., field mapping, hash algorithm), regenerate:

```bash
# All connectors
python tools/generate_connector_fixtures.py

# Single connector
python tools/generate_connector_fixtures.py --connector sharepoint_small
```

The generator:
1. Reads `baseline_raw.json`
2. Runs the connector's transform pipeline
3. Wraps records in `RecordEnvelope` (Connector Contract v1.0)
4. Validates all envelopes against the JSON schema
5. Writes `expected_envelopes.jsonl` (sorted keys, one per line)

**Important:** After regenerating, review the diff. Any change in expected output should be intentional and documented.

---

## Running Tests

```bash
# Fixture comparison tests
pytest tests/test_connector_fixtures.py -v

# Contract + fixture tests together
pytest tests/test_connector_contract_v1.py tests/test_connector_fixtures.py -v
```

---

## Adding a New Connector Fixture

1. Create `tests/fixtures/connectors/<name>_small/`
2. Add `baseline_raw.json` with 3-5 representative records in the source's native format
3. Add `delta_raw.json` with mutations (changed, added, removed records)
4. Add a transformer function in `tools/generate_connector_fixtures.py`
5. Run `python tools/generate_connector_fixtures.py --connector <name>_small`
6. Add test class in `tests/test_connector_fixtures.py`
7. Add connector name to `TestCrossConnector.CONNECTORS`

---

## Design Decisions

- **JSONL for golden files**: One envelope per line means diffs show exactly which record changed
- **Fixed `collected_at`**: All generated envelopes use `2026-02-18T12:00:00+00:00` for determinism
- **No secrets in fixtures**: Raw data is hand-crafted or recorded with PII removed
- **Separate raw vs canonical**: SharePoint/Dataverse/Snowflake fixtures use raw API format; AskSage uses canonical (since its output is already structured)
