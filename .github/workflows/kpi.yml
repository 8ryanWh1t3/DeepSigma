name: Repo Radar KPI

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: read
  pull-requests: write

jobs:
  kpi:
    runs-on: ubuntu-latest
    env:
      MPLCONFIGDIR: .cache/matplotlib
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install KPI dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/locks/kpi.txt
          pip install pyyaml

      - name: Milestone gate (v2.1.0)
        continue-on-error: true
        run: make milestone-gate

      - name: Issue label gate
        run: make issue-label-gate

      - name: KPI issue deltas
        run: make kpi-issues

      - name: Roadmap gate
        run: make roadmap-gate

      - name: Pulse insights
        run: make pulse-insights

      - name: Run KPI
        id: run-kpi
        run: make kpi

      - name: Commit KPI results
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add enterprise/release_kpis/
          git add pilot_pack/ || true
          git diff --cached --quiet || git commit -m "chore(kpi): update release_kpis [skip ci]"
          git push

      - name: Upload KPI artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repo-kpi
          path: |
            enterprise/release_kpis/PR_COMMENT.md
            enterprise/release_kpis/KPI_GATE_REPORT.md
            enterprise/release_kpis/ISSUE_LABEL_GATE_REPORT.md
            enterprise/release_kpis/ROADMAP_SCOPE_GATE_REPORT.md
            enterprise/release_kpis/kpi_confidence.json
            enterprise/release_kpis/kpi_bands_*.json
            enterprise/release_kpis/history.json
            enterprise/release_kpis/issue_deltas.json
            enterprise/release_kpis/insights_metrics.json
            enterprise/release_kpis/badge_latest.svg
            enterprise/release_kpis/roadmap_badge.svg
            enterprise/release_kpis/roadmap_forecast.json
            enterprise/release_kpis/roadmap_forecast.md
            enterprise/release_kpis/roadmap_timeline.svg
            enterprise/release_kpis/roadmap_timeline.md
            enterprise/release_kpis/stability_*.json
            enterprise/release_kpis/stability_simulation_*.json
            enterprise/release_kpis/stability_adjusted_forecast.json
            enterprise/release_kpis/nonlinear_stability_report.md
            enterprise/release_kpis/kpi_trend.png
            enterprise/release_kpis/kpi_trend.svg
            enterprise/release_kpis/radar_*.png
            enterprise/release_kpis/radar_*.svg
            enterprise/release_kpis/radar_composite_latest.md
            enterprise/release_kpis/kpi_*merged.json
            pilot_pack/**

      - name: Post PR comment (Repo KPI)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('enterprise/release_kpis/PR_COMMENT.md', 'utf8');
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const marker = "## Repo Radar KPI â€”";
            const comments = await github.rest.issues.listComments({ owner, repo, issue_number, per_page: 100 });
            const existing = comments.data.find(c => c.body && c.body.startsWith(marker));
            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }
