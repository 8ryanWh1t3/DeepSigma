name: No Duplicate-Like Filenames

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  no-dupes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Check duplicate-like filenames
        run: |
          python - <<'PY'
          from pathlib import Path

          root = Path(".")
          skip_prefixes = (".git/", "enterprise/")
          seen = {}
          collisions = []

          for p in root.rglob("*"):
              if not p.is_file():
                  continue
              rel = p.as_posix()
              if rel.startswith(skip_prefixes):
                  continue
              # Detect only same-directory case-insensitive dupes; allow
              # normal cross-directory names like README.md.
              parent = p.parent.as_posix().lower()
              norm = p.name.lower()
              key = (parent, norm)
              if key in seen:
                  collisions.append((seen[key], rel))
              else:
                  seen[key] = rel

          if collisions:
              print("FAIL: duplicate-like filenames detected:")
              for a, b in collisions:
                  print(f" - {a} <-> {b}")
              raise SystemExit(1)

          print("PASS: no duplicate-like filenames")
          PY
