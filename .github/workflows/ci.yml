name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    name: Unit Tests (py${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        include:
          - os: windows-latest
            python-version: "3.12"
          - os: windows-latest
            python-version: "3.13"

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,excel]" pydantic

      - name: Install RDF extra (py3.12 Linux only)
        if: matrix.python-version == '3.12' && runner.os == 'Linux'
        run: pip install -e ".[rdf]"

      - name: Run unit tests with coverage (Linux)
        if: runner.os == 'Linux'
        run: |
          python -m pytest tests/ -v --tb=short -m "not benchmark" --cov=coherence_ops --cov=engine --cov-report=term-missing --ignore=tests/test_integration.py --ignore=tests/test_load.py --ignore=tests/test_benchmarks.py --ignore=tests/test_golden_path.py --ignore=tests/test_trust_scorecard.py --ignore=tests/test_shacl_claim.py

      - name: Run unit tests with coverage (Windows)
        if: runner.os == 'Windows'
        run: |
          python -m pytest tests/ -v --tb=short -m "not benchmark" --cov=coherence_ops --cov=engine --cov-report=term-missing --ignore=tests/test_integration.py --ignore=tests/test_load.py --ignore=tests/test_benchmarks.py --ignore=tests/test_golden_path.py --ignore=tests/test_trust_scorecard.py --ignore=tests/test_iris.py --ignore=tests/test_langchain_governance.py

  integration-tests:
    name: Integration & Demo Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,excel]"

      - name: Run integration tests
        run: |
          python -m pytest tests/test_integration.py tests/test_load.py -v --tb=short

      - name: Golden Path fixture gate
        run: |
          python -m demos.golden_path --source sharepoint --fixture demos/golden_path/fixtures/sharepoint_small --output golden_path_ci_out --json
          python -m pytest tests/test_golden_path.py -v --tb=short

      - name: Generate Trust Scorecard
        run: |
          python -m tools.trust_scorecard --input golden_path_ci_out --output trust_scorecard.json
          cat trust_scorecard.json
          python -m pytest tests/test_trust_scorecard.py -v --tb=short

      - name: Run Money Demo contract test
        run: |
          python -m pytest tests/test_money_demo.py -v --tb=short

      - name: Excel-first Money Demo
        run: |
          python -m demos.excel_first --out excel_first_demo_out
          python -m pytest tests/test_excel_first_money_demo.py -v --tb=short

      - name: Validate BOOT contract
        run: |
          python tools/validate_workbook_boot.py templates/creative_director_suite/Creative_Director_Suite_CoherenceOps_v2.xlsx
          python -m pytest tests/test_workbook_boot_validator.py -v --tb=short

      - name: MDPT Prompt Index gate
        run: |
          python mdpt/tools/generate_prompt_index.py --csv tests/fixtures/promptcapabilities_export.csv --out mdpt_index_ci_out
          python -m pytest tests/test_mdpt_index_generator.py -v --tb=short

  validation-gates:
    name: Validation Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,excel]"

      - name: Validate examples against schemas
        run: |
          python tools/validate_examples.py

      - name: Validate LLM Data Model examples
        run: |
          python docs/llm_data_model/05_validation/validate_examples.py

      - name: Connector contract + fixture tests
        run: |
          python -m pytest tests/test_connector_contract_v1.py tests/test_connector_fixtures.py -v --tb=short

      - name: Product CLI smoke test
        run: |
          python -m deepsigma.cli.main doctor --json
          python -m pytest tests/test_cli_smoke.py -v --tb=short

  benchmarks:
    name: Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run benchmarks
        run: |
          python -m pytest tests/test_benchmarks.py -v --tb=short -m benchmark

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run ruff check
        run: |
          ruff check . --select E,F,W --ignore E501


  dashboard-build:
    name: Dashboard TypeScript Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: dashboard
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'
          cache-dependency-path: dashboard/package-lock.json
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci --ignore-scripts; else npm install; fi
      - name: Type-check and build
        run: npm run build
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-dist
          path: dashboard/dist/
          retention-days: 5

  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, validation-gates, lint, dashboard-build]
    if: startsWith(github.ref, 'refs/tags/v')
    environment: pypi
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Build package
        run: python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
