name: DeepSigma CI (CORE + ENTERPRISE)

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  core:
    name: CORE (always)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install CORE
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Guardrails
        run: |
          make edition-guard
          make secret-scan

      - name: Type check
        run: pyright src/core/

      - name: Verify release artifacts
        run: make verify-release-artifacts

      - name: CORE demo + baseline + tests
        run: |
          make core-ci

  enterprise:
    name: ENTERPRISE (optional)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.title, '[enterprise]')
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install ENTERPRISE
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install -e "./enterprise[dev]"

      - name: Guardrails
        run: |
          make edition-guard
          make secret-scan

      - name: ENTERPRISE demo + tests
        run: |
          make enterprise-ci

      - name: Scalability regression gate
        run: make scalability-gate

      - name: Audit-neutral pack self-check
        run: python enterprise/scripts/export_audit_neutral_pack.py --self-check

      - name: Release readiness self-check
        run: python enterprise/scripts/release_check.py --self-check

      - name: Helm chart lint
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm lint enterprise/charts/deepsigma/
