name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
permissions:
  contents: read

jobs:
  unit-tests:
    name: Unit Tests (py${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        include:
          - os: windows-latest
            python-version: "3.12"
          - os: windows-latest
            python-version: "3.13"

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -c requirements/locks/dev-excel-local.txt -e ".[dev,excel,local]" pydantic

      - name: Install RDF extra (py3.12 Linux only)
        if: matrix.python-version == '3.12' && runner.os == 'Linux'
        run: pip install -c requirements/locks/rdf.txt -e ".[rdf]"

      - name: Run unit tests with coverage (Linux)
        if: runner.os == 'Linux'
        run: |
          python -m pytest tests/ -v --tb=short -m "not benchmark" --cov=core --cov=engine --cov-report=term-missing --ignore=tests/test_integration.py --ignore=tests/test_load.py --ignore=tests/test_benchmarks.py --ignore=tests/test_golden_path.py --ignore=tests/test_trust_scorecard.py --ignore=tests/test_shacl_claim.py

      - name: Run unit tests with coverage (Windows)
        if: runner.os == 'Windows'
        run: |
          python -m pytest tests/ -v --tb=short -m "not benchmark" --cov=core --cov=engine --cov-report=term-missing --ignore=tests/test_integration.py --ignore=tests/test_load.py --ignore=tests/test_benchmarks.py --ignore=tests/test_golden_path.py --ignore=tests/test_trust_scorecard.py --ignore=tests/test_iris.py --ignore=tests/test_langchain_governance.py

  integration-tests:
    name: Integration & Demo Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -c requirements/locks/dev-excel-local.txt -e ".[dev,excel]"

      - name: Run integration tests
        run: |
          python -m pytest tests/test_integration.py tests/test_load.py -v --tb=short

      - name: Golden Path fixture gate
        run: |
          python -m demos.golden_path --source sharepoint --fixture src/demos/golden_path/fixtures/sharepoint_small --output golden_path_ci_out --json
          python -m pytest tests/test_golden_path.py -v --tb=short

      - name: Generate Trust Scorecard
        run: |
          python -m tools.trust_scorecard --input golden_path_ci_out --output trust_scorecard.json
          cat trust_scorecard.json
          python -m pytest tests/test_trust_scorecard.py -v --tb=short

      - name: Run Money Demo contract test
        run: |
          python -m pytest tests/test_money_demo.py -v --tb=short

      - name: Excel-first Money Demo
        run: |
          python -m demos.excel_first --out excel_first_demo_out
          python -m pytest tests/test_excel_first_money_demo.py -v --tb=short

      - name: Validate BOOT contract
        run: |
          python src/tools/validate_workbook_boot.py artifacts/templates/creative_director_suite/Creative_Director_Suite_CoherenceOps_v2.xlsx
          python -m pytest tests/test_workbook_boot_validator.py -v --tb=short

      - name: MDPT Prompt Index gate
        run: |
          python src/mdpt/tools/generate_prompt_index.py --csv tests/fixtures/promptcapabilities_export.csv --out mdpt_index_ci_out
          python -m pytest tests/test_mdpt_index_generator.py -v --tb=short

  validation-gates:
    name: Validation Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -c requirements/locks/dev-excel-local.txt -e ".[dev,excel]"

      - name: Enforce version sync (pyproject vs release_kpis/VERSION.txt)
        run: make version-sync-check

      - name: Milestone Gate (v2.1.0 hardening)
        run: make milestone-gate

      - name: Validate examples against schemas
        run: |
          python src/tools/validate_examples.py

      - name: Validate LLM Data Model examples
        run: |
          python docs/llm_data_model/05_validation/validate_examples.py

      - name: Connector contract + fixture tests
        run: |
          python -m pytest tests/test_connector_contract_v1.py tests/test_connector_fixtures.py -v --tb=short

      - name: Product CLI smoke test
        run: |
          python -m deepsigma.cli.main doctor --json
          python -m pytest tests/test_cli_smoke.py -v --tb=short

      - name: Mermaid diagram audit
        run: python src/tools/mermaid_audit.py

  benchmarks:
    name: Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -c requirements/locks/dev-excel-local.txt -e ".[dev]"

      - name: Run benchmarks
        run: |
          python -m pytest tests/test_benchmarks.py -v --tb=short -m benchmark

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install -c requirements/locks/dev-excel-local.txt ruff

      - name: Run ruff check
        run: |
          ruff check . --select E,F,W --ignore E501


  dashboard-build:
    name: Dashboard TypeScript Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: dashboard
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'
          cache-dependency-path: dashboard/package-lock.json
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci --ignore-scripts; else npm install; fi
      - name: Type-check and build
        run: npm run build
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-dist
          path: dashboard/dist/
          retention-days: 5

  release-preflight:
    name: Release Preflight (tag integrity)
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: 'pip'
      - name: Validate release metadata + tag points to main HEAD
        run: make release-check-strict

  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, validation-gates, lint, dashboard-build, release-preflight]
    if: startsWith(github.ref, 'refs/tags/v')
    environment: pypi
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install -c requirements/locks/release-build.txt build

      - name: Validate release metadata
        run: make release-check

      - name: Build package
        run: make build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  release-artifacts:
    name: Release Artifacts + GHCR
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, validation-gates, lint, dashboard-build, release-preflight]
    if: startsWith(github.ref, 'refs/tags/v')
    outputs:
      image_digest: ${{ steps.build-image.outputs.digest }}
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ghcr.io/8ryanwh1t3/deepsigma
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install -c requirements/locks/release-build.txt build sigstore

      - name: Validate release metadata
        run: make release-check

      - name: Build wheel and sdist
        run: make build

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate source SBOM (CycloneDX)
        run: |
          syft dir:. -o cyclonedx-json=dist/deepsigma-${{ github.ref_name }}-source.sbom.cdx.json

      - name: Sign release artifacts (Sigstore)
        run: |
          python -m sigstore sign --output-directory dist --overwrite dist/*.whl dist/*.tar.gz

      - name: Generate SLSA provenance attestations (dist)
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: "dist/*"

      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
          fail_on_unmatched_files: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest
          labels: |
            org.opencontainers.image.sbom=deepsigma-${{ github.ref_name }}-image.sbom.spdx.json
            org.opencontainers.image.sbom.source=deepsigma-${{ github.ref_name }}-source.sbom.cdx.json

      - name: Build and push Docker image
        id: build-image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Sign Docker image (Cosign keyless)
        uses: sigstore/cosign-installer@v3.8.1

      - name: Cosign sign published image digest
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes "${{ env.IMAGE_NAME }}@${{ steps.build-image.outputs.digest }}"

      - name: Generate image SBOM (SPDX)
        run: |
          syft "${{ env.IMAGE_NAME }}@${{ steps.build-image.outputs.digest }}" \
            -o spdx-json=dist/deepsigma-${{ github.ref_name }}-image.sbom.spdx.json

      - name: Generate SLSA provenance attestation (container image)
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.build-image.outputs.digest }}
          push-to-registry: true

      - name: Upload release evidence bundle
        uses: actions/upload-artifact@v4
        with:
          name: release-evidence-${{ github.ref_name }}
          path: dist/*

  verify-release-supply-chain:
    name: Verify release signatures + attestations
    runs-on: ubuntu-latest
    needs: [release-artifacts]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      id-token: write
    env:
      IMAGE_NAME: ghcr.io/8ryanwh1t3/deepsigma
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install verify tools
        run: |
          python -m pip install --upgrade pip
          pip install -c requirements/locks/release-build.txt sigstore

      - name: Download release evidence bundle
        uses: actions/download-artifact@v4
        with:
          name: release-evidence-${{ github.ref_name }}
          path: dist

      - name: Verify wheel/sdist signatures (Sigstore)
        run: |
          set -euo pipefail
          for artifact in dist/*.whl dist/*.tar.gz; do
            bundle="${artifact}.sigstore.json"
            python -m sigstore verify github \
              --bundle "$bundle" \
              --repository "${{ github.repository }}" \
              --trigger "push" \
              --name "CI" \
              --ref "refs/tags/${{ github.ref_name }}" \
              "$artifact"
          done

      - name: Install cosign
        uses: sigstore/cosign-installer@v3.8.1

      - name: Verify published image signature (Cosign)
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign verify \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate-identity-regexp "^https://github.com/${{ github.repository }}/.github/workflows/ci.yml@refs/tags/${{ github.ref_name }}$" \
            "${{ env.IMAGE_NAME }}@${{ needs.release-artifacts.outputs.image_digest }}"

  release-proof:
    name: Release proof regeneration (Golden Path)
    runs-on: ubuntu-latest
    needs: [release-artifacts, dashboard-build]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install runtime dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -c requirements/locks/dev-excel-local.txt -e ".[dev,excel]"

      - name: Run Golden Path and capture transcript
        run: |
          set -euo pipefail
          mkdir -p proof
          python -m demos.golden_path \
            --source sharepoint \
            --fixture src/demos/golden_path/fixtures/sharepoint_small \
            --output proof/golden_path_out \
            --json | tee proof/golden_path_transcript.txt

      - name: Generate Trust Scorecard
        run: |
          python -m tools.trust_scorecard \
            --input proof/golden_path_out \
            --output proof/trust_scorecard.json \
            | tee -a proof/golden_path_transcript.txt

      - name: Gate release on Trust Scorecard SLOs
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          scorecard = json.loads(Path("proof/trust_scorecard.json").read_text())
          checks = scorecard.get("slo_checks", {})
          failed = [k for k, v in checks.items() if not v]
          if failed:
              raise SystemExit(f"Trust Scorecard SLO failure(s): {', '.join(failed)}")
          print("Trust Scorecard gate PASS")
          PY

      - name: Download dashboard build artifact
        uses: actions/download-artifact@v4
        with:
          name: dashboard-dist
          path: dashboard/dist

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Capture dashboard screenshot (headless)
        run: |
          set -euo pipefail
          npm install --no-save playwright
          npx playwright install --with-deps chromium
          python -m http.server 4173 --directory dashboard/dist >/tmp/dashboard_server.log 2>&1 &
          server_pid=$!
          trap "kill ${server_pid}" EXIT
          npx playwright screenshot --device="Desktop Chrome" \
            http://127.0.0.1:4173 \
            proof/dashboard_screenshot.png

      - name: Build versioned proof bundle
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME}"
          cp proof/trust_scorecard.json "proof/trust_scorecard_${version}.json"
          cp proof/golden_path_transcript.txt "proof/golden_path_transcript_${version}.txt"
          cp proof/dashboard_screenshot.png "proof/dashboard_screenshot_${version}.png"
          cp proof/golden_path_out/summary.json "proof/golden_path_summary_${version}.json"
          tar -czf "proof/golden_path_output_${version}.tar.gz" -C proof golden_path_out

      - name: Upload proof bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-proof-${{ github.ref_name }}
          path: proof/*

      - name: Attach proof artifacts to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            proof/trust_scorecard_${{ github.ref_name }}.json
            proof/golden_path_transcript_${{ github.ref_name }}.txt
            proof/dashboard_screenshot_${{ github.ref_name }}.png
            proof/golden_path_summary_${{ github.ref_name }}.json
            proof/golden_path_output_${{ github.ref_name }}.tar.gz

  pypi-smoke:
    name: Smoke install from PyPI
    runs-on: ubuntu-latest
    needs: [publish]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install from PyPI and validate CLI version
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          for i in $(seq 1 12); do
            python -m pip install --upgrade pip
            if pip install "deepsigma==${version}"; then
              break
            fi
            if [ "$i" -eq 12 ]; then
              echo "deepsigma ${version} not visible on PyPI after retries"
              exit 1
            fi
            sleep 20
          done
          deepsigma --version | tee /tmp/deepsigma-version.txt
          grep -q "${version}" /tmp/deepsigma-version.txt

      - name: Validate optional extras install
        run: |
          version="${GITHUB_REF_NAME#v}"
          pip install "deepsigma[rdf,azure,snowflake]==${version}"
