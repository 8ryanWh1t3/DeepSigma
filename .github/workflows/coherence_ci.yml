name: Coherence Pilot CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 6 * * *"

permissions:
  contents: read
  pull-requests: write

jobs:
  coherence-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install core deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e . pytest

      - name: Run DeepSigma Core demo and contract test
        run: |
          bash run_money_demo.sh
          python -m pytest tests/test_money_demo.py -q

      - name: Core package boundary check
        run: |
          python - <<'PY'
          from pathlib import Path
          roots = [
              p.name
              for p in Path("src").iterdir()
              if p.is_dir() and not p.name.endswith(".egg-info")
          ]
          allowed = {"core", "coherence_ops"}
          bad = sorted(set(roots) - allowed)
          if bad:
              raise SystemExit(f"Unexpected src packages for CORE gate: {bad}")
          print("PASS: CORE package boundary")
          PY

      - name: Secret pattern scan (quick)
        run: |
          python - <<'PY'
          import re
          from pathlib import Path
          patterns = [
              re.compile(r"AKIA[0-9A-Z]{16}"),
              re.compile(r"ghp_[A-Za-z0-9]{36}"),
              re.compile(r"-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY-----"),
          ]
          skip = {".git", ".venv", "enterprise", "node_modules"}
          hits = []
          for p in Path(".").rglob("*"):
              if not p.is_file():
                  continue
              if any(part in skip for part in p.parts):
                  continue
              try:
                  text = p.read_text(encoding="utf-8", errors="ignore")
              except Exception:
                  continue
              for pat in patterns:
                  if pat.search(text):
                      hits.append(str(p))
                      break
          if hits:
              raise SystemExit(f"Potential secret patterns found: {hits[:10]}")
          print("PASS: quick secret scan")
          PY

      - name: Build core CI report
        run: |
          mkdir -p docs/examples/demo-stack
          python - <<'PY'
          import json
          from datetime import datetime, timezone
          from pathlib import Path

          report = {
              "ci_score": 100,
              "timestamp": datetime.now(timezone.utc).isoformat(),
              "mode": "DeepSigma Core",
              "checks": [
                  "run_money_demo.sh",
                  "tests/test_money_demo.py",
              ],
              "violations": [],
          }
          out = Path("docs/examples/demo-stack/ci_report.json")
          out.write_text(json.dumps(report, indent=2), encoding="utf-8")
          Path("docs/examples/demo-stack/ci_report.md").write_text(
              "# Coherence Core CI Report\n\n"
              "- CI score: 100\n"
              "- Mode: DeepSigma Core\n"
              "- Checks: run_money_demo.sh, tests/test_money_demo.py\n",
              encoding="utf-8",
          )
          PY

      - name: Upload CI report artifact
        uses: actions/upload-artifact@v4
        with:
          name: coherence-ci-report
          path: |
            docs/examples/demo-stack/ci_report.md
            docs/examples/demo-stack/ci_report.json

      - name: Comment CI on PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'docs/examples/demo-stack/ci_report.json';
            if (!fs.existsSync(path)) {
              core.info('No ci_report.json found; skipping comment.');
              return;
            }
            const report = JSON.parse(fs.readFileSync(path, 'utf8'));
            const violations = (report.violations || []).slice(0, 5)
              .map(v => `- \`${v.file}\`: ${v.message}${v.issue_ref ? ` (${v.issue_ref})` : ''}`)
              .join('\n') || '- None';
            const body = [
              '## Coherence Pilot CI',
              '',
              `- CI score: **${report.ci_score}**`,
              `- Timestamp: ${report.timestamp}`,
              '',
              '### Top Violations',
              violations
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
