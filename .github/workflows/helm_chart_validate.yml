name: Helm Chart Validation

on:
  push:
    branches: [main]
    paths:
      - "charts/**"
      - "docs/deployment/HELM.md"
      - ".github/workflows/helm_chart_validate.yml"

permissions:
  contents: read

jobs:
  chart-lint-template:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup Helm
        uses: azure/setup-helm@v4
      - name: Helm lint
        run: helm lint charts/deepsigma
      - name: Helm template
        run: helm template deepsigma charts/deepsigma >/tmp/deepsigma-render.yaml

  kind-install-test:
    runs-on: ubuntu-latest
    needs: chart-lint-template
    steps:
      - uses: actions/checkout@v6
      - name: Setup Helm
        uses: azure/setup-helm@v4
      - name: Setup kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: deepsigma
      - name: Build and load local API image for kind
        run: |
          docker build -f docker/scale/Dockerfile.api -t deepsigma-api:ci .
          kind load docker-image deepsigma-api:ci --name deepsigma
      - name: Install chart
        run: |
          helm upgrade --install deepsigma charts/deepsigma \
            --namespace deepsigma \
            --create-namespace \
            --set api.image.repository=deepsigma-api \
            --set api.image.tag=ci \
            --set api.image.pullPolicy=IfNotPresent
          kubectl -n deepsigma wait \
            --for=condition=available \
            deployment \
            -l app.kubernetes.io/instance=deepsigma \
            --timeout=180s
      - name: Helm test smoke checks
        run: helm test deepsigma -n deepsigma
      - name: Diagnostics on failure
        if: failure()
        run: |
          kubectl get pods -A -o wide
          kubectl -n deepsigma get all
          kubectl -n deepsigma describe deploy deepsigma || true
          kubectl -n deepsigma logs deploy/deepsigma --all-containers=true --tail=200 || true
          kubectl -n deepsigma get events --sort-by=.metadata.creationTimestamp | tail -n 100 || true
          helm get all deepsigma -n deepsigma || true
