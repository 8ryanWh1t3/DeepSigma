name: Admissibility Gate

permissions:
  contents: read

on:
  push:
    paths:
      - 'enterprise/src/tools/reconstruct/**'
      - 'enterprise/schemas/reconstruct/**'
      - 'enterprise/tests/test_transparency*'
      - 'enterprise/tests/test_multisig*'
      - 'enterprise/tests/test_merkle*'
      - 'enterprise/tests/test_seal_and_prove*'
      - 'enterprise/tests/test_authority_ledger*'
      - 'enterprise/tests/test_verify_pack*'
jobs:
  admissibility:
    name: Court-Grade Admissibility
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Run new test suites
        run: |
          python -m unittest enterprise.tests.test_merkle_commitments -v
          python -m unittest enterprise.tests.test_transparency_log -v
          python -m unittest enterprise.tests.test_multisig -v
          python -m unittest enterprise.tests.test_seal_and_prove -v
          python -m unittest enterprise.tests.test_authority_ledger -v
          python -m unittest enterprise.tests.test_verify_pack -v

      - name: Run existing regression suites
        run: |
          python -m unittest enterprise.tests.test_deterministic_seal -v
          python -m unittest enterprise.tests.test_reconstruct_replay -v
          python -m unittest enterprise.tests.test_signature_support -v

      - name: Generate HMAC key
        run: |
          SIGN_KEY=$(python -c "import secrets,base64;print(base64.b64encode(secrets.token_bytes(32)).decode())")
          echo "SIGN_KEY=$SIGN_KEY" >> "$GITHUB_ENV"

      - name: Seal-and-prove pipeline
        run: >
          python enterprise/src/tools/reconstruct/seal_and_prove.py
          --decision-id DEC-001
          --clock 2026-02-21T00:00:00Z
          --sign-algo hmac
          --sign-key-id ds-ci-2026-02
          --sign-key "$SIGN_KEY"
          --user ci
          --out-dir "$RUNNER_TEMP/sealed"
          --transparency-log "$RUNNER_TEMP/log.ndjson"
          --auto-authority
          --authority-ledger "$RUNNER_TEMP/ledger.ndjson"
          --pack-dir "$RUNNER_TEMP/pack"

      - name: Verify transparency chain
        run: >
          python enterprise/src/tools/reconstruct/transparency_log_append.py
          --log-path "$RUNNER_TEMP/log.ndjson"
          --verify-only

      - name: Full replay with all flags
        run: |
          sealed=$(ls "$RUNNER_TEMP"/sealed/RUN-*.json | grep -v '\.sig\.' | grep -v manifest | head -1)
          python enterprise/src/tools/reconstruct/replay_sealed_run.py \
            --sealed "$sealed" \
            --verify-signature true \
            --key "$SIGN_KEY" \
            --verify-transparency true \
            --transparency-log "$RUNNER_TEMP/log.ndjson"

      - name: Determinism audit (strict)
        run: |
          sealed=$(ls "$RUNNER_TEMP"/sealed/RUN-*.json | grep -v '\.sig\.' | grep -v manifest | head -1)
          python enterprise/src/tools/reconstruct/determinism_audit.py --sealed "$sealed" --strict

      - name: Authority ledger chain verification
        run: >
          python enterprise/src/tools/reconstruct/authority_ledger_append.py
          --ledger-path "$RUNNER_TEMP/ledger.ndjson"
          --verify-only

      - name: Verify pack (one-command)
        run: >
          python enterprise/src/tools/reconstruct/verify_pack.py
          --pack "$RUNNER_TEMP/pack"
          --key "$SIGN_KEY"
