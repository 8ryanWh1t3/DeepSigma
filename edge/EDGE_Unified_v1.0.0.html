<!doctype html>
<!-- v015: ABP viewer/verifier in Utility tab -->
<!-- UNIFIED_BUILD_STAMP: 2026-02-25T06:00:00Z -->
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Deep Sigma - SEQUOIA Unified All-5 v015</title>
  <style>
    :root { --bg:#081019; --card:#0f1a2a; --line:#25415e; --txt:#e7eef7; --muted:#97afc8; --accent:#7df9ff; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; background:var(--bg); color:var(--txt); }
    header { padding:12px 14px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .brand b { display:block; letter-spacing:.4px; }
    .brand small { color:var(--muted); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button { background:#17273d; color:var(--txt); border:1px solid #2b4a69; border-radius:10px; padding:8px 10px; cursor:pointer; }
    button:hover { border-color:#3f658a; }
    main { display:grid; grid-template-columns:280px 1fr; min-height:calc(100vh - 62px); }
    aside { border-right:1px solid var(--line); padding:10px; }
    .tab { width:100%; text-align:left; border:1px solid transparent; background:transparent; color:var(--txt); padding:10px; border-radius:10px; margin-bottom:8px; }
    .tab.active { background:#132239; border-color:#355170; }
    .meta { margin-top:10px; padding:10px; border:1px solid var(--line); border-radius:10px; background:var(--card); }
    .meta h3 { margin:0 0 8px 0; font-size:13px; }
    .meta p { margin:0; color:var(--muted); font-size:12px; }
    section { padding:10px; display:flex; flex-direction:column; gap:8px; }
    .frame-wrap { position:relative; border:1px solid var(--line); border-radius:12px; overflow:hidden; height:calc(100vh - 140px); min-height:520px; background:#0c1522; }
    iframe { width:100%; height:100%; border:0; }
    .module-frame { position:absolute; inset:0; }
    .foot { color:var(--muted); font-size:11px; }
    .hidden { display:none !important; }
    @media (max-width:980px) {
      main { grid-template-columns:1fr; }
      aside { border-right:0; border-bottom:1px solid var(--line); }
      .frame-wrap { height:66vh; min-height:440px; }
    }
  
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.panel h4{margin:0 0 8px 0;font-size:13px;color:#cfe2f7}

/* IRIS Panel */
.iris-pane{padding:16px;overflow-y:auto;max-height:calc(100vh - 140px)}
.iris-header{margin-bottom:14px}
.iris-header h2{margin:0;color:var(--accent);font-size:18px;letter-spacing:.5px}
.iris-sub{color:var(--muted);font-size:12px}
.iris-types{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.iris-type{background:#17273d;color:var(--muted);border:1px solid #2b4a69;border-radius:999px;padding:6px 14px;font-size:12px;cursor:pointer;transition:all .15s}
.iris-type:hover{border-color:#3f658a;color:var(--txt)}
.iris-type.active{background:rgba(125,249,255,.12);border-color:rgba(125,249,255,.5);color:var(--accent)}
.iris-input-row{display:flex;gap:8px;margin-bottom:14px}
.iris-input-row input{flex:1;background:#0d1520;color:var(--txt);border:1px solid #243449;border-radius:10px;padding:9px 12px;font-size:13px}
.iris-input-row input:focus{border-color:rgba(125,249,255,.5);outline:none}
.iris-input-row button{background:rgba(125,249,255,.12);border-color:rgba(125,249,255,.45);color:var(--accent);padding:9px 18px;font-weight:600}
.iris-input-row button:hover{background:rgba(125,249,255,.2)}
.iris-result{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;min-height:60px;margin-bottom:14px}
.iris-result:empty{display:none}
.iris-status-pill{display:inline-block;padding:3px 10px;border-radius:999px;font-size:11px;font-weight:700;letter-spacing:.5px}
.iris-status-pill.resolved{background:rgba(93,255,147,.15);color:#5dff93;border:1px solid rgba(93,255,147,.3)}
.iris-status-pill.partial{background:rgba(255,204,102,.15);color:#ffcc66;border:1px solid rgba(255,204,102,.3)}
.iris-status-pill.not-found{background:rgba(255,107,107,.15);color:#ff6b6b;border:1px solid rgba(255,107,107,.3)}
.iris-conf-wrap{margin:10px 0}
.iris-conf-label{font-size:11px;color:var(--muted);margin-bottom:4px}
.iris-conf-bar{width:100%;height:8px;background:#1a2538;border-radius:4px;overflow:hidden}
.iris-conf-fill{height:100%;border-radius:4px;transition:width .3s}
.iris-conf-fill.high{background:#5dff93}
.iris-conf-fill.mid{background:#ffcc66}
.iris-conf-fill.low{background:#ff6b6b}
.iris-answer{margin:12px 0;font-size:13px;line-height:1.6;color:var(--txt)}
.iris-answer strong{color:var(--accent)}
.iris-prov-chain{border-left:2px solid var(--line);margin:10px 0 0 8px;padding-left:16px}
.iris-prov-item{position:relative;margin-bottom:12px;font-size:12px}
.iris-prov-item::before{content:'';position:absolute;left:-21px;top:5px;width:10px;height:10px;border-radius:50%;background:var(--accent);border:2px solid var(--card)}
.iris-prov-item .prov-role{display:inline-block;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;margin-right:6px}
.iris-prov-item .prov-role.source{background:rgba(125,249,255,.15);color:var(--accent)}
.iris-prov-item .prov-role.evidence{background:rgba(93,255,147,.15);color:#5dff93}
.iris-prov-item .prov-role.context{background:rgba(255,204,102,.15);color:#ffcc66}
.iris-prov-item .prov-artifact{color:var(--muted);font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:11px}
.iris-prov-item .prov-detail{color:var(--txt);margin-top:2px}
.iris-modules-affected{margin-top:10px;display:flex;gap:6px;flex-wrap:wrap}
.iris-mod-badge{padding:3px 8px;border-radius:6px;font-size:11px;font-weight:600;background:rgba(125,249,255,.08);border:1px solid rgba(125,249,255,.2);color:var(--accent)}
.iris-history h3{margin:0 0 8px;font-size:13px;color:var(--muted)}
.iris-history-item{padding:8px 10px;background:var(--card);border:1px solid var(--line);border-radius:8px;margin-bottom:6px;cursor:pointer;font-size:12px;display:flex;gap:8px;align-items:center}
.iris-history-item:hover{border-color:#3f658a}
.iris-history-item .hist-type{padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700;background:rgba(125,249,255,.1);color:var(--accent)}
.iris-history-item .hist-query{flex:1;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.iris-history-item .hist-ts{color:var(--muted);font-size:10px}
.iris-history-item .hist-status{font-size:10px;font-weight:700}
.iris-empty{color:var(--muted);font-size:13px;font-style:italic;text-align:center;padding:30px 0}
.iris-alink{color:var(--accent);cursor:pointer;text-decoration:none;font-weight:700;border-bottom:1px dashed rgba(125,249,255,.3)}
.iris-alink:hover{border-bottom-color:var(--accent);text-shadow:0 0 6px rgba(125,249,255,.3)}
#iris-popover-overlay{position:fixed;inset:0;z-index:99999;background:rgba(8,16,25,.75);display:none;align-items:center;justify-content:center}
#iris-popover-overlay.open{display:flex}
#iris-popover-modal{background:#0f1a2a;border:1px solid #355170;border-radius:12px;padding:18px 20px;max-width:620px;width:92%;max-height:80vh;overflow:auto;box-shadow:0 12px 40px rgba(0,0,0,.55)}
#iris-popover-modal h3{margin:0 0 6px;font-size:15px;color:var(--accent)}
#iris-popover-modal .iris-pop-meta{font-size:12px;color:var(--muted);margin-bottom:12px;display:flex;gap:10px;flex-wrap:wrap}
#iris-popover-modal .iris-pop-meta span{padding:2px 8px;border-radius:6px;background:rgba(125,249,255,.08);border:1px solid rgba(125,249,255,.15)}
#iris-popover-modal .iris-pop-label{font-size:13px;color:var(--txt);margin-bottom:12px;line-height:1.5}
#iris-popover-modal .iris-pop-data{max-height:50vh;overflow:auto}
#iris-popover-modal .iris-pop-close{float:right;background:transparent;border:1px solid #2b4a69;color:var(--muted);border-radius:8px;padding:4px 12px;font-size:12px;cursor:pointer}
#iris-popover-modal .iris-pop-close:hover{border-color:var(--accent);color:var(--accent)}
.iris-kv-table{width:100%;border-collapse:separate;border-spacing:0;font-size:12px}
.iris-kv-table td{padding:6px 10px;border-bottom:1px solid #1a2d42;vertical-align:top}
.iris-kv-table tr:last-child td{border-bottom:none}
.iris-kv-table .kv-key{color:var(--accent);font-weight:600;white-space:nowrap;width:1%;padding-right:14px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:11px}
.iris-kv-table .kv-val{color:var(--txt);word-break:break-word}
.iris-kv-table .kv-val.muted{color:var(--muted);font-style:italic}
.iris-kv-nested{background:#0a1018;border:1px solid #1e3350;border-radius:8px;padding:8px 10px;margin:4px 0}
.iris-kv-nested .iris-kv-table td{padding:4px 8px;font-size:11px}
.iris-kv-arr-item{background:#0d1520;border:1px solid #1a2d42;border-radius:6px;padding:6px 8px;margin-bottom:4px}
.iris-kv-arr-item:last-child{margin-bottom:0}
.iris-kv-arr-idx{display:inline-block;min-width:18px;color:var(--muted);font-size:10px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
.iris-kv-primitive{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;padding:2px 6px;border-radius:4px}
.iris-kv-string{color:#5dff93}
.iris-kv-number{color:#ffcc66}
.iris-kv-bool{color:#7df9ff}
.iris-kv-null{color:var(--muted);font-style:italic}
.iris-prov-item.clickable{cursor:pointer;border-radius:6px;padding:4px 6px;margin-left:-6px}
.iris-prov-item.clickable:hover{background:rgba(125,249,255,.05)}
.iris-hl{background:rgba(255,204,66,.55);color:#fff;border-radius:2px;padding:0 2px;font-weight:600}
.iris-history-item.active{border-color:rgba(125,249,255,.5);background:#132239}
.iris-input-row button.loading{opacity:.6;pointer-events:none}
.iris-input-row button .iris-spin{display:inline-block;width:12px;height:12px;border:2px solid rgba(125,249,255,.3);border-top-color:var(--accent);border-radius:50%;animation:iris-spin .6s linear infinite;margin-right:6px;vertical-align:middle}
@keyframes iris-spin{to{transform:rotate(360deg)}}
.iris-validation{color:#ff6b6b;font-size:12px;margin:-8px 0 10px;padding:4px 0}
.iris-mod-badge.clickable{cursor:pointer;transition:all .15s}
.iris-mod-badge.clickable:hover{background:rgba(125,249,255,.18);border-color:rgba(125,249,255,.5)}
.iris-raw-toggle{background:transparent;border:1px solid #2b4a69;color:var(--muted);border-radius:6px;padding:3px 10px;font-size:11px;cursor:pointer;margin-top:8px}
.iris-raw-toggle:hover{border-color:var(--accent);color:var(--accent)}
.iris-raw-pre{background:#0a1018;border:1px solid #1e3350;border-radius:8px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:11px;color:var(--txt);white-space:pre-wrap;word-break:break-word;max-height:40vh;overflow:auto;margin-top:6px}
.iris-dim-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin:10px 0}
.iris-dim-card{background:#0d1520;border:1px solid #1a2d42;border-radius:8px;padding:8px 10px}
.iris-dim-card .dim-label{font-size:11px;color:var(--muted);margin-bottom:4px}
.iris-dim-card .dim-bar{height:6px;background:#1a2538;border-radius:3px;overflow:hidden;margin-bottom:3px}
.iris-dim-card .dim-fill{height:100%;border-radius:3px}
.iris-dim-card .dim-val{font-size:12px;font-weight:700}
.iris-answer-section{margin:6px 0;padding:6px 0;border-bottom:1px solid rgba(37,65,94,.4)}
.iris-answer-section:last-child{border-bottom:none}
.iris-answer-section .section-head{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.iris-kv-expand{background:transparent;border:1px solid #1e3350;color:var(--muted);border-radius:4px;padding:1px 6px;font-size:10px;cursor:pointer;margin-left:4px}
.iris-kv-expand:hover{border-color:var(--accent);color:var(--accent)}

/* ABP Panel */
.abp-header{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:10px 0 6px}
.abp-id{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:14px;color:var(--accent);font-weight:700}
.abp-version{font-size:11px;color:var(--muted);padding:2px 8px;background:rgba(125,249,255,.08);border:1px solid rgba(125,249,255,.15);border-radius:6px}
.abp-ts{font-size:11px;color:var(--muted)}
.abp-section{margin:8px 0 4px;cursor:pointer;display:flex;align-items:center;gap:6px}
.abp-section h4{margin:0;font-size:13px;color:#cfe2f7}
.abp-section .abp-toggle{font-size:10px;color:var(--muted);transition:transform .15s}
.abp-section .abp-toggle.open{transform:rotate(90deg)}
.abp-section-body{padding:0 0 0 12px;font-size:12px}
.abp-section-body.collapsed{display:none}
.abp-list{list-style:none;padding:0;margin:4px 0}
.abp-list li{padding:4px 8px;border-left:3px solid var(--line);margin-bottom:3px;font-size:12px}
.abp-list li.allow{border-left-color:#5dff93}
.abp-list li.deny{border-left-color:#ff6b6b}
.abp-list li .abp-item-id{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:11px;color:var(--accent);margin-right:6px}
.abp-list li .abp-item-reason{color:var(--muted);font-style:italic;margin-left:6px}
.abp-data-table{width:100%;border-collapse:separate;border-spacing:0;font-size:12px;margin:4px 0}
.abp-data-table th{text-align:left;padding:4px 8px;color:var(--muted);font-size:11px;border-bottom:1px solid var(--line);font-weight:600}
.abp-data-table td{padding:4px 8px;border-bottom:1px solid rgba(37,65,94,.3)}
.abp-data-table .sensitivity{padding:1px 6px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase}
.abp-data-table .sensitivity.public{background:rgba(93,255,147,.12);color:#5dff93}
.abp-data-table .sensitivity.internal{background:rgba(125,249,255,.12);color:var(--accent)}
.abp-data-table .sensitivity.confidential{background:rgba(255,204,102,.12);color:#ffcc66}
.abp-data-table .sensitivity.restricted{background:rgba(255,107,107,.12);color:#ff6b6b}
.abp-hash{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:11px;color:var(--muted);word-break:break-all;margin:6px 0;padding:6px 8px;background:#0a1018;border:1px solid #1e3350;border-radius:6px}
.abp-verify-results{margin:8px 0}
.abp-check{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:12px}
.abp-pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:10px;font-weight:700;letter-spacing:.5px}
.abp-pill.pass{background:rgba(93,255,147,.15);color:#5dff93;border:1px solid rgba(93,255,147,.3)}
.abp-pill.fail{background:rgba(255,107,107,.15);color:#ff6b6b;border:1px solid rgba(255,107,107,.3)}
.abp-pill.warn{background:rgba(255,204,102,.15);color:#ffcc66;border:1px solid rgba(255,204,102,.3)}
.abp-check-name{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:11px;color:var(--txt);min-width:140px}
.abp-check-detail{color:var(--muted);font-size:11px}
.abp-empty{color:var(--muted);font-size:12px;font-style:italic;padding:10px 0}
.abp-proof-list{display:flex;gap:4px;flex-wrap:wrap;margin:4px 0}
.abp-proof-badge{padding:2px 8px;border-radius:6px;font-size:11px;background:rgba(125,249,255,.08);border:1px solid rgba(125,249,255,.15);color:var(--accent)}
.abp-comp-ref{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:11px;color:var(--txt);padding:4px 8px;background:#0d1520;border:1px solid #1a2d42;border-radius:6px;margin:3px 0;display:block}

/* ABP Context Bar */
.abp-bar{background:linear-gradient(90deg,rgba(125,249,255,.06),rgba(93,255,147,.04));border:1px solid rgba(125,249,255,.18);border-radius:10px;padding:8px 12px;margin:0 0 6px;font-size:12px;display:none}
.abp-bar.active{display:block}
.abp-bar-header{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px}
.abp-bar-id{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;color:var(--accent);font-weight:700}
.abp-bar-scope{color:var(--muted);font-size:11px}
.abp-bar-module-status{font-size:11px;font-weight:700;padding:2px 8px;border-radius:999px}
.abp-bar-module-status.in-scope{background:rgba(93,255,147,.12);color:#5dff93;border:1px solid rgba(93,255,147,.25)}
.abp-bar-module-status.out-scope{background:rgba(255,204,102,.12);color:#ffcc66;border:1px solid rgba(255,204,102,.25)}
.abp-bar-body{display:flex;gap:16px;flex-wrap:wrap}
.abp-bar-col{min-width:140px}
.abp-bar-col-title{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.abp-bar-item{font-size:11px;padding:1px 0;display:flex;align-items:center;gap:4px}
.abp-bar-item .dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.abp-bar-item .dot.green{background:#5dff93}
.abp-bar-item .dot.red{background:#ff6b6b}
.abp-bar-item .dot.yellow{background:#ffcc66}
.abp-bar-item .dot.cyan{background:var(--accent)}
.abp-bar-none{color:var(--muted);font-size:11px;font-style:italic}
</style>
</head>
<body>
<header>
  <div class="brand">
    <b>Deep Sigma - SEQUOIA Unified All-5 v015</b>
    <small>Single-file host that embeds Suite + Hiring + Bid/No-Bid + Compliance + BOE</small>
  </div>
  <div class="row">
    <button id="btnExportRollupHost" class="primary">Export Rollup JSON</button>
    <button id="btnPrintExecHost">Print Executive View</button>
    <button id="btnOpenExternal">Open Current in New Window</button>
  </div>
</header>
<main>
  <aside>
    <button class="tab active" data-id="suite">Suite Control</button>
    <button class="tab" data-id="hiring">Hiring Console</button>
    <button class="tab" data-id="bid">Bid/No-Bid</button>
    <button class="tab" data-id="compliance">Compliance Matrix</button>
    <button class="tab" data-id="boe">BOE/Pricing</button>
    <button class="tab" data-id="iris">IRIS</button>
    <button class="tab" data-id="utility">Utility</button>
    <div class="meta">
      <h3 id="mTitle">Suite Control</h3>
      <p id="mDesc">Unified control surface (read-only wrapper + telemetry)</p>
    </div>

  </aside>
  <section>
    <div id="abpBar" class="abp-bar"></div>
    <div id="modulePane">
      <div class="frame-wrap">
        <div id="frameDeck"></div>
      </div>
      <div class="foot">All five modules are embedded directly in this single file. Use module-native controls inside each tab.</div>
    </div>

    <div id="utilityPane" class="hidden">
      <div class="meta"><p id="bootStatusTop">Lazy-load active: module content loads on first open and reuses cached Blob URLs.</p></div>
      <div class="meta">
        <h3>Storage Keys</h3>
        <p id="keyRegistry">Loading keys...</p>
      </div>
      <div class="meta">
        <h3>Edge Transport Status</h3>
        <p id="utilityEdgeStatus">Loading edge status...</p>
      </div>
      <div class="meta">
        <h3>Schema Compatibility</h3>
        <p id="utilitySchemaStatus">Loading schema status...</p>
      </div>
      <div class="meta">
        <h3>Host Tools</h3>
        <div class="row">
          <button id="btnRunSuiteTest">Run Suite Test Mode</button>
          <button id="btnVerifyPackHost">Verify Pack Hash</button>
          <button id="btnResetHostCache">Reset Host Cache</button>
        </div>
      </div>
      <div class="meta">
        <h3>Evidence Integrity Verifier</h3>
        <div class="row">
          <input id="hostManifestFile" type="file" accept="application/json"/>
          <input id="hostHashesFile" type="file" accept="application/json"/>
        </div>
        <p id="hostVerifyStatus">Host verifier idle.</p>
      </div>
      <div class="meta">
        <h3>ZIP Import (Bid/Compliance/BOE)</h3>
        <div class="row">
          <input id="hostZipImportFile" type="file" accept=".zip,application/zip"/>
          <button id="btnImportZipHost" class="primary">Import ZIP</button>
        </div>
        <p id="hostZipSupportNote">ZIP engine: checking support...</p>
        <pre id="hostZipImportResult" class="mono">No ZIP import run yet.</pre>
      </div>
      <div class="meta">
        <h3>Suite Rollup JSON</h3>
        <textarea id="suiteRollupUtility" style="width:100%;min-height:180px;background:#0c1522;color:#e7eef7;border:1px solid #2b4a69;border-radius:8px;padding:8px" readonly></textarea>
      </div>
      <div class="meta">
        <h3>Host Rollup</h3>
        <textarea id="hostRollup" style="width:100%;min-height:180px;background:#0c1522;color:#e7eef7;border:1px solid #2b4a69;border-radius:8px;padding:8px" readonly></textarea>
      </div>
      <div class="meta">
        <h3>Authority Boundary Primitive (ABP)</h3>
        <div class="row" style="margin-bottom:8px">
          <input id="abpFileInput" type="file" accept="application/json"/>
          <button id="btnAbpVerify" class="primary">Verify ABP</button>
          <button id="btnAbpClear">Clear</button>
        </div>
        <div id="abpVerifyResults"></div>
        <div id="abpViewer"></div>
      </div>
      <div class="meta"><p id="bootStatusBottom">Lazy-load active: module content loads on first open and reuses cached Blob URLs.</p></div>
    </div>

    <!-- IRIS Panel (host-level, not iframe) -->
    <div id="irisPane" class="iris-pane hidden">
      <div class="iris-header">
        <h2>IRIS</h2>
        <span class="iris-sub">Interface for Resolution, Insight &amp; Status</span>
      </div>
      <div class="iris-types">
        <button class="iris-type active" data-qt="WHY">WHY</button>
        <button class="iris-type" data-qt="WHAT_CHANGED">WHAT CHANGED</button>
        <button class="iris-type" data-qt="WHAT_DRIFTED">WHAT DRIFTED</button>
        <button class="iris-type" data-qt="RECALL">RECALL</button>
        <button class="iris-type" data-qt="STATUS">STATUS</button>
      </div>
      <div class="iris-input-row">
        <input id="irisQuery" type="text" placeholder="Ask IRIS..." />
        <button id="irisGo">Resolve</button>
      </div>
      <div id="irisResult" class="iris-result"></div>
      <div id="irisHistorySection" class="iris-history">
        <h3>Query History</h3>
        <div id="irisHistoryList"></div>
      </div>
    </div>

    <!-- IRIS Artifact Popover -->
    <div id="iris-popover-overlay">
      <div id="iris-popover-modal">
        <button class="iris-pop-close" id="irisPopClose">Close</button>
        <h3 id="irisPopTitle">Artifact Detail</h3>
        <div class="iris-pop-meta" id="irisPopMeta"></div>
        <div class="iris-pop-label" id="irisPopLabel"></div>
        <div class="iris-pop-data" id="irisPopData"></div>
      </div>
    </div>
  </section>
</main>

<script>
  const MODULES = {
    "suite": {title: "Suite Control", desc: "Unified control surface (read-only wrapper + telemetry)", html: "<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\"/>\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/>\n  <title>Deep Sigma - SEQUOIA Unified Suite (Read-Only) v013<\/title>\n  <style>\n    :root { --bg:#0a0f16; --card:#111b29; --line:#22354d; --txt:#e7eef7; --muted:#8ea6bf; --accent:#7df9ff; --ok:#5dff93; --warn:#ffcc66; --bad:#ff6b6b; }\n    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}\n    header{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap}\n    .brand b{display:block;letter-spacing:.4px}.brand small{color:var(--muted)}\n    .badge{border:1px solid rgba(125,249,255,.35);color:var(--accent);padding:4px 8px;border-radius:999px;font-size:12px}\n    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}\n    button{background:#182235;color:var(--txt);border:1px solid #243449;border-radius:10px;padding:8px 10px;cursor:pointer}\n    button:hover{border-color:#2f4765}\n    button.primary{border-color:rgba(125,249,255,.45);box-shadow:0 0 0 1px rgba(125,249,255,.12) inset}\n    main{display:grid;grid-template-columns:340px 1fr;min-height:calc(100vh - 62px)}\n    aside{border-right:1px solid var(--line);padding:12px;overflow:auto;max-height:calc(100vh - 62px)}\n    .module{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:10px;cursor:pointer}\n    .module.active{border-color:rgba(125,249,255,.6);box-shadow:0 0 0 1px rgba(125,249,255,.15) inset}\n    .module b{display:block;font-size:13px;margin-bottom:5px}\n    .module .meta{font-size:12px;color:var(--muted)}\n    .path{margin-top:6px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:11px;color:#a9c3de;word-break:break-all}\n    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}\n    .content{padding:12px;display:flex;flex-direction:column;gap:10px}\n    .panel{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}\n    .panel h3{margin:0 0 8px 0;font-size:14px}\n    .panel p{margin:0;color:var(--muted);font-size:12px}\n    .kpi{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}\n    .kpi .card,.lens .card{background:#0d1520;border:1px solid #22354d;border-radius:10px;padding:8px}\n    .kpi .v{font-size:18px;font-weight:700}\n    .kpi .l{font-size:11px;color:var(--muted)}\n    .lens{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}\n    .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}\n    .triple{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}\n    table{width:100%;border-collapse:collapse;font-size:12px}\n    th,td{padding:8px;border-bottom:1px solid #22354d;vertical-align:top}\n    th{text-align:left;color:#b9d3ea}\n    .status-ok{color:var(--ok)} .status-warn{color:var(--warn)} .status-orange{color:#ff9933} .status-bad{color:var(--bad)}\n    .frame-wrap{position:relative;height:54vh;min-height:360px;background:#0d1520;border:1px solid var(--line);border-radius:12px;overflow:hidden}\n    iframe{width:100%;height:100%;border:0;pointer-events:none}\n    .overlay{position:absolute;inset:0;display:flex;align-items:flex-end;justify-content:flex-end;padding:10px;background:linear-gradient(to top, rgba(10,15,22,.35), rgba(10,15,22,0));pointer-events:none}\n    .overlay span{background:rgba(17,27,41,.82);border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:11px;color:#c0d5eb}\n    .pill{display:inline-block;padding:2px 7px;border-radius:999px;border:1px solid #2a3d57;font-size:11px;color:#bed6ef;margin-right:6px;margin-bottom:6px}\n    textarea, pre{width:100%;box-sizing:border-box;background:#0d1520;color:var(--txt);border:1px solid #243449;border-radius:10px;padding:10px;font-size:12px}\n    textarea{min-height:160px;resize:vertical}\n    .foot{font-size:11px;color:var(--muted)}\n    .alert{background:rgba(255,204,102,.08);border:1px solid rgba(255,204,102,.45);color:#ffd98e;border-radius:10px;padding:9px;font-size:12px}\n    @media (max-width: 1200px){ .kpi{grid-template-columns:repeat(3,1fr)} .lens{grid-template-columns:repeat(2,1fr)} .triple{grid-template-columns:1fr} .split{grid-template-columns:1fr} }\n    @media (max-width: 960px){ main{grid-template-columns:1fr} aside{border-right:0;border-bottom:1px solid var(--line);max-height:none} .frame-wrap{height:50vh;min-height:320px} }\n  <\/style>\n<\/head>\n<body>\n<header>\n  <div class=\"brand\">\n    <b>Deep Sigma - SEQUOIA Unified Suite (Read-Only) v013<\/b>\n    <small>Control surface for Truth, Reasoning, Memory, Governance across 4 edge consoles<\/small>\n  <\/div>\n  <div class=\"row\">\n    <button id=\"btnRefresh\">Refresh<\/button>\n    <button id=\"btnExportRollup\" class=\"primary\">Export Rollup JSON<\/button>\n    <button id=\"btnPrintExec\">Print Executive View<\/button>\n    <div class=\"badge\">Read-Only Shell<\/div>\n  <\/div>\n<\/header>\n<main>\n  <aside>\n    <div id=\"moduleList\"><\/div>\n    <div class=\"panel\">\n      <h3>Storage Keys<\/h3>\n      <div id=\"keysList\" class=\"path\"><\/div>\n    <\/div>\n    <div class=\"panel\">\n      <h3>Edge Transport Status<\/h3>\n      <div id=\"edgeStatus\" class=\"muted\">No edge data.<\/div>\n    <\/div>\n    <div class=\"panel\">\n      <h3>Schema Compatibility<\/h3>\n      <div id=\"schemaStatus\"><\/div>\n    <\/div>\n  <\/aside>\n  <section class=\"content\">\n    <div class=\"panel\">\n      <h3>Unified KPI Strip<\/h3>\n      <div id=\"kpiStrip\" class=\"kpi\"><\/div>\n    <\/div>\n\n    <div class=\"panel\">\n      <h3>Historical Trend (7/30)<\/h3>\n      <div id=\"trendStrip\" class=\"triple\"><\/div>\n    <\/div>\n\n    <div class=\"panel\">\n      <h3>Deep Sigma Lenses<\/h3>\n      <div id=\"lensStrip\" class=\"lens\"><\/div>\n    <\/div>\n\n    \n\n    <div class=\"panel split\">\n      <div>\n        <h3>Control Gates<\/h3>\n        <div id=\"gatePanel\"><\/div>\n      <\/div>\n      <div>\n        <h3>Module Health Scoring<\/h3>\n        <div id=\"scorePanel\"><\/div>\n      <\/div>\n    <\/div>\n\n    <div class=\"panel\">\n      <h3>Cross-Module Telemetry<\/h3>\n      <div id=\"telemetryTable\"><\/div>\n    <\/div>\n\n    <div class=\"panel\">\n      <h3>Drift Signal Rollup (DS)<\/h3>\n      <div id=\"dsRollup\" class=\"muted\">No signals.<\/div>\n    <\/div>\n\n    <div class=\"panel alert\">\n      Embedded viewer is intentionally inert (read-only). Use <b>Open Module (New Tab)<\/b> for live interaction, editing, export, and test mode execution.\n    <\/div>\n\n    <div class=\"panel split\">\n      <div>\n        <h3>Suite Rollup JSON (deepsigma_suite_rollup_v1)<\/h3>\n        <textarea id=\"rollupPreview\" class=\"mono\" readonly><\/textarea>\n      <\/div>\n      <div>\n        <h3>Evidence Integrity Verifier<\/h3>\n        <p>Drop <span class=\"mono\">ingest_manifest.json<\/span> and <span class=\"mono\">hashes.json<\/span>, then verify <span class=\"mono\">pack_hash<\/span>.<\/p>\n        <div class=\"row\" style=\"margin:8px 0\">\n          <input id=\"manifestFile\" type=\"file\" accept=\"application/json\"/>\n          <input id=\"hashesFile\" type=\"file\" accept=\"application/json\"/>\n          <button id=\"btnVerifyPack\" class=\"primary\">Verify<\/button>\n        <\/div>\n        <pre id=\"verifyResult\" class=\"mono\">No verification run yet.<\/pre>\n        <h3 style=\"margin-top:10px\">ZIP Import (Bid/Compliance/BOE)<\/h3>\n        <p>Import from any of the 3 module ZIP packs and hydrate local storage for this suite.<\/p>\n        <div class=\"row\" style=\"margin:8px 0\">\n          <input id=\"zipImportFile\" type=\"file\" accept=\".zip,application/zip\"/>\n          <button id=\"btnImportZip\" class=\"primary\">Import ZIP<\/button>\n        <\/div>\n        <div id=\"zipSupportNote\" class=\"muted\"><\/div>\n        <pre id=\"importZipResult\" class=\"mono\">No ZIP import run yet.<\/pre>\n      <\/div>\n    <\/div>\n\n    \n    <div class=\"foot\">Wrapper is read-only by design. It reads local artifacts and localStorage. It does not modify underlying module data.<\/div>\n  <\/section>\n<\/main>\n\n<script>\nconst TREND_KEY = \"ds_sequoia_suite_rollup_history_v1\";\nconst MODULES = [\n  {\n    id: \"hiring\",\n    name: \"Hiring Console v019\",\n    desc: \"Authority gate + edge sync model for hiring episodes.\",\n    file: \"NGA_SEQUOIA_UI_v019.html\",\n    defaultTab: \"#dashboard\",\n    dataKey: \"ds_sequoia_hiring_console_v2_artifacts\",\n    edgeCfgKey: \"ds_sequoia_edge_cfg_v1\",\n    edgeOutboxKey: \"ds_sequoia_edge_outbox_v1\",\n    schemas: [\"deepsigma_ingest_manifest_v1\",\"deepsigma_edge_sync_v1\",\"MG_TalentGraph\",\"DLR_OFFER\"]\n  },\n  {\n    id: \"bid\",\n    name: \"Bid/No-Bid Console v003\",\n    desc: \"Gate scoring, assumptions, risks, decision seal, and artifacts.\",\n    file: \"NGA_SEQUOIA_BidNoBid_UI_v003.html\",\n    defaultTab: \"#dashboard\",\n    dataKey: \"ds_bidnobid_console_v1\",\n    edgeCfgKey: \"ds_bidnobid_edge_cfg_v1\",\n    edgeOutboxKey: \"ds_bidnobid_edge_outbox_v1\",\n    edgeAuditKey: \"ds_bidnobid_edge_audit_v1\",\n    schemas: [\"deepsigma_ingest_manifest_v1\",\"deepsigma_edge_sync_v1\",\"MG_OpportunityGraph\",\"DLR_BIDNOBID\"]\n  },\n  {\n    id: \"compliance\",\n    name: \"Compliance Matrix Console v001\",\n    desc: \"RFP requirements traceability, mapping, gaps, and DS checks.\",\n    file: \"NGA_SEQUOIA_ComplianceMatrix_UI_v001.html\",\n    defaultTab: \"#dashboard\",\n    dataKey: \"ds_compliance_matrix_v1\",\n    schemas: [\"deepsigma_compliance_matrix_v1\",\"deepsigma_ingest_manifest_v1\",\"DLR_REQUIREMENTS_BASELINE\"]\n  },\n  {\n    id: \"boe\",\n    name: \"BOE / Pricing Console v001\",\n    desc: \"Labor/rate BOE, risk bands, assumptions, and DLR-BOE exports.\",\n    file: \"NGA_SEQUOIA_BOE_Pricing_UI_v001.html\",\n    defaultTab: \"#dashboard\",\n    dataKey: \"ds_boe_pricing_v1\",\n    schemas: [\"deepsigma_boe_v1\",\"deepsigma_ingest_manifest_v1\",\"DLR_BOE_ASSUMPTIONS\"]\n  }\n];\n\nconst RATE_OUTLIER_THRESHOLD = 250;\nconst HOURS_OUTLIER_THRESHOLD = 2000;\nconst DS_GAP_AGE_DAYS = 5;\nlet activeModuleId = MODULES[0].id;\n\nfunction esc(s){ return String(s || \"\").replace(/[&<>\"']/g, m => ({\"&\":\"&amp;\",\"<\":\"&lt;\",\">\":\"&gt;\",\"\\\"\":\"&quot;\",\"'\":\"&#39;\"}[m])); }\nfunction n(x){ const v = Number(x); return Number.isFinite(v) ? v : 0; }\nfunction nowIso(){ return new Date().toISOString(); }\nfunction today(){ return new Date().toISOString().slice(0,10); }\nfunction daysOld(iso){ const t = new Date(iso || Date.now()).getTime(); if(!Number.isFinite(t)) return 0; return Math.max(0, Math.floor((Date.now()-t)/86400000)); }\nfunction pct(part, all){ if(!all) return 0; return Math.round((part/all)*1000)/10; }\n\nfunction readJson(key){\n  try{ const raw = localStorage.getItem(key); if(!raw) return null; return JSON.parse(raw); }\n  catch(_){ return null; }\n}\nfunction writeJson(key, val){\n  try{ localStorage.setItem(key, JSON.stringify(val)); }catch(_){ }\n}\n\nfunction summarizeHiring(db){\n  if(!db || typeof db !== \"object\") return {episodes:0, ds:0, sealed:0, truth:0, reasoning:0, memory:0, governance:0, detail:{}};\n  const roles = Array.isArray(db.roles) ? db.roles.length : 0;\n  const candidates = Array.isArray(db.candidates) ? db.candidates.length : 0;\n  const interviews = Array.isArray(db.interviews) ? db.interviews.length : 0;\n  const drift = Array.isArray(db.drift) ? db.drift : [];\n  const rs = Array.isArray(db.rs) ? db.rs.length : 0;\n  const offers = Array.isArray(db.candidates) ? db.candidates.filter(c=>c && (c.offer_date || c.status===\"Offer\" || c.status===\"Accepted\" || c.status===\"Started\")).length : 0;\n  return {\n    episodes: candidates,\n    ds: drift.length,\n    sealed: offers,\n    truth: roles + candidates,\n    reasoning: interviews + rs,\n    memory: drift.length + rs,\n    governance: offers,\n    detail: {roles,candidates,interviews,drift:drift.length,rs,offers}\n  };\n}\nfunction summarizeBid(db){\n  if(!db || typeof db !== \"object\") return {episodes:0, ds:0, sealed:0, truth:0, reasoning:0, memory:0, governance:0, detail:{}};\n  const opps = Array.isArray(db.opportunities) ? db.opportunities : [];\n  const assumptions = Array.isArray(db.assumptions) ? db.assumptions.length : 0;\n  const risks = Array.isArray(db.risks) ? db.risks.length : 0;\n  const drift = Array.isArray(db.drift) ? db.drift : [];\n  const rs = Array.isArray(db.rs) ? db.rs.length : 0;\n  const sealed = opps.filter(o=>o?.decision?.sealed).length;\n  return {\n    episodes: opps.length,\n    ds: drift.length,\n    sealed,\n    truth: opps.length,\n    reasoning: assumptions + risks,\n    memory: drift.length + rs,\n    governance: sealed,\n    detail: {opportunities:opps.length,assumptions,risks,drift:drift.length,rs,sealed}\n  };\n}\nfunction summarizeCompliance(db){\n  if(!db || typeof db !== \"object\") return {episodes:0, ds:0, sealed:0, truth:0, reasoning:0, memory:0, governance:0, detail:{}};\n  const reqs = Array.isArray(db.requirements) ? db.requirements : [];\n  const deliverables = Array.isArray(db.deliverables) ? db.deliverables.length : 0;\n  const gaps = Array.isArray(db.gaps) ? db.gaps : [];\n  const rs = Array.isArray(db.rs) ? db.rs.length : 0;\n  const mapped = reqs.filter(r=>String(r?.compliance_statement || \"\").trim().length>0).length;\n  const unassigned = reqs.filter(r=>!String(r?.owner || \"\").trim()).length;\n  const oldGaps = gaps.filter(g=>String(g?.status || \"\") !== \"Resolved\" && daysOld(g?.created) > DS_GAP_AGE_DAYS).length;\n  const dsAuto = [\n    unassigned>0 ? 1 : 0,\n    oldGaps>0 ? 1 : 0,\n    reqs.length && (mapped/reqs.length*100) < 90 ? 1 : 0,\n    reqs.filter(r=>!String(r?.compliance_statement || \"\").trim()).length>0 ? 1 : 0\n  ].reduce((a,b)=>a+b,0);\n  const sealed = db?.intake?.baseline_sealed ? 1 : 0;\n  return {\n    episodes: reqs.length,\n    ds: dsAuto,\n    sealed,\n    truth: reqs.length + deliverables,\n    reasoning: mapped,\n    memory: gaps.length + rs,\n    governance: sealed,\n    detail: {requirements:reqs.length,mapped,deliverables,gaps:gaps.length,ds_auto:dsAuto,baseline_sealed:!!sealed}\n  };\n}\nfunction summarizeBoe(db){\n  if(!db || typeof db !== \"object\") return {episodes:0, ds:0, sealed:0, truth:0, reasoning:0, memory:0, governance:0, detail:{}};\n  const labor = Array.isArray(db.labor) ? db.labor : [];\n  const assumptions = Array.isArray(db.assumptions) ? db.assumptions : [];\n  const missing = labor.filter(l=>!(n(l?.hours)>0) || !(n(l?.rate)>0)).length;\n  const rateOut = labor.filter(l=>n(l?.rate) > RATE_OUTLIER_THRESHOLD).length;\n  const hoursOut = labor.filter(l=>n(l?.hours) > HOURS_OUTLIER_THRESHOLD).length;\n  const cats = new Set(assumptions.map(a=>String(a?.category || \"\").toLowerCase()));\n  const missingDrivers = [\"rates\",\"escalation\",\"productivity\"].filter(c=>!cats.has(c)).length;\n  const ds = (missing>0?1:0)+(rateOut>0?1:0)+(hoursOut>0?1:0)+(missingDrivers>0?1:0);\n  const sealed = db?.approval?.sealed ? 1 : 0;\n  return {\n    episodes: labor.length,\n    ds,\n    sealed,\n    truth: labor.length,\n    reasoning: assumptions.length,\n    memory: assumptions.length,\n    governance: sealed,\n    detail: {labor_lines:labor.length,assumptions:assumptions.length,missing,rate_outliers:rateOut,hours_outliers:hoursOut,sealed:!!sealed}\n  };\n}\n\nfunction moduleSummary(mod){\n  const db = readJson(mod.dataKey);\n  if(mod.id === \"hiring\") return summarizeHiring(db);\n  if(mod.id === \"bid\") return summarizeBid(db);\n  if(mod.id === \"compliance\") return summarizeCompliance(db);\n  if(mod.id === \"boe\") return summarizeBoe(db);\n  return {episodes:0,ds:0,sealed:0,truth:0,reasoning:0,memory:0,governance:0,detail:{}};\n}\n\nfunction collectRollup(){\n  const byModule = MODULES.map(m => ({id:m.id, name:m.name, ...moduleSummary(m)}));\n  const totals = byModule.reduce((a,m)=>{\n    a.episodes += m.episodes; a.ds += m.ds; a.sealed += m.sealed;\n    a.truth += m.truth; a.reasoning += m.reasoning; a.memory += m.memory; a.governance += m.governance;\n    return a;\n  }, {episodes:0,ds:0,sealed:0,truth:0,reasoning:0,memory:0,governance:0});\n  const modulesWithData = byModule.filter(m=>m.episodes>0 || m.ds>0 || m.sealed>0).length;\n  return {byModule, totals, modulesWithData};\n}\n\nfunction governanceHealth(totals){\n  if(totals.ds === 0) return {label:\"GREEN\", cls:\"status-ok\"};\n  if(totals.ds <= 6) return {label:\"YELLOW\", cls:\"status-warn\"};\n  return {label:\"RED\", cls:\"status-bad\"};\n}\n\nfunction schemaCheck(mod){\n  const db = readJson(mod.dataKey);\n  if(!db) return {ok:false,msg:\"no data\"};\n  if(mod.id === \"hiring\"){\n    const ok = Array.isArray(db.roles) && Array.isArray(db.candidates) && Array.isArray(db.interviews) && Array.isArray(db.drift) && db.meta;\n    return {ok,msg:ok?\"shape ok\":\"missing core arrays/meta\"};\n  }\n  if(mod.id === \"bid\"){\n    const ok = Array.isArray(db.opportunities) && Array.isArray(db.assumptions) && Array.isArray(db.risks) && Array.isArray(db.drift) && db.meta;\n    return {ok,msg:ok?\"shape ok\":\"missing core arrays/meta\"};\n  }\n  if(mod.id === \"compliance\"){\n    const ok = db.intake && Array.isArray(db.requirements) && Array.isArray(db.deliverables) && Array.isArray(db.gaps) && db.meta;\n    return {ok,msg:ok?\"shape ok\":\"missing intake/arrays/meta\"};\n  }\n  if(mod.id === \"boe\"){\n    const ok = db.intake && Array.isArray(db.labor) && Array.isArray(db.assumptions) && db.risk_model && db.approval && db.meta;\n    return {ok,msg:ok?\"shape ok\":\"missing intake/labor/assumptions/risk/approval/meta\"};\n  }\n  return {ok:false,msg:\"unknown module\"};\n}\n\nfunction buildControlGates(rollup){\n  const byId = Object.fromEntries(rollup.byModule.map(m=>[m.id,m]));\n  const compliance = readJson(\"ds_compliance_matrix_v1\");\n  const boe = readJson(\"ds_boe_pricing_v1\");\n  const bidOutbox = readJson(\"ds_bidnobid_edge_outbox_v1\") || [];\n  const hiringOutbox = readJson(\"ds_sequoia_edge_outbox_v1\") || [];\n\n  const reqs = Array.isArray(compliance?.requirements) ? compliance.requirements : [];\n  const keyAssumptionCats = new Set((Array.isArray(boe?.assumptions) ? boe.assumptions : []).map(a=>String(a?.category || \"\").toLowerCase()));\n\n  const gates = [\n    {id:\"GATE-001\", name:\"Unsealed episodes\", pass: rollup.totals.sealed >= 1, value: `sealed=${rollup.totals.sealed}`},\n    {id:\"GATE-002\", name:\"Missing key assumptions\", pass: [\"rates\",\"escalation\",\"productivity\"].every(x=>keyAssumptionCats.has(x)), value:`present=${Array.from(keyAssumptionCats).join(\",\") || \"none\"}`},\n    {id:\"GATE-003\", name:\"Edge outbox backlog <= 5\", pass: (Array.isArray(bidOutbox)?bidOutbox.length:0) + (Array.isArray(hiringOutbox)?hiringOutbox.length:0) <= 5, value:`outbox=${(bidOutbox.length||0)+(hiringOutbox.length||0)}`},\n    {id:\"GATE-004\", name:\"No high DS pressure\", pass: rollup.totals.ds <= 6, value:`ds=${rollup.totals.ds}`},\n    {id:\"GATE-005\", name:\"Compliance coverage >= 90%\", pass: reqs.length ? pct(reqs.filter(r=>String(r?.compliance_statement || \"\").trim()).length, reqs.length) >= 90 : false, value:`reqs=${reqs.length}`},\n    {id:\"GATE-006\", name:\"Bid decisions sealed\", pass: (byId.bid?.sealed || 0) >= 1 || (byId.bid?.episodes || 0) === 0, value:`sealed=${byId.bid?.sealed || 0}`}\n  ];\n  return gates.map(g=>({...g,status:g.pass?\"PASS\":(g.id===\"GATE-005\" && g.value===\"reqs=0\" ? \"WARN\" : \"FAIL\")}));\n}\n\nfunction moduleHealthScore(mod, summary){\n  const schema = schemaCheck(mod).ok ? 1 : 0;\n  const data = summary.episodes > 0 ? 1 : 0;\n  const driftFactor = Math.max(0, 1 - Math.min(summary.ds, 10)/10);\n  const sealFactor = summary.episodes ? Math.min(1, summary.sealed / summary.episodes) : 0.5;\n  const memoryFactor = Math.min(1, summary.memory / 10);\n  const score = Math.round((0.20*schema + 0.20*data + 0.30*driftFactor + 0.20*sealFactor + 0.10*memoryFactor) * 100);\n  return score;\n}\n\nfunction rollupObject(){\n  const rollup = collectRollup();\n  const schemaRows = MODULES.map(m=>({module:m.id, ...schemaCheck(m)}));\n  const gates = buildControlGates(rollup);\n  const moduleScores = rollup.byModule.map(m=>{\n    const mod = MODULES.find(x=>x.id===m.id);\n    return {module:m.id, score:moduleHealthScore(mod,m)};\n  });\n  const composite = moduleScores.length ? Math.round(moduleScores.reduce((a,b)=>a+b.score,0)/moduleScores.length) : 0;\n\n  return {\n    schema: \"deepsigma_suite_rollup_v1\",\n    generated_at: nowIso(),\n    scope: \"sequoia_edge_suite\",\n    modules: rollup.byModule,\n    totals: rollup.totals,\n    modules_with_data: rollup.modulesWithData,\n    governance_health: governanceHealth(rollup.totals).label,\n    schema_compatibility: schemaRows,\n    control_gates: gates,\n    module_scores: moduleScores,\n    composite_score: composite,\n    storage_keys: MODULES.map(m=>({module:m.id,data_key:m.dataKey,edge_cfg_key:m.edgeCfgKey || null,edge_outbox_key:m.edgeOutboxKey || null,edge_audit_key:m.edgeAuditKey || null}))\n  };\n}\n\nfunction renderList(activeId){\n  const host = document.getElementById(\"moduleList\");\n  host.innerHTML = MODULES.map(m => `\n    <div class=\"module ${m.id===activeId?\"active\":\"\"}\" data-id=\"${esc(m.id)}\">\n      <b>${esc(m.name)}<\/b>\n      <div class=\"meta\">${esc(m.desc)}<\/div>\n      <div class=\"path\">${esc(m.file)}<\/div>\n      <div class=\"row\" style=\"margin-top:6px\">\n        <button data-action=\"open\" data-id=\"${esc(m.id)}\">Open<\/button>\n        <button data-action=\"open-tab\" data-id=\"${esc(m.id)}\">Open Tab<\/button>\n      <\/div>\n    <\/div>\n  `).join(\"\");\n}\n\nfunction renderKeys(){\n  const rows = [];\n  MODULES.forEach(m=>{\n    rows.push(`<div><span class=\"pill\">${esc(m.id)}<\/span><span class=\"mono\">${esc(m.dataKey)}<\/span><\/div>`);\n    if(m.edgeCfgKey) rows.push(`<div class=\"mono\">${esc(m.edgeCfgKey)}<\/div>`);\n    if(m.edgeOutboxKey) rows.push(`<div class=\"mono\">${esc(m.edgeOutboxKey)}<\/div>`);\n    if(m.edgeAuditKey) rows.push(`<div class=\"mono\">${esc(m.edgeAuditKey)}<\/div>`);\n  });\n  document.getElementById(\"keysList\").innerHTML = rows.join(\"\");\n}\n\nfunction renderEdgeStatus(){\n  const lines = [];\n  MODULES.forEach(m=>{\n    if(!m.edgeCfgKey && !m.edgeOutboxKey && !m.edgeAuditKey) return;\n    const cfg = m.edgeCfgKey ? readJson(m.edgeCfgKey) : null;\n    const outbox = m.edgeOutboxKey ? (readJson(m.edgeOutboxKey) || []) : [];\n    const audit = m.edgeAuditKey ? (readJson(m.edgeAuditKey) || {}) : null;\n    const endpoint = cfg?.endpoint ? \"configured\" : \"not set\";\n    const pending = Array.isArray(outbox) ? outbox.length : 0;\n    const receiptCount = Array.isArray(audit?.receipts) ? audit.receipts.length : 0;\n    lines.push(`<div><span class=\"pill\">${esc(m.id)}<\/span> endpoint: ${esc(endpoint)} | outbox: ${pending} | receipts: ${receiptCount}<\/div>`);\n  });\n  document.getElementById(\"edgeStatus\").innerHTML = lines.length ? lines.join(\"\") : \"No edge transport surfaces detected.\";\n}\n\nfunction renderSchemaStatus(){\n  const rows = MODULES.map(m=>{\n    const s = schemaCheck(m);\n    const cls = s.ok ? \"status-ok\" : \"status-warn\";\n    return `<tr><td>${esc(m.name)}<\/td><td class=\"${cls}\">${s.ok?\"OK\":\"WARN\"}<\/td><td>${esc(s.msg)}<\/td><\/tr>`;\n  }).join(\"\");\n  document.getElementById(\"schemaStatus\").innerHTML = `<table><thead><tr><th>Module<\/th><th>Status<\/th><th>Detail<\/th><\/tr><\/thead><tbody>${rows}<\/tbody><\/table>`;\n}\n\nfunction renderKpis(rollup){\n  const health = governanceHealth(rollup.totals);\n  document.getElementById(\"kpiStrip\").innerHTML = `\n    <div class=\"card\"><div class=\"l\">Total Episodes<\/div><div class=\"v\">${rollup.totals.episodes}<\/div><\/div>\n    <div class=\"card\"><div class=\"l\">Total DS<\/div><div class=\"v\">${rollup.totals.ds}<\/div><\/div>\n    <div class=\"card\"><div class=\"l\">Sealed Decisions/Baselines<\/div><div class=\"v\">${rollup.totals.sealed}<\/div><\/div>\n    <div class=\"card\"><div class=\"l\">Modules with Data<\/div><div class=\"v\">${rollup.modulesWithData}/4<\/div><\/div>\n    <div class=\"card\"><div class=\"l\">Truth Footprint<\/div><div class=\"v\">${rollup.totals.truth}<\/div><\/div>\n    <div class=\"card\"><div class=\"l\">Governance Health<\/div><div class=\"v ${health.cls}\">${health.label}<\/div><\/div>\n  `;\n}\n\nfunction renderLenses(rollup){\n  const t = rollup.totals;\n  document.getElementById(\"lensStrip\").innerHTML = `\n    <div class=\"card\"><div class=\"l\">Truth Layer<\/div><div class=\"v\">${t.truth}<\/div><div class=\"l\">Roles/Reqs/Labor evidence points<\/div><\/div>\n    <div class=\"card\"><div class=\"l\">Reasoning Layer<\/div><div class=\"v\">${t.reasoning}<\/div><div class=\"l\">Assumptions, mappings, interview traces<\/div><\/div>\n    <div class=\"card\"><div class=\"l\">Memory Layer<\/div><div class=\"v\">${t.memory}<\/div><div class=\"l\">DS/RS history + gap memory<\/div><\/div>\n    <div class=\"card\"><div class=\"l\">Governance Layer<\/div><div class=\"v\">${t.governance}<\/div><div class=\"l\">Seals, approvals, baselines<\/div><\/div>\n  `;\n}\n\nfunction renderTelemetry(rollup){\n  const rows = rollup.byModule.map(m=>`<tr>\n    <td>${esc(m.name)}<\/td>\n    <td>${m.episodes}<\/td>\n    <td>${m.ds}<\/td>\n    <td>${m.sealed}<\/td>\n    <td>${esc(Object.entries(m.detail).map(([k,v])=>`${k}=${v}`).join(\", \"))}<\/td>\n  <\/tr>`).join(\"\");\n  document.getElementById(\"telemetryTable\").innerHTML = `<table><thead><tr><th>Module<\/th><th>Episodes<\/th><th>DS<\/th><th>Sealed<\/th><th>Detail<\/th><\/tr><\/thead><tbody>${rows}<\/tbody><\/table>`;\n}\n\nfunction renderDsRollup(){\n  const lines = [];\n\n  const hiring = readJson(\"ds_sequoia_hiring_console_v2_artifacts\");\n  (Array.isArray(hiring?.drift) ? hiring.drift.slice(-10).reverse() : []).forEach(d=>lines.push({module:\"hiring\", code:d.code || \"DS-HIRE\", msg:d.msg || \"drift\"}));\n\n  const bid = readJson(\"ds_bidnobid_console_v1\");\n  (Array.isArray(bid?.drift) ? bid.drift.slice(-10).reverse() : []).forEach(d=>lines.push({module:\"bid\", code:d.code || \"DS-BID\", msg:d.msg || \"drift\"}));\n\n  const c = readJson(\"ds_compliance_matrix_v1\");\n  if(c){\n    const reqs = Array.isArray(c.requirements) ? c.requirements : [];\n    const gaps = Array.isArray(c.gaps) ? c.gaps : [];\n    const unassigned = reqs.filter(r=>!String(r?.owner || \"\").trim()).length;\n    const unmapped = reqs.filter(r=>!String(r?.compliance_statement || \"\").trim()).length;\n    const oldGaps = gaps.filter(g=>String(g?.status || \"\") !== \"Resolved\" && daysOld(g?.created) > DS_GAP_AGE_DAYS).length;\n    if(unassigned>0) lines.push({module:\"compliance\", code:\"DS-COMP-001\", msg:`Unassigned requirements: ${unassigned}`});\n    if(oldGaps>0) lines.push({module:\"compliance\", code:\"DS-COMP-002\", msg:`Open gaps older than ${DS_GAP_AGE_DAYS}d: ${oldGaps}`});\n    if(unmapped>0) lines.push({module:\"compliance\", code:\"DS-COMP-004\", msg:`Requirements without compliance statement: ${unmapped}`});\n  }\n\n  const b = readJson(\"ds_boe_pricing_v1\");\n  if(b){\n    const labor = Array.isArray(b.labor) ? b.labor : [];\n    const assumptions = Array.isArray(b.assumptions) ? b.assumptions : [];\n    const missing = labor.filter(l=>!(n(l?.hours)>0) || !(n(l?.rate)>0)).length;\n    const rateOut = labor.filter(l=>n(l?.rate) > RATE_OUTLIER_THRESHOLD).length;\n    const hoursOut = labor.filter(l=>n(l?.hours) > HOURS_OUTLIER_THRESHOLD).length;\n    const cats = new Set(assumptions.map(a=>String(a?.category || \"\").toLowerCase()));\n    const missingDrivers = [\"rates\",\"escalation\",\"productivity\"].filter(x=>!cats.has(x)).length;\n    if(missing>0) lines.push({module:\"boe\", code:\"DS-BOE-001\", msg:`Missing hours/rate lines: ${missing}`});\n    if(rateOut>0) lines.push({module:\"boe\", code:\"DS-BOE-002\", msg:`Rate outliers > $${RATE_OUTLIER_THRESHOLD}: ${rateOut}`});\n    if(hoursOut>0) lines.push({module:\"boe\", code:\"DS-BOE-003\", msg:`Hours outliers > ${HOURS_OUTLIER_THRESHOLD}: ${hoursOut}`});\n    if(missingDrivers>0) lines.push({module:\"boe\", code:\"DS-BOE-004\", msg:`Missing key driver assumptions: ${missingDrivers}`});\n  }\n\n  const host = document.getElementById(\"dsRollup\");\n  if(!lines.length){ host.textContent = \"No active DS signals detected.\"; return; }\n  host.innerHTML = lines.slice(0,40).map(x=>`<div><span class=\"pill\">${esc(x.module)}<\/span><span class=\"pill\">${esc(x.code)}<\/span>${esc(x.msg)}<\/div>`).join(\"\");\n}\n\nfunction trendHistory(){\n  const list = readJson(TREND_KEY);\n  return Array.isArray(list) ? list : [];\n}\nfunction updateTrendSnapshot(rollup){\n  const arr = trendHistory();\n  const day = today();\n  const cur = {date:day, ds:rollup.totals.ds, sealed:rollup.totals.sealed, modules_with_data:rollup.modulesWithData};\n  const i = arr.findIndex(x=>x.date===day);\n  if(i>=0) arr[i]=cur; else arr.push(cur);\n  arr.sort((a,b)=>String(a.date).localeCompare(String(b.date)));\n  const trimmed = arr.slice(-120);\n  writeJson(TREND_KEY, trimmed);\n  return trimmed;\n}\nfunction metricDelta(arr, key, days){\n  if(!arr.length) return {latest:0, prior:0, delta:0};\n  const latest = arr[arr.length-1][key] || 0;\n  const target = new Date(Date.now() - days*86400000).toISOString().slice(0,10);\n  let prior = arr[0][key] || 0;\n  for(let i=arr.length-1;i>=0;i--){ if(arr[i].date <= target){ prior = arr[i][key] || 0; break; } }\n  return {latest, prior, delta: latest-prior};\n}\nfunction renderTrend(arr){\n  const d7ds = metricDelta(arr,\"ds\",7);\n  const d30ds = metricDelta(arr,\"ds\",30);\n  const d7sealed = metricDelta(arr,\"sealed\",7);\n  const d30mods = metricDelta(arr,\"modules_with_data\",30);\n  document.getElementById(\"trendStrip\").innerHTML = `\n    <div class=\"card\">\n      <div class=\"l\">DS Trend<\/div>\n      <div class=\"v\">7d: ${d7ds.delta >= 0 ? \"+\" : \"\"}${d7ds.delta} | 30d: ${d30ds.delta >= 0 ? \"+\" : \"\"}${d30ds.delta}<\/div>\n      <div class=\"l\">latest=${d7ds.latest}<\/div>\n    <\/div>\n    <div class=\"card\">\n      <div class=\"l\">Sealed Trend<\/div>\n      <div class=\"v\">7d: ${d7sealed.delta >= 0 ? \"+\" : \"\"}${d7sealed.delta}<\/div>\n      <div class=\"l\">latest=${d7sealed.latest}<\/div>\n    <\/div>\n    <div class=\"card\">\n      <div class=\"l\">Coverage Trend (modules w/data)<\/div>\n      <div class=\"v\">30d: ${d30mods.delta >= 0 ? \"+\" : \"\"}${d30mods.delta}<\/div>\n      <div class=\"l\">latest=${d30mods.latest}/4<\/div>\n    <\/div>\n  `;\n}\n\nfunction renderGatesAndScores(rollup){\n  const gates = buildControlGates(rollup);\n  document.getElementById(\"gatePanel\").innerHTML = `<table><thead><tr><th>Gate<\/th><th>Status<\/th><th>Value<\/th><\/tr><\/thead><tbody>${gates.map(g=>{\n    const cls = g.status===\"PASS\"?\"status-ok\":(g.status===\"WARN\"?\"status-warn\":\"status-bad\");\n    return `<tr><td>${esc(g.id)} ${esc(g.name)}<\/td><td class=\"${cls}\">${esc(g.status)}<\/td><td>${esc(g.value)}<\/td><\/tr>`;\n  }).join(\"\")}<\/tbody><\/table>`;\n\n  const scores = rollup.byModule.map(m=>{\n    const mod = MODULES.find(x=>x.id===m.id);\n    return {module:m.id, name:m.name, score:moduleHealthScore(mod,m)};\n  });\n  const composite = scores.length ? Math.round(scores.reduce((a,b)=>a+b.score,0)/scores.length) : 0;\n  document.getElementById(\"scorePanel\").innerHTML = `<table><thead><tr><th>Module<\/th><th>Score<\/th><\/tr><\/thead><tbody>${scores.map(s=>`<tr><td>${esc(s.name)}<\/td><td>${s.score}<\/td><\/tr>`).join(\"\")}<tr><td><b>Composite<\/b><\/td><td><b>${composite}<\/b><\/td><\/tr><\/tbody><\/table>`;\n}\n\nfunction renderRollupPreview(obj){\n  document.getElementById(\"rollupPreview\").value = JSON.stringify(obj, null, 2);\n}\n\nfunction selectModule(id){\n  const mod = MODULES.find(m => m.id === id) || MODULES[0];\n  activeModuleId = mod.id;\n  renderList(mod.id);\n  try { location.hash = \"#\" + mod.id; } catch(_) {}\n}\n\nfunction openModule(mod, withTab){\n  const href = withTab ? `${mod.file}${mod.defaultTab || \"\"}` : mod.file;\n  window.open(href, \"_blank\", \"noopener\");\n}\n\nasync function sha256Hex(bytes){\n  const arr = bytes instanceof Uint8Array ? bytes : new Uint8Array(bytes);\n  const out = await crypto.subtle.digest(\"SHA-256\", arr);\n  return Array.from(new Uint8Array(out)).map(b=>b.toString(16).padStart(2,\"0\")).join(\"\");\n}\nfunction utf8(s){ return new TextEncoder().encode(String(s || \"\")); }\nfunction utf8Decode(bytes){ return new TextDecoder().decode(bytes); }\nfunction u16le(buf, i){ return buf[i] | (buf[i+1] << 8); }\nfunction u32le(buf, i){ return (buf[i]) | (buf[i+1] << 8) | (buf[i+2] << 16) | (buf[i+3] << 24); }\n\nasync function inflateRaw(bytes){\n  if(typeof DecompressionStream !== \"function\") throw new Error(\"DecompressionStream not available for deflate entries.\");\n  const ds = new DecompressionStream(\"deflate-raw\");\n  const blob = new Blob([bytes]);\n  const stream = blob.stream().pipeThrough(ds);\n  const ab = await new Response(stream).arrayBuffer();\n  return new Uint8Array(ab);\n}\n\nasync function loadJsZip(){\n  if(window.JSZip) return window.JSZip;\n  await new Promise((resolve, reject)=>{\n    const s = document.createElement(\"script\");\n    s.src = \"https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js\";\n    s.async = true;\n    s.onload = resolve;\n    s.onerror = ()=>reject(new Error(\"Failed to load JSZip CDN fallback.\"));\n    document.head.appendChild(s);\n  });\n  if(!window.JSZip) throw new Error(\"JSZip did not initialize.\");\n  return window.JSZip;\n}\n\nasync function unzipEntries(zipFile){\n  if(typeof DecompressionStream !== \"function\"){\n    const JSZip = await loadJsZip();\n    const zip = await JSZip.loadAsync(zipFile);\n    const out = [];\n    for(const name of Object.keys(zip.files)){\n      const f = zip.files[name];\n      if(f.dir) continue;\n      const data = new Uint8Array(await f.async(\"uint8array\"));\n      out.push({name, data, text: utf8Decode(data)});\n    }\n    return out;\n  }\n  const buf = new Uint8Array(await zipFile.arrayBuffer());\n  const entries = [];\n  let i = 0;\n  while(i + 30 <= buf.length){\n    const sig = u32le(buf, i) >>> 0;\n    if(sig !== 0x04034b50) break;\n    const method = u16le(buf, i + 8);\n    const compSize = u32le(buf, i + 18) >>> 0;\n    const nameLen = u16le(buf, i + 26);\n    const extraLen = u16le(buf, i + 28);\n    const nameStart = i + 30;\n    const dataStart = nameStart + nameLen + extraLen;\n    const dataEnd = dataStart + compSize;\n    if(dataEnd > buf.length) throw new Error(\"ZIP parse failed: truncated entry.\");\n    const name = utf8Decode(buf.slice(nameStart, nameStart + nameLen));\n    const compressed = buf.slice(dataStart, dataEnd);\n    let data;\n    if(method === 0){\n      data = compressed;\n    } else if(method === 8){\n      data = await inflateRaw(compressed);\n    } else {\n      throw new Error(`Unsupported ZIP method ${method} for entry ${name}`);\n    }\n    entries.push({name, data, text: utf8Decode(data)});\n    i = dataEnd;\n  }\n  return entries;\n}\n\nfunction findJson(entries, predicate){\n  const e = entries.find(x => predicate(String(x.name || \"\").toLowerCase()));\n  if(!e) return null;\n  try{ return JSON.parse(e.text); }catch(_){ return null; }\n}\n\nfunction importComplianceFromEntries(entries){\n  const matrix = findJson(entries, n => n.includes(\"/matrix/\") && n.endsWith(\"_compliance_matrix.json\"));\n  if(!matrix || matrix.schema !== \"deepsigma_compliance_matrix_v1\") return {imported:false, reason:\"compliance matrix JSON not found\"};\n  const db = {\n    intake: matrix.intake || {},\n    requirements: Array.isArray(matrix.requirements) ? matrix.requirements : [],\n    deliverables: Array.isArray(matrix.deliverables) ? matrix.deliverables : [],\n    gaps: Array.isArray(matrix.gaps) ? matrix.gaps : [],\n    ds_manual: [],\n    rs: [],\n    meta: {created: nowIso(), version: \"1.0\", imported_from: \"zip\"}\n  };\n  writeJson(\"ds_compliance_matrix_v1\", db);\n  return {imported:true, module:\"compliance\", requirements:db.requirements.length, gaps:db.gaps.length};\n}\n\nfunction importBoeFromEntries(entries){\n  const boe = findJson(entries, n => n.includes(\"/boe/\") && n.includes(\"boe_\") && n.endsWith(\".json\"));\n  if(!boe || boe.schema !== \"deepsigma_boe_v1\") return {imported:false, reason:\"boe JSON not found\"};\n  const db = {\n    intake: boe.intake || {},\n    labor: Array.isArray(boe.labor) ? boe.labor : [],\n    assumptions: Array.isArray(boe.assumptions) ? boe.assumptions : [],\n    risk_model: boe.risk_model || {hours:{best:0.9,base:1,worst:1.15},rate:{best:0.98,base:1,worst:1.05},sensitivity:{escalation:true,surge:false,clearance:false}},\n    approval: boe.approval || {approvers:\"\", authority_note:\"\", decision_note:\"\", sealed:false, sealed_at:null},\n    meta: {created: nowIso(), version: \"1.0\", imported_from: \"zip\"}\n  };\n  writeJson(\"ds_boe_pricing_v1\", db);\n  return {imported:true, module:\"boe\", labor_lines:db.labor.length, assumptions:db.assumptions.length};\n}\n\nfunction importBidFromEntries(entries){\n  const mg = findJson(entries, n => n.includes(\"/mg/\") && n.includes(\"_mg_opportunitygraph_\") && n.endsWith(\".json\"));\n  const assumptions = findJson(entries, n => n.includes(\"/assumptions/\") && n.includes(\"_assumptions_\") && n.endsWith(\".json\"));\n  const risks = findJson(entries, n => n.includes(\"/risks/\") && n.includes(\"_risks_\") && n.endsWith(\".json\"));\n  const manifest = findJson(entries, n => n.endsWith(\"/ingest_manifest.json\"));\n  if(!mg || !Array.isArray(mg.nodes)) return {imported:false, reason:\"bid mg JSON not found\"};\n  const oppNode = mg.nodes.find(n => n && n.type === \"opportunity\") || {};\n  const decNode = mg.nodes.find(n => n && n.type === \"decision\") || null;\n  const oppId = manifest?.opportunity_id || oppNode.id || (Array.isArray(assumptions) && assumptions[0]?.opp_id) || `OPP-${today()}`;\n\n  const existing = readJson(\"ds_bidnobid_console_v1\");\n  const db = (existing && typeof existing === \"object\") ? existing : {opportunities:[], assumptions:[], risks:[], drift:[], rs:[], meta:{created:nowIso(), version:\"1.0\"}};\n  db.opportunities = Array.isArray(db.opportunities) ? db.opportunities : [];\n  db.assumptions = Array.isArray(db.assumptions) ? db.assumptions : [];\n  db.risks = Array.isArray(db.risks) ? db.risks : [];\n  db.drift = Array.isArray(db.drift) ? db.drift : [];\n  db.rs = Array.isArray(db.rs) ? db.rs : [];\n\n  const opp = {\n    id: String(oppId),\n    customer: String(oppNode.customer || \"\"),\n    office: \"\",\n    vehicle: String(oppNode.vehicle || \"\"),\n    naics: \"\",\n    value_band: String(oppNode.value_band || \"\"),\n    pop: \"\",\n    dates: {rfi:\"\", rfp:\"\", q_due:\"\", due:\"\", award_est:\"\"},\n    competitors: \"\",\n    security_needs: \"\",\n    score: {scores:{strategic_fit:0,customer_access:0,capability_fit:0,past_perf:0,capacity_staffing:0,differentiation:0,price_margin:0,risk_complexity:0}, total:0, recommendation:\"Watch\", updated:nowIso()},\n    decision: decNode ? {value:String(decNode.value || \"Watch\"), approver:\"\", authority:\"\", rationale:\"Imported from ZIP\", sealed:!!decNode.sealed, seal:decNode.sealed ? `${nowIso()}|zip-import` : null, updated:nowIso()} : null,\n    created: nowIso(),\n    updated: nowIso()\n  };\n  const oi = db.opportunities.findIndex(x => String(x?.id) === opp.id);\n  if(oi >= 0) db.opportunities[oi] = {...db.opportunities[oi], ...opp, updated: nowIso()};\n  else db.opportunities.push(opp);\n\n  if(Array.isArray(assumptions)){\n    assumptions.forEach(a=>{\n      const rec = {...a, opp_id: a?.opp_id || opp.id, id: a?.id || `ASM-${Math.random().toString(16).slice(2,8).toUpperCase()}`, created: a?.created || nowIso()};\n      if(!db.assumptions.find(x=>String(x?.id)===String(rec.id))) db.assumptions.push(rec);\n    });\n  }\n  if(Array.isArray(risks)){\n    risks.forEach(r=>{\n      const rec = {...r, opp_id: r?.opp_id || opp.id, id: r?.id || `RISK-${Math.random().toString(16).slice(2,8).toUpperCase()}`, created: r?.created || nowIso()};\n      if(!db.risks.find(x=>String(x?.id)===String(rec.id))) db.risks.push(rec);\n    });\n  }\n  db.meta = {...(db.meta || {}), version:\"1.0\", imported_from:\"zip\", updated: nowIso()};\n  writeJson(\"ds_bidnobid_console_v1\", db);\n  return {imported:true, module:\"bid\", opportunities:db.opportunities.length, assumptions:db.assumptions.length, risks:db.risks.length};\n}\n\nasync function importModuleZip(){\n  const zf = document.getElementById(\"zipImportFile\").files?.[0];\n  if(!zf){ document.getElementById(\"importZipResult\").textContent = \"Select a ZIP file first.\"; return; }\n  try{\n    const entries = await unzipEntries(zf);\n    const results = [];\n    const compliance = importComplianceFromEntries(entries); if(compliance.imported) results.push(compliance);\n    const boe = importBoeFromEntries(entries); if(boe.imported) results.push(boe);\n    const bid = importBidFromEntries(entries); if(bid.imported) results.push(bid);\n    if(!results.length){\n      document.getElementById(\"importZipResult\").textContent = JSON.stringify({\n        schema: \"deepsigma_zip_import_v1\",\n        generated_at: nowIso(),\n        file: zf.name,\n        imported: false,\n        message: \"No compatible Bid/Compliance/BOE payload found in ZIP.\"\n      }, null, 2);\n      return;\n    }\n    document.getElementById(\"importZipResult\").textContent = JSON.stringify({\n      schema: \"deepsigma_zip_import_v1\",\n      generated_at: nowIso(),\n      file: zf.name,\n      imported: true,\n      modules: results\n    }, null, 2);\n    refresh();\n  }catch(err){\n    document.getElementById(\"importZipResult\").textContent = `ZIP import failed: ${err.message || err}`;\n  }\n}\n\nasync function verifyEvidence(){\n  const mf = document.getElementById(\"manifestFile\").files?.[0];\n  const hf = document.getElementById(\"hashesFile\").files?.[0];\n  if(!mf || !hf){ document.getElementById(\"verifyResult\").textContent = \"Select manifest and hashes files first.\"; return; }\n  try{\n    const manifest = JSON.parse(await mf.text());\n    const hashesDoc = JSON.parse(await hf.text());\n    const hashes = hashesDoc?.hashes || {};\n    const pairs = Object.entries(hashes).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>`${k} ${v}`).join(\"\\n\");\n    const computed = await sha256Hex(utf8(pairs));\n    const inManifest = manifest?.pack_hash || \"\";\n    const inHashes = hashesDoc?.pack_hash || \"\";\n    const ok = computed && inManifest && inHashes && computed === inManifest && computed === inHashes;\n    document.getElementById(\"verifyResult\").textContent = JSON.stringify({\n      schema: \"deepsigma_pack_verify_v1\",\n      generated_at: nowIso(),\n      manifest_schema: manifest?.schema || null,\n      files_hashed: Object.keys(hashes).length,\n      computed_pack_hash: computed,\n      manifest_pack_hash: inManifest,\n      hashes_pack_hash: inHashes,\n      valid: !!ok\n    }, null, 2);\n  }catch(err){\n    document.getElementById(\"verifyResult\").textContent = `Verification failed: ${err.message || err}`;\n  }\n}\n\nfunction exportRollup(){\n  const obj = rollupObject();\n  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:\"application/json\"});\n  const a = document.createElement(\"a\");\n  a.href = URL.createObjectURL(blob);\n  a.download = `deepsigma_suite_rollup_${today()}.json`;\n  a.click();\n}\n\nfunction printExec(){\n  const obj = rollupObject();\n  const w = window.open(\"\", \"_blank\", \"noopener\");\n  if(!w) return;\n  const html = `<!doctype html><html><head><meta charset=\"utf-8\"/><title>Deep Sigma Executive Snapshot<\/title>\n    <style>body{font-family:system-ui;padding:20px;color:#0f1720}h1{margin:0 0 8px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #c7d1dc;padding:8px;font-size:12px}th{text-align:left;background:#eef4fa}pre{background:#f5f8fb;padding:10px;border:1px solid #d2dbe6}<\/style><\/head><body>\n    <h1>Deep Sigma Executive Snapshot<\/h1><div>Generated: ${esc(obj.generated_at)}<\/div>\n    <h2>Totals<\/h2><pre>${esc(JSON.stringify(obj.totals, null, 2))}<\/pre>\n    <h2>Control Gates<\/h2><table><thead><tr><th>Gate<\/th><th>Status<\/th><th>Value<\/th><\/tr><\/thead><tbody>${obj.control_gates.map(g=>`<tr><td>${esc(g.id)} ${esc(g.name)}<\/td><td>${esc(g.status)}<\/td><td>${esc(g.value)}<\/td><\/tr>`).join(\"\")}<\/tbody><\/table>\n    <h2>Module Scores<\/h2><table><thead><tr><th>Module<\/th><th>Score<\/th><\/tr><\/thead><tbody>${obj.module_scores.map(s=>`<tr><td>${esc(s.module)}<\/td><td>${s.score}<\/td><\/tr>`).join(\"\")}<tr><td><b>Composite<\/b><\/td><td><b>${obj.composite_score}<\/b><\/td><\/tr><\/tbody><\/table>\n    <\/body><\/html>`;\n  w.document.open(); w.document.write(html); w.document.close(); w.focus(); w.print();\n}\n\nfunction refresh(){\n  const rollup = collectRollup();\n  renderKeys();\n  renderEdgeStatus();\n  renderSchemaStatus();\n  renderKpis(rollup);\n  renderLenses(rollup);\n  renderTelemetry(rollup);\n  renderDsRollup();\n  renderGatesAndScores(rollup);\n\n  const hist = updateTrendSnapshot(rollup);\n  renderTrend(hist);\n\n  const obj = rollupObject();\n  renderRollupPreview(obj);\n  document.getElementById(\"zipSupportNote\").textContent =\n    (typeof DecompressionStream === \"function\")\n      ? \"ZIP engine: native DecompressionStream.\"\n      : \"ZIP engine: JSZip CDN fallback will be loaded when needed.\";\n}\n\n(function init(){\n  refresh();\n  renderList(MODULES[0].id);\n  document.getElementById(\"moduleList\").addEventListener(\"click\", (e) => {\n    const card = e.target.closest(\".module\");\n    const btn = e.target.closest(\"button\");\n    if(btn){\n      const mod = MODULES.find(m=>m.id===btn.dataset.id);\n      if(!mod) return;\n      if(btn.dataset.action === \"open\") return openModule(mod, false);\n      if(btn.dataset.action === \"open-tab\") return openModule(mod, true);\n      return;\n    }\n    if(!card) return;\n    selectModule(card.dataset.id);\n  });\n  const hash = (location.hash || \"\").replace(\"#\", \"\").trim();\n  selectModule(hash || MODULES[0].id);\n\n  document.getElementById(\"btnRefresh\")?.addEventListener(\"click\", refresh);\n  document.getElementById(\"btnExportRollup\")?.addEventListener(\"click\", exportRollup);\n  document.getElementById(\"btnPrintExec\")?.addEventListener(\"click\", printExec);\n  document.getElementById(\"btnVerifyPack\")?.addEventListener(\"click\", verifyEvidence);\n  document.getElementById(\"btnImportZip\")?.addEventListener(\"click\", importModuleZip);\n\n  window.addEventListener(\"storage\", refresh);\n  setInterval(refresh, 10000);\n})();\n<\/script>\n<\/body>\n<\/html>\n"},
    "hiring": {title: "Hiring Console v019", desc: "SEQUOIA hiring workflow", html: "<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\"/>\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/>\n  <title>Deep Sigma  SEQUOIA Hiring Console v019<\/title>\n  <style>\n    :root { --bg:#0b0f14; --card:#111824; --muted:#8aa0b5; --txt:#e7eef7; --accent:#7df9ff; --warn:#ffcc66; --bad:#ff6b6b; --ok:#5dff93; }\n    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--txt);}\n    header{padding:16px 18px;border-bottom:1px solid #1b2a3a;display:flex;gap:12px;align-items:center;justify-content:space-between;}\n    .brand{display:flex;flex-direction:column;gap:2px}\n    .brand b{letter-spacing:.5px}\n    .brand small{color:var(--muted)}\n    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}\n    button{background:#182235;color:var(--txt);border:1px solid #243449;border-radius:10px;padding:10px 12px;cursor:pointer}\n    button:hover{border-color:#2f4765}\n    button.primary{border-color:rgba(125,249,255,.45);box-shadow:0 0 0 1px rgba(125,249,255,.12) inset}\n    button.danger{border-color:rgba(255,107,107,.45)}\n    main{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 66px)}\n    nav{border-right:1px solid #1b2a3a;padding:14px}\n    .tab{display:block;width:100%;text-align:left;padding:10px 12px;border-radius:10px;border:1px solid transparent;background:transparent;color:var(--txt);margin-bottom:8px}\n    .tab.active{background:#101a28;border-color:#243449}\n    .wrap{padding:14px 16px;max-width:1200px}\n    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}\n    .card{background:var(--card);border:1px solid #1b2a3a;border-radius:14px;padding:12px}\n    .card h3{margin:0 0 10px 0;font-size:14px;color:#cfe2f7;letter-spacing:.3px}\n    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}\n    input,textarea,select{\n      width:100%;box-sizing:border-box;background:#0d1520;color:var(--txt);\n      border:1px solid #243449;border-radius:10px;padding:10px 10px;font-size:13px;\n    }\n    textarea{min-height:90px;resize:vertical}\n    .muted{color:var(--muted);font-size:12px}\n    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #243449;color:var(--muted);font-size:12px;margin-right:6px}\n    .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}\n    .kpi .card{padding:10px}\n    .kpi b{display:block;font-size:18px;margin-top:4px}\n    table{width:100%;border-collapse:collapse;font-size:13px}\n    th,td{padding:10px;border-bottom:1px solid #1b2a3a;vertical-align:top}\n    th{color:#b9d3ea;text-align:left;font-weight:600}\n    .status{font-weight:600}\n    .s-ok{color:var(--ok)} .s-warn{color:var(--warn)} .s-bad{color:var(--bad)}\n    .flex{display:flex;gap:10px;flex-wrap:wrap}\n    .right{display:flex;gap:10px;justify-content:flex-end;align-items:center}\n    .small{font-size:12px}\n    .hidden{display:none}\n    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;}\n    .split{display:grid;grid-template-columns:1.3fr .7fr;gap:12px}\n    .warnbox{border:1px solid rgba(255,204,102,.35);background:rgba(255,204,102,.06);border-radius:12px;padding:10px}\n  <\/style>\n<\/head>\n<body>\n<div id=\"hud\" style=\"position:fixed;top:72px;right:12px;z-index:9999;background:rgba(125,249,255,.08);border:1px solid rgba(125,249,255,.25);padding:10px;border-radius:12px;font-size:12px;max-width:340px;display:none\"><\/div>\n<div id=\"rsModal\" style=\"display:none;position:fixed;inset:76px 12px 12px 12px;z-index:9998;background:rgba(11,15,20,.98);border:1px solid rgba(125,249,255,.25);border-radius:16px;overflow:auto;padding:12px\"><\/div>\n<header>\n  <div class=\"brand\">\n    <b>Deep Sigma  SEQUOIA Hiring Console<\/b>\n    <small> DLR   RS   DS   MG   SealVersionPatch (local-only) <span id=\"storeWarn\" style=\"display:none;color:#ffcc66\"> storage disabled; using memory only. Use Export JSON/ZIP.<\/span><\/small>\n  <\/div>\n  <div class=\"row\">\n    <button id=\"btnExport\" class=\"primary\">Export JSON<\/button>\n    <button id=\"btnImport\">Import JSON<\/button>\n    <button id=\"btnReset\" class=\"danger\">Reset<\/button>\n  <\/div>\n<\/header>\n\n<main>\n  <nav>\n    <button class=\"tab active\" data-tab=\"dashboard\">Dashboard<\/button>\n    <button class=\"tab\" data-tab=\"roles\">Roles (DLR-ROLE)<\/button>\n    <button class=\"tab\" data-tab=\"candidates\">Candidates (MG)<\/button>\n    <button class=\"tab\" data-tab=\"interviews\">Interviews & Scorecards<\/button>\n    <button class=\"tab\" data-tab=\"board\">Fulfillment Board<\/button>\n    <button class=\"tab\" data-tab=\"drift\">Drift Signals (DS)<\/button>\n    <button class=\"tab\" data-tab=\"test\">Test Mode<\/button>\n    <button class=\"tab\" data-tab=\"rs\">RS Sessions<\/button>\n    <button class=\"tab\" data-tab=\"artifacts\">Artifacts Generator<\/button>\n    <div style=\"margin-top:14px\" class=\"muted\">\n      Data stored in <span class=\"mono\">localStorage<\/span>. Export for sharing.\n    <\/div>\n  <\/nav>\n\n  <div class=\"wrap\">\n    <!-- DASHBOARD -->\n    <section id=\"tab-dashboard\">\n      <div class=\"kpi\">\n        <div class=\"card\"><div class=\"muted\">Open Roles<\/div><b id=\"kOpenRoles\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Active Candidates<\/div><b id=\"kCandidates\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">In Interview<\/div><b id=\"kInInterview\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Offers Out<\/div><b id=\"kOffers\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Started<\/div><b id=\"kStarted\">0<\/b><\/div>\n      <\/div>\n\n      <div class=\"kpi\" style=\"margin-top:12px\">\n        <div class=\"card\"><div class=\"muted\">Avg Time-to-Offer<\/div><b id=\"kTimeToOffer\"><\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Offer Acceptance<\/div><b id=\"kOfferAccept\"><\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Variance Breaches<\/div><b id=\"kVarBreaches\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Stuck Candidates<\/div><b id=\"kStuck\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Auto DS Alerts<\/div><b id=\"kAutoDs\">0<\/b><\/div>\n      <\/div>\n\n      <div class=\"grid\" style=\"margin-top:12px\">\n        <div class=\"card\">\n          <h3>Fast Actions<\/h3>\n          <div class=\"flex\">\n            <button class=\"primary\" id=\"btnSeed\">Seed SEQUOIA roles<\/button>\n            <button id=\"btnNewRole\">+ New Role<\/button>\n            <button id=\"btnNewCandidate\">+ New Candidate<\/button>\n            <button id=\"btnNewInterview\">+ New Interview<\/button>\n            <button id=\"btnGoArtifacts\" class=\"primary\">Generate Artifacts <\/button>\n            <button id=\"btnGoRS\">RS <\/button>\n          <\/div>\n          <p class=\"muted\" style=\"margin-top:10px\">\n            Stark rule: 3-gate loop, same-day decision, offer within 24h of Gate 3.\n          <\/p>\n        <\/div>\n        <div class=\"card\">\n          <h3>Hiring SLOs<\/h3>\n          <ul class=\"muted\">\n            <li>Time-to-Offer  7 days<\/li>\n            <li>Offer Acceptance  70%<\/li>\n            <li>Interviewer variance (RFS)  15 pts<\/li>\n            <li>&quot;Why retrieval&quot;  60 seconds (decision reconstructable)<\/li>\n          <\/ul>\n        <\/div>\n      <\/div>\n\n      <div class=\"card\" style=\"margin-top:12px\">\n        <h3>Latest Drift Alerts (DS)<\/h3>\n        <div id=\"driftList\" class=\"muted\">No drift yet.<\/div>\n      <\/div>\n    <\/section>\n\n    <!-- ROLES -->\n    <section id=\"tab-roles\" class=\"hidden\">\n      <div class=\"card\">\n        <h3>Create / Edit Role (DLR-ROLE)<\/h3>\n        <div class=\"grid\">\n          <div>\n            <label>Role ID (DLR-ROLE-###)<\/label>\n            <input id=\"roleId\" placeholder=\"DLR-ROLE-001\"/>\n          <\/div>\n          <div>\n            <label>Role Name<\/label>\n            <input id=\"roleName\" placeholder=\"Program Manager (PM)\"/>\n          <\/div>\n        <\/div>\n        <div class=\"grid\">\n          <div>\n            <label>Wave<\/label>\n            <select id=\"roleWave\">\n              <option>Wave 1  Mobilize<\/option>\n              <option>Wave 2  Factory<\/option>\n              <option>Wave 3  Integration<\/option>\n            <\/select>\n          <\/div>\n          <div>\n            <label>Labor Category (mapping)<\/label>\n            <input id=\"roleLabor\" placeholder=\"Program Manager / Project Manager / ISSO / ...\"/>\n          <\/div>\n        <\/div>\n        <label>Mission (90 days)<\/label>\n        <textarea id=\"roleMission\" placeholder=\"Stand up contract governance + delivery rhythm; meet SLOs...\"><\/textarea>\n\n        <div class=\"grid\">\n          <div>\n            <label>Must-Haves (max 5, one per line)<\/label>\n            <textarea id=\"roleMust\" placeholder=\"1) ...\"><\/textarea>\n          <\/div>\n          <div>\n            <label>Nice-to-Haves (one per line)<\/label>\n            <textarea id=\"roleNice\" placeholder=\"...\"><\/textarea>\n          <\/div>\n        <\/div>\n\n        <label>Gate 2 Simulation Prompt<\/label>\n        <textarea id=\"roleSim\" placeholder=\"Week 1 mission scenario...\"><\/textarea>\n\n        <div class=\"right\" style=\"margin-top:10px\">\n          <span class=\"muted small\" id=\"roleSavedHint\"><\/span>\n          <button id=\"btnSaveRole\" class=\"primary\">Save Role<\/button>\n          <button id=\"btnClearRole\">Clear<\/button>\n        <\/div>\n      <\/div>\n\n      <div class=\"card\" style=\"margin-top:12px\">\n        <h3>Roles<\/h3>\n        <div id=\"rolesTable\"><\/div>\n      <\/div>\n    <\/section>\n\n    <!-- CANDIDATES -->\n    <section id=\"tab-candidates\" class=\"hidden\">\n      <div class=\"card\">\n        <h3>Create / Edit Candidate (MG Node)<\/h3>\n        <div class=\"grid\">\n          <div>\n            <label>Candidate ID<\/label>\n            <input id=\"candId\" placeholder=\"C-0001\"/>\n          <\/div>\n          <div>\n            <label>Name (or redacted handle)<\/label>\n            <input id=\"candName\" placeholder=\"Candidate A\"/>\n          <\/div>\n        <\/div>\n        <div class=\"grid\">\n          <div>\n            <label>Target Role<\/label>\n            <select id=\"candRole\"><\/select>\n          <\/div>\n          <div>\n            <label>Status<\/label>\n            <select id=\"candStatus\">\n              <option>Sourcing<\/option>\n              <option>Screened<\/option>\n              <option>Gate2<\/option>\n              <option>Gate3<\/option>\n              <option>Offer<\/option>\n              <option>Accepted<\/option>\n              <option>Cleared<\/option>\n              <option>Started<\/option>\n            <\/select>\n          <\/div>\n        <\/div>\n        <div class=\"grid\">\n          <div>\n            <label>Clearance<\/label>\n            <input id=\"candClearance\" placeholder=\"TS/SCI (eligible) / Secret / None\"/>\n          <\/div>\n          <div>\n            <label>Availability Date<\/label>\n            <input id=\"candAvail\" placeholder=\"YYYY-MM-DD\"/>\n          <\/div>\n        <\/div>\n        <div class=\"grid\">\n          <div>\n            <label>Comp Range (candidate)<\/label>\n            <input id=\"candComp\" placeholder=\"$...\"/>\n          <\/div>\n          <div>\n            <label>Evidence Links (one per line)<\/label>\n            <textarea id=\"candEvidence\" placeholder=\"GitHub / writing / work samples...\"><\/textarea>\n          <\/div>\n        <\/div>\n        <label>Risk Flags (Red/Yellow)<\/label>\n        <textarea id=\"candRisks\" placeholder=\"Red: ...&#10;Yellow: ...\"><\/textarea>\n\n        <div class=\"right\" style=\"margin-top:10px\">\n          <span class=\"muted small\" id=\"candSavedHint\"><\/span>\n          <button id=\"btnSaveCandidate\" class=\"primary\">Save Candidate<\/button>\n          <button id=\"btnClearCandidate\">Clear<\/button>\n        <\/div>\n      <\/div>\n\n      <div class=\"card\" style=\"margin-top:12px\">\n        <h3>Candidates<\/h3>\n        <div id=\"candsTable\"><\/div>\n      <\/div>\n    <\/section>\n\n    <!-- INTERVIEWS -->\n    <section id=\"tab-interviews\" class=\"hidden\">\n      <div class=\"card\">\n        <h3>Create Interview + Sealed Scorecard<\/h3>\n        <div class=\"grid\">\n          <div>\n            <label>Interview ID<\/label>\n            <input id=\"intId\" placeholder=\"I-0001\"/>\n          <\/div>\n          <div>\n            <label>Candidate<\/label>\n            <select id=\"intCand\"><\/select>\n          <\/div>\n        <\/div>\n        <div class=\"grid\">\n          <div>\n            <label>Gate<\/label>\n            <select id=\"intGate\">\n              <option>Gate 1  Screen<\/option>\n              <option>Gate 2  Simulation<\/option>\n              <option>Gate 3  Execution & Trust<\/option>\n            <\/select>\n          <\/div>\n          <div>\n            <label>Interviewer<\/label>\n            <input id=\"intInterviewer\" placeholder=\"Interviewer Name\"/>\n          <\/div>\n        <\/div>\n\n        <div class=\"grid\">\n          <div>\n            <label>RFS (0100)<\/label>\n            <input id=\"sRfs\" type=\"number\" min=\"0\" max=\"100\" placeholder=\"80\"/>\n          <\/div>\n          <div>\n            <label>TPS (0100)<\/label>\n            <input id=\"sTps\" type=\"number\" min=\"0\" max=\"100\" placeholder=\"70\"/>\n          <\/div>\n        <\/div>\n        <div class=\"grid\">\n          <div>\n            <label>UR (0.01.0)<\/label>\n            <input id=\"sUr\" type=\"number\" step=\"0.01\" min=\"0\" max=\"1\" placeholder=\"0.65\"/>\n          <\/div>\n          <div>\n            <label>Decision<\/label>\n            <select id=\"sDecision\">\n              <option>Hire<\/option>\n              <option>Hold<\/option>\n              <option>No-Hire<\/option>\n            <\/select>\n          <\/div>\n        <\/div>\n\n        <label>Evidence (one per line)<\/label>\n        <textarea id=\"sEvidence\"><\/textarea>\n        <label>Notes<\/label>\n        <textarea id=\"sNotes\"><\/textarea>\n        <label>Flags (Red/Yellow)<\/label>\n        <textarea id=\"sFlags\" placeholder=\"Red: ...&#10;Yellow: ...\"><\/textarea>\n\n        <div class=\"right\" style=\"margin-top:10px\">\n          <span class=\"muted small\" id=\"intSavedHint\"><\/span>\n          <button id=\"btnSaveInterview\" class=\"primary\">Save Interview<\/button>\n          <button id=\"btnClearInterview\">Clear<\/button>\n        <\/div>\n      <\/div>\n\n      <div class=\"card\" style=\"margin-top:12px\">\n        <h3>Interviews<\/h3>\n        <div id=\"intsTable\"><\/div>\n      <\/div>\n    <\/section>\n\n    <!-- BOARD -->\n    <section id=\"tab-board\" class=\"hidden\">\n      <div class=\"card\">\n        <h3>Fulfillment Board<\/h3>\n        <div id=\"boardTable\"><\/div>\n        <p class=\"muted\" style=\"margin-top:10px\">\n          States: Sourcing  Screened  Gate2  Gate3  Offer  Accepted  Cleared  Started\n        <\/p>\n      <\/div>\n    <\/section>\n\n    <!-- DRIFT -->\n    <section id=\"tab-drift\" class=\"hidden\">\n      <div class=\"card\">\n        <h3>Drift Signals (DS)  Hiring<\/h3>\n        <p class=\"muted\">Auto-detects DS triggers from your interview data and records alerts.<\/p>\n        <div id=\"driftTable\"><\/div>\n        <div class=\"right\" style=\"margin-top:10px\">\n          <button id=\"btnRunDrift\" class=\"primary\">Run Drift Scan<\/button>\n        <\/div>\n      <\/div>\n    \n    <!-- RS -->\n    <section id=\"tab-rs\" class=\"hidden\">\n      <div class=\"card\" style=\"margin-bottom:12px\">\n        <h3>RS Sessions<\/h3>\n        <div class=\"muted\">Weekly Hiring Reflection  create, auto-fill snapshot, add patches, seal, export.<\/div>\n      <\/div>\n\n      <div class=\"card\">\n        <h3>Create / Update RS<\/h3>\n\n        <div class=\"grid\">\n          <div>\n            <label>RS ID<\/label>\n            <input id=\"rsId\" placeholder=\"RS-0001\"/>\n          <\/div>\n          <div>\n            <label>Week Of (YYYY-MM-DD)<\/label>\n            <input id=\"rsWeek\" placeholder=\"YYYY-MM-DD\"/>\n          <\/div>\n        <\/div>\n\n        <div class=\"grid\">\n          <div>\n            <label>Coherence Steward<\/label>\n            <input id=\"rsSteward\" placeholder=\"(name)\"/>\n          <\/div>\n          <div>\n            <label>Seal<\/label>\n            <select id=\"rsSealed\">\n              <option value=\"false\">Open (editable)<\/option>\n              <option value=\"true\">Sealed (freeze)<\/option>\n            <\/select>\n          <\/div>\n        <\/div>\n\n        <div class=\"card\" style=\"margin-top:12px\">\n          <div style=\"display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap\">\n            <h3 style=\"margin:0\">Auto Snapshot<\/h3>\n            <div class=\"flex\">\n              <button id=\"btnCreateRSNow\" class=\"primary\">Create RS (this week)<\/button>\n              <button id=\"btnAutoFillRS\" class=\"primary\">Auto-Fill Snapshot<\/button>\n            <\/div>\n          <\/div>\n          <div id=\"rsSnapshot\" class=\"muted\" style=\"margin-top:10px\">Create an RS to populate snapshot.<\/div>\n        <\/div>\n\n        <label>Decisions (one per line)<\/label>\n        <textarea id=\"rsDecisions\" placeholder=\"- Decision 1&#10;- Decision 2\"><\/textarea>\n\n        <div class=\"card\" style=\"margin-top:12px\">\n          <h3>Patches<\/h3>\n          <div class=\"muted small\">Changes to the hiring system: rubric, gate design, sourcing lane, comp, capacity.<\/div>\n\n          <div class=\"grid\" style=\"margin-top:10px\">\n            <div>\n              <label>Patch Title<\/label>\n              <input id=\"patchTitle\" placeholder=\"Tighten Gate 2 scoring anchors for PM\"/>\n            <\/div>\n            <div>\n              <label>Owner<\/label>\n              <input id=\"patchOwner\" placeholder=\"(name)\"/>\n            <\/div>\n          <\/div>\n          <div class=\"grid\">\n            <div>\n              <label>Due (YYYY-MM-DD)<\/label>\n              <input id=\"patchDue\" placeholder=\"YYYY-MM-DD\"/>\n            <\/div>\n            <div>\n              <label>Success Metric<\/label>\n              <input id=\"patchMetric\" placeholder=\"Variance breaches  0; Time-to-offer  7d\"/>\n            <\/div>\n          <\/div>\n          <div class=\"right\" style=\"margin-top:10px\">\n            <button id=\"btnAddPatch\">+ Add Patch<\/button>\n          <\/div>\n          <div id=\"patchesTable\" style=\"margin-top:10px\"><\/div>\n        <\/div>\n\n        <div class=\"right\" style=\"margin-top:10px\">\n          <span class=\"muted small\" id=\"rsSavedHint\"><\/span>\n          <button id=\"btnSaveRS\" class=\"primary\">Save RS<\/button>\n          <button id=\"btnExportRS\">Export RS.md<\/button>\n          <button id=\"btnExportExec\">Export Exec Brief.md<\/button>\n          <button id=\"btnClearRS\" class=\"danger\">Clear<\/button>\n        <\/div>\n      <\/div>\n\n      <div class=\"card\" style=\"margin-top:12px\">\n        <h3>RS Sessions List<\/h3>\n        <div id=\"rsTable\" style=\"margin-top:10px\"><\/div>\n      <\/div>\n    <\/section>\n\n<\/section>\n\n    \n    <!-- TEST MODE -->\n    <section id=\"tab-test\" class=\"hidden\">\n      <div class=\"card\">\n        <h3>Test Mode<\/h3>\n        <div class=\"muted\">Generate realistic sample data and automatically validate: ZIP export, manifest, hashing, safe export, SLO/Auto DS, and Offer artifacts.<\/div>\n\n        <div class=\"grid\" style=\"margin-top:12px\">\n          <div>\n            <label>Sample Candidates Count<\/label>\n            <input id=\"tmCount\" type=\"number\" min=\"1\" max=\"200\" value=\"10\"/>\n          <\/div>\n          <div>\n            <label>Safe Export for Test Run<\/label>\n            <select id=\"tmSafe\">\n              <option value=\"false\">Off<\/option>\n              <option value=\"true\">On (Lite)<\/option>\n              <option value=\"strict\">On (Strict)<\/option>\n            <\/select>\n          <\/div>\n        <\/div>\n\n        <div class=\"grid\">\n          <div>\n            <label>Simulate Aging (days)<\/label>\n            <input id=\"tmAgeDays\" type=\"number\" min=\"0\" max=\"60\" value=\"10\"/>\n          <\/div>\n          <div>\n            <label>Notes<\/label>\n            <input id=\"tmNotes\" placeholder=\"Test run notes (optional)\"/>\n          <\/div>\n        <\/div>\n\n        <div class=\"flex\" style=\"margin-top:10px\">\n          <button id=\"tmSeedRoles\" class=\"primary\">Seed Roles<\/button>\n          <button id=\"tmGenData\" class=\"primary\">Generate Sample Data<\/button>\n          <button id=\"tmTriggerVariance\">Trigger Variance Breach<\/button>\n          <button id=\"tmMakeOffer\">Create Offer + Accepted<\/button>\n          <button id=\"tmSimAging\">Simulate Aging<\/button>\n        <\/div>\n\n        <div class=\"flex\" style=\"margin-top:10px\">\n          <button id=\"tmRunAll\" class=\"primary\">RUN FULL TEST<\/button>\n          <button id=\"tmDownloadZip\" class=\"primary\">Download ZIP Pack<\/button>\n          <button id=\"tmReset\" class=\"danger\">Reset Data<\/button>\n        <\/div>\n\n        <div class=\"card\" style=\"margin-top:12px\">\n          <h3>Test Log<\/h3>\n          <pre id=\"tmLog\" class=\"mono\" style=\"white-space:pre-wrap;margin:0\"><\/pre>\n        <\/div>\n      <\/div>\n    <\/section>\n\n<!-- ARTIFACTS -->\n    <section id=\"tab-artifacts\" class=\"hidden\">\n      <div class=\"split\">\n        <div class=\"card\">\n          <h3>Artifacts Generator<\/h3>\n          <div class=\"warnbox muted\">\n            This exports files to your machine. Nothing is sent anywhere.\n          <\/div>\n\n          <label>Pack Prefix<\/label>\n          <input id=\"packPrefix\" placeholder=\"SEQUOIA\" value=\"SEQUOIA\"/>\n\n          <div class=\"grid\" style=\"margin-top:10px\">\n            <div>\n              <label>Safe Export (redact PII)<\/label>\n              <select id=\"safeExport\">\n                <option value=\"false\">Off<\/option>\n                <option value=\"true\">On<\/option>\n              <\/select>\n            <\/div>\n            <div>\n              <label>Safe Export Level<\/label>\n              <select id=\"safeExportLevel\">\n                <option value=\"lite\">Lite (mask name/comp/clearance)<\/option>\n                <option value=\"strict\">Strict (also strip evidence links)<\/option>\n              <\/select>\n            <\/div>\n          <\/div>\n\n          <label>Organization / Program<\/label>\n          <input id=\"orgProgram\" placeholder=\"NGA  SEQUOIA\"/>\n\n          <label>Coherence Steward<\/label>\n          <input id=\"cohSteward\" placeholder=\"(name)\"/>\n\n          <label>Approval / Authority Note<\/label>\n          <textarea id=\"authorityNote\" placeholder=\"Who can approve hiring decisions, offers, role changes, and policy shifts...\"><\/textarea>\n\n          <div class=\"card\" style=\"margin-top:12px\">\n            <h3>Edge Sync (DeepSigma Enterprise)<\/h3>\n            <div class=\"grid\">\n              <div>\n                <label>Enterprise Intake Endpoint<\/label>\n                <input id=\"edgeEndpoint\" placeholder=\"https://your-enterprise-host/api/edge/intake\"/>\n              <\/div>\n              <div>\n                <label>Bearer Token<\/label>\n                <input id=\"edgeToken\" type=\"password\" placeholder=\"Optional token for Authorization header\"/>\n              <\/div>\n            <\/div>\n            <div class=\"grid\" style=\"margin-top:10px\">\n              <div>\n                <label>Manifest Signing Key (HMAC)<\/label>\n                <input id=\"edgeSignKey\" type=\"password\" placeholder=\"Optional shared key for manifest signature\"/>\n              <\/div>\n              <div>\n                <label>Outbox<\/label>\n                <div class=\"muted\" id=\"edgeOutboxCount\">Outbox: 0 pending<\/div>\n              <\/div>\n            <\/div>\n            <div class=\"flex\" style=\"margin-top:10px\">\n              <button class=\"primary\" id=\"btnSyncPack\">Sync ZIP Pack to Enterprise<\/button>\n              <button id=\"btnRetryOutbox\">Retry Outbox<\/button>\n            <\/div>\n            <div id=\"edgeSyncStatus\" class=\"muted small\" style=\"margin-top:8px\">Status: not synced<\/div>\n          <\/div>\n\n          <div class=\"flex\" style=\"margin-top:10px\">\n            <button class=\"primary\" id=\"btnDLRRoles\">Download DLR-ROLE MDs<\/button>\n            <button class=\"primary\" id=\"btnMG\">Download MG_TalentGraph.json<\/button>\n            <button class=\"primary\" id=\"btnScorecards\">Download SCORECARDS.json<\/button>\n\t    <button class=\"primary\" id=\"btnZipPack\">Download ZIP Pack<\/button>\n          <\/div>\n\n          <div class=\"flex\" style=\"margin-top:10px\">\n            <button id=\"btnRSTemplate\">Download RS_HIRING_WEEKLY.md<\/button>\n            <button id=\"btnDSTemplate\">Download DS_HIRING.md<\/button>\n          <\/div>\n\n          <div class=\"card\" style=\"margin-top:12px\">\n            <h3>Offer Generator (per candidate)<\/h3>\n            <div id=\"offersList\" class=\"muted\">No candidates in Offer status.<\/div>\n          <\/div>\n\n          <p class=\"muted small\" style=\"margin-top:10px\">\n            Tip: Export JSON daily. Treat the export file as the &quot;portable system of record&quot; until you wire SharePoint/PowerApp.\n          <\/p>\n        <\/div>\n\n        <div class=\"card\">\n          <h3>Preview<\/h3>\n          <div class=\"muted\">Select an export action to preview the first generated artifact here.<\/div>\n          <pre id=\"preview\" class=\"mono\" style=\"white-space:pre-wrap;margin-top:10px;\"><\/pre>\n        <\/div>\n      <\/div>\n    <\/section>\n  <\/div>\n<\/main>\n\n<input id=\"fileImport\" type=\"file\" accept=\"application/json\" class=\"hidden\"/>\n<script>\nconst KEY = \"ds_sequoia_hiring_console_v2_artifacts\";\nconst EDGE_CFG_KEY = \"ds_sequoia_edge_cfg_v1\";\nconst EDGE_OUTBOX_KEY = \"ds_sequoia_edge_outbox_v1\";\n\nfunction storageAvailable(){\n  try{\n    const x=\"__ds_test__\";\n    window.localStorage.setItem(x,x);\n    window.localStorage.removeItem(x);\n    return true;\n  } catch(e){\n    return false;\n  }\n}\n\nfunction getStoreItem(k){\n  if(storageAvailable()) return window.localStorage.getItem(k);\n  return (window.__ds_memstore && window.__ds_memstore[k]) ? window.__ds_memstore[k] : null;\n}\nfunction setStoreItem(k,v){\n  if(storageAvailable()) return window.localStorage.setItem(k,v);\n  window.__ds_memstore ||= {};\n  window.__ds_memstore[k]=v;\n}\nfunction removeStoreItem(k){\n  if(storageAvailable()) return window.localStorage.removeItem(k);\n  if(window.__ds_memstore) delete window.__ds_memstore[k];\n}\n\nfunction edgeCfgDefault(){\n  return { endpoint:\"\", token:\"\", sign_key:\"\" };\n}\nfunction loadEdgeCfg(){\n  const raw = getStoreItem(EDGE_CFG_KEY);\n  if(!raw) return edgeCfgDefault();\n  try{\n    const cfg = JSON.parse(raw);\n    return {\n      endpoint: cfg.endpoint || \"\",\n      token: cfg.token || \"\",\n      sign_key: cfg.sign_key || \"\"\n    };\n  }catch(_){\n    return edgeCfgDefault();\n  }\n}\nfunction saveEdgeCfg(){\n  const cfg = {\n    endpoint: v(\"edgeEndpoint\"),\n    token: v(\"edgeToken\"),\n    sign_key: v(\"edgeSignKey\")\n  };\n  setStoreItem(EDGE_CFG_KEY, JSON.stringify(cfg));\n}\nfunction loadOutbox(){\n  const raw = getStoreItem(EDGE_OUTBOX_KEY);\n  if(!raw) return [];\n  try{\n    const x = JSON.parse(raw);\n    return Array.isArray(x) ? x : [];\n  }catch(_){\n    return [];\n  }\n}\nfunction saveOutbox(items){\n  setStoreItem(EDGE_OUTBOX_KEY, JSON.stringify(items));\n  updateOutboxBadge();\n}\nfunction updateOutboxBadge(){\n  const n = loadOutbox().length;\n  const el = document.getElementById(\"edgeOutboxCount\");\n  if(el) el.textContent = `Outbox: ${n} pending`;\n}\nfunction syncStatus(msg, ok){\n  const el = document.getElementById(\"edgeSyncStatus\");\n  if(!el) return;\n  el.textContent = `Status: ${msg}`;\n  el.style.color = ok===true ? \"var(--ok)\" : ok===false ? \"var(--bad)\" : \"var(--muted)\";\n}\nfunction stableStringify(value){\n  if(value===null || typeof value!==\"object\") return JSON.stringify(value);\n  if(Array.isArray(value)) return `[${value.map(stableStringify).join(\",\")}]`;\n  const keys = Object.keys(value).sort();\n  return `{${keys.map(k=>`${JSON.stringify(k)}:${stableStringify(value[k])}`).join(\",\")}}`;\n}\nfunction b64FromBytes(bytes){\n  let s = \"\";\n  const arr = bytes instanceof Uint8Array ? bytes : new Uint8Array(bytes);\n  for(let i=0;i<arr.length;i++) s += String.fromCharCode(arr[i]);\n  return btoa(s);\n}\nfunction b64FromArrayBuffer(buf){\n  return b64FromBytes(new Uint8Array(buf));\n}\nfunction bytesFromB64(b64){\n  const bin = atob(b64);\n  const out = new Uint8Array(bin.length);\n  for(let i=0;i<bin.length;i++) out[i] = bin.charCodeAt(i);\n  return out;\n}\nasync function signManifest(manifest, signKey){\n  if(!signKey) return null;\n  const key = await crypto.subtle.importKey(\n    \"raw\",\n    strToUtf8Bytes(signKey),\n    {name:\"HMAC\", hash:\"SHA-256\"},\n    false,\n    [\"sign\"]\n  );\n  const material = strToUtf8Bytes(stableStringify(manifest));\n  const sig = await crypto.subtle.sign(\"HMAC\", key, material);\n  return b64FromArrayBuffer(sig);\n}\n\nasync function createZipPackPayload(){\n  const db0 = load();\n  const meta = packMeta();\n  const root = `${safeFile(meta.prefix)}_HiringPack_${meta.date}`;\n  const entries = [];\n  const ts = new Date();\n\n  const addText = (path, text) => {\n    const bytes = strToUtf8Bytes(text);\n    entries.push({name: `${root}/${path}`, bytes, mtime: ts});\n    return bytes;\n  };\n  const addJson = (path, obj) => {\n    const text = JSON.stringify(obj, null, 2);\n    const bytes = strToUtf8Bytes(text);\n    entries.push({name: `${root}/${path}`, bytes, mtime: ts});\n    return bytes;\n  };\n\n  // Roles\n  if(db0.roles.length){\n    db0.roles.forEach(r=>{\n      addText(`roles_dlr_role/${safeFile(meta.prefix)}_${safeFile(r.id)}_${safeFile(r.name)}.md`, mdRole(r, meta));\n    });\n  } else addText(\"roles_dlr_role/_empty.txt\", \"No roles found.\");\n\n  // MG + Scorecards\n  const mg = buildMG(meta);\n  addJson(`mg/${safeFile(meta.prefix)}_MG_TalentGraph_${meta.date}.json`, mg);\n\n  const sc = buildScorecards(meta);\n  addJson(`scorecards/${safeFile(meta.prefix)}_SCORECARDS_${meta.date}.json`, sc);\n\n  // RS template + DS snapshot\n  addText(`rs/${safeFile(meta.prefix)}_RS_HIRING_WEEKLY_${meta.date}.md`, buildRS(meta));\n  addText(`ds/${safeFile(meta.prefix)}_DS_HIRING_${meta.date}.md`, buildDS(meta));\n\n  // RS sessions\n  if(db0.rs && db0.rs.length){\n    db0.rs.forEach(s=>{\n      addText(`rs_sessions/${safeFile(meta.prefix)}_RS_${safeFile(s.id)}_${s.week_of}.md`, rsToMarkdown(s, meta));\n      addText(`rs_sessions/${safeFile(meta.prefix)}_EXEC_BRIEF_${safeFile(s.id)}_${s.week_of}.md`, rsExecBrief(s, meta));\n    });\n  } else addText(\"rs_sessions/_none.txt\", \"No RS sessions recorded.\");\n\n  // Offers\n  const offers = db0.candidates.filter(c=>c.status===\"Offer\");\n  if(offers.length){\n    offers.forEach((c,idx)=>{\n      const cc = redactCandidate(c, idx);\n      const r = db0.roles.find(x=>x.id===c.role) || {id:c.role, name:\"(role not found)\"};\n      addText(`offers_dlr_offer/${safeFile(meta.prefix)}_DLR_OFFER_${safeFile(cc.id)}_${safeFile(cc.name)}_${meta.date}.md`, buildOfferMD(cc, r, meta));\n    });\n  } else addText(\"offers_dlr_offer/_none.txt\", \"No candidates in Offer status.\");\n\n  // Manifest + hashes\n  const manifest = {\n    schema: \"deepsigma_ingest_manifest_v1\",\n    meta,\n    counts: {\n      roles: db0.roles.length,\n      candidates: db0.candidates.length,\n      interviews: db0.interviews.length,\n      drift: db0.drift.length,\n      rs_sessions: (db0.rs||[]).length,\n      offers: offers.length\n    },\n    hashes_file: \"hashes.json\"\n  };\n\n  const hashes = {};\n  for(const e of entries){\n    hashes[e.name] = await sha256Hex(e.bytes);\n  }\n  const pack_hash_material = strToUtf8Bytes(Object.entries(hashes).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>`${k} ${v}`).join(\"\\n\"));\n  const pack_hash = await sha256Hex(pack_hash_material);\n  manifest.pack_hash = pack_hash;\n\n  addJson(\"ingest_manifest.json\", manifest);\n  addJson(\"hashes.json\", {pack_hash, hashes});\n\n  addText(\"README.md\", `# ${meta.prefix} Hiring Pack (ZIP)\\nProgram: ${meta.program}\\nGenerated: ${meta.generated}\\nSafe export: ${meta.safe_export} (${meta.safe_export_level})\\n\\nIncludes manifest + SHA-256 hashes.\\n`);\n\n  const zipBlob = buildZip(entries);\n  return {root, manifest, hashes, zipBlob, meta};\n}\n\nasync function downloadZipPack(){\n  const {root, manifest, zipBlob} = await createZipPackPayload();\n  previewText(JSON.stringify(manifest, null, 2));\n  const a = document.createElement(\"a\");\n  a.href = URL.createObjectURL(zipBlob);\n  a.download = `${root}.zip`;\n  a.click();\n}\n\nasync function postPackToEnterprise(pack, cfg){\n  const zipBytes = new Uint8Array(await pack.zipBlob.arrayBuffer());\n  const signature = await signManifest(pack.manifest, cfg.sign_key || \"\");\n  const payload = {\n    schema: \"deepsigma_edge_sync_v1\",\n    sent_at: nowIso(),\n    client: {app: \"NGA_SEQUOIA_UI\", version: \"0.19\"},\n    root: pack.root,\n    manifest: pack.manifest,\n    hashes: pack.hashes,\n    zip_b64: b64FromBytes(zipBytes),\n    signature: signature ? {alg: \"HMAC-SHA256\", value_b64: signature} : null\n  };\n  const headers = {\"Content-Type\":\"application/json\"};\n  if(cfg.token) headers[\"Authorization\"] = `Bearer ${cfg.token}`;\n  if(signature) headers[\"X-DeepSigma-Signature\"] = signature;\n  const res = await fetch(cfg.endpoint, {\n    method: \"POST\",\n    headers,\n    body: JSON.stringify(payload)\n  });\n  if(!res.ok){\n    const txt = await res.text().catch(()=> \"\");\n    throw new Error(`HTTP ${res.status}${txt ? `: ${txt.slice(0,200)}` : \"\"}`);\n  }\n  return payload;\n}\nasync function syncPackNow(){\n  saveEdgeCfg();\n  const cfg = loadEdgeCfg();\n  if(!cfg.endpoint) return alert(\"Set Enterprise Intake Endpoint first.\");\n  syncStatus(\"syncing...\", null);\n  try{\n    const pack = await createZipPackPayload();\n    await postPackToEnterprise(pack, cfg);\n    previewText(JSON.stringify(pack.manifest, null, 2));\n    syncStatus(`synced ${pack.root} at ${nowIso()}`, true);\n  }catch(err){\n    try{\n      const pack = await createZipPackPayload();\n      const zipBytes = new Uint8Array(await pack.zipBlob.arrayBuffer());\n      const signature = await signManifest(pack.manifest, cfg.sign_key || \"\");\n      const queue = loadOutbox();\n      queue.push({\n        queued_at: nowIso(),\n        endpoint: cfg.endpoint,\n        root: pack.root,\n        manifest: pack.manifest,\n        hashes: pack.hashes,\n        zip_b64: b64FromBytes(zipBytes),\n        signature: signature || null\n      });\n      saveOutbox(queue);\n    }catch(_){}\n    syncStatus(`queued to outbox (${err.message || \"sync failed\"})`, false);\n  }\n}\nasync function retryOutbox(){\n  saveEdgeCfg();\n  const cfg = loadEdgeCfg();\n  let q = loadOutbox();\n  if(!q.length) return syncStatus(\"outbox empty\", true);\n  if(!cfg.endpoint) return alert(\"Set Enterprise Intake Endpoint first.\");\n  syncStatus(`retrying ${q.length} queued pack(s)...`, null);\n  const keep = [];\n  let okCount = 0;\n  for(const item of q){\n    try{\n      const payload = {\n        schema: \"deepsigma_edge_sync_v1\",\n        sent_at: nowIso(),\n        client: {app: \"NGA_SEQUOIA_UI\", version: \"0.19\"},\n        root: item.root,\n        manifest: item.manifest,\n        hashes: item.hashes,\n        zip_b64: item.zip_b64,\n        signature: item.signature ? {alg: \"HMAC-SHA256\", value_b64: item.signature} : null\n      };\n      const headers = {\"Content-Type\":\"application/json\"};\n      if(cfg.token) headers[\"Authorization\"] = `Bearer ${cfg.token}`;\n      if(item.signature) headers[\"X-DeepSigma-Signature\"] = item.signature;\n      const res = await fetch(item.endpoint || cfg.endpoint, {\n        method: \"POST\",\n        headers,\n        body: JSON.stringify(payload)\n      });\n      if(!res.ok) throw new Error(`HTTP ${res.status}`);\n      okCount += 1;\n    }catch(_){\n      keep.push(item);\n    }\n  }\n  saveOutbox(keep);\n  syncStatus(`outbox sent=${okCount}, pending=${keep.length}`, keep.length===0);\n}\n\nfunction nowIso(){ return new Date().toISOString(); }\nfunction today(){ return new Date().toISOString().slice(0,10); }\nfunction uid(prefix){ return prefix + \"-\" + Math.random().toString(16).slice(2,8).toUpperCase(); }\n\n// ---------------- Single-file ZIP (store) ----------------\nfunction crc32(buf){\n  let c = 0 ^ (-1);\n  for(let i=0;i<buf.length;i++){\n    c = (c >>> 8) ^ CRC_TABLE[(c ^ buf[i]) & 0xFF];\n  }\n  return (c ^ (-1)) >>> 0;\n}\nconst CRC_TABLE = (() => {\n  const t = new Uint32Array(256);\n  for (let i=0;i<256;i++){\n    let c=i;\n    for(let k=0;k<8;k++){\n      c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);\n    }\n    t[i]=c>>>0;\n  }\n  return t;\n})();\nfunction u16(n){ return [n & 0xFF, (n>>>8) & 0xFF]; }\nfunction u32(n){ return [n & 0xFF, (n>>>8) & 0xFF, (n>>>16) & 0xFF, (n>>>24) & 0xFF]; }\nfunction strToUtf8Bytes(s){ return new TextEncoder().encode(s); }\n\nfunction buildZip(entries){\n  const fileParts = [];\n  const centralParts = [];\n  let offset = 0;\n\n  for(const e of entries){\n    const nameBytes = strToUtf8Bytes(e.name);\n    const data = e.bytes;\n    const crc = crc32(data);\n    const size = data.length;\n    const dt = e.mtime || new Date();\n    const dosTime = ((dt.getHours() & 0x1F) << 11) | ((dt.getMinutes() & 0x3F) << 5) | ((Math.floor(dt.getSeconds()/2)) & 0x1F);\n    const dosDate = (((dt.getFullYear()-1980) & 0x7F) << 9) | (((dt.getMonth()+1) & 0x0F) << 5) | (dt.getDate() & 0x1F);\n\n    const local = [\n      ...u32(0x04034b50), ...u16(20), ...u16(0), ...u16(0),\n      ...u16(dosTime), ...u16(dosDate),\n      ...u32(crc), ...u32(size), ...u32(size),\n      ...u16(nameBytes.length), ...u16(0),\n    ];\n    fileParts.push(new Uint8Array(local), nameBytes, data);\n\n    const central = [\n      ...u32(0x02014b50), ...u16(0x0314), ...u16(20),\n      ...u16(0), ...u16(0),\n      ...u16(dosTime), ...u16(dosDate),\n      ...u32(crc), ...u32(size), ...u32(size),\n      ...u16(nameBytes.length), ...u16(0), ...u16(0),\n      ...u16(0), ...u16(0), ...u32(0),\n      ...u32(offset),\n    ];\n    centralParts.push(new Uint8Array(central), nameBytes);\n    offset += local.length + nameBytes.length + size;\n  }\n\n  const centralStart = offset;\n  for(const part of centralParts){\n    fileParts.push(part);\n    offset += part.length;\n  }\n  const centralSize = offset - centralStart;\n\n  const eocd = [\n    ...u32(0x06054b50),\n    ...u16(0), ...u16(0),\n    ...u16(entries.length), ...u16(entries.length),\n    ...u32(centralSize), ...u32(centralStart),\n    ...u16(0)\n  ];\n  fileParts.push(new Uint8Array(eocd));\n  return new Blob(fileParts, {type:\"application/zip\"});\n}\n\nasync function sha256Hex(bytes){\n  const buf = await crypto.subtle.digest(\"SHA-256\", bytes.buffer ? bytes.buffer : bytes);\n  const arr = Array.from(new Uint8Array(buf));\n  return arr.map(b=>b.toString(16).padStart(2,\"0\")).join(\"\");\n}\nfunction safeFile(s){ return (s||\"\").replace(/[^a-z0-9_\\-]+/gi,\"_\").replace(/_+/g,\"_\").replace(/^_+|_+$/g,\"\"); }\n\nfunction load(){\n  const raw = getStoreItem(KEY);\n  if(!raw){\n    const init = { roles:[], candidates:[], interviews:[], drift:[], rs:[], meta:{created:nowIso(), version:\"2.0\"} };\n    setStoreItem(KEY, JSON.stringify(init));\n  }\n  const db = JSON.parse(getStoreItem(KEY));\n  // migrations / defaults\n  db.roles ||= [];\n  db.candidates ||= [];\n  db.interviews ||= [];\n  db.drift ||= [];\n  db.rs ||= [];\n  db.meta ||= {created: nowIso(), version:\"2.0\"};\n  // ensure candidate timestamps exist\n  db.candidates.forEach((c,idx)=>{\n    c = redactCandidate(c, idx); c.created ||= nowIso(); c.status_changed ||= c.created; });\n  return db;\n}\nfunction save(db){ setStoreItem(KEY, JSON.stringify(db)); refreshAll(); }\n\nfunction setTab(tab){\n  try{ location.hash = \"#\"+tab; }catch(_){ }\n  document.querySelectorAll(\".tab\").forEach(b=>b.classList.toggle(\"active\", b.dataset.tab===tab));\n\n  const tabs = [\"dashboard\",\"roles\",\"candidates\",\"interviews\",\"board\",\"drift\",\"test\",\"rs\",\"artifacts\"];\n  const hud = document.getElementById(\"hud\");\n\n  tabs.forEach(t=>{\n    const el = document.getElementById(\"tab-\"+t);\n    if(!el) return;\n    const shouldHide = (t!==tab);\n    el.classList.toggle(\"hidden\", shouldHide);\n    // hard override for safety\n    if(shouldHide) el.style.display = \"none\";\n    else el.style.display = \"block\";\n  });\n\n  if(tab===\"artifacts\") refreshOffersList();\n  if(tab===\"rs\"){    // show RS modal overlay for reliability\n    const rm=document.getElementById(\"rsModal\");\n    if(rm){ rm.style.display=\"block\"; renderRSModal(); }\n  \n    try{ renderRSList(); }catch(_){}\n    try{ defaultRSFields(); }catch(_){}\n    // force visibility + min height so it can't collapse\n    const rs = document.getElementById(\"tab-rs\");\n    if(rs){\n      rs.style.minHeight = \"600px\";\n      rs.style.border = \"1px dashed rgba(125,249,255,.35)\";\n      rs.style.background = \"rgba(125,249,255,.03)\";\n      rs.scrollIntoView({block:\"start\"});\n  }\n  }\n\n  // HUD refresh after paint\n  const show = (location.search||\"\").includes(\"hashdebug=1\");\n  if(hud){\n    hud.style.display = show ? \"block\" : \"none\";\n    requestAnimationFrame(()=>{\n      const rows = [];\n      tabs.forEach(t=>{\n        const el = document.getElementById(\"tab-\"+t);\n        if(!el){ rows.push(` tab-${t}: MISSING`); return; }\n        const cs = getComputedStyle(el);\n        rows.push(` tab-${t}: ${el.classList.contains(\"hidden\") ? \"hidden\" : \"shown\"} | display=${cs.display} | vis=${cs.visibility} | height=${Math.round(el.getBoundingClientRect().height)}px`);\n      });\n      hud.innerHTML = `<b>Tab Debug HUD<\/b><div class=\"muted\">Add <span class=\"mono\">?hashdebug=1<\/span> to URL to keep this visible.<\/div><div style=\"margin-top:6px\" class=\"mono\">${rows.join(\"<br>\")}<\/div>`;\n    });\n  }\n}\nwindow.setTab = setTab;\ndocument.querySelectorAll(\".tab\").forEach(b=>b.addEventListener(\"click\", ()=>setTab(b.dataset.tab)));\n\nfunction seedSequoia(){\n  const db = load();\n  if(db.roles.length) return alert(\"Roles already exist. Reset if you want a clean seed.\");\n  const roles = [\n    {id:\"DLR-ROLE-001\", name:\"Program Manager (PM)\", wave:\"Wave 1  Mobilize\", labor:\"Program Manager\",\n     mission:\"Stand up contract governance + delivery rhythm; meet SLOs; maintain customer trust.\",\n     must:[\"IDIQ/task order delivery discipline\",\"Metrics cadence + risk burn-down\",\"Stakeholder management\",\"Staffing/vendor coordination\",\"Evidence-based reporting\"],\n     nice:[\"ATO familiarity\",\"GEOINT context\"],\n     sim:\"Customer wants +30% throughput without quality loss in 72 hours. What do you do?\"},\n    {id:\"DLR-ROLE-002\", name:\"Delivery Lead / Scrum Master\", wave:\"Wave 1  Mobilize\", labor:\"Project Manager / Scrum Master\",\n     mission:\"Sprint discipline, throughput stability, predictable change handling.\",\n     must:[\"Backlog hygiene\",\"Change control\",\"Cycle time/WIP/throughput metrics\",\"Cross-team coordination\",\"Escalation discipline\"],\n     nice:[\"Labeling ops exposure\"],\n     sim:\"Label policy change lands mid-sprint. Prevent rework spiral while keeping throughput.\"},\n    {id:\"DLR-ROLE-003\", name:\"Security Lead (ISSO/ISSM)\", wave:\"Wave 1  Mobilize\", labor:\"ISSO / ISSM\",\n     mission:\"Access control + compliance posture + audit readiness without delivery drag.\",\n     must:[\"ISSO/ISSM experience\",\"ATO mindset\",\"Data handling + logging\",\"Identity/access governance\",\"Risk acceptance routing\"],\n     nice:[\"Cloud security\"],\n     sim:\"You inherit labeling tool + data flow. Identify top 10 control failures in 30 minutes.\"},\n    {id:\"DLR-ROLE-004\", name:\"Coherence Steward (Deep Sigma)\", wave:\"Wave 1  Mobilize\", labor:\"Governance / Knowledge Mgmt Lead\",\n     mission:\"Make delivery mechanically reconstructable: decisions, changes, drift, patches, memory.\",\n     must:[\"Evidence-first documentation\",\"Versioning discipline\",\"Blast radius thinking\",\"Queryable knowledge structure\",\"Calm enforcement\"],\n     nice:[\"Ontologies/graphs\"],\n     sim:\"Reconstruct why label class X changed and which datasets/models were impacted  under 60 seconds.\"},\n    {id:\"DLR-ROLE-005\", name:\"Data Ops Lead\", wave:\"Wave 2  Factory\", labor:\"Operations Manager\",\n     mission:\"Run labeling floor: staffing, queues, throughput, escalation.\",\n     must:[\"Production ops\",\"Queueing/staffing\",\"Metric-driven floor control\",\"Escalation discipline\",\"Training/SOP enforcement\"],\n     nice:[\"Labeling tools\"],\n     sim:\"Design shift plan to hit 50 labels/day/person while protecting QA.\"},\n    {id:\"DLR-ROLE-006\", name:\"QA Lead\", wave:\"Wave 2  Factory\", labor:\"QA Manager\",\n     mission:\"Quality gates, IAA stability, adjudication workflow.\",\n     must:[\"IAA + sampling\",\"Adjudication\",\"Feedback loops\",\"Metrics ownership\",\"Change impact evaluation\"],\n     nice:[\"Data labeling QA\"],\n     sim:\"IAA is sliding. Set thresholds, sampling plan, adjudication, stop-ship triggers.\"},\n  ];\n  db.roles = roles;\n  save(db);\n  alert(\"Seeded SEQUOIA roles.\");\n}\n\nfunction roleOptions(selectEl){\n  const db = load();\n  selectEl.innerHTML = db.roles.map(r=>`<option value=\"${r.id}\">${r.id}  ${r.name}<\/option>`).join(\"\") || `<option value=\"\">(no roles yet)<\/option>`;\n}\n\nfunction refreshAll(){\n  refreshDashboard(); refreshRoles(); refreshCandidates(); refreshInterviews(); refreshBoard(); refreshDrift();\n  roleOptions(document.getElementById(\"candRole\"));\n  const db = load();\n  document.getElementById(\"intCand\").innerHTML = db.candidates.map(c=>`<option value=\"${c.id}\">${c.id}  ${c.name}<\/option>`).join(\"\") || `<option value=\"\">(no candidates yet)<\/option>`;\n  refreshOffersList();\n  renderRSList();\n}\n\n\nfunction computeSLO(){\n  const db = load();\n  const offers = db.candidates.filter(c=>c.offer_date);\n  const accepted = db.candidates.filter(c=>c.accepted_date);\n  const offerAcceptance = offers.length ? Math.round((accepted.length / offers.length)*100) : null;\n\n  const tto = offers.filter(c=>c.created).map(c => (new Date(c.offer_date).getTime() - new Date(c.created).getTime())/(1000*60*60*24)).filter(x=>x>=0);\n  const avgTimeToOffer = tto.length ? Math.round((tto.reduce((a,b)=>a+b,0)/tto.length)*10)/10 : null;\n\n  const byCand = {};\n  db.interviews.forEach(i=>{ byCand[i.candidate] ||= []; byCand[i.candidate].push(Number(i.rfs)); });\n  let varianceBreaches = 0;\n  Object.values(byCand).forEach(scores=>{\n    if(scores.length>=2){\n      const mx=Math.max(...scores), mn=Math.min(...scores);\n      if(mx-mn>15) varianceBreaches += 1;\n    }\n  });\n\n  const now = Date.now();\n  const days = (iso)=> Math.max(0, Math.round((now - new Date(iso).getTime())/(1000*60*60*24)));\n  const thresh = {Sourcing:7, Screened:5, Gate2:3, Gate3:3, Offer:2, Accepted:5, Cleared:10, Started:9999};\n  let stuck = 0;\n  db.candidates.forEach(c=>{\n    const st=c.status||\"Sourcing\";\n    const age=days(c.status_changed||c.created||nowIso());\n    if(age > (thresh[st] ?? 7)) stuck += 1;\n  });\n\n  return {avgTimeToOffer, offerAcceptance, varianceBreaches, stuck};\n}\n\nfunction upsertAutoDS(code, msg, patch){\n  const db = load();\n  const d = today();\n  const exists = db.drift.some(x=>x.code===code && (x.time||\"\").startsWith(d));\n  if(exists) return false;\n  db.drift.push({time: nowIso(), code, msg, patch});\n  save(db);\n  return true;\n}\n\nfunction runAutoDS(){\n  const slo = computeSLO();\n  let created = 0;\n\n  if(slo.avgTimeToOffer != null && slo.avgTimeToOffer > 7){\n    if(upsertAutoDS(\"DS-HIRE-001\", `Avg time-to-offer is ${slo.avgTimeToOffer} days (>7).`, \"Patch loop capacity, tighten scheduling, pre-brief interviewers.\")) created += 1;\n  }\n  if(slo.offerAcceptance != null && slo.offerAcceptance < 70){\n    if(upsertAutoDS(\"DS-HIRE-002\", `Offer acceptance is ${slo.offerAcceptance}% (<70%).`, \"Patch comp band, mission clarity, start-date friction.\")) created += 1;\n  }\n  if(slo.varianceBreaches > 0){\n    if(upsertAutoDS(\"DS-HIRE-003\", `Interviewer variance breaches present: ${slo.varianceBreaches}.`, \"Calibrate rubric, add scoring anchors, require 2 Gate-2 scorers.\")) created += 1;\n  }\n  if(slo.stuck > 0){\n    if(upsertAutoDS(\"DS-HIRE-004\", `Stuck candidates detected: ${slo.stuck}.`, \"Patch stage SLAs, force routing decisions, remove bottlenecks.\")) created += 1;\n  }\n  return created;\n}\n\nfunction refreshDashboard(){\n  const db = load();\n  document.getElementById(\"kOpenRoles\").textContent = db.roles.length;\n  document.getElementById(\"kCandidates\").textContent = db.candidates.length;\n  document.getElementById(\"kInInterview\").textContent = db.candidates.filter(c=>[\"Gate2\",\"Gate3\"].includes(c.status)).length;\n  document.getElementById(\"kOffers\").textContent = db.candidates.filter(c=>c.status===\"Offer\").length;\n  document.getElementById(\"kStarted\").textContent = db.candidates.filter(c=>c.status===\"Started\").length;\n\n  const slo = computeSLO();\n  const autoCreated = runAutoDS();\n  const kT = document.getElementById(\"kTimeToOffer\"); if(kT) kT.textContent = (slo.avgTimeToOffer==null) ? \"\" : `${slo.avgTimeToOffer}d`;\n  const kA = document.getElementById(\"kOfferAccept\"); if(kA) kA.textContent = (slo.offerAcceptance==null) ? \"\" : `${slo.offerAcceptance}%`;\n  const kV = document.getElementById(\"kVarBreaches\"); if(kV) kV.textContent = `${slo.varianceBreaches}`;\n  const kS = document.getElementById(\"kStuck\"); if(kS) kS.textContent = `${slo.stuck}`;\n  const kD = document.getElementById(\"kAutoDs\"); if(kD) kD.textContent = `${autoCreated}`;\n\n  const d = db.drift.slice(-5).reverse();\n  const el = document.getElementById(\"driftList\");\n  if(!d.length){ el.textContent = \"No drift yet.\"; return; }\n  el.innerHTML = d.map(x=>`<div><span class=\"pill\">${x.code}<\/span> ${x.msg} <span class=\"muted\">(${x.time})<\/span><\/div>`).join(\"\");\n}\n\nfunction refreshRoles(){\n  const db = load();\n  const el = document.getElementById(\"rolesTable\");\n  if(!db.roles.length){ el.innerHTML = \"<div class='muted'>No roles yet. Click &quot;Seed SEQUOIA roles&quot;.<\/div>\"; return; }\n  el.innerHTML = `<table>\n    <thead><tr><th>ID<\/th><th>Role<\/th><th>Wave<\/th><th>Labor<\/th><th><\/th><\/tr><\/thead>\n    <tbody>${db.roles.map(r=>`\n      <tr>\n        <td class=\"mono\">${r.id}<\/td>\n        <td>${r.name}<\/td>\n        <td>${r.wave}<\/td>\n        <td class=\"muted\">${r.labor||\"\"}<\/td>\n        <td><button data-action=\"role-edit\" data-id=\"${r.id}\">Edit<\/button> <button class=\"danger\" data-action=\"role-delete\" data-id=\"${r.id}\">Delete<\/button><\/td>\n      <\/tr>`).join(\"\")}\n    <\/tbody><\/table>`;\n}\n\nfunction refreshCandidates(){\n  const db = load();\n  const el = document.getElementById(\"candsTable\");\n  if(!db.candidates.length){ el.innerHTML = \"<div class='muted'>No candidates yet.<\/div>\"; return; }\n  const roleName = (id)=> (db.roles.find(r=>r.id===id)?.name)||\"(role?)\";\n  el.innerHTML = `<table>\n    <thead><tr><th>ID<\/th><th>Name<\/th><th>Role<\/th><th>Status<\/th><th>Clearance<\/th><th><\/th><\/tr><\/thead>\n    <tbody>${db.candidates.map(c=>`\n      <tr>\n        <td class=\"mono\">${c.id}<\/td>\n        <td>${c.name}<\/td>\n        <td class=\"muted\">${c.role}  ${roleName(c.role)}<\/td>\n        <td class=\"status\">${c.status}<\/td>\n        <td class=\"muted\">${c.clearance||\"\"}<\/td>\n        <td><button data-action=\"cand-edit\" data-id=\"${c.id}\">Edit<\/button> <button class=\"danger\" data-action=\"cand-delete\" data-id=\"${c.id}\">Delete<\/button><\/td>\n      <\/tr>`).join(\"\")}\n    <\/tbody><\/table>`;\n}\n\nfunction refreshInterviews(){\n  const db = load();\n  const el = document.getElementById(\"intsTable\");\n  if(!db.interviews.length){ el.innerHTML = \"<div class='muted'>No interviews yet.<\/div>\"; return; }\n  const candName = (id)=> (db.candidates.find(c=>c.id===id)?.name)||\"(candidate?)\";\n  el.innerHTML = `<table>\n    <thead><tr><th>ID<\/th><th>Candidate<\/th><th>Gate<\/th><th>RFS/TPS/UR<\/th><th>Decision<\/th><th>Seal<\/th><th><\/th><\/tr><\/thead>\n    <tbody>${db.interviews.map(i=>`\n      <tr>\n        <td class=\"mono\">${i.id}<\/td>\n        <td>${i.candidate}  ${candName(i.candidate)}<\/td>\n        <td class=\"muted\">${i.gate}<\/td>\n        <td class=\"muted\">${i.rfs}/${i.tps}/${i.ur}<\/td>\n        <td class=\"${i.decision==='Hire'?'s-ok':i.decision==='Hold'?'s-warn':'s-bad'}\">${i.decision}<\/td>\n        <td class=\"muted mono\">${i.seal}<\/td>\n        <td><button data-action=\"int-edit\" data-id=\"${i.id}\">Edit<\/button> <button class=\"danger\" data-action=\"int-delete\" data-id=\"${i.id}\">Delete<\/button><\/td>\n      <\/tr>`).join(\"\")}\n    <\/tbody><\/table>`;\n}\n\nfunction refreshBoard(){\n  const db = load();\n  const el = document.getElementById(\"boardTable\");\n  const cols = [\"Sourcing\",\"Screened\",\"Gate2\",\"Gate3\",\"Offer\",\"Accepted\",\"Cleared\",\"Started\"];\n  const buckets = Object.fromEntries(cols.map(c=>[c,[]]));\n  db.candidates.forEach((c,idx)=>{\n    c = redactCandidate(c, idx); (buckets[c.status] ||= []).push(c); });\n\n  el.innerHTML = `<div class=\"grid\" style=\"grid-template-columns:repeat(4,1fr)\">\n    ${cols.map(s=>`\n      <div class=\"card\">\n        <h3>${s} <span class=\"muted\">(${(buckets[s]||[]).length})<\/span><\/h3>\n        ${(buckets[s]||[]).map(c=>`\n          <div style=\"border:1px solid #1b2a3a;border-radius:12px;padding:10px;margin-bottom:8px\">\n            <div><b>${c.name}<\/b> <span class=\"muted mono\">${c.id}<\/span><\/div>\n            <div class=\"muted small\">${c.role}<\/div>\n            <div class=\"right\" style=\"margin-top:8px\">\n              <button data-action=\"cand-move\" data-id=\"${c.id}\" data-dir=\"-1\"><\/button>\n              <button data-action=\"cand-move\" data-id=\"${c.id}\" data-dir=\"1\"><\/button>\n            <\/div>\n          <\/div>`).join(\"\") || `<div class=\"muted\"><\/div>`}\n      <\/div>`).join(\"\")}\n  <\/div>`;\n}\n\nfunction refreshDrift(){\n  const db = load();\n  const el = document.getElementById(\"driftTable\");\n  if(!db.drift.length){ el.innerHTML = \"<div class='muted'>No drift alerts recorded.<\/div>\"; return; }\n  el.innerHTML = `<table>\n    <thead><tr><th>Time<\/th><th>Code<\/th><th>Message<\/th><th>Patch Hint<\/th><\/tr><\/thead>\n    <tbody>${db.drift.slice().reverse().map(d=>`\n      <tr>\n        <td class=\"muted mono\">${d.time}<\/td>\n        <td class=\"mono\">${d.code}<\/td>\n        <td>${d.msg}<\/td>\n        <td class=\"muted\">${d.patch}<\/td>\n      <\/tr>`).join(\"\")}\n    <\/tbody><\/table>`;\n}\n\nfunction runDriftScan(){\n  const db = load();\n  const alerts = [];\n\n  // DS-HIRE-003: high variance for same candidate across interviews (RFS range > 15)\n  const byCand = {};\n  db.interviews.forEach(i=>{\n    byCand[i.candidate] ||= [];\n    byCand[i.candidate].push(Number(i.rfs));\n  });\n  Object.entries(byCand).forEach(([cid, scores])=>{\n    if(scores.length >= 2){\n      const mx = Math.max(...scores), mn = Math.min(...scores);\n      if(mx - mn > 15){\n        alerts.push({code:\"DS-HIRE-003\", msg:`Interviewer variance for ${cid} is ${mx-mn} RFS points.`, patch:\"Calibrate rubric; retrain interviewers; tighten Gate 2 scoring anchors.\"});\n      }\n    }\n  });\n\n  // DS-HIRE-005: repeated \"Hire\" but candidate still stuck early\n  const hires = new Set(db.interviews.filter(i=>i.decision===\"Hire\").map(i=>i.candidate));\n  hires.forEach(cid=>{\n    const c = db.candidates.find(x=>x.id===cid);\n    if(c && [\"Sourcing\",\"Screened\"].includes(c.status)){\n      alerts.push({code:\"DS-HIRE-005\", msg:`Candidate ${cid} has Hire scorecards but is still in ${c.status}.`, patch:\"Enforce decision routing; advance gate or issue offer within 24h post Gate 3.\"});\n    }\n  });\n\n  alerts.forEach(a=>db.drift.push({ time: nowIso(), ...a }));\n  save(db);\n  alert(alerts.length ? `Drift scan recorded ${alerts.length} alert(s).` : \"No drift detected.\");\n}\n\nfunction moveCandidate(id, dir){\n  const db = load();\n  const cols = [\"Sourcing\",\"Screened\",\"Gate2\",\"Gate3\",\"Offer\",\"Accepted\",\"Cleared\",\"Started\"];\n  const c = db.candidates.find(x=>x.id===id);\n  if(!c) return;\n  const idx = cols.indexOf(c.status);\n  const prev = c.status;\n  const next = cols[Math.max(0, Math.min(cols.length-1, idx + dir))];\n  if(prev !== next){\n    c.status = next;\n    c.status_changed = nowIso();\n    if(next === \"Offer\" && !c.offer_date) c.offer_date = nowIso();\n    if(next === \"Accepted\" && !c.accepted_date) c.accepted_date = nowIso();\n    if(next === \"Started\" && !c.started_date) c.started_date = nowIso();\n  }\n  save(db);\n}\n\nfunction newRole(){ clearRole(); setTab(\"roles\"); document.getElementById(\"roleId\").value = uid(\"DLR-ROLE\"); }\nfunction saveRole(){\n  const db = load();\n  const r = { id:v(\"roleId\"), name:v(\"roleName\"), wave:v(\"roleWave\"), labor:v(\"roleLabor\"),\n    mission:v(\"roleMission\"), must:v(\"roleMust\").split(\"\\\\n\").filter(x=>x.trim()),\n    nice:v(\"roleNice\").split(\"\\\\n\").filter(x=>x.trim()),\n    sim:v(\"roleSim\")\n  };\n  if(!r.id || !r.name) return alert(\"Role ID and Role Name are required.\");\n  const idx = db.roles.findIndex(x=>x.id===r.id);\n  if(idx>=0) db.roles[idx]=r; else db.roles.push(r);\n  save(db); hint(\"roleSavedHint\",\"Saved.\");\n}\nfunction editRole(id){\n  const db = load(); const r = db.roles.find(x=>x.id===id); if(!r) return;\n  setTab(\"roles\");\n  s(\"roleId\", r.id); s(\"roleName\", r.name); s(\"roleWave\", r.wave); s(\"roleLabor\", r.labor||\"\");\n  s(\"roleMission\", r.mission||\"\"); s(\"roleMust\", (r.must||[]).join(\"\\n\")); s(\"roleNice\", (r.nice||[]).join(\"\\n\")); s(\"roleSim\", r.sim||\"\");\n}\nfunction deleteRole(id){ if(!confirm(\"Delete role?\")) return; const db=load(); db.roles=db.roles.filter(r=>r.id!==id); save(db); }\nfunction clearRole(){ [\"roleId\",\"roleName\",\"roleLabor\",\"roleMission\",\"roleMust\",\"roleNice\",\"roleSim\"].forEach(x=>s(x,\"\")); s(\"roleWave\",\"Wave 1  Mobilize\"); hint(\"roleSavedHint\",\"\"); }\n\nfunction newCandidate(){ clearCandidate(); setTab(\"candidates\"); document.getElementById(\"candId\").value = uid(\"C\"); }\nfunction saveCandidate(){\n  const db = load();\n  const incoming = {\n    id:v(\"candId\"), name:v(\"candName\"), role:v(\"candRole\"), status:v(\"candStatus\"),\n    clearance:v(\"candClearance\"), availability:v(\"candAvail\"), comp:v(\"candComp\"),\n    evidence:v(\"candEvidence\").split(\"\\n\").filter(x=>x.trim()),\n    risks:v(\"candRisks\")\n  };\n  if(!incoming.id || !incoming.name || !incoming.role) return alert(\"Candidate ID, Name, and Role are required.\");\n\n  const idx = db.candidates.findIndex(x=>x.id===incoming.id);\n  if(idx>=0){\n    const prev = db.candidates[idx];\n    const statusChanged = (prev.status !== incoming.status);\n    db.candidates[idx] = {\n      ...prev,\n      ...incoming,\n      created: prev.created || nowIso(),\n      status_changed: statusChanged ? nowIso() : (prev.status_changed || prev.created || nowIso()),\n    };\n    const c = db.candidates[idx];\n    if(c.status===\"Offer\" && !c.offer_date) c.offer_date = nowIso();\n    if(c.status===\"Accepted\" && !c.accepted_date) c.accepted_date = nowIso();\n    if(c.status===\"Started\" && !c.started_date) c.started_date = nowIso();\n  } else {\n    const c = { ...incoming, created: nowIso(), status_changed: nowIso() };\n    if(c.status===\"Offer\") c.offer_date = nowIso();\n    if(c.status===\"Accepted\") c.accepted_date = nowIso();\n    if(c.status===\"Started\") c.started_date = nowIso();\n    db.candidates.push(c);\n  }\n  save(db); hint(\"candSavedHint\",\"Saved.\");\n}\nfunction editCandidate(id){\n  const db = load(); const c = db.candidates.find(x=>x.id===id); if(!c) return;\n  setTab(\"candidates\");\n  s(\"candId\", c.id); s(\"candName\", c.name); s(\"candRole\", c.role); s(\"candStatus\", c.status);\n  s(\"candClearance\", c.clearance||\"\"); s(\"candAvail\", c.availability||\"\"); s(\"candComp\", c.comp||\"\");\n  s(\"candEvidence\", (c.evidence||[]).join(\"\\n\")); s(\"candRisks\", c.risks||\"\");\n}\nfunction deleteCandidate(id){\n  if(!confirm(\"Delete candidate?\")) return;\n  const db = load();\n  db.candidates = db.candidates.filter(c=>c.id!==id);\n  db.interviews = db.interviews.filter(i=>i.candidate!==id);\n  save(db);\n}\nfunction clearCandidate(){ [\"candId\",\"candName\",\"candClearance\",\"candAvail\",\"candComp\",\"candEvidence\",\"candRisks\"].forEach(x=>s(x,\"\")); s(\"candStatus\",\"Sourcing\"); hint(\"candSavedHint\",\"\"); }\n\nfunction newInterview(){ clearInterview(); setTab(\"interviews\"); document.getElementById(\"intId\").value = uid(\"I\"); }\nfunction saveInterview(){\n  const db = load();\n  const i = {\n    id:v(\"intId\"), candidate:v(\"intCand\"), gate:v(\"intGate\"), interviewer:v(\"intInterviewer\"),\n    rfs:Number(v(\"sRfs\")||0), tps:Number(v(\"sTps\")||0), ur:Number(v(\"sUr\")||0),\n    decision:v(\"sDecision\"),\n    evidence:v(\"sEvidence\").split(\"\\\\n\").filter(x=>x.trim()),\n    notes:v(\"sNotes\"),\n    flags:v(\"sFlags\"),\n    seal:`${nowIso()}|v1`\n  };\n  if(!i.id || !i.candidate) return alert(\"Interview ID and Candidate are required.\");\n  const idx = db.interviews.findIndex(x=>x.id===i.id);\n  if(idx>=0) db.interviews[idx]=i; else db.interviews.push(i);\n\n  // light status assist\n  const c = db.candidates.find(x=>x.id===i.candidate);\n  if(c){\n    const prev = c.status;\n    let next = prev;\n    if(i.gate.startsWith(\"Gate 1\")) next = \"Screened\";\n    if(i.gate.startsWith(\"Gate 2\")) next = \"Gate2\";\n    if(i.gate.startsWith(\"Gate 3\")) next = (i.decision===\"Hire\") ? \"Offer\" : \"Gate3\";\n    if(next !== prev){\n      c.status = next;\n      c.status_changed = nowIso();\n      if(next === \"Offer\" && !c.offer_date) c.offer_date = nowIso();\n    }\n  }\n  save(db); hint(\"intSavedHint\",\"Saved & sealed.\");\n}\nfunction editInterview(id){\n  const db = load(); const i = db.interviews.find(x=>x.id===id); if(!i) return;\n  setTab(\"interviews\");\n  s(\"intId\", i.id); s(\"intCand\", i.candidate); s(\"intGate\", i.gate); s(\"intInterviewer\", i.interviewer||\"\");\n  s(\"sRfs\", i.rfs); s(\"sTps\", i.tps); s(\"sUr\", i.ur); s(\"sDecision\", i.decision);\n  s(\"sEvidence\", (i.evidence||[]).join(\"\\n\")); s(\"sNotes\", i.notes||\"\"); s(\"sFlags\", i.flags||\"\");\n}\nfunction deleteInterview(id){ if(!confirm(\"Delete interview?\")) return; const db=load(); db.interviews=db.interviews.filter(i=>i.id!==id); save(db); }\nfunction clearInterview(){ [\"intId\",\"intInterviewer\",\"sRfs\",\"sTps\",\"sUr\",\"sEvidence\",\"sNotes\",\"sFlags\"].forEach(x=>s(x,\"\")); s(\"intGate\",\"Gate 1  Screen\"); s(\"sDecision\",\"Hire\"); hint(\"intSavedHint\",\"\"); }\n\n// -------- ARTIFACT GENERATION --------\n\nfunction isSafeExport(){\n  return (document.getElementById(\"safeExport\")?.value || \"false\") === \"true\";\n}\nfunction safeLevel(){\n  return document.getElementById(\"safeExportLevel\")?.value || \"lite\";\n}\nfunction redactCandidate(c, idx){\n  if(!isSafeExport()) return c;\n  const lvl = safeLevel();\n  const masked = {...c};\n  masked.name = `Candidate-${String(idx+1).padStart(3,\"0\")}`;\n  if(masked.comp) masked.comp = \"(masked)\";\n  if(masked.clearance) masked.clearance = \"(masked)\";\n  if(lvl === \"strict\") masked.evidence = [];\n  return masked;\n}\nfunction packMeta(){\n  return {\n    prefix: v(\"packPrefix\") || \"SEQUOIA\",\n    program: v(\"orgProgram\") || \"NGA  SEQUOIA\",\n    steward: v(\"cohSteward\") || \"(unassigned)\",\n    authority: v(\"authorityNote\") || \"(not specified)\",\n    generated: nowIso(),\n    date: today(),\n    version: \"1.0\",\n    safe_export: isSafeExport(),\n    safe_export_level: safeLevel()\n  };\n}\n\n\nfunction mdRole(r, meta){\n  const must = (r.must||[]).slice(0,5).map(x=>`- ${x}`).join(\"\\n\") || \"- (none)\";\n  const nice = (r.nice||[]).map(x=>`- ${x}`).join(\"\\n\") || \"- (none)\";\n  return `# ${r.id}  ${r.name}\n**Program:** ${meta.program}  \n**Wave:** ${r.wave}  \n**Labor Category:** ${r.labor || \"(tbd)\"}  \n**Generated:** ${meta.generated}\n\n## Mission (90 days)\n${r.mission || \"(tbd)\"}\n\n## Must-Haves ( 5)\n${must}\n\n## Nice-to-Haves\n${nice}\n\n## Gate 2 Simulation (Week 1)\n${r.sim || \"(tbd)\"}\n\n## Deep Sigma Controls\n-  SealVersionPatch: role packet changes are versioned.\n-  MG linkage: hire decisions link to role packet + evidence.\n-  DS: hiring drift triggers create patch tickets.\n-  RS: weekly calibration of rubric + outcomes.\n\n## Authority / Approvals\n${meta.authority}\n`;\n}\n\nfunction buildMG(meta){\n  const db = load();\n  // simple node/edge graph export (MG)\n  const nodes = [];\n  const edges = [];\n\n  db.roles.forEach(r=>{\n    nodes.push({type:\"Role\", id:r.id, name:r.name, wave:r.wave, labor:r.labor || null});\n  });\n\n  db.candidates.forEach((c,idx)=>{\n    c = redactCandidate(c, idx);\n    nodes.push({type:\"Candidate\", id:c.id, name:c.name, role:c.role, status:c.status,\n      clearance:c.clearance || null, availability:c.availability || null, comp:c.comp || null,\n      evidence:c.evidence || [], risks:c.risks || \"\"});\n    edges.push({type:\"TARGETS_ROLE\", from:c.id, to:c.role});\n  });\n\n  db.interviews.forEach(i=>{\n    nodes.push({type:\"Interview\", id:i.id, candidate:i.candidate, gate:i.gate, interviewer:i.interviewer || null,\n      rfs:i.rfs, tps:i.tps, ur:i.ur, decision:i.decision, seal:i.seal});\n    edges.push({type:\"HAS_INTERVIEW\", from:i.candidate, to:i.id});\n  });\n\n  // de-dupe nodes by (type,id)\n  const seen = new Set();\n  const uniqNodes = [];\n  for(const n of nodes){\n    const k = `${n.type}:${n.id}`;\n    if(seen.has(k)) continue;\n    seen.add(k);\n    uniqNodes.push(n);\n  }\n\n  return { meta, nodes: uniqNodes, edges };\n}\n\nfunction buildScorecards(meta){\n  const db = load();\n  if(!isSafeExport()) return { meta, interviews: db.interviews };\n  const candIndex = new Map(db.candidates.map((c,i)=>[c.id, i]));\n  const interviews = db.interviews.map(i=>{\n    const idx = candIndex.has(i.candidate) ? candIndex.get(i.candidate) : 0;\n    return {...i, candidate_name: `Candidate-${String(idx+1).padStart(3,\"0\")}`};\n  });\n  return { meta, interviews };\n}\n\nfunction buildDS(meta){\n  const db = load();\n  return `# DS_HIRING  Drift Snapshot\n**Program:** ${meta.program}  \n**Generated:** ${meta.generated}\n\n## Recorded Drift Alerts\n${db.drift.length ? db.drift.slice().reverse().map(d=>`- **${d.code}** (${d.time})  ${d.msg}\\n  - Patch hint: ${d.patch}`).join(\"\\n\") : \"- None\"}\n\n## Patch Queue (manual)\n- [ ] Review DS alerts\n- [ ] Decide patch: rubric, sourcing lane, comp band, loop capacity, gate design\n- [ ] Seal patch decision into next RS\n`;\n}\n\nfunction buildRS(meta){\n  const db = load();\n  const counts = (status)=>db.candidates.filter(c=>c.status===status).length;\n  return `# RS_HIRING_WEEKLY  Weekly Hiring Reflection\n**Program:** ${meta.program}  \n**Week of:** ${meta.date}  \n**Generated:** ${meta.generated}  \n**Coherence Steward:** ${meta.steward}\n\n## Operating Snapshot\n- Open roles: ${db.roles.length}\n- Candidates: ${db.candidates.length}\n- Sourcing: ${counts(\"Sourcing\")}\n- Screened: ${counts(\"Screened\")}\n- Gate2: ${counts(\"Gate2\")}\n- Gate3: ${counts(\"Gate3\")}\n- Offer: ${counts(\"Offer\")}\n- Accepted: ${counts(\"Accepted\")}\n- Cleared: ${counts(\"Cleared\")}\n- Started: ${counts(\"Started\")}\n\n## SLO Check (fill)\n- Time-to-offer  7 days: (Pass/Fail)  evidence:\n- Offer acceptance  70%: (Pass/Fail)  evidence:\n- Variance  15 RFS: (Pass/Fail)  evidence:\n- Why-retrieval  60s: (Pass/Fail)  evidence:\n\n## Drift (DS) Review\n${db.drift.length ? db.drift.slice(-10).reverse().map(d=>`- ${d.code}  ${d.msg} (${d.time})`).join(\"\\n\") : \"- None\"}\n\n## Decisions (Seal)\n- Decision 1:\n- Decision 2:\n- Decision 3:\n\n## Patches (SealVersionPatch)\n- Patch 1 (what changes in the hiring system):\n- Patch 2:\n`;\n}\n\nfunction buildOfferMD(candidate, role, meta){\n  // Minimal offer DLR (non-proprietary)\n  return `# DLR-OFFER  ${candidate.id} (${candidate.name})\n**Program:** ${meta.program}  \n**Role:** ${role.id}  ${role.name}  \n**Generated:** ${meta.generated}\n\n## Candidate Snapshot (MG)\n- Candidate ID: ${candidate.id}\n- Status: ${candidate.status}\n- Clearance: ${candidate.clearance || \"(tbd)\"}\n- Availability: ${candidate.availability || \"(tbd)\"}\n- Compensation (candidate stated): ${candidate.comp || \"(tbd)\"}\n- Evidence:\n${(candidate.evidence||[]).length ? candidate.evidence.map(e=>`  - ${e}`).join(\"\\n\") : \"  - (none)\"}\n- Risk flags:\n${candidate.risks ? candidate.risks.split(\"\\\\n\").map(x=>`  - ${x}`).join(\"\\n\") : \"  - (none)\"}\n\n## Offer Terms (fill)\n- Labor category mapping:\n- Bill rate / salary:\n- Work mode:\n- Start date:\n- Contingencies (clearance/customer approval):\n- Travel:\n- Period of performance alignment:\n\n## Decision Basis (link to sealed scorecards)\n- Interviews referencing candidate: ${countInterviews(candidate.id)} (see SCORECARDS export)\n- Decision: (Offer / Hold / No-offer)\n- Approver:\n- Seal:\n`;\n}\n\nfunction countInterviews(cid){\n  const db = load();\n  return db.interviews.filter(i=>i.candidate===cid).length;\n}\n\nfunction previewText(txt){\n  document.getElementById(\"preview\").textContent = txt;\n}\n\nfunction downloadText(filename, text){\n  const blob = new Blob([text], {type:\"text/plain;charset=utf-8\"});\n  const a = document.createElement(\"a\");\n  a.href = URL.createObjectURL(blob);\n  a.download = filename;\n  a.click();\n}\n\nfunction downloadJson(filename, obj){\n  const blob = new Blob([JSON.stringify(obj,null,2)], {type:\"application/json\"});\n  const a = document.createElement(\"a\");\n  a.href = URL.createObjectURL(blob);\n  a.download = filename;\n  a.click();\n}\n\nfunction downloadRoleMDs(){\n  const db = load();\n  const meta = packMeta();\n  if(!db.roles.length) return alert(\"No roles to export.\");\n  // download each role MD\n  const first = mdRole(db.roles[0], meta);\n  previewText(first);\n  db.roles.forEach(r=>{\n    const fn = `${safeFile(meta.prefix)}_${safeFile(r.id)}_${safeFile(r.name)}.md`;\n    downloadText(fn, mdRole(r, meta));\n  });\n}\n\nfunction downloadMG(){\n  const meta = packMeta();\n  const mg = buildMG(meta);\n  previewText(JSON.stringify(mg, null, 2).slice(0, 3000) + \"\\n\");\n  downloadJson(`${safeFile(meta.prefix)}_MG_TalentGraph_${meta.date}.json`, mg);\n}\n\nfunction downloadScorecards(){\n  const meta = packMeta();\n  const sc = buildScorecards(meta);\n  previewText(JSON.stringify(sc, null, 2).slice(0, 3000) + \"\\n\");\n  downloadJson(`${safeFile(meta.prefix)}_SCORECARDS_${meta.date}.json`, sc);\n}\n\nfunction downloadRS(){\n  const meta = packMeta();\n  const rs = buildRS(meta);\n  previewText(rs);\n  downloadText(`${safeFile(meta.prefix)}_RS_HIRING_WEEKLY_${meta.date}.md`, rs);\n}\n\nfunction downloadDS(){\n  const meta = packMeta();\n  const ds = buildDS(meta);\n  previewText(ds);\n  downloadText(`${safeFile(meta.prefix)}_DS_HIRING_${meta.date}.md`, ds);\n}\n\nfunction refreshOffersList(){\n  const db = load();\n  const meta = packMeta();\n  const offers = db.candidates.filter(c=>c.status===\"Offer\");\n  const el = document.getElementById(\"offersList\");\n  if(!el) return;\n  if(!offers.length){ el.textContent = \"No candidates in Offer status.\"; return; }\n\n  el.innerHTML = offers.map(c=>{\n    const role = db.roles.find(r=>r.id===c.role) || {id:c.role, name:\"(role not found)\"};\n    const fn = `${safeFile(meta.prefix)}_DLR_OFFER_${safeFile(c.id)}_${safeFile(c.name)}_${meta.date}.md`;\n    return `<div style=\"border:1px solid #1b2a3a;border-radius:12px;padding:10px;margin-bottom:8px\">\n      <div><b>${c.name}<\/b> <span class=\"muted mono\">${c.id}<\/span><\/div>\n      <div class=\"muted small\">${role.id}  ${role.name}<\/div>\n      <div class=\"right\" style=\"margin-top:8px\">\n        <button class=\"primary\" data-action=\"offer-dlr\" data-id=\"${c.id}\">Download Offer DLR<\/button>\n      <\/div>\n    <\/div>`;\n  }).join(\"\");\n}\n\nfunction downloadOffer(candidateId){\n  const db = load();\n  const meta = packMeta();\n  const c = db.candidates.find(x=>x.id===candidateId);\n  if(!c) return alert(\"Candidate not found.\");\n  const r = db.roles.find(x=>x.id===c.role) || {id:c.role, name:\"(role not found)\"};\n  const txt = buildOfferMD(c, r, meta);\n  previewText(txt);\n  const fn = `${safeFile(meta.prefix)}_DLR_OFFER_${safeFile(c.id)}_${safeFile(c.name)}_${meta.date}.md`;\n  downloadText(fn, txt);\n}\n\n// -------- UTILITIES + EXPORT/IMPORT --------\nfunction v(id){ return document.getElementById(id).value.trim(); }\nfunction s(id,val){ document.getElementById(id).value = val; }\nfunction hint(id,msg){ document.getElementById(id).textContent = msg; setTimeout(()=>document.getElementById(id).textContent=\"\", 1500); }\n\n// Export/Import/Reset\ndocument.getElementById(\"btnExport\").addEventListener(\"click\", ()=>{\n  const db = load();\n  const blob = new Blob([JSON.stringify(db,null,2)], {type:\"application/json\"});\n  const a = document.createElement(\"a\");\n  a.href = URL.createObjectURL(blob);\n  a.download = `sequoia_hiring_console_${new Date().toISOString().slice(0,10)}.json`;\n  a.click();\n});\ndocument.getElementById(\"btnImport\").addEventListener(\"click\", ()=>document.getElementById(\"fileImport\").click());\ndocument.getElementById(\"fileImport\").addEventListener(\"change\", (e)=>{\n  const file = e.target.files[0]; if(!file) return;\n  const reader = new FileReader();\n  reader.onload = () => {\n    try{\n      const db = JSON.parse(reader.result);\n      setStoreItem(KEY, JSON.stringify(db));\n      refreshAll();\n      alert(\"Imported.\");\n    } catch(err){ alert(\"Invalid JSON.\"); }\n  };\n  reader.readAsText(file);\n});\ndocument.getElementById(\"btnReset\").addEventListener(\"click\", ()=>{\n  if(!confirm(\"Reset ALL local data?\")) return;\n  removeStoreItem(KEY);\n  load(); refreshAll();\n});\n\n\n\nfunction renderRSModal(){\n  const m = document.getElementById(\"rsModal\");\n  if(!m) return;\n  m.innerHTML = `\n    <div class=\"card\" style=\"position:sticky;top:0;z-index:1\">\n      <div style=\"display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap\">\n        <div>\n          <b>RS Console (overlay mode)<\/b>\n          <div class=\"muted small\">If your layout collapses tabs, RS renders here.<\/div>\n        <\/div>\n        <div class=\"flex\">\n          <button id=\"rsModalClose\" class=\"danger\">Close<\/button>\n        <\/div>\n      <\/div>\n    <\/div>\n    <div style=\"margin-top:12px\">\n      ${document.getElementById(\"tab-rs\") ? document.getElementById(\"tab-rs\").innerHTML.replace(/id=\"rsFallback\"[\\s\\S]*?<\\/div>/g,\"\") : '<div class=\"card\"><h3>RS section not found in DOM<\/h3><\/div>'}\n    <\/div>\n  `;\n  // Clean up any stray fallback renders\n  m.querySelectorAll(\"#rsFallback\").forEach(n=>n.remove());\n  // Re-bind RS buttons inside modal by reusing IDs (they exist now inside modal)\n  document.getElementById(\"rsModalClose\")?.addEventListener(\"click\", ()=>{\n    m.style.display=\"none\";\n  });\n  // Bind RS controls (these IDs are now inside modal)\n  document.getElementById(\"btnCreateRSNow\")?.addEventListener(\"click\", ()=>{ defaultRSFields(); autoFillRS(); saveRS(); });\n  document.getElementById(\"btnAutoFillRS\")?.addEventListener(\"click\", autoFillRS);\n  document.getElementById(\"btnAddPatch\")?.addEventListener(\"click\", addPatch);\n  document.getElementById(\"btnSaveRS\")?.addEventListener(\"click\", saveRS);\n  document.getElementById(\"btnExportRS\")?.addEventListener(\"click\", exportRS);\n  document.getElementById(\"btnExportExec\")?.addEventListener(\"click\", exportExec);\n  document.getElementById(\"btnClearRS\")?.addEventListener(\"click\", defaultRSFields);\n\n  document.getElementById(\"patchesTable\")?.addEventListener(\"click\", (e)=>{\n    const b = e.target.closest(\"button\"); if(!b) return;\n    if(b.dataset.action===\"patch-del\"){\n      rsEditingPatches = rsEditingPatches.filter(p=>p.id!==b.dataset.id);\n      renderPatchesTable();\n    }\n  });\n  document.getElementById(\"rsTable\")?.addEventListener(\"click\", (e)=>{\n    const b = e.target.closest(\"button\"); if(!b) return;\n    e.preventDefault();\n    const a = b.dataset.action; const id = b.dataset.id;\n    if(a===\"rs-edit\"){ openRS(id); }\n    if(a===\"rs-del\"){ deleteRS(id); }\n  }, true);\n\n  // force render list/snapshot defaults\n  renderRSList();\n  defaultRSFields();\n}\n\n// ---------------- RS (Reflection Sessions) ----------------\nlet rsEditingPatches = [];\nlet rsLastSnapshot = null;\n\nfunction defaultRSFields(){\n  document.getElementById(\"rsId\").value = uid(\"RS\");\n  document.getElementById(\"rsWeek\").value = today();\n  document.getElementById(\"rsSteward\").value = document.getElementById(\"cohSteward\")?.value || \"\";\n  document.getElementById(\"rsSealed\").value = \"false\";\n  document.getElementById(\"rsDecisions\").value = \"\";\n  rsEditingPatches = [];\n  rsLastSnapshot = null;\n  renderPatchesTable();\n  document.getElementById(\"rsSnapshot\").innerHTML = `<div class=\"muted\">Create an RS to populate snapshot.<\/div>`;\n  hint(\"rsSavedHint\",\"\");\n}\n\nfunction computeSnapshot(){\n  const db = load();\n  const now = Date.now();\n  const days = (iso)=> Math.max(0, Math.round((now - new Date(iso).getTime()) / (1000*60*60*24)));\n\n  const statuses = [\"Sourcing\",\"Screened\",\"Gate2\",\"Gate3\",\"Offer\",\"Accepted\",\"Cleared\",\"Started\"];\n  const counts = {};\n  const oldest = {};\n  statuses.forEach(s=>{ counts[s]=0; oldest[s]=0; });\n\n  db.candidates.forEach((c,idx)=>{\n    c = redactCandidate(c, idx);\n    const st = c.status || \"Sourcing\";\n    counts[st] = (counts[st]||0) + 1;\n    const age = days(c.status_changed || c.created || nowIso());\n    oldest[st] = Math.max(oldest[st]||0, age);\n  });\n\n  const offers = db.candidates.filter(c=>c.offer_date);\n  const accepted = db.candidates.filter(c=>c.accepted_date);\n  const offerAcceptance = offers.length ? Math.round((accepted.length / offers.length)*100) : null;\n\n  const tto = offers\n    .filter(c=>c.created)\n    .map(c => (new Date(c.offer_date).getTime() - new Date(c.created).getTime()) / (1000*60*60*24))\n    .filter(x=>x>=0);\n  const avgTimeToOffer = tto.length ? Math.round((tto.reduce((a,b)=>a+b,0)/tto.length)*10)/10 : null;\n\n  const byCand = {};\n  db.interviews.forEach(i=>{\n    byCand[i.candidate] ||= [];\n    byCand[i.candidate].push(Number(i.rfs));\n  });\n  let varianceBreaches = 0;\n  Object.values(byCand).forEach(scores=>{\n    if(scores.length >= 2){\n      const mx = Math.max(...scores), mn = Math.min(...scores);\n      if(mx - mn > 15) varianceBreaches += 1;\n    }\n  });\n\n  const stuck = [];\n  const thresh = {Sourcing:7, Screened:5, Gate2:3, Gate3:3, Offer:2, Accepted:5, Cleared:10, Started:9999};\n  db.candidates.forEach((c,idx)=>{\n    c = redactCandidate(c, idx);\n    const st = c.status || \"Sourcing\";\n    const age = days(c.status_changed || c.created || nowIso());\n    if(age > (thresh[st] ?? 7)){\n      stuck.push({id:c.id, name:c.name, status:st, days:age, role:c.role});\n    }\n  });\n\n  const driftRecent = db.drift.slice(-10).reverse();\n\n  return {\n    generated: nowIso(),\n    counts,\n    oldest,\n    slo: {\n      time_to_offer_days_avg: avgTimeToOffer,\n      offer_acceptance_pct: offerAcceptance,\n      variance_breaches_count: varianceBreaches\n    },\n    stuck,\n    driftRecent\n  };\n}\n\nfunction renderSnapshotBox(s){\n  const sCounts = Object.entries(s.counts).map(([k,v])=>`<span class=\"pill\">${k}: ${v}<\/span>`).join(\" \");\n  const sOld = Object.entries(s.oldest).map(([k,v])=>`<span class=\"pill\">${k} oldest: ${v}d<\/span>`).join(\" \");\n  const slo = s.slo;\n  const tto = (slo.time_to_offer_days_avg==null) ? \"\" : `${slo.time_to_offer_days_avg}d`;\n  const acc = (slo.offer_acceptance_pct==null) ? \"\" : `${slo.offer_acceptance_pct}%`;\n  const varb = `${slo.variance_breaches_count}`;\n  const stuckTop = s.stuck.slice(0,8).map(x=>`<div class=\"muted\"> ${x.name} (${x.id})  ${x.status} ${x.days}d<\/div>`).join(\"\") || `<div class=\"muted\">None<\/div>`;\n  const driftTop = s.driftRecent.slice(0,6).map(d=>`<div class=\"muted\"> <b>${d.code}<\/b>  ${d.msg}<\/div>`).join(\"\") || `<div class=\"muted\">None<\/div>`;\n\n  return `\n  <div class=\"muted small\">Generated: <span class=\"mono\">${s.generated}<\/span><\/div>\n  <div style=\"margin-top:8px\">${sCounts}<\/div>\n  <div style=\"margin-top:8px\">${sOld}<\/div>\n  <div class=\"grid\" style=\"margin-top:10px\">\n    <div class=\"card\"><div class=\"muted\">Avg Time-to-Offer<\/div><b>${tto}<\/b><\/div>\n    <div class=\"card\"><div class=\"muted\">Offer Acceptance<\/div><b>${acc}<\/b><\/div>\n  <\/div>\n  <div class=\"card\" style=\"margin-top:10px\">\n    <h3>Variance Breaches (RFS range > 15)<\/h3>\n    <div class=\"muted\">${varb}<\/div>\n  <\/div>\n  <div class=\"card\" style=\"margin-top:10px\">\n    <h3>Stuck Candidates (top)<\/h3>\n    ${stuckTop}\n  <\/div>\n  <div class=\"card\" style=\"margin-top:10px\">\n    <h3>Recent Drift Alerts (top)<\/h3>\n    ${driftTop}\n  <\/div>\n  `;\n}\n\nfunction autoFillRS(){\n  rsLastSnapshot = computeSnapshot();\n  document.getElementById(\"rsSnapshot\").innerHTML = renderSnapshotBox(rsLastSnapshot);\n}\n\nfunction renderPatchesTable(){\n  const el = document.getElementById(\"patchesTable\");\n  if(!el) return;\n  if(!rsEditingPatches.length){\n    el.innerHTML = `<div class=\"muted\">No patches yet.<\/div>`;\n    return;\n  }\n  el.innerHTML = `<table>\n    <thead><tr><th>ID<\/th><th>Title<\/th><th>Owner<\/th><th>Due<\/th><th>Success metric<\/th><th><\/th><\/tr><\/thead>\n    <tbody>\n      ${rsEditingPatches.map(p=>`\n        <tr>\n          <td class=\"mono\">${p.id}<\/td>\n          <td>${p.title}<\/td>\n          <td class=\"muted\">${p.owner||\"\"}<\/td>\n          <td class=\"muted\">${p.due||\"\"}<\/td>\n          <td class=\"muted\">${p.metric||\"\"}<\/td>\n          <td><button class=\"danger\" data-action=\"patch-del\" data-id=\"${p.id}\">Delete<\/button><\/td>\n        <\/tr>`).join(\"\")}\n    <\/tbody><\/table>`;\n}\n\nfunction addPatch(){\n  const title = document.getElementById(\"patchTitle\").value.trim();\n  if(!title) return alert(\"Patch title required.\");\n  rsEditingPatches.push({\n    id: uid(\"PATCH\"),\n    title,\n    owner: document.getElementById(\"patchOwner\").value.trim(),\n    due: document.getElementById(\"patchDue\").value.trim(),\n    metric: document.getElementById(\"patchMetric\").value.trim()\n  });\n  document.getElementById(\"patchTitle\").value = \"\";\n  document.getElementById(\"patchOwner\").value = \"\";\n  document.getElementById(\"patchDue\").value = \"\";\n  document.getElementById(\"patchMetric\").value = \"\";\n  renderPatchesTable();\n}\n\nfunction saveRS(){\n  const db = load();\n  const id = document.getElementById(\"rsId\").value.trim();\n  const week = document.getElementById(\"rsWeek\").value.trim() || today();\n  const steward = document.getElementById(\"rsSteward\").value.trim() || \"(unassigned)\";\n  const sealed = document.getElementById(\"rsSealed\").value === \"true\";\n  const decisions = document.getElementById(\"rsDecisions\").value.split(\"\\\\n\").map(x=>x.trim()).filter(Boolean);\n\n  const rs = {\n    id,\n    week_of: week,\n    steward,\n    created: nowIso(),\n    sealed,\n    seal: sealed ? `${nowIso()}|v1` : null,\n    snapshot: rsLastSnapshot || computeSnapshot(),\n    decisions,\n    patches: rsEditingPatches.slice()\n  };\n\n  if(!id) return alert(\"RS ID required.\");\n\n  const idx = db.rs.findIndex(x=>x.id===id);\n  if(idx >= 0){\n    if(db.rs[idx].sealed) return alert(\"RS is sealed. Create a new RS next week.\");\n    db.rs[idx] = { ...db.rs[idx], ...rs, created: db.rs[idx].created };\n  } else {\n    db.rs.push(rs);\n  }\n\n  save(db);\n  renderRSList();\n  hint(\"rsSavedHint\",\"Saved.\");\n}\n\nfunction rsToMarkdown(rs, meta){\n  const c = rs.snapshot.counts;\n  const slo = rs.snapshot.slo;\n  const tto = slo.time_to_offer_days_avg==null ? \"\" : `${slo.time_to_offer_days_avg} days`;\n  const acc = slo.offer_acceptance_pct==null ? \"\" : `${slo.offer_acceptance_pct}%`;\n  const drift = rs.snapshot.driftRecent.map(d=>`- **${d.code}** (${d.time})  ${d.msg}\\n  - Patch hint: ${d.patch}`).join(\"\\n\") || \"- None\";\n  const stuck = rs.snapshot.stuck.map(x=>`- ${x.name} (${x.id})  ${x.status} ${x.days}d`).join(\"\\n\") || \"- None\";\n  const dec = rs.decisions.map(d=>`- ${d}`).join(\"\\n\") || \"- None\";\n  const patches = rs.patches.map(p=>`- **${p.id}**  ${p.title}\\n  - Owner: ${p.owner||\"(tbd)\"} | Due: ${p.due||\"(tbd)\"}\\n  - Success: ${p.metric||\"(tbd)\"}`).join(\"\\n\") || \"- None\";\n\n  return `# RS_HIRING_WEEKLY  ${rs.week_of}\n**Program:** ${meta.program}  \n**RS ID:** ${rs.id}  \n**Generated:** ${meta.generated}  \n**Coherence Steward:** ${rs.steward}  \n**Seal:** ${rs.sealed ? rs.seal : \"(open)\"}  \n\n## Operating Snapshot\n- Open roles: ${load().roles.length}\n- Candidates: ${load().candidates.length}\n- Sourcing: ${c.Sourcing||0}\n- Screened: ${c.Screened||0}\n- Gate2: ${c.Gate2||0}\n- Gate3: ${c.Gate3||0}\n- Offer: ${c.Offer||0}\n- Accepted: ${c.Accepted||0}\n- Cleared: ${c.Cleared||0}\n- Started: ${c.Started||0}\n\n## SLO Check\n- Avg Time-to-Offer: ${tto}\n- Offer Acceptance: ${acc}\n- Variance breaches (RFS range > 15): ${rs.snapshot.slo.variance_breaches_count}\n\n## Drift (DS) Review\n${drift}\n\n## Stuck Candidates\n${stuck}\n\n## Decisions (Seal)\n${dec}\n\n## Patches (SealVersionPatch)\n${patches}\n`;\n}\n\nfunction rsExecBrief(rs, meta){\n  const slo = rs.snapshot.slo;\n  const tto = slo.time_to_offer_days_avg==null ? \"\" : `${slo.time_to_offer_days_avg}d`;\n  const acc = slo.offer_acceptance_pct==null ? \"\" : `${slo.offer_acceptance_pct}%`;\n  const c = rs.snapshot.counts;\n  const topDrift = rs.snapshot.driftRecent.slice(0,3).map(d=>`- ${d.code}: ${d.msg}`).join(\"\\n\") || \"- None\";\n  const topStuck = rs.snapshot.stuck.slice(0,5).map(x=>`- ${x.name} (${x.id})  ${x.status} ${x.days}d`).join(\"\\n\") || \"- None\";\n  const topPatches = rs.patches.slice(0,5).map(p=>`- ${p.id}: ${p.title} (Owner: ${p.owner||\"tbd\"}, Due: ${p.due||\"tbd\"})`).join(\"\\n\") || \"- None\";\n\n  return `# Hiring Exec Brief  ${rs.week_of}\n**Program:** ${meta.program}  \n**RS ID:** ${rs.id}  \n**Seal:** ${rs.sealed ? rs.seal : \"(open)\"}  \n\n## KPIs\n- Avg Time-to-Offer: ${tto}\n- Offer Acceptance: ${acc}\n- Variance breaches: ${rs.snapshot.slo.variance_breaches_count}\n\n## Pipeline\n- Roles: ${load().roles.length}\n- Candidates: ${load().candidates.length}\n- Sourcing ${c.Sourcing||0} | Screened ${c.Screened||0} | Gate2 ${c.Gate2||0} | Gate3 ${c.Gate3||0} | Offer ${c.Offer||0} | Accepted ${c.Accepted||0} | Started ${c.Started||0}\n\n## Top Drift\n${topDrift}\n\n## Top Stuck\n${topStuck}\n\n## Patches Shipping\n${topPatches}\n`;\n}\n\nfunction exportRS(){\n  const db = load();\n  const id = document.getElementById(\"rsId\").value.trim();\n  const rs = db.rs.find(x=>x.id===id);\n  if(!rs) return alert(\"Save RS first.\");\n  const meta = packMeta();\n  const txt = rsToMarkdown(rs, meta);\n  previewText(txt);\n  downloadText(`${safeFile(meta.prefix)}_RS_${safeFile(rs.id)}_${rs.week_of}.md`, txt);\n}\n\nfunction exportExec(){\n  const db = load();\n  const id = document.getElementById(\"rsId\").value.trim();\n  const rs = db.rs.find(x=>x.id===id);\n  if(!rs) return alert(\"Save RS first.\");\n  const meta = packMeta();\n  const txt = rsExecBrief(rs, meta);\n  previewText(txt);\n  downloadText(`${safeFile(meta.prefix)}_EXEC_BRIEF_${safeFile(rs.id)}_${rs.week_of}.md`, txt);\n}\n\nfunction renderRSList(){\n  const db = load();\n  const el = document.getElementById(\"rsTable\");\n  if(!el) return;\n  if(!db.rs.length){\n    el.innerHTML = `<div class=\"muted\">No RS sessions yet.<\/div>`;\n    return;\n  }\n  el.innerHTML = `<table>\n    <thead><tr><th>ID<\/th><th>Week<\/th><th>Steward<\/th><th>Seal<\/th><th>Patches<\/th><th><\/th><\/tr><\/thead>\n    <tbody>\n      ${db.rs.slice().reverse().map(r=>`\n        <tr>\n          <td class=\"mono\">${r.id}<\/td>\n          <td class=\"muted\">${r.week_of}<\/td>\n          <td class=\"muted\">${r.steward}<\/td>\n          <td class=\"muted mono\">${r.sealed ? r.seal : \"(open)\"}<\/td>\n          <td class=\"muted\">${(r.patches||[]).length}<\/td>\n          <td>\n            <button data-action=\"rs-edit\" data-id=\"${r.id}\">Open<\/button>\n            <button class=\"danger\" data-action=\"rs-del\" data-id=\"${r.id}\">Delete<\/button>\n          <\/td>\n        <\/tr>`).join(\"\")}\n    <\/tbody><\/table>`;\n}\n\nfunction openRS(id){\n  const db = load();\n  const rs = db.rs.find(x=>x.id===id);\n  if(!rs) return;\n\n  const modal = document.getElementById(\"rsModal\");\n  const scope = (modal && modal.style.display===\"block\") ? modal : document;\n  const q = (sel)=> scope.querySelector(sel);\n\n  q(\"#rsId\").value = rs.id;\n  q(\"#rsWeek\").value = rs.week_of;\n  q(\"#rsSteward\").value = rs.steward;\n  q(\"#rsSealed\").value = rs.sealed ? \"true\" : \"false\";\n  q(\"#rsDecisions\").value = (rs.decisions||[]).join(\"\\n\");\n\n  rsEditingPatches = (rs.patches||[]).slice();\n  rsLastSnapshot = rs.snapshot || null;\n\n  const snap = q(\"#rsSnapshot\");\n  if(snap) snap.innerHTML = rsLastSnapshot ? renderSnapshotBox(rsLastSnapshot) : `<div class=\"muted\">No snapshot.<\/div>`;\n\n  renderPatchesTable();\n}\n\nfunction deleteRS(id){\n  const db = load();\n  if(!confirm(\"Delete RS session?\")) return;\n  db.rs = db.rs.filter(x=>x.id!==id);\n  save(db);\n  renderRSList();\n}\n\nfunction bindEvents(){\n  document.getElementById(\"btnSeed\")?.addEventListener(\"click\", seedSequoia);\n  document.getElementById(\"btnNewRole\")?.addEventListener(\"click\", newRole);\n  document.getElementById(\"btnNewCandidate\")?.addEventListener(\"click\", newCandidate);\n  document.getElementById(\"btnNewInterview\")?.addEventListener(\"click\", newInterview);\n  document.getElementById(\"btnGoArtifacts\")?.addEventListener(\"click\", ()=>setTab(\"artifacts\"));\n  document.getElementById(\"btnGoRS\")?.addEventListener(\"click\", ()=>setTab(\"rs\"));\n\n  document.getElementById(\"btnSaveRole\")?.addEventListener(\"click\", saveRole);\n  document.getElementById(\"btnClearRole\")?.addEventListener(\"click\", clearRole);\n  document.getElementById(\"btnSaveCandidate\")?.addEventListener(\"click\", saveCandidate);\n  document.getElementById(\"btnClearCandidate\")?.addEventListener(\"click\", clearCandidate);\n  document.getElementById(\"btnSaveInterview\")?.addEventListener(\"click\", saveInterview);\n  document.getElementById(\"btnClearInterview\")?.addEventListener(\"click\", clearInterview);\n\n  document.getElementById(\"btnRunDrift\")?.addEventListener(\"click\", runDriftScan);\n\n  document.getElementById(\"btnDLRRoles\")?.addEventListener(\"click\", downloadRoleMDs);\n  document.getElementById(\"btnMG\")?.addEventListener(\"click\", downloadMG);\n  document.getElementById(\"btnScorecards\")?.addEventListener(\"click\", downloadScorecards);\n  document.getElementById(\"btnRSTemplate\")?.addEventListener(\"click\", downloadRS);\n  document.getElementById(\"btnDSTemplate\")?.addEventListener(\"click\", downloadDS);\n  document.getElementById(\"btnZipPack\")?.addEventListener(\"click\", downloadZipPack);\n  document.getElementById(\"btnSyncPack\")?.addEventListener(\"click\", syncPackNow);\n  document.getElementById(\"btnRetryOutbox\")?.addEventListener(\"click\", retryOutbox);\n  document.getElementById(\"edgeEndpoint\")?.addEventListener(\"change\", saveEdgeCfg);\n  document.getElementById(\"edgeToken\")?.addEventListener(\"change\", saveEdgeCfg);\n  document.getElementById(\"edgeSignKey\")?.addEventListener(\"change\", saveEdgeCfg);\n\n  document.getElementById(\"btnAutoFillRS\")?.addEventListener(\"click\", autoFillRS);\n    document.getElementById(\"btnCreateRSNow\")?.addEventListener(\"click\", ()=>{ defaultRSFields(); autoFillRS(); saveRS(); });\n  document.getElementById(\"btnSaveRS\")?.addEventListener(\"click\", saveRS);\n  document.getElementById(\"btnExportRS\")?.addEventListener(\"click\", exportRS);\n  document.getElementById(\"btnExportExec\")?.addEventListener(\"click\", exportExec);\n  document.getElementById(\"btnClearRS\")?.addEventListener(\"click\", defaultRSFields);\n  document.getElementById(\"btnAddPatch\")?.addEventListener(\"click\", addPatch);\n\n  document.getElementById(\"rolesTable\")?.addEventListener(\"click\", (e)=>{\n    const b = e.target.closest(\"button\"); if(!b) return;\n    const a = b.dataset.action; const id = b.dataset.id;\n    if(a===\"role-edit\") editRole(id);\n    if(a===\"role-delete\") deleteRole(id);\n  });\n\n  document.getElementById(\"candsTable\")?.addEventListener(\"click\", (e)=>{\n    const b = e.target.closest(\"button\"); if(!b) return;\n    const a = b.dataset.action; const id = b.dataset.id;\n    if(a===\"cand-edit\") editCandidate(id);\n    if(a===\"cand-delete\") deleteCandidate(id);\n  });\n\n  document.getElementById(\"intsTable\")?.addEventListener(\"click\", (e)=>{\n    const b = e.target.closest(\"button\"); if(!b) return;\n    const a = b.dataset.action; const id = b.dataset.id;\n    if(a===\"int-edit\") editInterview(id);\n    if(a===\"int-delete\") deleteInterview(id);\n  });\n\n  document.getElementById(\"boardTable\")?.addEventListener(\"click\", (e)=>{\n    const b = e.target.closest(\"button\"); if(!b) return;\n    if(b.dataset.action===\"cand-move\"){\n      moveCandidate(b.dataset.id, Number(b.dataset.dir));\n    }\n  });\n\n  document.getElementById(\"offersList\")?.addEventListener(\"click\", (e)=>{\n    const b = e.target.closest(\"button\"); if(!b) return;\n    if(b.dataset.action===\"offer-dlr\") downloadOffer(b.dataset.id);\n  });\n\n  document.getElementById(\"rsTable\")?.addEventListener(\"click\", (e)=>{\n    const b = e.target.closest(\"button\"); if(!b) return;\n    const a = b.dataset.action; const id = b.dataset.id;\n    if(a===\"rs-edit\"){ setTab(\"rs\"); openRS(id); }\n    if(a===\"rs-del\") deleteRS(id);\n  });\n\n  document.getElementById(\"patchesTable\")?.addEventListener(\"click\", (e)=>{\n    const b = e.target.closest(\"button\"); if(!b) return;\n    if(b.dataset.action===\"patch-del\"){\n      rsEditingPatches = rsEditingPatches.filter(p=>p.id!==b.dataset.id);\n      renderPatchesTable();\n    }\n  });\n}\n\n\n// ---- Diagnostics ----\nwindow.addEventListener(\"error\", (e)=>{\n  try{\n    const msg = (e && e.message) ? e.message : \"Unknown error\";\n    const box = document.createElement(\"div\");\n    box.style.position=\"fixed\"; box.style.left=\"12px\"; box.style.right=\"12px\"; box.style.bottom=\"12px\";\n    box.style.background=\"rgba(255,107,107,.12)\"; box.style.border=\"1px solid rgba(255,107,107,.4)\";\n    box.style.padding=\"10px\"; box.style.borderRadius=\"12px\"; box.style.zIndex=\"9999\";\n    box.innerHTML = `<b>JS Error:<\/b> <span class=\"mono\">${msg}<\/span>  open DevTools Console for details.`;\n    document.body.appendChild(box);\n  }catch(_){}\n});\n\nfunction routeHash(){\n  const h = (location.hash||\"\").replace(\"#\",\"\").trim();\n  if(h && [\"dashboard\",\"roles\",\"candidates\",\"interviews\",\"board\",\"drift\",\"test\",\"rs\",\"artifacts\"].includes(h)){\n    setTab(h);\n  }\n}\nwindow.addEventListener(\"hashchange\", routeHash);\n\n\n// ---------------- Test Mode ----------------\nfunction tmLog(msg){\n  const el = document.getElementById(\"tmLog\");\n  if(!el) return;\n  const line = `[${new Date().toISOString()}] ${msg}\\n`;\n  el.textContent = (el.textContent || \"\") + line;\n  el.scrollTop = el.scrollHeight;\n}\nfunction tmClearLog(){ const el=document.getElementById(\"tmLog\"); if(el) el.textContent=\"\"; }\n\nfunction tmSetSafe(mode){\n  const safe = document.getElementById(\"safeExport\");\n  const lvl = document.getElementById(\"safeExportLevel\");\n  if(!safe || !lvl) return;\n  if(mode===\"false\"){ safe.value=\"false\"; return; }\n  safe.value=\"true\";\n  lvl.value = (mode===\"strict\") ? \"strict\" : \"lite\";\n}\n\nfunction tmRandPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }\nfunction tmNowMinusDays(d){\n  const dt = new Date(Date.now() - d*24*60*60*1000);\n  return dt.toISOString();\n}\n\nfunction tmSeed(){\n  try{ seedSequoia(); tmLog(\"Seeded SEQUOIA roles.\"); } catch(e){ tmLog(\"Seed roles failed: \"+e.message); }\n}\n\nfunction tmGenerateData(){\n  const db = load();\n  const n = Math.max(1, Math.min(200, Number(document.getElementById(\"tmCount\")?.value || 10)));\n  if(!db.roles.length){ tmLog(\"No roles found. Seed roles first.\"); return; }\n\n  const statuses = [\"Sourcing\",\"Screened\",\"Gate2\",\"Gate3\"];\n  const clearances = [\"TS/SCI (eligible)\",\"Secret\",\"None\"];\n  const comps = [\"$120k-$150k\",\"$150k-$185k\",\"$185k-$220k\",\"$220k-$250k\"];\n  const ev = [\"Portfolio link\",\"Prior program reference\",\"GitHub (redacted)\",\"Writing sample\"];\n\n  for(let i=0;i<n;i++){\n    const role = tmRandPick(db.roles).id;\n    const id = `C-${String(db.candidates.length+1).padStart(4,\"0\")}`;\n    const c = {\n      id,\n      name: `Sample Candidate ${db.candidates.length+1}`,\n      role,\n      status: tmRandPick(statuses),\n      clearance: tmRandPick(clearances),\n      availability: new Date(Date.now()+ (7+Math.floor(Math.random()*30))*24*60*60*1000).toISOString().slice(0,10),\n      comp: tmRandPick(comps),\n      evidence: [tmRandPick(ev)],\n      risks: \"\"\n    };\n    c.created = nowIso();\n    c.status_changed = c.created;\n    db.candidates.push(c);\n\n    db.interviews.push({\n      id: `I-${String(db.interviews.length+1).padStart(4,\"0\")}`,\n      candidate: c.id,\n      gate: \"Gate 1  Screen\",\n      interviewer: \"TestRunner\",\n      rfs: 80 + Math.floor(Math.random()*10),\n      tps: 70 + Math.floor(Math.random()*15),\n      ur: 0.65 + Math.round(Math.random()*25)/100,\n      decision: \"Hire\",\n      evidence: [\"Test evidence\"],\n      notes: \"\",\n      flags: \"\",\n      seal: `${nowIso()}|v1`\n    });\n  }\n\n  save(db);\n  tmLog(`Generated ${n} candidates + Gate 1 interviews.`);\n}\n\nfunction tmTriggerVariance(){\n  const db = load();\n  if(!db.candidates.length){ tmLog(\"No candidates.\"); return; }\n  const c = db.candidates[0];\n  db.interviews.push({\n    id: `I-${String(db.interviews.length+1).padStart(4,\"0\")}`,\n    candidate: c.id,\n    gate: \"Gate 2  Simulation\",\n    interviewer: \"Interviewer-A\",\n    rfs: 95, tps: 85, ur: 0.85, decision: \"Hire\",\n    evidence: [\"A\"], notes:\"\", flags:\"\", seal:`${nowIso()}|v1`\n  });\n  db.interviews.push({\n    id: `I-${String(db.interviews.length+1).padStart(4,\"0\")}`,\n    candidate: c.id,\n    gate: \"Gate 2  Simulation\",\n    interviewer: \"Interviewer-B\",\n    rfs: 60, tps: 70, ur: 0.70, decision: \"Hold\",\n    evidence: [\"B\"], notes:\"\", flags:\"\", seal:`${nowIso()}|v1`\n  });\n  save(db);\n  tmLog(`Variance breach injected for ${c.id} (95 vs 60).`);\n}\n\nfunction tmMakeOfferAccepted(){\n  const db = load();\n  if(!db.candidates.length){ tmLog(\"No candidates.\"); return; }\n  const c = db.candidates[0];\n  c.status = \"Offer\"; c.offer_date = nowIso(); c.status_changed = nowIso();\n  c.status = \"Accepted\"; c.accepted_date = nowIso(); c.status_changed = nowIso();\n  save(db);\n  tmLog(`Candidate ${c.id} moved to Offer then Accepted.`);\n}\n\nfunction tmSimulateAging(){\n  const db = load();\n  const days = Math.max(0, Math.min(60, Number(document.getElementById(\"tmAgeDays\")?.value || 10)));\n  db.candidates.forEach((c,idx)=>{\n    if(idx % 2 === 0){\n      c.created = tmNowMinusDays(days+2);\n      c.status_changed = tmNowMinusDays(days);\n    }\n  });\n  save(db);\n  tmLog(`Simulated aging on ~50% by ${days} days.`);\n}\n\nasync function tmRunAll(){\n  tmClearLog();\n  tmLog(\"Starting FULL TEST\");\n  const mode = document.getElementById(\"tmSafe\")?.value || \"false\";\n  tmSetSafe(mode===\"true\" ? \"lite\" : mode);\n\n  if(load().roles.length === 0) tmSeed();\n  tmGenerateData();\n  tmTriggerVariance();\n  tmMakeOfferAccepted();\n  tmSimulateAging();\n\n  refreshAll();\n  tmLog(\"Auto DS executed via dashboard refresh. Check Drift tab.\");\n  tmLog(\"Now click Download ZIP Pack to validate: manifest + hashes + safe export.\");\n}\n\nfunction tmResetAll(){\n  if(!confirm(\"Reset ALL local data?\")) return;\n  removeStoreItem(KEY);\n  load();\n  refreshAll();\n  tmClearLog();\n  tmLog(\"Reset complete.\");\n}\n\nfunction bindTestMode(){\n  document.getElementById(\"tmSeedRoles\")?.addEventListener(\"click\", tmSeed);\n  document.getElementById(\"tmGenData\")?.addEventListener(\"click\", tmGenerateData);\n  document.getElementById(\"tmTriggerVariance\")?.addEventListener(\"click\", tmTriggerVariance);\n  document.getElementById(\"tmMakeOffer\")?.addEventListener(\"click\", tmMakeOfferAccepted);\n  document.getElementById(\"tmSimAging\")?.addEventListener(\"click\", tmSimulateAging);\n  document.getElementById(\"tmRunAll\")?.addEventListener(\"click\", tmRunAll);\n  document.getElementById(\"tmDownloadZip\")?.addEventListener(\"click\", downloadZipPack);\n  document.getElementById(\"tmReset\")?.addEventListener(\"click\", tmResetAll);\n}\n\n(function init(){\n  load();\n  const edgeCfg = loadEdgeCfg();\n  s(\"edgeEndpoint\", edgeCfg.endpoint || \"\");\n  s(\"edgeToken\", edgeCfg.token || \"\");\n  s(\"edgeSignKey\", edgeCfg.sign_key || \"\");\n  updateOutboxBadge();\n  refreshAll();\n  bindEvents();\n  bindTestMode();\n  if(!storageAvailable()){ const w=document.getElementById(\"storeWarn\"); if(w) w.style.display=\"inline\"; }\n  renderRSList();\n  defaultRSFields();\n  // Respect URL hash first; default to dashboard only if no valid hash.\n  const h = (location.hash||\"\").replace(\"#\",\"\").trim();\n  const valid = [\"dashboard\",\"roles\",\"candidates\",\"interviews\",\"board\",\"drift\",\"test\",\"rs\",\"artifacts\"];\n  if(h && valid.includes(h)){\n    setTab(h);\n  } else {\n    setTab(\"dashboard\");\n  }\n})();\n<\/script>\n<\/body>\n<\/html>\n"},
    "bid": {title: "Bid/No-Bid v003", desc: "Capture gating and decision records", html: "<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\"/>\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/>\n  <title>Deep Sigma  Bid/No-Bid Console v003<\/title>\n  <style>\n    :root { --bg:#0b0f14; --card:#111824; --muted:#8aa0b5; --txt:#e7eef7; --accent:#7df9ff; --warn:#ffcc66; --bad:#ff6b6b; --ok:#5dff93; }\n    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--txt);}\n    header{padding:16px 18px;border-bottom:1px solid #1b2a3a;display:flex;gap:12px;align-items:center;justify-content:space-between;}\n    .brand{display:flex;flex-direction:column;gap:2px}\n    .brand b{letter-spacing:.5px}\n    .brand small{color:var(--muted)}\n    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}\n    button{background:#182235;color:var(--txt);border:1px solid #243449;border-radius:10px;padding:10px 12px;cursor:pointer}\n    button:hover{border-color:#2f4765}\n    button.primary{border-color:rgba(125,249,255,.45);box-shadow:0 0 0 1px rgba(125,249,255,.12) inset}\n    button.danger{border-color:rgba(255,107,107,.45)}\n    main{display:grid;grid-template-columns:290px 1fr;min-height:calc(100vh - 66px)}\n    nav{border-right:1px solid #1b2a3a;padding:14px}\n    .tab{display:block;width:100%;text-align:left;padding:10px 12px;border-radius:10px;border:1px solid transparent;background:transparent;color:var(--txt);margin-bottom:8px}\n    .tab.active{background:#101a28;border-color:#243449}\n    .wrap{padding:14px 16px;max-width:1300px}\n    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}\n    .card{background:var(--card);border:1px solid #1b2a3a;border-radius:14px;padding:12px}\n    .card h3{margin:0 0 10px 0;font-size:14px;color:#cfe2f7;letter-spacing:.3px}\n    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}\n    input,textarea,select{width:100%;box-sizing:border-box;background:#0d1520;color:var(--txt);border:1px solid #243449;border-radius:10px;padding:10px 10px;font-size:13px}\n    textarea{min-height:90px;resize:vertical}\n    .muted{color:var(--muted);font-size:12px}\n    .small{font-size:12px}\n    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #243449;color:var(--muted);font-size:12px;margin-right:6px}\n    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}\n    table{width:100%;border-collapse:collapse;font-size:13px}\n    th,td{padding:10px;border-bottom:1px solid #1b2a3a;vertical-align:top}\n    th{color:#b9d3ea;text-align:left;font-weight:600}\n    .hidden{display:none}\n    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;}\n    .flex{display:flex;gap:10px;flex-wrap:wrap}\n    .right{display:flex;gap:10px;justify-content:flex-end;align-items:center}\n    .warnbox{border:1px solid rgba(255,204,102,.35);background:rgba(255,204,102,.06);border-radius:12px;padding:10px}\n    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}\n  <\/style>\n<\/head>\n<body>\n<header>\n  <div class=\"brand\">\n    <b>Deep Sigma  Bid/No-Bid Console v003<\/b>\n    <small>DLR  RS  DS  MG  SealVersionPatch (single-file edge)<\/small>\n  <\/div>\n  <div class=\"row\">\n    <button id=\"btnExport\" class=\"primary\">Export JSON<\/button>\n    <button id=\"btnImport\">Import JSON<\/button>\n    <button id=\"btnReset\" class=\"danger\">Reset<\/button>\n  <\/div>\n<\/header>\n<main>\n  <nav>\n    <button class=\"tab active\" data-tab=\"dashboard\">Dashboard<\/button>\n    <button class=\"tab\" data-tab=\"opps\">Opportunities<\/button>\n    <button class=\"tab\" data-tab=\"gate\">Gate 0 Score<\/button>\n    <button class=\"tab\" data-tab=\"assumptions\">Assumptions<\/button>\n    <button class=\"tab\" data-tab=\"risks\">Risks (KRIs)<\/button>\n    <button class=\"tab\" data-tab=\"decision\">Decision (DLR)<\/button>\n    <button class=\"tab\" data-tab=\"drift\">Drift + RS<\/button>\n    <button class=\"tab\" data-tab=\"artifacts\">Artifacts Export<\/button>\n    <button class=\"tab\" data-tab=\"test\">Test Mode<\/button>\n    <div style=\"margin-top:14px\" class=\"muted\">Data stored in <span class=\"mono\">localStorage<\/span>.<\/div>\n  <\/nav>\n  <div class=\"wrap\">\n    <section id=\"tab-dashboard\">\n      <div class=\"kpi\">\n        <div class=\"card\"><div class=\"muted\">Open Opportunities<\/div><b id=\"kOpen\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Pending Approval<\/div><b id=\"kPending\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Bid Rate<\/div><b id=\"kBidRate\"><\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Kill Rate<\/div><b id=\"kKillRate\"><\/b><\/div>\n      <\/div>\n      <div class=\"kpi\" style=\"margin-top:10px\">\n        <div class=\"card\"><div class=\"muted\">Avg Time-to-Decision<\/div><b id=\"kTTD\"><\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Top Risks (Open)<\/div><b id=\"kRiskOpen\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Watch Decisions<\/div><b id=\"kWatch\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Auto DS Alerts<\/div><b id=\"kDs\">0<\/b><\/div>\n      <\/div>\n      <div class=\"card\" style=\"margin-top:12px\">\n        <h3>Top Risks This Week<\/h3>\n        <div id=\"dashTopRisks\" class=\"muted\">No risks yet.<\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-opps\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Create / Edit Opportunity<\/h3>\n          <label>Opportunity ID<\/label><input id=\"oppId\" placeholder=\"OPP-001\"/>\n          <label>Customer<\/label><input id=\"oppCustomer\" placeholder=\"Agency / Office\"/>\n          <label>Office / Program<\/label><input id=\"oppOffice\" placeholder=\"Program office\"/>\n          <label>Vehicle<\/label><input id=\"oppVehicle\" placeholder=\"IDIQ / GWAC / BPA\"/>\n          <label>NAICS<\/label><input id=\"oppNaics\" placeholder=\"541715\"/>\n          <label>Est Value Band<\/label><input id=\"oppValueBand\" placeholder=\"$50M-$100M\"/>\n          <label>Place of Performance<\/label><input id=\"oppPop\" placeholder=\"CONUS / OCONUS\"/>\n          <label>RFI Date<\/label><input id=\"oppRfi\" type=\"date\"/>\n          <label>RFP Date<\/label><input id=\"oppRfp\" type=\"date\"/>\n          <label>Questions Due<\/label><input id=\"oppQDue\" type=\"date\"/>\n          <label>Proposal Due<\/label><input id=\"oppDue\" type=\"date\"/>\n          <label>Award Estimate<\/label><input id=\"oppAward\" type=\"date\"/>\n          <label>Incumbent + Competitors<\/label><textarea id=\"oppComp\" placeholder=\"Incumbent: ...\\nCompetitors: ...\"><\/textarea>\n          <label>Security / Data / Facility Needs<\/label><textarea id=\"oppSec\" placeholder=\"CUI / TS-SCI / SCIF / IL5 ...\"><\/textarea>\n          <div class=\"right\" style=\"margin-top:10px\">\n            <button id=\"btnOppClear\">Clear<\/button>\n            <button id=\"btnOppSave\" class=\"primary\">Save Opportunity<\/button>\n          <\/div>\n          <div id=\"oppHint\" class=\"muted\"><\/div>\n        <\/div>\n        <div class=\"card\">\n          <h3>Opportunity List<\/h3>\n          <div id=\"oppTable\" class=\"muted\">No opportunities yet.<\/div>\n        <\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-gate\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Gate 0 Weighted Score<\/h3>\n          <label>Opportunity<\/label><select id=\"gateOpp\"><\/select>\n          <div id=\"gateInputs\"><\/div>\n          <div class=\"card\" style=\"margin-top:10px\">\n            <div>Total Score: <b id=\"gateTotal\">0<\/b> / 100<\/div>\n            <div>Recommendation: <b id=\"gateReco\">No-Bid<\/b><\/div>\n            <div class=\"muted small\">Thresholds: Bid  80 | Watch 6579 | No-Bid &lt; 65<\/div>\n          <\/div>\n          <div class=\"right\" style=\"margin-top:10px\">\n            <button id=\"btnGateSave\" class=\"primary\">Save Score<\/button>\n          <\/div>\n          <div id=\"gateHint\" class=\"muted\"><\/div>\n        <\/div>\n        <div class=\"card\">\n          <h3>Scoring Weights<\/h3>\n          <ul class=\"muted\">\n            <li>Strategic fit (15%)<\/li>\n            <li>Customer access / relationship strength (15%)<\/li>\n            <li>Capability fit (15%)<\/li>\n            <li>Past performance match (10%)<\/li>\n            <li>Capacity / staffing feasibility (15%)<\/li>\n            <li>Differentiation strength (10%)<\/li>\n            <li>Price/margin viability (10%)<\/li>\n            <li>Risk level / complexity (10%)<\/li>\n          <\/ul>\n        <\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-assumptions\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Add Assumption<\/h3>\n          <label>Opportunity<\/label><select id=\"aOpp\"><\/select>\n          <label>Assumption<\/label><textarea id=\"aText\"><\/textarea>\n          <label>Category<\/label>\n          <select id=\"aCat\"><option>technical<\/option><option>staffing<\/option><option>pricing<\/option><option>schedule<\/option><option>customer<\/option><\/select>\n          <label>Expiry Date<\/label><input id=\"aExp\" type=\"date\"/>\n          <label>Confidence<\/label><select id=\"aConf\"><option>Low<\/option><option>Med<\/option><option>High<\/option><\/select>\n          <label>Disconfirmers<\/label><textarea id=\"aDis\"><\/textarea>\n          <div class=\"right\" style=\"margin-top:10px\"><button id=\"btnASave\" class=\"primary\">Save Assumption<\/button><\/div>\n        <\/div>\n        <div class=\"card\"><h3>Assumptions<\/h3><div id=\"aTable\" class=\"muted\">None.<\/div><\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-risks\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Add Risk (KRI)<\/h3>\n          <label>Opportunity<\/label><select id=\"rOpp\"><\/select>\n          <label>Risk Description<\/label><textarea id=\"rText\"><\/textarea>\n          <label>Severity<\/label><select id=\"rSev\"><option>Low<\/option><option>Med<\/option><option>High<\/option><\/select>\n          <label>Mitigation<\/label><textarea id=\"rMit\"><\/textarea>\n          <label>Owner<\/label><input id=\"rOwner\"/>\n          <label>Due Date<\/label><input id=\"rDue\" type=\"date\"/>\n          <label>Tripwire Metric<\/label><input id=\"rTrip\" placeholder=\"Trigger condition\"/>\n          <div class=\"right\" style=\"margin-top:10px\"><button id=\"btnRSave\" class=\"primary\">Save Risk<\/button><\/div>\n        <\/div>\n        <div class=\"card\"><h3>Risk Register<\/h3><div id=\"rTable\" class=\"muted\">None.<\/div><\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-decision\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Decision (DLR)<\/h3>\n          <label>Opportunity<\/label><select id=\"dOpp\"><\/select>\n          <label>Decision<\/label><select id=\"dDecision\"><option>Bid<\/option><option>No-Bid<\/option><option>Watch<\/option><\/select>\n          <label>Approver<\/label><input id=\"dApprover\"/>\n          <label>Authority Note<\/label><textarea id=\"dAuthority\"><\/textarea>\n          <label>Decision Rationale<\/label><textarea id=\"dRationale\"><\/textarea>\n          <label>Seal<\/label><select id=\"dSeal\"><option value=\"false\">Open<\/option><option value=\"true\">Sealed<\/option><\/select>\n          <div class=\"right\" style=\"margin-top:10px\"><button id=\"btnDSave\" class=\"primary\">Save Decision<\/button><\/div>\n          <div id=\"dHint\" class=\"muted\"><\/div>\n        <\/div>\n        <div class=\"card\"><h3>Decision Snapshot<\/h3><pre id=\"dPreview\" class=\"mono\" style=\"white-space:pre-wrap\"><\/pre><\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-drift\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Drift Signals (DS)<\/h3>\n          <label>Code<\/label><input id=\"dsCode\" placeholder=\"DS-ACCESS-001\"/>\n          <label>Message<\/label><textarea id=\"dsMsg\"><\/textarea>\n          <label>Patch Hint<\/label><input id=\"dsPatch\"/>\n          <div class=\"right\" style=\"margin-top:10px\"><button id=\"btnDsSave\" class=\"primary\">Add DS<\/button><\/div>\n          <h3 style=\"margin-top:14px\">Weekly RS<\/h3>\n          <label>Week Of<\/label><input id=\"rsWeek\" type=\"date\"/>\n          <label>Steward<\/label><input id=\"rsSteward\"/>\n          <label>Notes<\/label><textarea id=\"rsNotes\"><\/textarea>\n          <div class=\"right\" style=\"margin-top:10px\"><button id=\"btnRsSave\">Save RS<\/button><\/div>\n        <\/div>\n        <div class=\"card\"><h3>DS + RS Log<\/h3><div id=\"dsTable\" class=\"muted\">None.<\/div><\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-artifacts\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Artifacts Export<\/h3>\n          <div class=\"warnbox muted\">Local export only unless Edge Sync is configured.<\/div>\n          <label>Opportunity for export<\/label><select id=\"packOpp\"><\/select>\n          <label>Pack Prefix<\/label><input id=\"packPrefix\" value=\"SEQUOIA\"/>\n          <label>Organization / Program<\/label><input id=\"orgProgram\" value=\"NGA  SEQUOIA\"/>\n          <label>Coherence Steward<\/label><input id=\"cohSteward\"/>\n          <label>Approval / Authority Note<\/label><textarea id=\"authorityNote\"><\/textarea>\n          <div class=\"grid\">\n            <div>\n              <label>Safe Export<\/label>\n              <select id=\"safeExport\"><option value=\"false\">Off<\/option><option value=\"true\">On<\/option><\/select>\n            <\/div>\n            <div>\n              <label>Safe Level<\/label>\n              <select id=\"safeExportLevel\"><option value=\"lite\">Lite<\/option><option value=\"strict\">Strict<\/option><\/select>\n            <\/div>\n          <\/div>\n          <div class=\"flex\" style=\"margin-top:10px\">\n            <button id=\"btnZipPack\" class=\"primary\">Download ZIP Pack<\/button>\n          <\/div>\n\n          <div class=\"card\" style=\"margin-top:12px\">\n            <h3>Edge Sync (DeepSigma Enterprise)<\/h3>\n            <label>Enterprise Intake Endpoint<\/label><input id=\"edgeEndpoint\" placeholder=\"https://host/api/edge/intake\"/>\n            <label>Bearer Token<\/label><input id=\"edgeToken\" type=\"password\"/>\n            <label>Manifest Signing Key (HMAC)<\/label><input id=\"edgeSignKey\" type=\"password\"/>\n            <div class=\"muted\" id=\"edgeOutboxCount\">Outbox: 0 pending<\/div>\n            <div class=\"flex\" style=\"margin-top:10px\">\n              <button id=\"btnSyncPack\" class=\"primary\">Sync ZIP Pack to Enterprise<\/button>\n              <button id=\"btnRetryOutbox\">Retry Outbox<\/button>\n            <\/div>\n            <div id=\"edgeSyncStatus\" class=\"muted\">Status: not synced<\/div>\n            <div class=\"muted\" id=\"edgeAuditCount\" style=\"margin-top:6px\">Receipts: 0<\/div>\n            <div class=\"flex\" style=\"margin-top:8px\">\n              <button id=\"btnDownloadReceipts\">Download Sync Receipts<\/button>\n            <\/div>\n            <pre id=\"edgeAuditPreview\" class=\"mono small\" style=\"white-space:pre-wrap;margin-top:8px;max-height:140px;overflow:auto\"><\/pre>\n          <\/div>\n        <\/div>\n        <div class=\"card\">\n          <h3>Preview<\/h3>\n          <pre id=\"preview\" class=\"mono\" style=\"white-space:pre-wrap\"><\/pre>\n        <\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-test\" class=\"hidden\">\n      <div class=\"card\">\n        <h3>Test Mode<\/h3>\n        <div class=\"muted\">Generate sample opportunity + assumptions + risks + sealed decision, then export/sync in under 60s.<\/div>\n        <div class=\"flex\" style=\"margin-top:10px\">\n          <button id=\"tmRunAll\" class=\"primary\">RUN FULL TEST<\/button>\n          <button id=\"tmDownloadZip\" class=\"primary\">Download ZIP Pack<\/button>\n          <button id=\"tmReset\" class=\"danger\">Reset Data<\/button>\n        <\/div>\n        <pre id=\"tmLog\" class=\"mono\" style=\"white-space:pre-wrap;margin-top:10px\"><\/pre>\n      <\/div>\n    <\/section>\n  <\/div>\n<\/main>\n\n<input id=\"fileImport\" type=\"file\" accept=\"application/json\" class=\"hidden\"/>\n<script>\nconst KEY = \"ds_bidnobid_console_v1\";\nconst EDGE_CFG_KEY = \"ds_bidnobid_edge_cfg_v1\";\nconst EDGE_OUTBOX_KEY = \"ds_bidnobid_edge_outbox_v1\";\nconst EDGE_AUDIT_KEY = \"ds_bidnobid_edge_audit_v1\";\nconst SCORE_CFG = [\n  {id:\"strategic_fit\", name:\"Strategic fit\", weight:15},\n  {id:\"customer_access\", name:\"Customer access / relationship strength\", weight:15},\n  {id:\"capability_fit\", name:\"Capability fit\", weight:15},\n  {id:\"past_perf\", name:\"Past performance match\", weight:10},\n  {id:\"capacity_staffing\", name:\"Capacity / staffing feasibility\", weight:15},\n  {id:\"differentiation\", name:\"Differentiation strength\", weight:10},\n  {id:\"price_margin\", name:\"Price/margin viability\", weight:10},\n  {id:\"risk_complexity\", name:\"Risk level / complexity\", weight:10}\n];\n\nfunction storageAvailable(){\n  try{ const x=\"__ds_test__\"; localStorage.setItem(x,x); localStorage.removeItem(x); return true; }\n  catch(_){ return false; }\n}\nfunction getStoreItem(k){ if(storageAvailable()) return localStorage.getItem(k); window.__ds_memstore ||= {}; return window.__ds_memstore[k] || null; }\nfunction setStoreItem(k,v){ if(storageAvailable()) return localStorage.setItem(k,v); window.__ds_memstore ||= {}; window.__ds_memstore[k]=v; }\nfunction removeStoreItem(k){ if(storageAvailable()) return localStorage.removeItem(k); if(window.__ds_memstore) delete window.__ds_memstore[k]; }\n\nfunction nowIso(){ return new Date().toISOString(); }\nfunction today(){ return new Date().toISOString().slice(0,10); }\nfunction uid(prefix){ return `${prefix}-${Math.random().toString(16).slice(2,8).toUpperCase()}`; }\nfunction v(id){ return (document.getElementById(id)?.value || \"\").trim(); }\nfunction s(id,val){ const el=document.getElementById(id); if(el) el.value = val || \"\"; }\nfunction esc(x){ return String(x || \"\").replace(/[&<>\"']/g, m => ({\"&\":\"&amp;\",\"<\":\"&lt;\",\">\":\"&gt;\",\"\\\"\":\"&quot;\",\"'\":\"&#39;\"}[m])); }\nfunction asStr(x, maxLen=4000){ return String(x ?? \"\").slice(0, maxLen); }\nfunction asDate(x){ const s = asStr(x, 32); return /^\\\\d{4}-\\\\d{2}-\\\\d{2}$/.test(s) ? s : \"\"; }\nfunction asIso(x){ const s = asStr(x, 40); return /^\\\\d{4}-\\\\d{2}-\\\\d{2}T/.test(s) ? s : nowIso(); }\nfunction asBool(x){ return x === true; }\nfunction asEnum(x, allowed, fallback){ return allowed.includes(x) ? x : fallback; }\nfunction asNumRange(x, lo, hi, fallback=0){ const n = Number(x); if(!Number.isFinite(n)) return fallback; return Math.max(lo, Math.min(hi, n)); }\nfunction uniqBy(arr, keyFn){ const seen = new Set(); const out = []; for(const x of arr){ const k = keyFn(x); if(seen.has(k)) continue; seen.add(k); out.push(x); } return out; }\n\nfunction emptyDb(){\n  return { opportunities:[], assumptions:[], risks:[], drift:[], rs:[], meta:{created:nowIso(), version:\"1.0\"} };\n}\nfunction normalizeScores(scores){\n  const out = {};\n  for(const c of SCORE_CFG) out[c.id] = asNumRange(scores?.[c.id], 0, 5, 0);\n  return out;\n}\nfunction normalizeOpportunity(o){\n  const id = asStr(o?.id, 64) || uid(\"OPP\");\n  const scoreScores = normalizeScores(o?.score?.scores || {});\n  const scoreTotal = computeScore(scoreScores);\n  const scoreReco = decisionForScore(scoreTotal);\n  let decision = null;\n  if(o?.decision && typeof o.decision === \"object\"){\n    const sealed = asBool(o.decision.sealed);\n    decision = {\n      value: asEnum(asStr(o.decision.value, 20), [\"Bid\",\"No-Bid\",\"Watch\"], \"Watch\"),\n      approver: asStr(o.decision.approver, 256),\n      authority: asStr(o.decision.authority, 2000),\n      rationale: asStr(o.decision.rationale, 6000),\n      sealed,\n      seal: sealed ? asStr(o.decision.seal, 120) || `${nowIso()}|v1` : null,\n      updated: asIso(o.decision.updated),\n    };\n  }\n  return {\n    id,\n    customer: asStr(o?.customer, 256),\n    office: asStr(o?.office, 256),\n    vehicle: asStr(o?.vehicle, 128),\n    naics: asStr(o?.naics, 64),\n    value_band: asStr(o?.value_band, 64),\n    pop: asStr(o?.pop, 128),\n    dates: {\n      rfi: asDate(o?.dates?.rfi),\n      rfp: asDate(o?.dates?.rfp),\n      q_due: asDate(o?.dates?.q_due),\n      due: asDate(o?.dates?.due),\n      award_est: asDate(o?.dates?.award_est),\n    },\n    competitors: asStr(o?.competitors, 4000),\n    security_needs: asStr(o?.security_needs, 4000),\n    score: {scores: scoreScores, total: scoreTotal, recommendation: scoreReco, updated: asIso(o?.score?.updated)},\n    decision,\n    created: asIso(o?.created),\n    updated: asIso(o?.updated),\n  };\n}\nfunction normalizeAssumption(a){\n  return {\n    id: asStr(a?.id, 64) || uid(\"ASM\"),\n    opp_id: asStr(a?.opp_id, 64),\n    text: asStr(a?.text, 4000),\n    category: asEnum(asStr(a?.category, 32), [\"technical\",\"staffing\",\"pricing\",\"schedule\",\"customer\"], \"technical\"),\n    expiry: asDate(a?.expiry),\n    confidence: asEnum(asStr(a?.confidence, 16), [\"Low\",\"Med\",\"High\"], \"Med\"),\n    disconfirmers: asStr(a?.disconfirmers, 4000),\n    created: asIso(a?.created),\n  };\n}\nfunction normalizeRisk(r){\n  return {\n    id: asStr(r?.id, 64) || uid(\"RISK\"),\n    opp_id: asStr(r?.opp_id, 64),\n    text: asStr(r?.text, 4000),\n    severity: asEnum(asStr(r?.severity, 16), [\"Low\",\"Med\",\"High\"], \"Med\"),\n    mitigation: asStr(r?.mitigation, 4000),\n    owner: asStr(r?.owner, 128),\n    due: asDate(r?.due),\n    tripwire: asStr(r?.tripwire, 400),\n    status: asEnum(asStr(r?.status, 24), [\"Open\",\"Closed\"], \"Open\"),\n    created: asIso(r?.created),\n  };\n}\nfunction normalizeDrift(d){\n  return {\n    time: asIso(d?.time),\n    code: asStr(d?.code, 64) || uid(\"DS\"),\n    msg: asStr(d?.msg, 4000),\n    patch: asStr(d?.patch, 512),\n  };\n}\nfunction normalizeRs(r){\n  return {\n    id: asStr(r?.id, 64) || uid(\"RS\"),\n    week_of: asDate(r?.week_of) || today(),\n    steward: asStr(r?.steward, 128),\n    notes: asStr(r?.notes, 6000),\n    created: asIso(r?.created),\n  };\n}\nfunction normalizeDb(input, strict=false){\n  if(!input || typeof input !== \"object\" || Array.isArray(input)) throw new Error(\"Invalid root object\");\n  const db = {\n    opportunities: Array.isArray(input.opportunities) ? input.opportunities.map(normalizeOpportunity) : [],\n    assumptions: Array.isArray(input.assumptions) ? input.assumptions.map(normalizeAssumption) : [],\n    risks: Array.isArray(input.risks) ? input.risks.map(normalizeRisk) : [],\n    drift: Array.isArray(input.drift) ? input.drift.map(normalizeDrift) : [],\n    rs: Array.isArray(input.rs) ? input.rs.map(normalizeRs) : [],\n    meta: {created: asIso(input.meta?.created), version: \"1.0\"},\n  };\n  db.opportunities = uniqBy(db.opportunities, x=>x.id);\n  const oppIds = new Set(db.opportunities.map(x=>x.id));\n  db.assumptions = db.assumptions.filter(a=>a.opp_id && oppIds.has(a.opp_id));\n  db.risks = db.risks.filter(r=>r.opp_id && oppIds.has(r.opp_id));\n  if(strict && db.opportunities.length===0 && (input.opportunities?.length || input.assumptions?.length || input.risks?.length)){\n    throw new Error(\"Import rejected: no valid opportunities after validation\");\n  }\n  return db;\n}\nfunction load(){\n  const raw = getStoreItem(KEY);\n  if(!raw){ const db = emptyDb(); setStoreItem(KEY, JSON.stringify(db)); return db; }\n  try{\n    const db = normalizeDb(JSON.parse(raw), false);\n    setStoreItem(KEY, JSON.stringify(db));\n    return db;\n  }catch(_){\n    const db = emptyDb();\n    setStoreItem(KEY, JSON.stringify(db));\n    return db;\n  }\n}\nfunction save(db){\n  const clean = normalizeDb(db, false);\n  setStoreItem(KEY, JSON.stringify(clean));\n  refreshAll();\n}\n\nfunction safeFile(sv){ return (sv||\"\").replace(/[^a-z0-9_\\-]+/gi,\"_\").replace(/_+/g,\"_\").replace(/^_+|_+$/g,\"\"); }\nfunction isSafeExport(){ return (document.getElementById(\"safeExport\")?.value || \"false\") === \"true\"; }\nfunction safeLevel(){ return document.getElementById(\"safeExportLevel\")?.value || \"lite\"; }\nfunction redactOpp(o){\n  if(!isSafeExport()) return {...o};\n  const x = {...o};\n  x.customer = \"(masked)\";\n  if(safeLevel()===\"strict\") x.competitors = \"(masked)\";\n  return x;\n}\nfunction packMeta(){\n  return {\n    prefix: v(\"packPrefix\") || \"SEQUOIA\",\n    program: v(\"orgProgram\") || \"NGA  SEQUOIA\",\n    steward: v(\"cohSteward\") || \"(unassigned)\",\n    authority: v(\"authorityNote\") || \"(not specified)\",\n    generated: nowIso(), date: today(), version: \"1.0\",\n    safe_export: isSafeExport(), safe_export_level: safeLevel()\n  };\n}\n\nfunction decisionForScore(score){\n  if(score >= 80) return \"Bid\";\n  if(score >= 65) return \"Watch\";\n  return \"No-Bid\";\n}\nfunction computeScore(scores){\n  let total = 0;\n  SCORE_CFG.forEach(c=>{\n    const raw = Number(scores?.[c.id] || 0);\n    const bounded = Math.max(0, Math.min(5, raw));\n    total += (bounded/5) * c.weight;\n  });\n  return Math.round(total*10)/10;\n}\n\nfunction buildGateInputs(){\n  const root = document.getElementById(\"gateInputs\");\n  if(!root) return;\n  root.innerHTML = SCORE_CFG.map(c=>`\n    <label>${esc(c.name)} (${c.weight}%)<\/label>\n    <input type=\"range\" min=\"0\" max=\"5\" step=\"1\" value=\"0\" id=\"sc_${c.id}\"/>\n    <div class=\"muted\" id=\"sc_${c.id}_v\">0<\/div>\n  `).join(\"\");\n  SCORE_CFG.forEach(c=>{\n    const el = document.getElementById(`sc_${c.id}`);\n    el?.addEventListener(\"input\", ()=>{\n      const vv = document.getElementById(`sc_${c.id}_v`);\n      if(vv) vv.textContent = String(el.value);\n      refreshGatePreview();\n    });\n  });\n}\nfunction gateScoresFromUi(){\n  const x = {};\n  SCORE_CFG.forEach(c=> x[c.id] = Number(document.getElementById(`sc_${c.id}`)?.value || 0));\n  return x;\n}\nfunction setGateScores(scores){\n  SCORE_CFG.forEach(c=>{\n    const n = Number(scores?.[c.id] || 0);\n    const el = document.getElementById(`sc_${c.id}`);\n    const vv = document.getElementById(`sc_${c.id}_v`);\n    if(el) el.value = String(n);\n    if(vv) vv.textContent = String(n);\n  });\n}\nfunction refreshGatePreview(){\n  const score = computeScore(gateScoresFromUi());\n  const reco = decisionForScore(score);\n  const t = document.getElementById(\"gateTotal\");\n  const r = document.getElementById(\"gateReco\");\n  if(t) t.textContent = String(score);\n  if(r){ r.textContent = reco; r.className = reco===\"Bid\" ? \"ok\" : reco===\"Watch\" ? \"warn\" : \"bad\"; }\n}\n\nfunction tabList(){ return [\"dashboard\",\"opps\",\"gate\",\"assumptions\",\"risks\",\"decision\",\"drift\",\"artifacts\",\"test\"]; }\nfunction setTab(tab){\n  tabList().forEach(t=>{\n    const sec = document.getElementById(`tab-${t}`);\n    if(sec) sec.classList.toggle(\"hidden\", t!==tab);\n  });\n  document.querySelectorAll(\".tab\").forEach(b=> b.classList.toggle(\"active\", b.dataset.tab===tab));\n  try{ location.hash = \"#\" + tab; }catch(_){ }\n}\n\nfunction oppOptionsHtml(db){\n  if(!db.opportunities.length) return `<option value=\"\">(no opportunities)<\/option>`;\n  return db.opportunities.map(o=>`<option value=\"${esc(o.id)}\">${esc(o.id)}  ${esc(o.customer)}<\/option>`).join(\"\");\n}\nfunction bindOppSelects(){\n  const db = load();\n  [\"gateOpp\",\"aOpp\",\"rOpp\",\"dOpp\",\"packOpp\"].forEach(id=>{\n    const el = document.getElementById(id);\n    if(el) el.innerHTML = oppOptionsHtml(db);\n  });\n}\n\nfunction saveOpportunity(){\n  const db = load();\n  const id = v(\"oppId\") || uid(\"OPP\");\n  const opp = {\n    id,\n    customer: v(\"oppCustomer\"), office: v(\"oppOffice\"), vehicle: v(\"oppVehicle\"), naics: v(\"oppNaics\"),\n    value_band: v(\"oppValueBand\"), pop: v(\"oppPop\"),\n    dates: { rfi: v(\"oppRfi\"), rfp: v(\"oppRfp\"), q_due: v(\"oppQDue\"), due: v(\"oppDue\"), award_est: v(\"oppAward\") },\n    competitors: v(\"oppComp\"), security_needs: v(\"oppSec\"),\n    score: db.opportunities.find(o=>o.id===id)?.score || {scores:{}, total:0, recommendation:\"No-Bid\"},\n    decision: db.opportunities.find(o=>o.id===id)?.decision || null,\n    created: db.opportunities.find(o=>o.id===id)?.created || nowIso(),\n    updated: nowIso()\n  };\n  const i = db.opportunities.findIndex(x=>x.id===id);\n  if(i>=0) db.opportunities[i]=opp; else db.opportunities.push(opp);\n  save(db);\n  document.getElementById(\"oppHint\").textContent = `Saved ${id}`;\n}\nfunction clearOpportunity(){\n  [\"oppId\",\"oppCustomer\",\"oppOffice\",\"oppVehicle\",\"oppNaics\",\"oppValueBand\",\"oppPop\",\"oppRfi\",\"oppRfp\",\"oppQDue\",\"oppDue\",\"oppAward\",\"oppComp\",\"oppSec\"].forEach(x=>s(x,\"\"));\n}\nfunction editOpportunity(id){\n  const o = load().opportunities.find(x=>x.id===id); if(!o) return;\n  setTab(\"opps\");\n  s(\"oppId\",o.id); s(\"oppCustomer\",o.customer); s(\"oppOffice\",o.office); s(\"oppVehicle\",o.vehicle); s(\"oppNaics\",o.naics);\n  s(\"oppValueBand\",o.value_band); s(\"oppPop\",o.pop); s(\"oppRfi\",o.dates?.rfi); s(\"oppRfp\",o.dates?.rfp); s(\"oppQDue\",o.dates?.q_due);\n  s(\"oppDue\",o.dates?.due); s(\"oppAward\",o.dates?.award_est); s(\"oppComp\",o.competitors); s(\"oppSec\",o.security_needs);\n}\nfunction deleteOpportunity(id){\n  if(!confirm(\"Delete opportunity?\")) return;\n  const db = load();\n  db.opportunities = db.opportunities.filter(o=>o.id!==id);\n  db.assumptions = db.assumptions.filter(a=>a.opp_id!==id);\n  db.risks = db.risks.filter(r=>r.opp_id!==id);\n  save(db);\n}\n\nfunction saveGateScore(){\n  const db = load();\n  const oppId = v(\"gateOpp\"); if(!oppId) return alert(\"Select opportunity\");\n  const o = db.opportunities.find(x=>x.id===oppId); if(!o) return alert(\"Opportunity not found\");\n  const scores = gateScoresFromUi();\n  const total = computeScore(scores);\n  const recommendation = decisionForScore(total);\n  o.score = {scores,total,recommendation,updated:nowIso()};\n  o.updated = nowIso();\n  save(db);\n  document.getElementById(\"gateHint\").textContent = `Saved score for ${oppId}`;\n}\n\nfunction saveAssumption(){\n  const db = load();\n  const x = {\n    id: uid(\"ASM\"), opp_id: v(\"aOpp\"), text: v(\"aText\"), category: v(\"aCat\"), expiry: v(\"aExp\"),\n    confidence: v(\"aConf\"), disconfirmers: v(\"aDis\"), created: nowIso()\n  };\n  if(!x.opp_id || !x.text) return alert(\"Opportunity and assumption are required.\");\n  db.assumptions.push(x); save(db);\n  [\"aText\",\"aDis\",\"aExp\"].forEach(id=>s(id,\"\")); s(\"aConf\",\"Med\");\n}\nfunction saveRisk(){\n  const db = load();\n  const x = {\n    id: uid(\"RISK\"), opp_id: v(\"rOpp\"), text: v(\"rText\"), severity: v(\"rSev\"), mitigation: v(\"rMit\"),\n    owner: v(\"rOwner\"), due: v(\"rDue\"), tripwire: v(\"rTrip\"), status:\"Open\", created: nowIso()\n  };\n  if(!x.opp_id || !x.text) return alert(\"Opportunity and risk are required.\");\n  db.risks.push(x); save(db);\n  [\"rText\",\"rMit\",\"rOwner\",\"rDue\",\"rTrip\"].forEach(id=>s(id,\"\")); s(\"rSev\",\"Med\");\n}\nfunction saveDecision(){\n  const db = load();\n  const oppId = v(\"dOpp\"); if(!oppId) return alert(\"Select opportunity\");\n  const o = db.opportunities.find(x=>x.id===oppId); if(!o) return alert(\"Opportunity not found\");\n  const sealed = v(\"dSeal\")===\"true\";\n  o.decision = {\n    value: v(\"dDecision\"), approver: v(\"dApprover\"), authority: v(\"dAuthority\"), rationale: v(\"dRationale\"),\n    sealed, seal: sealed ? `${nowIso()}|v1` : null, updated: nowIso()\n  };\n  o.updated = nowIso();\n  save(db);\n  document.getElementById(\"dHint\").textContent = `Saved decision for ${oppId}`;\n}\n\nfunction saveDS(){\n  const db = load();\n  const x = {time: nowIso(), code: v(\"dsCode\") || uid(\"DS\"), msg: v(\"dsMsg\"), patch: v(\"dsPatch\")};\n  if(!x.msg) return alert(\"DS message required.\");\n  db.drift.push(x); save(db);\n  s(\"dsCode\",\"\"); s(\"dsMsg\",\"\"); s(\"dsPatch\",\"\");\n}\nfunction saveRS(){\n  const db = load();\n  const x = {id: uid(\"RS\"), week_of: v(\"rsWeek\") || today(), steward: v(\"rsSteward\"), notes: v(\"rsNotes\"), created: nowIso()};\n  db.rs.push(x); save(db);\n  s(\"rsWeek\",\"\"); s(\"rsSteward\",\"\"); s(\"rsNotes\",\"\");\n}\n\nfunction renderOppTable(){\n  const db = load();\n  const el = document.getElementById(\"oppTable\");\n  if(!db.opportunities.length){ el.innerHTML = \"<div class='muted'>No opportunities yet.<\/div>\"; return; }\n  el.innerHTML = `<table><thead><tr><th>ID<\/th><th>Customer<\/th><th>Due<\/th><th>Score<\/th><th>Decision<\/th><th><\/th><\/tr><\/thead><tbody>${\n    db.opportunities.map(o=>`<tr>\n      <td class=\"mono\">${esc(o.id)}<\/td>\n      <td>${esc(o.customer)}<\/td>\n      <td class=\"muted\">${esc(o.dates?.due || \"\")}<\/td>\n      <td>${o.score ? `${o.score.total} (${esc(o.score.recommendation)})` : \"\"}<\/td>\n      <td>${o.decision ? `${esc(o.decision.value)} ${o.decision.sealed ? \"(sealed)\" : \"(open)\"}` : \"\"}<\/td>\n      <td><button data-action=\"edit\" data-id=\"${esc(o.id)}\">Edit<\/button> <button class=\"danger\" data-action=\"del\" data-id=\"${esc(o.id)}\">Delete<\/button><\/td>\n    <\/tr>`).join(\"\")\n  }<\/tbody><\/table>`;\n}\nfunction renderAssumptions(){\n  const db = load();\n  const el = document.getElementById(\"aTable\");\n  if(!db.assumptions.length){ el.innerHTML = \"<div class='muted'>None.<\/div>\"; return; }\n  el.innerHTML = `<table><thead><tr><th>Opp<\/th><th>Assumption<\/th><th>Category<\/th><th>Expiry<\/th><th>Conf<\/th><\/tr><\/thead><tbody>${\n    db.assumptions.slice().reverse().map(a=>`<tr><td class=\"mono\">${esc(a.opp_id)}<\/td><td>${esc(a.text)}<\/td><td>${esc(a.category)}<\/td><td>${esc(a.expiry)}<\/td><td>${esc(a.confidence)}<\/td><\/tr>`).join(\"\")\n  }<\/tbody><\/table>`;\n}\nfunction renderRisks(){\n  const db = load();\n  const el = document.getElementById(\"rTable\");\n  if(!db.risks.length){ el.innerHTML = \"<div class='muted'>None.<\/div>\"; return; }\n  el.innerHTML = `<table><thead><tr><th>Opp<\/th><th>Risk<\/th><th>Sev<\/th><th>Owner<\/th><th>Tripwire<\/th><\/tr><\/thead><tbody>${\n    db.risks.slice().reverse().map(r=>`<tr><td class=\"mono\">${esc(r.opp_id)}<\/td><td>${esc(r.text)}<\/td><td>${esc(r.severity)}<\/td><td>${esc(r.owner)}<\/td><td>${esc(r.tripwire)}<\/td><\/tr>`).join(\"\")\n  }<\/tbody><\/table>`;\n}\nfunction renderDSRS(){\n  const db = load();\n  const el = document.getElementById(\"dsTable\");\n  const parts = [];\n  if(db.drift.length){\n    parts.push(\"<h3>Drift Signals<\/h3>\");\n    parts.push(`<table><thead><tr><th>Time<\/th><th>Code<\/th><th>Message<\/th><th>Patch<\/th><\/tr><\/thead><tbody>${db.drift.slice().reverse().map(d=>`<tr><td class=\\\"muted mono\\\">${esc(d.time)}<\/td><td class=\\\"mono\\\">${esc(d.code)}<\/td><td>${esc(d.msg)}<\/td><td>${esc(d.patch)}<\/td><\/tr>`).join(\"\")}<\/tbody><\/table>`);\n  }\n  if(db.rs.length){\n    parts.push(\"<h3 style='margin-top:12px'>RS Entries<\/h3>\");\n    parts.push(`<table><thead><tr><th>ID<\/th><th>Week<\/th><th>Steward<\/th><th>Notes<\/th><\/tr><\/thead><tbody>${db.rs.slice().reverse().map(r=>`<tr><td class=\\\"mono\\\">${esc(r.id)}<\/td><td>${esc(r.week_of)}<\/td><td>${esc(r.steward)}<\/td><td>${esc(r.notes)}<\/td><\/tr>`).join(\"\")}<\/tbody><\/table>`);\n  }\n  el.innerHTML = parts.length ? parts.join(\"\") : \"<div class='muted'>None.<\/div>\";\n}\nfunction refreshDecisionPreview(){\n  const db = load();\n  const id = v(\"dOpp\");\n  const o = db.opportunities.find(x=>x.id===id);\n  const el = document.getElementById(\"dPreview\");\n  if(!o || !o.decision){ el.textContent = \"No decision yet.\"; return; }\n  el.textContent = JSON.stringify(o.decision, null, 2);\n}\n\nfunction computeDashboard(){\n  const db = load();\n  const open = db.opportunities.length;\n  const pending = db.opportunities.filter(o=>!o.decision || !o.decision.sealed).length;\n  const decided = db.opportunities.filter(o=>o.decision).length;\n  const bid = db.opportunities.filter(o=>o.decision?.value===\"Bid\").length;\n  const nobid = db.opportunities.filter(o=>o.decision?.value===\"No-Bid\").length;\n  const watch = db.opportunities.filter(o=>o.decision?.value===\"Watch\").length;\n  const ttdVals = db.opportunities.filter(o=>o.decision).map(o=>{\n    const a = new Date(o.created || o.updated || nowIso()).getTime();\n    const b = new Date(o.decision.updated || nowIso()).getTime();\n    return Math.max(0, Math.round((b-a)/(1000*60*60*24)));\n  });\n  const avgTtd = ttdVals.length ? (ttdVals.reduce((x,y)=>x+y,0)/ttdVals.length).toFixed(1)+\"d\" : \"\";\n  const bidRate = decided ? Math.round((bid/decided)*100)+\"%\" : \"\";\n  const killRate = decided ? Math.round((nobid/decided)*100)+\"%\" : \"\";\n  const riskOpen = db.risks.filter(r=>r.status!==\"Closed\").length;\n  const autoDs = db.drift.length;\n\n  document.getElementById(\"kOpen\").textContent = String(open);\n  document.getElementById(\"kPending\").textContent = String(pending);\n  document.getElementById(\"kBidRate\").textContent = bidRate;\n  document.getElementById(\"kKillRate\").textContent = killRate;\n  document.getElementById(\"kTTD\").textContent = avgTtd;\n  document.getElementById(\"kRiskOpen\").textContent = String(riskOpen);\n  document.getElementById(\"kWatch\").textContent = String(watch);\n  document.getElementById(\"kDs\").textContent = String(autoDs);\n\n  const top = db.risks.slice().reverse().slice(0,5);\n  document.getElementById(\"dashTopRisks\").innerHTML = top.length\n    ? top.map(r=>`<div><span class=\"pill\">${esc(r.severity)}<\/span> ${esc(r.text)} <span class=\"muted\">(${esc(r.opp_id)})<\/span><\/div>`).join(\"\")\n    : \"No risks yet.\";\n}\n\n// ZIP + HASH\nfunction crc32(buf){\n  let c = 0 ^ (-1);\n  for(let i=0;i<buf.length;i++) c = (c>>>8) ^ CRC_TABLE[(c ^ buf[i]) & 0xFF];\n  return (c ^ (-1)) >>> 0;\n}\nconst CRC_TABLE = (()=>{ const t=new Uint32Array(256); for(let i=0;i<256;i++){ let c=i; for(let k=0;k<8;k++) c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1); t[i]=c>>>0; } return t; })();\nfunction u16(n){ return [n & 0xFF, (n>>>8)&0xFF]; }\nfunction u32(n){ return [n & 0xFF, (n>>>8)&0xFF, (n>>>16)&0xFF, (n>>>24)&0xFF]; }\nfunction strToUtf8Bytes(s){ return new TextEncoder().encode(s); }\nfunction buildZip(entries){\n  const fileParts=[]; const central=[]; let offset=0;\n  for(const e of entries){\n    const nameBytes=strToUtf8Bytes(e.name), data=e.bytes, crc=crc32(data), size=data.length;\n    const dt=e.mtime||new Date();\n    const dosTime=((dt.getHours()&0x1F)<<11)|((dt.getMinutes()&0x3F)<<5)|((Math.floor(dt.getSeconds()/2))&0x1F);\n    const dosDate=(((dt.getFullYear()-1980)&0x7F)<<9)|(((dt.getMonth()+1)&0x0F)<<5)|(dt.getDate()&0x1F);\n    const local=[...u32(0x04034b50),...u16(20),...u16(0),...u16(0),...u16(dosTime),...u16(dosDate),...u32(crc),...u32(size),...u32(size),...u16(nameBytes.length),...u16(0)];\n    fileParts.push(new Uint8Array(local), nameBytes, data);\n    const c=[...u32(0x02014b50),...u16(0x0314),...u16(20),...u16(0),...u16(0),...u16(dosTime),...u16(dosDate),...u32(crc),...u32(size),...u32(size),...u16(nameBytes.length),...u16(0),...u16(0),...u16(0),...u16(0),...u32(0),...u32(offset)];\n    central.push(new Uint8Array(c), nameBytes);\n    offset += local.length + nameBytes.length + size;\n  }\n  const centralStart=offset;\n  for(const p of central){ fileParts.push(p); offset += p.length; }\n  const centralSize=offset-centralStart;\n  const eocd=[...u32(0x06054b50),...u16(0),...u16(0),...u16(entries.length),...u16(entries.length),...u32(centralSize),...u32(centralStart),...u16(0)];\n  fileParts.push(new Uint8Array(eocd));\n  return new Blob(fileParts,{type:\"application/zip\"});\n}\nasync function sha256Hex(bytes){\n  const b = bytes.buffer ? bytes.buffer : bytes;\n  const out = await crypto.subtle.digest(\"SHA-256\", b);\n  return Array.from(new Uint8Array(out)).map(x=>x.toString(16).padStart(2,\"0\")).join(\"\");\n}\n\nfunction buildOpportunityGraph(meta, opp, assumptions, risks){\n  const nodes=[{type:\"opportunity\", id:opp.id, customer:opp.customer, vehicle:opp.vehicle}];\n  const edges=[];\n  assumptions.forEach(a=>{ nodes.push({type:\"assumption\", id:a.id, expiry:a.expiry, confidence:a.confidence}); edges.push({type:\"HAS_ASSUMPTION\", from:opp.id, to:a.id}); });\n  risks.forEach(r=>{ nodes.push({type:\"risk\", id:r.id, severity:r.severity, owner:r.owner}); edges.push({type:\"HAS_RISK\", from:opp.id, to:r.id}); });\n  if(opp.decision){\n    const did = `${opp.id}-DECISION`;\n    nodes.push({type:\"decision\", id:did, value:opp.decision.value, sealed:opp.decision.sealed});\n    edges.push({type:\"HAS_DECISION\", from:opp.id, to:did});\n  }\n  return {meta, nodes, edges};\n}\nfunction dlrMarkdown(meta, opp){\n  const d = opp.decision || {};\n  return `# DLR  Bid/No-Bid (${opp.id})\\n**Program:** ${meta.program}  \\n**Generated:** ${meta.generated}  \\n\\n## Opportunity\\n- ID: ${opp.id}\\n- Customer: ${opp.customer}\\n- Vehicle: ${opp.vehicle}\\n- Value Band: ${opp.value_band}\\n\\n## Gate 0 Score\\n- Total: ${opp.score?.total ?? \"\"} / 100\\n- Recommendation: ${opp.score?.recommendation ?? \"\"}\\n\\n## Decision\\n- Value: ${d.value || \"(unset)\"}\\n- Approver: ${d.approver || \"(unset)\"}\\n- Authority: ${d.authority || \"(unset)\"}\\n- Seal: ${d.sealed ? d.seal : \"(open)\"}\\n\\n## Rationale\\n${d.rationale || \"(none)\"}\\n`;\n}\nfunction dsMarkdown(db, oppId){\n  const list = db.drift.slice().reverse().map(d=>`- **${d.code}** (${d.time})  ${d.msg}\\n  - Patch: ${d.patch}`).join(\"\\n\") || \"- None\";\n  return `# DS Capture  ${today()}\\n\\n## Opportunity\\n- ${oppId || \"(all)\"}\\n\\n## Drift\\n${list}\\n`;\n}\nfunction rsMarkdown(db){\n  const list = db.rs.slice().reverse().map(r=>`- ${r.id} | week ${r.week_of} | ${r.steward}\\n  - ${r.notes}`).join(\"\\n\") || \"- None\";\n  return `# RS Capture Weekly  ${today()}\\n\\n${list}\\n`;\n}\n\nasync function createZipPackPayload(){\n  const db = load();\n  const meta = packMeta();\n  const oppId = v(\"packOpp\");\n  const opp = db.opportunities.find(x=>x.id===oppId) || db.opportunities[0];\n  if(!opp) throw new Error(\"No opportunities available for export.\");\n\n  const oppx = redactOpp(opp);\n  const assumptions = db.assumptions.filter(a=>a.opp_id===opp.id);\n  const risks = db.risks.filter(r=>r.opp_id===opp.id);\n  const mg = buildOpportunityGraph(meta, oppx, assumptions, risks);\n  const dlr = dlrMarkdown(meta, oppx);\n  const ds = dsMarkdown(db, opp.id);\n  const rs = rsMarkdown(db);\n\n  const root = `${safeFile(meta.prefix)}_BidNoBidPack_${safeFile(opp.id)}_${meta.date}`;\n  const entries = []; const ts = new Date();\n  const addText = (path, text)=>{ const bytes=strToUtf8Bytes(text); entries.push({name:`${root}/${path}`, bytes, mtime:ts}); return bytes; };\n  const addJson = (path, obj)=>{ const text=JSON.stringify(obj,null,2); const bytes=strToUtf8Bytes(text); entries.push({name:`${root}/${path}`, bytes, mtime:ts}); return bytes; };\n\n  addJson(`mg/${safeFile(meta.prefix)}_MG_OpportunityGraph_${safeFile(opp.id)}_${meta.date}.json`, mg);\n  addText(`dlr/${safeFile(meta.prefix)}_DLR_BIDNOBID_${safeFile(opp.id)}_${meta.date}.md`, dlr);\n  addJson(`assumptions/${safeFile(meta.prefix)}_ASSUMPTIONS_${safeFile(opp.id)}_${meta.date}.json`, assumptions);\n  addJson(`risks/${safeFile(meta.prefix)}_RISKS_${safeFile(opp.id)}_${meta.date}.json`, risks);\n  addText(`ds/${safeFile(meta.prefix)}_DS_CAPTURE_${meta.date}.md`, ds);\n  addText(`rs/${safeFile(meta.prefix)}_RS_CAPTURE_WEEKLY_${meta.date}.md`, rs);\n\n  const manifest = {\n    schema: \"deepsigma_ingest_manifest_v1\",\n    meta,\n    opportunity_id: opp.id,\n    counts: {\n      opportunities: db.opportunities.length,\n      assumptions: assumptions.length,\n      risks: risks.length,\n      drift: db.drift.length,\n      rs_sessions: db.rs.length\n    },\n    hashes_file: \"hashes.json\"\n  };\n  const hashes = {};\n  for(const e of entries) hashes[e.name] = await sha256Hex(e.bytes);\n  const packHashMaterial = strToUtf8Bytes(Object.entries(hashes).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>`${k} ${v}`).join(\"\\n\"));\n  const pack_hash = await sha256Hex(packHashMaterial);\n  manifest.pack_hash = pack_hash;\n\n  addJson(\"ingest_manifest.json\", manifest);\n  addJson(\"hashes.json\", {pack_hash, hashes});\n  addText(\"README.md\", `# ${meta.prefix} Bid/No-Bid Pack\\nProgram: ${meta.program}\\nGenerated: ${meta.generated}\\nSafe export: ${meta.safe_export} (${meta.safe_export_level})\\n`);\n\n  const zipBlob = buildZip(entries);\n  return {root, manifest, hashes, zipBlob};\n}\nasync function downloadZipPack(){\n  const {root, manifest, zipBlob} = await createZipPackPayload();\n  document.getElementById(\"preview\").textContent = JSON.stringify(manifest, null, 2);\n  const a = document.createElement(\"a\");\n  a.href = URL.createObjectURL(zipBlob);\n  a.download = `${root}.zip`;\n  a.click();\n}\n\nfunction edgeCfgDefault(){ return {endpoint:\"\", token:\"\", sign_key:\"\"}; }\nfunction loadEdgeCfg(){ try{ return {...edgeCfgDefault(), ...(JSON.parse(getStoreItem(EDGE_CFG_KEY) || \"{}\"))}; }catch(_){ return edgeCfgDefault(); } }\nfunction saveEdgeCfg(){ setStoreItem(EDGE_CFG_KEY, JSON.stringify({endpoint:v(\"edgeEndpoint\"), token:v(\"edgeToken\"), sign_key:v(\"edgeSignKey\")})); }\nfunction loadOutbox(){ try{ const x = JSON.parse(getStoreItem(EDGE_OUTBOX_KEY) || \"[]\"); return Array.isArray(x)?x:[]; }catch(_){ return []; } }\nfunction saveOutbox(xs){ setStoreItem(EDGE_OUTBOX_KEY, JSON.stringify(xs)); updateOutboxBadge(); }\nfunction updateOutboxBadge(){ const el=document.getElementById(\"edgeOutboxCount\"); if(el) el.textContent = `Outbox: ${loadOutbox().length} pending`; }\nfunction syncStatus(msg, ok){ const el=document.getElementById(\"edgeSyncStatus\"); if(!el) return; el.textContent=`Status: ${msg}`; el.style.color = ok===true?\"var(--ok)\":ok===false?\"var(--bad)\":\"var(--muted)\"; }\nfunction loadAudit(){ try{ const x = JSON.parse(getStoreItem(EDGE_AUDIT_KEY) || \"[]\"); return Array.isArray(x) ? x : []; }catch(_){ return []; } }\nfunction saveAudit(xs){ setStoreItem(EDGE_AUDIT_KEY, JSON.stringify(xs)); updateAuditUI(); }\nfunction addAudit(entry){\n  const q = loadAudit();\n  q.push(entry);\n  while(q.length > 200) q.shift();\n  saveAudit(q);\n}\nfunction updateAuditUI(){\n  const logs = loadAudit();\n  const cnt = document.getElementById(\"edgeAuditCount\");\n  const pv = document.getElementById(\"edgeAuditPreview\");\n  if(cnt) cnt.textContent = `Receipts: ${logs.length}`;\n  if(pv){\n    const last = logs.slice(-5).reverse();\n    pv.textContent = last.length ? last.map(x =>\n      `[${x.at}] ${x.action} ${x.result} ${x.status_code ?? \"-\"} req=${x.request_id} root=${x.root || \"-\"}`\n    ).join(\"\\n\") : \"No sync receipts yet.\";\n  }\n}\nfunction downloadReceipts(){\n  const blob = new Blob([JSON.stringify({schema:\"deepsigma_sync_receipts_v1\", generated_at: nowIso(), receipts: loadAudit()}, null, 2)], {type:\"application/json\"});\n  const a = document.createElement(\"a\");\n  a.href = URL.createObjectURL(blob);\n  a.download = `deepsigma_sync_receipts_${today()}.json`;\n  a.click();\n}\nfunction stableStringify(vv){ if(vv===null||typeof vv!==\"object\") return JSON.stringify(vv); if(Array.isArray(vv)) return `[${vv.map(stableStringify).join(\",\")}]`; const ks=Object.keys(vv).sort(); return `{${ks.map(k=>`${JSON.stringify(k)}:${stableStringify(vv[k])}`).join(\",\")}}`; }\nfunction b64FromBytes(bytes){ let s=\"\"; const arr = bytes instanceof Uint8Array ? bytes : new Uint8Array(bytes); for(let i=0;i<arr.length;i++) s += String.fromCharCode(arr[i]); return btoa(s); }\nasync function signManifest(manifest, signKey){\n  if(!signKey) return null;\n  const key = await crypto.subtle.importKey(\"raw\", strToUtf8Bytes(signKey), {name:\"HMAC\", hash:\"SHA-256\"}, false, [\"sign\"]);\n  const sig = await crypto.subtle.sign(\"HMAC\", key, strToUtf8Bytes(stableStringify(manifest)));\n  return b64FromBytes(new Uint8Array(sig));\n}\nasync function postPackToEnterprise(pack, cfg){\n  const zipBytes = new Uint8Array(await pack.zipBlob.arrayBuffer());\n  const signature = await signManifest(pack.manifest, cfg.sign_key || \"\");\n  const requestId = `REQ-${Math.random().toString(16).slice(2,10).toUpperCase()}`;\n  const payload = {\n    schema: \"deepsigma_edge_sync_v1\",\n    sent_at: nowIso(),\n    client: {app:\"NGA_SEQUOIA_BIDNOBID_UI\", version:\"0.03\"},\n    request_id: requestId,\n    root: pack.root,\n    manifest: pack.manifest,\n    hashes: pack.hashes,\n    zip_b64: b64FromBytes(zipBytes),\n    signature: signature ? {alg:\"HMAC-SHA256\", value_b64: signature} : null\n  };\n  const headers = {\"Content-Type\":\"application/json\"};\n  if(cfg.token) headers[\"Authorization\"] = `Bearer ${cfg.token}`;\n  if(signature) headers[\"X-DeepSigma-Signature\"] = signature;\n  const res = await fetch(cfg.endpoint, {method:\"POST\", headers, body:JSON.stringify(payload)});\n  const txt = await res.text().catch(()=>\"\");\n  return {ok: res.ok, status: res.status, response_text: txt.slice(0, 500), signature_used: !!signature, request_id: requestId};\n}\nasync function syncPackNow(){\n  saveEdgeCfg();\n  const cfg = loadEdgeCfg();\n  if(!cfg.endpoint) return alert(\"Set Enterprise Intake Endpoint first.\");\n  syncStatus(\"syncing...\", null);\n  try{\n    const pack = await createZipPackPayload();\n    const resp = await postPackToEnterprise(pack, cfg);\n    if(resp.ok){\n      addAudit({\n        at: nowIso(), action:\"sync\", result:\"success\", status_code: resp.status, request_id: resp.request_id,\n        endpoint: cfg.endpoint, root: pack.root, manifest_hash: pack.manifest.pack_hash, signature_used: resp.signature_used\n      });\n      syncStatus(`synced ${pack.root} (HTTP ${resp.status})`, true);\n      return;\n    }\n    const signature = await signManifest(pack.manifest, cfg.sign_key || \"\");\n    const q = loadOutbox();\n    q.push({queued_at:nowIso(), endpoint:cfg.endpoint, root:pack.root, manifest:pack.manifest, hashes:pack.hashes, zip_b64:b64FromBytes(new Uint8Array(await pack.zipBlob.arrayBuffer())), signature});\n    saveOutbox(q);\n    addAudit({\n      at: nowIso(), action:\"sync\", result:\"queued\", status_code: resp.status, request_id: resp.request_id,\n      endpoint: cfg.endpoint, root: pack.root, manifest_hash: pack.manifest.pack_hash, signature_used: !!signature, error: resp.response_text || `HTTP ${resp.status}`\n    });\n    syncStatus(`queued (HTTP ${resp.status})`, false);\n  }catch(err){\n    const pack = await createZipPackPayload();\n    const signature = await signManifest(pack.manifest, cfg.sign_key || \"\");\n    const q = loadOutbox();\n    q.push({queued_at:nowIso(), endpoint:cfg.endpoint, root:pack.root, manifest:pack.manifest, hashes:pack.hashes, zip_b64:b64FromBytes(new Uint8Array(await pack.zipBlob.arrayBuffer())), signature});\n    saveOutbox(q);\n    addAudit({\n      at: nowIso(), action:\"sync\", result:\"queued\", status_code: null, request_id: `REQ-LOCAL-${Math.random().toString(16).slice(2,8).toUpperCase()}`,\n      endpoint: cfg.endpoint, root: pack.root, manifest_hash: pack.manifest.pack_hash, signature_used: !!signature, error: err.message || \"network/unknown error\"\n    });\n    syncStatus(`queued (${err.message || \"sync failed\"})`, false);\n  }\n}\nasync function retryOutbox(){\n  saveEdgeCfg();\n  const cfg = loadEdgeCfg();\n  let q = loadOutbox();\n  if(!q.length) return syncStatus(\"outbox empty\", true);\n  if(!cfg.endpoint) return alert(\"Set Enterprise Intake Endpoint first.\");\n  let ok=0; const keep=[];\n  for(const item of q){\n    try{\n      const requestId = `REQ-${Math.random().toString(16).slice(2,10).toUpperCase()}`;\n      const payload = {schema:\"deepsigma_edge_sync_v1\", sent_at:nowIso(), client:{app:\"NGA_SEQUOIA_BIDNOBID_UI\",version:\"0.03\"}, request_id:requestId, root:item.root, manifest:item.manifest, hashes:item.hashes, zip_b64:item.zip_b64, signature:item.signature?{alg:\"HMAC-SHA256\",value_b64:item.signature}:null};\n      const headers={\"Content-Type\":\"application/json\"};\n      if(cfg.token) headers[\"Authorization\"]=`Bearer ${cfg.token}`;\n      if(item.signature) headers[\"X-DeepSigma-Signature\"]=item.signature;\n      const res = await fetch(item.endpoint || cfg.endpoint, {method:\"POST\", headers, body:JSON.stringify(payload)});\n      const txt = await res.text().catch(()=> \"\");\n      if(!res.ok){\n        keep.push(item);\n        addAudit({\n          at: nowIso(), action:\"retry\", result:\"failed\", status_code: res.status, request_id: requestId,\n          endpoint: item.endpoint || cfg.endpoint, root: item.root, manifest_hash: item.manifest?.pack_hash || null,\n          signature_used: !!item.signature, error: txt.slice(0, 300) || `HTTP ${res.status}`\n        });\n        continue;\n      }\n      ok += 1;\n      addAudit({\n        at: nowIso(), action:\"retry\", result:\"success\", status_code: res.status, request_id: requestId,\n        endpoint: item.endpoint || cfg.endpoint, root: item.root, manifest_hash: item.manifest?.pack_hash || null,\n        signature_used: !!item.signature\n      });\n    }catch(err){\n      keep.push(item);\n      addAudit({\n        at: nowIso(), action:\"retry\", result:\"failed\", status_code: null, request_id: `REQ-LOCAL-${Math.random().toString(16).slice(2,8).toUpperCase()}`,\n        endpoint: item.endpoint || cfg.endpoint, root: item.root, manifest_hash: item.manifest?.pack_hash || null,\n        signature_used: !!item.signature, error: err.message || \"network/unknown error\"\n      });\n    }\n  }\n  saveOutbox(keep);\n  syncStatus(`outbox sent=${ok}, pending=${keep.length}`, keep.length===0);\n}\n\nfunction tmLog(msg){ const el=document.getElementById(\"tmLog\"); if(!el) return; el.textContent += `[${nowIso()}] ${msg}\\n`; el.scrollTop = el.scrollHeight; }\nfunction tmResetAll(){ if(!confirm(\"Reset ALL local data?\")) return; removeStoreItem(KEY); load(); refreshAll(); document.getElementById(\"tmLog\").textContent=\"\"; tmLog(\"Reset complete.\"); }\nfunction tmRunAll(){\n  const db = load();\n  const id = uid(\"OPP\");\n  db.opportunities.push({\n    id, customer:\"Sample Agency\", office:\"Sample Office\", vehicle:\"IDIQ\", naics:\"541715\", value_band:\"$50M-$100M\", pop:\"CONUS\",\n    dates:{rfi:today(), rfp:today(), q_due:today(), due:today(), award_est:today()}, competitors:\"Incumbent: ExampleCo\", security_needs:\"CUI\",\n    score:{scores:{strategic_fit:4,customer_access:3,capability_fit:4,past_perf:4,capacity_staffing:3,differentiation:3,price_margin:3,risk_complexity:2}, total:0, recommendation:\"Watch\"},\n    decision:null, created:nowIso(), updated:nowIso()\n  });\n  const o = db.opportunities[db.opportunities.length-1];\n  o.score.total = computeScore(o.score.scores);\n  o.score.recommendation = decisionForScore(o.score.total);\n  db.assumptions.push({id:uid(\"ASM\"), opp_id:id, text:\"Pricing data will hold through amendment 1\", category:\"pricing\", expiry:today(), confidence:\"Med\", disconfirmers:\"Gov updates IGCE\", created:nowIso()});\n  db.risks.push({id:uid(\"RISK\"), opp_id:id, text:\"Access risk to customer tech lead\", severity:\"High\", mitigation:\"Exec intro\", owner:\"Capture Lead\", due:today(), tripwire:\"No meeting by +7 days\", status:\"Open\", created:nowIso()});\n  db.drift.push({time:nowIso(), code:\"DS-ACCESS-001\", msg:\"Customer access lag\", patch:\"Escalate sponsor\"});\n  db.rs.push({id:uid(\"RS\"), week_of:today(), steward:\"Coherence Steward\", notes:\"Tighten gate on access evidence\", created:nowIso()});\n  o.decision = {value:o.score.recommendation, approver:\"Test Approver\", authority:\"Capture Authority\", rationale:\"Auto test decision\", sealed:true, seal:`${nowIso()}|v1`, updated:nowIso()};\n  o.updated = nowIso();\n  save(db);\n  s(\"packOpp\", id);\n  tmLog(`Generated sample opportunity ${id}`);\n  tmLog(`Score=${o.score.total}, Recommendation=${o.score.recommendation}, Sealed decision created.`);\n}\n\nfunction refreshAll(){\n  bindOppSelects();\n  renderOppTable();\n  renderAssumptions();\n  renderRisks();\n  renderDSRS();\n  computeDashboard();\n  refreshGatePreview();\n  refreshDecisionPreview();\n}\n\nfunction bindEvents(){\n  document.querySelectorAll(\".tab\").forEach(b=> b.addEventListener(\"click\", ()=>setTab(b.dataset.tab)));\n  document.getElementById(\"btnOppSave\")?.addEventListener(\"click\", saveOpportunity);\n  document.getElementById(\"btnOppClear\")?.addEventListener(\"click\", clearOpportunity);\n  document.getElementById(\"oppTable\")?.addEventListener(\"click\", (e)=>{\n    const b=e.target.closest(\"button\"); if(!b) return;\n    if(b.dataset.action===\"edit\") editOpportunity(b.dataset.id);\n    if(b.dataset.action===\"del\") deleteOpportunity(b.dataset.id);\n  });\n\n  document.getElementById(\"gateOpp\")?.addEventListener(\"change\", ()=>{\n    const db=load(); const o=db.opportunities.find(x=>x.id===v(\"gateOpp\"));\n    setGateScores(o?.score?.scores || {});\n    refreshGatePreview();\n  });\n  document.getElementById(\"btnGateSave\")?.addEventListener(\"click\", saveGateScore);\n\n  document.getElementById(\"btnASave\")?.addEventListener(\"click\", saveAssumption);\n  document.getElementById(\"btnRSave\")?.addEventListener(\"click\", saveRisk);\n  document.getElementById(\"btnDsSave\")?.addEventListener(\"click\", saveDS);\n  document.getElementById(\"btnRsSave\")?.addEventListener(\"click\", saveRS);\n\n  document.getElementById(\"dOpp\")?.addEventListener(\"change\", ()=>{\n    const db=load(); const o=db.opportunities.find(x=>x.id===v(\"dOpp\"));\n    if(o?.decision){ s(\"dDecision\",o.decision.value); s(\"dApprover\",o.decision.approver); s(\"dAuthority\",o.decision.authority); s(\"dRationale\",o.decision.rationale); s(\"dSeal\",o.decision.sealed?\"true\":\"false\"); }\n    else { s(\"dDecision\",\"Watch\"); s(\"dApprover\",\"\"); s(\"dAuthority\",\"\"); s(\"dRationale\",\"\"); s(\"dSeal\",\"false\"); }\n    refreshDecisionPreview();\n  });\n  document.getElementById(\"btnDSave\")?.addEventListener(\"click\", saveDecision);\n\n  document.getElementById(\"btnZipPack\")?.addEventListener(\"click\", downloadZipPack);\n  document.getElementById(\"btnSyncPack\")?.addEventListener(\"click\", syncPackNow);\n  document.getElementById(\"btnRetryOutbox\")?.addEventListener(\"click\", retryOutbox);\n  document.getElementById(\"btnDownloadReceipts\")?.addEventListener(\"click\", downloadReceipts);\n  document.getElementById(\"edgeEndpoint\")?.addEventListener(\"change\", saveEdgeCfg);\n  document.getElementById(\"edgeToken\")?.addEventListener(\"change\", saveEdgeCfg);\n  document.getElementById(\"edgeSignKey\")?.addEventListener(\"change\", saveEdgeCfg);\n\n  document.getElementById(\"btnExport\")?.addEventListener(\"click\", ()=>{\n    const blob = new Blob([JSON.stringify(load(),null,2)], {type:\"application/json\"});\n    const a = document.createElement(\"a\"); a.href = URL.createObjectURL(blob); a.download = `bidnobid_console_${today()}.json`; a.click();\n  });\n  document.getElementById(\"btnImport\")?.addEventListener(\"click\", ()=>document.getElementById(\"fileImport\")?.click());\n  document.getElementById(\"fileImport\")?.addEventListener(\"change\", (e)=>{\n    const file = e.target.files?.[0]; if(!file) return;\n    const reader = new FileReader();\n    reader.onload = ()=>{\n      try{\n        const parsed = JSON.parse(reader.result);\n        const db = normalizeDb(parsed, true);\n        setStoreItem(KEY, JSON.stringify(db));\n        refreshAll();\n        alert(\"Imported.\");\n      }catch(err){\n        alert(`Invalid JSON/schema: ${err.message || \"Import rejected.\"}`);\n      }\n    };\n    reader.readAsText(file);\n  });\n  document.getElementById(\"btnReset\")?.addEventListener(\"click\", tmResetAll);\n\n  document.getElementById(\"tmRunAll\")?.addEventListener(\"click\", tmRunAll);\n  document.getElementById(\"tmDownloadZip\")?.addEventListener(\"click\", downloadZipPack);\n  document.getElementById(\"tmReset\")?.addEventListener(\"click\", tmResetAll);\n}\n\n(function init(){\n  load();\n  buildGateInputs();\n  const cfg = loadEdgeCfg();\n  s(\"edgeEndpoint\", cfg.endpoint || \"\");\n  s(\"edgeToken\", cfg.token || \"\");\n  s(\"edgeSignKey\", cfg.sign_key || \"\");\n  updateOutboxBadge();\n  updateAuditUI();\n  bindEvents();\n  refreshAll();\n  const h = (location.hash||\"\").replace(\"#\",\"\").trim();\n  if(tabList().includes(h)) setTab(h); else setTab(\"dashboard\");\n})();\n<\/script>\n<\/body>\n<\/html>\n"},
    "compliance": {title: "Compliance Matrix v001", desc: "Requirements traceability and gaps", html: "<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\"/>\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/>\n  <title>Deep Sigma  Compliance Matrix Console v001<\/title>\n  <style>\n    :root { --bg:#0b0f14; --card:#111824; --muted:#8aa0b5; --txt:#e7eef7; --accent:#7df9ff; --warn:#ffcc66; --bad:#ff6b6b; --ok:#5dff93; }\n    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--txt)}\n    header{padding:16px 18px;border-bottom:1px solid #1b2a3a;display:flex;gap:12px;align-items:center;justify-content:space-between}\n    .brand{display:flex;flex-direction:column;gap:2px}\n    .brand b{letter-spacing:.5px}\n    .brand small{color:var(--muted)}\n    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}\n    button{background:#182235;color:var(--txt);border:1px solid #243449;border-radius:10px;padding:10px 12px;cursor:pointer}\n    button:hover{border-color:#2f4765}\n    button.primary{border-color:rgba(125,249,255,.45);box-shadow:0 0 0 1px rgba(125,249,255,.12) inset}\n    button.danger{border-color:rgba(255,107,107,.45)}\n    main{display:grid;grid-template-columns:300px 1fr;min-height:calc(100vh - 66px)}\n    nav{border-right:1px solid #1b2a3a;padding:14px}\n    .tab{display:block;width:100%;text-align:left;padding:10px 12px;border-radius:10px;border:1px solid transparent;background:transparent;color:var(--txt);margin-bottom:8px}\n    .tab.active{background:#101a28;border-color:#243449}\n    .wrap{padding:14px 16px;max-width:1300px}\n    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}\n    .card{background:var(--card);border:1px solid #1b2a3a;border-radius:14px;padding:12px}\n    .card h3{margin:0 0 10px 0;font-size:14px;color:#cfe2f7;letter-spacing:.3px}\n    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}\n    input,textarea,select{width:100%;box-sizing:border-box;background:#0d1520;color:var(--txt);border:1px solid #243449;border-radius:10px;padding:10px 10px;font-size:13px}\n    textarea{min-height:90px;resize:vertical}\n    table{width:100%;border-collapse:collapse;font-size:13px}\n    th,td{padding:10px;border-bottom:1px solid #1b2a3a;vertical-align:top}\n    th{color:#b9d3ea;text-align:left;font-weight:600}\n    .muted{color:var(--muted);font-size:12px}\n    .small{font-size:12px}\n    .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}\n    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #243449;color:var(--muted);font-size:12px;margin-right:6px}\n    .hidden{display:none}\n    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}\n    .flex{display:flex;gap:10px;flex-wrap:wrap}\n    .right{display:flex;gap:10px;justify-content:flex-end;align-items:center}\n    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}\n    .warnbox{border:1px solid rgba(255,204,102,.35);background:rgba(255,204,102,.06);border-radius:12px;padding:10px}\n  <\/style>\n<\/head>\n<body>\n<header>\n  <div class=\"brand\">\n    <b>Deep Sigma  Compliance Matrix Console v001<\/b>\n    <small>RFP Intake  Requirements  Mapping  Deliverables  Gaps/DS  Export Pack<\/small>\n  <\/div>\n  <div class=\"row\">\n    <button id=\"btnExport\" class=\"primary\">Export JSON<\/button>\n    <button id=\"btnImport\">Import JSON<\/button>\n    <button id=\"btnReset\" class=\"danger\">Reset<\/button>\n  <\/div>\n<\/header>\n<main>\n  <nav>\n    <button class=\"tab active\" data-tab=\"dashboard\">Dashboard<\/button>\n    <button class=\"tab\" data-tab=\"intake\">RFP Intake<\/button>\n    <button class=\"tab\" data-tab=\"requirements\">Requirements<\/button>\n    <button class=\"tab\" data-tab=\"mapping\">Compliance Mapping<\/button>\n    <button class=\"tab\" data-tab=\"deliverables\">Deliverables Registry<\/button>\n    <button class=\"tab\" data-tab=\"gaps\">Gaps + Q&A Queue<\/button>\n    <button class=\"tab\" data-tab=\"artifacts\">Artifacts Export<\/button>\n    <button class=\"tab\" data-tab=\"test\">Test Mode<\/button>\n    <div class=\"muted\" style=\"margin-top:14px\">Data stored in <span class=\"mono\">localStorage<\/span>. Offline-first.<\/div>\n  <\/nav>\n\n  <div class=\"wrap\">\n    <section id=\"tab-dashboard\">\n      <div class=\"kpi\">\n        <div class=\"card\"><div class=\"muted\">Total Requirements<\/div><b id=\"kReq\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Coverage %<\/div><b id=\"kCov\">0%<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Unassigned<\/div><b id=\"kUnassigned\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Open Gaps<\/div><b id=\"kGaps\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Due Soon<\/div><b id=\"kDueSoon\">0<\/b><\/div>\n      <\/div>\n      <div class=\"kpi\" style=\"margin-top:10px\">\n        <div class=\"card\"><div class=\"muted\">Change Churn (24h)<\/div><b id=\"kChurn\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Auto DS Alerts<\/div><b id=\"kDs\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Baseline Seal<\/div><b id=\"kSeal\">Open<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Decisions Pending<\/div><b id=\"kPending\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Coverage Gap to 90%<\/div><b id=\"kGap90\">0%<\/b><\/div>\n      <\/div>\n      <div class=\"grid\" style=\"margin-top:12px\">\n        <div class=\"card\"><h3>Top DS Alerts<\/h3><div id=\"dashDs\" class=\"muted\">No DS alerts.<\/div><\/div>\n        <div class=\"card\"><h3>Thresholds<\/h3><ul class=\"muted\"><li>Coverage target by T-3 days: 90%<\/li><li>Unassigned reqs: 0<\/li><li>Gaps older than 5 days: alert<\/li><\/ul><\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-intake\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>RFP Intake<\/h3>\n          <label>Solicitation ID<\/label><input id=\"rfpSolicitation\" placeholder=\"SOL-2026-001\"/>\n          <label>Title<\/label><input id=\"rfpTitle\" placeholder=\"Title\"/>\n          <label>Customer<\/label><input id=\"rfpCustomer\"/>\n          <label>RFP Due Date<\/label><input id=\"rfpDue\" type=\"date\"/>\n          <label>Q&A Due Date<\/label><input id=\"rfpQDue\" type=\"date\"/>\n          <label>Volumes/Sections<\/label><textarea id=\"rfpSections\" placeholder=\"Vol I...\\nSec L...\\nSec M...\"><\/textarea>\n          <div class=\"right\" style=\"margin-top:10px\">\n            <button id=\"btnSaveIntake\" class=\"primary\">Save Intake<\/button>\n            <button id=\"btnSealBaseline\">Baseline Seal<\/button>\n          <\/div>\n          <div id=\"intakeHint\" class=\"muted\"><\/div>\n        <\/div>\n        <div class=\"card\"><h3>Baseline<\/h3><pre id=\"baselinePreview\" class=\"mono\" style=\"white-space:pre-wrap\"><\/pre><\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-requirements\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Add / Edit Requirement<\/h3>\n          <label>Requirement ID<\/label><input id=\"reqId\" placeholder=\"auto if empty\"/>\n          <label>Section Ref<\/label><input id=\"reqSection\" placeholder=\"L.3.2\"/>\n          <label>Type<\/label><select id=\"reqType\"><option>Shall<\/option><option>Will<\/option><option>Info<\/option><\/select>\n          <label>Priority<\/label><select id=\"reqPriority\"><option>High<\/option><option>Med<\/option><option>Low<\/option><\/select>\n          <label>Requirement Text<\/label><textarea id=\"reqText\"><\/textarea>\n          <label>Owner<\/label><input id=\"reqOwner\"/>\n          <label>Status<\/label><select id=\"reqStatus\"><option>New<\/option><option>Assigned<\/option><option>Drafted<\/option><option>Reviewed<\/option><option>Final<\/option><option>N/A<\/option><\/select>\n          <div class=\"right\" style=\"margin-top:10px\"><button id=\"btnReqClear\">Clear<\/button><button id=\"btnReqSave\" class=\"primary\">Save Requirement<\/button><\/div>\n          <div id=\"reqHint\" class=\"muted\"><\/div>\n        <\/div>\n        <div class=\"card\">\n          <h3>Bulk Paste Requirements<\/h3>\n          <div class=\"muted\">One requirement per line.<\/div>\n          <textarea id=\"reqBulk\" placeholder=\"System shall ...\\nSystem shall ...\"><\/textarea>\n          <div class=\"right\" style=\"margin-top:10px\"><button id=\"btnReqBulk\" class=\"primary\">Split + Add<\/button><\/div>\n        <\/div>\n      <\/div>\n      <div class=\"card\" style=\"margin-top:12px\"><h3>Requirements Table<\/h3><div id=\"reqTable\" class=\"muted\">No requirements yet.<\/div><\/div>\n    <\/section>\n\n    <section id=\"tab-mapping\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Compliance Mapping<\/h3>\n          <label>Requirement<\/label><select id=\"mapReq\"><\/select>\n          <label>Compliance Statement<\/label><textarea id=\"mapStatement\"><\/textarea>\n          <label>Evidence Links/Artifacts<\/label><textarea id=\"mapEvidence\" placeholder=\"artifact/path.md\\nhttps://...\"><\/textarea>\n          <label>Dependencies (Req IDs, comma-separated)<\/label><input id=\"mapDeps\"/>\n          <label>Verification Method<\/label><select id=\"mapVerify\"><option>test<\/option><option>inspect<\/option><option>demonstrate<\/option><option>analysis<\/option><\/select>\n          <div class=\"right\" style=\"margin-top:10px\"><button id=\"btnMapSave\" class=\"primary\">Save Mapping<\/button><\/div>\n        <\/div>\n        <div class=\"card\"><h3>Mapping Snapshot<\/h3><pre id=\"mapPreview\" class=\"mono\" style=\"white-space:pre-wrap\"><\/pre><\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-deliverables\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Add Deliverable<\/h3>\n          <label>Deliverable ID<\/label><input id=\"delId\" placeholder=\"DEL-001\"/>\n          <label>Description<\/label><textarea id=\"delDesc\"><\/textarea>\n          <label>Due Date<\/label><input id=\"delDue\" type=\"date\"/>\n          <label>Mapped Requirement IDs (comma-separated)<\/label><input id=\"delReqs\"/>\n          <label>Owner<\/label><input id=\"delOwner\"/>\n          <label>Status<\/label><select id=\"delStatus\"><option>Open<\/option><option>In Progress<\/option><option>Done<\/option><\/select>\n          <div class=\"right\" style=\"margin-top:10px\"><button id=\"btnDelSave\" class=\"primary\">Save Deliverable<\/button><\/div>\n        <\/div>\n        <div class=\"card\"><h3>Deliverables<\/h3><div id=\"delTable\" class=\"muted\">No deliverables yet.<\/div><\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-gaps\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Gap / Q&A Item<\/h3>\n          <label>Requirement<\/label><select id=\"gapReq\"><\/select>\n          <label>Gap Item<\/label><textarea id=\"gapText\"><\/textarea>\n          <label>Question for Customer<\/label><textarea id=\"gapQuestion\"><\/textarea>\n          <label>Resolution Notes<\/label><textarea id=\"gapResolution\"><\/textarea>\n          <label>Status<\/label><select id=\"gapStatus\"><option>Open<\/option><option>Resolved<\/option><\/select>\n          <div class=\"right\" style=\"margin-top:10px\"><button id=\"btnGapSave\" class=\"primary\">Save Gap<\/button><\/div>\n        <\/div>\n        <div class=\"card\"><h3>Gap Queue<\/h3><div id=\"gapTable\" class=\"muted\">No gaps yet.<\/div><\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-artifacts\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Artifacts Export<\/h3>\n          <div class=\"warnbox muted\">Exports to local ZIP with manifest + hashes + pack_hash.<\/div>\n          <label>Pack Prefix<\/label><input id=\"packPrefix\" value=\"SEQUOIA\"/>\n          <label>Organization / Program<\/label><input id=\"orgProgram\" value=\"NGA  SEQUOIA\"/>\n          <label>Coherence Steward<\/label><input id=\"cohSteward\"/>\n          <div class=\"grid\">\n            <div>\n              <label>Safe Export<\/label>\n              <select id=\"safeExport\"><option value=\"false\">Off<\/option><option value=\"true\">On<\/option><\/select>\n            <\/div>\n            <div>\n              <label>Safe Level<\/label>\n              <select id=\"safeExportLevel\"><option value=\"lite\">Lite<\/option><option value=\"strict\">Strict (strip req text)<\/option><\/select>\n            <\/div>\n          <\/div>\n          <div class=\"flex\" style=\"margin-top:10px\"><button id=\"btnZipPack\" class=\"primary\">Download ZIP Pack<\/button><\/div>\n        <\/div>\n        <div class=\"card\"><h3>Preview<\/h3><pre id=\"preview\" class=\"mono\" style=\"white-space:pre-wrap\"><\/pre><\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-test\" class=\"hidden\">\n      <div class=\"card\">\n        <h3>Test Mode<\/h3>\n        <div class=\"muted\">Generates sample RFP + 50 requirements + mappings + gaps, runs DS rules, then export.<\/div>\n        <div class=\"flex\" style=\"margin-top:10px\">\n          <button id=\"tmRunAll\" class=\"primary\">RUN FULL TEST<\/button>\n          <button id=\"tmDownloadZip\" class=\"primary\">Download ZIP Pack<\/button>\n          <button id=\"tmReset\" class=\"danger\">Reset Data<\/button>\n        <\/div>\n        <pre id=\"tmLog\" class=\"mono\" style=\"white-space:pre-wrap;margin-top:10px\"><\/pre>\n      <\/div>\n    <\/section>\n  <\/div>\n<\/main>\n\n<input id=\"fileImport\" type=\"file\" accept=\"application/json\" class=\"hidden\"/>\n<script>\nconst KEY = \"ds_compliance_matrix_v1\";\nconst DS_GAP_AGE_DAYS = 5;\nconst DS_COVERAGE_T3 = 90;\n\nfunction storageAvailable(){ try{ const x=\"__ds_test__\"; localStorage.setItem(x,x); localStorage.removeItem(x); return true; }catch(_){ return false; } }\nfunction getStoreItem(k){ if(storageAvailable()) return localStorage.getItem(k); window.__ds_memstore ||= {}; return window.__ds_memstore[k] || null; }\nfunction setStoreItem(k,v){ if(storageAvailable()) return localStorage.setItem(k,v); window.__ds_memstore ||= {}; window.__ds_memstore[k] = v; }\nfunction removeStoreItem(k){ if(storageAvailable()) return localStorage.removeItem(k); if(window.__ds_memstore) delete window.__ds_memstore[k]; }\n\nfunction nowIso(){ return new Date().toISOString(); }\nfunction today(){ return new Date().toISOString().slice(0,10); }\nfunction uid(prefix){ return `${prefix}-${Math.random().toString(16).slice(2,8).toUpperCase()}`; }\nfunction v(id){ return (document.getElementById(id)?.value || \"\").trim(); }\nfunction s(id,val){ const el=document.getElementById(id); if(el) el.value = val || \"\"; }\nfunction esc(x){ return String(x || \"\").replace(/[&<>\"']/g, m => ({\"&\":\"&amp;\",\"<\":\"&lt;\",\">\":\"&gt;\",\"\\\"\":\"&quot;\",\"'\":\"&#39;\"}[m])); }\nfunction asDate(x){ const s = String(x || \"\"); return /^\\d{4}-\\d{2}-\\d{2}$/.test(s) ? s : \"\"; }\nfunction daysOld(iso){ const a = new Date(iso || nowIso()).getTime(); const b = Date.now(); return Math.max(0, Math.floor((b-a)/(1000*60*60*24))); }\n\nfunction emptyDb(){\n  return {\n    intake: { solicitation_id:\"\", title:\"\", customer:\"\", due_date:\"\", qa_due_date:\"\", sections:\"\", baseline_sealed:false, baseline_seal:null, baseline_snapshot:null },\n    requirements: [],\n    deliverables: [],\n    gaps: [],\n    ds_manual: [],\n    rs: [],\n    meta: {created: nowIso(), version: \"1.0\"}\n  };\n}\nfunction load(){\n  const raw = getStoreItem(KEY);\n  if(!raw){ const db=emptyDb(); setStoreItem(KEY, JSON.stringify(db)); return db; }\n  try{\n    const db = JSON.parse(raw);\n    db.intake ||= emptyDb().intake;\n    db.requirements ||= [];\n    db.deliverables ||= [];\n    db.gaps ||= [];\n    db.ds_manual ||= [];\n    db.rs ||= [];\n    db.meta ||= {created: nowIso(), version:\"1.0\"};\n    return db;\n  }catch(_){\n    const db=emptyDb(); setStoreItem(KEY, JSON.stringify(db)); return db;\n  }\n}\nfunction save(db){ setStoreItem(KEY, JSON.stringify(db)); refreshAll(); }\n\nfunction safeFile(sv){ return (sv||\"\").replace(/[^a-z0-9_\\-]+/gi,\"_\").replace(/_+/g,\"_\").replace(/^_+|_+$/g,\"\"); }\nfunction isSafeExport(){ return (document.getElementById(\"safeExport\")?.value || \"false\") === \"true\"; }\nfunction safeLevel(){ return document.getElementById(\"safeExportLevel\")?.value || \"lite\"; }\n\nfunction setTab(tab){\n  [\"dashboard\",\"intake\",\"requirements\",\"mapping\",\"deliverables\",\"gaps\",\"artifacts\",\"test\"].forEach(t=>{\n    const el = document.getElementById(`tab-${t}`);\n    if(el) el.classList.toggle(\"hidden\", t!==tab);\n  });\n  document.querySelectorAll(\".tab\").forEach(b=> b.classList.toggle(\"active\", b.dataset.tab===tab));\n  try{ location.hash = \"#\" + tab; }catch(_){ }\n}\n\nfunction reqOptionsHtml(db){\n  if(!db.requirements.length) return `<option value=\"\">(no requirements)<\/option>`;\n  return db.requirements.map(r=>`<option value=\"${esc(r.id)}\">${esc(r.id)}  ${esc(r.section_ref || \"\")}<\/option>`).join(\"\");\n}\nfunction bindReqSelects(){\n  const db = load();\n  [\"mapReq\",\"gapReq\"].forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML = reqOptionsHtml(db); });\n}\n\nfunction saveIntake(){\n  const db = load();\n  db.intake.solicitation_id = v(\"rfpSolicitation\");\n  db.intake.title = v(\"rfpTitle\");\n  db.intake.customer = v(\"rfpCustomer\");\n  db.intake.due_date = asDate(v(\"rfpDue\"));\n  db.intake.qa_due_date = asDate(v(\"rfpQDue\"));\n  db.intake.sections = v(\"rfpSections\");\n  save(db);\n  document.getElementById(\"intakeHint\").textContent = \"Intake saved.\";\n}\nasync function sealBaseline(){\n  const db = load();\n  const snap = {\n    intake: {...db.intake},\n    requirement_ids: db.requirements.map(r=>r.id).sort(),\n    count_requirements: db.requirements.length,\n    sealed_at: nowIso()\n  };\n  const hash = await sha256Hex(strToUtf8Bytes(JSON.stringify(snap, null, 2)));\n  db.intake.baseline_sealed = true;\n  db.intake.baseline_seal = `${snap.sealed_at}|sha256:${hash}`;\n  db.intake.baseline_snapshot = snap;\n  save(db);\n  document.getElementById(\"intakeHint\").textContent = \"Baseline sealed.\";\n}\n\nfunction saveRequirement(){\n  const db = load();\n  const id = v(\"reqId\") || `REQ-${String(db.requirements.length+1).padStart(4,\"0\")}`;\n  const r = {\n    id,\n    section_ref: v(\"reqSection\"),\n    type: v(\"reqType\") || \"Shall\",\n    priority: v(\"reqPriority\") || \"Med\",\n    text: v(\"reqText\"),\n    owner: v(\"reqOwner\"),\n    status: v(\"reqStatus\") || \"New\",\n    compliance_statement: db.requirements.find(x=>x.id===id)?.compliance_statement || \"\",\n    evidence: db.requirements.find(x=>x.id===id)?.evidence || [],\n    dependencies: db.requirements.find(x=>x.id===id)?.dependencies || [],\n    verification_method: db.requirements.find(x=>x.id===id)?.verification_method || \"analysis\",\n    updated: nowIso(),\n    created: db.requirements.find(x=>x.id===id)?.created || nowIso()\n  };\n  const i = db.requirements.findIndex(x=>x.id===id);\n  if(i>=0) db.requirements[i]=r; else db.requirements.push(r);\n  save(db);\n  document.getElementById(\"reqHint\").textContent = `Saved ${id}`;\n}\nfunction clearRequirement(){ [\"reqId\",\"reqSection\",\"reqText\",\"reqOwner\"].forEach(x=>s(x,\"\")); s(\"reqType\",\"Shall\"); s(\"reqPriority\",\"Med\"); s(\"reqStatus\",\"New\"); }\nfunction editRequirement(id){\n  const r = load().requirements.find(x=>x.id===id); if(!r) return;\n  s(\"reqId\",r.id); s(\"reqSection\",r.section_ref); s(\"reqType\",r.type); s(\"reqPriority\",r.priority); s(\"reqText\",r.text); s(\"reqOwner\",r.owner); s(\"reqStatus\",r.status);\n  setTab(\"requirements\");\n}\nfunction deleteRequirement(id){\n  if(!confirm(\"Delete requirement?\")) return;\n  const db = load();\n  db.requirements = db.requirements.filter(r=>r.id!==id);\n  db.gaps = db.gaps.filter(g=>g.req_id!==id);\n  db.deliverables = db.deliverables.map(d=>({...d, req_ids: d.req_ids.filter(x=>x!==id)}));\n  save(db);\n}\nfunction bulkAddRequirements(){\n  const db = load();\n  const lines = v(\"reqBulk\").split(/\\r?\\n/).map(x=>x.trim()).filter(Boolean);\n  if(!lines.length) return alert(\"Paste requirement lines first.\");\n  lines.forEach(line=>{\n    const id = `REQ-${String(db.requirements.length+1).padStart(4,\"0\")}`;\n    db.requirements.push({\n      id, section_ref:\"\", type:\"Shall\", priority:\"Med\", text:line, owner:\"\", status:\"New\",\n      compliance_statement:\"\", evidence:[], dependencies:[], verification_method:\"analysis\",\n      created: nowIso(), updated: nowIso()\n    });\n  });\n  save(db);\n  s(\"reqBulk\",\"\");\n}\n\nfunction saveMapping(){\n  const db = load();\n  const id = v(\"mapReq\"); if(!id) return alert(\"Select requirement\");\n  const r = db.requirements.find(x=>x.id===id); if(!r) return alert(\"Requirement not found\");\n  r.compliance_statement = v(\"mapStatement\");\n  r.evidence = v(\"mapEvidence\").split(/\\r?\\n/).map(x=>x.trim()).filter(Boolean);\n  r.dependencies = v(\"mapDeps\").split(\",\").map(x=>x.trim()).filter(Boolean);\n  r.verification_method = v(\"mapVerify\") || \"analysis\";\n  r.updated = nowIso();\n  save(db);\n}\n\nfunction saveDeliverable(){\n  const db = load();\n  const id = v(\"delId\") || `DEL-${String(db.deliverables.length+1).padStart(3,\"0\")}`;\n  const d = {\n    id,\n    description: v(\"delDesc\"),\n    due: asDate(v(\"delDue\")),\n    req_ids: v(\"delReqs\").split(\",\").map(x=>x.trim()).filter(Boolean),\n    owner: v(\"delOwner\"),\n    status: v(\"delStatus\") || \"Open\",\n    created: db.deliverables.find(x=>x.id===id)?.created || nowIso(),\n    updated: nowIso()\n  };\n  const i = db.deliverables.findIndex(x=>x.id===id);\n  if(i>=0) db.deliverables[i]=d; else db.deliverables.push(d);\n  save(db);\n}\n\nfunction saveGap(){\n  const db = load();\n  const g = {\n    id: uid(\"GAP\"),\n    req_id: v(\"gapReq\"),\n    text: v(\"gapText\"),\n    question: v(\"gapQuestion\"),\n    resolution: v(\"gapResolution\"),\n    status: v(\"gapStatus\") || \"Open\",\n    created: nowIso(),\n    updated: nowIso()\n  };\n  if(!g.req_id || !g.text) return alert(\"Requirement + gap text required.\");\n  db.gaps.push(g);\n  save(db);\n  [\"gapText\",\"gapQuestion\",\"gapResolution\"].forEach(x=>s(x,\"\")); s(\"gapStatus\",\"Open\");\n}\n\nfunction computeAutoDs(db){\n  const alerts = [];\n  const reqs = db.requirements;\n  const unassigned = reqs.filter(r=>!r.owner).length;\n  if(unassigned > 0) alerts.push({code:\"DS-COMP-001\", msg:`Unassigned requirements: ${unassigned}`});\n\n  const oldGaps = db.gaps.filter(g=>g.status!==\"Resolved\" && daysOld(g.created) > DS_GAP_AGE_DAYS).length;\n  if(oldGaps > 0) alerts.push({code:\"DS-COMP-002\", msg:`Open gaps older than ${DS_GAP_AGE_DAYS} days: ${oldGaps}`});\n\n  const covered = reqs.filter(r=>r.compliance_statement && r.compliance_statement.trim().length>0).length;\n  const coverage = reqs.length ? (covered/reqs.length)*100 : 0;\n  const due = db.intake.due_date ? new Date(db.intake.due_date + \"T00:00:00Z\").getTime() : null;\n  const t3 = due ? (Date.now() >= (due - (3*24*60*60*1000))) : false;\n  if(t3 && coverage < DS_COVERAGE_T3) alerts.push({code:\"DS-COMP-003\", msg:`Coverage below ${DS_COVERAGE_T3}% at T-3 days (${coverage.toFixed(1)}%)`});\n\n  const noMap = reqs.filter(r=>!(r.compliance_statement && r.compliance_statement.trim())).length;\n  if(noMap > 0) alerts.push({code:\"DS-COMP-004\", msg:`Requirements without compliance statement: ${noMap}`});\n\n  return alerts.map(a=>({time: nowIso(), code:a.code, msg:a.msg, patch:\"Assign owner + map evidence\"}));\n}\n\nfunction renderDashboard(){\n  const db = load();\n  const totalReq = db.requirements.length;\n  const covered = db.requirements.filter(r=>r.compliance_statement && r.compliance_statement.trim()).length;\n  const coverage = totalReq ? Math.round((covered/totalReq)*1000)/10 : 0;\n  const unassigned = db.requirements.filter(r=>!r.owner).length;\n  const openGaps = db.gaps.filter(g=>g.status!==\"Resolved\").length;\n  const dueSoon = db.deliverables.filter(d=>d.status!==\"Done\" && d.due && (new Date(d.due).getTime()-Date.now()) <= (5*24*60*60*1000)).length;\n  const churn = db.requirements.filter(r=>daysOld(r.updated)===0).length;\n  const ds = computeAutoDs(db);\n  const pending = db.requirements.filter(r=>!([\"Final\",\"N/A\"].includes(r.status))).length;\n\n  document.getElementById(\"kReq\").textContent = String(totalReq);\n  document.getElementById(\"kCov\").textContent = `${coverage}%`;\n  document.getElementById(\"kUnassigned\").textContent = String(unassigned);\n  document.getElementById(\"kGaps\").textContent = String(openGaps);\n  document.getElementById(\"kDueSoon\").textContent = String(dueSoon);\n  document.getElementById(\"kChurn\").textContent = String(churn);\n  document.getElementById(\"kDs\").textContent = String(ds.length);\n  document.getElementById(\"kSeal\").textContent = db.intake.baseline_sealed ? \"Sealed\" : \"Open\";\n  document.getElementById(\"kPending\").textContent = String(pending);\n  document.getElementById(\"kGap90\").textContent = `${Math.max(0, (90-coverage)).toFixed(1)}%`;\n\n  const dsEl = document.getElementById(\"dashDs\");\n  dsEl.innerHTML = ds.length ? ds.map(x=>`<div><span class=\"pill\">${esc(x.code)}<\/span> ${esc(x.msg)}<\/div>`).join(\"\") : \"No DS alerts.\";\n}\n\nfunction renderIntake(){\n  const db = load();\n  s(\"rfpSolicitation\", db.intake.solicitation_id);\n  s(\"rfpTitle\", db.intake.title);\n  s(\"rfpCustomer\", db.intake.customer);\n  s(\"rfpDue\", db.intake.due_date);\n  s(\"rfpQDue\", db.intake.qa_due_date);\n  s(\"rfpSections\", db.intake.sections);\n  document.getElementById(\"baselinePreview\").textContent = db.intake.baseline_snapshot ? JSON.stringify({seal:db.intake.baseline_seal, snapshot:db.intake.baseline_snapshot}, null, 2) : \"No baseline snapshot yet.\";\n}\n\nfunction renderRequirements(){\n  const db = load();\n  const el = document.getElementById(\"reqTable\");\n  if(!db.requirements.length){ el.innerHTML = \"<div class='muted'>No requirements yet.<\/div>\"; return; }\n  el.innerHTML = `<table><thead><tr><th>ID<\/th><th>Section<\/th><th>Type<\/th><th>Priority<\/th><th>Owner<\/th><th>Status<\/th><th>Mapped<\/th><th><\/th><\/tr><\/thead><tbody>${db.requirements.map(r=>`<tr>\n    <td class=\"mono\">${esc(r.id)}<\/td><td>${esc(r.section_ref)}<\/td><td>${esc(r.type)}<\/td><td>${esc(r.priority)}<\/td><td>${esc(r.owner)}<\/td><td>${esc(r.status)}<\/td><td>${r.compliance_statement ? \"Yes\" : \"No\"}<\/td>\n    <td><button data-action=\"edit\" data-id=\"${esc(r.id)}\">Edit<\/button> <button class=\"danger\" data-action=\"del\" data-id=\"${esc(r.id)}\">Delete<\/button><\/td>\n  <\/tr>`).join(\"\")}<\/tbody><\/table>`;\n}\nfunction renderMapping(){\n  const db = load();\n  const id = v(\"mapReq\");\n  const r = db.requirements.find(x=>x.id===id);\n  if(!r){ document.getElementById(\"mapPreview\").textContent = \"Select requirement.\"; return; }\n  s(\"mapStatement\", r.compliance_statement || \"\");\n  s(\"mapEvidence\", (r.evidence||[]).join(\"\\n\"));\n  s(\"mapDeps\", (r.dependencies||[]).join(\", \"));\n  s(\"mapVerify\", r.verification_method || \"analysis\");\n  document.getElementById(\"mapPreview\").textContent = JSON.stringify({id:r.id, statement:r.compliance_statement, evidence:r.evidence, deps:r.dependencies, verify:r.verification_method}, null, 2);\n}\nfunction renderDeliverables(){\n  const db = load();\n  const el = document.getElementById(\"delTable\");\n  if(!db.deliverables.length){ el.innerHTML = \"<div class='muted'>No deliverables yet.<\/div>\"; return; }\n  el.innerHTML = `<table><thead><tr><th>ID<\/th><th>Description<\/th><th>Due<\/th><th>Req IDs<\/th><th>Owner<\/th><th>Status<\/th><\/tr><\/thead><tbody>${db.deliverables.map(d=>`<tr>\n    <td class=\"mono\">${esc(d.id)}<\/td><td>${esc(d.description)}<\/td><td>${esc(d.due)}<\/td><td class=\"mono\">${esc((d.req_ids||[]).join(\",\"))}<\/td><td>${esc(d.owner)}<\/td><td>${esc(d.status)}<\/td>\n  <\/tr>`).join(\"\")}<\/tbody><\/table>`;\n}\nfunction renderGaps(){\n  const db = load();\n  const el = document.getElementById(\"gapTable\");\n  if(!db.gaps.length){ el.innerHTML = \"<div class='muted'>No gaps yet.<\/div>\"; return; }\n  el.innerHTML = `<table><thead><tr><th>Req<\/th><th>Gap<\/th><th>Question<\/th><th>Status<\/th><th>Age<\/th><\/tr><\/thead><tbody>${db.gaps.slice().reverse().map(g=>`<tr>\n    <td class=\"mono\">${esc(g.req_id)}<\/td><td>${esc(g.text)}<\/td><td>${esc(g.question)}<\/td><td>${esc(g.status)}<\/td><td>${daysOld(g.created)}d<\/td>\n  <\/tr>`).join(\"\")}<\/tbody><\/table>`;\n}\n\nfunction buildCanonicalMatrix(db, meta){\n  const reqs = db.requirements.map(r=>{\n    const rr = {...r};\n    if(isSafeExport() && safeLevel()===\"strict\"){\n      rr.text = \"(masked)\";\n      rr.compliance_statement = rr.compliance_statement ? \"(masked)\" : \"\";\n      rr.evidence = [];\n    }\n    return rr;\n  });\n  return {\n    schema: \"deepsigma_compliance_matrix_v1\",\n    meta,\n    intake: db.intake,\n    requirements: reqs,\n    deliverables: db.deliverables,\n    gaps: db.gaps,\n    ds_auto: computeAutoDs(db)\n  };\n}\nfunction baselineMarkdown(db, meta){\n  return `# DLR  Requirements Baseline\\n**Program:** ${meta.program}  \\n**Generated:** ${meta.generated}  \\n\\n## Intake\\n- Solicitation: ${db.intake.solicitation_id || \"(unset)\"}\\n- Title: ${db.intake.title || \"(unset)\"}\\n- Customer: ${db.intake.customer || \"(unset)\"}\\n- Due: ${db.intake.due_date || \"(unset)\"}\\n\\n## Baseline Seal\\n- Sealed: ${db.intake.baseline_sealed ? \"true\" : \"false\"}\\n- Seal: ${db.intake.baseline_seal || \"(none)\"}\\n\\n## Requirement Counts\\n- Total: ${db.requirements.length}\\n- Unassigned: ${db.requirements.filter(r=>!r.owner).length}\\n- Mapped: ${db.requirements.filter(r=>r.compliance_statement).length}\\n`;\n}\nfunction dsMarkdown(db, ds){\n  return `# DS Compliance  ${today()}\\n\\n## Auto Alerts\\n${ds.length ? ds.map(d=>`- **${d.code}** (${d.time})  ${d.msg}`).join(\"\\n\") : \"- None\"}\\n\\n## Open Gaps\\n${db.gaps.filter(g=>g.status!==\"Resolved\").length ? db.gaps.filter(g=>g.status!==\"Resolved\").map(g=>`- ${g.req_id}: ${g.text} (${daysOld(g.created)}d)`).join(\"\\n\") : \"- None\"}\\n`;\n}\n\nfunction crc32(buf){ let c = 0 ^ (-1); for(let i=0;i<buf.length;i++) c = (c>>>8) ^ CRC_TABLE[(c ^ buf[i]) & 0xFF]; return (c ^ (-1)) >>> 0; }\nconst CRC_TABLE = (()=>{ const t=new Uint32Array(256); for(let i=0;i<256;i++){ let c=i; for(let k=0;k<8;k++) c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1); t[i]=c>>>0; } return t; })();\nfunction u16(n){ return [n & 0xFF, (n>>>8)&0xFF]; }\nfunction u32(n){ return [n & 0xFF, (n>>>8)&0xFF, (n>>>16)&0xFF, (n>>>24)&0xFF]; }\nfunction strToUtf8Bytes(s){ return new TextEncoder().encode(s); }\nfunction buildZip(entries){\n  const fileParts=[]; const central=[]; let offset=0;\n  for(const e of entries){\n    const nameBytes=strToUtf8Bytes(e.name), data=e.bytes, crc=crc32(data), size=data.length;\n    const dt=e.mtime||new Date();\n    const dosTime=((dt.getHours()&0x1F)<<11)|((dt.getMinutes()&0x3F)<<5)|((Math.floor(dt.getSeconds()/2))&0x1F);\n    const dosDate=(((dt.getFullYear()-1980)&0x7F)<<9)|(((dt.getMonth()+1)&0x0F)<<5)|(dt.getDate()&0x1F);\n    const local=[...u32(0x04034b50),...u16(20),...u16(0),...u16(0),...u16(dosTime),...u16(dosDate),...u32(crc),...u32(size),...u32(size),...u16(nameBytes.length),...u16(0)];\n    fileParts.push(new Uint8Array(local), nameBytes, data);\n    const c=[...u32(0x02014b50),...u16(0x0314),...u16(20),...u16(0),...u16(0),...u16(dosTime),...u16(dosDate),...u32(crc),...u32(size),...u32(size),...u16(nameBytes.length),...u16(0),...u16(0),...u16(0),...u16(0),...u32(0),...u32(offset)];\n    central.push(new Uint8Array(c), nameBytes);\n    offset += local.length + nameBytes.length + size;\n  }\n  const centralStart=offset;\n  for(const p of central){ fileParts.push(p); offset += p.length; }\n  const centralSize=offset-centralStart;\n  const eocd=[...u32(0x06054b50),...u16(0),...u16(0),...u16(entries.length),...u16(entries.length),...u32(centralSize),...u32(centralStart),...u16(0)];\n  fileParts.push(new Uint8Array(eocd));\n  return new Blob(fileParts,{type:\"application/zip\"});\n}\nasync function sha256Hex(bytes){ const out = await crypto.subtle.digest(\"SHA-256\", bytes.buffer ? bytes.buffer : bytes); return Array.from(new Uint8Array(out)).map(b=>b.toString(16).padStart(2,\"0\")).join(\"\"); }\n\nasync function createZipPackPayload(){\n  const db = load();\n  const meta = {\n    prefix: v(\"packPrefix\") || \"SEQUOIA\",\n    program: v(\"orgProgram\") || \"NGA  SEQUOIA\",\n    steward: v(\"cohSteward\") || \"(unassigned)\",\n    generated: nowIso(),\n    date: today(),\n    safe_export: isSafeExport(),\n    safe_export_level: safeLevel(),\n    version: \"1.0\"\n  };\n  const root = `${safeFile(meta.prefix)}_CompliancePack_${meta.date}`;\n  const entries = []; const ts = new Date();\n  const addJson = (path,obj)=>{ const bytes=strToUtf8Bytes(JSON.stringify(obj,null,2)); entries.push({name:`${root}/${path}`, bytes, mtime:ts}); return bytes; };\n  const addText = (path,text)=>{ const bytes=strToUtf8Bytes(text); entries.push({name:`${root}/${path}`, bytes, mtime:ts}); return bytes; };\n\n  const matrix = buildCanonicalMatrix(db, meta);\n  const dsAuto = computeAutoDs(db);\n  addJson(`matrix/${safeFile(meta.prefix)}_COMPLIANCE_MATRIX.json`, matrix);\n  addText(`baseline/${safeFile(meta.prefix)}_DLR_REQUIREMENTS_BASELINE.md`, baselineMarkdown(db, meta));\n  addText(`ds/${safeFile(meta.prefix)}_DS_COMPLIANCE_${meta.date}.md`, dsMarkdown(db, dsAuto));\n\n  const manifest = {\n    schema: \"deepsigma_ingest_manifest_v1\",\n    meta,\n    counts: {\n      requirements: db.requirements.length,\n      deliverables: db.deliverables.length,\n      gaps: db.gaps.length,\n      ds_auto: dsAuto.length\n    },\n    hashes_file: \"hashes.json\"\n  };\n  const hashes = {};\n  for(const e of entries) hashes[e.name] = await sha256Hex(e.bytes);\n  const material = strToUtf8Bytes(Object.entries(hashes).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>`${k} ${v}`).join(\"\\n\"));\n  const pack_hash = await sha256Hex(material);\n  manifest.pack_hash = pack_hash;\n  addJson(\"ingest_manifest.json\", manifest);\n  addJson(\"hashes.json\", {pack_hash, hashes});\n  addText(\"README.md\", `# ${meta.prefix} Compliance Pack\\nProgram: ${meta.program}\\nGenerated: ${meta.generated}\\nSafe export: ${meta.safe_export} (${meta.safe_export_level})\\n`);\n\n  const zipBlob = buildZip(entries);\n  return {root, manifest, zipBlob};\n}\nasync function downloadZipPack(){\n  const {root, manifest, zipBlob} = await createZipPackPayload();\n  document.getElementById(\"preview\").textContent = JSON.stringify(manifest, null, 2);\n  const a = document.createElement(\"a\");\n  a.href = URL.createObjectURL(zipBlob);\n  a.download = `${root}.zip`;\n  a.click();\n}\n\nfunction tmLog(msg){ const el=document.getElementById(\"tmLog\"); if(!el) return; el.textContent += `[${nowIso()}] ${msg}\\n`; el.scrollTop = el.scrollHeight; }\nfunction tmResetAll(){ if(!confirm(\"Reset ALL local data?\")) return; removeStoreItem(KEY); load(); refreshAll(); document.getElementById(\"tmLog\").textContent=\"\"; tmLog(\"Reset complete.\"); }\nfunction tmRunAll(){\n  const db = load();\n  db.intake = { solicitation_id:\"SOL-TEST-001\", title:\"Sample Compliance RFP\", customer:\"Sample Agency\", due_date:today(), qa_due_date:today(), sections:\"Vol I\\nSec L\\nSec M\", baseline_sealed:false, baseline_seal:null, baseline_snapshot:null };\n  db.requirements = [];\n  for(let i=1;i<=50;i++){\n    const id = `REQ-${String(i).padStart(4,\"0\")}`;\n    db.requirements.push({\n      id,\n      section_ref:`L.${Math.ceil(i/5)}.${(i%5)+1}`,\n      type: i%7===0 ? \"Info\" : \"Shall\",\n      priority: i%3===0 ? \"High\" : \"Med\",\n      text:`Requirement ${i}: Contractor shall provide capability ${i}.`,\n      owner: i%6===0 ? \"\" : `Owner-${(i%8)+1}`,\n      status: i%5===0 ? \"Drafted\" : \"Assigned\",\n      compliance_statement: i%4===0 ? \"\" : `We comply via approach ${i}.`,\n      evidence: i%4===0 ? [] : [`artifact-${i}.md`],\n      dependencies: i>1 && i%10===0 ? [`REQ-${String(i-1).padStart(4,\"0\")}`] : [],\n      verification_method: [\"test\",\"inspect\",\"demonstrate\",\"analysis\"][i%4],\n      created: nowIso(),\n      updated: nowIso()\n    });\n  }\n  db.deliverables = [\n    {id:\"DEL-001\", description:\"Volume 1 Technical\", due:today(), req_ids:[\"REQ-0001\",\"REQ-0002\"], owner:\"Lead-1\", status:\"In Progress\", created:nowIso(), updated:nowIso()},\n    {id:\"DEL-002\", description:\"Volume 2 Management\", due:today(), req_ids:[\"REQ-0010\",\"REQ-0011\"], owner:\"Lead-2\", status:\"Open\", created:nowIso(), updated:nowIso()}\n  ];\n  db.gaps = [\n    {id:uid(\"GAP\"), req_id:\"REQ-0004\", text:\"Need customer clarification on latency target\", question:\"Confirm latency threshold?\", resolution:\"\", status:\"Open\", created:new Date(Date.now()-6*24*60*60*1000).toISOString(), updated:nowIso()},\n    {id:uid(\"GAP\"), req_id:\"REQ-0012\", text:\"Missing interface spec\", question:\"Provide ICD version?\", resolution:\"\", status:\"Open\", created:nowIso(), updated:nowIso()}\n  ];\n  db.ds_manual = [];\n  db.rs = [{id:uid(\"RS\"), week_of:today(), steward:\"Compliance Steward\", notes:\"Focus on unassigned high-priority requirements\", created:nowIso()}];\n  save(db);\n  tmLog(\"Generated sample intake + 50 requirements + mappings + gaps.\");\n  tmLog(`Auto DS count: ${computeAutoDs(db).length}`);\n}\n\nfunction bindEvents(){\n  document.querySelectorAll(\".tab\").forEach(b=>b.addEventListener(\"click\", ()=>setTab(b.dataset.tab)));\n\n  document.getElementById(\"btnSaveIntake\")?.addEventListener(\"click\", saveIntake);\n  document.getElementById(\"btnSealBaseline\")?.addEventListener(\"click\", sealBaseline);\n\n  document.getElementById(\"btnReqSave\")?.addEventListener(\"click\", saveRequirement);\n  document.getElementById(\"btnReqClear\")?.addEventListener(\"click\", clearRequirement);\n  document.getElementById(\"btnReqBulk\")?.addEventListener(\"click\", bulkAddRequirements);\n  document.getElementById(\"reqTable\")?.addEventListener(\"click\", (e)=>{\n    const b=e.target.closest(\"button\"); if(!b) return;\n    if(b.dataset.action===\"edit\") editRequirement(b.dataset.id);\n    if(b.dataset.action===\"del\") deleteRequirement(b.dataset.id);\n  });\n\n  document.getElementById(\"mapReq\")?.addEventListener(\"change\", renderMapping);\n  document.getElementById(\"btnMapSave\")?.addEventListener(\"click\", saveMapping);\n\n  document.getElementById(\"btnDelSave\")?.addEventListener(\"click\", saveDeliverable);\n  document.getElementById(\"btnGapSave\")?.addEventListener(\"click\", saveGap);\n\n  document.getElementById(\"btnZipPack\")?.addEventListener(\"click\", downloadZipPack);\n\n  document.getElementById(\"btnExport\")?.addEventListener(\"click\", ()=>{\n    const blob = new Blob([JSON.stringify(load(),null,2)], {type:\"application/json\"});\n    const a = document.createElement(\"a\"); a.href = URL.createObjectURL(blob); a.download = `compliance_matrix_console_${today()}.json`; a.click();\n  });\n  document.getElementById(\"btnImport\")?.addEventListener(\"click\", ()=>document.getElementById(\"fileImport\")?.click());\n  document.getElementById(\"fileImport\")?.addEventListener(\"change\", (e)=>{\n    const file = e.target.files?.[0]; if(!file) return;\n    const reader = new FileReader();\n    reader.onload = ()=>{\n      try{\n        const db = JSON.parse(reader.result);\n        if(!db || typeof db !== \"object\" || Array.isArray(db)) throw new Error(\"Invalid root object\");\n        setStoreItem(KEY, JSON.stringify(db));\n        refreshAll();\n        alert(\"Imported.\");\n      }catch(err){ alert(`Invalid JSON: ${err.message || \"Import failed\"}`); }\n    };\n    reader.readAsText(file);\n  });\n  document.getElementById(\"btnReset\")?.addEventListener(\"click\", tmResetAll);\n\n  document.getElementById(\"tmRunAll\")?.addEventListener(\"click\", tmRunAll);\n  document.getElementById(\"tmDownloadZip\")?.addEventListener(\"click\", downloadZipPack);\n  document.getElementById(\"tmReset\")?.addEventListener(\"click\", tmResetAll);\n}\n\nfunction refreshAll(){\n  bindReqSelects();\n  renderDashboard();\n  renderIntake();\n  renderRequirements();\n  renderMapping();\n  renderDeliverables();\n  renderGaps();\n}\n\n(function init(){\n  load();\n  bindEvents();\n  refreshAll();\n  const h = (location.hash||\"\").replace(\"#\",\"\").trim();\n  const valid = [\"dashboard\",\"intake\",\"requirements\",\"mapping\",\"deliverables\",\"gaps\",\"artifacts\",\"test\"];\n  if(valid.includes(h)) setTab(h); else setTab(\"dashboard\");\n})();\n<\/script>\n<\/body>\n<\/html>\n"},
    "boe": {title: "BOE/Pricing v001", desc: "BOE assumptions, risk bands, and approval", html: "<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\"/>\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/>\n  <title>Deep Sigma - BOE / Pricing Console v001<\/title>\n  <style>\n    :root { --bg:#0b0f14; --card:#111824; --muted:#8aa0b5; --txt:#e7eef7; --accent:#7df9ff; --warn:#ffcc66; --bad:#ff6b6b; --ok:#5dff93; }\n    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--txt)}\n    header{padding:16px 18px;border-bottom:1px solid #1b2a3a;display:flex;gap:12px;align-items:center;justify-content:space-between}\n    .brand{display:flex;flex-direction:column;gap:2px}.brand b{letter-spacing:.4px}.brand small{color:var(--muted)}\n    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}\n    button{background:#182235;color:var(--txt);border:1px solid #243449;border-radius:10px;padding:10px 12px;cursor:pointer}\n    button:hover{border-color:#2f4765} button.primary{border-color:rgba(125,249,255,.45);box-shadow:0 0 0 1px rgba(125,249,255,.12) inset} button.danger{border-color:rgba(255,107,107,.45)}\n    main{display:grid;grid-template-columns:290px 1fr;min-height:calc(100vh - 66px)}\n    nav{border-right:1px solid #1b2a3a;padding:14px}\n    .tab{display:block;width:100%;text-align:left;padding:10px 12px;border-radius:10px;border:1px solid transparent;background:transparent;color:var(--txt);margin-bottom:8px}\n    .tab.active{background:#101a28;border-color:#243449}\n    .wrap{padding:14px 16px;max-width:1400px}\n    .card{background:var(--card);border:1px solid #1b2a3a;border-radius:14px;padding:12px}\n    .card h3{margin:0 0 10px 0;font-size:14px;color:#cfe2f7;letter-spacing:.3px}\n    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}\n    .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}\n    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}\n    input,textarea,select{width:100%;box-sizing:border-box;background:#0d1520;color:var(--txt);border:1px solid #243449;border-radius:10px;padding:10px 10px;font-size:13px}\n    textarea{min-height:92px;resize:vertical}\n    .small{font-size:12px}.muted{color:var(--muted);font-size:12px}\n    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}\n    table{width:100%;border-collapse:collapse;font-size:13px} th,td{padding:9px;border-bottom:1px solid #1b2a3a;vertical-align:top} th{color:#b9d3ea;text-align:left}\n    .hidden{display:none}\n    .right{display:flex;gap:10px;justify-content:flex-end;align-items:center;flex-wrap:wrap}\n    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #243449;color:var(--muted);font-size:12px;margin-right:6px}\n    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}\n  <\/style>\n<\/head>\n<body>\n<header>\n  <div class=\"brand\">\n    <b>Deep Sigma - BOE / Pricing Console v001<\/b>\n    <small>Offline edge node | DLR-BOE | DS pricing drift | Manifest + Hashes + Pack Hash<\/small>\n  <\/div>\n  <div class=\"row\">\n    <button id=\"btnExport\" class=\"primary\">Export JSON<\/button>\n    <button id=\"btnImport\">Import JSON<\/button>\n    <button id=\"btnReset\" class=\"danger\">Reset<\/button>\n  <\/div>\n<\/header>\n<main>\n  <nav>\n    <button class=\"tab active\" data-tab=\"dashboard\">Dashboard<\/button>\n    <button class=\"tab\" data-tab=\"intake\">Opportunity / RFP Intake<\/button>\n    <button class=\"tab\" data-tab=\"labor\">Labor Mix Builder<\/button>\n    <button class=\"tab\" data-tab=\"assumptions\">Assumptions (DLR-BOE)<\/button>\n    <button class=\"tab\" data-tab=\"risk\">Risk Bands + Sensitivities<\/button>\n    <button class=\"tab\" data-tab=\"approval\">Review / Approval (Seal)<\/button>\n    <button class=\"tab\" data-tab=\"artifacts\">Artifacts Export<\/button>\n    <button class=\"tab\" data-tab=\"test\">Test Mode<\/button>\n    <div style=\"margin-top:14px\" class=\"muted\">Data stored in <span class=\"mono\">localStorage<\/span>.<\/div>\n  <\/nav>\n  <div class=\"wrap\">\n    <section id=\"tab-dashboard\">\n      <div class=\"kpi\">\n        <div class=\"card\"><div class=\"muted\">Total Labor Hours<\/div><b id=\"kHours\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Base Total Price<\/div><b id=\"kPrice\">$0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Margin Band (manual)<\/div><b id=\"kMargin\">-<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Risk Score<\/div><b id=\"kRisk\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Auto DS Alerts<\/div><b id=\"kDs\">0<\/b><\/div>\n      <\/div>\n      <div class=\"kpi\" style=\"margin-top:10px\">\n        <div class=\"card\"><div class=\"muted\">BOE Completeness<\/div><b id=\"kComplete\">0%<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Assumptions<\/div><b id=\"kAssumptions\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Rate Outliers<\/div><b id=\"kRateOut\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Hours Outliers<\/div><b id=\"kHoursOut\">0<\/b><\/div>\n        <div class=\"card\"><div class=\"muted\">Missing Hours/Rate<\/div><b id=\"kMissing\">0<\/b><\/div>\n      <\/div>\n      <div class=\"card\" style=\"margin-top:12px\">\n        <h3>Auto DS Alerts<\/h3>\n        <div id=\"dashDs\" class=\"muted\">No alerts.<\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-intake\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Opportunity / Pricing Basis Intake<\/h3>\n          <label>Opportunity ID<\/label><input id=\"iOppId\" placeholder=\"OPP-BOE-001\"/>\n          <label>Opportunity Title<\/label><input id=\"iTitle\" placeholder=\"Program / Pursuit name\"/>\n          <label>Customer<\/label><input id=\"iCustomer\" placeholder=\"Agency / Office\"/>\n          <label>Contract Type<\/label><select id=\"iContract\"><option>FFP<\/option><option>T&M<\/option><option>Cost+<\/option><\/select>\n          <label>Period of Performance<\/label><input id=\"iPop\" placeholder=\"Base + 4 options\"/>\n          <label>Locations<\/label><textarea id=\"iLocations\" placeholder=\"Arlington, VA\\nSan Diego, CA\"><\/textarea>\n          <label>Escalation Policy<\/label><textarea id=\"iEscalation\" placeholder=\"e.g., 3% annual\"><\/textarea>\n          <label>Fringe Placeholder (%)<\/label><input id=\"iFringe\" type=\"number\" step=\"0.01\"/>\n          <label>Overhead Placeholder (%)<\/label><input id=\"iOverhead\" type=\"number\" step=\"0.01\"/>\n          <label>G&A Placeholder (%)<\/label><input id=\"iGa\" type=\"number\" step=\"0.01\"/>\n          <label>Manual Margin Band<\/label><input id=\"iMarginBand\" placeholder=\"Best 14% / Base 11% / Worst 8%\"/>\n          <div class=\"right\" style=\"margin-top:10px\"><button id=\"btnIntakeSave\" class=\"primary\">Save Intake<\/button><\/div>\n          <div id=\"iHint\" class=\"muted\"><\/div>\n        <\/div>\n        <div class=\"card\">\n          <h3>Intake Snapshot<\/h3>\n          <pre id=\"iPreview\" class=\"mono\" style=\"white-space:pre-wrap\">No intake saved.<\/pre>\n        <\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-labor\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Labor Line Item<\/h3>\n          <label>Line ID (optional)<\/label><input id=\"lId\" placeholder=\"LINE-001\"/>\n          <label>Role / Labor Category<\/label><input id=\"lRole\"/>\n          <label>Location<\/label><input id=\"lLocation\"/>\n          <label>Clearance<\/label><input id=\"lClearance\" placeholder=\"None / Secret / TS-SCI\"/>\n          <label>Hours<\/label><input id=\"lHours\" type=\"number\" min=\"0\" step=\"1\"/>\n          <label>Rate ($/hr)<\/label><input id=\"lRate\" type=\"number\" min=\"0\" step=\"0.01\"/>\n          <label>Period<\/label><input id=\"lPeriod\" placeholder=\"Base / Option1\"/>\n          <label>Rate Type<\/label><select id=\"lRateType\"><option>loaded<\/option><option>fully-burdened<\/option><option>raw<\/option><\/select>\n          <label>Notes<\/label><textarea id=\"lNotes\"><\/textarea>\n          <div class=\"right\" style=\"margin-top:10px\">\n            <button id=\"btnLClear\">Clear<\/button>\n            <button id=\"btnLSave\" class=\"primary\">Save Line<\/button>\n          <\/div>\n          <div id=\"lHint\" class=\"muted\"><\/div>\n        <\/div>\n        <div class=\"card\">\n          <h3>Labor Mix<\/h3>\n          <div id=\"laborTable\" class=\"muted\">No labor lines yet.<\/div>\n          <h3 style=\"margin-top:12px\">Aggregates<\/h3>\n          <pre id=\"laborAgg\" class=\"mono\" style=\"white-space:pre-wrap\">{}<\/pre>\n        <\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-assumptions\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Add Assumption<\/h3>\n          <label>Assumption text<\/label><textarea id=\"aText\"><\/textarea>\n          <label>Category<\/label><select id=\"aCat\"><option>rates<\/option><option>hours<\/option><option>productivity<\/option><option>travel<\/option><option>subs<\/option><option>escalation<\/option><\/select>\n          <label>Confidence<\/label><select id=\"aConfidence\"><option>Low<\/option><option>Med<\/option><option>High<\/option><\/select>\n          <label>Expiry date<\/label><input id=\"aExpiry\" type=\"date\"/>\n          <label>Disconfirmers<\/label><textarea id=\"aDis\"><\/textarea>\n          <div class=\"right\" style=\"margin-top:10px\"><button id=\"btnASave\" class=\"primary\">Save Assumption<\/button><\/div>\n        <\/div>\n        <div class=\"card\"><h3>Assumptions Register<\/h3><div id=\"assumptionTable\" class=\"muted\">No assumptions yet.<\/div><\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-risk\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Risk Bands + Sensitivities<\/h3>\n          <label>Hours multipliers (best/base/worst)<\/label>\n          <div class=\"grid\" style=\"grid-template-columns:1fr 1fr 1fr\">\n            <input id=\"rbHoursBest\" type=\"number\" step=\"0.01\" value=\"0.9\"/>\n            <input id=\"rbHoursBase\" type=\"number\" step=\"0.01\" value=\"1.0\"/>\n            <input id=\"rbHoursWorst\" type=\"number\" step=\"0.01\" value=\"1.15\"/>\n          <\/div>\n          <label>Rate multipliers (best/base/worst)<\/label>\n          <div class=\"grid\" style=\"grid-template-columns:1fr 1fr 1fr\">\n            <input id=\"rbRateBest\" type=\"number\" step=\"0.01\" value=\"0.98\"/>\n            <input id=\"rbRateBase\" type=\"number\" step=\"0.01\" value=\"1.0\"/>\n            <input id=\"rbRateWorst\" type=\"number\" step=\"0.01\" value=\"1.05\"/>\n          <\/div>\n          <label>Sensitivity switches<\/label>\n          <select id=\"rbEscalation\"><option value=\"true\">Escalation ON<\/option><option value=\"false\">Escalation OFF<\/option><\/select>\n          <select id=\"rbSurge\"><option value=\"false\">Surge Staffing OFF<\/option><option value=\"true\">Surge Staffing ON<\/option><\/select>\n          <select id=\"rbClearance\"><option value=\"false\">Clearance Premium OFF<\/option><option value=\"true\">Clearance Premium ON<\/option><\/select>\n          <div class=\"right\" style=\"margin-top:10px\"><button id=\"btnRiskSave\" class=\"primary\">Save Risk Model<\/button><\/div>\n        <\/div>\n        <div class=\"card\">\n          <h3>Banded Totals<\/h3>\n          <pre id=\"riskPreview\" class=\"mono\" style=\"white-space:pre-wrap\">No model yet.<\/pre>\n        <\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-approval\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Review / Approval<\/h3>\n          <label>Approver(s)<\/label><input id=\"apApprovers\" placeholder=\"Name; Name\"/>\n          <label>Authority note<\/label><textarea id=\"apAuthority\"><\/textarea>\n          <label>Decision note<\/label><textarea id=\"apDecision\"><\/textarea>\n          <label>Seal status<\/label><select id=\"apSeal\"><option value=\"false\">Open<\/option><option value=\"true\">Sealed<\/option><\/select>\n          <div class=\"right\" style=\"margin-top:10px\"><button id=\"btnApprovalSave\" class=\"primary\">Save Approval<\/button><\/div>\n          <div id=\"apHint\" class=\"muted\"><\/div>\n        <\/div>\n        <div class=\"card\">\n          <h3>DLR-BOE Preview<\/h3>\n          <pre id=\"approvalPreview\" class=\"mono\" style=\"white-space:pre-wrap\">No approval record.<\/pre>\n        <\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-artifacts\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Artifacts Export<\/h3>\n          <label>Prefix<\/label><input id=\"packPrefix\" value=\"SEQUOIA\"/>\n          <label>Program<\/label><input id=\"orgProgram\" value=\"NGA - SEQUOIA\"/>\n          <label>Steward<\/label><input id=\"cohSteward\" value=\"Pricing Steward\"/>\n          <label>Safe Export<\/label><select id=\"safeExport\"><option value=\"false\">OFF<\/option><option value=\"true\">ON<\/option><\/select>\n          <label>Safe Level<\/label><select id=\"safeExportLevel\"><option value=\"lite\">Lite (mask customer/title/notes)<\/option><option value=\"strict\">Strict (strip narrative)<\/option><\/select>\n          <div class=\"right\" style=\"margin-top:10px\"><button id=\"btnZipPack\" class=\"primary\">Download BOE Pack ZIP<\/button><\/div>\n          <div class=\"muted small\">Pack includes BOE JSON, DLR_BOE_ASSUMPTIONS.md, DS_PRICING_date.md, ingest_manifest.json, hashes.json, README.md.<\/div>\n        <\/div>\n        <div class=\"card\">\n          <h3>Manifest Preview<\/h3>\n          <pre id=\"preview\" class=\"mono\" style=\"white-space:pre-wrap\">No export yet.<\/pre>\n        <\/div>\n      <\/div>\n    <\/section>\n\n    <section id=\"tab-test\" class=\"hidden\">\n      <div class=\"grid\">\n        <div class=\"card\">\n          <h3>Test Mode<\/h3>\n          <div class=\"right\" style=\"justify-content:flex-start\">\n            <button id=\"tmRunAll\" class=\"primary\">Generate Sample BOE<\/button>\n            <button id=\"tmDownloadZip\">Export ZIP<\/button>\n            <button id=\"tmReset\" class=\"danger\">Reset Data<\/button>\n          <\/div>\n          <div class=\"muted small\" style=\"margin-top:8px\">Generates 20-60 labor lines, assumptions, outliers, and approval snapshot.<\/div>\n          <pre id=\"tmLog\" class=\"mono\" style=\"white-space:pre-wrap;min-height:160px\"><\/pre>\n        <\/div>\n        <div class=\"card\">\n          <h3>Expected DS Rules<\/h3>\n          <ul class=\"muted\">\n            <li>DS-BOE-001: labor line missing hours or rate<\/li>\n            <li>DS-BOE-002: rate outlier &gt; $250/hr<\/li>\n            <li>DS-BOE-003: hours outlier &gt; 2,000 hrs/position/year<\/li>\n            <li>DS-BOE-004: missing assumptions for rates/escalation/productivity<\/li>\n          <\/ul>\n        <\/div>\n      <\/div>\n    <\/section>\n  <\/div>\n<\/main>\n\n<input id=\"fileImport\" type=\"file\" accept=\"application/json\" class=\"hidden\"/>\n<script>\nconst KEY = \"ds_boe_pricing_v1\";\nconst RATE_OUTLIER_THRESHOLD = 250;\nconst HOURS_OUTLIER_THRESHOLD = 2000;\n\nfunction storageAvailable(){ try{ const x=\"__ds_test__\"; localStorage.setItem(x,x); localStorage.removeItem(x); return true; }catch(_){ return false; } }\nfunction getStoreItem(k){ if(storageAvailable()) return localStorage.getItem(k); window.__ds_memstore ||= {}; return window.__ds_memstore[k] || null; }\nfunction setStoreItem(k,v){ if(storageAvailable()) return localStorage.setItem(k,v); window.__ds_memstore ||= {}; window.__ds_memstore[k] = v; }\nfunction removeStoreItem(k){ if(storageAvailable()) return localStorage.removeItem(k); if(window.__ds_memstore) delete window.__ds_memstore[k]; }\n\nfunction nowIso(){ return new Date().toISOString(); }\nfunction today(){ return new Date().toISOString().slice(0,10); }\nfunction uid(prefix){ return `${prefix}-${Math.random().toString(16).slice(2,8).toUpperCase()}`; }\nfunction v(id){ return (document.getElementById(id)?.value || \"\").trim(); }\nfunction s(id,val){ const el=document.getElementById(id); if(el) el.value = val || \"\"; }\nfunction esc(x){ return String(x || \"\").replace(/[&<>\"']/g, m => ({\"&\":\"&amp;\",\"<\":\"&lt;\",\">\":\"&gt;\",\"\\\"\":\"&quot;\",\"'\":\"&#39;\"}[m])); }\nfunction n(x){ const t = Number(x); return Number.isFinite(t) ? t : 0; }\nfunction money(x){ return `$${n(x).toLocaleString(undefined,{maximumFractionDigits:2,minimumFractionDigits:2})}`; }\nfunction safeFile(sv){ return (sv||\"\").replace(/[^a-z0-9_\\-]+/gi,\"_\").replace(/_+/g,\"_\").replace(/^_+|_+$/g,\"\"); }\nfunction strToUtf8Bytes(s){ return new TextEncoder().encode(s); }\n\nfunction emptyDb(){\n  return {\n    intake: {\n      opp_id:\"\", title:\"\", customer:\"\", contract_type:\"FFP\", pop:\"\", locations:\"\", escalation_policy:\"\", fringe_pct:0, overhead_pct:0, ga_pct:0, margin_band:\"\"\n    },\n    labor: [],\n    assumptions: [],\n    risk_model: {\n      hours: {best:0.9, base:1.0, worst:1.15},\n      rate: {best:0.98, base:1.0, worst:1.05},\n      sensitivity: {escalation:true, surge:false, clearance:false}\n    },\n    approval: {approvers:\"\", authority_note:\"\", decision_note:\"\", sealed:false, sealed_at:null},\n    meta: {created:nowIso(), version:\"1.0\"}\n  };\n}\nfunction load(){\n  const raw = getStoreItem(KEY);\n  if(!raw){ const db = emptyDb(); setStoreItem(KEY, JSON.stringify(db)); return db; }\n  try{\n    const db = JSON.parse(raw);\n    db.intake ||= emptyDb().intake;\n    db.labor ||= [];\n    db.assumptions ||= [];\n    db.risk_model ||= emptyDb().risk_model;\n    db.approval ||= emptyDb().approval;\n    db.meta ||= {created:nowIso(), version:\"1.0\"};\n    return db;\n  }catch(_){ const db = emptyDb(); setStoreItem(KEY, JSON.stringify(db)); return db; }\n}\nfunction save(db){ setStoreItem(KEY, JSON.stringify(db)); refreshAll(); }\n\nfunction setTab(tab){\n  [\"dashboard\",\"intake\",\"labor\",\"assumptions\",\"risk\",\"approval\",\"artifacts\",\"test\"].forEach(t=>{\n    const el=document.getElementById(`tab-${t}`); if(el) el.classList.toggle(\"hidden\", t!==tab);\n  });\n  document.querySelectorAll(\".tab\").forEach(b=> b.classList.toggle(\"active\", b.dataset.tab===tab));\n  try{ location.hash = \"#\" + tab; }catch(_){ }\n}\n\nfunction lineTotal(line){ return n(line.hours) * n(line.rate); }\nfunction aggregates(db){\n  const byPeriod = {}, byRole = {}, byLocation = {};\n  let hours = 0, price = 0;\n  db.labor.forEach(l=>{\n    const h=n(l.hours), r=n(l.rate), t=h*r;\n    hours += h; price += t;\n    byPeriod[l.period||\"(unset)\"] = (byPeriod[l.period||\"(unset)\"] || 0) + t;\n    byRole[l.role||\"(unset)\"] = (byRole[l.role||\"(unset)\"] || 0) + t;\n    byLocation[l.location||\"(unset)\"] = (byLocation[l.location||\"(unset)\"] || 0) + t;\n  });\n  return {hours, price, byPeriod, byRole, byLocation};\n}\n\nfunction computeRiskBandTotals(db){\n  const agg = aggregates(db);\n  const rm = db.risk_model;\n  const sensHours = rm.sensitivity.surge ? 1.08 : 1.0;\n  const sensRates = (rm.sensitivity.clearance ? 1.04 : 1.0) * (rm.sensitivity.escalation ? 1.03 : 1.0);\n  const mk = (hM,rM)=> agg.price * hM * rM * sensHours * sensRates;\n  return {\n    best: mk(n(rm.hours.best), n(rm.rate.best)),\n    base: mk(n(rm.hours.base), n(rm.rate.base)),\n    worst: mk(n(rm.hours.worst), n(rm.rate.worst)),\n    delta_best_vs_base: mk(n(rm.hours.best), n(rm.rate.best)) - mk(n(rm.hours.base), n(rm.rate.base)),\n    delta_worst_vs_base: mk(n(rm.hours.worst), n(rm.rate.worst)) - mk(n(rm.hours.base), n(rm.rate.base))\n  };\n}\n\nfunction computeAutoDs(db){\n  const alerts = [];\n  const missing = db.labor.filter(l=>!(n(l.hours)>0) || !(n(l.rate)>0));\n  if(missing.length){ alerts.push({code:\"DS-BOE-001\", msg:`Labor lines missing hours or rate: ${missing.length}`}); }\n\n  const rateOut = db.labor.filter(l=>n(l.rate) > RATE_OUTLIER_THRESHOLD);\n  if(rateOut.length){ alerts.push({code:\"DS-BOE-002\", msg:`Rate outliers above $${RATE_OUTLIER_THRESHOLD}/hr: ${rateOut.length}`}); }\n\n  const hoursOut = db.labor.filter(l=>n(l.hours) > HOURS_OUTLIER_THRESHOLD);\n  if(hoursOut.length){ alerts.push({code:\"DS-BOE-003\", msg:`Hours outliers above ${HOURS_OUTLIER_THRESHOLD}: ${hoursOut.length}`}); }\n\n  const cats = new Set(db.assumptions.map(a=>String(a.category||\"\").toLowerCase()));\n  const missingDrivers = [\"rates\",\"escalation\",\"productivity\"].filter(c=>!cats.has(c));\n  if(missingDrivers.length){ alerts.push({code:\"DS-BOE-004\", msg:`Missing assumptions for key drivers: ${missingDrivers.join(\", \")}`}); }\n\n  return alerts.map(a=>({time:nowIso(), code:a.code, msg:a.msg, patch:\"Review BOE model + add patch note\"}));\n}\n\nfunction boeCompleteness(db){\n  const checks = [];\n  checks.push(!!db.intake.opp_id);\n  checks.push(!!db.intake.customer);\n  checks.push(!!db.intake.contract_type);\n  checks.push(db.labor.length > 0);\n  checks.push(db.labor.every(l=>n(l.hours)>0 && n(l.rate)>0 && !!l.role));\n  checks.push(db.assumptions.length > 0);\n  checks.push(!!db.approval.approvers);\n  const pass = checks.filter(Boolean).length;\n  return Math.round((pass/checks.length)*1000)/10;\n}\n\nfunction saveIntake(){\n  const db = load();\n  db.intake.opp_id = v(\"iOppId\");\n  db.intake.title = v(\"iTitle\");\n  db.intake.customer = v(\"iCustomer\");\n  db.intake.contract_type = v(\"iContract\") || \"FFP\";\n  db.intake.pop = v(\"iPop\");\n  db.intake.locations = v(\"iLocations\");\n  db.intake.escalation_policy = v(\"iEscalation\");\n  db.intake.fringe_pct = n(v(\"iFringe\"));\n  db.intake.overhead_pct = n(v(\"iOverhead\"));\n  db.intake.ga_pct = n(v(\"iGa\"));\n  db.intake.margin_band = v(\"iMarginBand\");\n  save(db);\n  document.getElementById(\"iHint\").textContent = \"Intake saved.\";\n}\n\nfunction saveLabor(){\n  const db = load();\n  const id = v(\"lId\") || `LINE-${String(db.labor.length+1).padStart(3,\"0\")}`;\n  const row = {\n    id,\n    role: v(\"lRole\"),\n    location: v(\"lLocation\"),\n    clearance: v(\"lClearance\"),\n    hours: n(v(\"lHours\")),\n    rate: n(v(\"lRate\")),\n    period: v(\"lPeriod\") || \"Base\",\n    rate_type: v(\"lRateType\") || \"loaded\",\n    notes: v(\"lNotes\"),\n    created: db.labor.find(x=>x.id===id)?.created || nowIso(),\n    updated: nowIso()\n  };\n  const i = db.labor.findIndex(x=>x.id===id);\n  if(i>=0) db.labor[i]=row; else db.labor.push(row);\n  save(db);\n  document.getElementById(\"lHint\").textContent = `Saved ${id}`;\n}\nfunction clearLabor(){ [\"lId\",\"lRole\",\"lLocation\",\"lClearance\",\"lHours\",\"lRate\",\"lPeriod\",\"lNotes\"].forEach(x=>s(x,\"\")); s(\"lRateType\",\"loaded\"); }\nfunction editLabor(id){ const r = load().labor.find(x=>x.id===id); if(!r) return; s(\"lId\",r.id); s(\"lRole\",r.role); s(\"lLocation\",r.location); s(\"lClearance\",r.clearance); s(\"lHours\",String(r.hours||\"\")); s(\"lRate\",String(r.rate||\"\")); s(\"lPeriod\",r.period); s(\"lRateType\",r.rate_type); s(\"lNotes\",r.notes); setTab(\"labor\"); }\nfunction deleteLabor(id){ if(!confirm(\"Delete labor line?\")) return; const db=load(); db.labor=db.labor.filter(x=>x.id!==id); save(db); }\n\nfunction saveAssumption(){\n  const db = load();\n  const rec = {\n    id: uid(\"ASM\"),\n    text: v(\"aText\"),\n    category: v(\"aCat\") || \"rates\",\n    confidence: v(\"aConfidence\") || \"Med\",\n    expiry: v(\"aExpiry\"),\n    disconfirmers: v(\"aDis\"),\n    created: nowIso()\n  };\n  if(!rec.text) return alert(\"Assumption text required.\");\n  db.assumptions.push(rec);\n  save(db);\n  [\"aText\",\"aExpiry\",\"aDis\"].forEach(x=>s(x,\"\")); s(\"aCat\",\"rates\"); s(\"aConfidence\",\"Med\");\n}\n\nfunction saveRiskModel(){\n  const db = load();\n  db.risk_model.hours.best = n(v(\"rbHoursBest\"));\n  db.risk_model.hours.base = n(v(\"rbHoursBase\"));\n  db.risk_model.hours.worst = n(v(\"rbHoursWorst\"));\n  db.risk_model.rate.best = n(v(\"rbRateBest\"));\n  db.risk_model.rate.base = n(v(\"rbRateBase\"));\n  db.risk_model.rate.worst = n(v(\"rbRateWorst\"));\n  db.risk_model.sensitivity.escalation = v(\"rbEscalation\") === \"true\";\n  db.risk_model.sensitivity.surge = v(\"rbSurge\") === \"true\";\n  db.risk_model.sensitivity.clearance = v(\"rbClearance\") === \"true\";\n  save(db);\n}\n\nfunction saveApproval(){\n  const db = load();\n  db.approval.approvers = v(\"apApprovers\");\n  db.approval.authority_note = v(\"apAuthority\");\n  db.approval.decision_note = v(\"apDecision\");\n  const seal = v(\"apSeal\") === \"true\";\n  db.approval.sealed = seal;\n  db.approval.sealed_at = seal ? nowIso() : null;\n  save(db);\n  document.getElementById(\"apHint\").textContent = \"Approval saved.\";\n}\n\nfunction renderDashboard(){\n  const db=load();\n  const agg = aggregates(db);\n  const ds = computeAutoDs(db);\n  const missing = db.labor.filter(l=>!(n(l.hours)>0) || !(n(l.rate)>0)).length;\n  const rateOut = db.labor.filter(l=>n(l.rate) > RATE_OUTLIER_THRESHOLD).length;\n  const hoursOut = db.labor.filter(l=>n(l.hours) > HOURS_OUTLIER_THRESHOLD).length;\n  const riskScore = Math.min(100, (ds.length*20) + (rateOut*3) + (hoursOut*2));\n\n  document.getElementById(\"kHours\").textContent = String(Math.round(agg.hours));\n  document.getElementById(\"kPrice\").textContent = money(agg.price);\n  document.getElementById(\"kMargin\").textContent = db.intake.margin_band || \"-\";\n  document.getElementById(\"kRisk\").textContent = String(Math.round(riskScore));\n  document.getElementById(\"kDs\").textContent = String(ds.length);\n  document.getElementById(\"kComplete\").textContent = `${boeCompleteness(db)}%`;\n  document.getElementById(\"kAssumptions\").textContent = String(db.assumptions.length);\n  document.getElementById(\"kRateOut\").textContent = String(rateOut);\n  document.getElementById(\"kHoursOut\").textContent = String(hoursOut);\n  document.getElementById(\"kMissing\").textContent = String(missing);\n  document.getElementById(\"dashDs\").innerHTML = ds.length ? ds.map(x=>`<div><span class=\"pill\">${esc(x.code)}<\/span> ${esc(x.msg)}<\/div>`).join(\"\") : \"No DS alerts.\";\n}\n\nfunction renderIntake(){\n  const db=load();\n  s(\"iOppId\",db.intake.opp_id); s(\"iTitle\",db.intake.title); s(\"iCustomer\",db.intake.customer); s(\"iContract\",db.intake.contract_type);\n  s(\"iPop\",db.intake.pop); s(\"iLocations\",db.intake.locations); s(\"iEscalation\",db.intake.escalation_policy);\n  s(\"iFringe\",String(db.intake.fringe_pct||\"\")); s(\"iOverhead\",String(db.intake.overhead_pct||\"\")); s(\"iGa\",String(db.intake.ga_pct||\"\")); s(\"iMarginBand\",db.intake.margin_band);\n  document.getElementById(\"iPreview\").textContent = JSON.stringify(db.intake, null, 2);\n}\nfunction renderLabor(){\n  const db=load();\n  const el=document.getElementById(\"laborTable\");\n  if(!db.labor.length){ el.innerHTML = \"<div class='muted'>No labor lines yet.<\/div>\"; }\n  else {\n    el.innerHTML = `<table><thead><tr><th>ID<\/th><th>Role<\/th><th>Location<\/th><th>Clr<\/th><th>Hours<\/th><th>Rate<\/th><th>Period<\/th><th>Total<\/th><th><\/th><\/tr><\/thead><tbody>${db.labor.map(r=>`<tr>\n      <td class=\"mono\">${esc(r.id)}<\/td><td>${esc(r.role)}<\/td><td>${esc(r.location)}<\/td><td>${esc(r.clearance)}<\/td><td>${n(r.hours).toLocaleString()}<\/td><td>${money(r.rate)}<\/td><td>${esc(r.period)}<\/td><td>${money(lineTotal(r))}<\/td>\n      <td><button data-action=\"edit\" data-id=\"${esc(r.id)}\">Edit<\/button> <button class=\"danger\" data-action=\"del\" data-id=\"${esc(r.id)}\">Delete<\/button><\/td>\n    <\/tr>`).join(\"\")}<\/tbody><\/table>`;\n  }\n  const agg = aggregates(db);\n  document.getElementById(\"laborAgg\").textContent = JSON.stringify({\n    totals: {hours:agg.hours, price:agg.price},\n    by_period: agg.byPeriod,\n    by_role: agg.byRole,\n    by_location: agg.byLocation\n  }, null, 2);\n}\nfunction renderAssumptions(){\n  const db=load(); const el=document.getElementById(\"assumptionTable\");\n  if(!db.assumptions.length){ el.innerHTML = \"<div class='muted'>No assumptions yet.<\/div>\"; return; }\n  el.innerHTML = `<table><thead><tr><th>ID<\/th><th>Category<\/th><th>Confidence<\/th><th>Expiry<\/th><th>Assumption<\/th><\/tr><\/thead><tbody>${db.assumptions.slice().reverse().map(a=>`<tr>\n    <td class=\"mono\">${esc(a.id)}<\/td><td>${esc(a.category)}<\/td><td>${esc(a.confidence)}<\/td><td>${esc(a.expiry)}<\/td><td>${esc(a.text)}<\/td>\n  <\/tr>`).join(\"\")}<\/tbody><\/table>`;\n}\nfunction renderRisk(){\n  const db=load();\n  s(\"rbHoursBest\",String(db.risk_model.hours.best)); s(\"rbHoursBase\",String(db.risk_model.hours.base)); s(\"rbHoursWorst\",String(db.risk_model.hours.worst));\n  s(\"rbRateBest\",String(db.risk_model.rate.best)); s(\"rbRateBase\",String(db.risk_model.rate.base)); s(\"rbRateWorst\",String(db.risk_model.rate.worst));\n  s(\"rbEscalation\",String(!!db.risk_model.sensitivity.escalation)); s(\"rbSurge\",String(!!db.risk_model.sensitivity.surge)); s(\"rbClearance\",String(!!db.risk_model.sensitivity.clearance));\n  const bands = computeRiskBandTotals(db);\n  document.getElementById(\"riskPreview\").textContent = JSON.stringify({\n    model: db.risk_model,\n    totals: bands,\n    base_price: aggregates(db).price,\n    delta_best_vs_base: bands.delta_best_vs_base,\n    delta_worst_vs_base: bands.delta_worst_vs_base\n  }, null, 2);\n}\nfunction renderApproval(){\n  const db=load();\n  s(\"apApprovers\", db.approval.approvers); s(\"apAuthority\", db.approval.authority_note); s(\"apDecision\", db.approval.decision_note); s(\"apSeal\", String(!!db.approval.sealed));\n  document.getElementById(\"approvalPreview\").textContent = JSON.stringify(db.approval, null, 2);\n}\n\nfunction applySafeToBoe(db){\n  const safe = (document.getElementById(\"safeExport\")?.value || \"false\") === \"true\";\n  const level = document.getElementById(\"safeExportLevel\")?.value || \"lite\";\n  const out = JSON.parse(JSON.stringify(db));\n  if(!safe) return out;\n\n  if(level === \"lite\"){\n    out.intake.customer = out.intake.customer ? \"(masked)\" : \"\";\n    out.intake.title = out.intake.title ? \"(masked)\" : \"\";\n    out.labor = out.labor.map(l=>({ ...l, notes: l.notes ? \"(masked)\" : \"\" }));\n    out.approval.authority_note = out.approval.authority_note ? \"(masked)\" : \"\";\n    out.approval.decision_note = out.approval.decision_note ? \"(masked)\" : \"\";\n  }else if(level === \"strict\"){\n    out.intake.customer = out.intake.customer ? \"(masked)\" : \"\";\n    out.intake.title = out.intake.title ? \"(masked)\" : \"\";\n    out.intake.locations = \"\";\n    out.intake.escalation_policy = \"\";\n    out.labor = out.labor.map(l=>({\n      id: l.id, role: \"(stripped)\", location: \"(stripped)\", clearance: \"(stripped)\", hours: n(l.hours), rate: n(l.rate), period: l.period, rate_type: l.rate_type, notes: \"\"\n    }));\n    out.assumptions = out.assumptions.map(a=>({id:a.id, category:a.category, confidence:a.confidence, expiry:a.expiry, text:\"\", disconfirmers:\"\"}));\n    out.approval.authority_note = \"\";\n    out.approval.decision_note = \"\";\n    out.approval.approvers = out.approval.approvers ? \"(masked)\" : \"\";\n  }\n  return out;\n}\n\nfunction dsMarkdown(ds){\n  return `# DS Pricing - ${today()}\\n\\n## Auto Alerts\\n${ds.length ? ds.map(d=>`- **${d.code}** (${d.time}) - ${d.msg}`).join(\"\\\\n\") : \"- None\"}\\n`;\n}\nfunction dlrMarkdown(db, meta){\n  const agg = aggregates(db);\n  return `# DLR BOE Assumptions\\n**Program:** ${meta.program}  \\n**Generated:** ${meta.generated}  \\n\\n## Intake\\n- Opp ID: ${db.intake.opp_id || \"(unset)\"}\\n- Contract Type: ${db.intake.contract_type || \"(unset)\"}\\n- POP: ${db.intake.pop || \"(unset)\"}\\n\\n## Totals\\n- Labor Hours: ${Math.round(agg.hours)}\\n- Base Price: ${money(agg.price)}\\n\\n## Approval\\n- Approvers: ${db.approval.approvers || \"(unset)\"}\\n- Sealed: ${db.approval.sealed ? \"true\" : \"false\"}\\n- Sealed At: ${db.approval.sealed_at || \"(none)\"}\\n\\n## Assumption Count\\n- ${db.assumptions.length}\\n`;\n}\n\nfunction crc32(buf){ let c = 0 ^ (-1); for(let i=0;i<buf.length;i++) c = (c>>>8) ^ CRC_TABLE[(c ^ buf[i]) & 0xFF]; return (c ^ (-1)) >>> 0; }\nconst CRC_TABLE = (()=>{ const t=new Uint32Array(256); for(let i=0;i<256;i++){ let c=i; for(let k=0;k<8;k++) c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1); t[i]=c>>>0; } return t; })();\nfunction u16(n){ return [n & 0xFF, (n>>>8)&0xFF]; }\nfunction u32(n){ return [n & 0xFF, (n>>>8)&0xFF, (n>>>16)&0xFF, (n>>>24)&0xFF]; }\nfunction buildZip(entries){\n  const fileParts=[]; const central=[]; let offset=0;\n  for(const e of entries){\n    const nameBytes=strToUtf8Bytes(e.name), data=e.bytes, crc=crc32(data), size=data.length;\n    const dt=e.mtime||new Date();\n    const dosTime=((dt.getHours()&0x1F)<<11)|((dt.getMinutes()&0x3F)<<5)|((Math.floor(dt.getSeconds()/2))&0x1F);\n    const dosDate=(((dt.getFullYear()-1980)&0x7F)<<9)|(((dt.getMonth()+1)&0x0F)<<5)|(dt.getDate()&0x1F);\n    const local=[...u32(0x04034b50),...u16(20),...u16(0),...u16(0),...u16(dosTime),...u16(dosDate),...u32(crc),...u32(size),...u32(size),...u16(nameBytes.length),...u16(0)];\n    fileParts.push(new Uint8Array(local), nameBytes, data);\n    const c=[...u32(0x02014b50),...u16(0x0314),...u16(20),...u16(0),...u16(0),...u16(dosTime),...u16(dosDate),...u32(crc),...u32(size),...u32(size),...u16(nameBytes.length),...u16(0),...u16(0),...u16(0),...u16(0),...u32(0),...u32(offset)];\n    central.push(new Uint8Array(c), nameBytes);\n    offset += local.length + nameBytes.length + size;\n  }\n  const centralStart=offset;\n  for(const p of central){ fileParts.push(p); offset += p.length; }\n  const centralSize=offset-centralStart;\n  const eocd=[...u32(0x06054b50),...u16(0),...u16(0),...u16(entries.length),...u16(entries.length),...u32(centralSize),...u32(centralStart),...u16(0)];\n  fileParts.push(new Uint8Array(eocd));\n  return new Blob(fileParts,{type:\"application/zip\"});\n}\nasync function sha256Hex(bytes){ const out = await crypto.subtle.digest(\"SHA-256\", bytes.buffer ? bytes.buffer : bytes); return Array.from(new Uint8Array(out)).map(b=>b.toString(16).padStart(2,\"0\")).join(\"\"); }\n\nasync function createZipPackPayload(){\n  const db = load();\n  const safe = (document.getElementById(\"safeExport\")?.value || \"false\") === \"true\";\n  const level = document.getElementById(\"safeExportLevel\")?.value || \"lite\";\n  const meta = {\n    prefix: v(\"packPrefix\") || \"SEQUOIA\",\n    program: v(\"orgProgram\") || \"NGA - SEQUOIA\",\n    steward: v(\"cohSteward\") || \"Pricing Steward\",\n    generated: nowIso(),\n    date: today(),\n    safe_export: safe,\n    safe_export_level: level,\n    version: \"1.0\"\n  };\n  const root = `${safeFile(meta.prefix)}_BOEPack_${meta.date}`;\n  const entries = []; const ts = new Date();\n  const addJson = (path,obj)=>{ const bytes=strToUtf8Bytes(JSON.stringify(obj,null,2)); entries.push({name:`${root}/${path}`, bytes, mtime:ts}); return bytes; };\n  const addText = (path,text)=>{ const bytes=strToUtf8Bytes(text); entries.push({name:`${root}/${path}`, bytes, mtime:ts}); return bytes; };\n\n  const ds = computeAutoDs(db);\n  const safeBoe = applySafeToBoe(db);\n  const riskBands = computeRiskBandTotals(db);\n  addJson(`boe/BOE_${safeFile(db.intake.opp_id || \"OPP\")}.json`, {\n    schema: \"deepsigma_boe_v1\",\n    meta,\n    intake: safeBoe.intake,\n    labor: safeBoe.labor,\n    assumptions: safeBoe.assumptions,\n    risk_model: safeBoe.risk_model,\n    risk_bands: riskBands,\n    approval: safeBoe.approval\n  });\n  addText(`dlr/DLR_BOE_ASSUMPTIONS_${safeFile(db.intake.opp_id || \"OPP\")}.md`, dlrMarkdown(safeBoe, meta));\n  addText(`ds/DS_PRICING_${meta.date}.md`, dsMarkdown(ds));\n\n  const manifest = {\n    schema: \"deepsigma_ingest_manifest_v1\",\n    meta,\n    counts: {\n      labor_lines: db.labor.length,\n      assumptions: db.assumptions.length,\n      ds_auto: ds.length\n    },\n    hashes_file: \"hashes.json\"\n  };\n  const hashes = {};\n  for(const e of entries) hashes[e.name] = await sha256Hex(e.bytes);\n  const material = strToUtf8Bytes(Object.entries(hashes).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,val])=>`${k} ${val}`).join(\"\\n\"));\n  const pack_hash = await sha256Hex(material);\n  manifest.pack_hash = pack_hash;\n\n  addJson(\"ingest_manifest.json\", manifest);\n  addJson(\"hashes.json\", {pack_hash, hashes});\n  addText(\"README.md\", `# ${meta.prefix} BOE Pack\\nProgram: ${meta.program}\\nGenerated: ${meta.generated}\\nSafe export: ${meta.safe_export} (${meta.safe_export_level})\\n`);\n\n  return {root, manifest, zipBlob: buildZip(entries)};\n}\n\nasync function downloadZipPack(){\n  const {root, manifest, zipBlob} = await createZipPackPayload();\n  document.getElementById(\"preview\").textContent = JSON.stringify(manifest, null, 2);\n  const a = document.createElement(\"a\");\n  a.href = URL.createObjectURL(zipBlob);\n  a.download = `${root}.zip`;\n  a.click();\n}\n\nfunction tmLog(msg){ const el=document.getElementById(\"tmLog\"); if(!el) return; el.textContent += `[${nowIso()}] ${msg}\\n`; el.scrollTop = el.scrollHeight; }\nfunction tmResetAll(){ if(!confirm(\"Reset ALL local data?\")) return; removeStoreItem(KEY); load(); refreshAll(); document.getElementById(\"tmLog\").textContent=\"\"; tmLog(\"Reset complete.\"); }\nfunction tmRunAll(){\n  const db = load();\n  db.intake = {\n    opp_id: \"OPP-TEST-BOE-001\",\n    title: \"Sample Mission Services Pursuit\",\n    customer: \"Sample Agency\",\n    contract_type: \"FFP\",\n    pop: \"Base + 4 Option Years\",\n    locations: \"Arlington, VA\\nSan Antonio, TX\",\n    escalation_policy: \"3% annual\",\n    fringe_pct: 31,\n    overhead_pct: 24,\n    ga_pct: 11,\n    margin_band: \"Best 15% / Base 11% / Worst 8%\"\n  };\n  db.labor = [];\n  const lineCount = 20 + Math.floor(Math.random()*41);\n  const roles = [\"PM\",\"Deputy PM\",\"Systems Engineer\",\"Cyber Analyst\",\"Data Scientist\",\"DevSecOps Engineer\",\"Trainer\",\"Field Service Rep\"];\n  const locs = [\"Arlington, VA\",\"San Antonio, TX\",\"Huntsville, AL\",\"Remote\"];\n  const periods = [\"Base\",\"Option1\",\"Option2\",\"Option3\",\"Option4\"];\n  for(let i=1;i<=lineCount;i++){\n    db.labor.push({\n      id: `LINE-${String(i).padStart(3,\"0\")}`,\n      role: roles[i%roles.length],\n      location: locs[i%locs.length],\n      clearance: i%3===0 ? \"TS-SCI\" : \"Secret\",\n      hours: 900 + ((i*47)%900),\n      rate: 120 + ((i*9)%95),\n      period: periods[i%periods.length],\n      rate_type: \"loaded\",\n      notes: i%5===0 ? \"Shift overlap + transition support\" : \"\",\n      created: nowIso(),\n      updated: nowIso()\n    });\n  }\n  if(db.labor[2]) db.labor[2].rate = 312;\n  if(db.labor[7]) db.labor[7].hours = 2350;\n  if(db.labor[10]) db.labor[10].rate = 0;\n\n  db.assumptions = [\n    {id:uid(\"ASM\"), text:\"Historical loaded rates anchored to FY25 awarded rates.\", category:\"rates\", confidence:\"Med\", expiry:today(), disconfirmers:\"Awarded labor category mapping changes\", created:nowIso()},\n    {id:uid(\"ASM\"), text:\"Productivity uplift of 8% by month 4 from tooling standardization.\", category:\"productivity\", confidence:\"Low\", expiry:today(), disconfirmers:\"Onboarding delay >30 days\", created:nowIso()}\n  ];\n  db.risk_model = {\n    hours: {best:0.9, base:1.0, worst:1.15},\n    rate: {best:0.98, base:1.0, worst:1.05},\n    sensitivity: {escalation:true, surge:true, clearance:true}\n  };\n  db.approval = {approvers:\"Pricing Lead; Capture Exec\", authority_note:\"Pricing board authority under capture policy.\", decision_note:\"Proceed with base and high-confidence options.\", sealed:true, sealed_at:nowIso()};\n  save(db);\n\n  const ds = computeAutoDs(db);\n  tmLog(`Generated sample BOE with ${lineCount} lines.`);\n  tmLog(`Injected outliers: rate>${RATE_OUTLIER_THRESHOLD}, hours>${HOURS_OUTLIER_THRESHOLD}, missing rate.`);\n  tmLog(`Auto DS count: ${ds.length}`);\n}\n\nfunction bindEvents(){\n  document.querySelectorAll(\".tab\").forEach(b=>b.addEventListener(\"click\", ()=>setTab(b.dataset.tab)));\n  document.getElementById(\"btnIntakeSave\")?.addEventListener(\"click\", saveIntake);\n  document.getElementById(\"btnLSave\")?.addEventListener(\"click\", saveLabor);\n  document.getElementById(\"btnLClear\")?.addEventListener(\"click\", clearLabor);\n  document.getElementById(\"laborTable\")?.addEventListener(\"click\", (e)=>{\n    const b=e.target.closest(\"button\"); if(!b) return;\n    if(b.dataset.action===\"edit\") editLabor(b.dataset.id);\n    if(b.dataset.action===\"del\") deleteLabor(b.dataset.id);\n  });\n  document.getElementById(\"btnASave\")?.addEventListener(\"click\", saveAssumption);\n  document.getElementById(\"btnRiskSave\")?.addEventListener(\"click\", saveRiskModel);\n  document.getElementById(\"btnApprovalSave\")?.addEventListener(\"click\", saveApproval);\n  document.getElementById(\"btnZipPack\")?.addEventListener(\"click\", downloadZipPack);\n\n  document.getElementById(\"btnExport\")?.addEventListener(\"click\", ()=>{\n    const blob = new Blob([JSON.stringify(load(),null,2)], {type:\"application/json\"});\n    const a = document.createElement(\"a\"); a.href = URL.createObjectURL(blob); a.download = `boe_pricing_console_${today()}.json`; a.click();\n  });\n  document.getElementById(\"btnImport\")?.addEventListener(\"click\", ()=>document.getElementById(\"fileImport\")?.click());\n  document.getElementById(\"fileImport\")?.addEventListener(\"change\", (e)=>{\n    const file = e.target.files?.[0]; if(!file) return;\n    const reader = new FileReader();\n    reader.onload = ()=>{\n      try{\n        const db = JSON.parse(reader.result);\n        if(!db || typeof db !== \"object\" || Array.isArray(db)) throw new Error(\"Invalid root object\");\n        setStoreItem(KEY, JSON.stringify(db));\n        refreshAll();\n        alert(\"Imported.\");\n      }catch(err){ alert(`Invalid JSON: ${err.message || \"Import failed\"}`); }\n    };\n    reader.readAsText(file);\n  });\n  document.getElementById(\"btnReset\")?.addEventListener(\"click\", tmResetAll);\n\n  document.getElementById(\"tmRunAll\")?.addEventListener(\"click\", tmRunAll);\n  document.getElementById(\"tmDownloadZip\")?.addEventListener(\"click\", downloadZipPack);\n  document.getElementById(\"tmReset\")?.addEventListener(\"click\", tmResetAll);\n}\n\nfunction refreshAll(){\n  renderDashboard();\n  renderIntake();\n  renderLabor();\n  renderAssumptions();\n  renderRisk();\n  renderApproval();\n}\n\n(function init(){\n  load();\n  bindEvents();\n  refreshAll();\n  const h = (location.hash||\"\").replace(\"#\",\"\").trim();\n  const valid = [\"dashboard\",\"intake\",\"labor\",\"assumptions\",\"risk\",\"approval\",\"artifacts\",\"test\"];\n  if(valid.includes(h)) setTab(h); else setTab(\"dashboard\");\n})();\n<\/script>\n<\/body>\n<\/html>\n"}
  };

  let activeId = 'suite';
  const moduleFrames = {};

  const KEY_REGISTRY = {
    suite: [
      'ds_sequoia_suite_rollup_history_v1'
    ],
    hiring: [
      'ds_sequoia_hiring_console_v2_artifacts',
      'ds_sequoia_edge_cfg_v1',
      'ds_sequoia_edge_outbox_v1'
    ],
    bid: [
      'ds_bidnobid_console_v1',
      'ds_bidnobid_edge_cfg_v1',
      'ds_bidnobid_edge_outbox_v1',
      'ds_bidnobid_edge_audit_v1'
    ],
    compliance: [
      'ds_compliance_matrix_v1'
    ],
    boe: [
      'ds_boe_pricing_v1'
    ],
    abp: [
      'ds_abp_v1'
    ]
  };

  function renderKeyRegistry() {
    const out = [];
    Object.entries(KEY_REGISTRY).forEach(([mod, keys]) => {
      out.push(`${mod}:`);
      keys.forEach(k => out.push(`  - ${k}`));
    });
    const el = document.getElementById('keyRegistry');
    if (el) el.textContent = out.join('\\n');
  }

  const _jsonCache = {};
  let _jsonCacheTick = 0;
  function readJsonSafe(key) {
    // Cache per tick (invalidated each refresh cycle)
    const tick = _jsonCacheTick;
    const ck = tick + ':' + key;
    if (ck in _jsonCache) return _jsonCache[ck];
    try {
      const raw = localStorage.getItem(key);
      const val = raw ? JSON.parse(raw) : null;
      _jsonCache[ck] = val;
      return val;
    } catch (_) {
      _jsonCache[ck] = null;
      return null;
    }
  }
  function invalidateJsonCache() { _jsonCacheTick++; }

  function writeJsonSafe(key, val) {
    try { localStorage.setItem(key, JSON.stringify(val)); } catch (_) {}
  }

  function nowIsoHost() { return new Date().toISOString(); }
  function todayHost() { return new Date().toISOString().slice(0, 10); }
  function escapeHtml(s) {
    return String(s || '').replace(/[&<>"']/g, (m) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[m]));
  }

  async function loadJsZipHost() {
    if (window.JSZip) return window.JSZip;
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
      s.async = true;
      s.onload = resolve;
      s.onerror = () => reject(new Error('Failed to load JSZip.'));
      document.head.appendChild(s);
    });
    if (!window.JSZip) throw new Error('JSZip unavailable after load.');
    return window.JSZip;
  }

  async function unzipEntriesHost(zipFile) {
    const JSZip = await loadJsZipHost();
    const zip = await JSZip.loadAsync(zipFile);
    const out = [];
    for (const name of Object.keys(zip.files)) {
      const f = zip.files[name];
      if (f.dir) continue;
      const text = await f.async('string');
      out.push({ name, text });
    }
    return out;
  }

  function findJsonHost(entries, predicate) {
    const e = entries.find((x) => predicate(String(x.name || '').toLowerCase()));
    if (!e) return null;
    try { return JSON.parse(e.text); } catch (_) { return null; }
  }

  function importComplianceFromEntriesHost(entries) {
    const matrix = findJsonHost(entries, (n) => n.includes('/matrix/') && n.endsWith('_compliance_matrix.json'));
    if (!matrix || matrix.schema !== 'deepsigma_compliance_matrix_v1') return { imported: false };
    writeJsonSafe('ds_compliance_matrix_v1', {
      intake: matrix.intake || {},
      requirements: Array.isArray(matrix.requirements) ? matrix.requirements : [],
      deliverables: Array.isArray(matrix.deliverables) ? matrix.deliverables : [],
      gaps: Array.isArray(matrix.gaps) ? matrix.gaps : [],
      ds_manual: [],
      rs: [],
      meta: { created: nowIsoHost(), version: '1.0', imported_from: 'zip' }
    });
    return { imported: true, module: 'compliance' };
  }

  function importBoeFromEntriesHost(entries) {
    const boe = findJsonHost(entries, (n) => n.includes('/boe/') && n.includes('boe_') && n.endsWith('.json'));
    if (!boe || boe.schema !== 'deepsigma_boe_v1') return { imported: false };
    writeJsonSafe('ds_boe_pricing_v1', {
      intake: boe.intake || {},
      labor: Array.isArray(boe.labor) ? boe.labor : [],
      assumptions: Array.isArray(boe.assumptions) ? boe.assumptions : [],
      risk_model: boe.risk_model || { hours: { best: 0.9, base: 1, worst: 1.15 }, rate: { best: 0.98, base: 1, worst: 1.05 }, sensitivity: { escalation: true, surge: false, clearance: false } },
      approval: boe.approval || { approvers: '', authority_note: '', decision_note: '', sealed: false, sealed_at: null },
      meta: { created: nowIsoHost(), version: '1.0', imported_from: 'zip' }
    });
    return { imported: true, module: 'boe' };
  }

  function importBidFromEntriesHost(entries) {
    const mg = findJsonHost(entries, (n) => n.includes('/mg/') && n.includes('_mg_opportunitygraph_') && n.endsWith('.json'));
    if (!mg || !Array.isArray(mg.nodes)) return { imported: false };
    const assumptions = findJsonHost(entries, (n) => n.includes('/assumptions/') && n.includes('_assumptions_') && n.endsWith('.json'));
    const risks = findJsonHost(entries, (n) => n.includes('/risks/') && n.includes('_risks_') && n.endsWith('.json'));
    const manifest = findJsonHost(entries, (n) => n.endsWith('/ingest_manifest.json'));
    const oppNode = mg.nodes.find((n) => n && n.type === 'opportunity') || {};
    const decNode = mg.nodes.find((n) => n && n.type === 'decision') || null;
    const oppId = manifest?.opportunity_id || oppNode.id || (Array.isArray(assumptions) && assumptions[0]?.opp_id) || `OPP-${todayHost()}`;

    const existing = readJsonSafe('ds_bidnobid_console_v1');
    const db = (existing && typeof existing === 'object') ? existing : { opportunities: [], assumptions: [], risks: [], drift: [], rs: [], meta: { created: nowIsoHost(), version: '1.0' } };
    db.opportunities = Array.isArray(db.opportunities) ? db.opportunities : [];
    db.assumptions = Array.isArray(db.assumptions) ? db.assumptions : [];
    db.risks = Array.isArray(db.risks) ? db.risks : [];
    const opp = {
      id: String(oppId),
      customer: String(oppNode.customer || ''),
      office: '',
      vehicle: String(oppNode.vehicle || ''),
      naics: '',
      value_band: String(oppNode.value_band || ''),
      pop: '',
      dates: { rfi: '', rfp: '', q_due: '', due: '', award_est: '' },
      competitors: '',
      security_needs: '',
      score: { scores: { strategic_fit: 0, customer_access: 0, capability_fit: 0, past_perf: 0, capacity_staffing: 0, differentiation: 0, price_margin: 0, risk_complexity: 0 }, total: 0, recommendation: 'Watch', updated: nowIsoHost() },
      decision: decNode ? { value: String(decNode.value || 'Watch'), approver: '', authority: '', rationale: 'Imported from ZIP', sealed: !!decNode.sealed, seal: decNode.sealed ? `${nowIsoHost()}|zip-import` : null, updated: nowIsoHost() } : null,
      created: nowIsoHost(),
      updated: nowIsoHost()
    };
    const oi = db.opportunities.findIndex((x) => String(x?.id) === opp.id);
    if (oi >= 0) db.opportunities[oi] = { ...db.opportunities[oi], ...opp, updated: nowIsoHost() };
    else db.opportunities.push(opp);
    if (Array.isArray(assumptions)) {
      assumptions.forEach((a) => {
        const rec = { ...a, opp_id: a?.opp_id || opp.id, id: a?.id || `ASM-${Math.random().toString(16).slice(2, 8).toUpperCase()}`, created: a?.created || nowIsoHost() };
        if (!db.assumptions.find((x) => String(x?.id) === String(rec.id))) db.assumptions.push(rec);
      });
    }
    if (Array.isArray(risks)) {
      risks.forEach((r) => {
        const rec = { ...r, opp_id: r?.opp_id || opp.id, id: r?.id || `RISK-${Math.random().toString(16).slice(2, 8).toUpperCase()}`, created: r?.created || nowIsoHost() };
        if (!db.risks.find((x) => String(x?.id) === String(rec.id))) db.risks.push(rec);
      });
    }
    db.meta = { ...(db.meta || {}), version: '1.0', imported_from: 'zip', updated: nowIsoHost() };
    writeJsonSafe('ds_bidnobid_console_v1', db);
    return { imported: true, module: 'bid' };
  }

  async function importModuleZipHost() {
    const input = document.getElementById('hostZipImportFile');
    const out = document.getElementById('hostZipImportResult');
    const zf = input?.files?.[0];
    if (!zf) {
      if (out) out.textContent = 'Select a ZIP file first.';
      return;
    }
    try {
      const entries = await unzipEntriesHost(zf);
      const results = [];
      const compliance = importComplianceFromEntriesHost(entries); if (compliance.imported) results.push(compliance);
      const boe = importBoeFromEntriesHost(entries); if (boe.imported) results.push(boe);
      const bid = importBidFromEntriesHost(entries); if (bid.imported) results.push(bid);
      if (!results.length) {
        if (out) out.textContent = JSON.stringify({ schema: 'deepsigma_zip_import_v1', generated_at: nowIsoHost(), file: zf.name, imported: false, message: 'No compatible Bid/Compliance/BOE payload found in ZIP.' }, null, 2);
        return;
      }
      if (out) out.textContent = JSON.stringify({ schema: 'deepsigma_zip_import_v1', generated_at: nowIsoHost(), file: zf.name, imported: true, modules: results }, null, 2);
      renderUtilityEdgeStatus();
      renderUtilitySchemaStatus();
      hostRollup();
      refreshSuiteFrame();
    } catch (err) {
      if (out) out.textContent = `ZIP import failed: ${err.message || err}`;
    }
  }

  function renderUtilityEdgeStatus() {
    const hiringOutbox = readJsonSafe('ds_sequoia_edge_outbox_v1');
    const bidOutbox = readJsonSafe('ds_bidnobid_edge_outbox_v1');
    const hiringCfg = readJsonSafe('ds_sequoia_edge_cfg_v1');
    const bidCfg = readJsonSafe('ds_bidnobid_edge_cfg_v1');
    const lines = [
      `hiring_outbox=${Array.isArray(hiringOutbox) ? hiringOutbox.length : 0}`,
      `bid_outbox=${Array.isArray(bidOutbox) ? bidOutbox.length : 0}`,
      `hiring_cfg=${hiringCfg ? 'present' : 'missing'}`,
      `bid_cfg=${bidCfg ? 'present' : 'missing'}`
    ];
    const el = document.getElementById('utilityEdgeStatus');
    if (el) el.textContent = lines.join(' | ');
  }

  function renderUtilitySchemaStatus() {
    const checks = [
      ['hiring', readJsonSafe('ds_sequoia_hiring_console_v2_artifacts')],
      ['bid', readJsonSafe('ds_bidnobid_console_v1')],
      ['compliance', readJsonSafe('ds_compliance_matrix_v1')],
      ['boe', readJsonSafe('ds_boe_pricing_v1')]
    ];
    const status = checks.map(([name, data]) => `${name}:${data ? 'ok' : 'missing'}`).join(' | ');
    const el = document.getElementById('utilitySchemaStatus');
    if (el) el.textContent = status;
  }

  function moveSuitePanelsToUtility() {
    const frame = moduleFrames.suite;
    const doc = frame?.contentWindow?.document;
    if (!doc) return;
    const titlesToMove = new Set(['Storage Keys', 'Edge Transport Status', 'Schema Compatibility']);
    const headings = doc.querySelectorAll('aside .panel h3');
    headings.forEach((h) => {
      const title = (h.textContent || '').trim();
      if (!titlesToMove.has(title)) return;
      const panel = h.closest('.panel');
      if (panel) panel.remove();
    });

    const rollupTitle = Array.from(doc.querySelectorAll('.panel h3')).find((h) =>
      (h.textContent || '').trim().startsWith('Suite Rollup JSON')
    );
    if (rollupTitle) {
      const leftCol = rollupTitle.closest('div');
      const splitPanel = rollupTitle.closest('.panel.split');
      // Preserve rollupPreview  KPI strip reads from it
      const rp = leftCol?.querySelector('#rollupPreview');
      if (rp && leftCol) {
        rp.style.display = 'none';
        leftCol.parentNode?.insertBefore(rp, leftCol);
      }
      if (leftCol) leftCol.remove();
      if (splitPanel) splitPanel.classList.remove('split');
    }

    const viewerAlert = Array.from(doc.querySelectorAll('.panel.alert')).find((el) =>
      (el.textContent || '').includes('Embedded viewer is intentionally inert')
    );
    if (viewerAlert) viewerAlert.remove();

    const verifyHeading = Array.from(doc.querySelectorAll('.panel h3')).find((h) =>
      (h.textContent || '').trim().startsWith('Evidence Integrity Verifier')
    );
    if (verifyHeading) {
      const verifyPanel = verifyHeading.closest('div');
      const verifyDesc = verifyHeading.nextElementSibling;
      if (verifyDesc && verifyDesc.tagName === 'P') verifyDesc.remove();
      const manifestInput = doc.getElementById('manifestFile');
      const verifyRow = manifestInput?.closest('.row');
      if (verifyRow) verifyRow.remove();
      const verifyResult = doc.getElementById('verifyResult');
      if (verifyResult) verifyResult.remove();
      verifyHeading.remove();
      if (verifyPanel && !verifyPanel.querySelector('h3')) verifyPanel.remove();
    }

    const zipHeading = Array.from(doc.querySelectorAll('.panel h3')).find((h) =>
      (h.textContent || '').trim().startsWith('ZIP Import (Bid/Compliance/BOE)')
    );
    if (zipHeading) {
      const zipPanel = zipHeading.closest('div');
      const zipDesc = zipHeading.nextElementSibling;
      if (zipDesc && zipDesc.tagName === 'P') zipDesc.remove();
      const zipInput = doc.getElementById('zipImportFile');
      const zipRow = zipInput?.closest('.row');
      if (zipRow) zipRow.remove();
      const zipSupportNote = doc.getElementById('zipSupportNote');
      if (zipSupportNote) zipSupportNote.remove();
      const zipResult = doc.getElementById('importZipResult');
      if (zipResult) zipResult.remove();
      zipHeading.remove();
      if (zipPanel && !zipPanel.querySelector('h3')) zipPanel.remove();
    }

    const overlay = doc.querySelector('.frame-wrap .overlay');
    if (overlay) overlay.remove();
  }

  function installSuitePopovers() {
    const frame = moduleFrames.suite;
    const doc = frame?.contentWindow?.document;
    if (!doc) return;

    if (!doc.getElementById('ds-popover-style')) {
      const style = doc.createElement('style');
      style.id = 'ds-popover-style';
      style.textContent = `
        .ds-pop-target { cursor: pointer; border-bottom: 1px dotted rgba(125,249,255,.45); }
        .ds-pop-target::after {
          content: " ";
          color: #7df9ff;
          font-weight: 700;
          font-size: 11px;
          opacity: 0.9;
        }
        #ds-popover {
          position: fixed;
          max-width: 340px;
          z-index: 99999;
          display: none;
          background: rgba(12,21,34,.98);
          border: 1px solid #355170;
          border-radius: 10px;
          padding: 8px 10px;
          color: #e7eef7;
          font: 12px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
          box-shadow: 0 8px 24px rgba(0,0,0,.35);
          pointer-events: none;
        }
      `;
      doc.head.appendChild(style);
    }

    let pop = doc.getElementById('ds-popover');
    if (!pop) {
      pop = doc.createElement('div');
      pop.id = 'ds-popover';
      doc.body.appendChild(pop);
    }

    const setTip = (selector, label, text) => {
      const nodes = doc.querySelectorAll(selector);
      nodes.forEach((el) => {
        if ((el.textContent || '').trim() === label) {
          el.classList.add('ds-pop-target');
          el.setAttribute('data-ds-popover', text);
          el.removeAttribute('title');
        }
      });
    };

    setTip('h3', 'Unified KPI Strip', 'Top-level cross-module metrics: throughput, seals, DS drift, and governance status.');
    setTip('h3', 'Historical Trend (7/30)', 'Change indicators over 7 and 30 days so regressions are visible early.');
    setTip('h3', 'Deep Sigma Lenses', 'Truth, Reasoning, Memory, and Governance signals derived from module artifacts.');
    setTip('h3', 'Governance Footprint', 'Schemas and artifact types expected for the currently selected module.');
    setTip('h3', 'Control Gates', 'Fail-closed checks used to determine readiness and operational confidence.');
    setTip('h3', 'Module Health Scoring', 'Per-module quality score plus composite for executive tracking.');
    setTip('h3', 'Cross-Module Telemetry', 'Normalized record counts and coverage summaries by module.');
    setTip('h3', 'Drift Signal Rollup (DS)', 'Aggregated drift alerts requiring patch or operational response.');
    setTip('button', 'Refresh', 'Recompute rollup, scores, gates, and trend snapshots from current local data.');
    setTip('button', 'Export Rollup JSON', 'Export the current suite rollup payload for downstream ingest/reporting.');
    setTip('button', 'Print Executive View', 'Open a compact printable summary with totals, gates, and module scores.');
    setTip('button', 'Open Module (New Tab)', 'Launch live module instance for data entry and operations.');
    setTip('button', 'Open Default Tab', 'Launch module on its default landing tab for faster workflows.');

    const dsDetail = (moduleName, code, msg) => {
      const moduleHelp = {
        hiring: 'Hiring authority gate and talent episode governance.',
        bid: 'Bid/No-Bid decision governance and capture risk controls.',
        compliance: 'Requirement traceability, assignment, and gap closure.',
        boe: 'Pricing/BOE completeness, outliers, and assumptions health.'
      };
      const ruleHelp = {
        'DS-COMP-001': 'Trigger: unassigned requirements > 0. Action: assign owners and set due dates.',
        'DS-COMP-002': 'Trigger: unresolved gaps older than threshold. Action: resolve or escalate blockers.',
        'DS-COMP-003': 'Trigger: compliance coverage under target. Action: fill missing mappings before submission.',
        'DS-COMP-004': 'Trigger: requirements missing compliance statements. Action: add statement + evidence.',
        'DS-BOE-001': 'Trigger: labor line missing hours or rate. Action: complete line item inputs.',
        'DS-BOE-002': 'Trigger: rate outlier above threshold. Action: validate rate basis and approvals.',
        'DS-BOE-003': 'Trigger: hours outlier above threshold. Action: validate staffing model assumptions.',
        'DS-BOE-004': 'Trigger: missing key BOE assumptions. Action: add rates/escalation/productivity assumptions.'
      };
      const mod = String(moduleName || '').toLowerCase();
      const rule = ruleHelp[code] || 'Operational drift detected. Review source data and apply corrective patch.';
      return [
        `Module: ${moduleName || 'unknown'}`,
        `Signal: ${code || 'n/a'}`,
        `Summary: ${msg || 'n/a'}`,
        `Context: ${moduleHelp[mod] || 'Cross-module governance signal.'}`,
        `Rule: ${rule}`
      ].join('\n');
    };

    const dsRows = doc.querySelectorAll('#dsRollup > div');
    dsRows.forEach((row) => {
      const pills = row.querySelectorAll('.pill');
      const moduleName = (pills[0]?.textContent || '').trim();
      const code = (pills[1]?.textContent || '').trim();
      const full = (row.textContent || '').trim();
      const msg = full.replace(`${moduleName}${code}`, '').trim() || full;
      row.classList.add('ds-pop-target');
      row.setAttribute('data-ds-popover', dsDetail(moduleName, code, msg));
      row.removeAttribute('title');
    });

    if (!doc.body.dataset.dsPopoverBound) {
      doc.body.dataset.dsPopoverBound = '1';
      const show = (target, ev) => {
        const msg = target?.getAttribute('data-ds-popover');
        if (!msg) return;
        pop.textContent = msg;
        pop.style.display = 'block';
        const x = Math.min((ev?.clientX || 20) + 14, Math.max(20, doc.documentElement.clientWidth - 360));
        const y = Math.min((ev?.clientY || 20) + 14, Math.max(20, doc.documentElement.clientHeight - 120));
        pop.style.left = `${x}px`;
        pop.style.top = `${y}px`;
      };
      const hide = () => { pop.style.display = 'none'; };
      doc.addEventListener('mouseover', (ev) => {
        const t = ev.target?.closest?.('.ds-pop-target');
        if (t) show(t, ev);
      });
      doc.addEventListener('mousemove', (ev) => {
        if (pop.style.display === 'block') show(ev.target?.closest?.('.ds-pop-target'), ev);
      });
      doc.addEventListener('mouseout', (ev) => {
        const from = ev.target?.closest?.('.ds-pop-target');
        const to = ev.relatedTarget?.closest?.('.ds-pop-target');
        if (from && !to) hide();
      });
      doc.addEventListener('scroll', hide, true);
    }
  }

  function stackSuiteModulesRight() {
    const frame = moduleFrames.suite;
    const doc = frame?.contentWindow?.document;
    if (!doc) return;
    const existing = doc.getElementById('ds-stacked-viewers');
    if (existing) existing.remove();
    doc.body.dataset.dsStackedLayout = '0';
  }

  function removeSuiteAside() {
    const frame = moduleFrames.suite;
    const doc = frame?.contentWindow?.document;
    if (!doc) return;
    const main = doc.querySelector('main');
    const aside = doc.querySelector('main > aside');
    if (aside) aside.remove();
    if (main) main.style.gridTemplateColumns = '1fr';
  }

  function convertSuiteLeftPanelsToSubtabs() {
    const frame = moduleFrames.suite;
    const doc = frame?.contentWindow?.document;
    if (!doc) return;
    const existing = doc.getElementById('ds-suite-subtabs');
    if (existing) existing.remove();
    doc.body.dataset.dsSubtabsLayout = '0';
    return;

    const main = doc.querySelector('main');
    const aside = doc.querySelector('main > aside');
    const content = doc.querySelector('main > section.content');
    const moduleList = doc.getElementById('moduleList');
    if (!main || !aside || !content || !moduleList) return;

    const cards = Array.from(moduleList.querySelectorAll('.module'));
    if (!cards.length) return;

    const subtabsPanel = doc.createElement('div');
    subtabsPanel.id = 'ds-suite-subtabs';
    subtabsPanel.className = 'panel';
    subtabsPanel.innerHTML = '<h3>Modules</h3>';
    const row = doc.createElement('div');
    row.className = 'row';
    row.style.gap = '6px';
    row.style.flexWrap = 'wrap';
    subtabsPanel.appendChild(row);

    const setActive = (id) => {
      row.querySelectorAll('button[data-id]').forEach((b) => {
        const active = b.getAttribute('data-id') === id;
        b.style.borderColor = active ? 'rgba(125,249,255,.55)' : '#243449';
        b.style.boxShadow = active ? '0 0 0 1px rgba(125,249,255,.15) inset' : 'none';
      });
    };

    cards.forEach((card) => {
      const id = card.getAttribute('data-id') || '';
      const label = (card.querySelector('b')?.textContent || id || 'module').trim();
      if (label === 'Deep Sigma - SEQUOIA Hiring Console') {
        card.remove();
        return;
      }
      const btn = doc.createElement('button');
      btn.type = 'button';
      btn.setAttribute('data-id', id);
      btn.textContent = label;
      btn.addEventListener('click', () => {
        const fn = frame.contentWindow?.selectModule;
        if (typeof fn === 'function') fn(id);
        setActive(id);
      });
      row.appendChild(btn);
    });

    content.insertBefore(subtabsPanel, content.firstChild);

    const activeCard = moduleList.querySelector('.module.active');
    setActive(activeCard?.getAttribute('data-id') || cards[0].getAttribute('data-id') || '');

    const observer = new MutationObserver(() => {
      const active = moduleList.querySelector('.module.active');
      if (active) setActive(active.getAttribute('data-id') || '');
    });
    observer.observe(moduleList, { attributes: true, subtree: true, attributeFilter: ['class'] });

    aside.style.display = 'none';
    main.style.gridTemplateColumns = '1fr';
    doc.body.dataset.dsSubtabsLayout = '1';
  }

  function enforceSuitePanelRemovals() {
    const frame = moduleFrames.suite;
    const doc = frame?.contentWindow?.document;
    if (!doc) return;
  }

  function syncSuiteRollupToUtility() {
    const frame = moduleFrames.suite;
    const doc = frame?.contentWindow?.document;
    const src = doc?.getElementById('rollupPreview');
    const dst = document.getElementById('suiteRollupUtility');
    if (!dst) return;
    dst.value = src?.value || 'Suite rollup not available yet. Open Suite Control and click Refresh.';
  }

  function renderSuiteCrossoverPanel() {
    const frame = moduleFrames.suite;
    const doc = frame?.contentWindow?.document;
    if (!doc) return;

    const bid = readJsonSafe('ds_bidnobid_console_v1') || {};
    const compliance = readJsonSafe('ds_compliance_matrix_v1') || {};
    const boe = readJsonSafe('ds_boe_pricing_v1') || {};
    const hiring = readJsonSafe('ds_sequoia_hiring_console_v2_artifacts') || {};

    const bidOpps = Array.isArray(bid.opportunities) ? bid.opportunities : [];
    const bidOppIds = bidOpps.map((o) => String(o?.id || '').trim()).filter(Boolean);
    const bidSealed = bidOpps.filter((o) => !!o?.decision?.sealed).length;
    const bidAssumptions = Array.isArray(bid.assumptions) ? bid.assumptions : [];
    const bidRisks = Array.isArray(bid.risks) ? bid.risks : [];

    const compReqs = Array.isArray(compliance.requirements) ? compliance.requirements : [];
    const compGaps = Array.isArray(compliance.gaps) ? compliance.gaps : [];
    const compSealed = !!compliance?.intake?.baseline_sealed;
    const compMapped = compReqs.filter((r) => String(r?.compliance_statement || '').trim()).length;
    const compOppCandidates = [
      compliance?.intake?.opp_id,
      compliance?.intake?.solicitation_id,
      compliance?.intake?.solicitation,
      compliance?.intake?.title
    ].map((x) => String(x || '').trim()).filter(Boolean);

    const boeOppId = String(boe?.intake?.opp_id || '').trim();
    const boeSealed = !!boe?.approval?.sealed;
    const boeAssumptions = Array.isArray(boe.assumptions) ? boe.assumptions : [];
    const boeLabor = Array.isArray(boe.labor) ? boe.labor : [];
    const boeClearances = [...new Set(boeLabor.map((l) => String(l?.clearance || '').trim()).filter(Boolean))];

    const hiringCandidates = Array.isArray(hiring.candidates) ? hiring.candidates : [];
    const hiringByClearance = new Map();
    hiringCandidates.forEach((c) => {
      const clr = String(c?.clearance || '').trim();
      if (!clr) return;
      hiringByClearance.set(clr, (hiringByClearance.get(clr) || 0) + 1);
    });
    const staffingMatches = boeClearances.map((clr) => ({
      clearance: clr,
      candidates: hiringByClearance.get(clr) || 0
    }));

    const oppSet = new Set(bidOppIds);
    const compMatchedOpp = compOppCandidates.find((v) => oppSet.has(v)) || '';
    const boeMatchedOpp = boeOppId && oppSet.has(boeOppId);
    const alignmentScore = [
      bidOppIds.length > 0,
      !!compMatchedOpp,
      !!boeMatchedOpp
    ].filter(Boolean).length;

    const staleAssumptions = [...bidAssumptions, ...boeAssumptions].filter((a) => {
      const ex = new Date(a?.expiry || a?.expires || a?.ttl || '').getTime();
      return Number.isFinite(ex) && ex < Date.now();
    }).length;
    const compCoverage = compReqs.length ? Math.round((compMapped / compReqs.length) * 100) : 0;
    const openGaps = compGaps.filter((g) => String(g?.status || '').toLowerCase() !== 'resolved').length;

    const gateRows = [
      {
        name: 'Opportunity Identity Alignment',
        status: alignmentScore >= 2 ? 'PASS' : 'WARN',
        detail: `bid_ids=${bidOppIds.join(', ') || 'none'} | compliance_match=${compMatchedOpp || 'none'} | boe_match=${boeMatchedOpp ? boeOppId : 'none'}`
      },
      {
        name: 'Governance Seal Chain (Bid -> Compliance -> BOE)',
        status: (bidSealed > 0 && compSealed && boeSealed) ? 'PASS' : 'WARN',
        detail: `bid_sealed=${bidSealed} | compliance_baseline=${compSealed} | boe_sealed=${boeSealed}`
      },
      {
        name: 'Risk Chain (Bid Risks + Compliance Gaps)',
        status: (bidRisks.length + openGaps) <= 5 ? 'PASS' : 'WARN',
        detail: `bid_risks=${bidRisks.length} | open_gaps=${openGaps}`
      },
      {
        name: 'Assumption Chain Health',
        status: staleAssumptions === 0 ? 'PASS' : 'WARN',
        detail: `bid_assumptions=${bidAssumptions.length} | boe_assumptions=${boeAssumptions.length} | expired=${staleAssumptions}`
      },
      {
        name: 'Staffing Crossover (BOE Clearances vs Hiring Pool)',
        status: staffingMatches.every((x) => x.candidates > 0) || staffingMatches.length === 0 ? 'PASS' : 'WARN',
        detail: staffingMatches.length ? staffingMatches.map((x) => `${x.clearance}:${x.candidates}`).join(' | ') : 'no boe clearance signals'
      },
      {
        name: 'Evidence Readiness',
        status: (bidOpps.length > 0 && compReqs.length > 0 && boeLabor.length > 0) ? 'PASS' : 'WARN',
        detail: `bid_opps=${bidOpps.length} | comp_reqs=${compReqs.length} | boe_labor=${boeLabor.length} | comp_coverage=${compCoverage}%`
      }
    ];

    let panel = doc.getElementById('ds-crossover-panel');
    if (!panel) {
      panel = doc.createElement('div');
      panel.id = 'ds-crossover-panel';
      panel.className = 'panel';
      const anchor = doc.getElementById('telemetryTable')?.closest('.panel') || doc.querySelector('section.content .panel');
      if (anchor && anchor.parentNode) anchor.parentNode.insertBefore(panel, anchor.nextSibling);
    }
    if (!panel) return;

    panel.innerHTML = `
      <h3>Cross-Module Crossover</h3>
      <table>
        <thead><tr><th>Signal</th><th>Status</th><th>Details</th></tr></thead>
        <tbody>
          ${gateRows.map((r) => `
            <tr>
              <td>${r.name}</td>
              <td class="${r.status === 'PASS' ? 'status-ok' : 'status-warn'}">${r.status}</td>
              <td>${r.detail}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  function renderSuiteLinkagePanel() {
    const frame = moduleFrames.suite;
    const doc = frame?.contentWindow?.document;
    if (!doc) return;

    const hiring = readJsonSafe('ds_sequoia_hiring_console_v2_artifacts') || {};
    const bid = readJsonSafe('ds_bidnobid_console_v1') || {};
    const compliance = readJsonSafe('ds_compliance_matrix_v1') || {};
    const boe = readJsonSafe('ds_boe_pricing_v1') || {};

    const norm = (s) => String(s || '').toLowerCase().replace(/[^a-z0-9]+/g, ' ').trim();
    const ratioPct = (linked, total) => total > 0 ? Math.round((linked / total) * 1000) / 10 : 0;

    const roles = Array.isArray(hiring.roles) ? hiring.roles : [];
    const candidates = Array.isArray(hiring.candidates) ? hiring.candidates : [];
    const interviews = Array.isArray(hiring.interviews) ? hiring.interviews : [];
    const roleIds = new Set(roles.map((r) => String(r?.id || '').trim()).filter(Boolean));
    const candidateIds = new Set(candidates.map((c) => String(c?.id || '').trim()).filter(Boolean));

    const opps = Array.isArray(bid.opportunities) ? bid.opportunities : [];
    const assumptions = Array.isArray(bid.assumptions) ? bid.assumptions : [];
    const risks = Array.isArray(bid.risks) ? bid.risks : [];
    const oppIds = new Set(opps.map((o) => String(o?.id || '').trim()).filter(Boolean));

    const reqs = Array.isArray(compliance.requirements) ? compliance.requirements : [];
    const deliverables = Array.isArray(compliance.deliverables) ? compliance.deliverables : [];
    const gaps = Array.isArray(compliance.gaps) ? compliance.gaps : [];
    const reqIds = new Set(reqs.map((r) => String(r?.id || r?.req_id || '').trim()).filter(Boolean));

    const labor = Array.isArray(boe.labor) ? boe.labor : [];
    const boeApproval = boe?.approval || {};

    const deliverableReqRefs = new Set();
    deliverables.forEach((d) => {
      const refs = []
        .concat(Array.isArray(d?.req_ids) ? d.req_ids : [])
        .concat(Array.isArray(d?.mapped_req_ids) ? d.mapped_req_ids : [])
        .concat(d?.req_id ? [d.req_id] : []);
      refs.forEach((x) => {
        const id = String(x || '').trim();
        if (id) deliverableReqRefs.add(id);
      });
    });

    const roleTokens = roles.map((r) => {
      const name = String(r?.title || r?.name || r?.role || r?.id || '').trim();
      const tokens = new Set(norm(name).split(' ').filter(Boolean));
      return { id: String(r?.id || '').trim(), name, tokens };
    });
    const tokenMatch = (a, bSet) => {
      const aTokens = norm(a).split(' ').filter(Boolean);
      let hit = 0;
      for (const t of aTokens) if (bSet.has(t)) hit += 1;
      return hit >= 2;
    };

    const offeredCandidates = candidates.filter((c) =>
      !!c?.offer_date || ['offer', 'accepted', 'started'].includes(String(c?.status || '').toLowerCase())
    );
    const decisions = opps.filter((o) => !!o?.decision);

    const metrics = [];
    const pushMetric = (m) => {
      const total = Number(m.total || 0);
      const linked = Math.min(total, Number(m.linked || 0));
      metrics.push({ ...m, total, linked, pct: ratioPct(linked, total) });
    };

    pushMetric({
      key: 'candidate_role',
      source: 'Candidates',
      target: 'Roles',
      linked: candidates.filter((c) => roleIds.has(String(c?.role || c?.role_id || '').trim())).length,
      total: candidates.length,
      break: 'Candidate missing/invalid role reference'
    });
    pushMetric({
      key: 'interview_candidate',
      source: 'Interviews',
      target: 'Candidates',
      linked: interviews.filter((i) => candidateIds.has(String(i?.candidate || i?.candidate_id || '').trim())).length,
      total: interviews.length,
      break: 'Interview missing candidate reference'
    });
    pushMetric({
      key: 'offer_candidate',
      source: 'Offers',
      target: 'Candidates',
      linked: offeredCandidates.filter((c) => candidateIds.has(String(c?.id || '').trim())).length,
      total: offeredCandidates.length,
      break: 'Offer record missing candidate id'
    });
    pushMetric({
      key: 'assumption_opp',
      source: 'Bid Assumptions',
      target: 'Opportunities',
      linked: assumptions.filter((a) => oppIds.has(String(a?.opp_id || a?.opportunity_id || '').trim())).length,
      total: assumptions.length,
      break: 'Assumption missing opp_id'
    });
    pushMetric({
      key: 'risk_opp',
      source: 'Bid Risks',
      target: 'Opportunities',
      linked: risks.filter((r) => oppIds.has(String(r?.opp_id || r?.opportunity_id || '').trim())).length,
      total: risks.length,
      break: 'Risk missing opp_id'
    });
    pushMetric({
      key: 'decision_opp',
      source: 'Decisions',
      target: 'Opportunities',
      linked: decisions.length,
      total: opps.length,
      break: 'Opportunity missing decision block'
    });
    pushMetric({
      key: 'req_statement',
      source: 'Requirements',
      target: 'Compliance Statements',
      linked: reqs.filter((r) => String(r?.compliance_statement || '').trim()).length,
      total: reqs.length,
      break: 'Requirement missing compliance statement'
    });
    pushMetric({
      key: 'req_owner',
      source: 'Requirements',
      target: 'Owners',
      linked: reqs.filter((r) => String(r?.owner || '').trim()).length,
      total: reqs.length,
      break: 'Requirement unassigned'
    });
    pushMetric({
      key: 'gap_req',
      source: 'Gaps',
      target: 'Requirements',
      linked: gaps.filter((g) => reqIds.has(String(g?.req_id || g?.requirement_id || '').trim())).length,
      total: gaps.length,
      break: 'Gap missing req_id'
    });
    pushMetric({
      key: 'req_deliverable',
      source: 'Requirements',
      target: 'Deliverables',
      linked: reqs.filter((r) => deliverableReqRefs.has(String(r?.id || r?.req_id || '').trim())).length,
      total: reqs.length,
      break: 'Requirement not mapped to deliverable'
    });
    pushMetric({
      key: 'boe_labor_category',
      source: 'Labor Lines',
      target: 'Labor Category',
      linked: labor.filter((l) => String(l?.labor_category || l?.labor_cat || l?.role || '').trim()).length,
      total: labor.length,
      break: 'Labor line missing labor category/role'
    });
    const boeHiringLinked = labor.filter((l) => {
      const role = String(l?.labor_category || l?.labor_cat || l?.role || '').trim();
      if (!role) return false;
      const exact = roleTokens.some((r) => norm(r.name) === norm(role));
      const fuzzy = !exact && roleTokens.some((r) => tokenMatch(role, r.tokens));
      return exact || fuzzy;
    }).length;
    pushMetric({
      key: 'boe_labor_role_map',
      source: 'Labor Lines',
      target: 'Hiring Roles',
      linked: boeHiringLinked,
      total: labor.length,
      break: 'Labor role not matched to hiring role map'
    });
    pushMetric({
      key: 'approval_seal',
      source: 'Approval',
      target: 'Seal',
      linked: boeApproval?.sealed ? 1 : 0,
      total: 1,
      break: 'BOE approval not sealed'
    });

    const bidGate = (() => {
      const priority = { 'no-bid': 3, watch: 2, bid: 1 };
      return opps
        .map((o) => String(o?.decision?.value || '').toLowerCase())
        .filter(Boolean)
        .sort((a, b) => (priority[b] || 0) - (priority[a] || 0))[0] || '';
    })();
    const cross = [
      {
        key: 'cross_boe_hiring',
        source: 'BOE Labor',
        target: 'Hiring Roles',
        linked: boeHiringLinked,
        total: labor.length,
        break: 'BOE lines not mapped to hiring role taxonomy'
      },
      {
        key: 'cross_compliance_bid',
        source: 'Compliance Requirements',
        target: 'Bid Opportunity',
        linked: (() => {
          const compOpp = String(compliance?.intake?.opp_id || compliance?.intake?.contract_id || '').trim();
          const bidContracts = new Set(opps.map((o) => String(o?.contract_id || '').trim()).filter(Boolean));
          const matched = (compOpp && (oppIds.has(compOpp) || bidContracts.has(compOpp)));
          return matched ? reqs.length : 0;
        })(),
        total: reqs.length,
        break: 'Shared opp_id/contract_id missing across Compliance and Bid'
      },
      {
        key: 'cross_bid_hiring_gate',
        source: 'Bid Decision',
        target: 'Hiring Episodes',
        linked: (bidGate === 'no-bid' ? (candidates.length === 0 ? 1 : 0) : 1),
        total: 1,
        break: 'No-Bid with active hiring episodes'
      }
    ].map((m) => ({ ...m, pct: ratioPct(m.linked, m.total) }));

    // Read DS-based governance from the KPI strip's rollup (must be before scoreWeights)
    const kpiRollup = (() => {
      try {
        return JSON.parse(doc.getElementById('rollupPreview')?.value || '{}');
      } catch(_) { return {}; }
    })();
    const kpiTotals = kpiRollup?.totals || {};

    const scoreWeights = {
      candidate_role: 15,
      interview_candidate: 10,
      req_statement: 15,
      gap_req: 5,
      boe_labor_role_map: 15,
      decision_opp: 5,
      drift_control: 20,
      seal_governance: 15
    };
    const scoreRatio = (k) => {
      if (k === 'drift_control') return Math.max(0, 1 - Math.min(Number(kpiTotals.ds || 0), 10) / 10);
      if (k === 'seal_governance') {
        // Count modules with governance seal (sealed > 0), not raw sealed/episodes
        const mods = Array.isArray(kpiRollup?.modules) ? kpiRollup.modules : [];
        if (!mods.length) return 0.5;
        const sealedMods = mods.filter(m => m.sealed > 0).length;
        return sealedMods / mods.length;
      }
      const m = metrics.find((x) => x.key === k);
      return m && m.total > 0 ? (m.linked / m.total) : 0;
    };
    const weighted = Object.entries(scoreWeights).map(([k, w]) => scoreRatio(k) * w);
    const score = Math.round(weighted.reduce((a, b) => a + b, 0));
    const bandOf = (v) => v >= 80 ? 'GREEN' : v >= 60 ? 'YELLOW' : v >= 40 ? 'ORANGE' : 'RED';
    const bandCls = (b) => b === 'GREEN' ? 'status-ok' : b === 'YELLOW' ? 'status-warn' : b === 'ORANGE' ? 'status-orange' : 'status-bad';
    const scoreBand = bandOf(score);
    const scoreClass = bandCls(scoreBand);

    const breakReasons = [...metrics, ...cross]
      .map((m) => ({ reason: m.break, miss: Math.max(0, m.total - m.linked) }))
      .filter((x) => x.miss > 0)
      .sort((a, b) => b.miss - a.miss)
      .slice(0, 3);

    // ---- Diagnostic knowledge base ----
    const diagKB = {
      candidate_role:      { module: 'Hiring', impact: 'Candidates cannot be traced to authorized roles, breaking hiring governance chain.', fix: 'Open Hiring Console  ensure every candidate has a valid role_id matching a role in the Roles table. Use the Role Mapper below to align BOE labor categories.' },
      interview_candidate: { module: 'Hiring', impact: 'Interviews are orphaned  no link to the candidate record, so interview evidence is unattributable.', fix: 'Open Hiring Console  verify each interview record has a candidate_id that exists in the Candidates table.' },
      offer_candidate:     { module: 'Hiring', impact: 'Offer records lack candidate linkage, meaning acceptance/start metrics are unreliable.', fix: 'Open Hiring Console  link offer records to candidate IDs. Ensure status field is set (offer/accepted/started).' },
      assumption_opp:      { module: 'Bid', impact: 'Assumptions are floating  not tied to an opportunity, so risk context is lost.', fix: 'Open Bid Console  set opp_id on each assumption to match an existing opportunity ID.' },
      risk_opp:            { module: 'Bid', impact: 'Risks are not scoped to an opportunity, weakening bid/no-bid decision rationale.', fix: 'Open Bid Console  assign opp_id on each risk record.' },
      decision_opp:        { module: 'Bid', impact: 'Opportunities without decisions are governance gaps  no auditable bid/no-bid determination.', fix: 'Open Bid Console  record a decision (bid / no-bid / watch) on every opportunity.' },
      req_statement:       { module: 'Compliance', impact: 'Requirements without compliance statements have no evidence of compliance, creating submission risk.', fix: 'Open Compliance Matrix  fill compliance_statement for each requirement. Reference SOW/PWS sections.' },
      req_owner:           { module: 'Compliance', impact: 'Unassigned requirements have no accountable owner  gaps will not be resolved before deadline.', fix: 'Open Compliance Matrix  assign an owner to every requirement. Prioritize high-weight items.' },
      gap_req:             { module: 'Compliance', impact: 'Gaps without requirement references cannot be prioritized or traced to compliance obligations.', fix: 'Open Compliance Matrix  link each gap to its parent requirement via req_id.' },
      req_deliverable:     { module: 'Compliance', impact: 'Requirements not mapped to deliverables mean work products may not satisfy contract obligations.', fix: 'Open Compliance Matrix  map requirements to deliverables. Each deliverable should reference req_ids it satisfies.' },
      boe_labor_category:  { module: 'BOE', impact: 'Labor lines without a category/role cannot be validated against rate tables or staffing models.', fix: 'Open BOE Console  set labor_category or role on every labor line.' },
      boe_labor_role_map:  { module: 'BOE', impact: 'BOE labor lines are not matched to hiring roles  cost estimates and staffing plans are disconnected.', fix: 'Use the Role Mapper in the Repair panel below to map BOE labor lines to Hiring roles, then Save.' },
      approval_seal:       { module: 'BOE', impact: 'BOE approval is unsealed  the pricing basis is not locked and can drift without audit trail.', fix: 'Open BOE Console  seal the approval record to lock the pricing baseline.' },
      cross_boe_hiring:    { module: 'Cross-Domain', impact: 'BOE labor taxonomy and Hiring role taxonomy are misaligned  headcount and cost models diverge.', fix: 'Use the Role Mapper below to align BOE labor lines to Hiring roles. Then assign contract_id to both modules.' },
      cross_compliance_bid:{ module: 'Cross-Domain', impact: 'Compliance requirements and Bid opportunities share no contract_id/opp_id  cross-module joins fail.', fix: 'Use "Auto-assign Contract ID  All" in the Repair panel to set a shared contract_id across modules.' },
      cross_bid_hiring_gate:{ module: 'Cross-Domain', impact: 'A No-Bid decision exists but hiring episodes are still active  resources are being spent on a dead opportunity.', fix: 'If the No-Bid is final, archive or remove hiring candidates. If hiring should continue, update the Bid decision.' }
    };

    const allMetrics = [...metrics, ...cross];

    const dsCount = Number(kpiTotals.ds || 0);
    const dsGov = dsCount === 0 ? 'GREEN' : dsCount <= 3 ? 'YELLOW' : dsCount <= 6 ? 'ORANGE' : 'RED';
    const dsGovCls = bandCls(dsGov);

    // Composite governance = worst of DS-based and linkage-based
    const govRank = { GREEN: 0, YELLOW: 1, ORANGE: 2, RED: 3 };
    const compositeGov = govRank[dsGov] >= govRank[scoreBand] ? dsGov : scoreBand;
    const compositeGovCls = bandCls(compositeGov);

    const governanceDiag = () => {
      const broken = allMetrics.filter(m => m.linked < m.total).sort((a,b) => (b.total - b.linked) - (a.total - a.linked));
      const topDrivers = broken.slice(0, 3);

      // DS governance summary
      const dsMessages = {
        GREEN:  'No drift signals. DS pressure is zero.',
        YELLOW: `${dsCount} drift signal(s) detected. Elevated but manageable.`,
        ORANGE: `${dsCount} drift signal(s). Approaching instability  triage soon.`,
        RED:    `${dsCount} drift signal(s). Governance instability  resolve compliance gaps and BOE outliers.`
      };
      const dsSummary = `<span class="${bandCls(dsGov)}">${dsGov}</span>  ${dsMessages[dsGov]}`;

      // Linkage governance summary
      const linkMessages = {
        GREEN:  `Linkage score ${score}/100. All cross-module links healthy.`,
        YELLOW: `Linkage score ${score}/100 (threshold: 80). ${broken.length} link type(s) have gaps.`,
        ORANGE: `Linkage score ${score}/100 (threshold: 60). ${broken.length} link type(s) degraded. Review recommended.`,
        RED:    `Linkage score ${score}/100 (threshold: 40). ${broken.length} link type(s) broken. Cross-module traceability is unreliable.`
      };
      const linkSummary = `<span class="${bandCls(scoreBand)}">${scoreBand}</span>  ${linkMessages[scoreBand]}`;

      const drivers = topDrivers.map(m => {
        const kb = diagKB[m.key] || {};
        const miss = m.total - m.linked;
        return `<div style="margin:8px 0;padding:8px;border:1px solid #22354d;border-radius:8px;background:#0d1520">
          <div style="font-weight:600;margin-bottom:4px">${m.source}  ${m.target} <span class="muted">(${miss} unlinked of ${m.total})</span></div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:4px">${kb.impact || m.break}</div>
          <div style="font-size:12px"><b>Fix:</b> ${kb.fix || 'Resolve the break reason shown in the linkage table.'}</div>
        </div>`;
      }).join('');

      return `
        <div style="margin-bottom:10px"><b>Composite Governance:</b> <span class="${compositeGovCls}" style="font-size:16px;font-weight:700">${compositeGov}</span></div>
        <table style="font-size:12px;margin-bottom:12px"><tbody>
          <tr><td style="width:130px;font-weight:600">Drift Signals (DS)</td><td>${dsSummary}</td></tr>
          <tr><td style="font-weight:600">Linkage Score</td><td>${linkSummary}</td></tr>
        </tbody></table>
        <div style="font-weight:600;margin:10px 0 6px">Top Linkage Drivers</div>${drivers || '<div class="muted">No broken links detected.</div>'}
        <div style="font-weight:600;margin:10px 0 6px">Weighted Score Breakdown</div>
        <table style="font-size:12px"><thead><tr><th>Metric</th><th>Weight</th><th>Coverage</th><th>Contribution</th></tr></thead><tbody>
        ${Object.entries(scoreWeights).map(([k,w]) => {
          const ratio = scoreRatio(k);
          const contrib = Math.round(ratio * w);
          const cls = bandCls(bandOf(Math.round(ratio * 100)));
          const labels = { drift_control: 'Drift Control (DS pressure)', seal_governance: 'Governance (seal ratio)' };
          const m = metrics.find(x => x.key === k);
          const label = labels[k] || (m ? m.source + '  ' + m.target : k);
          return `<tr><td>${label}</td><td>${w}</td><td class="${cls}">${Math.round(ratio*100)}%</td><td>${contrib}/${w}</td></tr>`;
        }).join('')}
        </tbody></table>`;
    };

    const metricDiag = (m) => {
      const kb = diagKB[m.key] || {};
      const miss = Math.max(0, m.total - m.linked);
      const status = miss === 0 ? 'PASS' : (m.pct >= 50 ? 'PARTIAL' : 'FAIL');
      const statusCls = miss === 0 ? 'status-ok' : (m.pct >= 50 ? 'status-warn' : 'status-bad');
      const weight = scoreWeights[m.key];
      return `
        <div style="margin-bottom:6px"><span class="pill ${statusCls}">${status}</span> <b>${m.source}  ${m.target}</b></div>
        <table style="font-size:12px;margin-bottom:8px"><tbody>
          <tr><td class="muted" style="width:100px">Module</td><td>${kb.module || ''}</td></tr>
          <tr><td class="muted">Linked</td><td>${m.linked} / ${m.total} (${m.pct}%)</td></tr>
          <tr><td class="muted">Unlinked</td><td>${miss}</td></tr>
          ${weight ? `<tr><td class="muted">Score Weight</td><td>${weight} pts</td></tr>` : ''}
          <tr><td class="muted">Break Reason</td><td>${m.break}</td></tr>
        </tbody></table>
        <div style="margin-bottom:6px"><b>Impact</b></div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:8px">${kb.impact || 'Unlinked records weaken cross-module governance traceability.'}</div>
        <div style="margin-bottom:6px"><b>How to Fix</b></div>
        <div style="font-size:12px">${kb.fix || 'Open the source module and resolve the missing linkage.'}</div>`;
    };

    let panel = doc.getElementById('ds-linkage-panel');
    if (!panel) {
      panel = doc.createElement('div');
      panel.id = 'ds-linkage-panel';
      panel.className = 'panel';
      const anchor = doc.getElementById('telemetryTable')?.closest('.panel') || doc.querySelector('section.content .panel');
      if (anchor && anchor.parentNode) anchor.parentNode.insertBefore(panel, anchor.nextSibling);
    }
    if (!panel) return;

    // Inject popover style + element once
    if (!doc.getElementById('ds-repair-diag-style')) {
      const ds = doc.createElement('style');
      ds.id = 'ds-repair-diag-style';
      ds.textContent = `
        #ds-diag-overlay{position:fixed;inset:0;z-index:99998;background:rgba(8,16,25,.7);display:none;align-items:center;justify-content:center}
        #ds-diag-overlay.open{display:flex}
        #ds-diag-modal{background:#0f1a2a;border:1px solid #355170;border-radius:12px;padding:16px 18px;max-width:560px;width:90%;max-height:80vh;overflow:auto;box-shadow:0 12px 40px rgba(0,0,0,.5)}
        #ds-diag-modal h3{margin:0 0 10px;font-size:15px}
        #ds-diag-close{float:right;background:transparent;border:1px solid #2b4a69;border-radius:8px;color:var(--txt);padding:4px 10px;cursor:pointer;font-size:13px}
        #ds-diag-close:hover{border-color:#3f658a}
        .ds-diag-click{cursor:pointer}
        .ds-diag-click:hover{background:rgba(125,249,255,.04)}
        .pill.ds-diag-click:hover{border-color:#3f658a}
      `;
      doc.head.appendChild(ds);
    }
    let overlay = doc.getElementById('ds-diag-overlay');
    if (!overlay) {
      overlay = doc.createElement('div');
      overlay.id = 'ds-diag-overlay';
      overlay.innerHTML = '<div id="ds-diag-modal"><button id="ds-diag-close">Close</button><div id="ds-diag-body"></div></div>';
      doc.body.appendChild(overlay);
      overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('open'); });
      doc.getElementById('ds-diag-close').addEventListener('click', () => overlay.classList.remove('open'));
    }
    const showDiag = (title, html) => {
      const body = doc.getElementById('ds-diag-body');
      body.innerHTML = `<h3>${title}</h3>${html}`;
      overlay.classList.add('open');
    };

    panel.innerHTML = `
      <h3>Cross-Module Linkage</h3>
      <div style="margin:6px 0 10px 0">
        <span class="pill ds-diag-click" data-diag="governance">Linkage Score: <b>${score}</b></span>
        <span class="pill ${scoreClass} ds-diag-click" data-diag="governance">${scoreBand}</span>
        <span class="pill ds-diag-click ${dsGovCls}" data-diag="governance">DS: ${dsCount} (${dsGov})</span>
        <span class="pill ds-diag-click ${compositeGovCls}" data-diag="governance" style="font-weight:600">Governance: ${compositeGov}</span>
      </div>
      <table>
        <thead><tr><th>Link Type</th><th>Linked</th><th>Total</th><th>% Linked</th><th>Top Break Reason</th></tr></thead>
        <tbody>
          ${allMetrics.map((m, i) => {
            const miss = Math.max(0, m.total - m.linked);
            const rowCls = miss > 0 ? 'ds-diag-click' : '';
            return `<tr class="${rowCls}" data-diag-idx="${i}">
              <td>${m.source}  ${m.target}</td>
              <td>${m.linked}</td>
              <td>${m.total}</td>
              <td>${m.pct}%</td>
              <td>${miss > 0 ? m.break : '<span class="status-ok">none</span>'}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
      <h3 style="margin-top:10px">Top Break Reasons</h3>
      <div>
        ${breakReasons.length ? breakReasons.map((b) => `<div>- ${b.reason} (${b.miss})</div>`).join('') : '<div class="status-ok">- none</div>'}
      </div>
    `;

    // Wire popover clicks
    panel.querySelectorAll('[data-diag="governance"]').forEach(el => {
      el.addEventListener('click', () => showDiag(`Governance Diagnostic: ${compositeGov}`, governanceDiag()));
    });
    panel.querySelectorAll('tr[data-diag-idx]').forEach(tr => {
      tr.addEventListener('click', () => {
        const idx = Number(tr.getAttribute('data-diag-idx'));
        const m = allMetrics[idx];
        if (!m) return;
        showDiag('Linkage Diagnostic', metricDiag(m));
      });
    });
  
    // ---- Identity + Linkage Repair (v008) ----
    const CONTRACT_KEY = 'ds_sequoia_contract_id';
    const defaultContractId = (localStorage.getItem(CONTRACT_KEY) || '').trim() || 'NGA-SEQUOIA';

    function countHas(arr, field) {
      if (!Array.isArray(arr) || !arr.length) return { has: 0, total: 0 };
      const has = arr.filter(x => x && String(x[field] || '').trim()).length;
      return { has, total: arr.length };
    }

    // module record arrays (best-effort across versions)
    const hiringRoles = hiring.roles || [];
    const hiringCandidates = hiring.candidates || [];
    const hiringInterviews = hiring.interviews || [];

    const bidOpps = bid.opps || bid.opportunities || [];
    const bidDecisions = bid.decisions || [];
    const bidRisks = bid.risks || [];
    const bidAss = bid.assumptions || [];

    const compReqs = compliance.requirements || compliance.reqs || [];
    const compGaps = compliance.gaps || [];
    const compDelivs = compliance.deliverables || compliance.delivs || [];

    const boeLines = boe.lines || boe.labor || boe.labor_lines || [];
    const boeApprovals = boe.approvals || boe.review || [];

    const cov = {
      hiring: {
        roles: countHas(hiringRoles, 'contract_id'),
        candidates: countHas(hiringCandidates, 'contract_id'),
        interviews: countHas(hiringInterviews, 'contract_id'),
      },
      bid: {
        opps: countHas(bidOpps, 'contract_id'),
        decisions: countHas(bidDecisions, 'contract_id'),
        risks: countHas(bidRisks, 'contract_id'),
        assumptions: countHas(bidAss, 'contract_id'),
      },
      compliance: {
        reqs: countHas(compReqs, 'contract_id'),
        gaps: countHas(compGaps, 'contract_id'),
        delivs: countHas(compDelivs, 'contract_id'),
      },
      boe: {
        lines: countHas(boeLines, 'contract_id'),
        approvals: countHas(boeApprovals, 'contract_id'),
      }
    };

    const covRows = [
      ['Hiring', 'Roles', cov.hiring.roles],
      ['Hiring', 'Candidates', cov.hiring.candidates],
      ['Hiring', 'Interviews', cov.hiring.interviews],
      ['Bid', 'Opps', cov.bid.opps],
      ['Bid', 'Decisions', cov.bid.decisions],
      ['Bid', 'Risks', cov.bid.risks],
      ['Bid', 'Assumptions', cov.bid.assumptions],
      ['Compliance', 'Requirements', cov.compliance.reqs],
      ['Compliance', 'Gaps', cov.compliance.gaps],
      ['Compliance', 'Deliverables', cov.compliance.delivs],
      ['BOE', 'Labor Lines', cov.boe.lines],
      ['BOE', 'Approvals', cov.boe.approvals],
    ];

    function pct(has, total){ return total ? Math.round((has/total)*100) : 100; }

    function writeBack(key, obj){
      try{ localStorage.setItem(key, JSON.stringify(obj)); return true; }catch(e){ return false; }
    }

    function applyContractId(moduleName, contractId){
      const cid = (contractId || defaultContractId).trim();
      localStorage.setItem(CONTRACT_KEY, cid);

      if(moduleName === 'hiring'){
        (hiring.roles||[]).forEach(x=>x.contract_id ||= cid);
        (hiring.candidates||[]).forEach(x=>x.contract_id ||= cid);
        (hiring.interviews||[]).forEach(x=>x.contract_id ||= cid);
        writeBack('ds_sequoia_hiring_console_v2_artifacts', hiring);
      }
      if(moduleName === 'bid'){
        (bid.opps||bid.opportunities||[]).forEach(x=>x.contract_id ||= cid);
        (bid.decisions||[]).forEach(x=>x.contract_id ||= cid);
        (bid.risks||[]).forEach(x=>x.contract_id ||= cid);
        (bid.assumptions||[]).forEach(x=>x.contract_id ||= cid);
        writeBack('ds_bidnobid_console_v1', bid);
      }
      if(moduleName === 'compliance'){
        (compliance.requirements||compliance.reqs||[]).forEach(x=>x.contract_id ||= cid);
        (compliance.gaps||[]).forEach(x=>x.contract_id ||= cid);
        (compliance.deliverables||compliance.delivs||[]).forEach(x=>x.contract_id ||= cid);
        writeBack('ds_compliance_matrix_v1', compliance);
      }
      if(moduleName === 'boe'){
        (boe.lines||boe.labor||boe.labor_lines||[]).forEach(x=>x.contract_id ||= cid);
        (boe.approvals||boe.review||[]).forEach(x=>x.contract_id ||= cid);
        writeBack('ds_boe_pricing_v1', boe);
      }
    }

    // BOE  Hiring: interactive mapper
    function normTokens(s){
      return String(s||'').toLowerCase().replace(/[^a-z0-9 ]+/g,' ').split(/\s+/).filter(Boolean);
    }
    function scoreMatch(a,b){
      const A=new Set(normTokens(a)), B=new Set(normTokens(b));
      if(!A.size || !B.size) return 0;
      let inter=0; A.forEach(t=>{ if(B.has(t)) inter++; });
      return inter / Math.max(A.size, B.size);
    }

    function buildRoleOptions(){
      const roles = hiring.roles || [];
      return ['<option value="">(unmapped)</option>'].concat(roles.map(r=>{
        const label = `${r.id || ''}  ${r.name || r.title || ''}`.trim();
        const val = r.id || r.name || r.title || '';
        return `<option value="${escapeHtml(val)}">${escapeHtml(label)}</option>`;
      })).join('');
    }

    const roleOptHtml = buildRoleOptions();

    const mapRows = (boeLines||[]).slice(0, 200).map((ln, idx)=>{
      const title = ln.role || ln.role_name || ln.title || ln.labor_category || ln.laborCat || '';
      const existing = ln.role_id || ln.roleId || '';
      // suggest best match
      let best = {id:'', name:'', s:0};
      (hiring.roles||[]).forEach(r=>{
        const rn = r.name || r.title || r.id || '';
        const s = scoreMatch(title, rn);
        if(s > best.s){ best = {id:(r.id||rn), name:rn, s}; }
      });
      const suggest = best.s >= 0.34 ? `${best.name} (${Math.round(best.s*100)}%)` : '';
      return `<tr>
        <td class="mono">${escapeHtml(String(idx+1))}</td>
        <td>${escapeHtml(title)}</td>
        <td class="muted">${escapeHtml(suggest)}</td>
        <td>
          <select data-action="map-role" data-idx="${idx}">
            ${roleOptHtml.replace(`value="${escapeHtml(existing)}"`, `value="${escapeHtml(existing)}" selected`)}
          </select>
        </td>
      </tr>`;
    }).join('');

    let repair = doc.getElementById('ds-linkage-repair-panel');
    if (!repair) {
      repair = doc.createElement('div');
      repair.id = 'ds-linkage-repair-panel';
      repair.className = 'panel';
      if (panel && panel.parentNode) panel.parentNode.insertBefore(repair, panel.nextSibling);
    }

    repair.innerHTML = `
      <h3>Identity + Linkage Repair</h3>
      <div class="muted" style="margin-top:-6px">Goal: make linkage GREEN by construction (contract_id everywhere, then deterministic mappings).</div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <label>Contract ID (shared)</label>
          <input id="ds-contract-id" value="${escapeHtml(defaultContractId)}" placeholder="NGA-SEQUOIA"/>
          <div class="muted small" style="margin-top:6px">Used for deterministic cross-module joins.</div>
        </div>
        <div>
          <label>Auto-assign Contract ID</label>
          <div class="row">
            <button id="btnAssignHiring">Hiring</button>
            <button id="btnAssignBid">Bid</button>
            <button id="btnAssignCompliance">Compliance</button>
            <button id="btnAssignBOE">BOE</button>
            <button id="btnAssignAll" class="primary">All</button>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h4>Identity Coverage</h4>
        <table>
          <thead><tr><th>Module</th><th>Record Type</th><th>Has contract_id</th><th>Total</th><th>%</th></tr></thead>
          <tbody>
            ${covRows.map(([m,t,c])=>`<tr><td>${m}</td><td>${t}</td><td>${c.has}</td><td>${c.total}</td><td>${pct(c.has,c.total)}%</td></tr>`).join('')}
          </tbody>
        </table>
      </div>

      <div class="panel" style="margin-top:12px">
        <h4>BOE  Hiring Role Mapper</h4>
        <div class="muted small">Maps BOE labor lines to Hiring roles (writes role_id into BOE lines). Uses suggestion + manual select.</div>
        <div style="max-height:280px; overflow:auto; margin-top:8px">
          <table>
            <thead><tr><th>#</th><th>BOE Line Role</th><th>Suggested</th><th>Map to Hiring Role</th></tr></thead>
            <tbody>${mapRows || `<tr><td colspan="4" class="muted">No BOE labor lines found.</td></tr>`}</tbody>
          </table>
        </div>
        <div class="right" style="margin-top:10px">
          <button id="btnSaveRoleMap" class="primary">Save Role Mappings</button>
        </div>
      </div>
    `;

    // Wire repair buttons
    const cidEl = doc.getElementById('ds-contract-id');
    const getCid = ()=> (cidEl?.value || defaultContractId).trim();

    doc.getElementById('btnAssignHiring')?.addEventListener('click', ()=>{ applyContractId('hiring', getCid()); renderSuiteLinkagePanel(); });
    doc.getElementById('btnAssignBid')?.addEventListener('click', ()=>{ applyContractId('bid', getCid()); renderSuiteLinkagePanel(); });
    doc.getElementById('btnAssignCompliance')?.addEventListener('click', ()=>{ applyContractId('compliance', getCid()); renderSuiteLinkagePanel(); });
    doc.getElementById('btnAssignBOE')?.addEventListener('click', ()=>{ applyContractId('boe', getCid()); renderSuiteLinkagePanel(); });
    doc.getElementById('btnAssignAll')?.addEventListener('click', ()=>{ ['hiring','bid','compliance','boe'].forEach(m=>applyContractId(m, getCid())); renderSuiteLinkagePanel(); });

    // Track role map selections in DOM
    const mapState = {};
    repair.querySelectorAll('select[data-action="map-role"]').forEach(sel=>{
      sel.addEventListener('change', ()=>{
        const idx = Number(sel.dataset.idx);
        mapState[idx] = sel.value;
      });
    });

    doc.getElementById('btnSaveRoleMap')?.addEventListener('click', ()=>{
      const db = readJsonSafe('ds_boe_pricing_v1') || {};
      const lines = db.lines || db.labor || db.labor_lines || [];
      Object.entries(mapState).forEach(([i,val])=>{
        const idx = Number(i);
        if(lines[idx]){
          lines[idx].role_id = val || '';
        }
      });
      // also set contract_id if missing
      lines.forEach(x=>x.contract_id ||= getCid());
      writeBack('ds_boe_pricing_v1', db);
      renderSuiteLinkagePanel();
      alert('Saved role mappings to BOE lines.');
    });

  }

  function enhanceSuiteKpiDiagnostics() {
    const frame = moduleFrames.suite;
    const doc = frame?.contentWindow?.document;
    if (!doc) return;

    if (!doc.getElementById('ds-kpi-fix-style')) {
      const style = doc.createElement('style');
      style.id = 'ds-kpi-fix-style';
      style.textContent = `
        .hidden{display:none}
        .kpi .card{cursor:pointer}
        .kpi .card:hover{border-color:#3c6186;box-shadow:0 0 0 1px rgba(125,249,255,.12) inset}
        .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .small{font-size:11px}
        .right{text-align:right}
        label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
        input,select{background:#0d1520;color:var(--txt);border:1px solid #243449;border-radius:8px;padding:7px 9px;font-size:13px;width:100%;box-sizing:border-box}
        input:focus,select:focus{border-color:rgba(125,249,255,.5);outline:none}
        select{cursor:pointer}
        select option{background:#0d1520;color:var(--txt)}
      `;
      doc.head.appendChild(style);
    }

    const kpiStrip = doc.getElementById('kpiStrip');
    if (!kpiStrip) return;

    let drawer = doc.getElementById('kpiDrawer');
    if (!drawer) {
      drawer = doc.createElement('div');
      drawer.id = 'kpiDrawer';
      drawer.className = 'panel hidden';
      drawer.style.marginTop = '10px';
      kpiStrip.insertAdjacentElement('afterend', drawer);
    }

    let rollup = {};
    try {
      rollup = JSON.parse(doc.getElementById('rollupPreview')?.value || '{}');
    } catch (_) {
      rollup = {};
    }
    const totals = rollup?.totals || {};
    const safe = {
      episodes: Number(totals.episodes || 0),
      ds: Number(totals.ds || 0),
      sealed: Number(totals.sealed || 0),
      truth: Number(totals.truth || 0)
    };
    const modulesWithData = Number(rollup?.modulesWithData ?? rollup?.modules_with_data ?? 0);
    const governance = safe.ds === 0 ? 'GREEN' : safe.ds <= 3 ? 'YELLOW' : safe.ds <= 6 ? 'ORANGE' : 'RED';
    const governanceCls = governance === 'GREEN' ? 'status-ok' : governance === 'YELLOW' ? 'status-warn' : governance === 'ORANGE' ? 'status-orange' : 'status-bad';
    frame.contentWindow.__suite_rollup = { ...rollup, totals: safe, modulesWithData };

    kpiStrip.innerHTML = [
      ['episodes', 'Episodes', safe.episodes, ''],
      ['ds', 'Drift Signals', safe.ds, safe.ds > 6 ? 'status-bad' : safe.ds > 3 ? 'status-orange' : safe.ds > 0 ? 'status-warn' : 'status-ok'],
      ['sealed', 'Sealed Decisions', safe.sealed, ''],
      ['modules', 'Modules w/ Data', modulesWithData, ''],
      ['truth', 'Truth Artifacts', safe.truth, ''],
      ['governance', 'Governance', governance, governanceCls]
    ].map(([k, l, v, cls]) => `<div class="card" data-kpi="${k}"><div class="v${cls ? ' ' + cls : ''}">${v}</div><div class="l">${l}</div></div>`).join('');

    const fixes = {
      episodes: { why: 'Episode count is low, so institutional decision memory is thin.', fix: 'Run module Test Mode and import ZIP packs to populate records.' },
      ds: { why: 'Drift signals are elevated, indicating governance instability.', fix: 'Resolve open compliance gaps and BOE outliers, then reseal decisions.' },
      sealed: { why: 'Unsealed decisions are not enforceable governance artifacts.', fix: 'Seal Bid decisions and BOE approvals; ensure compliance baseline is sealed.' },
      modules: { why: 'Not all modules have data, so cross-domain linkage is incomplete.', fix: 'Populate Bid, Compliance, BOE, and Hiring before readiness review.' },
      truth: { why: 'Truth artifact volume is low for reliable explainability.', fix: 'Increase mapped requirements, BOE lines, and traceable decision records.' },
      governance: { why: 'Governance state reflects unresolved drift pressure.', fix: 'Drive DS down, close linkage breaks, and raise seal coverage.' }
    };

    const linkageRows = () => {
      const root = doc.getElementById('ds-linkage-panel');
      if (!root) return [];
      const rows = [];
      const trs = root.querySelectorAll('table tbody tr');
      trs.forEach((tr) => {
        const tds = tr.querySelectorAll('td');
        if (tds.length < 5) return;
        const type = (tds[0].textContent || '').trim();
        const linked = Number((tds[1].textContent || '0').trim()) || 0;
        const total = Number((tds[2].textContent || '0').trim()) || 0;
        const reason = (tds[4].textContent || '').trim();
        rows.push({ type, linked, total, miss: Math.max(0, total - linked), reason });
      });
      return rows;
    };

    const dedupe = (arr) => {
      const seen = new Set();
      const out = [];
      arr.forEach((x) => {
        const k = String(x || '').trim();
        if (!k || seen.has(k)) return;
        seen.add(k);
        out.push(k);
      });
      return out;
    };

    const getBreakReasonsForKey = (key) => {
      const rows = linkageRows().filter((r) => r.miss > 0 && r.reason && r.reason !== 'none');
      const moduleEpisodeGaps = byModule
        .filter((m) => Number(m?.episodes || 0) === 0)
        .map((m) => `${m?.name || m?.id || 'module'} has 0 episodes`);
      const moduleTruthGaps = byModule
        .filter((m) => Number(m?.truth || 0) === 0)
        .map((m) => `${m?.name || m?.id || 'module'} has 0 truth artifacts`);

      let picks = [];
      if (key === 'episodes') {
        picks = moduleEpisodeGaps;
      } else if (key === 'sealed') {
        picks = rows
          .filter((r) => r.type.includes('Decisions') || r.type.includes('Approval'))
          .sort((a, b) => b.miss - a.miss)
          .map((r) => `${r.reason} (${r.miss})`);
      } else if (key === 'modules') {
        picks = moduleEpisodeGaps;
      } else if (key === 'truth') {
        picks = rows
          .filter((r) => r.type.includes('Requirements') || r.type.includes('Labor Lines'))
          .sort((a, b) => b.miss - a.miss)
          .map((r) => `${r.reason} (${r.miss})`)
          .concat(moduleTruthGaps);
      } else if (key === 'ds' || key === 'governance') {
        picks = rows.sort((a, b) => b.miss - a.miss).map((r) => `${r.reason} (${r.miss})`);
      } else {
        picks = rows.sort((a, b) => b.miss - a.miss).map((r) => `${r.reason} (${r.miss})`);
      }
      return dedupe(picks).slice(0, 3);
    };

    const byModule = Array.isArray(rollup?.byModule) ? rollup.byModule : (Array.isArray(rollup?.modules) ? rollup.modules : []);
    const topModuleLines = (metricKey) => {
      const map = {
        episodes: (m) => Number(m?.episodes || 0),
        ds: (m) => Number(m?.ds || 0),
        sealed: (m) => Number(m?.sealed || 0),
        truth: (m) => Number(m?.truth || 0)
      };
      const fn = map[metricKey];
      if (!fn) return [];
      return byModule
        .map((m) => ({ name: m?.name || m?.id || 'module', v: fn(m) }))
        .sort((a, b) => b.v - a.v)
        .slice(0, 3);
    };

    const kpiState = {
      episodes: { current: safe.episodes, target: 25, gap: Math.max(0, 25 - safe.episodes), contributors: topModuleLines('episodes') },
      ds: { current: safe.ds, target: 0, gap: Math.max(0, safe.ds - 0), contributors: topModuleLines('ds') },
      sealed: { current: safe.sealed, target: Math.max(1, safe.episodes), gap: Math.max(0, Math.max(1, safe.episodes) - safe.sealed), contributors: topModuleLines('sealed') },
      modules: { current: modulesWithData, target: 4, gap: Math.max(0, 4 - modulesWithData), contributors: [] },
      truth: { current: safe.truth, target: 40, gap: Math.max(0, 40 - safe.truth), contributors: topModuleLines('truth') },
      governance: { current: governance, target: 'GREEN', gap: governance === 'GREEN' ? 0 : (governance === 'YELLOW' ? 1 : 2), contributors: topModuleLines('ds') }
    };

    const showKpiFix = (key) => {
      // For governance and ds, try the full diagnostic modal first
      if ((key === 'governance' || key === 'ds') && doc.getElementById('ds-diag-overlay')) {
        const lPanel = doc.getElementById('ds-linkage-panel');
        const scorePill = lPanel?.querySelector('[data-diag="governance"]');
        if (scorePill) { scorePill.click(); return; }
      }

      const cfg = fixes[key] || fixes.governance;
      const breaks = getBreakReasonsForKey(key);
      const ks = kpiState[key] || kpiState.governance;
      const currentLine = key === 'governance'
        ? `Current: ${ks.current} | Target: ${ks.target}`
        : `Current: ${ks.current} | Target: ${ks.target} | Gap: ${ks.gap}`;
      const contrib = (ks.contributors || []).length
        ? ks.contributors.map((x) => `<tr><td>${x.name}</td><td style="font-weight:600">${x.v}</td></tr>`).join('')
        : '<tr><td colspan="2" class="muted">n/a</td></tr>';

      // Per-module breakdown table
      const modRows = byModule.map(m => {
        const vals = {
          episodes: m.episodes || 0, ds: m.ds || 0,
          sealed: m.sealed || 0, truth: m.truth || 0,
          modules: m.episodes > 0 || m.ds > 0 || m.sealed > 0 ? 1 : 0
        };
        const v = vals[key] ?? '';
        const bad = key === 'ds' ? v > 0 : key === 'modules' ? v === 0 : v === 0;
        const cls = bad ? 'status-bad' : 'status-ok';
        return `<tr><td>${m.name || m.id}</td><td class="${cls}" style="font-weight:600">${v}</td></tr>`;
      }).join('');

      // Use the diagnostic modal instead of the drawer
      const overlay = doc.getElementById('ds-diag-overlay');
      const body = doc.getElementById('ds-diag-body');
      if (overlay && body) {
        const labels = { episodes: 'Episodes', ds: 'Drift Signals', sealed: 'Sealed Decisions', modules: 'Modules w/ Data', truth: 'Truth Artifacts', governance: 'Governance' };
        body.innerHTML = `
          <h3>KPI Diagnostic: ${labels[key] || key}</h3>
          <table style="font-size:12px;margin-bottom:10px"><tbody>
            <tr><td class="muted" style="width:90px">Current</td><td style="font-weight:600">${ks.current}</td></tr>
            <tr><td class="muted">Target</td><td>${ks.target}</td></tr>
            ${key !== 'governance' ? '<tr><td class="muted">Gap</td><td>' + ks.gap + '</td></tr>' : ''}
          </tbody></table>
          <div style="font-weight:600;margin:10px 0 6px">Per-Module Breakdown</div>
          <table style="font-size:12px"><thead><tr><th>Module</th><th>${labels[key] || key}</th></tr></thead><tbody>${modRows}</tbody></table>
          <div style="font-weight:600;margin:10px 0 6px">What's Wrong</div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:8px">${cfg.why}</div>
          <div style="font-weight:600;margin:10px 0 6px">How to Fix</div>
          <div style="font-size:12px;margin-bottom:8px">${cfg.fix}</div>
          ${breaks.length ? '<div style="font-weight:600;margin:10px 0 6px">Top Break Reasons</div>' + breaks.map(b => '<div style="font-size:12px;margin:2px 0"> ' + b + '</div>').join('') : ''}
        `;
        overlay.classList.add('open');
      }
    };

    if (!kpiStrip.dataset.kpiFixBound) {
      kpiStrip.dataset.kpiFixBound = '1';
      kpiStrip.addEventListener('click', (e) => {
        const card = e.target.closest('.card[data-kpi]');
        if (!card) return;
        showKpiFix(card.getAttribute('data-kpi'));
      });
    }

    if (!drawer.dataset.kpiFixNavBound) {
      drawer.dataset.kpiFixNavBound = '1';
      drawer.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-go]');
        if (!btn) return;
        const id = btn.getAttribute('data-go');
        if (id === 'suite') {
          try { renderSuiteLinkagePanel(); } catch (_) {}
          const repair = doc.getElementById('ds-linkage-repair-panel');
          if (repair && typeof repair.scrollIntoView === 'function') {
            repair.scrollIntoView({ behavior: 'smooth', block: 'start' });
            return;
          }
        }
        try {
          if (window.parent && typeof window.parent.setActive === 'function') {
            window.parent.setActive(id);
            if (id === 'suite') {
              setTimeout(() => {
                try { renderSuiteLinkagePanel(); } catch (_) {}
                const suiteDoc = moduleFrames?.suite?.contentWindow?.document || doc;
                const repair = suiteDoc?.getElementById?.('ds-linkage-repair-panel');
                if (repair && typeof repair.scrollIntoView === 'function') {
                  repair.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
              }, 160);
            }
            return;
          }
        } catch (_) {}
        try { location.hash = `#${id}`; } catch (_) {}
      });
    }
  }

  function ensureModuleReady(id) {
    const mod = MODULES[id];
    if (!mod) return null;
    if (moduleFrames[id]) return moduleFrames[id];

    const deck = document.getElementById('frameDeck');
    if (!deck) return null;
    const frame = document.createElement('iframe');
    frame.id = `frame-${id}`;
    frame.className = 'module-frame hidden';
    frame.title = `Unified module viewer - ${id}`;
    frame.setAttribute('sandbox', 'allow-scripts allow-same-origin');
    frame.srcdoc = mod.html;
    deck.appendChild(frame);
    moduleFrames[id] = frame;
    return frame;
  }

  function getActiveFrame() {
    return moduleFrames[activeId] || null;
  }

  function refreshSuiteFrame() {
    const frame = moduleFrames.suite;
    const doc = frame?.contentWindow?.document;
    const refreshBtn = doc?.getElementById('btnRefresh');
    if (refreshBtn) refreshBtn.click();
    setTimeout(() => {
      moveSuitePanelsToUtility();
      stackSuiteModulesRight();
      removeSuiteAside();
      convertSuiteLeftPanelsToSubtabs();
      enforceSuitePanelRemovals();
      renderSuiteCrossoverPanel();
      renderSuiteLinkagePanel();
      enhanceSuiteKpiDiagnostics();
      installSuitePopovers();
      syncSuiteRollupToUtility();
    }, 120);
  }

  /* ===================================================================
     IRIS  Interface for Resolution, Insight & Status
     Read-only query resolution engine (client-side, localStorage-backed)
     =================================================================== */

  const IRIS_ARTIFACT_MAP = {
    hiring:     ['MG'],
    bid:        ['DLR'],
    compliance: ['DS'],
    boe:        ['RS', 'PRIME'],
    suite:      ['EP']
  };

  const GATE_META = {
    'GATE-001': { what: 'At least one decision or baseline must be formally sealed.', why: 'Unsealed decisions lack institutional commitment and can be reversed without audit trail.', so: 'Until sealed, no downstream process should treat these decisions as authoritative.' },
    'GATE-002': { what: 'Key cost driver assumptions (rates, escalation, productivity) must be documented.', why: 'Missing assumptions mean pricing is based on implicit guesses, creating unquantified risk.', so: 'Document all three categories before any BOE can be considered defensible.' },
    'GATE-003': { what: 'Edge transport outbox must have 5 or fewer pending messages.', why: 'A growing outbox indicates sync failures between modules, meaning downstream systems are working with stale data.', so: 'Investigate and flush the outbox to restore data currency across modules.' },
    'GATE-004': { what: 'Total drift signals across all modules must be 6 or fewer.', why: 'Drift signals indicate data quality degradation, missing fields, or process deviations that erode institutional trust.', so: 'Each DS should be triaged: resolve the root cause or formally accept the deviation.' },
    'GATE-005': { what: 'At least 90% of compliance requirements must have a mapped compliance statement.', why: 'Unmapped requirements are blind spots in proposal compliance, risking non-responsiveness.', so: 'Assign owners and draft compliance statements for all remaining gaps before proposal submission.' },
    'GATE-006': { what: 'All bid/no-bid opportunities must have a sealed decision.', why: 'Open bid decisions consume resources without commitment and block downstream pricing and staffing.', so: 'Force a decision (Bid, No-Bid, or Watch) and seal it with an authority signature.' }
  };

  const MODULE_META = {
    hiring: { what: 'Tracks roles, candidates, interviews, offers, and hiring drift signals.', why: 'Staffing is the primary execution risk on most contracts. Unfilled roles cascade into schedule slips and cost overruns.', lens: 'Truth = roles + candidates, Reasoning = interviews + rationale sheets, Memory = drift history, Governance = sealed offers.' },
    bid: { what: 'Manages opportunities, gate scoring, assumptions, risks, and bid/no-bid decisions.', why: 'The bid decision commits institutional resources. A weak decision process leads to pursuing unwinnable work or missing viable opportunities.', lens: 'Truth = opportunities, Reasoning = assumptions + risks, Memory = drift + rationale, Governance = sealed decisions.' },
    compliance: { what: 'Tracks RFP requirements, compliance mapping, gaps, and deliverables.', why: 'Non-compliance is the fastest path to proposal elimination. Every unmapped requirement is a potential rejection risk.', lens: 'Truth = requirements + deliverables, Reasoning = mapped statements, Memory = gaps + rationale, Governance = baseline seal.' },
    boe: { what: 'Manages labor lines, rates, hours, cost assumptions, risk models, and BOE approval.', why: 'The BOE is the financial backbone of any proposal. Rate outliers, missing hours, or undocumented assumptions create audit and cost risk.', lens: 'Truth = labor lines, Reasoning = assumptions, Memory = assumption history, Governance = approval seal.' }
  };

  let irisHistory = [];
  let irisQueryType = 'WHY';
  let irisLastArtifacts = [];
  let irisLastQuery = '';

  function irisCollectArtifacts() {
    const artifacts = [];
    const now = Date.now();

    // Hiring  MG artifacts
    const hiring = readJsonSafe('ds_sequoia_hiring_console_v2_artifacts');
    if (hiring) {
      const roles = hiring.roles || hiring.sequoia_roles || [];
      roles.forEach((r, i) => {
        artifacts.push({ type: 'MG', id: `MG-${i+1}`, module: 'hiring', data: r, ts: r.updated_at || now, label: r.role_title || r.title || `Role ${i+1}` });
      });
      if (hiring.contract_id) {
        artifacts.push({ type: 'MG', id: 'MG-contract', module: 'hiring', data: { contract_id: hiring.contract_id }, ts: now, label: `Contract: ${hiring.contract_id}` });
      }
      // Candidates
      const candidates = hiring.candidates || [];
      candidates.forEach((c, i) => {
        artifacts.push({ type: 'MG', id: c.id || `MG-cand-${i+1}`, module: 'hiring', data: c, ts: c.updated_at || now, label: c.name || c.candidate_name || `Candidate ${i+1}` });
      });
      // Interviews
      const interviews = hiring.interviews || [];
      interviews.forEach((iv, i) => {
        artifacts.push({ type: 'MG', id: `MG-iv-${i+1}`, module: 'hiring', data: iv, ts: iv.date || now, label: iv.candidate || iv.role || `Interview ${i+1}` });
      });
      // Drift
      const hiringDrift = hiring.drift || [];
      hiringDrift.forEach((d, i) => {
        artifacts.push({ type: 'DS', id: `DS-hire-${i+1}`, module: 'hiring', data: d, ts: d.ts || now, label: d.msg || d.code || `Hiring Drift ${i+1}` });
      });
    }

    // Bid  DLR artifacts
    const bid = readJsonSafe('ds_bidnobid_console_v1');
    if (bid) {
      if (bid.decision) {
        artifacts.push({ type: 'DLR', id: 'DLR-decision', module: 'bid', data: bid.decision, ts: bid.decision?.timestamp || now, label: `Bid Decision: ${bid.decision?.verdict || 'pending'}` });
      }
      const factors = bid.factors || bid.evaluation_factors || [];
      factors.forEach((f, i) => {
        artifacts.push({ type: 'DLR', id: `DLR-F${i+1}`, module: 'bid', data: f, ts: now, label: f.name || f.factor || `Factor ${i+1}` });
      });
      // Opportunities
      const opps = bid.opportunities || [];
      opps.forEach((o, i) => {
        artifacts.push({ type: 'DLR', id: o.id || `DLR-OPP-${i+1}`, module: 'bid', data: o, ts: o.updated || o.created || now, label: o.customer || o.title || o.id || `Opportunity ${i+1}` });
      });
      // Assumptions
      const assumptions = bid.assumptions || [];
      assumptions.forEach((a, i) => {
        artifacts.push({ type: 'DLR', id: a.id || `DLR-ASM-${i+1}`, module: 'bid', data: a, ts: a.created || now, label: a.description || a.text || a.category || `Assumption ${i+1}` });
      });
      // Risks
      const risks = bid.risks || [];
      risks.forEach((r, i) => {
        artifacts.push({ type: 'DLR', id: r.id || `DLR-RISK-${i+1}`, module: 'bid', data: r, ts: r.created || now, label: r.description || r.title || r.category || `Risk ${i+1}` });
      });
      // Drift signals
      const bidDrift = bid.drift || [];
      bidDrift.forEach((d, i) => {
        artifacts.push({ type: 'DS', id: `DS-bid-${i+1}`, module: 'bid', data: d, ts: d.ts || now, label: d.msg || d.code || `Bid Drift ${i+1}` });
      });
    }

    // Compliance  DS artifacts
    const compliance = readJsonSafe('ds_compliance_matrix_v1');
    if (compliance) {
      const items = compliance.items || compliance.requirements || compliance.matrix || [];
      items.forEach((item, i) => {
        artifacts.push({ type: 'DS', id: `DS-${i+1}`, module: 'compliance', data: item, ts: now, label: item.requirement || item.name || `Compliance ${i+1}` });
      });
      if (compliance.drift_signals || compliance.driftSignals) {
        const ds = compliance.drift_signals || compliance.driftSignals || [];
        ds.forEach((d, i) => {
          artifacts.push({ type: 'DS', id: `DS-drift-${i+1}`, module: 'compliance', data: d, ts: d.detected_at || now, label: d.description || d.signal || `Drift ${i+1}` });
        });
      }
      // Gaps
      const gaps = compliance.gaps || [];
      gaps.forEach((g, i) => {
        artifacts.push({ type: 'DS', id: `DS-gap-${i+1}`, module: 'compliance', data: g, ts: g.created || now, label: g.description || g.title || `Gap ${i+1}` });
      });
      // Deliverables
      const deliverables = compliance.deliverables || [];
      deliverables.forEach((d, i) => {
        artifacts.push({ type: 'DS', id: `DS-del-${i+1}`, module: 'compliance', data: d, ts: now, label: d.name || d.title || `Deliverable ${i+1}` });
      });
      // Intake
      if (compliance.intake) {
        artifacts.push({ type: 'DS', id: 'DS-intake', module: 'compliance', data: compliance.intake, ts: now, label: `Compliance Intake${compliance.intake?.baseline_sealed ? ' (Sealed)' : ''}` });
      }
    }

    // BOE  RS + PRIME artifacts
    const boe = readJsonSafe('ds_boe_pricing_v1');
    if (boe) {
      const rationales = boe.rationale_sheets || boe.rationales || [];
      rationales.forEach((r, i) => {
        artifacts.push({ type: 'RS', id: `RS-${i+1}`, module: 'boe', data: r, ts: now, label: r.title || r.name || `Rationale ${i+1}` });
      });
      const decisions = boe.decisions || boe.prime_decisions || [];
      decisions.forEach((d, i) => {
        artifacts.push({ type: 'PRIME', id: `PRIME-${i+1}`, module: 'boe', data: d, ts: d.sealed_at || now, label: d.title || d.decision || `Decision ${i+1}` });
      });
      if (boe.wbs || boe.cost_elements) {
        const wbs = boe.wbs || boe.cost_elements || [];
        wbs.forEach((w, i) => {
          artifacts.push({ type: 'RS', id: `RS-wbs-${i+1}`, module: 'boe', data: w, ts: now, label: w.name || w.element || `WBS ${i+1}` });
        });
      }
      // Labor lines
      const labor = boe.labor || [];
      labor.forEach((l, i) => {
        artifacts.push({ type: 'RS', id: `RS-labor-${i+1}`, module: 'boe', data: l, ts: now, label: l.task || l.role || l.name || `Labor ${i+1}` });
      });
      // Assumptions
      const boeAssumptions = boe.assumptions || [];
      boeAssumptions.forEach((a, i) => {
        artifacts.push({ type: 'RS', id: `RS-asm-${i+1}`, module: 'boe', data: a, ts: now, label: a.text || a.description || a.category || `BOE Assumption ${i+1}` });
      });
      // Approval/intake
      if (boe.approval) {
        artifacts.push({ type: 'PRIME', id: 'PRIME-approval', module: 'boe', data: boe.approval, ts: boe.approval?.sealed_at || now, label: `BOE Approval: ${boe.approval?.sealed ? 'Sealed' : 'Pending'}` });
      }
      if (boe.intake) {
        artifacts.push({ type: 'RS', id: 'RS-intake', module: 'boe', data: boe.intake, ts: now, label: `BOE Intake` });
      }
    }

    // Suite  EP (episode) artifacts from rollup
    const rollupHist = readJsonSafe('ds_sequoia_suite_rollup_history_v1');
    if (Array.isArray(rollupHist)) {
      rollupHist.forEach((ep, i) => {
        artifacts.push({ type: 'EP', id: `EP-${i+1}`, module: 'suite', data: ep, ts: ep.timestamp || ep.ts || now, label: `Episode ${i+1}` });
      });
    }

    // Edge outbox data
    const hiringOutbox = readJsonSafe('ds_sequoia_edge_outbox_v1');
    if (Array.isArray(hiringOutbox)) {
      hiringOutbox.forEach((msg, i) => {
        artifacts.push({ type: 'MG', id: `MG-edge-${i+1}`, module: 'hiring', data: msg, ts: msg.ts || now, label: `Edge msg: ${msg.type || 'outbox'}` });
      });
    }
    const bidOutbox = readJsonSafe('ds_bidnobid_edge_outbox_v1');
    if (Array.isArray(bidOutbox)) {
      bidOutbox.forEach((msg, i) => {
        artifacts.push({ type: 'DLR', id: `DLR-edge-${i+1}`, module: 'bid', data: msg, ts: msg.ts || now, label: `Edge msg: ${msg.type || 'outbox'}` });
      });
    }

    // Deduplicate by id
    const seen = new Set();
    const deduped = [];
    for (const a of artifacts) {
      if (!seen.has(a.id)) { seen.add(a.id); deduped.push(a); }
    }
    return deduped.sort((a, b) => (b.ts || 0) - (a.ts || 0));
  }

  // Word-boundary match: treats _ - . / as word separators so
  // "change" matches "change" and "status_change" but NOT "changed" or "status_changed"
  const _wordReCache = {};
  function irisWordTest(text, query) {
    let re = _wordReCache[query];
    if (!re) {
      const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      re = _wordReCache[query] = new RegExp('\\b' + escaped + '\\b', 'i');
    }
    return re.test(text.replace(/[_\-./]/g, ' '));
  }

  function irisMatchQuery(query, artifact) {
    const q = query.toLowerCase().trim();
    if (!q) return false;
    const label = (artifact.label || '').toLowerCase();
    const mod = (artifact.module || '').toLowerCase();
    const type = (artifact.type || '').toLowerCase();
    const primary = label + ' ' + mod + ' ' + type;
    // Word-boundary match in primary fields
    if (irisWordTest(primary, q)) return true;
    // Multi-term: all terms must word-match in primary fields
    const terms = q.split(/\s+/).filter(t => t.length > 0);
    if (terms.length > 1 && terms.every(t => irisWordTest(primary, t))) return true;
    // Fall back to full data search with word boundaries
    const dataStr = JSON.stringify(artifact.data || {}).toLowerCase();
    if (irisWordTest(dataStr, q)) return true;
    return false;
  }

  function irisScoreMatch(query, artifact) {
    const q = query.toLowerCase().trim();
    if (!q) return 0;
    const label = (artifact.label || '').toLowerCase();
    const mod = (artifact.module || '').toLowerCase();
    const type = (artifact.type || '').toLowerCase();
    let score = 0;
    if (irisWordTest(label, q)) score += 10;
    if (irisWordTest(type, q) || irisWordTest(mod, q)) score += 5;
    const terms = q.split(/\s+/).filter(t => t.length > 0);
    const primary = label + ' ' + mod + ' ' + type;
    if (terms.length > 1 && terms.every(t => irisWordTest(primary, t))) score += 7;
    if (label.startsWith(q)) score += 3;
    if (score === 0) {
      const dataStr = JSON.stringify(artifact.data || {}).toLowerCase();
      if (irisWordTest(dataStr, q)) score += 1;
    }
    return score;
  }

  function irisFilterAndRank(query, pool) {
    return pool
      .filter(a => irisMatchQuery(query, a))
      .map(a => ({ ...a, _score: irisScoreMatch(query, a) }))
      .sort((a, b) => b._score - a._score);
  }

  // Shared data search: mode='first' returns first {key,snippet}, mode='all' returns [{key,value,matchType}]
  function irisSearchData(q, data, mode) {
    if (!q || !data || typeof data !== 'object') return mode === 'all' ? [] : null;
    const results = [];
    function walk(obj, path) {
      if (!obj || typeof obj !== 'object') return;
      const entries = Array.isArray(obj) ? obj.map((v, i) => [String(i), v]) : Object.entries(obj);
      for (const [k, v] of entries) {
        const kPath = path ? path + (Array.isArray(obj) ? '[' + k + ']' : '.' + k) : k;
        if (irisWordTest(k, q)) {
          if (mode === 'first') return { key: kPath, snippet: k };
          results.push({ key: kPath, value: v, matchType: 'key' });
        }
        if (typeof v === 'string' && irisWordTest(v, q)) {
          if (mode === 'first') return { key: kPath, snippet: irisSnippet(v, q) };
          if (!results.find(r => r.key === kPath)) results.push({ key: kPath, value: v, matchType: 'value' });
        } else if ((typeof v === 'number' || typeof v === 'boolean') && irisWordTest(String(v), q)) {
          if (mode === 'first') return { key: kPath, snippet: String(v) };
          if (!results.find(r => r.key === kPath)) results.push({ key: kPath, value: v, matchType: 'value' });
        }
        if (v && typeof v === 'object') {
          const found = walk(v, kPath);
          if (mode === 'first' && found) return found;
        }
      }
      return mode === 'first' ? null : undefined;
    }
    const r = walk(data, '');
    return mode === 'all' ? results.slice(0, 10) : r;
  }

  function irisSnippet(text, term) {
    const normalized = text.replace(/[_\-./]/g, ' ');
    const escaped = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const m = new RegExp('\\b' + escaped + '\\b', 'i').exec(normalized);
    if (!m) return null;
    const idx = m.index;
    const start = Math.max(0, idx - 20);
    const end = Math.min(text.length, idx + term.length + 20);
    return (start > 0 ? '...' : '') + text.slice(start, end) + (end < text.length ? '...' : '');
  }

  function irisGetMatchContext(query, artifact) {
    const q = query.toLowerCase().trim();
    if (!q) return '';
    const data = artifact.data;
    const ctx = irisSearchData(q, data, 'first');
    if (ctx) return ` <span style="color:var(--muted);font-size:11px">matched <em>${escapeHtml(ctx.key)}</em>: "<span class="iris-hl">${escapeHtml(ctx.snippet)}</span>"</span>`;
    if (data) {
      const snip = irisSnippet(JSON.stringify(data), q);
      if (snip) return ` <span style="color:var(--muted);font-size:11px">matched in data: "<span class="iris-hl">${escapeHtml(snip)}</span>"</span>`;
    }
    return '';
  }

  function irisFindAllMatches(query, data) {
    return irisSearchData(query.toLowerCase().trim(), data, 'all');
  }

  function irisFormatHitLine(h, query) {
    const ctx = query ? irisGetMatchContext(query, h) : '';
    return `<a class="iris-alink" data-rid="${escapeHtml(h.id)}">${escapeHtml(h.type)}/${escapeHtml(h.id)}</a> (${escapeHtml(h.module)}): ${escapeHtml(h.label)}${ctx}\n`;
  }

  function irisScoreConfidence(hits, totalSearched) {
    if (hits.length === 0) return { score: 0, status: 'NOT_FOUND' };
    // Found hits  floor at PARTIAL (0.4 minimum)
    let score = 0.4;
    // Best hit quality bonus
    const topScore = hits[0]?._score || 0;
    score += Math.min(topScore / 10, 1) * 0.25;
    // Hit count bonus (diminishing returns)
    score += Math.min(hits.length - 1, 4) * 0.05;
    // Cross-module corroboration
    const modules = new Set(hits.map(h => h.module));
    if (modules.size > 1 && hits.length >= 3) score += 0.1;
    score = Math.min(score, 1.0);
    // NOT_FOUND only when zero hits; any match = at least PARTIAL
    const status = score >= 0.7 ? 'RESOLVED' : 'PARTIAL';
    return { score, status };
  }

  function irisBuildProvenance(hits) {
    if (hits.length === 0) return [];
    const topModule = hits[0].module;
    const topScore = hits[0]._score || 10;
    return hits.map((h, i) => {
      let role;
      const s = h._score || 0;
      if (i === 0) role = 'source';
      else if (s >= topScore * 0.7 && h.module === topModule) role = 'evidence';
      else if (s >= topScore * 0.7) role = 'evidence';
      else role = 'context';
      return { artifact: h.type, ref_id: h.id, role, detail: h.label, module: h.module };
    });
  }

  // Shared resolver result builder
  function irisResult(combined, allArtifacts, query, opts) {
    const { score, status } = irisScoreConfidence(combined, allArtifacts.length);
    const limit = opts.limit || 10;
    let answer = '';
    if (combined.length === 0) {
      answer = opts.empty || 'No artifacts found matching this query.';
    } else {
      answer = opts.prefix || `Found ${combined.length} artifact(s):\n\n`;
      combined.slice(0, limit).forEach(h => {
        answer += opts.formatHit ? opts.formatHit(h) : irisFormatHitLine(h, query);
      });
      if (combined.length > limit) answer += `\n... and ${combined.length - limit} more.`;
      if (opts.suffix) answer += opts.suffix;
    }
    return { status, confidence: score, answer, provenance: irisBuildProvenance(combined.slice(0, 10)), modules: [...new Set(combined.map(h => h.module))], ...(opts.extra || {}) };
  }

  // Deduplicate and merge hit lists
  function irisMergeHits(hits, extras) {
    const seen = new Set(hits.map(h => h.id));
    return [...hits, ...extras.filter(a => !seen.has(a.id))];
  }

  function irisResolveWhy(query, artifacts) {
    const q = query.toLowerCase();
    const hits = irisFilterAndRank(query, artifacts);
    const driftTerms = ['drift', 'governance', 'red', 'yellow', 'status', 'signal', 'compliance', 'violation', 'degraded', 'failing'];
    const decisionTerms = ['decision', 'sealed', 'rationale', 'prime', 'approved', 'rejected', 'verdict'];
    const wantsDrift = driftTerms.some(t => q.includes(t));
    const wantsDecisions = decisionTerms.some(t => q.includes(t));
    const extra = [
      ...(wantsDrift ? artifacts.filter(a => a.type === 'DS' && a.id.includes('drift')) : []),
      ...(wantsDrift ? artifacts.filter(a => a.module === 'compliance').slice(0, 5) : []),
      ...(wantsDecisions ? artifacts.filter(a => a.type === 'PRIME' || (a.type === 'DLR' && a.id.includes('decision'))) : [])
    ];
    const combined = irisMergeHits(hits, extra);
    const driftCount = artifacts.filter(a => a.type === 'DS' && a.id.includes('drift')).length;
    const suffix = driftCount > 0 && ['red', 'governance', 'drift'].some(t => q.includes(t)) ? `\n${driftCount} active drift signal(s) detected.` : '';
    return irisResult(combined, artifacts, query, { limit: 8, prefix: `Found ${combined.length} artifact(s) across [${[...new Set(combined.map(h => h.module))].join(', ')}] that explain this condition.\n\n`, empty: 'No artifacts found matching this query. Try a more specific term or check that module data is loaded.', suffix });
  }

  function irisResolveWhatChanged(query, artifacts) {
    const hits = irisFilterAndRank(query, artifacts);
    const extra = [...artifacts.filter(a => a.type === 'EP').slice(0, 5), ...artifacts.filter(a => a.id.includes('edge')).slice(0, 5)];
    const combined = irisMergeHits(hits, extra);
    return irisResult(combined, artifacts, query, {
      prefix: `Timeline of ${combined.length} change artifact(s):\n\n`,
      empty: 'No change history found. Run Suite rollup to generate episode data.',
      formatHit: h => {
        const ts = h.ts ? new Date(h.ts).toLocaleString() : 'unknown';
        return `<a class="iris-alink" data-rid="${escapeHtml(h.id)}">${escapeHtml(h.type)}/${escapeHtml(h.id)}</a> [${ts}]: ${escapeHtml(h.label)}${irisGetMatchContext(query, h)}\n`;
      }
    });
  }

  function irisResolveWhatDrifted(query, artifacts) {
    const driftPool = artifacts.filter(a => a.type === 'DS' || a.id.includes('drift'));
    const combined = query.trim() ? (irisFilterAndRank(query, driftPool).length > 0 ? irisFilterAndRank(query, driftPool) : driftPool) : driftPool;
    return irisResult(combined, artifacts, query, {
      prefix: `${combined.length} drift-related artifact(s) found:\n\n`,
      empty: 'No drift signals detected. Compliance module may not have data loaded.',
      formatHit: h => {
        let line = irisFormatHitLine(h, query);
        if (h.data?.severity) line += `  Severity: ${h.data.severity}\n`;
        if (h.data?.status) line += `  Status: ${h.data.status}\n`;
        return line;
      }
    });
  }

  function irisResolveRecall(query, artifacts) {
    const hits = irisFilterAndRank(query, artifacts);
    return irisResult(hits, artifacts, query, {
      limit: 12,
      prefix: `Recalled ${hits.length} artifact(s):\n\n`,
      empty: `No artifacts matching "${escapeHtml(query)}". Loaded modules: ${[...new Set(artifacts.map(a => a.module))].join(', ') || 'none'}.`
    });
  }

  function irisResolveStatus(query, artifacts) {
    const moduleGroups = {};
    artifacts.forEach(a => { (moduleGroups[a.module] = moduleGroups[a.module] || []).push(a); });
    const rollup = (function() { try { return JSON.parse(document.getElementById('rollupPreview')?.value || ''); } catch(_) { return null; } })();
    const modules = Object.keys(moduleGroups);
    const { score } = irisScoreConfidence(artifacts, artifacts.length);
    let answer = `<strong>System Status Summary</strong>\nTotal artifacts: ${artifacts.length} across ${modules.length} module(s)\n\n`;
    if (rollup) {
      const ds = Number(rollup.ds ?? 0), sealed = Number(rollup.sealed ?? 0), ep = Number(rollup.episodes ?? 0), truth = Number(rollup.truth ?? 0);
      const gov = ds === 0 ? 'GREEN' : ds <= 6 ? 'YELLOW' : 'RED';
      answer += `<strong>Rollup KPIs:</strong> Episodes=${ep}, DS=${ds}, Sealed=${sealed}, Truth=${truth}\nGovernance (DS-based): <strong>${gov}</strong>\n\n`;
    } else {
      answer += `<em style="color:var(--muted)">Rollup data unavailable  run Suite rollup to populate KPIs.</em>\n\n`;
    }
    answer += `<strong>Module Health</strong>\n`;
    const dimensions = [];
    modules.forEach(mod => {
      const group = moduleGroups[mod], types = [...new Set(group.map(a => a.type))], total = group.length;
      const driftCount = group.filter(a => a.id.includes('drift')).length;
      const health = Math.max(0, Math.min(100, Math.round(((total - driftCount) / Math.max(total, 1)) * 100)));
      dimensions.push({ mod, total, types, health, first: group[0] });
      answer += `<a class="iris-alink" data-rid="${group[0].id}">${mod}</a>: ${total} artifact(s) [${types.join(', ')}]  health: ${health}%\n`;
    });
    let provSource = artifacts.slice(0, 6);
    if (query.trim()) {
      const hits = irisFilterAndRank(query, artifacts);
      if (hits.length > 0) {
        answer += `\n<strong>Filtered to "${escapeHtml(query)}":</strong> ${hits.length} match(es)\n\n`;
        hits.slice(0, 10).forEach(h => { answer += irisFormatHitLine(h, query); });
        if (hits.length > 10) answer += `\n... and ${hits.length - 10} more.`;
        provSource = hits.slice(0, 6);
      }
    }
    return { status: artifacts.length > 0 ? 'RESOLVED' : 'NOT_FOUND', confidence: score, answer, provenance: irisBuildProvenance(provSource), modules, dimensions };
  }

  function irisResolve(queryType, queryText) {
    irisLastQuery = queryText;
    const artifacts = irisCollectArtifacts();
    irisLastArtifacts = artifacts;
    const resolvers = {
      WHY: irisResolveWhy,
      WHAT_CHANGED: irisResolveWhatChanged,
      WHAT_DRIFTED: irisResolveWhatDrifted,
      RECALL: irisResolveRecall,
      STATUS: irisResolveStatus
    };
    const resolver = resolvers[queryType] || resolvers.RECALL;
    const result = resolver(queryText, artifacts);
    irisHistory.unshift({ queryType, queryText, result, ts: Date.now() });
    if (irisHistory.length > 20) irisHistory.length = 20;
    return result;
  }

  /* IRIS UI Controller */

  function irisFormatValue(val, depth) {
    if (depth === undefined) depth = 0;
    if (val === null || val === undefined) return '<span class="iris-kv-primitive iris-kv-null">null</span>';
    if (typeof val === 'boolean') return `<span class="iris-kv-primitive iris-kv-bool">${val}</span>`;
    if (typeof val === 'number') return `<span class="iris-kv-primitive iris-kv-number">${val}</span>`;
    if (typeof val === 'string') {
      if (val.length > 200) return `<span class="iris-kv-primitive iris-kv-string">${escapeHtml(val.slice(0, 200))}...</span>`;
      return `<span class="iris-kv-primitive iris-kv-string">${escapeHtml(val)}</span>`;
    }
    if (Array.isArray(val)) {
      if (val.length === 0) return '<span class="iris-kv-primitive iris-kv-null">[ ]</span>';
      if (depth > 4) {
        const eid = 'kv-' + Math.random().toString(36).slice(2, 8);
        return `<span class="iris-kv-primitive iris-kv-null">[${val.length} items]</span><button class="iris-kv-expand" onclick="var el=document.getElementById('${eid}');el.style.display=el.style.display==='none'?'block':'none';this.textContent=el.style.display==='none'?'expand':'collapse'">expand</button><div id="${eid}" style="display:none">${val.map((item, i) => '<div class=\"iris-kv-arr-item\"><span class=\"iris-kv-arr-idx\">[' + i + ']</span> ' + irisFormatValue(item, depth + 1) + '</div>').join('')}</div>`;
      }
      let html = '';
      val.forEach((item, i) => {
        html += `<div class="iris-kv-arr-item"><span class="iris-kv-arr-idx">[${i}]</span> ${irisFormatValue(item, depth + 1)}</div>`;
      });
      return html;
    }
    if (typeof val === 'object') {
      const keys = Object.keys(val);
      if (keys.length === 0) return '<span class="iris-kv-primitive iris-kv-null">{ }</span>';
      if (depth > 4) {
        const eid = 'kv-' + Math.random().toString(36).slice(2, 8);
        return `<span class="iris-kv-primitive iris-kv-null">{${keys.length} fields}</span><button class="iris-kv-expand" onclick="var el=document.getElementById('${eid}');el.style.display=el.style.display==='none'?'block':'none';this.textContent=el.style.display==='none'?'expand':'collapse'">expand</button><div id="${eid}" style="display:none"><table class="iris-kv-table">${keys.map(k => '<tr><td class=\"kv-key\">' + escapeHtml(k) + '</td><td class=\"kv-val\">' + irisFormatValue(val[k], depth + 1) + '</td></tr>').join('')}</table></div>`;
      }
      let html = '<div class="' + (depth > 0 ? 'iris-kv-nested' : '') + '"><table class="iris-kv-table">';
      keys.forEach(k => {
        html += `<tr><td class="kv-key">${escapeHtml(k)}</td><td class="kv-val">${irisFormatValue(val[k], depth + 1)}</td></tr>`;
      });
      html += '</table></div>';
      return html;
    }
    return escapeHtml(String(val));
  }

  function irisHighlight(html, query) {
    if (!query || !query.trim()) return html;
    const terms = [query.trim()];
    const words = query.trim().split(/\s+/).filter(w => w.length > 1);
    if (words.length > 1) terms.push(...words);
    const escaped = terms.map(t => t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
    const re = new RegExp('(' + escaped.join('|') + ')', 'gi');
    const hl = '<span class="iris-hl">$1</span>';
    // If no HTML tags present, highlight directly
    if (!html.includes('<')) return html.replace(re, hl);
    // Split into tags and text segments, only highlight text
    return html.replace(/(<[^>]*>)|([^<]+)/g, (match, tag, text) => {
      if (tag) return tag;
      return text.replace(re, hl);
    });
  }

  function irisOpenPopover(refId) {
    const artifact = irisLastArtifacts.find(a => a.id === refId);
    if (!artifact) return;
    const overlay = document.getElementById('iris-popover-overlay');
    const title = document.getElementById('irisPopTitle');
    const meta = document.getElementById('irisPopMeta');
    const label = document.getElementById('irisPopLabel');
    const data = document.getElementById('irisPopData');
    if (!overlay || !title || !meta || !label || !data) return;
    const q = irisLastQuery || document.getElementById('irisQuery')?.value?.trim() || '';
    title.innerHTML = irisHighlight(escapeHtml(`${artifact.type} / ${artifact.id}`), q);
    const modColors = { hiring: '#7df9ff', bid: '#ffcc66', compliance: '#ff6b6b', boe: '#5dff93', suite: '#c4b5fd' };
    const modColor = modColors[artifact.module] || 'var(--accent)';
    meta.innerHTML = [
      `<span style="border-color:${modColor};color:${modColor}">${escapeHtml(artifact.module)}</span>`,
      `<span>${escapeHtml(artifact.type)}</span>`,
      `<span>${artifact.ts ? new Date(artifact.ts).toLocaleString() : 'no timestamp'}</span>`
    ].join('');
    label.innerHTML = irisHighlight(escapeHtml(artifact.label || ''), q);
    let dataHtml = '';
    // Show matched fields at the top when searching
    if (q) {
      let matchSection = '';
      // Search structured data fields
      if (artifact.data && typeof artifact.data === 'object') {
        const matches = irisFindAllMatches(q, artifact.data);
        if (matches.length > 0) {
          matchSection += `<div style="font-size:11px;color:#ffcc66;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">Matched Fields (${matches.length})</div>`;
          matchSection += `<table class="iris-kv-table">`;
          matches.forEach(m => {
            let valHtml;
            if (m.value && typeof m.value === 'object') {
              valHtml = irisFormatValue(m.value, 2);
            } else {
              valHtml = irisFormatValue(m.value, 0);
            }
            valHtml = irisHighlight(valHtml, q);
            const keyHtml = irisHighlight(escapeHtml(m.key), q);
            matchSection += `<tr><td class="kv-key">${keyHtml}</td><td class="kv-val">${valHtml}</td></tr>`;
          });
          matchSection += `</table>`;
        }
      }
      // If no structured field matches, try stringify fallback on data
      if (!matchSection && artifact.data) {
        const str = JSON.stringify(artifact.data).toLowerCase();
        if (str.includes(q.toLowerCase())) {
          const idx = str.indexOf(q.toLowerCase());
          const start = Math.max(0, idx - 30);
          const end = Math.min(str.length, idx + q.length + 30);
          const snip = (start > 0 ? '...' : '') + JSON.stringify(artifact.data).slice(start, end) + (end < str.length ? '...' : '');
          matchSection += `<div style="font-size:11px;color:#ffcc66;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">Matched in Data</div>`;
          matchSection += `<table class="iris-kv-table"><tr><td class="kv-key">context</td><td class="kv-val">${irisHighlight(escapeHtml(snip), q)}</td></tr></table>`;
        }
      }
      if (matchSection) {
        dataHtml += `<div style="margin-bottom:12px;padding:10px;background:#1a2538;border:1px solid rgba(255,204,66,.25);border-radius:8px">${matchSection}</div>`;
      }
    }
    // Full data tree
    if (artifact.data && typeof artifact.data === 'object' && Object.keys(artifact.data).length > 0) {
      dataHtml += irisHighlight(irisFormatValue(artifact.data, 0), q);
    } else if (artifact.data !== undefined && artifact.data !== null) {
      dataHtml += irisHighlight(irisFormatValue(artifact.data, 0), q);
    } else {
      dataHtml += '<span class="iris-kv-null" style="padding:8px;display:block">No data attached to this artifact.</span>';
    }
    data.innerHTML = dataHtml;
    overlay.classList.add('open');
  }

  function irisRenderResult(result) {
    const el = document.getElementById('irisResult');
    if (!el) return;
    const statusCls = result.status === 'RESOLVED' ? 'resolved' : result.status === 'PARTIAL' ? 'partial' : 'not-found';
    const confPct = Math.round(result.confidence * 100);
    const confCls = result.confidence >= 0.7 ? 'high' : result.confidence >= 0.4 ? 'mid' : 'low';
    let html = '';
    html += `<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">`;
    html += `<span class="iris-status-pill ${statusCls}">${result.status.replace('_', ' ')}</span>`;
    html += `<div class="iris-conf-wrap" style="flex:1;margin:0">`;
    html += `<div class="iris-conf-label">Confidence: ${confPct}%</div>`;
    html += `<div class="iris-conf-bar"><div class="iris-conf-fill ${confCls}" style="width:${confPct}%"></div></div>`;
    html += `</div></div>`;
    // Format answer with section breaks + highlight query terms
    const q = irisLastQuery || document.getElementById('irisQuery')?.value?.trim() || '';
    let answerHtml = result.answer
      .replace(/\n\n/g, '</div><div class="iris-answer-section">')
      .replace(/\n/g, '<br>');
    if (q) answerHtml = irisHighlight(answerHtml, q);
    html += `<div class="iris-answer"><div class="iris-answer-section">${answerHtml}</div></div>`;
    // Dimensional health bars (STATUS query)
    if (result.dimensions && result.dimensions.length > 0) {
      html += `<div class="iris-dim-grid">`;
      result.dimensions.forEach(d => {
        const cls = d.health >= 80 ? '#5dff93' : d.health >= 50 ? '#ffcc66' : '#ff6b6b';
        html += `<div class="iris-dim-card">`;
        html += `<div class="dim-label">${escapeHtml(d.mod)} <span style="color:var(--muted)">(${d.total})</span></div>`;
        html += `<div class="dim-bar"><div class="dim-fill" style="width:${d.health}%;background:${cls}"></div></div>`;
        html += `<div class="dim-val" style="color:${cls}">${d.health}%</div>`;
        html += `</div>`;
      });
      html += `</div>`;
    }
    // Provenance chain
    if (result.provenance && result.provenance.length > 0) {
      html += `<div style="font-size:12px;color:var(--muted);margin:10px 0 4px">Provenance Chain <span style="font-size:10px">(click to inspect)</span></div>`;
      html += `<div class="iris-prov-chain">`;
      result.provenance.forEach(p => {
        html += `<div class="iris-prov-item clickable" data-rid="${escapeHtml(p.ref_id)}">`;
        html += `<span class="prov-role ${p.role}">${p.role}</span>`;
        html += `<span class="prov-artifact">${escapeHtml(p.artifact)}/${escapeHtml(p.ref_id)}</span>`;
        html += `<div class="prov-detail">${escapeHtml(p.detail)} <span style="color:var(--muted)">(${p.module})</span></div>`;
        html += `</div>`;
      });
      html += `</div>`;
    }
    // Module badges
    if (result.modules && result.modules.length > 0) {
      html += `<div class="iris-modules-affected">`;
      result.modules.forEach(m => { html += `<span class="iris-mod-badge">${escapeHtml(m)}</span>`; });
      html += `</div>`;
    }
    // Raw JSON toggle
    const rawId = 'iris-raw-' + Date.now();
    html += `<button class="iris-raw-toggle" onclick="var el=document.getElementById('${rawId}');el.style.display=el.style.display==='none'?'block':'none';this.textContent=el.style.display==='none'?'Show Raw JSON':'Hide Raw JSON'">Show Raw JSON</button>`;
    html += `<pre class="iris-raw-pre" id="${rawId}" style="display:none">${escapeHtml(JSON.stringify(result, null, 2))}</pre>`;
    el.innerHTML = html;
  }

  let irisSelectedHistIdx = -1;

  function irisSaveHistory() {
    try { sessionStorage.setItem('iris_history', JSON.stringify(irisHistory)); } catch(_) {}
  }

  function irisLoadHistory() {
    try {
      const raw = sessionStorage.getItem('iris_history');
      if (raw) irisHistory = JSON.parse(raw);
    } catch(_) {}
  }

  function irisRenderHistory() {
    const list = document.getElementById('irisHistoryList');
    if (!list) return;
    if (irisHistory.length === 0) {
      list.innerHTML = '<div class="iris-empty">No queries yet. Select a type and ask IRIS.</div>';
      return;
    }
    list.innerHTML = irisHistory.map((h, i) => {
      const ts = new Date(h.ts).toLocaleTimeString();
      const statusCls = h.result.status === 'RESOLVED' ? 'color:#5dff93' : h.result.status === 'PARTIAL' ? 'color:#ffcc66' : 'color:#ff6b6b';
      const activeCls = i === irisSelectedHistIdx ? ' active' : '';
      const confPct = Math.round((h.result.confidence || 0) * 100);
      return `<div class="iris-history-item${activeCls}" data-idx="${i}">
        <span class="hist-type">${h.queryType.replace('_', ' ')}</span>
        <span class="hist-query">${escapeHtml(h.queryText || '(empty)')}</span>
        <span class="hist-status" style="${statusCls}">${h.result.status.replace('_', ' ')} ${confPct}%</span>
        <span class="hist-ts">${ts}</span>
      </div>`;
    }).join('');
  }

  function irisInit() {
    irisLoadHistory();

    const typeButtons = document.querySelectorAll('.iris-type');
    typeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        typeButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        irisQueryType = btn.dataset.qt;
        // Clear validation message on type change
        const val = document.getElementById('irisValidation');
        if (val) val.textContent = '';
      });
    });

    const goBtn = document.getElementById('irisGo');
    const queryInput = document.getElementById('irisQuery');
    let irisQuerying = false;

    // Insert validation message element
    const inputRow = queryInput?.parentElement;
    if (inputRow) {
      const valEl = document.createElement('div');
      valEl.id = 'irisValidation';
      valEl.className = 'iris-validation';
      inputRow.insertAdjacentElement('afterend', valEl);
    }

    function runIrisQuery() {
      if (irisQuerying) return;
      const valEl = document.getElementById('irisValidation');
      const q = queryInput?.value?.trim() || '';
      if (!q && irisQueryType !== 'STATUS') {
        if (valEl) valEl.textContent = irisQueryType === 'WHY' ? 'Enter a question  e.g. "why is governance red?"' : 'Enter a search term to query IRIS.';
        return;
      }
      if (valEl) valEl.textContent = '';
      // Loading state
      irisQuerying = true;
      if (goBtn) { goBtn.classList.add('loading'); goBtn.innerHTML = '<span class="iris-spin"></span>Resolving...'; }
      setTimeout(() => {
        try {
          const result = irisResolve(irisQueryType, q);
          irisSelectedHistIdx = 0;
          irisRenderResult(result);
          irisRenderHistory();
          irisSaveHistory();
        } catch(err) {
          const el = document.getElementById('irisResult');
          if (el) el.innerHTML = `<div style="color:#ff6b6b;padding:10px"><strong>Resolution Error:</strong> ${escapeHtml(err.message || String(err))}</div>`;
        }
        irisQuerying = false;
        if (goBtn) { goBtn.classList.remove('loading'); goBtn.textContent = 'Resolve'; }
      }, 30);
    }
    if (goBtn) goBtn.addEventListener('click', runIrisQuery);
    if (queryInput) queryInput.addEventListener('keydown', e => { if (e.key === 'Enter') runIrisQuery(); });
    // Clear validation on typing
    if (queryInput) queryInput.addEventListener('input', () => { const v = document.getElementById('irisValidation'); if (v) v.textContent = ''; });

    const histList = document.getElementById('irisHistoryList');
    if (histList) {
      histList.addEventListener('click', e => {
        const item = e.target.closest('.iris-history-item');
        if (!item) return;
        const idx = parseInt(item.dataset.idx, 10);
        if (irisHistory[idx]) {
          irisSelectedHistIdx = idx;
          // Restore query state
          if (queryInput) queryInput.value = irisHistory[idx].queryText || '';
          irisQueryType = irisHistory[idx].queryType;
          typeButtons.forEach(b => b.classList.toggle('active', b.dataset.qt === irisQueryType));
          // Re-collect artifacts for popover lookups
          irisLastArtifacts = irisCollectArtifacts();
          irisRenderResult(irisHistory[idx].result);
          irisRenderHistory();
        }
      });
    }

    // Popover: close handlers
    const popOverlay = document.getElementById('iris-popover-overlay');
    if (popOverlay) {
      popOverlay.addEventListener('click', e => { if (e.target === popOverlay) popOverlay.classList.remove('open'); });
    }
    const popClose = document.getElementById('irisPopClose');
    if (popClose) popClose.addEventListener('click', () => popOverlay?.classList.remove('open'));
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && popOverlay?.classList.contains('open')) popOverlay.classList.remove('open'); });

    // Delegated click on artifact links, provenance, and module badges
    const resultEl = document.getElementById('irisResult');
    if (resultEl) {
      resultEl.addEventListener('click', e => {
        const alink = e.target.closest('.iris-alink');
        if (alink) { irisOpenPopover(alink.dataset.rid); return; }
        const provItem = e.target.closest('.iris-prov-item.clickable');
        if (provItem) { irisOpenPopover(provItem.dataset.rid); }
      });
    }

    irisRenderHistory();
  }

  function setActive(id) {
    const isUtility = id === 'utility';
    const isIris = id === 'iris';
    const isHostPanel = isUtility || isIris;
    const mod = isUtility
      ? { title: 'Utility', desc: 'Host-level tools, verifier, test runner, and cache controls.' }
      : isIris
      ? { title: 'IRIS', desc: 'Interface for Resolution, Insight & Status  read-only query engine.' }
      : (MODULES[id] || MODULES.suite);
    activeId = isHostPanel ? id : (id in MODULES ? id : 'suite');

    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.id === activeId));
    document.getElementById('mTitle').textContent = mod.title;
    document.getElementById('mDesc').textContent = mod.desc;

    const modulePane = document.getElementById('modulePane');
    const utilityPane = document.getElementById('utilityPane');
    const irisPane = document.getElementById('irisPane');
    if (modulePane) modulePane.classList.toggle('hidden', isHostPanel);
    if (utilityPane) utilityPane.classList.toggle('hidden', !isUtility);
    if (irisPane) irisPane.classList.toggle('hidden', !isIris);

    const openBtn = document.getElementById('btnOpenExternal');
    if (openBtn) openBtn.disabled = isHostPanel;

    if (!isHostPanel) {
      const readyFrame = ensureModuleReady(activeId);
      const deckFrames = document.querySelectorAll('#frameDeck iframe');
      deckFrames.forEach(f => f.classList.add('hidden'));
      if (readyFrame) readyFrame.classList.remove('hidden');
      if (activeId === 'suite') setTimeout(refreshSuiteFrame, 80);
      if (activeId === 'suite') setTimeout(removeSuiteAside, 110);
      if (activeId === 'suite') setTimeout(convertSuiteLeftPanelsToSubtabs, 140);
      if (activeId === 'suite') setTimeout(enforceSuitePanelRemovals, 145);
      if (activeId === 'suite') setTimeout(renderSuiteCrossoverPanel, 155);
      if (activeId === 'suite') setTimeout(renderSuiteLinkagePanel, 165);
      if (activeId === 'suite') setTimeout(enhanceSuiteKpiDiagnostics, 175);
      if (activeId === 'suite') setTimeout(enforceSuitePanelRemovals, 380);
      if (activeId === 'suite') setTimeout(enforceSuitePanelRemovals, 900);
      if (activeId === 'suite') setTimeout(installSuitePopovers, 160);
    }

    const bs = document.getElementById('bootStatusTop');
    if (bs) bs.textContent = isUtility
      ? 'Utility tab active: host-level controls enabled.'
      : isIris
      ? 'IRIS active: read-only query resolution engine.'
      : `Lazy-load active: ${activeId} mounted and state preserved across tabs.`;

    if (isUtility || activeId === 'suite') hostRollup();
    syncSuiteRollupToUtility();
    renderUtilityEdgeStatus();
    renderUtilitySchemaStatus();

    renderAbpContextBar(activeId);
    try { location.hash = '#' + activeId; } catch(_) {}
  }

  document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => setActive(t.dataset.id)));
  document.getElementById('btnOpenExternal').addEventListener('click', () => {
    if (activeId === 'utility') return;
    const mod = MODULES[activeId] || MODULES.suite;
    const w = window.open('', '_blank', 'noopener');
    if(!w) return;
    w.document.open();
    w.document.write(mod.html);
    w.document.close();
  });


  function revokeModuleUrls() {
    const deck = document.getElementById('frameDeck');
    if (deck) deck.innerHTML = '';
    Object.keys(moduleFrames).forEach(k => { delete moduleFrames[k]; });
    const bs = document.getElementById('bootStatusTop');
    if (bs) bs.textContent = 'Host cache reset: module frames cleared.';
  }

  async function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

  function hostRollup() {
    invalidateJsonCache();
    const out = { generated_at: new Date().toISOString(), schema: 'deepsigma_unified_host_rollup_v1', modules: {} };
    const by = KEY_REGISTRY;
    Object.keys(by).forEach(mod => {
      const keys = by[mod];
      out.modules[mod] = keys.map(k => {
        const raw = localStorage.getItem(k);
        let parsed = null;
        try { parsed = raw ? JSON.parse(raw) : null; } catch(_) { parsed = null; }
        const count = parsed && typeof parsed === 'object' ? Object.keys(parsed).length : 0;
        return { key: k, present: !!raw, object_keys: count };
      });
    });
    const el = document.getElementById('hostRollup');
    if (el) el.value = JSON.stringify(out, null, 2);
    syncSuiteRollupToUtility();
    renderUtilityEdgeStatus();
    renderUtilitySchemaStatus();
    return out;
  }

  function getSuiteRollup() {
    // Try suite iframe first
    try {
      const frame = moduleFrames.suite;
      const doc = frame?.contentWindow?.document;
      const src = doc?.getElementById('rollupPreview');
      if (src?.value) { const r = JSON.parse(src.value); if (r.totals) return r; }
    } catch(_) {}
    // Try utility textarea
    try {
      const u = document.getElementById('suiteRollupUtility');
      if (u?.value) { const r = JSON.parse(u.value); if (r.totals) return r; }
    } catch(_) {}
    // Build rollup from localStorage directly
    return buildHostRollup();
  }

  function buildHostRollup() {
    const n = x => { const v = Number(x); return Number.isFinite(v) ? v : 0; };
    const pct = (p, a) => a ? Math.round((p / a) * 1000) / 10 : 0;
    const daysOld = iso => { const t = new Date(iso || Date.now()).getTime(); return Number.isFinite(t) ? Math.max(0, Math.floor((Date.now() - t) / 86400000)) : 0; };

    const hiring = readJsonSafe('ds_sequoia_hiring_console_v2_artifacts') || {};
    const bid = readJsonSafe('ds_bidnobid_console_v1') || {};
    const compliance = readJsonSafe('ds_compliance_matrix_v1') || {};
    const boe = readJsonSafe('ds_boe_pricing_v1') || {};

    // Hiring summary
    const hRoles = Array.isArray(hiring.roles) ? hiring.roles.length : 0;
    const hCands = Array.isArray(hiring.candidates) ? hiring.candidates.length : 0;
    const hIvs = Array.isArray(hiring.interviews) ? hiring.interviews.length : 0;
    const hDrift = Array.isArray(hiring.drift) ? hiring.drift.length : 0;
    const hRs = Array.isArray(hiring.rs) ? hiring.rs.length : 0;
    const hOffers = Array.isArray(hiring.candidates) ? hiring.candidates.filter(c => c && (c.offer_date || c.status === 'Offer' || c.status === 'Accepted' || c.status === 'Started')).length : 0;
    const hiringSummary = { episodes: hCands, ds: hDrift, sealed: hOffers, truth: hRoles + hCands, reasoning: hIvs + hRs, memory: hDrift + hRs, governance: hOffers };

    // Bid summary
    const bOpps = Array.isArray(bid.opportunities) ? bid.opportunities : [];
    const bAsm = Array.isArray(bid.assumptions) ? bid.assumptions.length : 0;
    const bRisks = Array.isArray(bid.risks) ? bid.risks.length : 0;
    const bDrift = Array.isArray(bid.drift) ? bid.drift.length : 0;
    const bRs = Array.isArray(bid.rs) ? bid.rs.length : 0;
    const bSealed = bOpps.filter(o => o?.decision?.sealed).length;
    const bidSummary = { episodes: bOpps.length, ds: bDrift, sealed: bSealed, truth: bOpps.length, reasoning: bAsm + bRisks, memory: bDrift + bRs, governance: bSealed };

    // Compliance summary
    const cReqs = Array.isArray(compliance.requirements) ? compliance.requirements : [];
    const cDels = Array.isArray(compliance.deliverables) ? compliance.deliverables.length : 0;
    const cGaps = Array.isArray(compliance.gaps) ? compliance.gaps : [];
    const cRs = Array.isArray(compliance.rs) ? compliance.rs.length : 0;
    const cMapped = cReqs.filter(r => String(r?.compliance_statement || '').trim().length > 0).length;
    const cUnassigned = cReqs.filter(r => !String(r?.owner || '').trim()).length;
    const cOldGaps = cGaps.filter(g => String(g?.status || '') !== 'Resolved' && daysOld(g?.created) > 5).length;
    const cDs = (cUnassigned > 0 ? 1 : 0) + (cOldGaps > 0 ? 1 : 0) + (cReqs.length && (cMapped / cReqs.length * 100) < 90 ? 1 : 0) + (cReqs.filter(r => !String(r?.compliance_statement || '').trim()).length > 0 ? 1 : 0);
    const cSealed = compliance?.intake?.baseline_sealed ? 1 : 0;
    const compSummary = { episodes: cReqs.length, ds: cDs, sealed: cSealed, truth: cReqs.length + cDels, reasoning: cMapped, memory: cGaps.length + cRs, governance: cSealed };

    // BOE summary
    const eLabor = Array.isArray(boe.labor) ? boe.labor : [];
    const eAsm = Array.isArray(boe.assumptions) ? boe.assumptions : [];
    const eMissing = eLabor.filter(l => !(n(l?.hours) > 0) || !(n(l?.rate) > 0)).length;
    const eRateOut = eLabor.filter(l => n(l?.rate) > 250).length;
    const eHoursOut = eLabor.filter(l => n(l?.hours) > 2000).length;
    const eCats = new Set(eAsm.map(a => String(a?.category || '').toLowerCase()));
    const eMissingDrivers = ['rates', 'escalation', 'productivity'].filter(c => !eCats.has(c)).length;
    const eDs = (eMissing > 0 ? 1 : 0) + (eRateOut > 0 ? 1 : 0) + (eHoursOut > 0 ? 1 : 0) + (eMissingDrivers > 0 ? 1 : 0);
    const eSealed = boe?.approval?.sealed ? 1 : 0;
    const boeSummary = { episodes: eLabor.length, ds: eDs, sealed: eSealed, truth: eLabor.length, reasoning: eAsm.length, memory: eAsm.length, governance: eSealed };

    const byModule = [
      { id: 'hiring', name: 'Hiring Console', ...hiringSummary },
      { id: 'bid', name: 'Bid/No-Bid Console', ...bidSummary },
      { id: 'compliance', name: 'Compliance Matrix Console', ...compSummary },
      { id: 'boe', name: 'BOE / Pricing Console', ...boeSummary }
    ];
    const totals = byModule.reduce((a, m) => {
      a.episodes += m.episodes; a.ds += m.ds; a.sealed += m.sealed;
      a.truth += m.truth; a.reasoning += m.reasoning; a.memory += m.memory; a.governance += m.governance;
      return a;
    }, { episodes: 0, ds: 0, sealed: 0, truth: 0, reasoning: 0, memory: 0, governance: 0 });
    const modulesWithData = byModule.filter(m => m.episodes > 0 || m.ds > 0 || m.sealed > 0).length;
    const govHealth = totals.ds === 0 ? 'GREEN' : totals.ds <= 3 ? 'YELLOW' : totals.ds <= 6 ? 'ORANGE' : 'RED';

    // Control gates
    const keyAsmCats = new Set(eAsm.map(a => String(a?.category || '').toLowerCase()));
    const bidOutbox = readJsonSafe('ds_bidnobid_edge_outbox_v1') || [];
    const hiringOutbox = readJsonSafe('ds_sequoia_edge_outbox_v1') || [];
    const outboxLen = (Array.isArray(bidOutbox) ? bidOutbox.length : 0) + (Array.isArray(hiringOutbox) ? hiringOutbox.length : 0);
    const gates = [
      { id: 'GATE-001', name: 'Unsealed episodes', status: totals.sealed >= 1 ? 'PASS' : 'FAIL', value: 'sealed=' + totals.sealed },
      { id: 'GATE-002', name: 'Missing key assumptions', status: ['rates', 'escalation', 'productivity'].every(x => keyAsmCats.has(x)) ? 'PASS' : 'FAIL', value: 'present=' + (Array.from(keyAsmCats).join(',') || 'none') },
      { id: 'GATE-003', name: 'Edge outbox backlog <= 5', status: outboxLen <= 5 ? 'PASS' : 'FAIL', value: 'outbox=' + outboxLen },
      { id: 'GATE-004', name: 'No high DS pressure', status: totals.ds <= 6 ? 'PASS' : 'FAIL', value: 'ds=' + totals.ds },
      { id: 'GATE-005', name: 'Compliance coverage >= 90%', status: cReqs.length ? (pct(cMapped, cReqs.length) >= 90 ? 'PASS' : 'FAIL') : 'WARN', value: 'reqs=' + cReqs.length },
      { id: 'GATE-006', name: 'Bid decisions sealed', status: bSealed >= 1 || bOpps.length === 0 ? 'PASS' : 'FAIL', value: 'sealed=' + bSealed }
    ];

    // Module scores
    const schemaOk = mod => { const db = readJsonSafe(mod.key); return db ? 1 : 0; };
    const modMeta = [
      { id: 'hiring', key: 'ds_sequoia_hiring_console_v2_artifacts' },
      { id: 'bid', key: 'ds_bidnobid_console_v1' },
      { id: 'compliance', key: 'ds_compliance_matrix_v1' },
      { id: 'boe', key: 'ds_boe_pricing_v1' }
    ];
    const moduleScores = byModule.map(m => {
      const meta = modMeta.find(x => x.id === m.id);
      const schema = meta && readJsonSafe(meta.key) ? 1 : 0;
      const data = m.episodes > 0 ? 1 : 0;
      const driftF = Math.max(0, 1 - Math.min(m.ds, 10) / 10);
      const sealF = m.episodes ? Math.min(1, m.sealed / m.episodes) : 0.5;
      const memF = Math.min(1, m.memory / 10);
      const score = Math.round((0.20 * schema + 0.20 * data + 0.30 * driftF + 0.20 * sealF + 0.10 * memF) * 100);
      return { module: m.id, score };
    });
    const composite = moduleScores.length ? Math.round(moduleScores.reduce((a, b) => a + b.score, 0) / moduleScores.length) : 0;

    return {
      schema: 'deepsigma_suite_rollup_v1',
      generated_at: new Date().toISOString(),
      modules: byModule,
      totals,
      modules_with_data: modulesWithData,
      governance_health: govHealth,
      control_gates: gates,
      module_scores: moduleScores,
      composite_score: composite
    };
  }

  function exportRollupHost() {
    const obj = getSuiteRollup();
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'deepsigma_suite_rollup_' + new Date().toISOString().slice(0, 10) + '.json';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function printExecHost() {
    const obj = getSuiteRollup();
    const e = escapeHtml;
    const t = obj.totals || {};
    const gates = obj.control_gates || [];
    const scores = obj.module_scores || [];
    const mods = obj.modules || [];
    const composite = obj.composite_score ?? (scores.length ? Math.round(scores.reduce((a, b) => a + (b.score || 0), 0) / scores.length) : 0);
    const gov = obj.governance_health || 'N/A';
    const govColor = gov === 'GREEN' ? '#15803d' : gov === 'YELLOW' ? '#a16207' : gov === 'ORANGE' ? '#d97706' : gov === 'RED' ? '#b91c1c' : '#555';
    const passFail = gates.filter(g => g.status === 'PASS').length;
    const failGates = gates.filter(g => g.status === 'FAIL');

    const w = window.open('', '_blank');
    if (!w) return;
    w.document.open();
    w.document.write(`<!doctype html><html><head><meta charset="utf-8"/><title>Deep Sigma - SEQUOIA Executive Snapshot</title>
<style>
  body{font-family:system-ui,-apple-system,sans-serif;padding:28px 36px;color:#1a1a2e;max-width:900px;margin:0 auto;line-height:1.55}
  h1{margin:0 0 4px;font-size:22px;color:#0f1720}
  .subtitle{color:#64748b;font-size:13px;margin-bottom:20px}
  h2{margin:28px 0 6px;font-size:16px;color:#1e293b;border-bottom:2px solid #e2e8f0;padding-bottom:4px}
  h3{margin:16px 0 4px;font-size:14px;color:#334155}
  p{margin:4px 0 10px;font-size:12.5px;color:#475569}
  .desc{font-size:12px;color:#64748b;margin:2px 0 12px;font-style:italic}
  table{width:100%;border-collapse:collapse;margin-bottom:14px}
  th,td{border:1px solid #cbd5e1;padding:7px 10px;font-size:12px}
  th{text-align:left;background:#f1f5f9;color:#334155;font-weight:600}
  .pass{color:#15803d;font-weight:700} .fail{color:#b91c1c;font-weight:700} .warn{color:#a16207;font-weight:700}
  .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:12px 0 18px}
  .kpi-card{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;text-align:center}
  .kpi-val{font-size:22px;font-weight:700;color:#0f172a}
  .kpi-label{font-size:11px;color:#64748b;margin-top:2px}
  .gov-badge{display:inline-block;padding:6px 18px;border-radius:6px;font-size:16px;font-weight:700;color:#fff;margin:4px 0 8px}
  .score-bar{height:10px;background:#e2e8f0;border-radius:5px;overflow:hidden;margin:2px 0}
  .score-fill{height:100%;border-radius:5px}
  .callout{background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:10px 14px;margin:10px 0;font-size:12px;color:#92400e}
  .callout-red{background:#fef2f2;border-color:#fecaca;color:#991b1b}
  .gate-detail{font-size:11px;color:#64748b;padding:2px 10px 6px}
  .footer{margin-top:30px;padding-top:12px;border-top:1px solid #e2e8f0;font-size:11px;color:#94a3b8;text-align:center}
  @media print{body{padding:12px} .kpi-grid{grid-template-columns:repeat(4,1fr)}}
</style></head><body>

<h1>Deep Sigma - SEQUOIA Executive Snapshot</h1>
<div class="subtitle">Generated ${e(obj.generated_at || new Date().toISOString())} | Schema: deepsigma_suite_rollup_v1 | ${e(String(obj.modules_with_data ?? mods.length))}/4 modules reporting data</div>

<h2>Institutional Decision Posture</h2>
<p>This section summarizes the overall health of the decision infrastructure. Governance health is derived from drift signal pressure across all modules. GREEN = drift controlled. YELLOW = emerging pressure. ORANGE = approaching instability. RED = systemic degradation.</p>

<div class="gov-badge" style="background:${govColor}">${e(gov)}</div>
<p><b>What this means:</b> ${gov === 'GREEN' ? 'All modules are operating within acceptable drift thresholds. Decision provenance is intact and auditable.' : gov === 'YELLOW' ? 'Drift signals are accumulating. Some decisions may be based on stale or incomplete data. Review DS sources and resolve before milestone.' : gov === 'ORANGE' ? 'Drift signals are approaching instability thresholds. Multiple modules show governance pressure. Triage drift sources before they compound.' : 'Multiple drift signals indicate systemic data quality issues. Decisions made in this state carry elevated risk. Immediate triage recommended.'}</p>

<h2>Key Performance Indicators</h2>
<p>These KPIs measure the depth and maturity of institutional decision memory across all four SEQUOIA modules. Higher numbers indicate richer evidence trails. Zero values indicate modules that have not been populated with operational data.</p>

<div class="kpi-grid">
  <div class="kpi-card"><div class="kpi-val">${t.episodes || 0}</div><div class="kpi-label">Episodes</div></div>
  <div class="kpi-card"><div class="kpi-val">${t.ds || 0}</div><div class="kpi-label">Drift Signals</div></div>
  <div class="kpi-card"><div class="kpi-val">${t.sealed || 0}</div><div class="kpi-label">Sealed Decisions</div></div>
  <div class="kpi-card"><div class="kpi-val">${t.truth || 0}</div><div class="kpi-label">Truth Artifacts</div></div>
</div>

<table>
  <thead><tr><th>Metric</th><th>Value</th><th>What It Measures</th></tr></thead>
  <tbody>
    <tr><td>Episodes</td><td>${t.episodes || 0}</td><td>Total operational records (candidates, opportunities, requirements, labor lines) across all modules</td></tr>
    <tr><td>Drift Signals</td><td>${t.ds || 0}</td><td>Data quality warnings: missing fields, stale gaps, unassigned requirements, rate outliers</td></tr>
    <tr><td>Sealed Decisions</td><td>${t.sealed || 0}</td><td>Formally committed decisions with authority signatures that cannot be silently reversed</td></tr>
    <tr><td>Truth Artifacts</td><td>${t.truth || 0}</td><td>Primary evidence records that form the factual foundation for all downstream reasoning</td></tr>
    <tr><td>Reasoning Artifacts</td><td>${t.reasoning || 0}</td><td>Analytical outputs: compliance mappings, risk assessments, interview evaluations, assumptions</td></tr>
    <tr><td>Memory Artifacts</td><td>${t.memory || 0}</td><td>Historical records that enable pattern recognition and prevent repeated mistakes</td></tr>
    <tr><td>Governance Artifacts</td><td>${t.governance || 0}</td><td>Authority-stamped seals, approvals, and baselines that enforce accountability</td></tr>
  </tbody>
</table>

<h2>Control Gates</h2>
<p>Control gates are binary pass/fail checkpoints that must all be satisfied before the system is considered decision-ready. Each gate tests a specific prerequisite. A single FAIL gate is sufficient reason to pause downstream processes until resolved.</p>

${failGates.length > 0 ? '<div class="callout callout-red"><b>' + failGates.length + ' gate(s) failing.</b> The following gates require action: ' + failGates.map(g => e(g.id)).join(', ') + '. See details below for remediation guidance.</div>' : '<div class="callout"><b>All ' + gates.length + ' gates passing.</b> The system is in a decision-ready posture. Continue monitoring for drift.</div>'}

<table>
  <thead><tr><th>Gate</th><th>Status</th><th>Current Value</th></tr></thead>
  <tbody>${gates.map(g => {
      const cls = g.status === 'PASS' ? 'pass' : g.status === 'WARN' ? 'warn' : 'fail';
      const info = GATE_META[g.id] || {};
      return '<tr><td><b>' + e(g.id) + '</b> ' + e(g.name) + '</td><td class="' + cls + '">' + e(g.status) + '</td><td>' + e(g.value) + '</td></tr>' +
        '<tr><td colspan="3" class="gate-detail"><b>What:</b> ' + e(info.what || '') + '<br><b>Why it matters:</b> ' + e(info.why || '') + '<br><b>So what:</b> ' + e(info.so || '') + '</td></tr>';
    }).join('')}</tbody>
</table>

<h2>Module Health Scores</h2>
<p>Each module is scored 0-100 based on five weighted factors: schema validity (20%), data presence (20%), drift control (30%), seal ratio (20%), and memory depth (10%). The composite score is the unweighted average across all modules. Scores below 50 indicate modules that need immediate attention.</p>

<table>
  <thead><tr><th>Module</th><th>Score</th><th>Bar</th><th>Assessment</th></tr></thead>
  <tbody>${scores.map(s => {
      const color = s.score >= 80 ? '#15803d' : s.score >= 60 ? '#a16207' : s.score >= 40 ? '#d97706' : '#b91c1c';
      const assessment = s.score >= 80 ? 'Healthy. Data is present, drift is controlled, and decisions are sealed.' : s.score >= 60 ? 'Moderate. Some gaps in data completeness or unsealed decisions.' : s.score >= 40 ? 'Degraded. Multiple gaps in drift control or governance seals. Review recommended.' : 'At risk. Missing data, high drift, or no sealed decisions. Requires immediate action.';
      return '<tr><td>' + e(s.module) + '</td><td style="font-weight:700;color:' + color + '">' + s.score + '</td><td><div class="score-bar"><div class="score-fill" style="width:' + s.score + '%;background:' + color + '"></div></div></td><td style="font-size:11px">' + assessment + '</td></tr>';
    }).join('')}
    <tr style="background:#f1f5f9"><td><b>Composite</b></td><td><b>${composite}</b></td><td><div class="score-bar"><div class="score-fill" style="width:${composite}%;background:${composite >= 80 ? '#15803d' : composite >= 60 ? '#a16207' : composite >= 40 ? '#d97706' : '#b91c1c'}"></div></div></td><td style="font-size:11px"><b>${composite >= 80 ? 'System is operating effectively.' : composite >= 60 ? 'System needs attention in underperforming modules.' : composite >= 40 ? 'System is degraded. Multiple modules need review.' : 'System health is critical. Prioritize data population and drift resolution.'}</b></td></tr>
  </tbody>
</table>

<h2>Module Detail</h2>
<p>Each module contributes to the four Deep Sigma lenses: Truth (factual evidence), Reasoning (analytical outputs), Memory (historical patterns), and Governance (authority and accountability). Understanding per-module contributions reveals where institutional knowledge is strong and where it is thin.</p>

${mods.map(m => {
      const desc = MODULE_META[m.id] || {};
      const sc = scores.find(s => s.module === m.id);
      const scVal = sc ? sc.score : 0;
      return '<h3>' + e(m.name || m.id) + ' <span style="font-size:12px;color:#64748b">(score: ' + scVal + ')</span></h3>' +
        '<p><b>What:</b> ' + e(desc.what || '') + '</p>' +
        '<p><b>Why it matters:</b> ' + e(desc.why || '') + '</p>' +
        '<p style="font-size:11.5px;color:#475569"><b>Lens breakdown:</b> ' + e(desc.lens || '') + '</p>' +
        '<table><thead><tr><th>Episodes</th><th>DS</th><th>Sealed</th><th>Truth</th><th>Reasoning</th><th>Memory</th><th>Governance</th></tr></thead>' +
        '<tbody><tr><td>' + (m.episodes || 0) + '</td><td>' + (m.ds || 0) + '</td><td>' + (m.sealed || 0) + '</td><td>' + (m.truth || 0) + '</td><td>' + (m.reasoning || 0) + '</td><td>' + (m.memory || 0) + '</td><td>' + (m.governance || 0) + '</td></tr></tbody></table>';
    }).join('')}

<h2>Deep Sigma Lens Summary</h2>
<p>The four lenses provide a cross-cutting view of institutional decision maturity. They answer: Do we know the facts (Truth)? Can we explain our reasoning (Reasoning)? Do we remember what happened before (Memory)? Is someone accountable (Governance)?</p>

<table>
  <thead><tr><th>Lens</th><th>Total</th><th>What It Represents</th><th>Risk If Low</th></tr></thead>
  <tbody>
    <tr><td><b>Truth</b></td><td>${t.truth || 0}</td><td>Factual evidence: roles, candidates, requirements, labor lines, opportunities</td><td>Decisions are based on assumptions rather than evidence</td></tr>
    <tr><td><b>Reasoning</b></td><td>${t.reasoning || 0}</td><td>Analytical outputs: compliance mappings, assumptions, risk assessments, interview traces</td><td>Decision rationale is implicit and non-reproducible</td></tr>
    <tr><td><b>Memory</b></td><td>${t.memory || 0}</td><td>Historical records: drift signals, rationale sheets, gap history</td><td>Organization repeats mistakes and cannot learn from patterns</td></tr>
    <tr><td><b>Governance</b></td><td>${t.governance || 0}</td><td>Accountability markers: sealed decisions, approved baselines, authority stamps</td><td>No one is formally accountable for decisions taken</td></tr>
  </tbody>
</table>

<div class="footer">
  Deep Sigma - SEQUOIA Unified All-5 | Institutional Decision Infrastructure<br>
  This snapshot is a point-in-time view. Re-run after data changes to get an updated posture.
</div>

</body></html>`);
    w.document.close();
    w.focus();
    w.print();
  }

  async function verifyPackHashHost() {
    const mf = document.getElementById('hostManifestFile')?.files?.[0];
    const hf = document.getElementById('hostHashesFile')?.files?.[0];
    const out = document.getElementById('hostVerifyStatus');
    if(!mf || !hf){ if(out) out.textContent = 'Select manifest + hashes JSON files.'; return; }
    try {
      const manifest = JSON.parse(await mf.text());
      const hashesDoc = JSON.parse(await hf.text());
      const hashes = hashesDoc?.hashes || {};
      const pairs = Object.entries(hashes).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>`${k} ${v}`).join('\n');
      const data = new TextEncoder().encode(pairs);
      const digest = await crypto.subtle.digest('SHA-256', data);
      const computed = Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join('');
      const ok = computed && manifest?.pack_hash === computed && hashesDoc?.pack_hash === computed;
      if(out) out.textContent = ok ? `PASS pack_hash ${computed}` : `FAIL computed=${computed} manifest=${manifest?.pack_hash || 'n/a'} hashes=${hashesDoc?.pack_hash || 'n/a'}`;
    } catch(err) {
      if(out) out.textContent = `Verifier error: ${err.message || err}`;
    }
  }

  async function runSuiteTestMode() {
    const order = ['hiring','bid','compliance','boe'];
    const bs = document.getElementById('bootStatusTop');
    for (const id of order) {
      setActive(id);
      await wait(450);
      const f = getActiveFrame();
      const doc = f?.contentWindow?.document;
      if(!doc) continue;
      const btn = doc.getElementById('tmRunAll');
      if(btn) {
        btn.click();
        await wait(350);
      }
      if (bs) bs.textContent = `Suite Test Mode: executed ${id}`;
    }
    setActive('suite');
    hostRollup();
    if (bs) bs.textContent = 'Suite Test Mode complete. Rollup generated.';
  }
  /*  ABP: Canonical JSON + Verification  */

  function abpCanonical(obj) {
    if (obj === null || obj === undefined) return JSON.stringify(obj);
    if (Array.isArray(obj)) return '[' + obj.map(abpCanonical).join(',') + ']';
    if (typeof obj === 'object') {
      const keys = Object.keys(obj).sort();
      return '{' + keys.map(k => JSON.stringify(k) + ':' + abpCanonical(obj[k])).join(',') + '}';
    }
    if (typeof obj === 'number' && Number.isFinite(obj) && obj === Math.floor(obj)) {
      return String(Math.trunc(obj));
    }
    return JSON.stringify(obj);
  }

  async function abpSha256(str) {
    const data = new TextEncoder().encode(str);
    const digest = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, '0')).join('');
  }

  async function abpComputeHash(abp) {
    const copy = Object.assign({}, abp);
    copy.hash = '';
    return 'sha256:' + await abpSha256(abpCanonical(copy));
  }

  async function abpComputeId(abp) {
    const seed = abpCanonical({
      scope: abp.scope,
      authority_ref: abp.authority_ref,
      created_at: abp.created_at
    });
    const hex = await abpSha256(seed);
    return 'ABP-' + hex.slice(0, 8);
  }

  function abpCheckContradictions(abp) {
    const issues = [];
    const objAllowed = new Set((abp.objectives?.allowed || []).map(o => o.id));
    const objDenied = new Set((abp.objectives?.denied || []).map(o => o.id));
    const objOverlap = [...objAllowed].filter(x => objDenied.has(x));
    if (objOverlap.length) issues.push('objectives: ' + objOverlap.join(', '));
    const toolAllow = new Set((abp.tools?.allow || []).map(t => t.name));
    const toolDeny = new Set((abp.tools?.deny || []).map(t => t.name));
    const toolOverlap = [...toolAllow].filter(x => toolDeny.has(x));
    if (toolOverlap.length) issues.push('tools: ' + toolOverlap.join(', '));
    return issues;
  }

  function abpCheckSchema(abp) {
    const required = ['abp_version','abp_id','scope','authority_ref','objectives','tools','data','approvals','escalation','runtime','proof','composition','created_at','hash'];
    const missing = required.filter(k => !(k in abp));
    return missing;
  }

  async function abpVerify(abp) {
    const checks = [];
    // 1. schema_present
    const missing = abpCheckSchema(abp);
    checks.push({ name: 'schema_present', pass: missing.length === 0, detail: missing.length ? 'missing: ' + missing.join(', ') : 'all required fields present' });
    // 2. hash_integrity
    const computed = await abpComputeHash(abp);
    const hashOk = computed === abp.hash;
    checks.push({ name: 'hash_integrity', pass: hashOk, detail: hashOk ? computed : 'expected ' + (abp.hash || 'n/a') + ', got ' + computed });
    // 3. id_deterministic
    const computedId = await abpComputeId(abp);
    const idOk = computedId === abp.abp_id;
    checks.push({ name: 'id_deterministic', pass: idOk, detail: idOk ? computedId : 'expected ' + (abp.abp_id || 'n/a') + ', got ' + computedId });
    // 4. no_contradictions
    const contradictions = abpCheckContradictions(abp);
    checks.push({ name: 'no_contradictions', pass: contradictions.length === 0, detail: contradictions.length ? contradictions.join('; ') : 'no overlaps' });
    return checks;
  }

  function renderAbpVerifyResults(checks) {
    const el = document.getElementById('abpVerifyResults');
    if (!el) return;
    const allPass = checks.every(c => c.pass);
    el.innerHTML = '<div class="abp-verify-results">' +
      '<div class="abp-check" style="margin-bottom:6px"><span class="abp-pill ' + (allPass ? 'pass' : 'fail') + '">' + (allPass ? 'ALL PASS' : 'FAILED') + '</span></div>' +
      checks.map(c =>
        '<div class="abp-check">' +
        '<span class="abp-pill ' + (c.pass ? 'pass' : 'fail') + '">' + (c.pass ? 'PASS' : 'FAIL') + '</span>' +
        '<span class="abp-check-name">' + escapeHtml(c.name) + '</span>' +
        '<span class="abp-check-detail">' + escapeHtml(c.detail) + '</span>' +
        '</div>'
      ).join('') +
      '</div>';
  }

  function renderAbpSection(title, bodyHtml, startOpen) {
    const id = 'abp-sec-' + title.replace(/\s+/g, '-').toLowerCase();
    return '<div class="abp-section" onclick="(function(e){var b=document.getElementById(\'' + id + '\');var t=e.currentTarget.querySelector(\'.abp-toggle\');if(b){b.classList.toggle(\'collapsed\');t&&t.classList.toggle(\'open\')}})(event)">' +
      '<span class="abp-toggle' + (startOpen ? ' open' : '') + '">&#9654;</span><h4>' + escapeHtml(title) + '</h4></div>' +
      '<div id="' + id + '" class="abp-section-body' + (startOpen ? '' : ' collapsed') + '">' + bodyHtml + '</div>';
  }

  function renderAbpList(items, cls, fields) {
    if (!items || !items.length) return '<p class="abp-empty">None</p>';
    return '<ul class="abp-list">' + items.map(item => {
      let html = '<li class="' + cls + '">';
      if (item.id || item.name) html += '<span class="abp-item-id">' + escapeHtml(item.id || item.name) + '</span>';
      if (item.description) html += escapeHtml(item.description);
      if (item.scope !== undefined && item.scope !== null) html += ' <span class="abp-item-reason">scope: ' + escapeHtml(item.scope) + '</span>';
      if (item.reason) html += '<span class="abp-item-reason">' + escapeHtml(item.reason) + '</span>';
      return html + '</li>';
    }).join('') + '</ul>';
  }

  function renderAbpViewer(abp) {
    const el = document.getElementById('abpViewer');
    if (!el) return;
    if (!abp) { el.innerHTML = ''; return; }

    let html = '';

    // Header
    html += '<div class="abp-header">' +
      '<span class="abp-id">' + escapeHtml(abp.abp_id || 'unknown') + '</span>' +
      '<span class="abp-version">v' + escapeHtml(abp.abp_version || '?') + '</span>' +
      '<span class="abp-ts">created ' + escapeHtml(abp.created_at || 'n/a') + '</span>' +
      (abp.effective_at ? '<span class="abp-ts">effective ' + escapeHtml(abp.effective_at) + '</span>' : '') +
      (abp.expires_at ? '<span class="abp-ts">expires ' + escapeHtml(abp.expires_at) + '</span>' : '') +
      '</div>';

    // Scope
    const scope = abp.scope || {};
    html += renderAbpSection('Scope',
      '<p>Contract: <strong>' + escapeHtml(scope.contract_id || 'n/a') + '</strong> &nbsp; Program: <strong>' + escapeHtml(scope.program || 'n/a') + '</strong></p>' +
      '<p>Modules: ' + (scope.modules || []).map(m => '<span class="abp-proof-badge">' + escapeHtml(m) + '</span>').join(' ') + '</p>',
      true);

    // Authority Ref
    const auth = abp.authority_ref || {};
    html += renderAbpSection('Authority Reference',
      '<p>Entry ID: <code>' + escapeHtml(auth.authority_entry_id || 'n/a') + '</code></p>' +
      '<p>Entry Hash: <code style="font-size:10px;word-break:break-all">' + escapeHtml(auth.authority_entry_hash || 'n/a') + '</code></p>' +
      (auth.authority_ledger_path ? '<p>Ledger: <code>' + escapeHtml(auth.authority_ledger_path) + '</code></p>' : ''),
      true);

    // Objectives
    const obj = abp.objectives || {};
    html += renderAbpSection('Objectives',
      '<strong style="color:#5dff93;font-size:11px">ALLOWED</strong>' + renderAbpList(obj.allowed, 'allow') +
      '<strong style="color:#ff6b6b;font-size:11px">DENIED</strong>' + renderAbpList(obj.denied, 'deny'),
      true);

    // Tools
    const tools = abp.tools || {};
    html += renderAbpSection('Tools',
      '<strong style="color:#5dff93;font-size:11px">ALLOW</strong>' + renderAbpList(tools.allow, 'allow') +
      '<strong style="color:#ff6b6b;font-size:11px">DENY</strong>' + renderAbpList(tools.deny, 'deny'),
      false);

    // Data Permissions
    const perms = abp.data?.permissions || [];
    if (perms.length) {
      html += renderAbpSection('Data Permissions',
        '<table class="abp-data-table"><thead><tr><th>Resource</th><th>Operations</th><th>Roles</th><th>Sensitivity</th></tr></thead><tbody>' +
        perms.map(p =>
          '<tr><td><code>' + escapeHtml(p.resource) + '</code></td>' +
          '<td>' + (p.operations || []).join(', ') + '</td>' +
          '<td>' + (p.roles || []).join(', ') + '</td>' +
          '<td><span class="sensitivity ' + (p.sensitivity || '') + '">' + escapeHtml(p.sensitivity || 'n/a') + '</span></td></tr>'
        ).join('') +
        '</tbody></table>',
        false);
    }

    // Approvals
    const approvals = abp.approvals?.required || [];
    if (approvals.length) {
      html += renderAbpSection('Approvals',
        '<table class="abp-data-table"><thead><tr><th>Action</th><th>Approver</th><th>Threshold</th><th>Timeout</th></tr></thead><tbody>' +
        approvals.map(a =>
          '<tr><td>' + escapeHtml(a.action) + '</td><td>' + escapeHtml(a.approver_role) + '</td><td>' + (a.threshold || 1) + '</td><td>' + (a.timeout_ms ? (a.timeout_ms / 1000) + 's' : 'none') + '</td></tr>'
        ).join('') +
        '</tbody></table>',
        false);
    }

    // Escalation
    const paths = abp.escalation?.paths || [];
    if (paths.length) {
      html += renderAbpSection('Escalation',
        '<table class="abp-data-table"><thead><tr><th>Trigger</th><th>Destination</th><th>Severity</th><th>Auto</th></tr></thead><tbody>' +
        paths.map(p =>
          '<tr><td>' + escapeHtml(p.trigger) + '</td><td>' + escapeHtml(p.destination) + '</td><td><span class="sensitivity ' + (p.severity === 'critical' ? 'restricted' : p.severity === 'warn' ? 'confidential' : 'internal') + '">' + escapeHtml(p.severity) + '</span></td><td>' + (p.auto ? 'yes' : 'no') + '</td></tr>'
        ).join('') +
        '</tbody></table>',
        false);
    }

    // Runtime Validators
    const validators = abp.runtime?.validators || [];
    if (validators.length) {
      html += renderAbpSection('Runtime Validators',
        '<table class="abp-data-table"><thead><tr><th>Name</th><th>When</th><th>Fail Action</th></tr></thead><tbody>' +
        validators.map(v =>
          '<tr><td><code>' + escapeHtml(v.name) + '</code></td><td>' + escapeHtml(v.when) + '</td><td><span class="sensitivity ' + (v.fail_action === 'block' ? 'restricted' : v.fail_action === 'escalate' ? 'confidential' : 'internal') + '">' + escapeHtml(v.fail_action) + '</span></td></tr>'
        ).join('') +
        '</tbody></table>',
        false);
    }

    // Proof Required
    const proof = abp.proof?.required || [];
    if (proof.length) {
      html += renderAbpSection('Proof Required',
        '<div class="abp-proof-list">' + proof.map(p => '<span class="abp-proof-badge">' + escapeHtml(p) + '</span>').join('') + '</div>',
        false);
    }

    // Composition
    const comp = abp.composition || {};
    let compHtml = '';
    if (comp.parent_abp_id) {
      compHtml += '<p>Parent: <span class="abp-comp-ref">' + escapeHtml(comp.parent_abp_id) + ' hash=' + escapeHtml(comp.parent_abp_hash || 'n/a') + '</span></p>';
    }
    if (comp.children && comp.children.length) {
      compHtml += '<p>Children:</p>' + comp.children.map(c =>
        '<span class="abp-comp-ref">' + escapeHtml(c.abp_id) + ' hash=' + escapeHtml(c.abp_hash || 'n/a') + '</span>'
      ).join('');
    }
    if (!compHtml) compHtml = '<p class="abp-empty">No composition (standalone ABP)</p>';
    html += renderAbpSection('Composition', compHtml, false);

    // Hash
    html += '<div class="abp-hash">hash: ' + escapeHtml(abp.hash || 'n/a') + '</div>';

    el.innerHTML = html;
  }

  async function loadAbpFromFile() {
    const fileInput = document.getElementById('abpFileInput');
    const file = fileInput?.files?.[0];
    if (!file) return;
    try {
      const text = await file.text();
      const abp = JSON.parse(text);
      writeJsonSafe('ds_abp_v1', abp);
      invalidateJsonCache();
      renderAbpViewer(abp);
      renderAbpContextBar(activeId);
      const checks = await abpVerify(abp);
      renderAbpVerifyResults(checks);
    } catch (err) {
      const el = document.getElementById('abpVerifyResults');
      if (el) el.innerHTML = '<div class="abp-check"><span class="abp-pill fail">ERROR</span><span class="abp-check-detail">' + escapeHtml(err.message || String(err)) + '</span></div>';
    }
  }

  async function verifyAbpFromStorage() {
    invalidateJsonCache();
    const abp = readJsonSafe('ds_abp_v1');
    if (!abp) {
      const el = document.getElementById('abpVerifyResults');
      if (el) el.innerHTML = '<p class="abp-empty">No ABP loaded. Use file input to load an abp_v1.json.</p>';
      return;
    }
    renderAbpViewer(abp);
    const checks = await abpVerify(abp);
    renderAbpVerifyResults(checks);
  }

  function clearAbp() {
    try { localStorage.removeItem('ds_abp_v1'); } catch (_) {}
    invalidateJsonCache();
    const viewer = document.getElementById('abpViewer');
    const results = document.getElementById('abpVerifyResults');
    if (viewer) viewer.innerHTML = '';
    if (results) results.innerHTML = '';
    const fileInput = document.getElementById('abpFileInput');
    if (fileInput) fileInput.value = '';
    renderAbpContextBar(activeId);
  }

  function renderAbpOnLoad() {
    const abp = readJsonSafe('ds_abp_v1');
    if (abp) {
      renderAbpViewer(abp);
      renderAbpContextBar(activeId);
    }
  }

  /*  ABP Context Bar (per-tab enforcement surface)  */

  const ABP_TAB_MAP = {
    suite: {
      label: 'Suite Control',
      module: null,
      getContext(abp) {
        const tools = abp.tools || {};
        const allow = (tools.allow || []).map(t => t.name);
        const deny = (tools.deny || []).map(t => t.name);
        const validators = (abp.runtime?.validators || []);
        const proof = abp.proof?.required || [];
        const cols = [];
        if (allow.length) cols.push({ title: 'Allowed Tools', items: allow.map(n => ({ dot: 'green', text: n })) });
        if (deny.length) cols.push({ title: 'Denied Tools', items: deny.map(n => ({ dot: 'red', text: n })) });
        if (validators.length) cols.push({ title: 'Validators', items: validators.map(v => ({ dot: v.fail_action === 'block' ? 'red' : 'yellow', text: v.name + ' (' + v.when + '  ' + v.fail_action + ')' })) });
        if (proof.length) cols.push({ title: 'Proof Required', items: proof.map(p => ({ dot: 'cyan', text: p })) });
        return cols;
      }
    },
    hiring: {
      label: 'Hiring Console',
      module: 'hiring',
      getContext(abp) {
        const cols = [];
        const perms = (abp.data?.permissions || []).filter(p => p.resource.includes('hiring') || p.roles?.includes('Operator'));
        const objs = (abp.objectives?.allowed || []);
        const staffObj = objs.filter(o => (o.description || '').toLowerCase().includes('staff'));
        if (staffObj.length) cols.push({ title: 'Relevant Objectives', items: staffObj.map(o => ({ dot: 'green', text: o.id + ': ' + o.description })) });
        if (perms.length) cols.push({ title: 'Data Permissions', items: perms.map(p => ({ dot: p.sensitivity === 'confidential' ? 'yellow' : 'green', text: p.resource + ' [' + p.operations.join(',') + '] ' + p.sensitivity })) });
        const approvals = (abp.approvals?.required || []);
        if (approvals.length) cols.push({ title: 'Approvals', items: approvals.map(a => ({ dot: 'yellow', text: a.action + '  ' + a.approver_role + ' (threshold ' + a.threshold + ')' })) });
        return cols;
      }
    },
    bid: {
      label: 'Bid/No-Bid',
      module: 'bid',
      getContext(abp) {
        const cols = [];
        const allowed = (abp.objectives?.allowed || []);
        const denied = (abp.objectives?.denied || []);
        const bidObjs = allowed.filter(o => (o.description || '').toLowerCase().includes('bid'));
        if (bidObjs.length || allowed.length) cols.push({ title: 'Allowed Objectives', items: (bidObjs.length ? bidObjs : allowed).map(o => ({ dot: 'green', text: o.id + ': ' + o.description })) });
        if (denied.length) cols.push({ title: 'Denied Objectives', items: denied.map(o => ({ dot: 'red', text: o.id + ': ' + o.description })) });
        const sealApproval = (abp.approvals?.required || []).filter(a => a.action.includes('seal'));
        if (sealApproval.length) cols.push({ title: 'Seal Approval', items: sealApproval.map(a => ({ dot: 'yellow', text: a.action + '  ' + a.approver_role + ' (threshold ' + a.threshold + ')' })) });
        return cols;
      }
    },
    compliance: {
      label: 'Compliance Matrix',
      module: 'compliance',
      getContext(abp) {
        const cols = [];
        const perms = abp.data?.permissions || [];
        if (perms.length) cols.push({ title: 'Data Permissions', items: perms.map(p => ({ dot: p.sensitivity === 'restricted' ? 'red' : p.sensitivity === 'confidential' ? 'yellow' : 'green', text: p.resource + ' [' + p.operations.join(',') + '] ' + p.sensitivity })) });
        const denied = (abp.objectives?.denied || []);
        if (denied.length) cols.push({ title: 'Denied Objectives', items: denied.map(o => ({ dot: 'red', text: o.id + ': ' + o.reason })) });
        const esc = (abp.escalation?.paths || []);
        if (esc.length) cols.push({ title: 'Escalation', items: esc.map(e => ({ dot: e.severity === 'critical' ? 'red' : 'yellow', text: e.trigger + '  ' + e.destination + ' (' + e.severity + ')' })) });
        return cols;
      }
    },
    boe: {
      label: 'BOE/Pricing',
      module: 'boe',
      getContext(abp) {
        const cols = [];
        const approvals = (abp.approvals?.required || []);
        if (approvals.length) cols.push({ title: 'Required Approvals', items: approvals.map(a => ({ dot: 'yellow', text: a.action + '  ' + a.approver_role + ' (threshold ' + a.threshold + (a.timeout_ms ? ', timeout ' + (a.timeout_ms/3600000) + 'h' : '') + ')' })) });
        const perms = (abp.data?.permissions || []).filter(p => p.operations.includes('write'));
        if (perms.length) cols.push({ title: 'Write Permissions', items: perms.map(p => ({ dot: p.sensitivity === 'confidential' ? 'yellow' : 'green', text: p.resource + ' [' + p.operations.join(',') + '] ' + p.sensitivity })) });
        const tools = (abp.tools?.allow || []).filter(t => t.name.includes('seal') || t.name.includes('sign'));
        if (tools.length) cols.push({ title: 'Allowed Seal/Sign', items: tools.map(t => ({ dot: 'green', text: t.name + (t.scope ? ' (scope: ' + t.scope + ')' : '') })) });
        return cols;
      }
    },
    iris: {
      label: 'IRIS',
      module: null,
      getContext(abp) {
        const cols = [];
        const esc = (abp.escalation?.paths || []);
        if (esc.length) cols.push({ title: 'Escalation Paths', items: esc.map(e => ({ dot: e.severity === 'critical' ? 'red' : 'yellow', text: e.trigger + '  ' + e.destination + ' (' + e.severity + ', auto=' + e.auto + ')' })) });
        const validators = (abp.runtime?.validators || []).filter(v => v.when === 'periodic');
        if (validators.length) cols.push({ title: 'Periodic Validators', items: validators.map(v => ({ dot: 'cyan', text: v.name + '  ' + v.fail_action })) });
        return cols;
      }
    },
    utility: {
      label: 'Utility',
      module: null,
      getContext() { return []; }
    }
  };

  function renderAbpContextBar(tabId) {
    const bar = document.getElementById('abpBar');
    if (!bar) return;
    invalidateJsonCache();
    const abp = readJsonSafe('ds_abp_v1');
    if (!abp) { bar.classList.remove('active'); return; }

    const tabCfg = ABP_TAB_MAP[tabId];
    if (!tabCfg || tabId === 'utility') { bar.classList.remove('active'); return; }

    const scope = abp.scope || {};
    const modules = scope.modules || [];
    const inScope = !tabCfg.module || modules.includes(tabCfg.module);
    const cols = tabCfg.getContext(abp);

    let html = '<div class="abp-bar-header">' +
      '<span class="abp-bar-id">' + escapeHtml(abp.abp_id) + '</span>' +
      '<span class="abp-bar-scope">' + escapeHtml(scope.program || '') + ' / ' + escapeHtml(scope.contract_id || '') + '</span>';
    if (tabCfg.module) {
      html += '<span class="abp-bar-module-status ' + (inScope ? 'in-scope' : 'out-scope') + '">' +
        (inScope ? tabCfg.module + ' IN SCOPE' : tabCfg.module + ' NOT IN SCOPE') + '</span>';
    }
    html += '</div>';

    if (cols.length) {
      html += '<div class="abp-bar-body">';
      for (const col of cols) {
        html += '<div class="abp-bar-col"><div class="abp-bar-col-title">' + escapeHtml(col.title) + '</div>';
        for (const item of col.items) {
          html += '<div class="abp-bar-item"><span class="dot ' + item.dot + '"></span>' + escapeHtml(item.text) + '</div>';
        }
        html += '</div>';
      }
      html += '</div>';
    }

    bar.innerHTML = html;
    bar.classList.add('active');
  }

  document.getElementById('abpFileInput')?.addEventListener('change', loadAbpFromFile);
  document.getElementById('btnAbpVerify')?.addEventListener('click', verifyAbpFromStorage);
  document.getElementById('btnAbpClear')?.addEventListener('click', clearAbp);

  document.getElementById('btnExportRollupHost')?.addEventListener('click', exportRollupHost);
  document.getElementById('btnPrintExecHost')?.addEventListener('click', printExecHost);
  document.getElementById('btnRunSuiteTest')?.addEventListener('click', runSuiteTestMode);
  document.getElementById('btnVerifyPackHost')?.addEventListener('click', verifyPackHashHost);
  document.getElementById('btnImportZipHost')?.addEventListener('click', importModuleZipHost);
  document.getElementById('btnResetHostCache')?.addEventListener('click', () => { revokeModuleUrls(); hostRollup(); });
  window.addEventListener('beforeunload', revokeModuleUrls);

  const hostZipSupport = document.getElementById('hostZipSupportNote');
  if (hostZipSupport) hostZipSupport.textContent = (typeof DecompressionStream === 'function')
    ? 'ZIP engine: JSZip (host import).'
    : 'ZIP engine: JSZip CDN fallback will load on first import.';

  renderKeyRegistry();
  hostRollup();
  irisInit();
  renderAbpOnLoad();
  const fromHashRaw = (location.hash || '').replace('#','').trim();
  const fromHash = fromHashRaw;
  setActive((fromHash === 'utility' || fromHash === 'iris' || MODULES[fromHash]) ? fromHash : 'suite');
</script>
</body>
</html>
