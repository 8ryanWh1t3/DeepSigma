<!--
  EDGE JRM EDGE v1.0.4 — Process Proof Functions
  ================================================
  [x] [1] Artifact-First Flow: CTA strip, Generate JRM-X Now, live counters
  [x] [2] Deterministic Replay Proof: stableStringify, buildReplayState, PASS/FAIL hash assertion
  [x] [3] Integrity Validation + Tamper Test: per-file SHA-256, tamper inject, restore original
  [x] [4] DLR/DS/CE Linkage: stable IDs (signature_key, dlr_id, ds_id), per-selection display
  [x] [5] Signal vs Judgment Toggle: drawer section visibility filter
  [x] [6] Decision Card Export: Markdown copy + PNG canvas download
  [x] [7] Packet Chain Semantics: roll params, windowing note, chain display
  [x] [8] UX Polish: V/R/T keyboard shortcuts, live counters, performance preserved
  Prior: v1.0.4 features (error guard, stage timestamps, coherence math, COMPRESS,
         packet hash/seal, drift heat, replay, SOC/Gov toggle, explain banner,
         agentic demo, enterprise badges, pagination, seeded RNG, onboarding,
         toast notifications, progress bar, shortcut bar)
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Deep Sigma EDGE — JRM EDGE v1.0.4</title>
  <style>
    :root {
      --bg:#0b0f14; --card:#111824; --muted:#8aa0b5; --txt:#e7eef7;
      --accent:#7df9ff; --warn:#ffcc66; --bad:#ff6b6b; --ok:#5dff93;
      --ribbon:#1a2638; --line:#1b2a3a; --drawer-w:440px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--txt);font-size:13px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}
    .hidden{display:none!important}
    .muted{color:var(--muted)}
    .small{font-size:11px}

    /* ── Header ────────────────────────────────── */
    header{padding:10px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:14px;flex-wrap:nowrap;min-height:52px;background:rgba(8,12,20,.95)}
    .brand{white-space:nowrap;font-weight:700;letter-spacing:.4px;font-size:14px}
    .brand small{display:block;color:var(--muted);font-size:11px;font-weight:400;letter-spacing:0}

    /* Stage Ribbon */
    .stage-ribbon{display:flex;align-items:center;gap:0;flex:1;justify-content:center;overflow-x:auto}
    .stage-pill{padding:4px 10px;border-radius:8px;font-size:11px;font-weight:600;color:var(--muted);background:var(--ribbon);border:1px solid transparent;transition:all .2s;white-space:nowrap;letter-spacing:.3px}
    .stage-pill.active{color:var(--accent);border-color:rgba(125,249,255,.5);box-shadow:0 0 8px rgba(125,249,255,.15)}
    .stage-pill.done{color:var(--ok);border-color:rgba(93,255,147,.3)}
    .stage-arrow{color:#2a3a4e;font-size:10px;margin:0 2px}

    /* Coherence Meter */
    .coherence-wrap{display:flex;align-items:center;gap:10px;white-space:nowrap;position:relative}
    .meter-ring{width:44px;height:44px;border-radius:50%;border:3px solid #243449;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;transition:border-color .3s,color .3s}
    .meter-ring.green{border-color:var(--ok);color:var(--ok)}
    .meter-ring.yellow{border-color:var(--warn);color:var(--warn)}
    .meter-ring.red{border-color:var(--bad);color:var(--bad)}
    .meter-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
    .sub-toggle{cursor:pointer;font-size:11px;color:var(--accent);border:none;background:none;padding:2px 6px}
    .sub-dropdown{position:absolute;right:0;top:56px;background:var(--card);border:1px solid var(--line);border-radius:10px;padding:10px 14px;z-index:100;min-width:220px;box-shadow:0 8px 24px rgba(0,0,0,.5)}
    .sub-row{display:flex;justify-content:space-between;padding:4px 0;font-size:12px}
    .sub-row .sub-val{font-weight:600}

    /* ── Tabs ──────────────────────────────────── */
    .tabs{display:flex;gap:0;border-bottom:1px solid var(--line);padding:0 16px;background:rgba(11,15,20,.9)}
    .ttab{padding:10px 18px;font-size:12px;font-weight:600;color:var(--muted);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;transition:all .15s;letter-spacing:.3px}
    .ttab:hover{color:var(--txt)}
    .ttab.active{color:var(--accent);border-bottom-color:var(--accent)}

    /* ── Main Area ─────────────────────────────── */
    .main-area{display:flex;height:calc(100vh - 144px);overflow:hidden}
    .content{flex:1;overflow-y:auto;padding:14px 18px}
    .content section{max-width:1400px}

    /* ── Cards ─────────────────────────────────── */
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:12px}
    .card h3{margin:0 0 10px 0;font-size:14px;color:#cfe2f7;letter-spacing:.3px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}

    /* ── Buttons ───────────────────────────────── */
    button{background:#182235;color:var(--txt);border:1px solid #243449;border-radius:10px;padding:8px 14px;cursor:pointer;font-size:12px;transition:all .15s}
    button:hover{border-color:#2f4765}
    button.primary{border-color:rgba(125,249,255,.45);box-shadow:0 0 0 1px rgba(125,249,255,.12) inset}
    button.primary:hover{background:rgba(125,249,255,.08)}
    button.danger{border-color:rgba(255,107,107,.45)}
    button.ok{border-color:rgba(93,255,147,.45)}

    /* ── Inputs ────────────────────────────────── */
    input,select{background:#0d1520;color:var(--txt);border:1px solid #243449;border-radius:8px;padding:7px 10px;font-size:12px}
    input:focus,select:focus{border-color:rgba(125,249,255,.5);outline:none}
    label{display:block;font-size:11px;color:var(--muted);margin:8px 0 4px}

    /* ── Tables ────────────────────────────────── */
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:7px 8px;border-bottom:1px solid #141e2d;text-align:left;vertical-align:top}
    th{color:#8aa0b5;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.4px}
    tbody tr{cursor:pointer;transition:background .1s}
    tbody tr:hover{background:rgba(125,249,255,.03)}
    tbody tr.selected{background:rgba(125,249,255,.07)}

    /* ── Badges ────────────────────────────────── */
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:10px;font-weight:600;letter-spacing:.3px;border:1px solid}
    .sev-critical{color:#ff6b6b;border-color:rgba(255,107,107,.4);background:rgba(255,107,107,.08)}
    .sev-high{color:#ff9f43;border-color:rgba(255,159,67,.4);background:rgba(255,159,67,.08)}
    .sev-medium{color:#ffcc66;border-color:rgba(255,204,102,.4);background:rgba(255,204,102,.08)}
    .sev-low{color:#7df9ff;border-color:rgba(125,249,255,.3);background:rgba(125,249,255,.06)}
    .sev-info{color:#8aa0b5;border-color:rgba(138,160,181,.3);background:rgba(138,160,181,.06)}
    .lane-LOG_ONLY{color:#8aa0b5;border-color:rgba(138,160,181,.3);background:rgba(138,160,181,.06)}
    .lane-NOTIFY{color:#7df9ff;border-color:rgba(125,249,255,.3);background:rgba(125,249,255,.06)}
    .lane-QUEUE_PATCH{color:#ffcc66;border-color:rgba(255,204,102,.4);background:rgba(255,204,102,.08)}
    .lane-REQUIRE_REVIEW{color:#ff6b6b;border-color:rgba(255,107,107,.4);background:rgba(255,107,107,.08)}
    .drift-badge{color:#ff9f43;border-color:rgba(255,159,67,.4);background:rgba(255,159,67,.08)}

    /* ── Controls Bar ──────────────────────────── */
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .controls .sep{width:1px;height:24px;background:var(--line)}
    .speed-label{font-size:11px;color:var(--muted)}
    .speed-slider{width:80px;accent-color:var(--accent)}

    /* ── Filters ───────────────────────────────── */
    .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .filters input[type=text]{width:200px}
    .filters select{min-width:100px}
    .filters label{margin:0;display:flex;align-items:center;gap:4px;font-size:11px}

    /* ── KPI Row ───────────────────────────────── */
    .kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:12px}
    .kpi-card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:10px;text-align:center}
    .kpi-card .kv{font-size:20px;font-weight:700}
    .kpi-card .kl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-top:4px}

    /* ── Ingest Cards ──────────────────────────── */
    .ingest-option{text-align:center;padding:20px}
    .ingest-option h4{margin:0 0 8px;color:#cfe2f7}
    .ingest-option p{color:var(--muted);font-size:12px;margin:0 0 12px}
    .file-input-wrap{position:relative;display:inline-block}
    .file-input-wrap input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}

    /* ── Drawer ────────────────────────────────── */
    .drawer{width:0;min-width:0;background:var(--card);border-left:1px solid var(--line);overflow:hidden;transition:width .25s ease,min-width .25s ease;position:relative;z-index:50}
    .drawer.open{width:var(--drawer-w);min-width:var(--drawer-w);overflow-y:auto}
    .drawer-head{padding:10px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px;position:sticky;top:0;background:var(--card);z-index:10}
    .drawer-head .close-btn{margin-left:auto;background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:2px 6px}
    .drawer-head .close-btn:hover{color:var(--txt)}
    .drawer-collapse-bar{display:flex;align-items:center;justify-content:space-between;padding:6px 14px;background:#0a0f16;border-bottom:1px solid var(--line);cursor:pointer;-webkit-user-select:none;user-select:none}
    .drawer-collapse-bar:hover{background:#0f1520}
    .drawer-collapse-bar .collapse-arrow{font-size:16px;color:var(--accent);transition:transform .2s}
    .drawer-collapse-bar .collapse-label{font-size:11px;font-weight:600;color:var(--muted);letter-spacing:.5px}
    .drawer-body{padding:0 14px 14px}
    .dsection{margin-top:10px}
    .dsection-hdr{display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 0;border-bottom:1px solid #141e2d;font-size:12px;font-weight:600;color:#9ab8d3;user-select:none}
    .dsection-hdr:hover{color:var(--txt)}
    .dsection-hdr .arrow{transition:transform .15s;font-size:10px}
    .dsection-hdr .arrow.collapsed{transform:rotate(-90deg)}
    .dsection-body{padding:8px 0;font-size:12px}
    .dsection-body pre{background:#0a0f16;border:1px solid #141e2d;border-radius:8px;padding:10px;overflow-x:auto;font-size:11px;line-height:1.5;white-space:pre-wrap;word-break:break-all;max-height:300px}
    .kv-table{width:100%}
    .kv-table td{padding:3px 8px 3px 0;vertical-align:top}
    .kv-table td:first-child{color:var(--muted);white-space:nowrap;width:120px}

    /* ── Coherence Tab ─────────────────────────── */
    .big-meter{width:140px;height:140px;border-radius:50%;border:6px solid #243449;display:flex;align-items:center;justify-content:center;font-size:36px;font-weight:700;margin:20px auto}
    .big-meter.green{border-color:var(--ok);color:var(--ok)}
    .big-meter.yellow{border-color:var(--warn);color:var(--warn)}
    .big-meter.red{border-color:var(--bad);color:var(--bad)}
    .sub-bar-wrap{margin:6px 0}
    .sub-bar-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px}
    .sub-bar{height:6px;border-radius:3px;background:#1a2638;overflow:hidden}
    .sub-bar-fill{height:100%;border-radius:3px;transition:width .3s}

    /* ── Health Tab ────────────────────────────── */
    .health-ring-wrap{position:relative;display:inline-block;padding:20px;cursor:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24'><text y='18' font-size='18' fill='%237df9ff'>%CE%A3</text></svg>") 12 12,pointer}
    .health-ring-wrap .health-tip{display:none;position:absolute;left:50%;top:100%;transform:translateX(-50%);z-index:100;width:420px;padding:14px 18px;background:#0d1219;border:1px solid var(--accent);border-radius:10px;font-size:13px;line-height:1.7;color:var(--txt);white-space:pre-line;box-shadow:0 8px 32px rgba(0,0,0,.6);pointer-events:none}
    .health-ring-wrap:hover .health-tip{display:block}
    .health-tip .tip-title{font-size:15px;font-weight:700;color:var(--accent);margin-bottom:6px}
    .health-tip .tip-row{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #1a2638}
    .health-tip .tip-row-label{color:var(--muted)}
    .health-tip .tip-row-val{font-weight:700;font-variant-numeric:tabular-nums}
    .health-tip .tip-formula{margin-top:8px;padding:8px 10px;background:rgba(125,249,255,.04);border:1px solid rgba(125,249,255,.1);border-radius:6px;font-family:ui-monospace,monospace;font-size:12px;color:var(--accent)}
    .health-score-ring{width:120px;height:120px;border-radius:50%;border:5px solid #243449;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:700}
    .health-score-ring.green{border-color:var(--ok);color:var(--ok)}
    .health-score-ring.yellow{border-color:var(--warn);color:var(--warn)}
    .health-score-ring.red{border-color:var(--bad);color:var(--bad)}
    .health-bar{display:flex;height:22px;border-radius:4px;overflow:hidden;gap:1px;margin:8px 0}
    .health-bar div{display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;letter-spacing:.3px;min-width:2px}
    .health-stat{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #141e2d;font-size:12px}
    .health-stat .hs-label{color:var(--muted)}
    .health-stat .hs-val{font-weight:700;font-variant-numeric:tabular-nums}
    .health-flag{font-size:10px;padding:2px 6px;border-radius:4px;display:inline-block;font-weight:600;margin:1px}
    .health-flag.flag-warn{color:#ff9f43;background:rgba(255,159,67,.1);border:1px solid rgba(255,159,67,.3)}
    .health-flag.flag-danger{color:#ff6b6b;background:rgba(255,107,107,.1);border:1px solid rgba(255,107,107,.3)}
    .health-flag.flag-info{color:#7df9ff;background:rgba(125,249,255,.1);border:1px solid rgba(125,249,255,.3)}

    /* ── Pipeline Logic Process ─────────────────── */
    .pipeline-flow{display:flex;align-items:stretch;gap:0;margin:12px 0;overflow-x:auto}
    .pipeline-stage{flex:1;min-width:80px;text-align:center;position:relative}
    .pipeline-stage-hdr{font-size:10px;font-weight:700;letter-spacing:.4px;text-transform:uppercase;padding:6px 4px;color:var(--muted);border-bottom:2px solid var(--line)}
    .pipeline-stage-hdr.stage-ok{color:var(--ok);border-bottom-color:var(--ok)}
    .pipeline-stage-hdr.stage-warn{color:var(--warn);border-bottom-color:var(--warn)}
    .pipeline-stage-hdr.stage-bad{color:var(--bad);border-bottom-color:var(--bad)}
    .pipeline-stage-body{padding:6px 4px;font-size:11px}
    .pipeline-stage-pct{font-size:18px;font-weight:700;font-variant-numeric:tabular-nums}
    .pipeline-stage-bar{height:4px;border-radius:2px;background:#1a2638;margin:4px auto;width:80%;overflow:hidden}
    .pipeline-stage-bar-fill{height:100%;border-radius:2px;transition:width .3s}
    .pipeline-arrow{display:flex;align-items:center;color:#2a3a4e;font-size:14px;padding:0 2px;margin-top:12px}
    .pipeline-cascade{margin-top:10px;padding:10px;background:#0a0f16;border:1px solid #141e2d;border-radius:8px}
    .cascade-row{display:flex;align-items:center;gap:6px;padding:3px 0;font-size:11px}
    .cascade-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .cascade-dot.c-ok{background:var(--ok)}.cascade-dot.c-fail{background:var(--bad)}.cascade-dot.c-skip{background:#3a4a5e}
    .cascade-label{color:var(--muted);min-width:70px;font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:.3px}
    .cascade-count{font-variant-numeric:tabular-nums;font-weight:600}
    .cascade-reason{color:var(--muted);font-size:10px;margin-left:auto}
    .logic-section{margin-top:10px;padding:10px;background:#0a0f16;border:1px solid #141e2d;border-radius:8px}
    .logic-section h4{margin:0 0 6px;font-size:12px;color:var(--accent);letter-spacing:.3px}
    .logic-formula{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:11px;color:var(--txt);padding:6px 8px;background:rgba(125,249,255,.03);border:1px solid rgba(125,249,255,.1);border-radius:6px;margin:4px 0;line-height:1.6}
    .logic-rule{display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid #141e2d;font-size:11px}
    .logic-rule:last-child{border-bottom:none}
    .logic-rule-lane{min-width:110px;font-weight:600}
    .logic-rule-cond{color:var(--muted);flex:1}
    .logic-rule-arrow{color:#2a3a4e}
    .logic-scale{display:flex;gap:4px;margin:4px 0}
    .logic-scale-item{flex:1;text-align:center;padding:4px;border-radius:4px;font-size:10px;border:1px solid var(--line);cursor:pointer;transition:transform .1s,box-shadow .1s}
    .logic-scale-item:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.4)}
    .logic-scale-item.active{outline:2px solid var(--accent);outline-offset:1px}
    .heat-records{margin-top:8px;max-height:260px;overflow-y:auto;background:#0a0f16;border:1px solid #141e2d;border-radius:6px;padding:8px}
    .claim-bar{display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid #141e2d;font-size:11px}
    .claim-bar:last-child{border-bottom:none}
    .claim-key{min-width:180px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:10px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .claim-evidence-bar{display:block;flex:1;height:14px;background:#1a2638;border-radius:3px;overflow:hidden;position:relative}
    .claim-evidence-fill{display:block;height:100%;border-radius:3px;width:0;transition:width .6s ease-out}
    .claim-conf{min-width:44px;text-align:right;font-weight:600;font-variant-numeric:tabular-nums;font-size:11px}
    .claim-evts{min-width:30px;text-align:center;font-size:10px;color:var(--muted)}
    .q-expand-btn{background:none;border:none;color:var(--accent);font-size:10px;cursor:pointer;padding:1px 4px}
    .q-detail-row{background:#0a0f16;font-size:10px;color:var(--muted)}
    .q-detail-row td{padding:6px 8px;border-bottom:1px solid #0d1520}
    .q-detail-item{margin:2px 0;line-height:1.5}
    .q-detail-item strong{color:var(--txt);font-weight:600}

    /* ── Packet Viewer ─────────────────────────── */
    .pkt-split{display:grid;grid-template-columns:280px 1fr;gap:14px;min-height:400px}
    .pkt-list{overflow-y:auto}
    .pkt-item{padding:10px;border:1px solid var(--line);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:background .15s}
    .pkt-item:hover{background:rgba(125,249,255,.03)}
    .pkt-item.active{border-color:rgba(125,249,255,.4);background:rgba(125,249,255,.05)}
    .pkt-detail{overflow-y:auto}

    /* Synthwave accent */
    header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(125,249,255,.15) 20%,rgba(255,107,255,.1) 50%,rgba(125,249,255,.15) 80%,transparent)}
    header{position:relative}

    /* Scrollbar */
    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:#243449;border-radius:3px}
    ::-webkit-scrollbar-thumb:hover{background:#2f4765}

    /* ── Stage Markers ─────────────────────────── */
    .stage-marker{display:inline-block;width:16px;text-align:center;font-size:11px;font-weight:700;line-height:16px}
    .stage-marker.pass{color:var(--ok)}.stage-marker.fail{color:var(--bad)}.stage-marker.skip{color:#3a4a5e}
    .stage-status-row{display:flex;gap:2px;align-items:center;margin-top:4px}

    /* ── Drift Heat ────────────────────────────── */
    .drift-heat{display:inline-block;width:28px;height:18px;border-radius:4px;text-align:center;font-size:10px;font-weight:700;line-height:18px}
    .drift-heat-0{background:#1a2e1a;color:#5dff93}.drift-heat-1{background:#2a3a1a;color:#a8e06c}
    .drift-heat-2{background:#3a3a1a;color:#d4c040}.drift-heat-3{background:#3a2a1a;color:#ffcc66}
    .drift-heat-4{background:#3a1a1a;color:#ff9f43}.drift-heat-5{background:#4a1010;color:#ff6b6b}

    /* ── Compress View ─────────────────────────── */
    .compress-block{background:#0a0f16;border:1px solid #141e2d;border-radius:8px;padding:10px;margin-top:8px;font-size:11px;line-height:1.6}
    .compress-line{display:flex;gap:8px;align-items:baseline}
    .compress-label{color:var(--muted);font-size:10px;min-width:60px;text-transform:uppercase;letter-spacing:.3px}
    .compress-arrow{color:#2a3a4e;font-size:12px;text-align:center;padding:2px 0}

    /* ── Seal Badge ────────────────────────────── */
    .seal-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:999px;font-size:11px;font-weight:600}
    .seal-ok{color:var(--ok);border:1px solid rgba(93,255,147,.4);background:rgba(93,255,147,.08)}
    .seal-broken{color:var(--bad);border:1px solid rgba(255,107,107,.4);background:rgba(255,107,107,.08)}
    .seal-pending{color:var(--muted);border:1px solid rgba(138,160,181,.3);background:rgba(138,160,181,.06)}
    .hash-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:10px;color:var(--muted);word-break:break-all}

    /* ── Replay ────────────────────────────────── */
    .replay-msg{background:#0a1a0a;border:1px solid rgba(93,255,147,.3);border-radius:10px;padding:12px;margin-top:10px;font-size:12px;color:var(--ok)}
    .replay-msg .replay-hash{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:10px;color:var(--muted);margin-top:4px}

    /* ── View Mode Toggle ──────────────────────── */
    .view-toggle{position:fixed;bottom:18px;right:18px;z-index:200;display:flex;border-radius:12px;overflow:hidden;border:1px solid var(--line);box-shadow:0 4px 16px rgba(0,0,0,.5)}
    .view-toggle button{padding:8px 14px;font-size:11px;font-weight:600;border:none;cursor:pointer;transition:all .15s;letter-spacing:.3px}
    .view-toggle .vt-soc{background:#182235;color:var(--muted)}
    .view-toggle .vt-gov{background:#182235;color:var(--muted)}
    .view-toggle .vt-soc.active{background:rgba(255,107,107,.15);color:var(--bad)}
    .view-toggle .vt-gov.active{background:rgba(125,249,255,.1);color:var(--accent)}

    /* ── Error Banner ──────────────────────────── */
    .err-banner{position:fixed;top:0;left:0;right:0;z-index:9999;background:#2a0a0a;border-bottom:2px solid var(--bad);padding:8px 16px;display:flex;align-items:center;gap:10px;font-size:12px;color:#ffaaaa}
    .err-banner .err-msg{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .err-banner .err-loc{color:var(--muted);font-size:10px}
    .err-banner button{padding:4px 10px;font-size:11px}
    .err-banner .err-close{background:none;border:none;color:var(--muted);font-size:16px;cursor:pointer;padding:2px 6px}

    /* ── Explain Banner ────────────────────────── */
    .explain-banner{background:linear-gradient(135deg,rgba(125,249,255,.04),rgba(93,255,147,.03));border:1px solid rgba(125,249,255,.15);border-radius:12px;padding:10px 16px;margin-bottom:12px;font-size:12px;line-height:1.5}
    .explain-banner strong{color:var(--accent)}

    /* ── Enterprise Badges ─────────────────────── */
    .tier-badge{display:inline-block;padding:1px 6px;border-radius:4px;font-size:9px;font-weight:700;letter-spacing:.5px;vertical-align:middle;margin-left:4px}
    .tier-core{background:rgba(93,255,147,.1);color:var(--ok);border:1px solid rgba(93,255,147,.25)}
    .tier-ent{background:rgba(125,249,255,.08);color:var(--accent);border:1px solid rgba(125,249,255,.2)}

    /* ── Load More ─────────────────────────────── */
    .load-more-wrap{text-align:center;padding:10px}
    .load-more-wrap button{font-size:12px;padding:6px 20px}
    .row-cap-msg{color:var(--muted);font-size:11px;margin-top:4px}

    /* ── Toast Notifications ───────────────────── */
    .toast-wrap{position:fixed;bottom:60px;right:18px;z-index:8000;display:flex;flex-direction:column-reverse;gap:6px;pointer-events:none}
    .toast{pointer-events:auto;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:500;box-shadow:0 4px 16px rgba(0,0,0,.5);animation:toastIn .25s ease-out,toastOut .3s ease-in 2.7s forwards;max-width:340px}
    .toast-ok{background:rgba(93,255,147,.12);border:1px solid rgba(93,255,147,.3);color:var(--ok)}
    .toast-warn{background:rgba(255,204,102,.1);border:1px solid rgba(255,204,102,.3);color:var(--warn)}
    .toast-info{background:rgba(125,249,255,.08);border:1px solid rgba(125,249,255,.2);color:var(--accent)}
    @keyframes toastIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    @keyframes toastOut{from{opacity:1}to{opacity:0;transform:translateY(-8px)}}

    /* ── Progress Bar ──────────────────────────── */
    .progress-wrap{height:3px;background:rgba(125,249,255,.08);border-radius:2px;margin-top:6px;overflow:hidden}
    .progress-bar{height:100%;width:0%;background:var(--accent);border-radius:2px;transition:width .15s linear}

    /* ── Onboarding Overlay ────────────────────── */
    .onboard-overlay{position:fixed;inset:0;z-index:7000;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center}
    .onboard-card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:28px 32px;max-width:520px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.6)}
    .onboard-card h2{margin:0 0 14px;color:var(--accent);font-size:18px}
    .onboard-steps{list-style:none;padding:0;margin:0 0 18px}
    .onboard-steps li{display:flex;align-items:flex-start;gap:10px;margin-bottom:14px;font-size:13px;line-height:1.5}
    .onboard-step-num{flex-shrink:0;width:26px;height:26px;border-radius:50%;background:rgba(125,249,255,.12);border:1px solid rgba(125,249,255,.3);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:var(--accent)}
    .onboard-actions{display:flex;align-items:center;gap:12px}
    .onboard-dismiss{font-size:11px;color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:4px}

    /* ── Shortcut Bar ──────────────────────────── */
    .shortcut-bar{position:fixed;bottom:0;left:0;right:0;z-index:150;background:rgba(11,15,20,.92);border-top:1px solid var(--line);padding:4px 16px;display:flex;align-items:center;gap:14px;font-size:10px;color:var(--muted);-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px)}
    .shortcut-bar kbd{display:inline-block;padding:1px 5px;border-radius:3px;background:rgba(125,249,255,.08);border:1px solid rgba(125,249,255,.15);font-family:inherit;font-size:10px;color:var(--accent);margin:0 1px}
    .shortcut-bar .shortcut-close{margin-left:auto;cursor:pointer;padding:2px 6px;color:var(--muted);font-size:12px}

    /* ── Row Click Hint ────────────────────────── */
    .row-hint{text-align:center;padding:4px;font-size:10px;color:var(--muted);opacity:.7;transition:opacity .3s}
    #eventBody tr{cursor:pointer}
    #eventBody tr:hover{background:rgba(125,249,255,.04)}

    /* ── Speed Slider Labels ───────────────────── */
    .speed-labels{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--muted)}
    .speed-labels .speed-end{opacity:.6}

    /* ── Tab Step Numbers ──────────────────────── */
    .ttab .step-num{display:inline-block;width:16px;height:16px;border-radius:50%;background:rgba(125,249,255,.08);font-size:9px;line-height:16px;text-align:center;color:var(--accent);margin-right:4px;font-weight:700}
    .ttab.active .step-num{background:rgba(125,249,255,.2)}

    /* ── CTA Strip ────────────────────────────── */
    .cta-strip{display:flex;align-items:center;gap:6px;padding:6px 16px;background:rgba(11,15,20,.85);border-bottom:1px solid var(--line);font-size:11px;color:var(--muted)}
    .cta-step{padding:3px 10px;border-radius:6px;border:1px solid var(--line);opacity:.5;transition:all .2s}
    .cta-step.done{opacity:1;color:var(--accent);border-color:rgba(125,249,255,.25);background:rgba(125,249,255,.06)}
    .cta-step.active{opacity:1;color:var(--txt);border-color:rgba(125,249,255,.4)}
    .cta-arrow{color:var(--line);font-size:13px}
    .cta-generate-btn{padding:5px 16px;border-radius:8px;background:var(--accent);color:#0b0f14;font-weight:700;font-size:12px;border:none;cursor:pointer;animation:pulse 2s ease-in-out infinite;transition:box-shadow .2s}
    .cta-generate-btn:hover{box-shadow:0 0 16px rgba(125,249,255,.4)}
    .cta-generate-btn:disabled{opacity:.4;cursor:default;animation:none}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(125,249,255,.3)}50%{box-shadow:0 0 12px 4px rgba(125,249,255,.25)}}

    /* ── Live Counters ────────────────────────── */
    .live-counters{display:flex;gap:14px;margin-left:auto;margin-right:12px}
    .live-counter{display:flex;flex-direction:column;align-items:center;gap:1px}
    .lc-val{font-size:14px;font-weight:700;color:var(--accent);font-variant-numeric:tabular-nums}
    .lc-label{font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted)}

    /* ── Drawer View Toggle ───────────────────── */
    .drawer-view-toggle{display:flex;gap:2px;background:rgba(11,15,20,.6);border-radius:6px;padding:2px;border:1px solid var(--line)}
    .drawer-view-toggle button{padding:3px 10px;border:none;border-radius:4px;background:transparent;color:var(--muted);font-size:10px;cursor:pointer;transition:all .15s}
    .drawer-view-toggle button.active{background:rgba(125,249,255,.12);color:var(--accent)}

    /* ── Tamper Fail State ─────────────────────── */
    .tamper-fail{border:2px solid #ff6b6b !important;animation:tamperShake .4s ease-in-out}
    @keyframes tamperShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
    .tamper-banner{background:rgba(255,107,107,.12);border:1px solid rgba(255,107,107,.4);color:#ff6b6b;padding:8px 14px;border-radius:8px;font-size:12px;font-weight:600;text-align:center;margin:8px 0}

    /* ── Replay Proof Panel ────────────────────── */
    .replay-proof{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;margin:8px 0;font-size:12px}
    .replay-proof h4{margin:0 0 8px;color:var(--accent);font-size:13px}
    .replay-proof-pass{color:#51cf66;font-weight:700}
    .replay-proof-fail{color:#ff6b6b;font-weight:700}
    .replay-proof .hash-display{font-family:monospace;font-size:10px;color:var(--muted);word-break:break-all;padding:4px 8px;background:rgba(0,0,0,.3);border-radius:4px;margin:4px 0}

    /* ── Packet Chain Note ─────────────────────── */
    .pkt-chain-note{background:rgba(125,249,255,.04);border:1px solid rgba(125,249,255,.12);border-radius:8px;padding:8px 12px;font-size:11px;color:var(--muted);line-height:1.5;margin-bottom:10px}

    /* ── Decision Card Actions ─────────────────── */
    .decision-card-actions{display:flex;gap:6px}
    .decision-card-actions button{padding:3px 10px;border-radius:6px;font-size:10px;border:1px solid var(--line);background:transparent;color:var(--muted);cursor:pointer;transition:all .15s}
    .decision-card-actions button:hover{border-color:rgba(125,249,255,.3);color:var(--accent)}

    /* ── Scenario Mixer ─────────────────────────── */
    .scenario-mixer{margin-top:8px;padding:12px 14px;display:none}
    .scenario-mixer.open{display:block}
    .scenario-mixer h4{margin:0 0 8px;font-size:13px;color:var(--accent)}
    .mixer-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:6px 14px}
    .mixer-row{display:flex;align-items:center;gap:6px;font-size:11px}
    .mixer-row label{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin:0;color:var(--txt)}
    .mixer-row input[type=range]{width:60px;accent-color:var(--accent)}
    .mixer-row .mixer-val{width:24px;text-align:right;font-variant-numeric:tabular-nums;color:var(--accent);font-weight:600;font-size:11px}
    .mixer-row .mixer-diff{font-size:8px;padding:1px 4px;border-radius:3px;font-weight:700;margin-left:2px}
    .mixer-total{margin-top:8px;font-size:12px;color:var(--muted);display:flex;align-items:center;gap:12px}
    .mixer-total strong{color:var(--accent);font-size:14px;font-variant-numeric:tabular-nums}
    .mixer-toggle{background:none;border:1px solid var(--line);color:var(--muted);font-size:11px;padding:3px 10px;border-radius:6px;cursor:pointer;transition:all .15s}
    .mixer-toggle:hover{border-color:rgba(125,249,255,.3);color:var(--accent)}

    /* ── Scenario Badges ───────────────────────── */
    .scenario-badge{display:inline-block;padding:1px 5px;border-radius:4px;font-size:8px;font-weight:700;letter-spacing:.3px;text-transform:uppercase;vertical-align:middle}
    .scen-low{color:#51cf66;border:1px solid rgba(81,207,102,.3);background:rgba(81,207,102,.06)}
    .scen-medium{color:#7df9ff;border:1px solid rgba(125,249,255,.3);background:rgba(125,249,255,.06)}
    .scen-hard{color:#ff9f43;border:1px solid rgba(255,159,67,.3);background:rgba(255,159,67,.06)}
    .scen-high{color:#ff6b6b;border:1px solid rgba(255,107,107,.3);background:rgba(255,107,107,.06)}
    .scen-expert{color:#cc5de8;border:1px solid rgba(204,93,232,.3);background:rgba(204,93,232,.06)}

    /* ── Linkage IDs ──────────────────────────── */
    .linkage-id{font-family:monospace;font-size:10px;color:rgba(125,249,255,.5);padding:1px 5px;background:rgba(125,249,255,.04);border-radius:3px;margin-left:6px}
  </style>
</head>
<body>

<!-- ── Toast Container ── -->
<div class="toast-wrap" id="toastWrap"></div>

<!-- ── Onboarding Overlay (hidden after first dismiss) ── -->
<div class="onboard-overlay" id="onboardOverlay" style="display:none">
  <div class="onboard-card">
    <h2>Welcome to JRM EDGE</h2>
    <p style="color:var(--muted);font-size:12px;margin:0 0 16px">This tool visualizes events flowing through a 9-stage Judgment Refinement pipeline. Here's how to get started:</p>
    <ol class="onboard-steps">
      <li><span class="onboard-step-num">1</span><div><strong>Ingest</strong> — Load raw logs (EVE, Snort, Copilot) or JRM-X packet zips. Or click <em>Use Embedded Demo Data</em> to explore with sample data.</div></li>
      <li><span class="onboard-step-num">2</span><div><strong>Run</strong> — Press Start to stream events through RAW &rarr; PARSE &rarr; &hellip; &rarr; MEMORY. Watch the stage ribbon animate and coherence score update in real time.</div></li>
      <li><span class="onboard-step-num">3</span><div><strong>Explore</strong> — Click any table row to open the trace drawer. Use the Trace, Packets, and Coherence tabs for deeper inspection.</div></li>
    </ol>
    <div class="onboard-actions">
      <button class="primary" id="onboardStart" style="padding:8px 20px">Get Started</button>
      <button class="ok" id="onboardDemo" style="padding:8px 20px">Load Demo Data</button>
      <label class="onboard-dismiss"><input type="checkbox" id="onboardDontShow"/> Don't show again</label>
    </div>
  </div>
</div>

<!-- ── Shortcut Bar ── -->
<div class="shortcut-bar" id="shortcutBar">
  <span><kbd>Space</kbd> Pause/Resume</span>
  <span><kbd>J</kbd><kbd>K</kbd> Navigate rows</span>
  <span><kbd>F</kbd> or <kbd>/</kbd> Search</span>
  <span><kbd>Esc</kbd> Close drawer</span>
  <span><kbd>V</kbd> Validate</span>
  <span><kbd>R</kbd> Replay</span>
  <span><kbd>T</kbd> Tamper</span>
  <span class="shortcut-close" id="shortcutClose" title="Hide shortcut bar">&times;</span>
</div>

<!-- ── Error Banner (hidden by default) ── -->
<div class="err-banner hidden" id="errBanner">
  <span class="err-msg" id="errMsg"></span>
  <span class="err-loc" id="errLoc"></span>
  <button id="errCopy">Copy error</button>
  <button class="err-close" id="errClose">&times;</button>
</div>

<!-- ═══════════════ HEADER ═══════════════ -->
<header>
  <div class="brand">
    Deep Sigma EDGE — JRM EDGE
    <small>Judgment Refinement Module | v1.0.4</small>
  </div>
  <div class="live-counters" id="liveCounters">
    <div class="live-counter"><span class="lc-val" id="lcEvents">0</span><span class="lc-label">Events</span></div>
    <div class="live-counter"><span class="lc-val" id="lcDLR">0</span><span class="lc-label">DLR</span></div>
    <div class="live-counter"><span class="lc-val" id="lcDS">0</span><span class="lc-label">DS</span></div>
    <div class="live-counter"><span class="lc-val" id="lcParts">0</span><span class="lc-label">Parts</span></div>
  </div>
  <div class="stage-ribbon" id="stageRibbon" role="status" aria-label="Pipeline stage progress"></div>
  <div class="coherence-wrap">
    <div>
      <div class="meter-label">Coherence</div>
      <div class="meter-ring" id="meterMain" role="meter" aria-label="Coherence score" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" title="75+ = Good | 50-74 = Warning | &lt;50 = Critical. Click &#9662; for sub-scores.">0</div>
    </div>
    <button class="sub-toggle" id="subToggle" title="Sub-scores">▾</button>
    <div class="sub-dropdown hidden" id="subDropdown">
      <div class="sub-row"><span>Parse Completeness <span class="muted">(20%)</span></span><span class="sub-val" id="subParse">0</span></div>
      <div class="sub-row"><span>Join Rate <span class="muted">(20%)</span></span><span class="sub-val" id="subJoin">0</span></div>
      <div class="sub-row"><span>Reasoning Coverage <span class="muted">(20%)</span></span><span class="sub-val" id="subReason">0</span></div>
      <div class="sub-row"><span>Drift Coverage <span class="muted">(20%)</span></span><span class="sub-val" id="subDrift">0</span></div>
      <div class="sub-row"><span>Patch Lineage Integrity <span class="muted">(20%)</span></span><span class="sub-val" id="subPatch">0</span></div>
      <div class="sub-row" style="border-top:1px solid var(--line);margin-top:4px;padding-top:6px"><span class="muted small">Last updated</span><span class="sub-val muted small" id="subUpdated">--:--:--</span></div>
    </div>
  </div>
</header>

<!-- ═══════════════ TABS ═══════════════ -->
<div class="tabs">
  <button class="ttab active" data-tab="ingest"><span class="step-num">1</span>Ingest</button>
  <button class="ttab" data-tab="run"><span class="step-num">2</span>Run</button>
  <button class="ttab" data-tab="trace"><span class="step-num">3</span>Trace</button>
  <button class="ttab" data-tab="packets"><span class="step-num">4</span>Packets</button>
  <button class="ttab" data-tab="coherence"><span class="step-num">5</span>Coherence</button>
  <button class="ttab" data-tab="health"><span class="step-num">6</span>&#9829; Health</button>
</div>

<!-- ═══════════════ CTA STRIP ═══════════════ -->
<div class="cta-strip" id="ctaStrip">
  <span class="cta-step done" id="ctaIngest">Ingest</span>
  <span class="cta-arrow">&rarr;</span>
  <span class="cta-step" id="ctaRun">Run</span>
  <span class="cta-arrow">&rarr;</span>
  <button class="cta-generate-btn" id="ctaGenerate" disabled>Generate JRM-X Now</button>
  <span class="cta-arrow">&rarr;</span>
  <span class="cta-step" id="ctaValidate">Validate</span>
  <span class="cta-arrow">&rarr;</span>
  <span class="cta-step" id="ctaReplay">Replay Proof</span>
</div>

<!-- ═══════════════ MAIN ═══════════════ -->
<div class="main-area">
  <div class="content">

    <!-- ── Ingest Tab ── -->
    <section id="tab-ingest">
      <div class="explain-banner">
        <strong>What:</strong> Turns raw logs into decision-ready packets. <strong>How:</strong> RAW &rarr; PARSE &rarr; NORMALIZE &rarr; JOIN &rarr; TRUTH &rarr; REASONING &rarr; DRIFT &rarr; PATCH &rarr; MEMORY. <strong>Output:</strong> JRM-X Packet (6 artifacts): TS / ALS / DLR / DS / MG&Delta; / CE.
      </div>
      <div class="grid3">
        <div class="card ingest-option">
          <h4>A) Load Raw Log File <span class="tier-badge tier-core">CORE</span></h4>
          <p>EVE JSON, Snort fast.log, or Copilot JSONL</p>
          <label>Format</label>
          <select id="inFmt" style="width:100%;margin-bottom:8px">
            <option value="auto">Auto-detect</option>
            <option value="eve">Suricata EVE</option>
            <option value="snort">Snort fast.log</option>
            <option value="copilot">Copilot Agent</option>
          </select>
          <div class="file-input-wrap">
            <button class="primary">Choose File</button>
            <input type="file" id="inRawFile" accept=".json,.jsonl,.log,.txt,.ndjson"/>
          </div>
          <div id="inRawStatus" class="muted small" style="margin-top:6px"></div>
        </div>
        <div class="card ingest-option">
          <h4>B) Load JRM-X Packet (6 artifacts) <span class="tier-badge tier-core">CORE</span></h4>
          <p>Upload one or more packet zip files. Each zip is a time-windowed packet &mdash; not a single forever-archive. Load multiple for a Packet Chain.</p>
          <div class="file-input-wrap">
            <button class="primary">Choose Zip(s)</button>
            <input type="file" id="inZipFile" accept=".zip" multiple/>
          </div>
          <div id="inZipStatus" class="muted small" style="margin-top:6px"></div>
        </div>
        <div class="card ingest-option">
          <h4>C) Load Folder Files</h4>
          <p>Select 6 individual JSON files</p>
          <label>truth_snapshot.json</label><input type="file" class="folder-file" data-key="truth_snapshot" accept=".json"/>
          <label>authority_slice.json</label><input type="file" class="folder-file" data-key="authority_slice" accept=".json"/>
          <label>decision_lineage.jsonl</label><input type="file" class="folder-file" data-key="decision_lineage" accept=".json,.jsonl"/>
          <label>drift_signal.jsonl</label><input type="file" class="folder-file" data-key="drift_signal" accept=".json,.jsonl"/>
          <label>memory_graph.json</label><input type="file" class="folder-file" data-key="memory_graph" accept=".json"/>
          <label>canon_entry.json</label><input type="file" class="folder-file" data-key="canon_entry" accept=".json"/>
          <div style="margin-top:8px"><button id="btnLoadFolder" class="primary">Load Folder Files</button></div>
          <div id="inFolderStatus" class="muted small" style="margin-top:6px"></div>
        </div>
      </div>
      <div class="card" style="text-align:center;margin-top:6px">
        <button id="btnDemo" class="ok" style="font-size:13px;padding:10px 24px">Use Embedded Demo Data</button>
        <span class="muted small" style="margin-left:10px"><span id="mixerTotalLabel">250</span> events + 4 packet parts</span>
        <button class="mixer-toggle" id="btnMixerToggle" style="margin-left:10px">Customize Mix</button>
        <span style="margin-left:12px"></span>
        <button id="btnAgenticDemo" class="primary" style="font-size:13px;padding:10px 24px">Run Agentic Demo</button>
        <span class="muted small" style="margin-left:10px">Auto-load + auto-run at full speed</span>
      </div>
      <div class="card scenario-mixer" id="scenarioMixer" style="margin-top:6px">
        <h4>Scenario Mix &amp; Difficulty</h4>
        <div class="mixer-grid">
          <div class="mixer-row"><label><span class="scenario-badge scen-medium">MED</span> FP Spike</label><input type="range" min="0" max="100" value="25" data-scen="FP_SPIKE"/><span class="mixer-val">25</span></div>
          <div class="mixer-row"><label><span class="scenario-badge scen-medium">MED</span> Stale Logic</label><input type="range" min="0" max="50" value="15" data-scen="STALE_LOGIC"/><span class="mixer-val">15</span></div>
          <div class="mixer-row"><label><span class="scenario-badge scen-hard">HARD</span> Lateral Move</label><input type="range" min="0" max="50" value="20" data-scen="LATERAL"/><span class="mixer-val">20</span></div>
          <div class="mixer-row"><label><span class="scenario-badge scen-hard">HARD</span> DNS Exfil</label><input type="range" min="0" max="50" value="20" data-scen="DNS_EXFIL"/><span class="mixer-val">20</span></div>
          <div class="mixer-row"><label><span class="scenario-badge scen-hard">HARD</span> Multi-Proto</label><input type="range" min="0" max="30" value="5" data-scen="MULTI_PROTO"/><span class="mixer-val">5</span></div>
          <div class="mixer-row"><label><span class="scenario-badge scen-high">HIGH</span> Critical Burst</label><input type="range" min="0" max="50" value="10" data-scen="CRITICAL"/><span class="mixer-val">10</span></div>
          <div class="mixer-row"><label><span class="scenario-badge scen-high">HIGH</span> Agentic</label><input type="range" min="0" max="60" value="30" data-scen="AGENTIC"/><span class="mixer-val">30</span></div>
          <div class="mixer-row"><label><span class="scenario-badge scen-low">LOW</span> Benign Noise</label><input type="range" min="0" max="100" value="40" data-scen="BENIGN"/><span class="mixer-val">40</span></div>
          <div class="mixer-row"><label><span class="scenario-badge scen-high">V.HARD</span> Chaos Mix</label><input type="range" min="0" max="60" value="30" data-scen="CHAOS"/><span class="mixer-val">30</span></div>
          <div class="mixer-row"><label><span class="scenario-badge scen-expert">EXPERT</span> Edge Cases</label><input type="range" min="0" max="30" value="15" data-scen="EDGE"/><span class="mixer-val">15</span></div>
          <div class="mixer-row"><label><span class="scenario-badge scen-medium">MED</span> Tissue (Fill)</label><input type="range" min="0" max="100" value="30" data-scen="TISSUE"/><span class="mixer-val">30</span></div>
        </div>
        <div class="mixer-total">
          Total: <strong id="mixerTotal">250</strong> events
          <button class="ok" id="btnMixerReset" style="font-size:10px;padding:2px 8px">Reset Defaults</button>
        </div>
      </div>
      <div class="card" style="margin-top:6px">
        <h3>Loaded Data</h3>
        <div id="inSummary" class="muted">No data loaded.</div>
      </div>
    </section>

    <!-- ── Run Console Tab ── -->
    <section id="tab-run" class="hidden">
      <div style="margin-bottom:8px"><span class="tier-badge tier-core">CORE</span> Local pipeline run <span class="tier-badge tier-ent">ENTERPRISE</span> Federation, gate, hub, advisories, full streaming connectors</div>
      <div class="controls">
        <button id="btnStart" class="ok">▶ Start</button>
        <button id="btnPause">⏸ Pause</button>
        <button id="btnStep">⏭ Step</button>
        <button id="btnStop" class="danger">⏹ Stop</button>
        <div class="sep"></div>
        <div class="speed-labels">
          <span class="speed-end">Slow</span>
          <input type="range" id="speedSlider" class="speed-slider" min="1" max="100" value="50"/>
          <span class="speed-end">Fast</span>
          <span id="speedVal" class="muted small" style="margin-left:4px">50ms</span>
        </div>
        <div class="sep"></div>
        <span id="runStatus" class="muted small">Idle</span>
        <span id="runProgress" class="muted small" style="margin-left:auto"></span>
      </div>
      <div class="progress-wrap"><div class="progress-bar" id="progressBar"></div></div>
      <div class="filters">
        <select id="fSev"><option value="">All Severities</option><option>critical</option><option>high</option><option>medium</option><option>low</option><option>info</option></select>
        <select id="fLane"><option value="">All Lanes</option><option>REQUIRE_REVIEW</option><option>QUEUE_PATCH</option><option>NOTIFY</option><option>LOG_ONLY</option></select>
        <label><input type="checkbox" id="fDrift"/> Drift only</label>
        <input type="text" id="fSearch" placeholder="Search (/ to focus)"/>
      </div>
      <div style="overflow-x:auto">
        <table id="eventTable">
          <thead><tr>
            <th>#</th><th>Time</th><th>Source</th><th>Type</th><th>Sig/Action</th><th>Severity</th><th>Lane</th><th>Drift</th><th>Heat</th><th>Scenario</th><th>Part</th>
          </tr></thead>
          <tbody id="eventBody"></tbody>
        </table>
      </div>
      <div class="row-hint" id="rowHint" style="display:none">Click any row to open the trace drawer &nbsp;|&nbsp; <kbd style="font-size:10px;padding:1px 4px;border-radius:3px;background:rgba(125,249,255,.08);border:1px solid rgba(125,249,255,.15);color:var(--accent)">J</kbd> <kbd style="font-size:10px;padding:1px 4px;border-radius:3px;background:rgba(125,249,255,.08);border:1px solid rgba(125,249,255,.15);color:var(--accent)">K</kbd> to navigate</div>
      <div id="runEmpty" class="muted" style="text-align:center;padding:30px">No data loaded yet. <button onclick="setTab('ingest')" style="background:none;border:none;color:var(--accent);cursor:pointer;text-decoration:underline;font-size:inherit">Go to Ingest</button> to load events, then press <strong>Start</strong>.</div>
      <div class="load-more-wrap hidden" id="loadMoreWrap">
        <button id="btnLoadMore">Load More Rows</button>
        <div class="row-cap-msg" id="loadMoreMsg"></div>
      </div>
    </section>

    <!-- ── Trace Tab (full-width) ── -->
    <section id="tab-trace" class="hidden">
      <div id="traceFullView" class="muted" style="text-align:center;padding:30px">Run the pipeline on the <button onclick="setTab('run')" style="background:none;border:none;color:var(--accent);cursor:pointer;text-decoration:underline;font-size:inherit">Run</button> tab, then click any event row to view its full 9-stage trace here.</div>
    </section>

    <!-- ── Packet Viewer Tab ── -->
    <section id="tab-packets" class="hidden">
      <div style="margin-bottom:8px;font-size:12px"><span class="tier-badge tier-core">CORE</span> <strong>JRM-X Packet (6 artifacts)</strong> &mdash; time-windowed decision snapshots. Multiple parts form a <strong>Packet Chain</strong> (not a single forever-archive).</div>
      <div class="pkt-chain-note">Packets roll on <strong>roll_events=50,000</strong> or <strong>roll_mb=25</strong>. Windowing: <strong>ROLLING</strong>. Multiple parts form a chain &mdash; not a single forever-archive.</div>
      <div class="pkt-split">
        <div class="pkt-list" id="pktList">
          <div class="muted" style="padding:10px">No packets loaded. <button onclick="setTab('ingest')" style="background:none;border:none;color:var(--accent);cursor:pointer;text-decoration:underline;font-size:inherit">Load JRM-X packets</button> from the Ingest tab.</div>
        </div>
        <div class="pkt-detail" id="pktDetail">
          <div class="muted" style="padding:10px">Select a packet part to view its contents.</div>
        </div>
      </div>
    </section>

    <!-- ── Coherence Tab ── -->
    <section id="tab-coherence" class="hidden">
      <div style="text-align:center">
        <div class="big-meter" id="bigMeter">0</div>
        <div class="muted small">Overall Coherence Score</div>
      </div>
      <div class="grid2" style="margin-top:14px">
        <div class="card">
          <h3>Sub-Scores</h3>
          <div id="cohSubBars"></div>
        </div>
        <div class="card">
          <h3>Top Drift Drivers</h3>
          <div id="cohDriftDrivers" class="muted">No drift data.</div>
        </div>
      </div>
      <div class="grid2">
        <div class="card">
          <h3>Patch Latency</h3>
          <div id="cohPatchLatency" class="muted">No patch data.</div>
        </div>
        <div class="card">
          <h3>Join Failures</h3>
          <div id="cohJoinFails" class="muted">No join failure data.</div>
        </div>
      </div>
    </section>

    <!-- ── Health Tab ── -->
    <section id="tab-health" class="hidden">
      <div style="text-align:center;margin-bottom:14px">
        <div class="health-ring-wrap">
          <div class="health-score-ring" id="healthRing">--</div>
          <div class="muted small">Logic Health Score</div>
          <div class="health-tip" id="healthTip"></div>
        </div>
      </div>
      <div class="card">
        <h3>&#9881; Pipeline Logic Process</h3>
        <div class="muted small" style="margin-bottom:8px">9-stage pipeline: per-stage pass/fail rates and failure cascade analysis.</div>
        <div id="healthPipeline" class="muted">Run the pipeline to see stage health.</div>
      </div>
      <div class="card">
        <h3>&#128269; Decision Logic Explained</h3>
        <div class="muted small" style="margin-bottom:8px">The rules, formulas, and thresholds DeepSigma uses to reach conclusions.</div>
        <div id="healthLogicExplained" class="muted">Run the pipeline to see decision logic.</div>
      </div>
      <div class="card">
        <h3>&#128200; Claim Evidence Map</h3>
        <div class="muted small" style="margin-bottom:8px">How claims are built from source events and how confidence converges.</div>
        <div id="healthClaimMap" class="muted">Run the pipeline to see claim evidence.</div>
      </div>
      <div class="grid2">
        <div class="card">
          <h3>Logic Health Overview</h3>
          <div id="healthOverview" class="muted">Run the pipeline to see health metrics.</div>
        </div>
        <div class="card">
          <h3>Decision Quality Metrics</h3>
          <div id="healthQuality" class="muted">Run the pipeline to see health metrics.</div>
        </div>
      </div>
      <div class="card">
        <h3>&#9829; Questionable Records</h3>
        <div class="muted small" style="margin-bottom:8px">Events flagged for uncertain or contradictory scoring. Click rows to expand detail.</div>
        <div id="healthQuestionable" class="muted">Run the pipeline to see health metrics.</div>
      </div>
      <div class="grid2">
        <div class="card">
          <h3>Signature Health</h3>
          <div id="healthSigTable" class="muted">Run the pipeline to see health metrics.</div>
        </div>
        <div class="card">
          <h3>Scenario Difficulty Scorecard</h3>
          <div id="healthScenarios" class="muted">Run the pipeline to see health metrics.</div>
        </div>
      </div>
    </section>

  </div>

  <!-- ── Right Trace Drawer ── -->
  <!-- Note: view-toggle is rendered at bottom of page after main-area -->
  <div class="drawer" id="traceDrawer">
    <div class="drawer-collapse-bar" id="drawerCollapseBar">
      <span class="collapse-label">EVENT TRACE</span>
      <span class="collapse-arrow">&#8594;</span>
    </div>
    <div class="drawer-head">
      <div class="drawer-view-toggle" id="drawerViewToggle">
        <button class="active" data-viewmode="all">All</button>
        <button data-viewmode="signal">Signal</button>
        <button data-viewmode="judgment">Judgment</button>
      </div>
      <button class="primary" id="btnWhy" style="font-size:11px;padding:4px 12px">WHY</button>
      <button id="btnCopyTrace" style="font-size:11px;padding:4px 12px">Copy Trace</button>
      <button id="btnCompress" style="font-size:11px;padding:4px 12px">COMPRESS</button>
      <button id="btnCopyCompressed" style="font-size:11px;padding:4px 12px" class="hidden">Copy Compressed</button>
      <div class="decision-card-actions">
        <button id="btnCardMD" style="font-size:10px;padding:3px 10px">Card MD</button>
        <button id="btnCardPNG" style="font-size:10px;padding:3px 10px">Card PNG</button>
      </div>
      <button id="btnCollapseAll" style="font-size:10px;padding:3px 10px" title="Collapse / Expand all sections">▲ Collapse</button>
      <button class="close-btn" id="btnCloseDrawer">✕</button>
    </div>
    <div class="drawer-body" id="drawerBody"></div>
  </div>
</div>

<!-- ═══════════════ VIEW MODE TOGGLE ═══════════════ -->
<div class="view-toggle">
  <button class="vt-soc active" data-mode="soc" aria-label="SOC view mode">SOC</button>
  <button class="vt-gov" data-mode="governance" aria-label="Governance view mode">Governance</button>
</div>

<script>
/* ═══════════════════════════════════════════════════════════════════════
   Deep Sigma EDGE — JRM EDGE v1.0.4
   Single-file JRM pipeline visualizer
   ═══════════════════════════════════════════════════════════════════════ */
"use strict";

/* ── [0] Global Error Guard ────────────────────────────────────────── */
var _lastErr="";
window.onerror=function(msg,src,line,col){
  _lastErr=msg+" ("+src+":"+line+":"+col+")";
  var b=document.getElementById("errBanner");if(b){b.classList.remove("hidden");document.getElementById("errMsg").textContent=msg;document.getElementById("errLoc").textContent=(src||"?")+":"+line+":"+col}
};
window.addEventListener("unhandledrejection",function(e){
  var msg=e.reason?String(e.reason.message||e.reason):"Unhandled promise rejection";
  _lastErr=msg;
  var b=document.getElementById("errBanner");if(b){b.classList.remove("hidden");document.getElementById("errMsg").textContent=msg;document.getElementById("errLoc").textContent="promise"}
});

/* ── Toast Notifications ───────────────────────────────────────────── */
function showToast(msg,type){
  type=type||"info";
  var wrap=document.getElementById("toastWrap");if(!wrap)return;
  var el=document.createElement("div");el.className="toast toast-"+type;el.textContent=msg;
  wrap.appendChild(el);
  setTimeout(function(){if(el.parentNode)el.parentNode.removeChild(el)},3200);
}

/* ── Onboarding ────────────────────────────────────────────────────── */
function showOnboarding(){
  try{if(localStorage.getItem("ds_jrm_edge_onboard")==="dismissed")return}catch(_){}
  var overlay=document.getElementById("onboardOverlay");if(overlay)overlay.style.display="";
}
function dismissOnboarding(){
  var overlay=document.getElementById("onboardOverlay");if(overlay)overlay.style.display="none";
  var cb=document.getElementById("onboardDontShow");
  if(cb&&cb.checked){try{localStorage.setItem("ds_jrm_edge_onboard","dismissed")}catch(_){}}
}

/* ── Seeded RNG (deterministic demo) ───────────────────────────────── */
var _seed=20260228;
function seededRand(){_seed=(_seed*16807+0)%2147483647;return(_seed-1)/2147483646}
function seededUid(p){return p+"-"+Math.floor(seededRand()*0xFFFFFFFF).toString(16).toUpperCase().padStart(8,"0")}

/* ── Utilities ─────────────────────────────────────────────────────── */
function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}
function uid(p){return p+"-"+Math.random().toString(16).slice(2,10).toUpperCase()}
function nowIso(){return new Date().toISOString()}
function sleep(ms){return new Promise(r=>setTimeout(r,ms))}
function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v))}
function storageOk(){try{const k="__ds_t";localStorage.setItem(k,k);localStorage.removeItem(k);return true}catch(_){return false}}
function getStore(k){if(storageOk())return localStorage.getItem(k);window.__mem=window.__mem||{};return window.__mem[k]||null}
function setStore(k,v){if(storageOk())localStorage.setItem(k,v);else{window.__mem=window.__mem||{};window.__mem[k]=v}}
function downloadFile(content,name,mime){const b=new Blob([content],{type:mime});const u=URL.createObjectURL(b);const a=document.createElement("a");a.href=u;a.download=name;a.click();URL.revokeObjectURL(u)}

async function sha256Hex(data){
  const buf=typeof data==="string"?new TextEncoder().encode(data):data;
  const hash=await crypto.subtle.digest("SHA-256",buf);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

function stableStringify(obj){
  if(obj===null||obj===undefined)return JSON.stringify(obj);
  if(typeof obj!=="object")return JSON.stringify(obj);
  if(Array.isArray(obj))return"["+obj.map(v=>stableStringify(v)).join(",")+"]";
  const keys=Object.keys(obj).sort();
  return"{"+keys.map(k=>JSON.stringify(k)+":"+stableStringify(obj[k])).join(",")+"}";
}

/* ── Stages ────────────────────────────────────────────────────────── */
const STAGES=["RAW","PARSE","NORMALIZE","JOIN","TRUTH","REASONING","DRIFT","PATCH","MEMORY"];

/* ── State ─────────────────────────────────────────────────────────── */
const S={
  events:[],
  packets:[],
  selectedIdx:null,
  running:false,
  paused:false,
  stepping:false,
  runIdx:0,
  activeStage:null,
  drawerOpen:false,
  viewMode:"soc",
  compressView:false,
  coherence:{parse:0,join:0,reasoning:0,drift:0,patch:0,total:0},
  cohLastUpdated:null,
  renderedRows:0,
  ROW_CAP:2000,
  // pipeline tracking
  _claimMap:{},
  _sigCounts:{},
  _sigRevs:{},
  _patchCount:0,
  _patchWithLineage:0,
  _joinFails:[],
  _driftDrivers:{},
  // v1.0.4 process proof
  ctaState:{ingest:false,run:false,generate:false,validate:false,replay:false},
  drawerViewMode:"all",
  _dlrCount:0,
  _dsCount:0,
  _tampered:{},
};

/* ── Stage Ribbon ──────────────────────────────────────────────────── */
function buildRibbon(){
  const el=document.getElementById("stageRibbon");
  el.innerHTML=STAGES.map((s,i)=>`<span class="stage-pill" data-stage="${s}">${s}</span>${i<STAGES.length-1?'<span class="stage-arrow">→</span>':''}`).join("");
}
function setStage(name){
  S.activeStage=name;
  document.querySelectorAll(".stage-pill").forEach(p=>{
    const sn=p.dataset.stage;
    const idx=STAGES.indexOf(sn);
    const activeIdx=STAGES.indexOf(name);
    p.classList.toggle("active",sn===name);
    p.classList.toggle("done",idx<activeIdx);
  });
}
function clearStages(){
  S.activeStage=null;
  document.querySelectorAll(".stage-pill").forEach(p=>{p.classList.remove("active","done")});
}

/* ── Coherence Meter ───────────────────────────────────────────────── */
function updateCoherence(processed,total){
  if(total===0)return;
  const parsed=processed;
  let joined=0,reasoned=0,driftChecked=0;
  for(let i=0;i<processed;i++){
    const e=S.events[i];
    if(e._join&&e._join.status!=="failed")joined++;
    if(e._dlr)reasoned++;
    if(e._driftChecked)driftChecked++;
  }
  const c=S.coherence;
  c.parse=Math.round((parsed/total)*100);
  c.join=parsed>0?Math.round((joined/parsed)*100):0;
  c.reasoning=total>0?Math.round((reasoned/total)*100):0;
  c.drift=total>0?Math.round((driftChecked/total)*100):0;
  c.patch=S._patchCount>0?Math.round((S._patchWithLineage/S._patchCount)*100):100;
  c.total=Math.round((c.parse+c.join+c.reasoning+c.drift+c.patch)/5);
  S.cohLastUpdated=new Date();
  renderMeter();
}
function renderMeter(){
  const c=S.coherence;
  const cls=c.total>=75?"green":c.total>=50?"yellow":"red";
  const m=document.getElementById("meterMain");
  m.textContent=c.total;m.className="meter-ring "+cls;m.setAttribute("aria-valuenow",c.total);
  const bm=document.getElementById("bigMeter");
  if(bm){bm.textContent=c.total;bm.className="big-meter "+cls}
  document.getElementById("subParse").textContent=c.parse;
  document.getElementById("subJoin").textContent=c.join;
  document.getElementById("subReason").textContent=c.reasoning;
  document.getElementById("subDrift").textContent=c.drift;
  document.getElementById("subPatch").textContent=c.patch;
  var upd=document.getElementById("subUpdated");
  if(upd&&S.cohLastUpdated){var d=S.cohLastUpdated;upd.textContent=String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0")+":"+String(d.getSeconds()).padStart(2,"0")}
  renderCohTab();renderHealthTab();
}

/* ── Tab Switching ─────────────────────────────────────────────────── */
function setTab(name){
  ["ingest","run","trace","packets","coherence","health"].forEach(t=>{
    const el=document.getElementById("tab-"+t);
    if(el)el.classList.toggle("hidden",t!==name);
  });
  document.querySelectorAll(".ttab").forEach(b=>b.classList.toggle("active",b.dataset.tab===name));
  try{location.hash="#"+name}catch(_){}
}

/* ── Adapters (browser-side) ───────────────────────────────────────── */
function hashRaw(raw){
  // Sync hash for display (real sha256 async done separately)
  let h=0;for(let i=0;i<raw.length;i++){h=((h<<5)-h)+raw.charCodeAt(i);h|=0}
  return "sha256:"+Math.abs(h).toString(16).padStart(16,"0");
}

function parseEVE(text){
  const events=[];
  text.split("\n").forEach((line,i)=>{
    line=line.trim();if(!line)return;
    try{
      const j=JSON.parse(line);
      const et=j.event_type||"generic";
      const typeMap={alert:"suricata_alert",dns:"suricata_dns",http:"suricata_http",flow:"suricata_flow",tls:"suricata_flow",fileinfo:"suricata_flow"};
      const severity=j.alert?{1:"critical",2:"high",3:"medium",4:"low"}[j.alert.severity]||"info":"info";
      const sig=j.alert?j.alert.signature_id:null;
      const rev=j.alert?j.alert.rev:null;
      const action=j.alert?j.alert.signature:(j.dns?`DNS ${j.dns.rrname||""}`:j.http?`${j.http.http_method||"GET"} ${j.http.url||"/"}`:et);
      events.push({
        event_id:uid("EVT"),source_system:"suricata",event_type:typeMap[et]||"generic",
        timestamp:j.timestamp||nowIso(),severity,
        actor:{ip:j.src_ip||"",port:j.src_port||0},
        object:{ip:j.dest_ip||"",port:j.dest_port||0},
        action,confidence:j.alert?clamp(1-(j.alert.severity||3)*0.15,0.2,0.99):0.7,
        evidence_hash:hashRaw(line),raw_pointer:`line:${i+1}`,environment_id:"",
        assumptions:[],raw_line:line,
        metadata:{signature_id:sig,rev,flow_id:j.flow_id,proto:j.proto,
          gid:j.alert?j.alert.gid:null,category:j.alert?j.alert.category:null,
          dns:j.dns||null,http:j.http||null,tls:j.tls||null,fileinfo:j.fileinfo||null},
        _scenario:j._scenario||null
      });
    }catch(_){
      events.push({
        event_id:uid("EVT"),source_system:"suricata",event_type:"malformed",
        timestamp:nowIso(),severity:"low",actor:{},object:{},action:"MALFORMED",
        confidence:0,evidence_hash:hashRaw(line),raw_pointer:`line:${i+1}`,
        environment_id:"",assumptions:[],raw_line:line,metadata:{}
      });
    }
  });
  return events;
}

function parseSnort(text){
  const events=[];
  const rx=/^(\d{2}\/\d{2}-[\d:.]+)\s+\[\*\*\]\s+\[(\d+):(\d+):(\d+)\]\s+(.*?)\s+\[\*\*\]\s+\[Classification:\s*(.*?)\]\s+\[Priority:\s*(\d+)\]\s+\{(\w+)\}\s+(\S+)\s+->\s+(\S+)/;
  text.split("\n").forEach((line,i)=>{
    line=line.trim();if(!line)return;
    const m=line.match(rx);
    if(m){
      const sevMap={1:"critical",2:"high",3:"medium",4:"low"};
      const [,ts,gid,sid,rev,msg,cls,pri,proto,src,dst]=m;
      events.push({
        event_id:uid("EVT"),source_system:"snort",event_type:"snort_alert",
        timestamp:`2026-${ts.replace("-","T")}`,severity:sevMap[pri]||"info",
        actor:{addr:src},object:{addr:dst},action:msg,
        confidence:clamp(1-Number(pri)*0.15,0.2,0.99),
        evidence_hash:hashRaw(line),raw_pointer:`line:${i+1}`,environment_id:"",
        assumptions:[],raw_line:line,
        metadata:{gid:Number(gid),signature_id:Number(sid),rev:Number(rev),classification:cls,proto}
      });
    }else{
      events.push({
        event_id:uid("EVT"),source_system:"snort",event_type:"malformed",
        timestamp:nowIso(),severity:"low",actor:{},object:{},action:"MALFORMED",
        confidence:0,evidence_hash:hashRaw(line),raw_pointer:`line:${i+1}`,
        environment_id:"",assumptions:[],raw_line:line,metadata:{}
      });
    }
  });
  return events;
}

function parseCopilot(text){
  const events=[];
  const typeMap={prompt:"agent_prompt",tool_call:"agent_tool_call",response:"agent_response",guardrail:"agent_guardrail"};
  text.split("\n").forEach((line,i)=>{
    line=line.trim();if(!line)return;
    try{
      const j=JSON.parse(line);
      events.push({
        event_id:uid("EVT"),source_system:"copilot",event_type:typeMap[j.type]||"generic",
        timestamp:j.timestamp||nowIso(),
        severity:j.guardrail_flags?"high":(j.confidence>=0.8?"low":"medium"),
        actor:{agent:j.agent_id||"unknown"},
        object:{target:j.target||""},
        action:j.type==="prompt"?j.prompt||j.type:j.type==="tool_call"?(j.tool_calls||[]).map(t=>t.name).join(",")||"tool_call":j.type==="response"?(j.response||"").slice(0,80):j.type,
        confidence:j.confidence||0.5,
        evidence_hash:hashRaw(line),raw_pointer:`line:${i+1}`,environment_id:"",
        assumptions:[],raw_line:line,
        metadata:{guardrail_flags:j.guardrail_flags||[],model:j.model||null,agent_id:j.agent_id},
        _scenario:j._scenario||null
      });
    }catch(_){
      events.push({
        event_id:uid("EVT"),source_system:"copilot",event_type:"malformed",
        timestamp:nowIso(),severity:"low",actor:{},object:{},action:"MALFORMED",
        confidence:0,evidence_hash:hashRaw(line),raw_pointer:`line:${i+1}`,
        environment_id:"",assumptions:[],raw_line:line,metadata:{}
      });
    }
  });
  return events;
}

function parseAuto(text){
  const trimmed=text.trim();
  if(!trimmed)return [];
  // Detect format
  const firstLine=trimmed.split("\n")[0].trim();
  if(firstLine.startsWith("{")){
    try{
      const j=JSON.parse(firstLine);
      if(j.event_type)return parseEVE(text);
      if(j.type&&(j.agent_id||j.prompt||j.tool_calls))return parseCopilot(text);
      return parseEVE(text);// default to EVE for JSON
    }catch(_){}
  }
  if(/^\d{2}\/\d{2}-/.test(firstLine))return parseSnort(text);
  return parseEVE(text);// fallback
}

/* ── Minimal Zip Parser ────────────────────────────────────────────── */
function parseZip(buf){
  const view=new DataView(buf);
  const u8=new Uint8Array(buf);
  const files=new Map();
  // Find end of central directory
  let eocdOff=-1;
  for(let i=u8.length-22;i>=0;i--){
    if(view.getUint32(i,true)===0x06054b50){eocdOff=i;break}
  }
  if(eocdOff<0)throw new Error("Not a valid zip file");
  const cdOff=view.getUint32(eocdOff+16,true);
  const cdCount=view.getUint16(eocdOff+10,true);
  let pos=cdOff;
  for(let i=0;i<cdCount;i++){
    if(view.getUint32(pos,true)!==0x02014b50)break;
    const method=view.getUint16(pos+10,true);
    const compSize=view.getUint32(pos+20,true);
    const uncompSize=view.getUint32(pos+24,true);
    const nameLen=view.getUint16(pos+28,true);
    const extraLen=view.getUint16(pos+30,true);
    const commentLen=view.getUint16(pos+32,true);
    const localOff=view.getUint32(pos+42,true);
    const name=new TextDecoder().decode(u8.slice(pos+46,pos+46+nameLen));
    pos+=46+nameLen+extraLen+commentLen;
    // Read local file header to find data offset
    const lNameLen=view.getUint16(localOff+26,true);
    const lExtraLen=view.getUint16(localOff+28,true);
    const dataOff=localOff+30+lNameLen+lExtraLen;
    const compressed=u8.slice(dataOff,dataOff+compSize);
    if(method===0){
      files.set(name,compressed);
    }else if(method===8){
      // DEFLATE — use DecompressionStream if available
      files.set(name,{compressed,uncompSize,method:8});
    }else{
      files.set(name,compressed);// best effort
    }
  }
  return files;
}

async function inflateData(entry){
  if(entry instanceof Uint8Array)return entry;
  if(!entry.compressed)return new Uint8Array(0);
  // Try DecompressionStream (supported in modern browsers)
  if(typeof DecompressionStream!=="undefined"){
    try{
      // Add zlib header for raw deflate
      const header=new Uint8Array([0x78,0x01]);
      const combined=new Uint8Array(header.length+entry.compressed.length);
      combined.set(header);combined.set(entry.compressed,header.length);
      const ds=new DecompressionStream("deflate");
      const writer=ds.writable.getWriter();
      writer.write(combined);writer.close();
      const reader=ds.readable.getReader();
      const chunks=[];let total=0;
      while(true){
        const{done,value}=await reader.read();
        if(done)break;
        chunks.push(value);total+=value.length;
      }
      const result=new Uint8Array(total);let off=0;
      for(const c of chunks){result.set(c,off);off+=c.length}
      return result;
    }catch(e){
      // Fallback: try raw deflate
      try{
        const ds=new DecompressionStream("raw");
        const writer=ds.writable.getWriter();
        writer.write(entry.compressed);writer.close();
        const reader=ds.readable.getReader();
        const chunks=[];let total=0;
        while(true){
          const{done,value}=await reader.read();
          if(done)break;
          chunks.push(value);total+=value.length;
        }
        const result=new Uint8Array(total);let off=0;
        for(const c of chunks){result.set(c,off);off+=c.length}
        return result;
      }catch(_){
        return entry.compressed;// give up, return raw
      }
    }
  }
  return entry.compressed;// no DecompressionStream
}

async function loadZipPacket(buf){
  const rawFiles=parseZip(buf);
  const files={};
  for(const[name,data]of rawFiles){
    if(name.endsWith("/"))continue;// skip directories
    const basename=name.split("/").pop();
    const inflated=await inflateData(data);
    files[basename]=new TextDecoder().decode(inflated);
  }
  // Parse manifest
  let manifest=null;
  try{manifest=JSON.parse(files["manifest.json"]||"{}")}catch(_){}
  return{
    name:manifest?manifest.packetName||manifest.packet_name||"Unknown":"Unknown",
    env:manifest?manifest.environmentId||manifest.environment_id||"?":"?",
    window_start:manifest?manifest.windowStart||manifest.window_start||"":"",
    window_end:manifest?manifest.windowEnd||manifest.window_end||"":"",
    event_count:manifest?manifest.eventCount||manifest.event_count||0:0,
    part:manifest?manifest.part||1:1,
    files,manifest
  };
}

/* ── Pipeline Simulation ───────────────────────────────────────────── */
function getSpeed(){return 101-Number(document.getElementById("speedSlider").value)}

function classifyLane(evt){
  const s=evt.severity;const c=evt.confidence;
  if((s==="critical"||s==="high")&&c>=0.8)return"REQUIRE_REVIEW";
  if(s==="high"&&c<0.8)return"QUEUE_PATCH";
  if(s==="medium")return"NOTIFY";
  return"LOG_ONLY";
}

function buildClaim(evt){
  const key=(evt.source_system||"?")+":"+(evt.metadata.signature_id||evt.action||"?");
  if(!S._claimMap[key]){
    S._claimMap[key]={claim_id:uid("CLM"),statement:`Claim for ${key}`,confidence:evt.confidence,evidence_refs:[evt.evidence_hash],source_events:[evt.event_id],assumptions:[]};
  }else{
    const cl=S._claimMap[key];
    cl.evidence_refs.push(evt.evidence_hash);
    cl.source_events.push(evt.event_id);
    cl.confidence=(cl.confidence+evt.confidence)/2;
  }
  return S._claimMap[key];
}

function computeJoin(evt){
  const sig=evt.metadata.signature_id||evt.metadata.sid;
  if(sig)return{signature_id:sig,rev:evt.metadata.rev||"?",status:"joined"};
  if(evt.event_type==="malformed")return{status:"failed",reason:"malformed"};
  if(evt.action&&evt.action!=="MALFORMED")return{action:evt.action,status:"joined"};
  S._joinFails.push(evt.event_type);
  return{status:"failed",reason:"no mapping key"};
}

function detectDrift(evt,idx){
  evt._driftChecked=true;
  const sig=evt.metadata.signature_id||evt.metadata.sid;
  const drifts=[];
  if(sig){
    S._sigCounts[sig]=(S._sigCounts[sig]||0)+1;
    if(!S._sigRevs[sig])S._sigRevs[sig]=new Set();
    if(evt.metadata.rev)S._sigRevs[sig].add(String(evt.metadata.rev));
    // FP_SPIKE
    if(S._sigCounts[sig]>=5){
      // Check avg confidence for this sig
      let sum=0,cnt=0;
      for(let i=0;i<=idx;i++){
        const e=S.events[i];
        if((e.metadata.signature_id||e.metadata.sid)===sig){sum+=e.confidence;cnt++}
      }
      if(cnt>0&&(sum/cnt)<0.7){
        drifts.push({drift_id:uid("DS"),drift_type:"FP_SPIKE",severity:"medium",
          notes:`Sig ${sig} fired ${cnt}x, avg conf ${(sum/cnt).toFixed(2)}`,
          fingerprint:{signature_id:String(sig),count:String(cnt)}});
        S._driftDrivers[sig]=(S._driftDrivers[sig]||0)+1;
      }
    }
    // STALE_LOGIC
    if(S._sigRevs[sig]&&S._sigRevs[sig].size>1){
      drifts.push({drift_id:uid("DS"),drift_type:"STALE_LOGIC",severity:"medium",
        notes:`Sig ${sig} has conflicting revs: ${[...S._sigRevs[sig]].sort().join(",")}`,
        fingerprint:{signature_id:String(sig),revisions:[...S._sigRevs[sig]].sort().join(",")}});
      S._driftDrivers[sig]=(S._driftDrivers[sig]||0)+1;
    }
  }
  // MISSING_MAPPING
  if(evt._join&&evt._join.status==="failed"){
    drifts.push({drift_id:uid("DS"),drift_type:"MISSING_MAPPING",severity:"low",
      notes:`Event type ${evt.event_type} has no claim mapping`,
      fingerprint:{event_type:evt.event_type}});
  }
  return drifts;
}

function buildPatch(evt){
  if(!evt._drift||evt._drift.length===0)return null;
  S._patchCount++;
  S._patchWithLineage++;
  const d=evt._drift[0];
  return{patch_id:uid("PATCH"),drift_id:d.drift_id,rev:S._patchCount,previous_rev:Math.max(0,S._patchCount-1),
    changes:[{type:"threshold_adjust",target:d.fingerprint}],lineage:[]};
}

function updateMemory(evt){
  // Simple tracking
  return{nodes_added:1,edges_added:evt._claim?1:0};
}

async function runPipeline(){
  S.running=true;S.paused=false;
  document.getElementById("runStatus").textContent="Running";
  document.getElementById("runEmpty").classList.add("hidden");
  var rowHint=document.getElementById("rowHint");if(rowHint)rowHint.style.display="";
  var pBar=document.getElementById("progressBar");if(pBar)pBar.style.width="0%";

  for(let i=S.runIdx;i<S.events.length;i++){
    if(!S.running)break;
    while(S.paused&&!S.stepping){await sleep(50)}
    if(S.stepping)S.stepping=false;
    if(!S.running)break;

    const evt=S.events[i];
    const delay=getSpeed();

    const ss={};var _t0;
    _t0=Date.now(); setStage("RAW"); ss.RAW={ok:true,t:_t0,reason:null}; await sleep(Math.max(1,delay/9));
    _t0=Date.now(); setStage("PARSE"); evt._parsed=true; var _pOk=evt.event_type!=="malformed"; ss.PARSE={ok:_pOk,t:_t0,reason:_pOk?null:"malformed event"}; await sleep(Math.max(1,delay/9));
    _t0=Date.now(); setStage("NORMALIZE"); evt._normalized=true; ss.NORMALIZE={ok:ss.PARSE.ok,t:_t0,reason:ss.PARSE.ok?null:"skipped (parse failed)"}; await sleep(Math.max(1,delay/9));
    _t0=Date.now(); setStage("JOIN"); evt._join=computeJoin(evt); var _jOk=evt._join.status!=="failed"; ss.JOIN={ok:_jOk,t:_t0,reason:_jOk?null:"join failed"}; await sleep(Math.max(1,delay/9));
    _t0=Date.now(); setStage("TRUTH"); evt._claim=buildClaim(evt); ss.TRUTH={ok:!!evt._claim,t:_t0,reason:evt._claim?null:"no claim built"}; await sleep(Math.max(1,delay/9));
    _t0=Date.now(); setStage("REASONING"); evt._dlr={lane:classifyLane(evt),why:[
      `Severity=${evt.severity}, confidence=${evt.confidence.toFixed(2)} → ${classifyLane(evt)}`,
      ...(evt.metadata.signature_id?[`Matched signature ${evt.metadata.signature_id} rev ${evt.metadata.rev||"?"}`]:[]),
      ...(evt.metadata.guardrail_flags&&evt.metadata.guardrail_flags.length?[`Guardrail flags: ${evt.metadata.guardrail_flags.join(", ")}`]:[])
    ]}; ss.REASONING={ok:true,t:_t0,reason:null}; await sleep(Math.max(1,delay/9));
    _t0=Date.now(); setStage("DRIFT"); evt._drift=detectDrift(evt,i); ss.DRIFT={ok:true,t:_t0,reason:null}; await sleep(Math.max(1,delay/9));
    _t0=Date.now(); setStage("PATCH"); evt._patch=buildPatch(evt); ss.PATCH={ok:!!evt._patch,t:_t0,reason:evt._patch?null:"no drift to patch"}; await sleep(Math.max(1,delay/9));
    _t0=Date.now(); setStage("MEMORY"); evt._mg=updateMemory(evt); ss.MEMORY={ok:true,t:_t0,reason:null}; await sleep(Math.max(1,delay/9));
    evt._stageStatus=ss;
    // Drift heat scale: 0=none, 1=mild, 3=drift emitted (DS exists), 5=requires review or SEV-1
    evt._driftScore=(function(){if(!evt._drift||evt._drift.length===0)return 0;var hc=evt._drift.some(function(d){return d&&d.severity==="critical"});var hr=evt._dlr&&evt._dlr.lane==="REQUIRE_REVIEW";if(hc||hr)return 5;var hh=evt._drift.some(function(d){return d&&d.severity==="high"});if(hh||evt._drift.length>=2)return 3;return 1})();

    S._dlrCount++;
    if(evt._drift&&evt._drift.length>0)S._dsCount+=evt._drift.length;
    appendEventRow(evt,i);
    updateCoherence(i+1,S.events.length);
    S.runIdx=i+1;
    document.getElementById("runProgress").textContent=`${i+1} / ${S.events.length}`;
    var _pct=Math.round(((i+1)/S.events.length)*100);
    var _pb=document.getElementById("progressBar");if(_pb)_pb.style.width=_pct+"%";
    updateLiveCounters();
  }

  S.running=false;
  clearStages();
  var _pbDone=document.getElementById("progressBar");if(_pbDone)_pbDone.style.width=S.runIdx>=S.events.length?"100%":"0%";
  document.getElementById("runStatus").textContent=S.runIdx>=S.events.length?"Complete":"Stopped";
  updateCtaState();updateLiveCounters();
  if(S.runIdx>=S.events.length){showToast("Pipeline complete \u2014 "+S.events.length+" events processed","ok");renderHealthTab()}
}

/* ── Event Table Rendering ─────────────────────────────────────────── */
function appendEventRow(evt,idx){
  S.renderedRows++;
  if(S.renderedRows>S.ROW_CAP){
    var wrap=document.getElementById("loadMoreWrap");if(wrap)wrap.classList.remove("hidden");
    var msg=document.getElementById("loadMoreMsg");if(msg)msg.textContent="Showing "+S.ROW_CAP+" of "+S.renderedRows+" events";
    return;
  }
  _renderRow(evt,idx);
}
function _renderRow(evt,idx){
  const body=document.getElementById("eventBody");
  const tr=document.createElement("tr");
  tr.dataset.idx=idx;
  const lane=evt._dlr?evt._dlr.lane:"";
  const hasDrift=evt._drift&&evt._drift.length>0;
  const sig=evt.metadata.signature_id||evt.metadata.sid||evt.action||"-";
  const heat=evt._driftScore||0;
  var scenMap={FP_SPIKE:"medium",STALE_LOGIC:"medium",LATERAL:"hard",DNS_EXFIL:"hard",MULTI_PROTO:"hard",CRITICAL:"high",AGENTIC:"high",BENIGN:"low",CHAOS:"high",EDGE:"expert",TISSUE:"medium"};
  var scenBadge=evt._scenario?`<span class="scenario-badge scen-${scenMap[evt._scenario]||"medium"}">${esc(evt._scenario)}</span>`:"";
  tr.innerHTML=`<td>${idx+1}</td><td class="mono small">${esc((evt.timestamp||"").slice(11,19))}</td><td>${esc(evt.source_system)}</td><td><span class="badge sev-${evt.severity==="info"?"info":evt.severity}">${esc(evt.event_type)}</span></td><td class="mono small">${esc(String(sig).slice(0,30))}</td><td><span class="badge sev-${evt.severity}">${esc(evt.severity)}</span></td><td>${lane?`<span class="badge lane-${lane}">${lane}</span>`:""}</td><td>${hasDrift?evt._drift.map(d=>`<span class="badge drift-badge">${esc(d.drift_type)}</span>`).join(" "):""}</td><td><span class="drift-heat drift-heat-${heat}">${heat}</span></td><td>${scenBadge}</td><td class="muted">${evt._packetPart||"-"}</td>`;
  tr.addEventListener("click",()=>selectEvent(idx));
  body.appendChild(tr);
  applyRowFilter(tr,evt);
}
function loadMoreRows(){
  var newCap=Math.min(S.renderedRows,S.ROW_CAP+2000);
  for(var i=S.ROW_CAP;i<newCap&&i<S.events.length;i++){
    var evt=S.events[i];if(evt&&evt._stageStatus)_renderRow(evt,i);
  }
  S.ROW_CAP=newCap;
  if(newCap>=S.renderedRows){document.getElementById("loadMoreWrap").classList.add("hidden")}
  else{document.getElementById("loadMoreMsg").textContent="Showing "+newCap+" of "+S.renderedRows+" events"}
}

function selectEvent(idx){
  if(idx<0||idx>=S.events.length)return;
  S.selectedIdx=idx;
  document.querySelectorAll("#eventBody tr").forEach(r=>{
    r.classList.toggle("selected",Number(r.dataset.idx)===idx);
  });
  openDrawer(idx);
}

/* ── Filters ───────────────────────────────────────────────────────── */
function applyFilters(){
  const rows=document.querySelectorAll("#eventBody tr");
  rows.forEach(tr=>{
    const idx=Number(tr.dataset.idx);
    const evt=S.events[idx];
    if(evt)applyRowFilter(tr,evt);
  });
}
function applyRowFilter(tr,evt){
  const fSev=document.getElementById("fSev").value;
  const fLane=document.getElementById("fLane").value;
  const fDrift=document.getElementById("fDrift").checked;
  const fSearch=document.getElementById("fSearch").value.toLowerCase();
  let show=true;
  if(fSev&&evt.severity!==fSev)show=false;
  if(fLane&&(!evt._dlr||evt._dlr.lane!==fLane))show=false;
  if(fDrift&&(!evt._drift||evt._drift.length===0))show=false;
  if(fSearch){
    const hay=(evt.event_type+evt.action+evt.source_system+(evt.metadata.signature_id||"")).toLowerCase();
    if(!hay.includes(fSearch))show=false;
  }
  tr.style.display=show?"":"none";
}

/* ── Trace Drawer ──────────────────────────────────────────────────── */
function openDrawer(idx){
  const evt=S.events[idx];
  if(!evt)return;
  S.drawerOpen=true;
  const d=document.getElementById("traceDrawer");
  d.classList.add("open");
  if(S.compressView)renderCompressView(evt);
  else renderDrawerContent(evt,idx);
  applyDrawerViewMode();
  renderFullTrace(evt,idx);
}
function closeDrawer(){
  S.drawerOpen=false;
  document.getElementById("traceDrawer").classList.remove("open");
}

function renderDrawerContent(evt,idx){
  const body=document.getElementById("drawerBody");
  const sections=[
    {title:"1. Event Summary",content:renderSummarySection(evt)},
    {title:"2. RAW",content:renderRawSection(evt)},
    {title:"3. PARSED / NORMALIZED",content:renderParsedSection(evt)},
    {title:"4. JOIN",content:renderJoinSection(evt)},
    {title:"5. TRUTH",content:renderTruthSection(evt)},
    {title:"6. REASONING",id:"sec-reasoning",content:renderReasoningSection(evt)},
    {title:"7. DRIFT",content:renderDriftSection(evt)},
    {title:"8. PATCH",content:renderPatchSection(evt)},
    {title:"9. MEMORY",content:renderMemorySection(evt)},
  ];
  body.innerHTML=sections.map(s=>`<div class="dsection"${s.id?' id="'+s.id+'"':''}><div class="dsection-hdr"><span class="arrow">▾</span> ${s.title}</div><div class="dsection-body">${s.content}</div></div>`).join("");
}

function renderSummarySection(evt){
  const lane=evt._dlr?evt._dlr.lane:"—";
  const drifts=evt._drift||[];
  return `<table class="kv-table">
    <tr><td>Event ID</td><td class="mono small">${esc(evt.event_id)}</td></tr>
    <tr><td>Timestamp</td><td class="mono small">${esc(evt.timestamp)}</td></tr>
    <tr><td>Source</td><td>${esc(evt.source_system)}</td></tr>
    <tr><td>Type</td><td><span class="badge sev-${evt.severity}">${esc(evt.event_type)}</span></td></tr>
    <tr><td>Severity</td><td><span class="badge sev-${evt.severity}">${esc(evt.severity)}</span></td></tr>
    <tr><td>Confidence</td><td>${evt.confidence.toFixed(2)}</td></tr>
    <tr><td>Lane</td><td>${lane!=="—"?`<span class="badge lane-${lane}">${lane}</span>`:lane}</td></tr>
    <tr><td>Drift</td><td>${drifts.length?drifts.map(d=>`<span class="badge drift-badge">${esc(d.drift_type)}</span>`).join(" "):"None"}</td></tr>
    ${evt._stageStatus?'<tr><td>Stages</td><td><div class="stage-status-row">'+STAGES.map(function(s){var st=evt._stageStatus[s];var isObj=st&&typeof st==="object";var ok=isObj?st.ok:(st==="pass");var cls=ok?"pass":(isObj&&st.ok===false||st==="fail")?"fail":"skip";var sym=ok?"\u2714":(cls==="fail")?"\u2716":"\u25CB";var tip=s+": "+(isObj?(ok?"ok":"fail"+(st.reason?" \u2014 "+st.reason:"")):(st||"pending"));if(isObj&&st.t)tip+=" @ "+new Date(st.t).toLocaleTimeString();return '<span class="stage-marker '+cls+'" title="'+tip+'">'+sym+"</span>"}).join("")+"</div></td></tr>":""}
    ${evt._driftScore!==undefined?'<tr><td>Drift Heat</td><td><span class="drift-heat drift-heat-'+evt._driftScore+'">'+evt._driftScore+"</span> / 5</td></tr>":""}
  </table>`;
}

function renderRawSection(evt){
  return `<div class="mono small muted" style="margin-bottom:4px">Evidence: ${esc(evt.evidence_hash)}</div>
  <pre class="mono">${esc(evt.raw_line||"(no raw data)")}</pre>`;
}

function renderParsedSection(evt){
  const rows=[
    ["actor",JSON.stringify(evt.actor)],
    ["object",JSON.stringify(evt.object)],
    ["action",evt.action],
    ["event_type",evt.event_type],
    ["severity",evt.severity],
    ["confidence",evt.confidence.toFixed(2)],
  ];
  if(evt.metadata.signature_id)rows.push(["signature_id",evt.metadata.signature_id]);
  if(evt.metadata.rev)rows.push(["rev",evt.metadata.rev]);
  if(evt.metadata.proto)rows.push(["proto",evt.metadata.proto]);
  if(evt.metadata.classification)rows.push(["classification",evt.metadata.classification]);
  if(evt.metadata.guardrail_flags&&evt.metadata.guardrail_flags.length)rows.push(["guardrail_flags",evt.metadata.guardrail_flags.join(", ")]);
  return `<table class="kv-table">${rows.map(([k,v])=>`<tr><td>${esc(k)}</td><td class="mono small">${esc(String(v))}</td></tr>`).join("")}</table>`;
}

function renderJoinSection(evt){
  const j=evt._join;
  if(!j)return '<span class="muted">Not yet processed</span>';
  const rows=[["status",j.status]];
  if(j.signature_id)rows.push(["signature_id",j.signature_id]);
  if(j.rev)rows.push(["rev",j.rev]);
  if(j.action)rows.push(["action",j.action]);
  if(j.reason)rows.push(["reason",j.reason]);
  return `<table class="kv-table">${rows.map(([k,v])=>`<tr><td>${esc(k)}</td><td class="mono small">${esc(String(v))}</td></tr>`).join("")}</table>`;
}

function renderTruthSection(evt){
  const c=evt._claim;
  if(!c)return '<span class="muted">Not yet processed</span>';
  return `<table class="kv-table">
    <tr><td>Claim ID</td><td class="mono small">${esc(c.claim_id)}</td></tr>
    <tr><td>Statement</td><td>${esc(c.statement)}</td></tr>
    <tr><td>Confidence</td><td>${c.confidence.toFixed(2)}</td></tr>
    <tr><td>Evidence</td><td class="mono small">${esc(c.evidence_refs.slice(-3).join(", "))}</td></tr>
    <tr><td>Source Events</td><td>${c.source_events.length}</td></tr>
  </table>`;
}

function renderReasoningSection(evt){
  const dlr=evt._dlr;
  if(!dlr)return '<span class="muted">Not yet processed</span>';
  var dlrId=hashRaw((evt.event_id||"")+"|"+dlr.lane+"|"+(dlr.why[0]||"")).toString(16).slice(0,10);
  return `<div style="margin-bottom:6px"><span class="badge lane-${dlr.lane}">${dlr.lane}</span><span class="linkage-id">DLR:${dlrId}</span></div>
  <div style="font-size:12px;font-weight:600;margin-bottom:4px">Why Bullets:</div>
  <ul style="margin:0;padding-left:18px">${dlr.why.map(w=>`<li style="margin-bottom:3px">${esc(w)}</li>`).join("")}</ul>
  <div class="muted small" style="margin-top:4px">Event: ${esc(evt.event_id||"N/A")}</div>
  ${evt.assumptions&&evt.assumptions.length?`<div class="muted small" style="margin-top:6px">Assumptions: ${esc(evt.assumptions.join("; "))}</div>`:""}`;
}

function renderDriftSection(evt){
  const drifts=evt._drift;
  if(!drifts||drifts.length===0)return '<span class="muted">No drift detected</span>';
  var sigKey=(evt.metadata&&evt.metadata.signature_id||"unknown")+":"+(evt.metadata&&evt.metadata.rev||0);
  return drifts.map(function(d){
    var dsId=hashRaw(sigKey+"|"+d.drift_type+"|"+(d.drift_id||"")).toString(16).slice(0,10);
    return `<div class="card" style="margin-bottom:6px;padding:8px">
    <div><span class="badge drift-badge">${esc(d.drift_type)}</span> <span class="badge sev-${d.severity}">${esc(d.severity)}</span><span class="linkage-id">DS:${dsId}</span></div>
    <div class="muted small" style="margin-top:4px">${esc(d.notes)}</div>
    <div class="mono small muted" style="margin-top:2px">ID: ${esc(d.drift_id)} | Sig: ${esc(sigKey)}</div>
  </div>`}).join("");
}

function renderPatchSection(evt){
  const p=evt._patch;
  if(!p)return '<span class="muted">No patch generated</span>';
  return `<table class="kv-table">
    <tr><td>Patch ID</td><td class="mono small">${esc(p.patch_id)}</td></tr>
    <tr><td>Drift ID</td><td class="mono small">${esc(p.drift_id)}</td></tr>
    <tr><td>Rev</td><td>${p.rev}</td></tr>
    <tr><td>Previous Rev</td><td>${p.previous_rev}</td></tr>
    <tr><td>Changes</td><td class="mono small">${esc(JSON.stringify(p.changes))}</td></tr>
  </table>`;
}

function renderMemorySection(evt){
  const mg=evt._mg;
  if(!mg)return '<span class="muted">Not yet processed</span>';
  const sig=evt.metadata.signature_id||evt.metadata.sid;
  const claim=evt._claim;
  var cePosture=claim?"confidence="+claim.confidence.toFixed(2)+", events="+claim.source_events.length:"None linked";
  return `<table class="kv-table">
    <tr><td>Nodes Added</td><td>${mg.nodes_added}</td></tr>
    <tr><td>Edges Added</td><td>${mg.edges_added}</td></tr>
    ${sig?`<tr><td>Signature</td><td class="mono small">${sig}</td></tr>`:""}
    <tr><td>CE Posture</td><td>${esc(cePosture)}</td></tr>
  </table>`;
}

/* ── Signal vs Judgment Toggle ─────────────────────────────────────── */
function setDrawerViewMode(mode){
  S.drawerViewMode=mode;
  document.querySelectorAll("#drawerViewToggle button").forEach(function(b){b.classList.toggle("active",b.dataset.viewmode===mode)});
  applyDrawerViewMode();
}
function applyDrawerViewMode(){
  var sections=document.querySelectorAll("#drawerBody .dsection");
  sections.forEach(function(sec,i){
    if(i===0){sec.style.display="";return} // Summary always visible
    if(S.drawerViewMode==="signal"){sec.style.display=i<=3?"":"none"} // sections 2,3,4 = RAW, PARSED, JOIN
    else if(S.drawerViewMode==="judgment"){sec.style.display=i>=4?"":"none"} // sections 5-9 = TRUTH through MEMORY
    else{sec.style.display=""} // all
  });
}

/* ── Decision Card Export ──────────────────────────────────────────── */
function copyDecisionCardMD(){
  if(S.selectedIdx===null){showToast("Select an event first","warn");return}
  var evt=S.events[S.selectedIdx];if(!evt)return;
  var lane=evt._dlr?evt._dlr.lane:"N/A";
  var driftTypes=evt._drift&&evt._drift.length?evt._drift.map(function(d){return d.drift_type}).join(", "):"none";
  var claimId=evt._claim?evt._claim.claim_id:"N/A";
  var posture=evt._claim?"confidence="+evt._claim.confidence.toFixed(2):"N/A";
  var md="## Decision Card: "+evt.event_id+"\n\n"+
    "- **RAW:** "+((evt.raw_line||"").slice(0,120))+"\n"+
    "- **JUDGMENT:** "+lane+" | drift="+driftTypes+" | confidence="+evt.confidence.toFixed(2)+"\n"+
    "- **CANON:** "+claimId+" | posture="+posture+"\n\n"+
    "`SHA-256: "+evt.evidence_hash+"`\n\n"+
    "_Generated "+new Date().toISOString()+" by EDGE JRM v1.0.4_\n";
  navigator.clipboard.writeText(md).then(function(){showToast("Decision card copied to clipboard","ok")}).catch(function(){showToast("Copy failed","warn")});
}
function downloadDecisionCardPNG(){
  if(S.selectedIdx===null){showToast("Select an event first","warn");return}
  var evt=S.events[S.selectedIdx];if(!evt)return;
  var c=document.createElement("canvas");c.width=400;c.height=300;
  var ctx=c.getContext("2d");
  // Dark background
  ctx.fillStyle="#0b0f14";ctx.fillRect(0,0,400,300);
  // Border
  ctx.strokeStyle="#7df9ff";ctx.lineWidth=1;ctx.strokeRect(4,4,392,292);
  // Title
  ctx.fillStyle="#7df9ff";ctx.font="bold 14px monospace";ctx.fillText("Decision Card",16,30);
  // Event ID
  ctx.fillStyle="#e1e8f0";ctx.font="11px monospace";ctx.fillText("Event: "+(evt.event_id||"").slice(0,40),16,52);
  // Lane
  var lane=evt._dlr?evt._dlr.lane:"N/A";
  ctx.fillText("Lane: "+lane,16,72);
  // Confidence
  ctx.fillText("Confidence: "+evt.confidence.toFixed(2),16,92);
  // Severity
  ctx.fillText("Severity: "+evt.severity,16,112);
  // Drift
  var driftTypes=evt._drift&&evt._drift.length?evt._drift.map(function(d){return d.drift_type}).join(", "):"none";
  ctx.fillText("Drift: "+driftTypes,16,132);
  // Canon
  var claimId=evt._claim?evt._claim.claim_id:"N/A";
  ctx.fillText("Canon: "+claimId,16,152);
  // Hash
  ctx.fillStyle="#8aa0b5";ctx.font="9px monospace";ctx.fillText("SHA-256: "+(evt.evidence_hash||"").slice(0,50),16,180);
  if((evt.evidence_hash||"").length>50)ctx.fillText((evt.evidence_hash||"").slice(50),16,194);
  // Raw line (truncated)
  ctx.fillStyle="#556677";ctx.fillText("RAW: "+((evt.raw_line||"").slice(0,55)),16,218);
  // Footer
  ctx.fillStyle="#7df9ff";ctx.font="9px monospace";ctx.fillText("EDGE JRM v1.0.4 | "+new Date().toISOString().slice(0,19),16,280);
  c.toBlob(function(blob){
    var url=URL.createObjectURL(blob);var a=document.createElement("a");a.href=url;
    a.download="decision_card_"+(evt.event_id||"event")+".png";a.click();URL.revokeObjectURL(url);
    showToast("Decision card PNG downloaded","ok");
  });
}

/* ── Full Trace View (Trace tab) ───────────────────────────────────── */
function renderFullTrace(evt,idx){
  const el=document.getElementById("traceFullView");
  if(!evt){el.innerHTML='<span class="muted">Select an event to view trace.</span>';return}
  // Reuse drawer sections in full width
  const sections=[
    {title:"1. Event Summary",content:renderSummarySection(evt)},
    {title:"2. RAW",content:renderRawSection(evt)},
    {title:"3. PARSED / NORMALIZED",content:renderParsedSection(evt)},
    {title:"4. JOIN",content:renderJoinSection(evt)},
    {title:"5. TRUTH",content:renderTruthSection(evt)},
    {title:"6. REASONING",content:renderReasoningSection(evt)},
    {title:"7. DRIFT",content:renderDriftSection(evt)},
    {title:"8. PATCH",content:renderPatchSection(evt)},
    {title:"9. MEMORY",content:renderMemorySection(evt)},
  ];
  el.innerHTML=`<h3 style="margin:0 0 10px">Trace: Event #${idx+1} — ${esc(evt.event_id)}</h3>`+
    sections.map(s=>`<div class="card"><div class="dsection"><div class="dsection-hdr"><span class="arrow">▾</span> ${s.title}</div><div class="dsection-body">${s.content}</div></div></div>`).join("");
}

/* ── Compress View ─────────────────────────────────────────────────── */
function toggleCompress(){
  S.compressView=!S.compressView;
  var btn=document.getElementById("btnCompress");
  btn.classList.toggle("primary",S.compressView);
  btn.textContent=S.compressView?"FULL":"COMPRESS";
  var ccBtn=document.getElementById("btnCopyCompressed");
  if(ccBtn)ccBtn.style.display=S.compressView?"inline-block":"none";
  if(S.selectedIdx!==null){
    var evt=S.events[S.selectedIdx];
    if(S.compressView)renderCompressView(evt);
    else renderDrawerContent(evt,S.selectedIdx);
  }
}
function copyCompressed(){
  if(S.selectedIdx===null)return;
  var evt=S.events[S.selectedIdx];if(!evt)return;
  var raw=(evt.raw_line||"(no raw data)").slice(0,120);
  var normalized=evt.source_system+":"+evt.event_type+" | "+(evt.action||"-")+" | sev="+evt.severity+" conf="+evt.confidence.toFixed(2);
  var lane=evt._dlr?evt._dlr.lane:"-";
  var drifts=evt._drift&&evt._drift.length?evt._drift.map(function(d){return d.drift_type}).join(","):"none";
  var canon=evt._claim?"claim="+evt._claim.claim_id.slice(0,12)+" conf="+evt._claim.confidence.toFixed(2):"no claim";
  var text="RAW: "+raw+"\nNORMAL: "+normalized+"\nDECISION: lane="+lane+" | drift="+drifts+" | "+canon;
  navigator.clipboard.writeText(text).then(function(){
    var btn=document.getElementById("btnCopyCompressed");
    btn.textContent="Copied!";setTimeout(function(){btn.textContent="Copy Compressed"},1500);showToast("Compressed trace copied to clipboard","ok");
  });
}
function renderCompressView(evt){
  if(!evt)return;
  var body=document.getElementById("drawerBody");
  var raw=esc((evt.raw_line||"(no raw data)").slice(0,120))+(evt.raw_line&&evt.raw_line.length>120?"\u2026":"");
  var normalized=esc(evt.source_system+":"+evt.event_type+" | "+(evt.action||"-")+" | sev="+evt.severity+" conf="+evt.confidence.toFixed(2));
  var lane=evt._dlr?evt._dlr.lane:"\u2014";
  var laneBadge=lane!=="\u2014"?'<span class="badge lane-'+lane+'">'+lane+"</span>":"\u2014";
  var drifts=evt._drift&&evt._drift.length?esc(evt._drift.map(function(d){return d.drift_type}).join(",")):"none";
  var canon=evt._claim?esc("claim="+evt._claim.claim_id.slice(0,12)+" conf="+evt._claim.confidence.toFixed(2)):"no claim";
  var stageHtml="";
  if(evt._stageStatus){
    stageHtml='<div style="margin-top:10px"><div style="font-size:11px;color:var(--muted);margin-bottom:4px">Stage Pipeline</div><div class="stage-status-row">';
    STAGES.forEach(function(s,i){
      var st=evt._stageStatus[s];var isObj=st&&typeof st==="object";var ok=isObj?st.ok:(st==="pass");
      var cls=ok?"pass":(isObj&&st.ok===false||st==="fail")?"fail":"skip";
      var sym=ok?"\u2714":(cls==="fail")?"\u2716":"\u25CB";
      stageHtml+='<span class="stage-marker '+cls+'" title="'+s+": "+(isObj?(ok?"ok":"fail"):(st||"pending"))+'">'+sym+"</span>";
      if(i<STAGES.length-1)stageHtml+='<span style="color:#2a3a4e;font-size:9px;margin:0 1px">\u2192</span>';
    });
    stageHtml+="</div></div>";
  }
  body.innerHTML='<div style="margin-top:10px;font-size:12px;font-weight:600;color:#9ab8d3;margin-bottom:8px">COMPRESS \u2014 3-Line Decision Summary</div>'+
    '<div class="compress-block mono">'+
    '<div class="compress-line"><span class="compress-label">RAW</span><span>'+raw+"</span></div>"+
    '<div class="compress-arrow">\u2193</div>'+
    '<div class="compress-line"><span class="compress-label">NORMAL</span><span>'+normalized+"</span></div>"+
    '<div class="compress-arrow">\u2193</div>'+
    '<div class="compress-line"><span class="compress-label">DECISION</span><span>'+laneBadge+" | drift="+drifts+" | "+canon+"</span></div>"+
    "</div>"+stageHtml;
}

/* ── Copy Trace ────────────────────────────────────────────────────── */
function copyTrace(){
  if(S.selectedIdx===null)return;
  const evt=S.events[S.selectedIdx];
  if(!evt)return;
  const trace={
    event_id:evt.event_id,timestamp:evt.timestamp,source_system:evt.source_system,
    event_type:evt.event_type,severity:evt.severity,confidence:evt.confidence,
    action:evt.action,evidence_hash:evt.evidence_hash,
    join:evt._join||null,claim:evt._claim?{claim_id:evt._claim.claim_id,confidence:evt._claim.confidence}:null,
    reasoning:evt._dlr||null,drift:evt._drift||[],patch:evt._patch||null,
    memory:evt._mg||null
  };
  navigator.clipboard.writeText(JSON.stringify(trace,null,2)).then(()=>{
    const btn=document.getElementById("btnCopyTrace");
    btn.textContent="Copied!";setTimeout(()=>btn.textContent="Copy Trace",1500);showToast("Full trace copied to clipboard","ok");
  });
}

/* ── Coherence Tab Rendering ───────────────────────────────────────── */
function renderCohTab(){
  const c=S.coherence;
  const subs=[
    {label:"Parse Completeness (20%)",val:c.parse},
    {label:"Join Rate (20%)",val:c.join},
    {label:"Reasoning Coverage (20%)",val:c.reasoning},
    {label:"Drift Coverage (20%)",val:c.drift},
    {label:"Patch Lineage Integrity (20%)",val:c.patch},
  ];
  const barsEl=document.getElementById("cohSubBars");
  if(barsEl){
    barsEl.innerHTML=subs.map(s=>{
      const col=s.val>=75?"var(--ok)":s.val>=50?"var(--warn)":"var(--bad)";
      return `<div class="sub-bar-wrap"><div class="sub-bar-label"><span>${s.label}</span><span style="font-weight:600">${s.val}</span></div><div class="sub-bar"><div class="sub-bar-fill" style="width:${s.val}%;background:${col}"></div></div></div>`;
    }).join("");
  }
  // Drift drivers
  const dd=document.getElementById("cohDriftDrivers");
  if(dd){
    const entries=Object.entries(S._driftDrivers).sort((a,b)=>b[1]-a[1]).slice(0,10);
    dd.innerHTML=entries.length?`<table class="kv-table">${entries.map(([k,v])=>`<tr><td class="mono small">${esc(k)}</td><td>${v} detections</td></tr>`).join("")}</table>`:'<span class="muted">No drift data.</span>';
  }
  // Join failures
  const jf=document.getElementById("cohJoinFails");
  if(jf){
    const counts={};S._joinFails.forEach(t=>{counts[t]=(counts[t]||0)+1});
    const entries=Object.entries(counts).sort((a,b)=>b[1]-a[1]);
    jf.innerHTML=entries.length?`<table class="kv-table">${entries.map(([k,v])=>`<tr><td>${esc(k)}</td><td>${v} failures</td></tr>`).join("")}</table>`:'<span class="muted">No join failures.</span>';
  }
  // Patch latency
  const pl=document.getElementById("cohPatchLatency");
  if(pl){
    pl.innerHTML=S._patchCount>0?`<div style="font-size:20px;font-weight:700">${S._patchCount}</div><div class="muted small">patches generated (all inline, &lt;1ms latency)</div>`:'<span class="muted">No patches generated.</span>';
  }
}

/* ── Health Tab ────────────────────────────────────────────────────── */
function renderHealthTab(){
  var evts=S.events.filter(function(e){return e._stageStatus});
  var n=evts.length;
  var stageNames=["RAW","PARSE","NORMALIZE","JOIN","TRUTH","REASONING","DRIFT","PATCH","MEMORY"];
  var ids=["healthPipeline","healthLogicExplained","healthClaimMap","healthOverview","healthQuality","healthQuestionable","healthSigTable","healthScenarios"];
  if(n===0){
    ids.forEach(function(id){var el=document.getElementById(id);if(el)el.innerHTML='<span class="muted">Run the pipeline to see health metrics.</span>'});
    var ring=document.getElementById("healthRing");if(ring){ring.textContent="--";ring.className="health-score-ring"}
    return;
  }

  // ── Gather raw data ──────────────────────────────────
  var confs=evts.map(function(e){return e.confidence});
  var sum=0;for(var i=0;i<n;i++)sum+=confs[i];
  var mean=sum/n;
  var sorted=confs.slice().sort(function(a,b){return a-b});
  var median=n%2===0?(sorted[n/2-1]+sorted[n/2])/2:sorted[Math.floor(n/2)];
  var cMin=sorted[0],cMax=sorted[sorted.length-1];

  // Lane counts
  var lanes={REQUIRE_REVIEW:0,QUEUE_PATCH:0,NOTIFY:0,LOG_ONLY:0};
  evts.forEach(function(e){if(e._dlr&&lanes.hasOwnProperty(e._dlr.lane))lanes[e._dlr.lane]++});

  // Confidence tiers
  var tiers=[
    {label:"Very Low (<0.3)",lo:0,hi:0.3,count:0,color:"var(--bad)"},
    {label:"Low (0.3\u20130.5)",lo:0.3,hi:0.5,count:0,color:"#ff9f43"},
    {label:"Medium (0.5\u20130.7)",lo:0.5,hi:0.7,count:0,color:"var(--warn)"},
    {label:"Good (0.7\u20130.85)",lo:0.7,hi:0.85,count:0,color:"var(--accent)"},
    {label:"High (0.85+)",lo:0.85,hi:1.01,count:0,color:"var(--ok)"}
  ];
  confs.forEach(function(c){tiers.forEach(function(t){if(c>=t.lo&&c<t.hi)t.count++})});

  // Drift counts
  var withDrift=evts.filter(function(e){return e._drift&&e._drift.length>0}).length;
  var pctDrift=((withDrift/n)*100).toFixed(1);

  // Low confidence count
  var lowConf=evts.filter(function(e){return e.confidence<0.5}).length;
  var pctLowConf=((lowConf/n)*100).toFixed(1);

  // Claim convergence
  var claimKeys=Object.keys(S._claimMap);
  var stableClaims=claimKeys.filter(function(k){var cl=S._claimMap[k];return cl.source_events.length>=3&&cl.confidence>=0.6}).length;
  var fluctClaims=claimKeys.filter(function(k){var cl=S._claimMap[k];return cl.source_events.length>=3&&cl.confidence<0.6}).length;

  // FP_SPIKE sigs
  var fpSpikeSigs=[];
  Object.keys(S._sigCounts).forEach(function(sig){
    var cnt=S._sigCounts[sig];
    if(cnt>=5){
      var s2=0,c2=0;
      evts.forEach(function(e){if(String(e.metadata.signature_id||e.metadata.sid)===sig){s2+=e.confidence;c2++}});
      if(c2>0&&(s2/c2)<0.7)fpSpikeSigs.push({sig:sig,count:cnt,avgConf:(s2/c2)});
    }
  });

  // ── Identify questionable records ────────────────────
  var QCONF=0.6;
  var questionable=[];
  var scenMap={FP_SPIKE:"medium",STALE_LOGIC:"medium",LATERAL:"hard",DNS_EXFIL:"hard",MULTI_PROTO:"hard",CRITICAL:"high",AGENTIC:"high",BENIGN:"low",CHAOS:"high",EDGE:"expert",TISSUE:"medium"};
  evts.forEach(function(e){
    var reasons=[];
    if(e.confidence<QCONF&&(e.severity==="critical"||e.severity==="high"))reasons.push("Low confidence + high severity");
    if(e._drift&&e._drift.length>=2)reasons.push(e._drift.length+" drift signals");
    if(e._driftScore>=3)reasons.push("Drift heat "+e._driftScore);
    if(e._join&&e._join.status==="failed")reasons.push("JOIN failure ("+(e._join.reason||"unknown")+")");
    if(e.event_type==="malformed"&&e._dlr)reasons.push("Malformed event received lane");
    if(reasons.length>0)questionable.push({idx:S.events.indexOf(e),evt:e,reasons:reasons});
  });

  // ── Compute health score ─────────────────────────────
  var confScore=Math.round(mean*100);
  var qRatio=n>0?questionable.length/n:0;
  var qScore=Math.round((1-qRatio)*100);
  var driftStab=Math.round((1-(withDrift/Math.max(n,1)))*100);
  var convRate=claimKeys.length>0?(stableClaims/claimKeys.length):1;
  var convScore=Math.round(convRate*100);
  var healthScore=Math.round(confScore*0.4+qScore*0.2+driftStab*0.2+convScore*0.2);
  var hCls=healthScore>=75?"green":healthScore>=50?"yellow":"red";

  // ── Render ring ──────────────────────────────────────
  var ring=document.getElementById("healthRing");
  if(ring){ring.textContent=healthScore;ring.className="health-score-ring "+hCls}
  var tip=document.getElementById("healthTip");
  if(tip){
    tip.innerHTML='<div class="tip-title">Logic Health Score: '+healthScore+' / 100</div>'+
      '<div class="tip-row"><span class="tip-row-label">Confidence (40%)</span><span class="tip-row-val">'+confScore+'</span></div>'+
      '<div style="font-size:11px;color:var(--muted);padding:0 0 4px">Mean event confidence \u00d7 100</div>'+
      '<div class="tip-row"><span class="tip-row-label">Record Quality (20%)</span><span class="tip-row-val">'+qScore+'</span></div>'+
      '<div style="font-size:11px;color:var(--muted);padding:0 0 4px">(1 \u2212 questionable/total) \u00d7 100</div>'+
      '<div class="tip-row"><span class="tip-row-label">Drift Stability (20%)</span><span class="tip-row-val">'+driftStab+'</span></div>'+
      '<div style="font-size:11px;color:var(--muted);padding:0 0 4px">(1 \u2212 drifted/total) \u00d7 100</div>'+
      '<div class="tip-row"><span class="tip-row-label">Claim Convergence (20%)</span><span class="tip-row-val">'+convScore+'</span></div>'+
      '<div style="font-size:11px;color:var(--muted);padding:0 0 4px">Stable claims / total claims \u00d7 100</div>'+
      '<div class="tip-formula">'+confScore+' \u00d7 0.4 + '+qScore+' \u00d7 0.2 + '+driftStab+' \u00d7 0.2 + '+convScore+' \u00d7 0.2 = <strong>'+healthScore+'</strong></div>';
  }

  // ── Card A: Pipeline Logic Process ──────────────────
  var plEl=document.getElementById("healthPipeline");
  if(plEl){
    var stageStats={};
    stageNames.forEach(function(s){stageStats[s]={ok:0,fail:0,reasons:{}}});
    evts.forEach(function(e){
      if(!e._stageStatus)return;
      stageNames.forEach(function(s){
        var st=e._stageStatus[s];if(!st)return;
        if(st.ok){stageStats[s].ok++}
        else{stageStats[s].fail++;var r=st.reason||"unknown";stageStats[s].reasons[r]=(stageStats[s].reasons[r]||0)+1}
      });
    });
    var pipeHtml='<div class="pipeline-flow">';
    stageNames.forEach(function(s,i){
      var stat=stageStats[s];var total=stat.ok+stat.fail;
      var pctOk=total>0?Math.round((stat.ok/total)*100):100;
      var cls=pctOk>=90?"stage-ok":pctOk>=70?"stage-warn":"stage-bad";
      var barColor=pctOk>=90?"var(--ok)":pctOk>=70?"var(--warn)":"var(--bad)";
      if(i>0)pipeHtml+='<div class="pipeline-arrow">\u2192</div>';
      pipeHtml+='<div class="pipeline-stage"><div class="pipeline-stage-hdr '+cls+'">'+s+'</div>'+
        '<div class="pipeline-stage-body"><div class="pipeline-stage-pct" style="color:'+barColor+'">'+pctOk+'%</div>'+
        '<div class="pipeline-stage-bar"><div class="pipeline-stage-bar-fill" style="width:'+pctOk+'%;background:'+barColor+'"></div></div>'+
        '<div class="muted" style="font-size:9px">'+stat.ok+' ok / '+stat.fail+' fail</div></div></div>';
    });
    pipeHtml+='</div>';
    // Cascade analysis
    var cascadeHtml='';
    var parseF=stageStats.PARSE.fail,joinF=stageStats.JOIN.fail,patchF=stageStats.PATCH.fail;
    if(parseF>0)cascadeHtml+='<div class="cascade-row"><span class="cascade-dot c-fail"></span><span style="color:var(--bad);font-size:11px">PARSE failures (\u00d7'+parseF+') cascade: NORMALIZE skips, JOIN may fail</span></div>';
    var indepJoin=joinF-parseF;
    if(indepJoin>0)cascadeHtml+='<div class="cascade-row"><span class="cascade-dot c-fail"></span><span style="color:var(--warn);font-size:11px">'+indepJoin+' independent JOIN failures from missing mapping keys</span></div>';
    if(patchF>0)cascadeHtml+='<div class="cascade-row"><span class="cascade-dot c-skip"></span><span style="color:var(--muted);font-size:11px">'+patchF+' events had no drift to patch (expected for clean events)</span></div>';
    // Per-stage failure reasons
    var reasonsHtml='';
    stageNames.forEach(function(s){
      var rKeys=Object.keys(stageStats[s].reasons);
      rKeys.forEach(function(r){
        var cnt=stageStats[s].reasons[r];
        var dotCls=r.indexOf("skipped")>=0?"c-skip":"c-fail";
        reasonsHtml+='<div class="cascade-row"><span class="cascade-dot '+dotCls+'"></span>'+
          '<span class="cascade-label">'+s+'</span>'+
          '<span class="cascade-count" style="color:var(--bad)">\u00d7'+cnt+'</span>'+
          '<span class="cascade-reason">'+esc(r)+'</span></div>';
      });
    });
    if(cascadeHtml||reasonsHtml){
      pipeHtml+='<div class="pipeline-cascade">';
      pipeHtml+='<div style="font-size:11px;font-weight:600;color:#9ab8d3;margin-bottom:6px">Failure Cascade &amp; Stage Reasons</div>';
      pipeHtml+=cascadeHtml;
      if(reasonsHtml)pipeHtml+='<div style="margin-top:6px;font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.3px">Per-Stage Failure Reasons</div>'+reasonsHtml;
      pipeHtml+='</div>';
    }
    plEl.innerHTML=pipeHtml;
  }

  // ── Card B: Decision Logic Explained ───────────────
  var dlEl=document.getElementById("healthLogicExplained");
  if(dlEl){
    var exEvt=evts.find(function(e){return e.source_system==="suricata"&&e.severity&&e.confidence>0})||evts[0];
    var exSev=exEvt?exEvt.severity:"high";
    var exSevNum={critical:1,high:2,medium:3,low:4,info:5}[exSev]||3;
    var exConf=exEvt?exEvt.confidence.toFixed(2):"0.55";
    var dlHtml='<div class="logic-section"><h4>1. Confidence Formula</h4>'+
      '<div class="logic-formula"><strong>EVE/Snort:</strong> clamp(1 - severity_num \u00d7 0.15, 0.20, 0.99)<br>'+
      '<span class="muted">severity_num: critical=1, high=2, medium=3, low=4</span><br>'+
      '<span style="color:var(--accent)">Example: severity='+esc(exSev)+' ('+exSevNum+') \u2192 1 - '+exSevNum+' \u00d7 0.15 = '+(1-exSevNum*0.15).toFixed(2)+' \u2192 conf = '+exConf+'</span><br><br>'+
      '<strong>Copilot:</strong> uses JSON-provided confidence, default 0.5<br>'+
      '<span class="muted">guardrail_flags present \u2192 forces severity="high"</span></div></div>';
    // Lane rules
    dlHtml+='<div class="logic-section"><h4>2. Lane Assignment Rules</h4>';
    var laneRules=[
      {lane:"REQUIRE_REVIEW",cond:"severity \u2208 {critical, high} AND confidence \u2265 0.80"},
      {lane:"QUEUE_PATCH",cond:"severity = high AND confidence < 0.80"},
      {lane:"NOTIFY",cond:"severity = medium"},
      {lane:"LOG_ONLY",cond:"everything else (low, info, or unmatched)"}
    ];
    laneRules.forEach(function(r){
      dlHtml+='<div class="logic-rule"><span class="logic-rule-lane"><span class="badge lane-'+r.lane+'" style="font-size:9px">'+r.lane+'</span></span>'+
        '<span class="logic-rule-arrow">\u2190</span><span class="logic-rule-cond">'+r.cond+'</span></div>';
    });
    dlHtml+='<div style="margin-top:6px;font-size:10px;color:var(--muted)">Current run: '+
      Object.keys(lanes).map(function(l){return '<span class="badge lane-'+l+'" style="font-size:8px">'+l+'</span> '+lanes[l]}).join(' &nbsp; ')+'</div></div>';
    // Drift rules
    dlHtml+='<div class="logic-section"><h4>3. Drift Detection Rules</h4>';
    [{type:"FP_SPIKE",cond:"sig_count \u2265 5 AND avg_confidence < 0.70",note:"Possible false-positive flooding"},
     {type:"STALE_LOGIC",cond:"signature has > 1 revision seen",note:"Conflicting rule versions in feed"},
     {type:"MISSING_MAPPING",cond:"JOIN stage failed (no signature_id or action)",note:"Event couldn\u2019t map to a claim"}
    ].forEach(function(r){
      dlHtml+='<div class="logic-rule"><span style="min-width:120px"><span class="badge drift-badge">'+r.type+'</span></span>'+
        '<span class="logic-rule-cond">'+r.cond+' <span class="muted small">'+r.note+'</span></span></div>';
    });
    dlHtml+='</div>';
    // Heat scale
    // Build heat buckets for click-to-reveal
    var heatBuckets={0:[],1:[],3:[],5:[]};
    evts.forEach(function(e,i){
      var hs=e._driftScore||0;
      if(hs===0)heatBuckets[0].push(i);
      else if(hs<=1)heatBuckets[1].push(i);
      else if(hs<=3)heatBuckets[3].push(i);
      else heatBuckets[5].push(i);
    });
    dlHtml+='<div class="logic-section"><h4>4. Drift Heat Scale</h4><div class="logic-scale">';
    [{val:0,label:"None",desc:"No drifts",bg:"#1a2e1a",color:"#5dff93"},
     {val:1,label:"Mild",desc:"1 drift, low/med sev",bg:"#2a3a1a",color:"#a8e06c"},
     {val:3,label:"High",desc:"sev=high OR \u22652 drifts",bg:"#3a2a1a",color:"#ffcc66"},
     {val:5,label:"Critical",desc:"sev=critical OR REQUIRE_REVIEW",bg:"#4a1010",color:"#ff6b6b"}
    ].forEach(function(h){
      var cnt=heatBuckets[h.val].length;
      dlHtml+='<div class="logic-scale-item" data-heat="'+h.val+'" style="background:'+h.bg+';color:'+h.color+';border-color:'+h.color+'30">'+
        '<div style="font-size:16px;font-weight:700">'+h.val+'</div>'+
        '<div style="font-size:9px;font-weight:600">'+h.label+'</div>'+
        '<div style="font-size:8px;opacity:.7">'+h.desc+'</div>'+
        '<div style="font-size:9px;margin-top:2px;font-weight:700">'+cnt+' events</div></div>';
    });
    dlHtml+='</div><div id="heatRecordsPanel"></div></div>';
    // Health score weights
    dlHtml+='<div class="logic-section"><h4>5. Health Score Weights</h4>'+
      '<div class="logic-formula">Health = <strong style="color:var(--accent)">Confidence \u00d7 0.40</strong> + '+
      '<strong style="color:var(--ok)">Record Quality \u00d7 0.20</strong> + '+
      '<strong style="color:var(--warn)">Drift Stability \u00d7 0.20</strong> + '+
      '<strong style="color:#cc5de8">Claim Convergence \u00d7 0.20</strong><br>'+
      '<span class="muted">Current: '+confScore+' \u00d7 0.4 + '+qScore+' \u00d7 0.2 + '+driftStab+' \u00d7 0.2 + '+convScore+' \u00d7 0.2 = <strong style="color:var(--txt)">'+healthScore+'</strong></span></div></div>';
    // Claim merging
    dlHtml+='<div class="logic-section"><h4>6. Claim Confidence Merging</h4>'+
      '<div class="logic-formula">new_confidence = (existing_confidence + event_confidence) / 2<br>'+
      '<span class="muted">Rolling average: with many events, confidence converges toward the group mean.<br>'+
      'Stable: \u22653 source events AND confidence \u2265 0.60 &nbsp;|&nbsp; Fluctuating: \u22653 source events AND confidence < 0.60</span></div></div>';
    dlEl.innerHTML=dlHtml;
    // Wire heat scale click handlers
    dlEl.querySelectorAll(".logic-scale-item[data-heat]").forEach(function(item){
      item.addEventListener("click",function(){
        var hv=Number(item.getAttribute("data-heat"));
        var panel=document.getElementById("heatRecordsPanel");
        if(!panel)return;
        // Toggle off if same clicked again
        var wasActive=item.classList.contains("active");
        dlEl.querySelectorAll(".logic-scale-item").forEach(function(el){el.classList.remove("active")});
        if(wasActive){panel.innerHTML="";return}
        item.classList.add("active");
        var idxs=heatBuckets[hv]||[];
        if(idxs.length===0){panel.innerHTML='<div class="heat-records"><span class="muted">No events at heat level '+hv+'.</span></div>';return}
        var show=idxs.slice(0,50);
        var rows=show.map(function(idx){
          var e=S.events[idx];if(!e)return"";
          var lane=e._dlr?e._dlr.lane:"--";
          var drifts=e._drift?e._drift.map(function(d){return d.drift_type}).join(", "):"none";
          return '<tr style="cursor:pointer" onclick="S.selectedIdx='+idx+';openDrawer('+idx+')">'+
            '<td>'+(idx+1)+'</td>'+
            '<td class="mono small">'+esc((e.timestamp||"").slice(11,19))+'</td>'+
            '<td><span class="badge sev-'+e.severity+'">'+esc(e.event_type)+'</span></td>'+
            '<td><span class="badge sev-'+e.severity+'">'+esc(e.severity)+'</span></td>'+
            '<td class="mono">'+e.confidence.toFixed(2)+'</td>'+
            '<td>'+(lane!=="--"?'<span class="badge lane-'+lane+'">'+lane+'</span>':lane)+'</td>'+
            '<td class="small">'+esc(drifts)+'</td>'+
            '<td><span class="drift-heat drift-heat-'+(e._driftScore||0)+'">'+(e._driftScore||0)+'</span></td></tr>';
        }).join("");
        var cap=idxs.length>50?'<div class="muted small" style="margin-bottom:4px">Showing 50 of '+idxs.length+' events.</div>':"";
        panel.innerHTML='<div class="heat-records">'+cap+
          '<table><thead><tr><th>#</th><th>Time</th><th>Type</th><th>Sev</th><th>Conf</th><th>Lane</th><th>Drifts</th><th>Heat</th></tr></thead>'+
          '<tbody>'+rows+'</tbody></table></div>';
      });
    });
  }

  // ── Card C: Claim Evidence Map ─────────────────────
  var cmEl=document.getElementById("healthClaimMap");
  if(cmEl){
    if(claimKeys.length===0){
      cmEl.innerHTML='<span class="muted">No claims built yet.</span>';
    }else{
      var claimsSorted=claimKeys.map(function(k){
        var cl=S._claimMap[k];return{key:k,evtCount:cl.source_events.length,conf:cl.confidence};
      }).sort(function(a,b){return b.evtCount-a.evtCount});
      var maxEvts=claimsSorted[0].evtCount;
      var cmHtml='<div style="font-size:11px;font-weight:600;color:#9ab8d3;margin-bottom:6px">Top Claims by Evidence Count</div>';
      claimsSorted.slice(0,15).forEach(function(c){
        var pct=maxEvts>0?Math.round((c.evtCount/maxEvts)*100):0;
        var confColor=c.conf>=0.7?"var(--ok)":c.conf>=0.5?"var(--warn)":"var(--bad)";
        cmHtml+='<div class="claim-bar"><span class="claim-key" title="'+esc(c.key)+'">'+esc(c.key)+'</span>'+
          '<span class="claim-evts">'+c.evtCount+'</span>'+
          '<span class="claim-evidence-bar"><span class="claim-evidence-fill" data-w="'+pct+'" style="background:'+confColor+'"></span></span>'+
          '<span class="claim-conf" style="color:'+confColor+'">'+c.conf.toFixed(2)+'</span></div>';
      });
      if(claimsSorted.length>15)cmHtml+='<div class="muted small" style="margin-top:4px">'+(claimsSorted.length-15)+' more claims not shown.</div>';
      // Unstable claims
      var unstable=claimsSorted.filter(function(c){return c.evtCount>=3&&c.conf<0.6}).sort(function(a,b){return a.conf-b.conf}).slice(0,10);
      if(unstable.length>0){
        cmHtml+='<div style="margin-top:12px;font-size:11px;font-weight:600;color:var(--warn);margin-bottom:6px">\u26A0 Least Stable Claims (conf < 0.60, \u22653 events)</div>';
        unstable.forEach(function(c){
          cmHtml+='<div class="claim-bar"><span class="claim-key" title="'+esc(c.key)+'">'+esc(c.key)+'</span>'+
            '<span class="claim-evts">'+c.evtCount+'</span>'+
            '<span class="claim-evidence-bar"><span class="claim-evidence-fill" data-w="'+Math.round((c.evtCount/maxEvts)*100)+'" style="background:var(--bad)"></span></span>'+
            '<span class="claim-conf" style="color:var(--bad)">'+c.conf.toFixed(2)+'</span></div>';
        });
      }
      // Summary
      var totalClaims=claimKeys.length;
      var avgEvts=claimsSorted.reduce(function(s,c){return s+c.evtCount},0)/totalClaims;
      var avgClConf=claimsSorted.reduce(function(s,c){return s+c.conf},0)/totalClaims;
      cmHtml+='<div style="display:flex;gap:16px;margin-top:10px;padding-top:8px;border-top:1px solid var(--line);font-size:11px;flex-wrap:wrap">'+
        '<span><span class="muted">Total Claims:</span> <strong>'+totalClaims+'</strong></span>'+
        '<span><span class="muted">Avg Events/Claim:</span> <strong>'+avgEvts.toFixed(1)+'</strong></span>'+
        '<span><span class="muted">Avg Claim Conf:</span> <strong style="color:'+(avgClConf>=0.6?"var(--ok)":"var(--warn)")+'">'+avgClConf.toFixed(2)+'</strong></span>'+
        '<span><span class="muted">Stable:</span> <strong style="color:var(--ok)">'+stableClaims+'</strong></span>'+
        '<span><span class="muted">Fluctuating:</span> <strong style="color:'+(fluctClaims>0?"var(--warn)":"var(--muted)")+'">'+fluctClaims+'</strong></span></div>';
      cmEl.innerHTML=cmHtml;
      requestAnimationFrame(function(){requestAnimationFrame(function(){
        cmEl.querySelectorAll(".claim-evidence-fill[data-w]").forEach(function(bar,i){
          setTimeout(function(){bar.style.width=bar.getAttribute("data-w")+"%"},i*40);
        });
      });});
    }
  }

  // ── Card 1: Logic Health Overview ────────────────────
  var ovEl=document.getElementById("healthOverview");
  if(ovEl){
    var barParts=tiers.map(function(t){
      var pct=n>0?((t.count/n)*100):0;
      return pct>0?'<div style="width:'+pct+'%;background:'+t.color+'" title="'+t.label+': '+t.count+'">'+(t.count>0?t.count:"")+'</div>':"";
    }).join("");
    var laneColors={REQUIRE_REVIEW:"var(--bad)",QUEUE_PATCH:"var(--warn)",NOTIFY:"var(--accent)",LOG_ONLY:"var(--muted)"};
    var laneBar=Object.keys(lanes).map(function(l){
      var c=lanes[l];var pct=n>0?((c/n)*100):0;
      return pct>0?'<div style="width:'+pct+'%;background:'+laneColors[l]+'" title="'+l+': '+c+'">'+(c>0?c:"")+'</div>':"";
    }).join("");
    var tierLegend=tiers.map(function(t){return '<span style="color:'+t.color+'">\u25A0 '+t.label+': '+t.count+'</span>'}).join("");
    var laneLegend=Object.keys(lanes).map(function(l){return '<span><span class="badge lane-'+l+'" style="font-size:9px">'+l+'</span> '+lanes[l]+'</span>'}).join("");
    ovEl.innerHTML='<div class="health-stat"><span class="hs-label">Confidence Distribution</span></div>'+
      '<div class="health-bar">'+barParts+'</div>'+
      '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;font-size:10px">'+tierLegend+'</div>'+
      '<div class="health-stat"><span class="hs-label">Lane Distribution</span></div>'+
      '<div class="health-bar">'+laneBar+'</div>'+
      '<div style="display:flex;flex-wrap:wrap;gap:6px;font-size:10px">'+laneLegend+'</div>';
  }

  // ── Card 2: Decision Quality Metrics ─────────────────
  var qEl=document.getElementById("healthQuality");
  if(qEl){
    function hs(label,val,col){return '<div class="health-stat"><span class="hs-label">'+label+'</span><span class="hs-val"'+(col?' style="color:'+col+'"':"")+'>'+val+'</span></div>'}
    qEl.innerHTML=hs("Mean Confidence",mean.toFixed(3))+
      hs("Median Confidence",median.toFixed(3))+
      hs("Min / Max",cMin.toFixed(3)+" / "+cMax.toFixed(3))+
      hs("Events conf &lt; 0.5",lowConf+" ("+pctLowConf+"%)",lowConf>0?"var(--warn)":"var(--ok)")+
      hs("Events with Drift",withDrift+" ("+pctDrift+"%)",withDrift>0?"var(--warn)":"var(--ok)")+
      hs("Claims: Stable",String(stableClaims),"var(--ok)")+
      hs("Claims: Fluctuating",String(fluctClaims),fluctClaims>0?"var(--warn)":"var(--muted)")+
      hs("FP_SPIKE Signatures",String(fpSpikeSigs.length),fpSpikeSigs.length>0?"var(--bad)":"var(--ok)")+
      hs("Questionable Records",questionable.length+" / "+n,questionable.length>0?"var(--bad)":"var(--ok)")+
      '<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--line)">'+
      '<div class="health-stat"><span class="hs-label" style="font-weight:600">Health Score Breakdown</span></div>'+
      hs("Confidence (40%)",String(confScore))+
      hs("Record Quality (20%)",String(qScore))+
      hs("Drift Stability (20%)",String(driftStab))+
      hs("Claim Convergence (20%)",String(convScore))+
      '</div>';
  }

  // ── Card 3: Questionable Records Table ───────────────
  var qtEl=document.getElementById("healthQuestionable");
  if(qtEl){
    if(questionable.length===0){
      qtEl.innerHTML='<span style="color:var(--ok)">No questionable records detected. All events have consistent scoring.</span>';
    }else{
      var rows=questionable.slice(0,100).map(function(q){
        var e=q.evt;
        var lane=e._dlr?e._dlr.lane:"--";
        var drifts=e._drift?e._drift.map(function(d){return d.drift_type}).join(", "):"--";
        var flagBadges=q.reasons.map(function(r){
          var cls=r.indexOf("Low confidence")>=0?"flag-danger":r.indexOf("drift")>=0||r.indexOf("Drift")>=0?"flag-warn":"flag-info";
          return '<span class="health-flag '+cls+'">'+esc(r)+'</span>';
        }).join(" ");
        var driftBadges=drifts!=="--"?drifts.split(", ").map(function(d){return '<span class="badge drift-badge">'+esc(d)+'</span>'}).join(" "):drifts;
        var scenBdg=e._scenario?'<span class="scenario-badge scen-'+(scenMap[e._scenario]||"medium")+'">'+esc(e._scenario)+'</span>':"";
        // Build expandable detail
        var details=[];
        q.reasons.forEach(function(r){
          if(r.indexOf("Low confidence")>=0){
            details.push('<div class="q-detail-item"><strong>Threshold violated:</strong> confidence ('+e.confidence.toFixed(2)+') < 0.60 with severity '+esc(e.severity)+'</div>');
            if(e.source_system==="suricata"||e.source_system==="snort"){
              var sevNum={critical:1,high:2,medium:3,low:4,info:5}[e.severity]||3;
              details.push('<div class="q-detail-item"><strong>Confidence origin:</strong> clamp(1 - '+sevNum+' \u00d7 0.15, 0.20, 0.99) = '+(Math.max(0.2,Math.min(0.99,1-sevNum*0.15))).toFixed(2)+'</div>');
            }else{
              details.push('<div class="q-detail-item"><strong>Confidence origin:</strong> Copilot JSON-provided or default 0.50</div>');
            }
          }
          if(r.indexOf("drift signals")>=0){
            details.push('<div class="q-detail-item"><strong>Threshold:</strong> \u22652 drift signals on single event. Actual: '+e._drift.length+'</div>');
            e._drift.forEach(function(d){details.push('<div class="q-detail-item" style="margin-left:12px">\u2022 '+esc(d.drift_type)+': '+esc(d.notes||"")+'</div>')});
          }
          if(r.indexOf("Drift heat")>=0){
            details.push('<div class="q-detail-item"><strong>Drift heat:</strong> '+e._driftScore+' (scale: 0=none, 1=mild, 3=high, 5=critical)</div>');
          }
          if(r.indexOf("JOIN failure")>=0){
            details.push('<div class="q-detail-item"><strong>Stage origin:</strong> JOIN \u2014 '+(e._join?esc(e._join.reason||"unknown"):"unknown")+'</div>');
            details.push('<div class="q-detail-item"><strong>Cascade:</strong> No claim built, MISSING_MAPPING drift emitted</div>');
          }
          if(r.indexOf("Malformed")>=0){
            details.push('<div class="q-detail-item"><strong>Stage origin:</strong> PARSE \u2014 event_type="malformed", NORMALIZE skipped</div>');
          }
        });
        // Stage pass/fail summary
        if(e._stageStatus){
          var stgSum=stageNames.map(function(s){var st=e._stageStatus[s];return st?(st.ok?'\u2713':'\u2717'):'\u2013'}).join(" ");
          details.push('<div class="q-detail-item"><strong>Stages:</strong> <span class="mono small">'+stageNames.join(" ")+'</span><br><span class="mono small">'+stgSum+'</span></div>');
        }
        return '<tr style="cursor:pointer" data-evidx="'+q.idx+'" onclick="S.selectedIdx='+q.idx+';openDrawer('+q.idx+');(function(el){var d=el.nextElementSibling;d.style.display=d.style.display===\'none\'?\'table-row\':\'none\'})(this)"><td>'+(q.idx+1)+'</td>'+
          '<td class="mono small">'+esc((e.timestamp||"").slice(11,19))+'</td>'+
          '<td><span class="badge sev-'+e.severity+'">'+esc(e.event_type)+'</span></td>'+
          '<td><span class="badge sev-'+e.severity+'">'+esc(e.severity)+'</span></td>'+
          '<td class="mono">'+e.confidence.toFixed(2)+'</td>'+
          '<td>'+(lane!=="--"?'<span class="badge lane-'+lane+'">'+lane+'</span>':lane)+'</td>'+
          '<td>'+driftBadges+'</td>'+
          '<td>'+scenBdg+'</td>'+
          '<td>'+flagBadges+' <span class="q-expand-btn">\u25BC</span></td></tr>'+
          '<tr class="q-detail-row" style="display:none"><td colspan="9">'+details.join("")+'</td></tr>';
      }).join("");
      var cap=questionable.length>100?'<div class="muted small" style="margin-bottom:6px">Showing first 100 of '+questionable.length+' questionable records.</div>':"";
      qtEl.innerHTML=cap+'<div style="max-height:400px;overflow-y:auto">'+
        '<table><thead><tr><th>#</th><th>Time</th><th>Type</th><th>Sev</th><th>Conf</th><th>Lane</th><th>Drift</th><th>Scenario</th><th>Reason Flagged</th></tr></thead>'+
        '<tbody>'+rows+'</tbody></table></div>';
    }
  }

  // ── Card 4: Signature Health ─────────────────────────
  var sigEl=document.getElementById("healthSigTable");
  if(sigEl){
    var sigStats={};
    evts.forEach(function(e){
      var sig=e.metadata.signature_id||e.metadata.sid;if(!sig)return;
      if(!sigStats[sig])sigStats[sig]={count:0,confSum:0,driftCount:0,fpSpike:false,staleLogic:false};
      sigStats[sig].count++;sigStats[sig].confSum+=e.confidence;
      if(e._drift)e._drift.forEach(function(d){
        sigStats[sig].driftCount++;
        if(d.drift_type==="FP_SPIKE")sigStats[sig].fpSpike=true;
        if(d.drift_type==="STALE_LOGIC")sigStats[sig].staleLogic=true;
      });
    });
    var sigEntries=Object.keys(sigStats).filter(function(k){return sigStats[k].count>=5})
      .sort(function(a,b){return sigStats[b].count-sigStats[a].count}).slice(0,20);
    if(sigEntries.length===0){
      sigEl.innerHTML='<span class="muted">No signatures with 5+ fires.</span>';
    }else{
      sigEl.innerHTML='<div style="max-height:300px;overflow-y:auto"><table>'+
        '<thead><tr><th>Sig ID</th><th>Fires</th><th>Avg Conf</th><th>Drifts</th><th>Flags</th></tr></thead><tbody>'+
        sigEntries.map(function(sig){
          var v=sigStats[sig];var avgC=v.confSum/v.count;var uncertain=avgC<0.6;
          return '<tr><td class="mono small">'+esc(sig)+'</td><td>'+v.count+'</td>'+
            '<td style="color:'+(uncertain?"var(--warn)":"var(--ok)")+'">'+avgC.toFixed(2)+'</td>'+
            '<td>'+v.driftCount+'</td>'+
            '<td>'+(v.fpSpike?'<span class="health-flag flag-warn">FP_SPIKE</span> ':"")+
            (v.staleLogic?'<span class="health-flag flag-info">STALE_LOGIC</span>':"")+'</td></tr>';
        }).join("")+'</tbody></table></div>';
    }
  }

  // ── Card 5: Scenario Difficulty Scorecard ─────────────
  var scEl=document.getElementById("healthScenarios");
  if(scEl){
    var scenStats={};
    evts.forEach(function(e){
      var sc=e._scenario||"(none)";
      if(!scenStats[sc])scenStats[sc]={count:0,confSum:0,flagged:0,lanes:{}};
      scenStats[sc].count++;scenStats[sc].confSum+=e.confidence;
      var ln=e._dlr?e._dlr.lane:"--";
      scenStats[sc].lanes[ln]=(scenStats[sc].lanes[ln]||0)+1;
    });
    questionable.forEach(function(q){
      var sc=q.evt._scenario||"(none)";
      if(scenStats[sc])scenStats[sc].flagged++;
    });
    var scenEntries=Object.keys(scenStats).sort(function(a,b){return scenStats[b].count-scenStats[a].count});
    if(scenEntries.length===0){
      scEl.innerHTML='<span class="muted">No scenario data.</span>';
    }else{
      scEl.innerHTML='<div style="max-height:300px;overflow-y:auto"><table>'+
        '<thead><tr><th>Scenario</th><th>Events</th><th>% Flagged</th><th>Avg Conf</th><th>Dominant Lane</th></tr></thead><tbody>'+
        scenEntries.map(function(sc){
          var v=scenStats[sc];var avgC=v.confSum/v.count;var pctFlag=((v.flagged/v.count)*100).toFixed(1);
          var domLane=Object.keys(v.lanes).sort(function(a,b){return v.lanes[b]-v.lanes[a]})[0]||"--";
          var badgeCls=scenMap[sc]||"medium";
          return '<tr><td>'+(sc!=="(none)"?'<span class="scenario-badge scen-'+badgeCls+'">'+esc(sc)+'</span>':esc(sc))+'</td>'+
            '<td>'+v.count+'</td>'+
            '<td style="color:'+(v.flagged>0?"var(--warn)":"var(--ok)")+'">'+pctFlag+'%</td>'+
            '<td style="color:'+(avgC<0.6?"var(--warn)":"var(--ok)")+'">'+avgC.toFixed(2)+'</td>'+
            '<td>'+(domLane!=="--"?'<span class="badge lane-'+domLane+'">'+domLane+'</span>':domLane)+'</td></tr>';
        }).join("")+'</tbody></table></div>';
    }
  }
}

/* ── Packet Viewer ─────────────────────────────────────────────────── */
function renderPacketList(){
  const el=document.getElementById("pktList");
  if(!S.packets.length){el.innerHTML='<div class="muted" style="padding:10px">No packets loaded.</div>';return}
  var chainLabel=S.packets.length>1?'<div style="font-size:11px;color:var(--accent);margin-bottom:6px;padding:4px 8px;border:1px solid rgba(125,249,255,.15);border-radius:4px">Packet Chain \u2014 '+S.packets.length+' parts loaded</div>':"";
  el.innerHTML=chainLabel+S.packets.map((p,i)=>`<div class="pkt-item" data-idx="${i}" onclick="selectPacket(${i})">
    <div style="font-weight:600;font-size:12px"><span style="color:var(--accent);font-size:10px">JRM-X Packet (6 artifacts)</span><br>${esc(p.name||"Part "+p.part)}</div>
    <div class="muted small">Env: ${esc(p.env)} | Events: ${p.event_count}</div>
    <div class="muted small">${esc((p.window_start||"").slice(0,19))} \u2192 ${esc((p.window_end||"").slice(0,19))}</div>
  </div>`).join("");
}
async function selectPacket(idx){
  document.querySelectorAll(".pkt-item").forEach((el,i)=>el.classList.toggle("active",i===idx));
  const pkt=S.packets[idx];
  if(!pkt)return;
  const detail=document.getElementById("pktDetail");
  const files=pkt.files||{};
  const cards=[];

  // Truth Snapshot
  if(files["truth_snapshot.json"]){
    try{
      const ts=JSON.parse(files["truth_snapshot.json"]);
      cards.push(`<div class="card"><h3>Truth Snapshot (TS)</h3><pre class="mono small">${esc(JSON.stringify(ts,null,2).slice(0,2000))}</pre></div>`);
    }catch(_){cards.push(`<div class="card"><h3>Truth Snapshot</h3><pre class="mono small">${esc(files["truth_snapshot.json"].slice(0,2000))}</pre></div>`)}
  }
  // Authority Slice
  if(files["authority_slice.json"]){
    try{
      const als=JSON.parse(files["authority_slice.json"]);
      cards.push(`<div class="card"><h3>Authority Slice (ALS)</h3><pre class="mono small">${esc(JSON.stringify(als,null,2).slice(0,2000))}</pre></div>`);
    }catch(_){cards.push(`<div class="card"><h3>Authority Slice</h3><pre class="mono small">${esc(files["authority_slice.json"].slice(0,2000))}</pre></div>`)}
  }
  // Decision Lineage
  if(files["decision_lineage.jsonl"]){
    const lines=files["decision_lineage.jsonl"].trim().split("\n").slice(0,50);
    cards.push(`<div class="card"><h3>Decision Lineage (DLR) — ${lines.length} entries</h3><div style="max-height:300px;overflow-y:auto"><pre class="mono small">${esc(lines.join("\n"))}</pre></div></div>`);
  }
  // Drift Signal
  if(files["drift_signal.jsonl"]){
    const lines=files["drift_signal.jsonl"].trim().split("\n").filter(l=>l.trim());
    cards.push(`<div class="card"><h3>Drift Signal (DS) — ${lines.length} signals</h3><div style="max-height:300px;overflow-y:auto"><pre class="mono small">${esc(lines.join("\n"))}</pre></div></div>`);
  }
  // Memory Graph
  if(files["memory_graph.json"]){
    try{
      const mg=JSON.parse(files["memory_graph.json"]);
      const nc=mg.nodes_added||mg.nodes?.length||0;
      const ec=mg.edges_added||mg.edges?.length||0;
      cards.push(`<div class="card"><h3>Memory Graph (MG)</h3><div class="kpi-row" style="grid-template-columns:1fr 1fr"><div class="kpi-card"><div class="kv">${nc}</div><div class="kl">Nodes</div></div><div class="kpi-card"><div class="kv">${ec}</div><div class="kl">Edges</div></div></div><pre class="mono small" style="max-height:200px;overflow-y:auto">${esc(JSON.stringify(mg,null,2).slice(0,1500))}</pre></div>`);
    }catch(_){cards.push(`<div class="card"><h3>Memory Graph</h3><pre class="mono small">${esc(files["memory_graph.json"].slice(0,1500))}</pre></div>`)}
  }
  // Canon Entry
  if(files["canon_entry.json"]){
    try{
      const ce=JSON.parse(files["canon_entry.json"]);
      const entries=Array.isArray(ce)?ce:ce.entries||[ce];
      cards.push(`<div class="card"><h3>Canon Entry (CE) — ${entries.length} postures</h3><pre class="mono small" style="max-height:300px;overflow-y:auto">${esc(JSON.stringify(entries,null,2).slice(0,2000))}</pre></div>`);
    }catch(_){cards.push(`<div class="card"><h3>Canon Entry</h3><pre class="mono small">${esc(files["canon_entry.json"].slice(0,2000))}</pre></div>`)}
  }
  // Manifest
  if(files["manifest.json"]){
    cards.push(`<div class="card"><h3>Manifest</h3><pre class="mono small">${esc(JSON.stringify(JSON.parse(files["manifest.json"]),null,2))}</pre></div>`);
  }

  // Hash/Seal validation
  let sealHtml="";
  if(pkt.manifest&&pkt.manifest.files){
    const mf=typeof pkt.manifest.files==="object"?pkt.manifest.files:{};
    let rows=[];
    for(const[fname,expectedHash]of Object.entries(mf)){
      const content=files[fname];
      if(content){
        const actual=await sha256Hex(content);
        const short=actual.slice(0,12);
        const expShort=(expectedHash||"").replace("sha256:","").slice(0,12);
        const expVal=expectedHash.includes(":")?expectedHash.split(":").slice(1).join(":"):expectedHash;
        const match=expVal&&expVal.length>0&&expVal===actual;
        rows.push(`<tr><td class="mono small">${esc(fname)}</td><td class="hash-mono">${short}\u2026</td><td>${match?'<span style="color:var(--ok)">\u2714</span>':'<span style="color:var(--warn)">\u2260</span>'}</td></tr>`);
      }
    }
    const hasMockHashes=Object.values(mf).some(function(h){return String(h).length<20});
    const sealStatus=hasMockHashes?'<span class="seal-badge seal-pending">Seal Pending (demo hashes)</span>':'<span class="seal-badge seal-ok">Sealed \u2714</span>';
    sealHtml=`<div class="card"><h3>Integrity &amp; Seal</h3><div style="margin-bottom:8px">${sealStatus}</div><table style="width:100%"><thead><tr><th>File</th><th>SHA-256</th><th></th></tr></thead><tbody>${rows.join("")}</tbody></table></div>`;
  }
  var tamperBtns=S._tampered[idx]?`<button class="danger" onclick="restoreTamper(${idx})">Restore Original</button>`:`<button onclick="tamperTest(${idx})">Tamper Test</button>`;
  detail.innerHTML=`<div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap"><button class="primary" onclick="exportPacket(${idx})">Export Packet JSON</button><button onclick="replayPacketChain(${idx})">Rebuild State</button><button onclick="validatePacket(${idx})">Validate Packet</button><button onclick="runReplayProof(${idx})">Replay Proof</button>${tamperBtns}</div>`+sealHtml+cards.join("");
}
function exportPacket(idx){
  const pkt=S.packets[idx];
  if(!pkt)return;
  downloadFile(JSON.stringify(pkt,null,2),`${pkt.name||"packet"}.json`,"application/json");
  showToast("Packet exported as JSON","ok");
}

async function replayPacketChain(idx){
  const pkt=S.packets[idx];if(!pkt)return;
  const detail=document.getElementById("pktDetail");
  const dlr=pkt.files["decision_lineage.jsonl"]||"";
  const lines=dlr.trim().split("\n").filter(function(l){return l.trim()});
  let replayEvents=0;const lanes={};
  lines.forEach(function(l){try{var j=JSON.parse(l);replayEvents++;lanes[j.lane]=(lanes[j.lane]||0)+1}catch(_){}});
  var mg;try{mg=JSON.parse(pkt.files["memory_graph.json"]||"{}")}catch(_){mg={}}
  var ce;try{ce=JSON.parse(pkt.files["canon_entry.json"]||"[]")}catch(_){ce=[]}
  if(!Array.isArray(ce))ce=ce.entries||[ce];
  const replayData=JSON.stringify({packet:pkt.name,events_replayed:replayEvents,lane_distribution:lanes,memory_nodes:mg.nodes_added||0,memory_edges:mg.edges_added||0,timestamp:nowIso()});
  const replayHash=await sha256Hex(replayData);
  // Cross-packet diff
  var diffHtml="";
  if(idx>0&&S.packets[idx-1]){
    var prev=S.packets[idx-1];
    var prevCe;try{prevCe=JSON.parse(prev.files["canon_entry.json"]||"[]")}catch(_){prevCe=[]}
    if(!Array.isArray(prevCe))prevCe=prevCe.entries||[prevCe];
    var prevMg;try{prevMg=JSON.parse(prev.files["memory_graph.json"]||"{}")}catch(_){prevMg={}}
    var prevDlr=prev.files["decision_lineage.jsonl"]||"";var prevLines=prevDlr.trim().split("\n").filter(function(l){return l.trim()});
    var prevLanes={};prevLines.forEach(function(l){try{var j=JSON.parse(l);prevLanes[j.lane]=(prevLanes[j.lane]||0)+1}catch(_){}});
    var diffs=[];
    // Posture changes
    ce.forEach(function(entry){
      var prevEntry=prevCe.find(function(p){return p.signature_id===entry.signature_id});
      if(prevEntry&&prevEntry.official_posture!==entry.official_posture)diffs.push("Posture: sig "+entry.signature_id+" "+prevEntry.official_posture+" \u2192 "+entry.official_posture);
      if(prevEntry&&prevEntry.active_rev!==entry.active_rev)diffs.push("Rev: sig "+entry.signature_id+" rev "+prevEntry.active_rev+" \u2192 "+entry.active_rev);
      if(!prevEntry)diffs.push("New posture: sig "+entry.signature_id+" = "+entry.official_posture);
    });
    // Node/edge delta
    var nodeDelta=(mg.nodes_added||0)-(prevMg.nodes_added||0);
    var edgeDelta=(mg.edges_added||0)-(prevMg.edges_added||0);
    if(nodeDelta!==0)diffs.push("Memory nodes: "+(nodeDelta>0?"+":"")+nodeDelta);
    if(edgeDelta!==0)diffs.push("Memory edges: "+(edgeDelta>0?"+":"")+edgeDelta);
    // Lane distribution changes
    var allLanes=new Set([].concat(Object.keys(lanes),Object.keys(prevLanes)));
    allLanes.forEach(function(l){var cur=lanes[l]||0;var prv=prevLanes[l]||0;if(cur!==prv)diffs.push("Lane "+l+": "+prv+" \u2192 "+cur)});
    if(diffs.length){
      diffHtml='<div style="margin-top:8px;padding:8px;border:1px solid rgba(125,249,255,.15);border-radius:4px"><div style="font-weight:600;font-size:11px;color:var(--accent);margin-bottom:4px">Cross-Packet Diff (Part '+(prev.part||idx)+' \u2192 Part '+(pkt.part||(idx+1))+')</div>'+diffs.map(function(d){return '<div style="font-size:11px;margin:2px 0">\u0394 '+esc(d)+"</div>"}).join("")+"</div>";
    }else{
      diffHtml='<div style="margin-top:8px;font-size:11px;color:var(--muted)">No differences from previous packet part.</div>';
    }
  }
  const existing=detail.querySelector(".replay-msg");
  if(existing)existing.remove();
  const div=document.createElement("div");
  div.className="replay-msg";
  div.innerHTML='<div style="font-weight:600;margin-bottom:4px">Replay Complete \u2014 Deterministic Verification</div>'+
    "<div>"+replayEvents+" decisions replayed from "+esc(pkt.name||"packet")+"</div>"+
    '<div style="margin-top:4px">Lanes: '+(Object.entries(lanes).map(function(e){return e[0]+"="+e[1]}).join(", ")||"none")+"</div>"+
    '<div style="margin-top:4px">Memory: '+(mg.nodes_added||0)+" nodes, "+(mg.edges_added||0)+" edges</div>"+
    '<div class="replay-hash">Replay SHA-256: '+replayHash+"</div>"+diffHtml;
  detail.appendChild(div);
}

async function validatePacket(idx){
  var pkt=S.packets[idx];if(!pkt)return;
  var detail=document.getElementById("pktDetail");
  var files=pkt.files||{};
  var mf=pkt.manifest&&pkt.manifest.files?pkt.manifest.files:{};
  var results=[];var allPass=true;
  var requiredFiles=["truth_snapshot.json","authority_slice.json","decision_lineage.jsonl","drift_signal.jsonl","memory_graph.json","canon_entry.json"];
  for(var i=0;i<requiredFiles.length;i++){
    var f=requiredFiles[i];
    if(files[f]){
      var computed=await sha256Hex(files[f]);
      var expected=mf[f]?mf[f].split(":").slice(1).join(":"):null;
      var match=expected&&expected.length>0?computed===expected:null;
      if(match===false)allPass=false;
      results.push({file:f,hash:computed.slice(0,16),present:true,match:match});
    }else{
      results.push({file:f,hash:"-",present:false,match:false});allPass=false;
    }
  }
  var isTampered=S._tampered[idx];
  var existing=detail.querySelector(".validate-msg");if(existing)existing.remove();
  var div=document.createElement("div");div.className="validate-msg"+(isTampered?" tamper-fail":"");
  var borderColor=allPass?"var(--ok)":"#ff6b6b";
  div.style.cssText="margin-top:10px;padding:10px;border:1px solid "+borderColor+";border-radius:6px;background:rgba("+(allPass?"93,255,147":"255,107,107")+",.05)";
  div.innerHTML=(isTampered?'<div class="tamper-banner">INTEGRITY BROKEN \u2014 Artifact tampered</div>':'')+
    '<div style="font-weight:600;margin-bottom:6px;color:'+(allPass?"var(--ok)":"#ff6b6b")+'">'+(allPass?"\u2714 PASS \u2014 All hashes match manifest":"\u2716 FAIL \u2014 Hash mismatch detected")+"</div>"+
    '<table style="width:100%;font-size:11px"><thead><tr><th style="text-align:left">Artifact</th><th>Present</th><th>SHA-256 (prefix)</th><th>Manifest</th></tr></thead><tbody>'+
    results.map(function(r){var mIcon=r.match===true?'<span style="color:var(--ok)">\u2714</span>':r.match===false?'<span style="color:#ff6b6b">\u2716</span>':'<span style="color:var(--muted)">\u2014</span>';return '<tr><td class="mono">'+esc(r.file)+"</td><td>"+(r.present?'<span style="color:var(--ok)">\u2714</span>':'<span style="color:#ff6b6b">\u2716</span>')+'</td><td class="mono">'+r.hash+"</td><td>"+mIcon+"</td></tr>"}).join("")+
    "</tbody></table>";
  detail.appendChild(div);
  S.ctaState.validate=true;updateCtaState();
  showToast(allPass?"Packet validation: PASS":"Packet validation: FAIL",allPass?"ok":"warn");
}
function tamperTest(idx){
  var pkt=S.packets[idx];if(!pkt)return;
  if(!pkt._originalFiles){pkt._originalFiles={};var fk=Object.keys(pkt.files||{});for(var i=0;i<fk.length;i++)pkt._originalFiles[fk[i]]=pkt.files[fk[i]]}
  // Flip 1 character in decision_lineage.jsonl
  var dlr=pkt.files["decision_lineage.jsonl"]||"";
  if(dlr.length>10){pkt.files["decision_lineage.jsonl"]=dlr.slice(0,5)+(dlr[5]==="X"?"Y":"X")+dlr.slice(6)}
  S._tampered[idx]=true;
  selectPacket(idx);
  setTimeout(function(){validatePacket(idx)},300);
  showToast("Tamper injected \u2014 1 byte flipped in decision_lineage.jsonl","warn");
}
function restoreTamper(idx){
  var pkt=S.packets[idx];if(!pkt||!pkt._originalFiles)return;
  var fk=Object.keys(pkt._originalFiles);for(var i=0;i<fk.length;i++)pkt.files[fk[i]]=pkt._originalFiles[fk[i]];
  delete pkt._originalFiles;
  S._tampered[idx]=false;
  selectPacket(idx);
  showToast("Original packet restored","ok");
}

/* ── CTA + Live Counters ──────────────────────────────────────────── */
function updateCtaState(){
  var cs=S.ctaState;
  cs.ingest=S.events.length>0||S.packets.length>0;
  cs.run=S.runIdx>0;
  cs.generate=cs.run;
  var el=function(id,done,active){
    var e=document.getElementById(id);if(!e)return;
    e.classList.toggle("done",!!done);e.classList.toggle("active",!!active&&!done);
  };
  el("ctaIngest",cs.ingest,false);
  el("ctaRun",cs.run,S.running);
  el("ctaValidate",cs.validate,false);
  el("ctaReplay",cs.replay,false);
  var btn=document.getElementById("ctaGenerate");
  if(btn)btn.disabled=!cs.run;
}
function updateLiveCounters(){
  var e=document.getElementById("lcEvents");if(e)e.textContent=S.runIdx;
  var d=document.getElementById("lcDLR");if(d)d.textContent=S._dlrCount;
  var s=document.getElementById("lcDS");if(s)s.textContent=S._dsCount;
  var p=document.getElementById("lcParts");if(p)p.textContent=S.packets.length;
}
async function generatePacketFromState(){
  if(S.runIdx===0){showToast("Run pipeline first","warn");return}
  showToast("Generating JRM-X packet from state...","info");
  var ts=new Date().toISOString();
  var sevHist={};S.events.forEach(function(e){sevHist[e.severity]=(sevHist[e.severity]||0)+1});
  var topSigs={};S.events.forEach(function(e){var sid=e.metadata&&e.metadata.signature_id;if(sid){topSigs[sid]=(topSigs[sid]||0)+1}});
  var truthSnap=JSON.stringify({generated:ts,severity_histogram:sevHist,top_signatures:topSigs,event_count:S.runIdx},null,2);
  var authSlice=JSON.stringify({schema_version:"1.0",generated:ts,authority:"JRM EDGE v1.0.4",classification:"UNCLASSIFIED",retention_days:90},null,2);
  var dlrLines=[];S.events.forEach(function(e,i){if(e._dlr)dlrLines.push(JSON.stringify({event_idx:i,event_id:e.event_id||("evt_"+i),lane:e._dlr.lane,why:e._dlr.why}))});
  var dlrContent=dlrLines.join("\n");
  var dsLines=[];S.events.forEach(function(e,i){if(e._drift&&e._drift.length>0){e._drift.forEach(function(d){dsLines.push(JSON.stringify({event_idx:i,sig_key:(e.metadata&&e.metadata.signature_id||"unknown")+":"+(e.metadata&&e.metadata.rev||0),drift_type:d.type,severity:d.severity}))})}});
  var dsContent=dsLines.join("\n");
  var mgEntries=[];S.events.forEach(function(e){if(e._mg)mgEntries.push(e._mg)});
  var mgContent=JSON.stringify({generated:ts,entries:mgEntries},null,2);
  var ceContent=JSON.stringify({generated:ts,claims:S._claimMap},null,2);
  var files={"truth_snapshot.json":truthSnap,"authority_slice.json":authSlice,"decision_lineage.jsonl":dlrContent,"drift_signal.jsonl":dsContent,"memory_graph.json":mgContent,"canon_entry.json":ceContent};
  var manifestFiles={};var fileKeys=Object.keys(files);
  for(var i=0;i<fileKeys.length;i++){
    manifestFiles[fileKeys[i]]="sha256:"+await sha256Hex(files[fileKeys[i]]);
  }
  var manifest={schema_version:"JRM-X/1.0",generated:ts,window_start:S.events[0]?S.events[0].timestamp:ts,window_end:S.events[S.events.length-1]?S.events[S.events.length-1].timestamp:ts,roll_events:50000,roll_mb:25,part:S.packets.length+1,files:manifestFiles};
  var pkt={label:"JRM-X Part "+(S.packets.length+1)+" (generated)",part:S.packets.length+1,manifest:manifest,files:files,window_start:manifest.window_start,window_end:manifest.window_end,generated:true};
  S.packets.push(pkt);
  S.ctaState.generate=true;
  updateCtaState();updateLiveCounters();
  setTab("packets");renderPacketList();
  selectPacket(S.packets.length-1);
  showToast("JRM-X packet generated with "+fileKeys.length+" artifacts","ok");
}

/* ── Deterministic Replay Proof ───────────────────────────────────── */
function buildReplayState(packets){
  var state={signatures:{},metrics:{events:0,dlrs:0,dss:0,parts:0}};
  var sorted=packets.slice().sort(function(a,b){return(a.window_start||"").localeCompare(b.window_start||"")});
  sorted.forEach(function(pkt){
    state.metrics.parts++;
    var files=pkt.files||{};
    // Apply DLR deltas
    var dlrContent=files["decision_lineage.jsonl"]||"";
    dlrContent.split("\n").filter(Boolean).forEach(function(line){
      try{var d=JSON.parse(line);state.metrics.dlrs++;state.metrics.events++}catch(_){}
    });
    // Apply DS deltas
    var dsContent=files["drift_signal.jsonl"]||"";
    dsContent.split("\n").filter(Boolean).forEach(function(line){
      try{var d=JSON.parse(line);state.metrics.dss++;
        var key=d.sig_key||"unknown";
        if(!state.signatures[key])state.signatures[key]={rev:0,posture:"unknown",last_seen:null,drift_count:0,last_patch_id:null};
        state.signatures[key].drift_count++;
        state.signatures[key].last_seen=d.drift_type||null;
      }catch(_){}
    });
    // Apply CE postures
    var ceContent=files["canon_entry.json"]||"";
    try{var ce=JSON.parse(ceContent);if(ce.claims){Object.keys(ce.claims).forEach(function(k){
      var key=k;if(!state.signatures[key])state.signatures[key]={rev:0,posture:"unknown",last_seen:null,drift_count:0,last_patch_id:null};
      state.signatures[key].posture=ce.claims[k].confidence?"active":"unknown";
    })}}catch(_){}
  });
  return state;
}
async function computeReplayHash(state){return await sha256Hex(stableStringify(state))}
async function runReplayProof(idx){
  if(idx===undefined)idx=S.packets.length-1;
  if(S.packets.length===0){showToast("No packets to replay","warn");return}
  var chain=S.packets.slice(0,idx+1);
  showToast("Running deterministic replay proof...","info");
  // Run twice to prove determinism
  var state1=buildReplayState(chain);
  var state2=buildReplayState(chain);
  var hash1=await computeReplayHash(state1);
  var hash2=await computeReplayHash(state2);
  var pass=hash1===hash2;
  S.ctaState.replay=true;updateCtaState();
  // Render proof panel
  var detail=document.getElementById("pktDetail");
  var existing=detail.querySelector(".replay-proof");if(existing)existing.remove();
  var div=document.createElement("div");div.className="replay-proof";
  var emptyHash=await computeReplayHash({signatures:{},metrics:{events:0,dlrs:0,dss:0,parts:0}});
  div.innerHTML='<h4>Deterministic Replay Proof</h4>'+
    '<div style="margin-bottom:6px"><strong>Packets in chain:</strong> '+chain.length+'</div>'+
    '<div>Ordered packets: '+chain.map(function(p,i){return(p.part||i+1)}).join(" \u2192 ")+'</div>'+
    '<div style="margin-top:6px"><strong>State hash (before):</strong></div><div class="hash-display">'+esc(emptyHash)+'</div>'+
    '<div><strong>State hash (after):</strong></div><div class="hash-display">'+esc(hash1)+'</div>'+
    '<div style="margin-top:6px"><strong>Double-run comparison:</strong></div>'+
    '<div>Run 1: <span class="mono">'+hash1.slice(0,16)+'...</span></div>'+
    '<div>Run 2: <span class="mono">'+hash2.slice(0,16)+'...</span></div>'+
    '<div style="margin-top:8px;font-size:14px" class="'+(pass?"replay-proof-pass":"replay-proof-fail")+'">'+(pass?"\u2714 PASS \u2014 Deterministic replay confirmed":"\u2716 FAIL \u2014 Non-deterministic replay detected")+'</div>'+
    '<div style="margin-top:4px;font-size:10px;color:var(--muted)">Metrics: '+state1.metrics.events+' events, '+state1.metrics.dlrs+' DLRs, '+state1.metrics.dss+' DSs, '+state1.metrics.parts+' parts</div>';
  detail.appendChild(div);
  showToast(pass?"Replay proof: PASS":"Replay proof: FAIL",pass?"ok":"warn");
}

/* ── Ingest Summary ────────────────────────────────────────────────── */
function renderIngestSummary(){
  const el=document.getElementById("inSummary");
  const parts=[];
  if(S.events.length)parts.push(`<b>${S.events.length}</b> events loaded`);
  if(S.packets.length)parts.push(`<b>${S.packets.length}</b> packet part(s)`);
  if(!parts.length){el.innerHTML="No data loaded.";return}
  const sources={};S.events.forEach(e=>{sources[e.source_system]=(sources[e.source_system]||0)+1});
  const srcStr=Object.entries(sources).map(([k,v])=>`${k}: ${v}`).join(", ");
  el.innerHTML=parts.join(" | ")+(srcStr?` | Sources: ${srcStr}`:"");
}

/* ── View Mode Toggle ──────────────────────────────────────────────── */
function setViewMode(mode){
  S.viewMode=mode;
  document.querySelectorAll(".view-toggle button").forEach(function(b){b.classList.toggle("active",b.dataset.mode===mode)});
  const body=document.getElementById("eventBody");
  const rows=[].slice.call(body.querySelectorAll("tr"));
  if(mode==="governance"){
    rows.sort(function(a,b){
      var ai=Number(a.dataset.idx),bi=Number(b.dataset.idx);
      var ea=S.events[ai],eb=S.events[bi];
      var da=(ea&&ea._driftScore)||0,db=(eb&&eb._driftScore)||0;
      if(da!==db)return db-da;
      return ai-bi;
    });
  }else{
    var sevOrder={critical:0,high:1,medium:2,low:3,info:4};
    rows.sort(function(a,b){
      var ai=Number(a.dataset.idx),bi=Number(b.dataset.idx);
      var ea=S.events[ai],eb=S.events[bi];
      var sa=ea?sevOrder[ea.severity]:5;var sb=eb?sevOrder[eb.severity]:5;
      if(sa===undefined)sa=5;if(sb===undefined)sb=5;
      if(sa!==sb)return sa-sb;
      return ai-bi;
    });
  }
  rows.forEach(function(r){body.appendChild(r)});
}

/* ── Reset Pipeline State ──────────────────────────────────────────── */
function resetPipelineState(){
  S.runIdx=0;S.running=false;S.paused=false;S.stepping=false;
  S._claimMap={};S._sigCounts={};S._sigRevs={};
  S._patchCount=0;S._patchWithLineage=0;S._joinFails=[];S._driftDrivers={};
  S._dlrCount=0;S._dsCount=0;S._tampered={};
  S.ctaState={ingest:false,run:false,generate:false,validate:false,replay:false};
  S.coherence={parse:0,join:0,reasoning:0,drift:0,patch:0,total:0};
  S.selectedIdx=null;S.renderedRows=0;S.cohLastUpdated=null;
  S.events.forEach(e=>{delete e._parsed;delete e._normalized;delete e._join;delete e._claim;delete e._dlr;delete e._drift;delete e._driftChecked;delete e._patch;delete e._mg;delete e._stageStatus;delete e._driftScore});
  document.getElementById("eventBody").innerHTML="";
  document.getElementById("runEmpty").classList.remove("hidden");
  document.getElementById("runStatus").textContent="Idle";
  document.getElementById("runProgress").textContent="";
  var lm=document.getElementById("loadMoreWrap");if(lm)lm.classList.add("hidden");
  clearStages();
  renderMeter();
  updateCtaState();updateLiveCounters();
}

/* ═══════════════════════════════════════════════════════════════════════
   MOCK DATA — 250 events + 4 packet parts
   Generator uses seededRand() for deterministic, reproducible output.
   10 scenario tiers demonstrate pipeline difficulty levels.
   ═══════════════════════════════════════════════════════════════════════ */
function generateMockEvents(cfg){
  cfg=cfg||{FP_SPIKE:25,STALE_LOGIC:15,LATERAL:20,DNS_EXFIL:20,MULTI_PROTO:5,CRITICAL:10,AGENTIC:30,BENIGN:40,CHAOS:30,EDGE:15,TISSUE:30};
  var ev=[];
  var fid=1000;
  var pick=function(a){return a[Math.floor(seededRand()*a.length)]};
  var rPort=function(){return 10000+Math.floor(seededRand()*55000)};
  var rIp=function(){return"10."+Math.floor(seededRand()*255)+"."+Math.floor(seededRand()*255)+"."+Math.floor(seededRand()*254+1)};
  var ts=function(base,off){var d=new Date("2026-02-28T10:00:00.000Z");d.setSeconds(d.getSeconds()+base+off);return d.toISOString()};
  var mkAlert=function(sid,rev,sig,cat,sev,scenario,tOff,srcIp,dstIp,dstPort){
    fid++;return{timestamp:ts(0,tOff),flow_id:fid,event_type:"alert",src_ip:srcIp||rIp(),src_port:rPort(),
      dest_ip:dstIp||"192.168.1."+Math.floor(seededRand()*254+1),dest_port:dstPort||pick([80,443,8080,8443]),proto:"TCP",
      alert:{action:pick(["allowed","blocked"]),gid:1,signature_id:sid,rev:rev,signature:sig,category:cat,severity:sev},_scenario:scenario};
  };
  var mkDns=function(domain,rrtype,scenario,tOff,srcIp){
    fid++;return{timestamp:ts(0,tOff),flow_id:fid,event_type:"dns",src_ip:srcIp||rIp(),src_port:rPort(),
      dest_ip:"10.0.0.1",dest_port:53,proto:"UDP",dns:{type:"query",rrname:domain,rrtype:rrtype||"A"},_scenario:scenario};
  };
  var mkHttp=function(host,url,method,status,len,scenario,tOff,srcIp,dstIp){
    fid++;return{timestamp:ts(0,tOff),flow_id:fid,event_type:"http",src_ip:srcIp||rIp(),src_port:rPort(),
      dest_ip:dstIp||rIp(),dest_port:pick([80,443,8080]),proto:"TCP",
      http:{hostname:host,url:url,http_method:method,status:status,length:len},_scenario:scenario};
  };
  var mkFlow=function(scenario,tOff,srcIp,dstIp,dstPort,pkts,bytes,state){
    fid++;return{timestamp:ts(0,tOff),flow_id:fid,event_type:"flow",src_ip:srcIp||rIp(),src_port:rPort(),
      dest_ip:dstIp||rIp(),dest_port:dstPort||443,proto:"TCP",
      flow:{pkts_toserver:pkts||Math.floor(seededRand()*200+5),pkts_toclient:Math.floor(seededRand()*180+3),
        bytes_toserver:bytes||Math.floor(seededRand()*100000+512),bytes_toclient:Math.floor(seededRand()*500000+128),
        state:state||"closed"},_scenario:scenario};
  };
  var mkAgent=function(type,agentId,content,scenario,tOff,model){
    var o={type:type,timestamp:ts(120,tOff),agent_id:agentId,target:pick(["network_analyzer","patch_manager","threat_intel_api","firewall_api","report_engine","data_export"]),
      confidence:Math.round((0.4+seededRand()*0.55)*100)/100,_scenario:scenario};
    if(model)o.model=model;
    if(type==="prompt")o.prompt=content;
    else if(type==="response")o.response=content;
    else if(type==="tool_call")o.tool_calls=content;
    else if(type==="guardrail")o.guardrail_flags=content;
    return o;
  };

  // ── Scenario 1: FP_SPIKE burst ── sig 2010935 fires repeatedly with declining confidence
  for(var i=0;i<cfg.FP_SPIKE;i++){
    var conf_decay=Math.max(1,Math.floor(1+(i/8))); // severity stays 1 (critical) but pipeline sees declining confidence via avg
    ev.push(mkAlert(2010935,6,"ET MALWARE Generic Trojan RAT","A Network Trojan was Detected",conf_decay>2?2:1,"FP_SPIKE",i,"10.0.0."+Math.floor(seededRand()*50+5),"192.168.1.100",80));
  }

  // ── Scenario 2: STALE_LOGIC conflict ── same sig, rotating revs 6/7/8
  for(var i=0;i<cfg.STALE_LOGIC;i++){
    var rev=pick([6,7,8]);
    ev.push(mkAlert(2010935,rev,"ET MALWARE Generic Trojan RAT","A Network Trojan was Detected",1,"STALE_LOGIC",25+i,rIp(),"192.168.1."+pick([100,101,102,103]),pick([80,443])));
  }

  // ── Scenario 3: Lateral movement chain ── one attacker sweeps targets
  var latSrc="10.99.0.77";
  var latTargets=["192.168.1.10","192.168.1.11","192.168.1.12","192.168.1.20","192.168.1.21","192.168.2.5","192.168.2.6","192.168.3.1","172.16.0.50","172.16.0.51"];
  var latPorts=[22,445,3389,5985,135,139,5986,8443,9200,6379];
  var latSigs=[{id:2019876,rev:1,sig:"ET SCAN Nmap Scripting Engine User-Agent",cat:"Web Application Attack",sev:2},
    {id:2100498,rev:12,sig:"GPL ATTACK_RESPONSE id check returned root",cat:"Potentially Bad Traffic",sev:2},
    {id:2002911,rev:6,sig:"ET SCAN Potential SSH Scan",cat:"Attempted Information Leak",sev:2},
    {id:2013028,rev:3,sig:"ET POLICY SMB2 NT Create Request",cat:"Potential Corporate Privacy Violation",sev:3}];
  for(var i=0;i<cfg.LATERAL;i++){
    var ls=latSigs[i%latSigs.length];
    ev.push(mkAlert(ls.id,ls.rev,ls.sig,ls.cat,ls.sev,"LATERAL",40+i,latSrc,latTargets[i%latTargets.length],latPorts[i%latPorts.length]));
  }

  // ── Scenario 4: DNS exfiltration ── encoded subdomain beacons
  var exfilBase=["tunnel.darknet.io","exfil.c2relay.net","beacon.stager.xyz"];
  for(var i=0;i<cfg.DNS_EXFIL;i++){
    var encoded=Math.floor(seededRand()*0xFFFFFFFF).toString(16)+"."+Math.floor(seededRand()*0xFFFF).toString(16);
    var domain=encoded+"."+pick(exfilBase);
    ev.push(mkDns(domain,i%5===0?"TXT":"A","DNS_EXFIL",60+i,"10.0.0."+Math.floor(seededRand()*10+30)));
  }

  // ── Scenario 5: Multi-protocol correlation ── DNS→HTTP→Alert chain (3 events per iteration)
  var corrDomains=["stage1.apt-group.net","payload.apt-group.net","c2.apt-group.net"];
  var corrIps=["198.51.100.10","198.51.100.11","198.51.100.12"];
  for(var i=0;i<cfg.MULTI_PROTO;i++){
    var srcHost="10.0.1."+Math.floor(seededRand()*20+50);
    // DNS lookup
    ev.push(mkDns(corrDomains[i%3],"A","MULTI_PROTO",80+i*3,srcHost));
    // HTTP fetch
    ev.push(mkHttp(corrDomains[i%3],pick(["/stage2","/payload.bin","/config.json","/beacon","/update"]),"GET",200,Math.floor(seededRand()*200000+1024),"MULTI_PROTO",81+i*3,srcHost,corrIps[i%3]));
    // Triggered alert
    ev.push(mkAlert(2030001,2,"ET MALWARE Suspected C2 Beacon","Command and Control",1,"MULTI_PROTO",82+i*3,srcHost,corrIps[i%3],443));
  }

  // ── Scenario 6: Critical burst + escalation ── SEV-1 high confidence
  var critSigs=[{id:2030002,rev:1,sig:"ET EXPLOIT CVE-2026-1234 RCE Attempt",cat:"Attempted Admin Access",sev:1},
    {id:2030003,rev:1,sig:"ET TROJAN Cobalt Strike Beacon Activity",cat:"A Network Trojan was Detected",sev:1},
    {id:2030004,rev:1,sig:"ET EXPLOIT Active Directory Kerberoasting",cat:"Credential Access",sev:1}];
  for(var i=0;i<cfg.CRITICAL;i++){
    var cs=critSigs[i%critSigs.length];
    ev.push(mkAlert(cs.id,cs.rev,cs.sig,cs.cat,cs.sev,"CRITICAL",95+i,rIp(),"192.168.1."+pick([1,2,3,5,10]),pick([445,88,389,636])));
  }

  // ── Scenario 7: Agentic coordination (30 events) ── 4 agents, multi-model, guardrails
  var agents=["agent-alpha","agent-beta","agent-gamma","agent-delta"];
  var models=["claude-opus-4-6","claude-sonnet-4-6","claude-haiku-4-5"];
  var prompts=["Analyze network traffic anomalies across all SOC environments","Correlate DNS exfiltration indicators with threat intelligence","Deploy emergency patches for CVE-2026-1234 on affected endpoints",
    "Investigate lateral movement from 10.99.0.77","Assess blast radius of Cobalt Strike beacon activity","Generate incident response timeline for the last 4 hours",
    "Review guardrail violations and recommend policy updates","Cross-reference memory graph with historical attack patterns"];
  var tools=[{name:"query_logs",args:{timeframe:"4h",filter:"severity>=high"}},{name:"lookup_ioc",args:{domain:"tunnel.darknet.io",type:"domain"}},
    {name:"deploy_patch",args:{hosts:["10.0.0.5","10.0.0.25","192.168.1.10"],patch_id:"CVE-2026-1234"}},{name:"block_domain",args:{domain:"stage1.apt-group.net"}},
    {name:"check_reputation",args:{ip:"198.51.100.10"}},{name:"scan_host",args:{target:"10.99.0.77",depth:"full"}},
    {name:"create_ticket",args:{priority:"P1",title:"Cobalt Strike C2 detected"}},{name:"snapshot_memory",args:{window:"last_250_events"}}];
  var responses=["Found 42 high-severity alerts correlated across 3 attack chains","DNS exfiltration confirmed: 20 encoded subdomain queries to darknet.io infrastructure",
    "Patch deployment blocked: requires human approval for 3 production hosts","Lateral movement confirmed: 10.99.0.77 accessed 10 hosts across 4 subnets in 20 seconds",
    "Cobalt Strike beacon signature matched with 98% confidence across 3 endpoints","Incident timeline generated: 250 events, 5 attack phases identified over 10-minute window",
    "3 guardrail violations detected: PII exposure risk, unauthorized production changes, data exfiltration attempt","Memory graph shows 15 connected components linking FP_SPIKE to lateral movement via shared infrastructure"];
  var guardrails=[["requires_approval","production_change"],["pii_detected","data_exfil_risk"],["privilege_escalation","blast_radius_high"],
    ["model_uncertainty","confidence_below_threshold"],["rate_limit_exceeded"],["unauthorized_scope"]];
  for(var i=0;i<cfg.AGENTIC;i++){
    var ag=agents[i%agents.length];
    var mod=models[i%models.length];
    var cycle=i%4; // prompt→tool→response→guardrail
    if(cycle===0)ev.push(mkAgent("prompt",ag,prompts[i%prompts.length],"AGENTIC",i,mod));
    else if(cycle===1)ev.push(mkAgent("tool_call",ag,[tools[i%tools.length]],"AGENTIC",i,null));
    else if(cycle===2)ev.push(mkAgent("response",ag,responses[i%responses.length],"AGENTIC",i,null));
    else ev.push(mkAgent("guardrail",ag,guardrails[i%guardrails.length],"AGENTIC",i,null));
  }

  // ── Scenario 8: Noise floor / benign (40 events) ── legitimate traffic, no drift expected
  var benignDns=["cdn.cloudflare.com","api.github.com","update.microsoft.com","fonts.googleapis.com","registry.npmjs.org",
    "pypi.org","rubygems.org","archive.ubuntu.com","security.debian.org","packages.elastic.co"];
  var benignHttp=[{h:"www.google.com",u:"/search",m:"GET",s:200},{h:"api.stripe.com",u:"/v1/charges",m:"POST",s:201},
    {h:"cdn.jsdelivr.net",u:"/npm/lodash",m:"GET",s:200},{h:"api.slack.com",u:"/api/chat.postMessage",m:"POST",s:200},
    {h:"sentry.io",u:"/api/store",m:"POST",s:200}];
  for(var i=0;i<cfg.BENIGN;i++){
    var tOff=105+Math.floor(i*0.75);
    if(i%4===0)ev.push(mkDns(benignDns[i%benignDns.length],"A","BENIGN",tOff));
    else if(i%4===1){var bh=benignHttp[i%benignHttp.length];ev.push(mkHttp(bh.h,bh.u,bh.m,bh.s,Math.floor(seededRand()*10000+256),"BENIGN",tOff))}
    else if(i%4===2)ev.push(mkFlow("BENIGN",tOff,rIp(),rIp(),pick([80,443,8080]),null,null,"closed"));
    else{ev.push(mkAlert(2024897,3,"ET INFO Observed DNS Query to .cloud TLD","Potentially Bad Traffic",3,"BENIGN",tOff))}
  }

  // ── Scenario 9: Mixed-source chaos (30 events) ── interleaved formats, IPv6, rapid sig changes
  var chaosSigs=[{id:2040001,rev:1,sig:"ET POLICY Outbound SSH Connection",cat:"Potential Corporate Privacy Violation",sev:3},
    {id:2040002,rev:2,sig:"ET EXPLOIT Buffer Overflow Attempt",cat:"Attempted Admin Access",sev:1},
    {id:2040003,rev:1,sig:"ET MALWARE Ransomware Checkin",cat:"A Network Trojan was Detected",sev:1},
    {id:2040004,rev:3,sig:"ET INFO Packed Executable Download",cat:"Misc Activity",sev:2},
    {id:2040005,rev:1,sig:"ET SCAN Masscan Detection",cat:"Detection of a Network Scan",sev:2}];
  for(var i=0;i<cfg.CHAOS;i++){
    var tOff=140+i;
    if(i%6===0){// IPv6 alert
      var cs2=chaosSigs[i%chaosSigs.length];
      fid++;ev.push({timestamp:ts(0,tOff),flow_id:fid,event_type:"alert",src_ip:"fe80::"+Math.floor(seededRand()*0xFFFF).toString(16),src_port:rPort(),
        dest_ip:"fe80::"+Math.floor(seededRand()*0xFFFF).toString(16),dest_port:pick([80,443,22]),proto:"TCP",
        alert:{action:"blocked",gid:1,signature_id:cs2.id,rev:cs2.rev,signature:cs2.sig,category:cs2.cat,severity:cs2.sev},_scenario:"CHAOS"});
    }else if(i%6===1){// Copilot event interleaved
      ev.push(mkAgent("prompt",pick(agents),pick(prompts),"CHAOS",tOff-120,pick(models)));
    }else if(i%6===2){// Rapid sig rev change
      var cs3=chaosSigs[i%chaosSigs.length];
      ev.push(mkAlert(cs3.id,cs3.rev+Math.floor(seededRand()*3),cs3.sig,cs3.cat,cs3.sev,"CHAOS",tOff));
    }else if(i%6===3){// DNS to suspicious domain
      ev.push(mkDns(Math.floor(seededRand()*0xFFFF).toString(16)+".tunnel.darknet.io","TXT","CHAOS",tOff));
    }else if(i%6===4){// HTTP to suspicious endpoint
      ev.push(mkHttp("dropper.malware.biz","/stage"+Math.floor(seededRand()*5)+".bin","GET",200,Math.floor(seededRand()*500000+50000),"CHAOS",tOff));
    }else{// High-volume flow
      ev.push(mkFlow("CHAOS",tOff,rIp(),rIp(),pick([22,3389,445]),Math.floor(seededRand()*5000+500),Math.floor(seededRand()*2000000+100000),"established"));
    }
  }

  // ── Scenario 10: Edge cases ── malformed, zero-conf, unknown types, long lines
  // Proportional split: nulls=33%, zero-conf=20%, unknown=27%, long=20% of cfg.EDGE
  var edgeNull=Math.max(1,Math.round(cfg.EDGE*0.33));
  var edgeZero=Math.max(1,Math.round(cfg.EDGE*0.20));
  var edgeUnk=Math.max(1,Math.round(cfg.EDGE*0.27));
  var edgeLong=Math.max(1,cfg.EDGE-edgeNull-edgeZero-edgeUnk);
  for(var i=0;i<edgeNull;i++)ev.push(null);
  // zero-confidence alerts
  for(var i=0;i<edgeZero;i++){
    fid++;ev.push({timestamp:ts(0,175+i),flow_id:fid,event_type:"alert",src_ip:rIp(),src_port:rPort(),
      dest_ip:rIp(),dest_port:80,proto:"TCP",alert:{action:"allowed",gid:1,signature_id:9999999,rev:0,
      signature:"UNKNOWN Uncategorized Rule Zero Confidence",category:"Not Coverage",severity:4},_scenario:"EDGE"});
  }
  // unknown event_type
  for(var i=0;i<edgeUnk;i++){
    fid++;ev.push({timestamp:ts(0,178+i),flow_id:fid,event_type:pick(["netflow","ikev2","smtp","mqtt"]),
      src_ip:rIp(),src_port:rPort(),dest_ip:rIp(),dest_port:pick([25,1883,500,4500]),proto:pick(["TCP","UDP"]),_scenario:"EDGE"});
  }
  // long raw_line events (stress test truncation)
  for(var i=0;i<edgeLong;i++){
    var longPayload="";for(var j=0;j<200;j++)longPayload+=Math.floor(seededRand()*16).toString(16);
    fid++;ev.push({timestamp:ts(0,182+i),flow_id:fid,event_type:"alert",src_ip:rIp(),src_port:rPort(),
      dest_ip:rIp(),dest_port:443,proto:"TCP",alert:{action:"allowed",gid:1,signature_id:2050001,rev:1,
      signature:"ET MALWARE Large Payload Exfiltration Attempt "+longPayload.slice(0,60),category:"Data Exfiltration",severity:1},_scenario:"EDGE"});
  }

  // ── Connecting tissue ── varied sigs to fill canon histogram
  var tissueSigs=[{id:2024897,rev:3,sig:"ET INFO Observed DNS Query to .cloud TLD",cat:"Potentially Bad Traffic",sev:3},
    {id:2100498,rev:12,sig:"GPL ATTACK_RESPONSE id check returned root",cat:"Potentially Bad Traffic",sev:2},
    {id:2019876,rev:1,sig:"ET SCAN Nmap Scripting Engine User-Agent",cat:"Web Application Attack",sev:2},
    {id:2002911,rev:6,sig:"ET SCAN Potential SSH Scan",cat:"Attempted Information Leak",sev:2},
    {id:2013028,rev:3,sig:"ET POLICY SMB2 NT Create Request",cat:"Potential Corporate Privacy Violation",sev:3},
    {id:2030001,rev:2,sig:"ET MALWARE Suspected C2 Beacon",cat:"Command and Control",sev:1},
    {id:2030002,rev:1,sig:"ET EXPLOIT CVE-2026-1234 RCE Attempt",cat:"Attempted Admin Access",sev:1},
    {id:2030003,rev:1,sig:"ET TROJAN Cobalt Strike Beacon Activity",cat:"A Network Trojan was Detected",sev:1}];
  for(var i=0;i<cfg.TISSUE;i++){
    var tSig=tissueSigs[i%tissueSigs.length];
    ev.push(mkAlert(tSig.id,tSig.rev,tSig.sig,tSig.cat,tSig.sev,"TISSUE",185+i));
  }

  return ev;
}

function readMixerConfig(){
  var cfg={};var total=0;
  var sliders=document.querySelectorAll("#scenarioMixer input[type=range]");
  sliders.forEach(function(sl){
    var key=sl.getAttribute("data-scen");
    var val=Number(sl.value)||0;
    cfg[key]=val;
    // MULTI_PROTO generates 3 events per iteration; others are 1:1
    total+=key==="MULTI_PROTO"?val*3:val;
  });
  return{cfg:cfg,total:total};
}

function updateMixerTotal(){
  var info=readMixerConfig();
  var mtEl=document.getElementById("mixerTotal");if(mtEl)mtEl.textContent=info.total;
  var mlEl=document.getElementById("mixerTotalLabel");if(mlEl)mlEl.textContent=info.total;
}

function loadDemoEvents(){
  _seed=20260228; // reset seed for deterministic generation
  var info=readMixerConfig();
  var raw=generateMockEvents(info.cfg);
  var eveRaw=raw.filter(function(e){return e&&!e.type}); // Suricata-format (has event_type, no .type)
  var copilotRaw=raw.filter(function(e){return e&&e.type}); // Copilot-format (has .type)
  var malformedLines="this is a malformed line\ncorrupted data {invalid json\n\x00binary garbage";
  var eveLines=eveRaw.map(function(e){return JSON.stringify(e)}).join("\n")+"\n"+malformedLines;
  var copilotLines=copilotRaw.map(function(e){return JSON.stringify(e)}).join("\n");
  var eveEvents=parseEVE(eveLines);
  var copilotEvents=parseCopilot(copilotLines);
  return eveEvents.concat(copilotEvents);
}

/* ── Mock Packet Parts (4-part chain) ────────────────────────────── */
function buildMockPacket(name,env,ws,we,part,ec,sevHist,topSigs,dlrEntries,dsEntries,ceEntries,mgNodes,mgEdges){
  var als=JSON.stringify({environment_id:env,policy:"GOV-2.1.0",authority_ref:"AUTH-033059a5",
    allowed_actions:["LOG_ONLY","NOTIFY","QUEUE_PATCH","REQUIRE_REVIEW"],escalation_threshold:"critical"},null,2);
  var ts_f=JSON.stringify({sensors:["sensor-east-01","sensor-east-02"],severity_histogram:sevHist,
    top_signatures:topSigs,window:{start:ws,end:we},event_count:ec},null,2);
  var dlr_f=dlrEntries.map(function(e){return JSON.stringify(e)}).join("\n");
  var ds_f=dsEntries.map(function(e){return JSON.stringify(e)}).join("\n");
  var mg_f=JSON.stringify({nodes_added:mgNodes,edges_added:mgEdges,
    nodes:[{id:"EVD-"+part,kind:"EVIDENCE"},{id:"CLM-"+part,kind:"CLAIM"},{id:"DS-"+part,kind:"DRIFT"}],
    edges:[{from:"EVD-"+part,to:"CLM-"+part,kind:"EVIDENCE_OF"},{from:"DS-"+part,to:"CLM-"+part,kind:"TRIGGERED"}]},null,2);
  var ce_f=JSON.stringify(ceEntries,null,2);
  var files={"truth_snapshot.json":ts_f,"authority_slice.json":als,"decision_lineage.jsonl":dlr_f,
    "drift_signal.jsonl":ds_f,"memory_graph.json":mg_f,"canon_entry.json":ce_f};
  // Demo stub hashes (generatePacketFromState produces real ones)
  var mfFiles={};Object.keys(files).forEach(function(k){mfFiles[k]="sha256:demo_"+k.replace(/\./g,"_")+"_part"+part});
  files["manifest.json"]=JSON.stringify({packet_name:name,environment_id:env,window_start:ws,window_end:we,
    part:part,event_count:ec,size_bytes:ec*128,created_at:we,files:mfFiles},null,2);
  return{name:name,env:env,window_start:ws,window_end:we,event_count:ec,part:part,files:files,
    manifest:{packet_name:name,environment_id:env,window_start:ws,window_end:we,part:part,event_count:ec,files:mfFiles}};
}

var MOCK_PACKETS=[
  buildMockPacket("JRM_X_PACKET_SOC_EAST_20260228T100000_20260228T100040_part01","SOC_EAST",
    "2026-02-28T10:00:00Z","2026-02-28T10:00:40Z",1,65,
    {critical:30,high:10,medium:15,low:5,info:5},
    [{id:2010935,name:"ET MALWARE Generic Trojan RAT",count:40},{id:2019876,name:"ET SCAN Nmap",count:5},{id:2002911,name:"ET SCAN SSH Scan",count:5}],
    [{eventId:"EVT-P1-001",lane:"REQUIRE_REVIEW",severity:"critical",confidence:0.85,whyBullets:[{text:"FP_SPIKE: sig 2010935 fired 25x",evidenceRef:"sha256:fp1",confidence:0.55}]},
     {eventId:"EVT-P1-002",lane:"REQUIRE_REVIEW",severity:"critical",confidence:0.85,whyBullets:[{text:"STALE_LOGIC: conflicting revs 6,7,8",evidenceRef:"sha256:sl1",confidence:0.65}]},
     {eventId:"EVT-P1-003",lane:"QUEUE_PATCH",severity:"high",confidence:0.7,whyBullets:[{text:"Lateral movement detected from 10.99.0.77",evidenceRef:"sha256:lat1",confidence:0.7}]}],
    [{driftId:"DS-P1-001",driftType:"FP_SPIKE",severity:"medium",detectedAt:"2026-02-28T10:00:05Z",notes:"Sig 2010935 fired 25x with declining confidence",fingerprint:{signature_id:"2010935",count:"25"}},
     {driftId:"DS-P1-002",driftType:"STALE_LOGIC",severity:"medium",detectedAt:"2026-02-28T10:00:25Z",notes:"Sig 2010935 has conflicting revisions: 6, 7, 8",fingerprint:{signature_id:"2010935",revisions:"6,7,8"}}],
    [{signature_id:2010935,active_rev:6,official_posture:"under_review",confidence:0.55,last_reviewed:"2026-02-28T10:00:25Z",assumptions:["FP_SPIKE pattern detected"]},
     {signature_id:2019876,active_rev:1,official_posture:"active",confidence:0.70,last_reviewed:"2026-02-28T10:00:40Z",assumptions:[]}],
    25,18),
  buildMockPacket("JRM_X_PACKET_SOC_EAST_20260228T100040_20260228T100105_part02","SOC_EAST",
    "2026-02-28T10:00:40Z","2026-02-28T10:01:05Z",2,65,
    {critical:15,high:8,medium:20,low:12,info:10},
    [{id:2030001,name:"ET MALWARE Suspected C2 Beacon",count:5},{id:2030002,name:"ET EXPLOIT CVE-2026-1234",count:3},{id:2024897,name:"ET INFO DNS .cloud",count:8}],
    [{eventId:"EVT-P2-001",lane:"REQUIRE_REVIEW",severity:"critical",confidence:0.92,whyBullets:[{text:"Multi-protocol correlation: DNS+HTTP+Alert chain",evidenceRef:"sha256:mp1",confidence:0.92}]},
     {eventId:"EVT-P2-002",lane:"NOTIFY",severity:"medium",confidence:0.75,whyBullets:[{text:"DNS exfil pattern: encoded subdomains to darknet.io",evidenceRef:"sha256:dns1",confidence:0.6}]}],
    [{driftId:"DS-P2-001",driftType:"FP_SPIKE",severity:"high",detectedAt:"2026-02-28T10:00:50Z",notes:"C2 beacon sig 2030001 correlated across DNS+HTTP+TLS",fingerprint:{signature_id:"2030001",count:"5"}},
     {driftId:"DS-P2-002",driftType:"MISSING_MAPPING",severity:"low",detectedAt:"2026-02-28T10:01:00Z",notes:"4 DNS exfil events lack claim mapping",fingerprint:{event_type:"suricata_dns",count:"4"}}],
    [{signature_id:2030001,active_rev:2,official_posture:"active",confidence:0.88,last_reviewed:"2026-02-28T10:01:00Z",assumptions:["C2 pattern confirmed"]},
     {signature_id:2030002,active_rev:1,official_posture:"active",confidence:0.92,last_reviewed:"2026-02-28T10:01:05Z",assumptions:["CVE-2026-1234 exploit chain"]}],
    20,15),
  buildMockPacket("JRM_X_PACKET_SOC_EAST_20260228T100105_20260228T100210_part03","SOC_EAST",
    "2026-02-28T10:01:05Z","2026-02-28T10:02:10Z",3,65,
    {critical:2,high:5,medium:15,low:25,info:18},
    [{id:2024897,name:"ET INFO DNS .cloud",count:10},{id:2010935,name:"ET MALWARE Generic Trojan RAT",count:2}],
    [{eventId:"EVT-P3-001",lane:"LOG_ONLY",severity:"low",confidence:0.85,whyBullets:[{text:"Benign DNS/HTTP traffic, no drift",evidenceRef:"sha256:ben1",confidence:0.85}]},
     {eventId:"EVT-P3-002",lane:"REQUIRE_REVIEW",severity:"high",confidence:0.75,whyBullets:[{text:"Agentic guardrail violation: PII detected in export",evidenceRef:"sha256:ag1",confidence:0.4}]}],
    [],
    [{signature_id:2010935,active_rev:7,official_posture:"patched",confidence:0.72,last_reviewed:"2026-02-28T10:02:00Z",assumptions:["Rev 7 consolidated post-review"]},
     {signature_id:2024897,active_rev:3,official_posture:"active",confidence:0.85,last_reviewed:"2026-02-28T10:02:10Z",assumptions:[]}],
    35,28),
  buildMockPacket("JRM_X_PACKET_SOC_EAST_20260228T100210_20260228T100340_part04","SOC_EAST",
    "2026-02-28T10:02:10Z","2026-02-28T10:03:40Z",4,55,
    {critical:8,high:12,medium:15,low:10,info:10},
    [{id:2040002,name:"ET EXPLOIT Buffer Overflow",count:3},{id:2040003,name:"ET MALWARE Ransomware",count:2},{id:2050001,name:"ET MALWARE Large Payload Exfil",count:3}],
    [{eventId:"EVT-P4-001",lane:"REQUIRE_REVIEW",severity:"critical",confidence:0.88,whyBullets:[{text:"Mixed-source chaos: IPv6 alerts + rapid sig changes",evidenceRef:"sha256:ch1",confidence:0.88}]},
     {eventId:"EVT-P4-002",lane:"QUEUE_PATCH",severity:"high",confidence:0.6,whyBullets:[{text:"Edge case: zero-confidence and unknown event types detected",evidenceRef:"sha256:edge1",confidence:0.3}]}],
    [{driftId:"DS-P4-001",driftType:"STALE_LOGIC",severity:"high",detectedAt:"2026-02-28T10:02:30Z",notes:"Chaos sigs 2040001-2040005 have rapid rev changes",fingerprint:{signature_id:"2040002",revisions:"2,3,4"}},
     {driftId:"DS-P4-002",driftType:"MISSING_MAPPING",severity:"medium",detectedAt:"2026-02-28T10:03:00Z",notes:"7 edge-case events (unknown types, zero-conf) have no mapping",fingerprint:{event_type:"mixed",count:"7"}}],
    [{signature_id:2040002,active_rev:2,official_posture:"under_review",confidence:0.60,last_reviewed:"2026-02-28T10:03:00Z",assumptions:["Buffer overflow pattern emerging"]},
     {signature_id:2040003,active_rev:1,official_posture:"active",confidence:0.90,last_reviewed:"2026-02-28T10:03:20Z",assumptions:["Ransomware checkin confirmed"]},
     {signature_id:2050001,active_rev:1,official_posture:"active",confidence:0.85,last_reviewed:"2026-02-28T10:03:40Z",assumptions:["Large payload exfil"]}],
    18,14)
];

/* ── Agentic Demo ──────────────────────────────────────────────────── */
async function runAgenticDemo(){
  // Auto-load demo data, set max speed, auto-run, then highlight drift event
  S.packets=MOCK_PACKETS.slice();
  resetPipelineState();
  S.events=loadDemoEvents();
  renderPacketList();renderIngestSummary();
  setTab("run");
  // Set speed to max
  var slider=document.getElementById("speedSlider");
  slider.value=100;document.getElementById("speedVal").textContent="1ms";
  // Auto-run pipeline
  await runPipeline();
  // Highlight first drift event
  for(var i=0;i<S.events.length;i++){
    if(S.events[i]._drift&&S.events[i]._drift.length>0){selectEvent(i);break}
  }
}

/* ═══════════════════════════════════════════════════════════════════════
   EVENT WIRING
   ═══════════════════════════════════════════════════════════════════════ */
window.addEventListener("DOMContentLoaded",()=>{
  buildRibbon();

  // Tab switching
  document.querySelectorAll(".ttab").forEach(b=>b.addEventListener("click",()=>setTab(b.dataset.tab)));

  // Sub-score dropdown
  document.getElementById("subToggle").addEventListener("click",()=>{
    document.getElementById("subDropdown").classList.toggle("hidden");
  });
  document.addEventListener("click",e=>{
    if(!e.target.closest(".coherence-wrap"))document.getElementById("subDropdown").classList.add("hidden");
  });

  // Speed slider
  document.getElementById("speedSlider").addEventListener("input",e=>{
    document.getElementById("speedVal").textContent=(101-Number(e.target.value))+"ms";
  });

  // Run controls
  document.getElementById("btnStart").addEventListener("click",()=>{
    if(S.events.length===0){alert("Load data first (Ingest tab).");return}
    if(S.running){S.paused=false;document.getElementById("runStatus").textContent="Running";return}
    if(S.runIdx>=S.events.length)resetPipelineState();
    runPipeline();
  });
  document.getElementById("btnPause").addEventListener("click",()=>{
    if(S.running){S.paused=!S.paused;document.getElementById("runStatus").textContent=S.paused?"Paused":"Running"}
  });
  document.getElementById("btnStep").addEventListener("click",()=>{
    if(!S.running){
      if(S.events.length===0)return;
      if(S.runIdx>=S.events.length)resetPipelineState();
      S.stepping=true;S.paused=true;runPipeline();
    }else{
      S.stepping=true;S.paused=false;
    }
  });
  document.getElementById("btnStop").addEventListener("click",()=>{
    S.running=false;S.paused=false;clearStages();
    document.getElementById("runStatus").textContent="Stopped";
  });

  // Filters
  ["fSev","fLane","fDrift","fSearch"].forEach(id=>{
    document.getElementById(id).addEventListener(id==="fDrift"?"change":"input",applyFilters);
  });

  // Drawer
  document.getElementById("drawerCollapseBar").addEventListener("click",closeDrawer);
  document.getElementById("btnCloseDrawer").addEventListener("click",closeDrawer);
  document.getElementById("btnWhy").addEventListener("click",()=>{
    const sec=document.getElementById("sec-reasoning");
    if(sec){sec.scrollIntoView({behavior:"smooth"});sec.style.background="rgba(125,249,255,.05)";setTimeout(()=>sec.style.background="",1500)}
  });
  document.getElementById("btnCopyTrace").addEventListener("click",copyTrace);
  document.getElementById("btnCompress").addEventListener("click",toggleCompress);
  document.getElementById("btnCollapseAll").addEventListener("click",function(){
    var bodies=document.querySelectorAll("#drawerBody .dsection-body");
    var arrows=document.querySelectorAll("#drawerBody .dsection-hdr .arrow");
    var allHidden=bodies.length&&Array.prototype.every.call(bodies,function(b){return b.classList.contains("hidden")});
    bodies.forEach(function(b){b.classList.toggle("hidden",!allHidden)});
    arrows.forEach(function(a){a.classList.toggle("collapsed",!allHidden)});
    this.textContent=allHidden?"▲ Collapse":"▼ Expand";
  });

  // View mode toggle
  document.querySelectorAll(".view-toggle button").forEach(function(b){
    b.addEventListener("click",function(){setViewMode(b.dataset.mode)});
  });

  // Ingest: Raw file
  document.getElementById("inRawFile").addEventListener("change",e=>{
    const file=e.target.files[0];if(!file)return;
    const fmt=document.getElementById("inFmt").value;
    const reader=new FileReader();
    reader.onload=ev=>{
      const text=ev.target.result;
      const parse=fmt==="eve"?parseEVE:fmt==="snort"?parseSnort:fmt==="copilot"?parseCopilot:parseAuto;
      S.events=parse(text);
      resetPipelineState();
      S.events=parse(text);// re-parse after reset
      document.getElementById("inRawStatus").textContent=`Loaded ${S.events.length} events from ${file.name}`;
      renderIngestSummary();
    };
    reader.readAsText(file);
  });

  // Ingest: Zip
  document.getElementById("inZipFile").addEventListener("change",async e=>{
    const files=e.target.files;if(!files.length)return;
    const status=document.getElementById("inZipStatus");
    status.textContent="Loading...";
    S.packets=[];
    for(const file of files){
      try{
        const buf=await file.arrayBuffer();
        const pkt=await loadZipPacket(buf);
        S.packets.push(pkt);
      }catch(err){
        status.textContent=`Error loading ${file.name}: ${err.message}`;
      }
    }
    status.textContent=`Loaded ${S.packets.length} packet part(s)`;
    renderPacketList();renderIngestSummary();
  });

  // Ingest: Folder files
  document.getElementById("btnLoadFolder").addEventListener("click",async()=>{
    const inputs=document.querySelectorAll(".folder-file");
    const files={};let count=0;
    for(const inp of inputs){
      const f=inp.files[0];
      if(f){
        files[inp.dataset.key+".json"]=await f.text();
        count++;
      }
    }
    if(count<1){document.getElementById("inFolderStatus").textContent="Select at least one file.";return}
    let manifest=null;
    try{manifest=JSON.parse(files["manifest.json"]||"{}")}catch(_){}
    S.packets=[{name:"Folder Import",env:manifest?.environment_id||"?",window_start:"",window_end:"",event_count:0,part:1,files,manifest}];
    document.getElementById("inFolderStatus").textContent=`Loaded ${count} file(s)`;
    renderPacketList();renderIngestSummary();
  });

  // Demo data
  document.getElementById("btnDemo").addEventListener("click",()=>{
    S.packets=MOCK_PACKETS.slice();
    resetPipelineState();
    S.events=loadDemoEvents();
    renderPacketList();renderIngestSummary();
    var mixInfo=readMixerConfig();
    showToast("Demo data loaded \u2014 "+mixInfo.total+" events + 4 packets (10 scenarios)","info");
    setTab("run");
  });

  // Mixer toggle
  var mixToggle=document.getElementById("btnMixerToggle");
  var mixPanel=document.getElementById("scenarioMixer");
  if(mixToggle&&mixPanel){
    mixPanel.style.display="none";
    mixToggle.addEventListener("click",function(){
      var vis=mixPanel.style.display!=="none";
      mixPanel.style.display=vis?"none":"block";
      mixToggle.textContent=vis?"\u25B6 Customize Mix":"\u25BC Customize Mix";
    });
  }
  // Mixer sliders live update
  document.querySelectorAll("#scenarioMixer input[type=range]").forEach(function(sl){
    sl.addEventListener("input",function(){
      var valSpan=sl.parentElement.querySelector(".mixer-val");
      if(valSpan)valSpan.textContent=sl.value;
      updateMixerTotal();
    });
  });
  // Mixer reset
  var mixReset=document.getElementById("btnMixerReset");
  if(mixReset)mixReset.addEventListener("click",function(){
    var defaults={FP_SPIKE:25,STALE_LOGIC:15,LATERAL:20,DNS_EXFIL:20,MULTI_PROTO:5,CRITICAL:10,AGENTIC:30,BENIGN:40,CHAOS:30,EDGE:15,TISSUE:30};
    document.querySelectorAll("#scenarioMixer input[type=range]").forEach(function(sl){
      var key=sl.getAttribute("data-scen");
      sl.value=defaults[key]||0;
      var valSpan=sl.parentElement.querySelector(".mixer-val");
      if(valSpan)valSpan.textContent=sl.value;
    });
    updateMixerTotal();
  });

  // Agentic Demo
  var agBtn=document.getElementById("btnAgenticDemo");
  if(agBtn)agBtn.addEventListener("click",runAgenticDemo);

  // Load More rows
  var lmBtn=document.getElementById("btnLoadMore");
  if(lmBtn)lmBtn.addEventListener("click",loadMoreRows);

  // Copy Compressed
  var ccBtn=document.getElementById("btnCopyCompressed");
  if(ccBtn)ccBtn.addEventListener("click",copyCompressed);

  // Error banner controls
  var errCopy=document.getElementById("errCopy");
  if(errCopy)errCopy.addEventListener("click",function(){navigator.clipboard.writeText(_lastErr).then(function(){errCopy.textContent="Copied!";setTimeout(function(){errCopy.textContent="Copy error"},1500);showToast("Error details copied","info")})});
  var errClose=document.getElementById("errClose");
  if(errClose)errClose.addEventListener("click",function(){document.getElementById("errBanner").classList.add("hidden")});

  // Keyboard shortcuts
  document.addEventListener("keydown",e=>{
    // Skip if typing in an input
    if(e.target.tagName==="INPUT"||e.target.tagName==="SELECT"||e.target.tagName==="TEXTAREA")return;
    if(e.key===" "){e.preventDefault();document.getElementById("btnPause").click()}
    if(e.key==="j"||e.key==="J"){
      if(S.selectedIdx!==null&&S.selectedIdx<S.events.length-1)selectEvent(S.selectedIdx+1);
      else if(S.selectedIdx===null&&S.events.length)selectEvent(0);
    }
    if(e.key==="k"||e.key==="K"){
      if(S.selectedIdx!==null&&S.selectedIdx>0)selectEvent(S.selectedIdx-1);
    }
    if(e.key==="f"||e.key==="F"){e.preventDefault();document.getElementById("fSearch").focus()}
    if(e.key==="/"){e.preventDefault();document.getElementById("fSearch").focus()}
    if(e.key==="Escape")closeDrawer();
    if(e.key==="v"||e.key==="V"){
      var curTab=document.querySelector(".ttab.active");
      if(curTab&&curTab.dataset.tab==="packets"&&S.packets.length){
        var selIdx=document.querySelector(".pkt-item.active");
        var pidx=selIdx?[].slice.call(document.querySelectorAll(".pkt-item")).indexOf(selIdx):S.packets.length-1;
        validatePacket(pidx>=0?pidx:0);
      }
    }
    if(e.key==="r"||e.key==="R"){
      if(e.key==="R"&&e.shiftKey)return; // allow browser refresh
      var curTab2=document.querySelector(".ttab.active");
      if(curTab2&&curTab2.dataset.tab==="packets"&&S.packets.length){runReplayProof()}
    }
    if(e.key==="t"||e.key==="T"){
      var curTab3=document.querySelector(".ttab.active");
      if(curTab3&&curTab3.dataset.tab==="packets"&&S.packets.length){
        if(confirm("Inject tamper into selected packet?")){
          var selIdx3=document.querySelector(".pkt-item.active");
          var pidx3=selIdx3?[].slice.call(document.querySelectorAll(".pkt-item")).indexOf(selIdx3):S.packets.length-1;
          tamperTest(pidx3>=0?pidx3:0);
        }
      }
    }
  });

  // Hash routing
  const hash=location.hash.slice(1);
  if(hash&&["ingest","run","trace","packets","coherence","health"].includes(hash))setTab(hash);

  // Onboarding
  var onStart=document.getElementById("onboardStart");
  if(onStart)onStart.addEventListener("click",dismissOnboarding);
  var onDemo=document.getElementById("onboardDemo");
  if(onDemo)onDemo.addEventListener("click",function(){
    dismissOnboarding();
    document.getElementById("btnDemo").click();
  });
  showOnboarding();

  // Shortcut bar dismiss
  var scClose=document.getElementById("shortcutClose");
  if(scClose)scClose.addEventListener("click",function(){
    document.getElementById("shortcutBar").style.display="none";
    try{localStorage.setItem("ds_jrm_edge_shortcuts","hidden")}catch(_){}
  });
  try{if(localStorage.getItem("ds_jrm_edge_shortcuts")==="hidden"){var sb=document.getElementById("shortcutBar");if(sb)sb.style.display="none"}}catch(_){}

  // CTA Generate button
  var ctaGen=document.getElementById("ctaGenerate");
  if(ctaGen)ctaGen.addEventListener("click",function(){generatePacketFromState()});

  // Drawer view toggle (Signal/Judgment)
  document.querySelectorAll("#drawerViewToggle button").forEach(function(btn){
    btn.addEventListener("click",function(){setDrawerViewMode(btn.dataset.viewmode)});
  });

  // Delegated collapse toggle for dsection headers (drawer + trace full view)
  ["drawerBody","traceFullView"].forEach(function(id){
    var container=document.getElementById(id);
    if(container)container.addEventListener("click",function(e){
      var hdr=e.target.closest(".dsection-hdr");
      if(!hdr)return;
      var body=hdr.nextElementSibling;
      if(body)body.classList.toggle("hidden");
      var arrow=hdr.querySelector(".arrow");
      if(arrow)arrow.classList.toggle("collapsed");
    });
  });

  // Decision card buttons
  var cardMD=document.getElementById("btnCardMD");
  if(cardMD)cardMD.addEventListener("click",copyDecisionCardMD);
  var cardPNG=document.getElementById("btnCardPNG");
  if(cardPNG)cardPNG.addEventListener("click",downloadDecisionCardPNG);

  // Init CTA state
  updateCtaState();updateLiveCounters();

  renderMeter();
  renderCohTab();
  renderHealthTab();
});
</script>
</body>
</html>
