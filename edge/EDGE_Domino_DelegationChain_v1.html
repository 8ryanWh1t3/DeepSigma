<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Security-Policy" content="default-src 'none'; connect-src 'none'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; base-uri 'none'; form-action 'none'; frame-src 'none'; object-src 'none'"/>
<!-- EDGE_HARDENING_V1 BEGIN -->
<script>
(function(){
"use strict";
var EDGE_BUILD_ID="EDGE_BUILD_ID:EDGE_Domino_DelegationChain_v1";
function _block(cap){
  return function(){throw new Error("EDGE hardening: "+cap+" is blocked")};
}
window.fetch          = _block("fetch");
window.XMLHttpRequest = _block("XMLHttpRequest");
window.WebSocket      = _block("WebSocket");
window.EventSource    = _block("EventSource");
try{navigator.sendBeacon=_block("sendBeacon")}catch(_){}
window.eval = _block("eval");
window.open = _block("window.open");
try{Object.defineProperty(window,"localStorage",
  {get:_block("localStorage"),configurable:false})}catch(_){}
try{Object.defineProperty(window,"sessionStorage",
  {get:_block("sessionStorage"),configurable:false})}catch(_){}
try{Object.defineProperty(window,"indexedDB",
  {get:_block("indexedDB"),configurable:false})}catch(_){}
document.addEventListener("DOMContentLoaded",function(){
  var ext=document.querySelectorAll("script[src],link[href]");
  if(ext.length>0){
    document.body.innerHTML=
      "<h1 style='color:red;font-family:monospace;padding:40px'>" +
      "EDGE VIOLATION: external resource detected (" +
      ext.length+" element(s))</h1>";
  }
});
})();
</script>
<!-- EDGE_HARDENING_V1 END -->
<!-- EDGE_POLICY_EXCEPTION: clipboard -->
<!-- EDGE_POLICY_EXCEPTION: download -->

<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Deep Sigma EDGE — Domino Delegation Chain</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0a1a;--bg2:#0f0f2a;--card:#12123a;--card-border:#2a1a5e;
  --neon-pink:#ff2d95;--neon-cyan:#00f0ff;--neon-purple:#b44dff;
  --neon-yellow:#ffe14d;--neon-orange:#ff6a00;--neon-green:#39ff14;
  --txt:#e8e0f0;--txt-muted:#8a80a0;--txt-dim:#5a5070;
  --font-body:'Segoe UI',system-ui,-apple-system,sans-serif;
  --font-mono:'Courier New',Courier,monospace;
  --glow-cyan:0 0 20px rgba(0,240,255,.3),0 0 60px rgba(0,240,255,.1);
  --glow-pink:0 0 20px rgba(255,45,149,.3),0 0 60px rgba(255,45,149,.1);
  --glow-purple:0 0 20px rgba(180,77,255,.3),0 0 60px rgba(180,77,255,.1);
}
html{font-size:clamp(14px,1.1vw,17px);scroll-behavior:smooth}
body{font-family:var(--font-body);color:var(--txt);background:var(--bg);line-height:1.65;min-height:100vh}
.wrap{max-width:1100px;width:94%;margin:0 auto;padding:24px 0 60px}

/* ── Header ──────────────────────────────────────────── */
.header{
  text-align:center;padding:30px 24px 22px;margin-bottom:20px;
  border:1px solid var(--card-border);border-radius:12px;
  background:linear-gradient(135deg,rgba(18,18,58,.9),rgba(10,10,26,.95));
  box-shadow:var(--glow-purple);position:relative;
}
.header::before{
  content:'';position:absolute;inset:-1px;border-radius:12px;z-index:-1;
  background:linear-gradient(135deg,var(--neon-pink),var(--neon-purple),var(--neon-cyan));
  opacity:.3;filter:blur(1px);
}
.header h1{
  font-size:1.7rem;font-weight:800;letter-spacing:2px;
  background:linear-gradient(90deg,var(--neon-pink),var(--neon-purple),var(--neon-cyan));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.header .sub{color:var(--txt-muted);font-size:.78rem;margin-top:6px;letter-spacing:.3px}
.badge-row{display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap}
.badge{
  display:inline-block;padding:3px 10px;border-radius:4px;font-size:.65rem;font-weight:700;
  letter-spacing:1.5px;text-transform:uppercase;font-family:var(--font-mono);
}
.badge-edge{background:rgba(255,45,149,.15);color:var(--neon-pink);border:1px solid rgba(255,45,149,.4)}
.badge-ver{background:rgba(0,240,255,.1);color:var(--neon-cyan);border:1px solid rgba(0,240,255,.3)}
.badge-offline{background:rgba(57,255,20,.1);color:var(--neon-green);border:1px solid rgba(57,255,20,.3)}

/* ── Progress Bar ────────────────────────────────────── */
.progress-bar{display:flex;align-items:flex-start;justify-content:center;gap:0;margin:0 0 20px;padding:0 12px}
.prog-step{display:flex;flex-direction:column;align-items:center;cursor:pointer;opacity:.4;transition:opacity .3s}
.prog-step.active,.prog-step.done{opacity:1}
.prog-num{
  width:32px;height:32px;border-radius:50%;background:var(--card);
  border:2px solid var(--txt-dim);display:flex;align-items:center;justify-content:center;
  font-size:.75rem;font-weight:700;color:var(--txt-dim);font-family:var(--font-mono);transition:all .3s;
}
.prog-step.active .prog-num{border-color:var(--neon-cyan);color:var(--neon-cyan);box-shadow:var(--glow-cyan)}
.prog-step.done .prog-num{border-color:var(--neon-green);background:rgba(57,255,20,.15);color:var(--neon-green)}
.prog-label{font-size:.62rem;margin-top:4px;color:var(--txt-dim);font-weight:600;letter-spacing:.3px;text-align:center}
.prog-step.active .prog-label{color:var(--neon-cyan)}
.prog-step.done .prog-label{color:var(--neon-green)}
.prog-line{flex:1;height:2px;background:var(--txt-dim);max-width:80px;margin:15px 8px 0;transition:background .3s}
.prog-line.done{background:var(--neon-green)}

/* ── Wizard Steps ────────────────────────────────────── */
.step{display:none}
.step.active{display:block;animation:fadeIn .25s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.step-nav{display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding:0 2px;gap:8px}

/* ── Cards ────────────────────────────────────────────── */
.card{
  background:var(--card);border:1px solid var(--card-border);border-radius:10px;
  padding:20px;margin-bottom:16px;transition:border-color .2s,box-shadow .2s;
}
.card:hover{border-color:rgba(180,77,255,.35);box-shadow:0 0 14px rgba(180,77,255,.06)}
.card h3{font-size:1rem;font-weight:700;margin-bottom:10px;color:var(--neon-cyan);letter-spacing:.5px}
.card h4{font-size:.82rem;font-weight:700;color:var(--neon-purple);margin:10px 0 4px}
.card p,.card li{font-size:.85rem;color:var(--txt);line-height:1.7}
.card-intro{font-size:.82rem;color:var(--txt-muted);margin-bottom:14px;line-height:1.6}

/* ── Tooltips ────────────────────────────────────────── */
.tip{
  display:inline-flex;align-items:center;justify-content:center;
  width:18px;height:18px;border-radius:50%;
  background:rgba(180,77,255,.15);border:1px solid rgba(180,77,255,.3);
  color:var(--neon-purple);font-size:.6rem;font-weight:700;
  cursor:help;position:relative;vertical-align:middle;margin-left:6px;
}
.tip:hover::after{
  content:attr(data-tip);position:absolute;bottom:calc(100% + 8px);left:50%;
  transform:translateX(-50%);background:var(--bg2);border:1px solid var(--card-border);
  border-radius:8px;padding:10px 14px;font-size:.72rem;font-weight:400;color:var(--txt);
  width:260px;white-space:normal;line-height:1.5;z-index:100;
  box-shadow:0 4px 20px rgba(0,0,0,.5);pointer-events:none;
}
.tip:hover::before{
  content:'';position:absolute;bottom:calc(100% + 2px);left:50%;transform:translateX(-50%);
  border:6px solid transparent;border-top-color:var(--card-border);z-index:101;
}

/* ── Form Elements ────────────────────────────────────── */
textarea{
  width:100%;min-height:80px;padding:10px;border-radius:6px;border:1px solid var(--card-border);
  background:rgba(0,0,0,.3);color:var(--neon-green);font-family:var(--font-mono);font-size:.78rem;
  resize:vertical;line-height:1.6;
}
textarea:focus{outline:none;border-color:var(--neon-purple)}
textarea::placeholder{color:var(--txt-dim)}
input[type="text"],input[type="password"]{
  padding:6px 10px;border-radius:5px;border:1px solid var(--card-border);
  background:rgba(0,0,0,.3);color:var(--txt);font-family:var(--font-mono);font-size:.78rem;width:100%;
}
input[type="text"]:focus,input[type="password"]:focus{outline:none;border-color:var(--neon-purple)}
label{font-size:.72rem;color:var(--txt-muted);font-weight:600;letter-spacing:.3px;display:block;margin-bottom:4px}

/* ── Buttons ──────────────────────────────────────────── */
.btn{
  padding:8px 16px;border-radius:6px;border:1px solid;cursor:pointer;
  font-family:var(--font-mono);font-size:.72rem;font-weight:700;letter-spacing:.5px;
  transition:all .2s;text-transform:uppercase;
}
.btn:disabled{opacity:.35;cursor:not-allowed}
.btn-primary{background:rgba(180,77,255,.2);border-color:rgba(180,77,255,.5);color:#fff}
.btn-primary:hover:not(:disabled){background:rgba(180,77,255,.35)}
.btn-master{background:rgba(0,240,255,.15);border-color:rgba(0,240,255,.4);color:var(--neon-cyan)}
.btn-master:hover:not(:disabled){background:rgba(0,240,255,.3)}
.btn-reset{background:rgba(255,45,149,.12);border-color:rgba(255,45,149,.35);color:var(--neon-pink)}
.btn-reset:hover:not(:disabled){background:rgba(255,45,149,.25)}
.btn-green{background:rgba(57,255,20,.12);border-color:rgba(57,255,20,.3);color:var(--neon-green)}
.btn-green:hover:not(:disabled){background:rgba(57,255,20,.22)}
.btn-copy{
  padding:3px 10px;font-size:.62rem;border-radius:4px;
  background:rgba(180,77,255,.15);border:1px solid rgba(180,77,255,.3);color:var(--neon-purple);
  cursor:pointer;font-family:var(--font-mono);font-weight:700;letter-spacing:.5px;transition:all .2s;
}
.btn-copy:hover{background:rgba(180,77,255,.3)}
.btn-copy.copied{background:rgba(57,255,20,.2);border-color:rgba(57,255,20,.4);color:var(--neon-green)}
.btn-sm{padding:5px 12px;font-size:.65rem}
.btn-row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}

/* ── Output Fields ────────────────────────────────────── */
.out{
  font-family:var(--font-mono);font-size:.72rem;padding:8px 10px;border-radius:6px;
  background:rgba(0,0,0,.3);border:1px solid rgba(42,26,94,.4);color:var(--neon-green);
  word-break:break-all;min-height:28px;line-height:1.5;margin:4px 0;
}
.out.empty{color:var(--txt-dim);font-style:italic}
.out-row{display:flex;gap:6px;align-items:start;margin:4px 0}
.out-row .out{flex:1}

/* ── Status Bar ───────────────────────────────────────── */
.status-bar{
  padding:8px 14px;border-radius:6px;font-size:.75rem;font-weight:600;
  font-family:var(--font-mono);margin:8px 0;transition:all .3s;
}
.status-ok{background:rgba(57,255,20,.08);border:1px solid rgba(57,255,20,.25);color:var(--neon-green)}
.status-warn{background:rgba(255,225,77,.08);border:1px solid rgba(255,225,77,.25);color:var(--neon-yellow)}
.status-err{background:rgba(255,45,149,.08);border:1px solid rgba(255,45,149,.25);color:var(--neon-pink)}
.status-idle{background:rgba(180,77,255,.05);border:1px solid rgba(180,77,255,.15);color:var(--txt-muted)}

/* ── Tile Palette ─────────────────────────────────────── */
.tile-palette{display:flex;flex-wrap:wrap;gap:4px;margin:8px 0;justify-content:center}
.pal-tile{
  display:inline-flex;align-items:center;padding:3px 6px;border-radius:4px;
  border:1px solid var(--card-border);background:rgba(0,0,0,.2);
  font-family:var(--font-mono);font-size:.7rem;font-weight:700;color:var(--neon-green);
  cursor:pointer;transition:all .2s;gap:2px;
}
.pal-tile:hover:not(.pal-used){border-color:var(--neon-cyan);background:rgba(0,240,255,.1)}
.pal-used{opacity:.25;cursor:not-allowed;text-decoration:line-through}
.pal-sep{display:inline-block;width:1px;height:12px;background:var(--txt-dim)}
.pal-count{font-size:.68rem;color:var(--txt-muted);margin-top:4px;text-align:center}

/* ── Participant Rows ─────────────────────────────────── */
.p-row{
  display:flex;gap:8px;align-items:center;padding:8px 10px;
  border-radius:6px;background:rgba(0,0,0,.2);margin:4px 0;
}
.p-num{
  width:24px;height:24px;border-radius:50%;background:var(--neon-purple);
  color:#fff;font-size:.65rem;font-weight:700;display:flex;
  align-items:center;justify-content:center;flex-shrink:0;
}
.p-role{flex:1;min-width:80px;padding:5px 8px;border-radius:4px;border:1px solid var(--card-border);background:rgba(0,0,0,.3);color:var(--txt);font-family:var(--font-mono);font-size:.72rem}
.p-role:focus{outline:none;border-color:var(--neon-purple)}
.tile-input-wrap{display:flex;align-items:center;gap:6px;flex-shrink:0}
.p-tile-input{width:60px;text-align:center;padding:5px 6px;border-radius:4px;border:1px solid var(--card-border);background:rgba(0,0,0,.3);color:var(--neon-green);font-family:var(--font-mono);font-size:.78rem;font-weight:700}
.p-tile-input:focus{outline:none;border-color:var(--neon-cyan)}
.tile-preview{
  padding:2px 8px;border-radius:4px;font-size:.78rem;font-weight:700;
  font-family:var(--font-mono);white-space:nowrap;
  background:rgba(0,240,255,.1);border:1px solid rgba(0,240,255,.3);color:var(--neon-cyan);
}
.tile-preview.tile-err{
  background:rgba(255,45,149,.1);border:1px solid rgba(255,45,149,.3);
  color:var(--neon-pink);font-weight:400;font-size:.65rem;
}
.p-flip{
  padding:4px 8px;border-radius:4px;cursor:pointer;border:1px solid rgba(180,77,255,.3);
  background:rgba(180,77,255,.12);color:var(--neon-purple);font-size:.78rem;transition:all .2s;
}
.p-flip:hover{background:rgba(180,77,255,.25)}
.p-remove{
  padding:3px 7px;border-radius:4px;cursor:pointer;border:1px solid rgba(255,45,149,.3);
  background:rgba(255,45,149,.1);color:var(--neon-pink);font-size:.72rem;font-weight:700;transition:all .2s;
}
.p-remove:hover{background:rgba(255,45,149,.25)}

/* ── Chain Visualization ──────────────────────────────── */
.chain-viz{display:flex;align-items:center;gap:6px;flex-wrap:wrap;padding:16px;justify-content:center}
.domino-tile{display:flex;flex-direction:column;align-items:center}
.tile-face{display:flex;border:2px solid var(--txt-dim);border-radius:6px;background:rgba(255,255,255,.06);overflow:hidden}
.tile-face.t-ok{border-color:var(--neon-green)}
.tile-face.t-broken{border-color:var(--neon-pink);border-style:dashed}
.tile-half{width:30px;height:30px;display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);padding:2px}
.tile-half+.tile-half{border-left:1px solid var(--txt-dim)}
.pip{width:5px;height:5px;border-radius:50%;background:var(--txt);align-self:center;justify-self:center}
.tile-label{font-size:.55rem;color:var(--txt-muted);margin-top:2px;font-family:var(--font-mono);text-align:center}
.chain-arrow{font-size:1.1rem;font-weight:700;padding:0 2px}
.chain-arrow.a-ok{color:var(--neon-green)}
.chain-arrow.a-fail{color:var(--neon-pink)}

/* ── Fix Suggestion ──────────────────────────────────── */
.fix-box{
  margin-top:10px;padding:10px 14px;border-radius:8px;
  background:rgba(255,225,77,.06);border:1px solid rgba(255,225,77,.25);
  font-size:.78rem;color:var(--neon-yellow);
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;line-height:1.6;
}
.fix-box .btn{flex-shrink:0}

/* ── Seal Summary ────────────────────────────────────── */
.seal-summary{
  display:flex;gap:20px;flex-wrap:wrap;padding:16px;border-radius:8px;
  background:rgba(180,77,255,.06);border:1px solid rgba(180,77,255,.25);margin-bottom:12px;
}
.seal-field{flex:1;min-width:200px}
.seal-field .sf-label{font-size:.65rem;color:var(--txt-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.seal-field .sf-value{font-family:var(--font-mono);font-size:.88rem;color:var(--neon-green);font-weight:700}

/* ── Details (collapsed) ─────────────────────────────── */
.detail-wrap{margin-top:12px;border:1px solid var(--card-border);border-radius:8px;overflow:hidden}
.detail-wrap summary{
  padding:10px 14px;cursor:pointer;font-size:.78rem;font-weight:600;
  color:var(--txt-muted);background:rgba(0,0,0,.15);-webkit-user-select:none;user-select:none;list-style:none;
}
.detail-wrap summary::-webkit-details-marker{display:none}
.detail-wrap summary::before{content:'\25b6  ';font-size:.6rem;transition:transform .2s;display:inline-block}
.detail-wrap[open] summary::before{transform:rotate(90deg)}
.detail-wrap summary:hover{color:var(--txt)}
.detail-wrap[open] summary{border-bottom:1px solid var(--card-border)}
.detail-body{padding:14px}

/* ── Tabs ────────────────────────────────────────────── */
.tab-bar{display:flex;gap:0;margin-bottom:16px;border-bottom:2px solid var(--card-border)}
.tab{
  padding:10px 18px;background:transparent;border:none;
  border-bottom:2px solid transparent;color:var(--txt-muted);
  font-family:var(--font-mono);font-size:.75rem;font-weight:700;
  cursor:pointer;transition:all .2s;letter-spacing:.5px;margin-bottom:-2px;
}
.tab:hover{color:var(--txt)}
.tab.active{color:var(--neon-cyan);border-bottom-color:var(--neon-cyan)}
.tab-panel{display:none}
.tab-panel.active{display:block;animation:fadeIn .2s ease}

/* ── Verify Banner ───────────────────────────────────── */
.verify-banner{
  text-align:center;padding:24px;border-radius:10px;margin:12px 0;
  font-size:1.4rem;font-weight:800;letter-spacing:2px;font-family:var(--font-mono);
}
.verify-banner.pass{
  background:rgba(57,255,20,.1);border:2px solid rgba(57,255,20,.4);
  color:var(--neon-green);box-shadow:0 0 30px rgba(57,255,20,.15);
}
.verify-banner.fail{
  background:rgba(255,45,149,.1);border:2px solid rgba(255,45,149,.4);
  color:var(--neon-pink);box-shadow:0 0 30px rgba(255,45,149,.15);
}
.verify-checks{margin-top:12px}
.verify-check{
  padding:8px 12px;margin:4px 0;border-radius:6px;font-size:.82rem;
  display:flex;align-items:center;gap:8px;
}
.check-pass{background:rgba(57,255,20,.06);color:var(--neon-green)}
.check-fail{background:rgba(255,45,149,.06);color:var(--neon-pink)}

/* ── Security Notes ───────────────────────────────────── */
.sec-notes{border:1px solid rgba(255,225,77,.25);border-radius:10px;overflow:hidden;margin-top:16px}
.sec-notes summary{
  padding:14px 18px;cursor:pointer;font-size:.9rem;font-weight:700;
  color:var(--neon-yellow);background:rgba(255,225,77,.03);-webkit-user-select:none;user-select:none;list-style:none;
}
.sec-notes summary::-webkit-details-marker{display:none}
.sec-notes summary::before{content:'\25b6  ';font-size:.6rem;transition:transform .2s;display:inline-block}
.sec-notes[open] summary::before{transform:rotate(90deg)}
.sec-notes[open] summary{border-bottom:1px solid rgba(255,225,77,.2)}
.sec-notes ul{padding:14px 18px 14px 34px}
.sec-notes li{font-size:.78rem;color:var(--txt-muted);margin:3px 0;line-height:1.7}

/* ── File Input ──────────────────────────────────────── */
.file-label{display:inline-block;cursor:pointer}
.file-label input[type="file"]{display:none}

/* ── Responsive ───────────────────────────────────────── */
@media(max-width:640px){
  html{font-size:14px}
  .header h1{font-size:1.2rem}
  .header{padding:20px 16px 16px}
  .btn{padding:7px 12px;font-size:.68rem}
  .p-row{flex-wrap:wrap;gap:6px}
  .p-role{min-width:60px;flex:1 1 100%;order:2}
  .tile-input-wrap{order:3}
  .p-num{order:1}
  .p-flip,.p-remove{order:4}
  .prog-label{display:none}
  .prog-num{width:26px;height:26px;font-size:.65rem}
  .prog-line{max-width:36px;margin:12px 4px 0}
  .step-nav{
    position:sticky;bottom:0;background:var(--bg);
    border-top:1px solid var(--card-border);
    padding:12px 8px;margin:16px -3% 0;z-index:50;
  }
  .wrap{padding-bottom:20px}
  .tab{padding:8px 12px;font-size:.68rem}
  .seal-summary{gap:12px;padding:12px}
  .chain-viz{padding:10px 4px;gap:4px}
  .tile-half{width:24px;height:24px}
  .verify-banner{font-size:1.1rem;padding:16px}
}
</style>
</head>
<body>
<!-- EDGE_ACTION_CONTRACT_V1 -->
<div id="edgeActionContract" style="
  margin:8px auto;max-width:1100px;width:94%;padding:6px 14px;
  border-radius:6px;border:1px solid rgba(57,255,20,.2);
  background:rgba(57,255,20,.04);
  font-family:'Courier New',Courier,monospace;font-size:.6rem;
  color:#8a80a0;display:flex;flex-wrap:wrap;gap:12px;align-items:center;
">
  <span style="color:#39ff14;font-weight:700;letter-spacing:1px">ACTION CONTRACT</span>
  <span>Network: LOCKED</span>
  <span style="opacity:.5">|</span>
  <span>Persistence: NONE</span>
  <span style="opacity:.5">|</span>
  <span>Side Effects: NONE</span>
</div>


<div class="wrap">

<!-- ═══════════════ HEADER ═══════════════ -->
<header class="header">
  <h1>Deep Sigma EDGE</h1>
  <div class="sub">Domino Delegation Chain &mdash; Prove your delegation ceremony with domino tiles</div>
  <div class="badge-row">
    <span class="badge badge-edge">EDGE Module</span>
    <span class="badge badge-ver">v1.0</span>
    <span class="badge badge-offline">Offline</span>
  </div>
</header>

<!-- ═══════════════ PROGRESS BAR ═══════════════ -->
<div class="progress-bar">
  <div class="prog-step active" onclick="progClick(1)">
    <div class="prog-num">1</div>
    <div class="prog-label">Add People</div>
  </div>
  <div class="prog-line" id="progLine1"></div>
  <div class="prog-step" onclick="progClick(2)">
    <div class="prog-num">2</div>
    <div class="prog-label">Build Chain</div>
  </div>
  <div class="prog-line" id="progLine2"></div>
  <div class="prog-step" onclick="progClick(3)">
    <div class="prog-num">3</div>
    <div class="prog-label">Seal</div>
  </div>
  <div class="prog-line" id="progLine3"></div>
  <div class="prog-step" onclick="progClick(4)">
    <div class="prog-num">4</div>
    <div class="prog-label">Use It</div>
  </div>
</div>

<!-- ═══════════════ STATUS ═══════════════ -->
<div id="statusBar" class="status-bar status-idle">Ready &mdash; add participants and enter domino tiles, or try an example.</div>

<!-- ═══════════════ Step 1: Add People ═══════════════ -->
<div class="step active" id="step1">
  <div class="card">
    <h3>Who is in the ceremony?
      <span class="tip" data-tip="Each participant draws a physical domino tile. The tiles form a chain that proves everyone was present.">?</span>
    </h3>
    <p class="card-intro">
      Add each person in the delegation chain. Give them a role and enter the domino tile they drew.
      Tiles are two numbers 0&ndash;6 (e.g. <strong>3-4</strong> or <strong>2,5</strong> or <strong>(1 6)</strong>).
    </p>
    <div class="btn-row">
      <button class="btn btn-green btn-sm" onclick="loadExample()">Try an Example</button>
      <button class="btn btn-primary btn-sm" onclick="addParticipant()">+ Add Person</button>
    </div>
    <div id="participantList" style="margin-top:10px"></div>
    <div style="margin-top:14px">
      <label>Tile Set
        <span class="tip" data-tip="A double-six domino set has 28 unique tiles. Taken tiles are dimmed. Click an available tile to assign it to the next empty participant.">?</span>
      </label>
      <div class="tile-palette" id="tilePalette"></div>
      <div class="pal-count" id="palCount">28 of 28 available</div>
    </div>
  </div>
  <div class="step-nav">
    <div></div>
    <button class="btn btn-master" onclick="goToStep(2)">Next: Build Chain &rarr;</button>
  </div>
</div>

<!-- ═══════════════ Step 2: Build Chain ═══════════════ -->
<div class="step" id="step2">
  <div class="card">
    <h3>Chain Preview
      <span class="tip" data-tip="For a valid chain, the right side of each tile must match the left side of the next tile. This is standard domino chaining.">?</span>
    </h3>
    <p class="card-intro">
      The right side of each tile must match the left side of the next.
      If there is a break, try flipping a tile.
    </p>
    <div class="chain-viz" id="chainViz"></div>
    <div id="chainStatus" class="status-bar status-idle">&mdash;</div>
    <div id="fixSuggestion"></div>
  </div>
  <div class="step-nav">
    <button class="btn btn-primary" onclick="goToStep(1)">&larr; Back</button>
    <button class="btn btn-master" id="sealBtn" onclick="goToStep(3)" disabled>Seal Chain &rarr;</button>
  </div>
</div>

<!-- ═══════════════ Step 3: Seal ═══════════════ -->
<div class="step" id="step3">
  <div class="card" style="border-color:rgba(180,77,255,.4);box-shadow:var(--glow-purple)">
    <h3 style="color:var(--neon-purple)">Chain Sealed
      <span class="tip" data-tip="The chain seal is a SHA-256 hash of the tile sequence. The Quick ID and Domino Name let you verify over the phone.">?</span>
    </h3>

    <!-- Always visible: Quick ID + Domino Name -->
    <div class="seal-summary">
      <div class="seal-field">
        <div class="sf-label">Quick ID
          <span class="tip" data-tip="First 16 characters of the chain seal (SHA-256 hash). Use this to quickly identify a ceremony.">?</span>
        </div>
        <div class="sf-value" id="chainFP">&mdash;</div>
      </div>
      <div class="seal-field">
        <div class="sf-label">Domino Name
          <span class="tip" data-tip="Two domino tile names derived from the seal. Say these over the phone for verbal verification.">?</span>
        </div>
        <div class="sf-value" id="chainDominoFP">&mdash;</div>
      </div>
    </div>

    <!-- Action buttons -->
    <div class="btn-row">
      <button class="btn btn-green btn-sm" onclick="downloadJSON()">Download Record</button>
      <button class="btn btn-primary btn-sm" id="copyJSONBtn" onclick="copyJSON(this)">Copy JSON</button>
    </div>

    <!-- Collapsed details -->
    <details class="detail-wrap">
      <summary>Show full details</summary>
      <div class="detail-body">
        <h4>Chain String</h4>
        <div class="out-row">
          <div id="chainStr" class="out empty">&mdash;</div>
          <button class="btn-copy" onclick="copyField('chainStr',this)">COPY</button>
        </div>
        <h4>Full Seal (SHA-256)</h4>
        <div class="out-row">
          <div id="chainHash" class="out empty">&mdash;</div>
          <button class="btn-copy" onclick="copyField('chainHash',this)">COPY</button>
        </div>
        <h4>Ceremony Record (JSON)</h4>
        <div class="out-row">
          <div id="ceremonyJSON" class="out empty" style="white-space:pre-wrap;max-height:240px;overflow:auto">&mdash;</div>
          <button class="btn-copy" onclick="copyField('ceremonyJSON',this)">COPY</button>
        </div>
      </div>
    </details>
  </div>
  <div class="step-nav">
    <button class="btn btn-primary" onclick="goToStep(2)">&larr; Back</button>
    <button class="btn btn-master" onclick="goToStep(4)">Next: Use It &rarr;</button>
  </div>
</div>

<!-- ═══════════════ Step 4: Use It ═══════════════ -->
<div class="step" id="step4">
  <div class="tab-bar">
    <button class="tab active" data-tab="verify" onclick="switchTab('verify')">Verify</button>
    <button class="tab" data-tab="lock" onclick="switchTab('lock')">Lock Message</button>
    <button class="tab" data-tab="unlock" onclick="switchTab('unlock')">Unlock Message</button>
  </div>

  <!-- Verify Tab -->
  <div class="tab-panel active" id="tab-verify">
    <div class="card" style="border-color:rgba(255,225,77,.25)">
      <h3 style="color:var(--neon-yellow)">Verify a Record
        <span class="tip" data-tip="Paste a ceremony record JSON to verify that the seal (hash) is correct and all tiles connect properly.">?</span>
      </h3>
      <p class="card-intro">Paste a ceremony record or load a saved file. We will re-compute the seal and check that everything matches.</p>
      <div class="btn-row">
        <label class="btn btn-primary btn-sm file-label">
          Load JSON File
          <input type="file" accept=".json" onchange="loadJSONFile(this)"/>
        </label>
      </div>
      <textarea id="verifyInput" placeholder="Paste ceremony record JSON here..." style="min-height:70px"></textarea>
      <div style="margin-top:8px">
        <button class="btn btn-primary" onclick="verifyRecord()">Verify</button>
      </div>
      <div id="verifyBanner" style="display:none"></div>
      <div id="verifyDetails"></div>
    </div>
  </div>

  <!-- Lock Message Tab -->
  <div class="tab-panel" id="tab-lock">
    <div class="card" style="border-color:rgba(0,240,255,.3)">
      <h3 style="color:var(--neon-cyan)">Lock a Message
        <span class="tip" data-tip="Encrypts your text using AES-256-GCM. The key is derived from the chain seal + your passphrase, so only someone with the same chain and passphrase can unlock it.">?</span>
      </h3>
      <p class="card-intro">
        Encrypt text so only someone with this exact chain and the passphrase can read it.
      </p>
      <label for="encPass">Passphrase</label>
      <input type="password" id="encPass" placeholder="Enter a strong passphrase" style="margin-bottom:8px"/>
      <label for="encPlain">Message to lock</label>
      <textarea id="encPlain" placeholder="Type or paste the text you want to encrypt..."></textarea>
      <div style="margin-top:8px">
        <button class="btn btn-master" onclick="encryptPayload()">Lock Message</button>
      </div>
      <h4>Locked output</h4>
      <div class="out-row">
        <div id="encOutput" class="out empty">No output yet</div>
        <button class="btn-copy" onclick="copyField('encOutput',this)">COPY</button>
      </div>
    </div>
  </div>

  <!-- Unlock Message Tab -->
  <div class="tab-panel" id="tab-unlock">
    <div class="card" style="border-color:rgba(255,45,149,.3)">
      <h3 style="color:var(--neon-pink)">Unlock a Message
        <span class="tip" data-tip="Decrypts text that was locked with the same chain and passphrase. If either is wrong, decryption will fail without revealing which one was incorrect.">?</span>
      </h3>
      <p class="card-intro">
        Decrypt a message using the same chain and passphrase that was used to lock it.
      </p>
      <label for="decPass">Passphrase</label>
      <input type="password" id="decPass" placeholder="Enter the passphrase" style="margin-bottom:8px"/>
      <label for="decCipher">Locked text (base64)</label>
      <textarea id="decCipher" placeholder="Paste the encrypted text here..."></textarea>
      <div style="margin-top:8px">
        <button class="btn btn-reset" onclick="decryptPayload()">Unlock Message</button>
      </div>
      <h4>Unlocked output</h4>
      <div id="decOutput" class="out empty">No output yet</div>
    </div>
  </div>

  <div class="step-nav">
    <button class="btn btn-primary" onclick="goToStep(3)">&larr; Back</button>
    <button class="btn btn-reset" onclick="resetAll()">Start Over</button>
  </div>
</div>

<!-- ═══════════════ SECURITY NOTES ═══════════════ -->
<details class="sec-notes">
  <summary>Security &amp; Usage Notes</summary>
  <ul>
    <li><strong>Chain coordination.</strong> Standard domino chaining: the right value of each tile must match the left value of the next. This constrains tile selection and proves sequential coordination between participants.</li>
    <li><strong>Ceremony binding.</strong> Lock/Unlock keys are derived via HKDF-SHA256 using the chain seal as input and SHA-256(passphrase) as salt. Different chains produce different keys even with the same passphrase.</li>
    <li><strong>Passphrase is the secret.</strong> The chain string is public (it appears in the ceremony record). Security depends entirely on passphrase strength. Use a strong passphrase.</li>
    <li><strong>No information leakage.</strong> Decryption failure (wrong chain or wrong passphrase) produces the same generic error. AES-GCM authentication catches both key mismatch and ciphertext tampering.</li>
    <li><strong>Ceremony record.</strong> The JSON output contains the chain, seal, fingerprints, participants, and timestamp. Embed this in authority ledger entries as a <code>ceremony_proof</code> field.</li>
    <li><strong>Domino name.</strong> Maps the first two bytes of the chain seal to domino tile names for verbal verification. 784 possible combinations.</li>
    <li><strong>Deterministic.</strong> Same tile inputs and orientations always produce the same chain seal. Independent verification on air-gapped machines is possible.</li>
    <li><strong>No network calls.</strong> This file runs entirely in-browser. Verify by inspecting source or running with network disabled.</li>
  </ul>
</details>

</div><!-- /.wrap -->

<!-- ═══════════════ JAVASCRIPT ═══════════════ -->
<script>
"use strict";

/* ── State ──────────────────────────────────────────── */
var state={
  participants:[],
  chainHashBytes:null,
  chainFingerprint:"",
  chainHashHex:"",
  dominoFP:"",
  chainString:"",
  valid:false,
  sealed:false,
  currentStep:1
};

var encoder=new TextEncoder();

/* ── Domino Lookup Table (index 0-27 -> [a,b]) ────────── */
var DOMINO_TABLE=[];
(function(){
  for(var b=0;b<=6;b++){
    for(var a=0;a<=b;a++){
      DOMINO_TABLE.push([a,b]);
    }
  }
})();

var TILE_WORDS=["blank","one","two","three","four","five","six"];

function tileName(a,b){
  if(a===b)return "double-"+TILE_WORDS[a];
  var lo=Math.min(a,b),hi=Math.max(a,b);
  return TILE_WORDS[lo]+"-"+TILE_WORDS[hi];
}

/* Map first 2 bytes of hex to two domino tile names */
function dominoFingerprint(hex){
  if(!hex||hex.length<4)return "\u2014";
  var b0=parseInt(hex.substring(0,2),16);
  var b1=parseInt(hex.substring(2,4),16);
  var t0=DOMINO_TABLE[b0%28];
  var t1=DOMINO_TABLE[b1%28];
  return tileName(t0[0],t0[1])+", "+tileName(t1[0],t1[1]);
}

/* ── Pip positions per value (col,row in 3x3 grid) ────── */
var PIP_POS={
  0:[],
  1:[[1,1]],
  2:[[2,0],[0,2]],
  3:[[2,0],[1,1],[0,2]],
  4:[[0,0],[2,0],[0,2],[2,2]],
  5:[[0,0],[2,0],[1,1],[0,2],[2,2]],
  6:[[0,0],[2,0],[0,1],[2,1],[0,2],[2,2]]
};

function buildPipHalf(val){
  var half=document.createElement("div");
  half.className="tile-half";
  var positions=PIP_POS[val]||[];
  for(var i=0;i<positions.length;i++){
    var pip=document.createElement("div");
    pip.className="pip";
    pip.style.gridColumn=String(positions[i][0]+1);
    pip.style.gridRow=String(positions[i][1]+1);
    half.appendChild(pip);
  }
  return half;
}

/* ── Utility ──────────────────────────────────────────── */
function bytesToHex(bytes){
  var hex="";
  for(var i=0;i<bytes.length;i++)hex+=("0"+bytes[i].toString(16)).slice(-2);
  return hex;
}

function sha256Bytes(data){
  return window.crypto.subtle.digest("SHA-256",data).then(function(buf){
    return new Uint8Array(buf);
  });
}

function hkdfSha256(ikmBytes,saltBytes,infoBytes,length){
  return window.crypto.subtle.importKey(
    "raw",ikmBytes,{name:"HKDF"},false,["deriveBits"]
  ).then(function(key){
    return window.crypto.subtle.deriveBits(
      {name:"HKDF",hash:"SHA-256",salt:saltBytes,info:infoBytes},key,length*8
    );
  }).then(function(buf){return new Uint8Array(buf)});
}

function setOut(id,text,isEmpty){
  var el=document.getElementById(id);
  if(!el)return;
  el.textContent=text;
  if(isEmpty)el.classList.add("empty");else el.classList.remove("empty");
}

function setStatus(msg,level){
  var bar=document.getElementById("statusBar");
  bar.textContent=msg;
  bar.className="status-bar status-"+level;
}

function copyField(id,btn){
  var el=document.getElementById(id);
  if(!el||el.classList.contains("empty"))return;
  var text=el.textContent;
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(function(){
      var orig=btn.textContent;
      btn.textContent="COPIED!";btn.classList.add("copied");
      setTimeout(function(){btn.textContent=orig;btn.classList.remove("copied")},2000);
    });
  }else{
    var ta=document.createElement("textarea");
    ta.value=text;ta.style.position="fixed";ta.style.opacity="0";
    document.body.appendChild(ta);ta.select();
    try{document.execCommand("copy");
      var orig=btn.textContent;
      btn.textContent="COPIED!";btn.classList.add("copied");
      setTimeout(function(){btn.textContent=orig;btn.classList.remove("copied")},2000);
    }catch(e){/* fallback failed */}
    document.body.removeChild(ta);
  }
}

/* ── Tile Parsing (enhanced: accepts 2-5, 2 5, 2,5, (2,5)) ── */
function parseSingleTile(str){
  var s=(str||"").trim().replace(/[()]/g,"");
  if(!s)return{ok:false,error:"empty"};
  var parts=s.split(/[\s,\-]+/);
  if(parts.length!==2)return{ok:false,error:"Enter two numbers, e.g. 3-4"};
  var a=parseInt(parts[0],10);
  var b=parseInt(parts[1],10);
  if(isNaN(a)||isNaN(b))return{ok:false,error:"Use numbers 0\u20136"};
  if(a<0||a>6||b<0||b>6)return{ok:false,error:"Each side must be 0\u20136"};
  return{ok:true,a:a,b:b};
}

/* ── Wizard Navigation ──────────────────────────────────── */
function goToStep(n){
  if(n===state.currentStep||n<1||n>4)return;

  /* Going backward */
  if(n<state.currentStep){
    if(n===1){clearSeal()}
    showStep(n);
    if(n===2){refreshViz()}
    return;
  }

  /* Going forward from step 1 */
  if(state.currentStep===1){
    syncAllInputs();
    if(!allParsed()){setStatus("Enter a valid tile for every participant first.","warn");return}
    var c=checkChain();
    state.valid=c.valid;
    renderChainViz(c);
    updateSealBtn();
    if(!c.valid){showStep(2);setStatus(c.reason,"err");return}
    /* Valid chain: seal and advance */
    computeSeal(function(){
      showStep(n>3?3:n);
      if(n>3){setTimeout(function(){goToStep(n)},50)}
    });
    return;
  }

  /* Going forward from step 2 */
  if(state.currentStep===2){
    if(!state.valid){setStatus("Fix the chain before continuing.","warn");return}
    computeSeal(function(){
      showStep(n);
    });
    return;
  }

  /* Step 3 to 4: no validation */
  showStep(n);
}

function progClick(n){
  if(n<=state.currentStep||n===state.currentStep+1){
    goToStep(n);
  }
}

function showStep(n){
  state.currentStep=n;
  for(var i=1;i<=4;i++){
    var el=document.getElementById("step"+i);
    if(el){el.classList.toggle("active",i===n)}
  }
  updateProgressBar();
  window.scrollTo({top:0,behavior:"smooth"});
}

function updateProgressBar(){
  var steps=document.querySelectorAll(".prog-step");
  var lines=document.querySelectorAll(".prog-line");
  for(var i=0;i<steps.length;i++){
    var sn=i+1;
    steps[i].classList.toggle("active",sn===state.currentStep);
    steps[i].classList.toggle("done",sn<state.currentStep);
  }
  for(var i=0;i<lines.length;i++){
    lines[i].classList.toggle("done",i+1<state.currentStep);
  }
}

function updateSealBtn(){
  var btn=document.getElementById("sealBtn");
  if(btn)btn.disabled=!state.valid;
}

function allParsed(){
  for(var i=0;i<state.participants.length;i++){
    if(!state.participants[i].parsed)return false;
  }
  return true;
}

function clearSeal(){
  state.sealed=false;state.chainHashBytes=null;state.chainFingerprint="";
  state.chainHashHex="";state.dominoFP="";state.chainString="";state.valid=false;
}

function refreshViz(){
  syncAllInputs();
  var c=checkChain();
  state.valid=c.valid;
  renderChainViz(c);
  updateSealBtn();
}

function computeSeal(cb){
  if(state.sealed){renderSealRecord();if(cb)cb();return}
  state.chainString=buildChainString();
  sha256Bytes(encoder.encode(state.chainString)).then(function(h){
    state.chainHashBytes=h;
    state.chainHashHex=bytesToHex(h);
    state.chainFingerprint=state.chainHashHex.substring(0,16);
    state.dominoFP=dominoFingerprint(state.chainHashHex);
    state.sealed=true;
    renderSealRecord();
    setStatus("Chain sealed. Quick ID: "+state.chainFingerprint+" \u2022 "+state.dominoFP,"ok");
    if(cb)cb();
  });
}

/* ── Load Example ────────────────────────────────────── */
function loadExample(){
  state.participants=[
    {role:"Authority",tile:"3-4",a:3,b:4,parsed:true},
    {role:"Regional Lead",tile:"4-1",a:4,b:1,parsed:true},
    {role:"Field Operator",tile:"1-6",a:1,b:6,parsed:true}
  ];
  renderParticipants();
  setStatus("Example loaded: 3 participants with a valid chain. Click Next to continue.","ok");
}

/* ── Participant Management ────────────────────────────── */
function addParticipant(){
  if(state.participants.length>=8){
    setStatus("Maximum 8 participants.","warn");return;
  }
  state.participants.push({role:"",tile:"",a:-1,b:-1,parsed:false});
  renderParticipants();
}

function removeParticipant(idx){
  if(state.participants.length<=2){
    setStatus("Minimum 2 participants required.","warn");return;
  }
  state.participants.splice(idx,1);
  renderParticipants();
  clearSeal();
}

function flipTile(idx){
  var p=state.participants[idx];
  if(!p.parsed)return;
  var tmp=p.a;p.a=p.b;p.b=tmp;
  p.tile=p.a+"-"+p.b;
  renderParticipants();
  clearSeal();
}

function syncAllInputs(){
  for(var i=0;i<state.participants.length;i++){syncParticipantInput(i)}
}

function syncParticipantInput(idx){
  var row=document.getElementById("p-row-"+idx);
  if(!row)return;
  var p=state.participants[idx];
  p.tile=row.querySelector(".p-tile-input").value;
  p.role=row.querySelector(".p-role").value;
  var result=parseSingleTile(p.tile);
  if(result.ok){p.a=result.a;p.b=result.b;p.parsed=true}
  else{p.a=-1;p.b=-1;p.parsed=false}
  /* Update inline preview/error */
  var preview=row.querySelector(".tile-preview");
  if(!preview)return;
  if(p.parsed){
    preview.textContent=p.a+"|"+p.b;
    preview.className="tile-preview";
    preview.style.display="";
  }else if(p.tile.trim()){
    preview.textContent=result.error;
    preview.className="tile-preview tile-err";
    preview.style.display="";
  }else{
    preview.textContent="";
    preview.style.display="none";
  }
  state.sealed=false;
  renderTilePalette();
}

function renderParticipants(){
  var container=document.getElementById("participantList");
  container.innerHTML="";
  for(var i=0;i<state.participants.length;i++){
    var p=state.participants[i];
    var row=document.createElement("div");
    row.className="p-row";row.id="p-row-"+i;

    var num=document.createElement("span");
    num.className="p-num";num.textContent=String(i+1);

    var role=document.createElement("input");
    role.type="text";role.className="p-role";
    role.placeholder=i===0?"e.g. Authority":"e.g. Delegate";
    role.value=p.role;
    role.oninput=(function(idx){return function(){syncParticipantInput(idx)}})(i);

    var tileWrap=document.createElement("div");
    tileWrap.className="tile-input-wrap";

    var tile=document.createElement("input");
    tile.type="text";tile.className="p-tile-input";
    tile.placeholder="3-4";tile.value=p.tile;
    tile.title="Two numbers 0-6: e.g. 3-4 or 2,5 or (1 6)";
    tile.oninput=(function(idx){return function(){syncParticipantInput(idx)}})(i);

    var preview=document.createElement("span");
    preview.className="tile-preview";
    if(p.parsed){preview.textContent=p.a+"|"+p.b}
    else{preview.style.display="none"}

    tileWrap.appendChild(tile);
    tileWrap.appendChild(preview);

    var flip=document.createElement("button");
    flip.className="p-flip";flip.textContent="\u21c4";flip.title="Flip tile orientation";
    flip.onclick=(function(idx){return function(){flipTile(idx)}})(i);

    var rem=document.createElement("button");
    rem.className="p-remove";rem.textContent="\u2715";rem.title="Remove";
    rem.onclick=(function(idx){return function(){removeParticipant(idx)}})(i);

    row.appendChild(num);row.appendChild(role);row.appendChild(tileWrap);
    row.appendChild(flip);row.appendChild(rem);
    container.appendChild(row);
  }
  renderTilePalette();
}

/* ── Tile Palette (all 28 tiles in a double-six set) ───── */
function getUsedTiles(){
  var used={};
  for(var i=0;i<state.participants.length;i++){
    var p=state.participants[i];
    if(!p.parsed)continue;
    var lo=Math.min(p.a,p.b),hi=Math.max(p.a,p.b);
    used[lo+"-"+hi]=i;
  }
  return used;
}

function renderTilePalette(){
  var pal=document.getElementById("tilePalette");
  if(!pal)return;
  pal.innerHTML="";
  var used=getUsedTiles();
  var avail=28-Object.keys(used).length;
  for(var t=0;t<DOMINO_TABLE.length;t++){
    var pair=DOMINO_TABLE[t];
    var a=pair[0],b=pair[1];
    var key=a+"-"+b;
    var el=document.createElement("div");
    var taken=used[key]!==undefined;
    el.className="pal-tile"+(taken?" pal-used":"");
    el.title=tileName(a,b)+(taken?" (participant "+(used[key]+1)+")":"");
    var s1=document.createElement("span");s1.textContent=String(a);
    var sep=document.createElement("span");sep.className="pal-sep";
    var s2=document.createElement("span");s2.textContent=String(b);
    el.appendChild(s1);el.appendChild(sep);el.appendChild(s2);
    if(!taken){
      el.onclick=(function(aa,bb){return function(){pickTile(aa,bb)}})(a,b);
    }
    pal.appendChild(el);
  }
  var ct=document.getElementById("palCount");
  if(ct)ct.textContent=avail+" of 28 available";
}

function pickTile(a,b){
  /* Assign to the first participant without a valid tile */
  var idx=-1;
  for(var i=0;i<state.participants.length;i++){
    if(!state.participants[i].parsed){idx=i;break}
  }
  if(idx===-1){
    setStatus("All participants already have tiles. Add another person or clear one.","warn");return;
  }
  state.participants[idx].tile=a+"-"+b;
  state.participants[idx].a=a;
  state.participants[idx].b=b;
  state.participants[idx].parsed=true;
  renderParticipants();
  setStatus("Assigned "+a+"|"+b+" ("+tileName(a,b)+") to participant "+(idx+1)+".","ok");
  state.sealed=false;
}

/* ── Chain Validation ──────────────────────────────────── */
function checkChain(){
  for(var i=0;i<state.participants.length;i++){
    if(!state.participants[i].parsed)return{valid:false,breakAt:-1,reason:"Not all tiles entered"};
  }
  /* Duplicate check: a physical set has only one of each tile (a-b === b-a) */
  var seen={};
  for(var i=0;i<state.participants.length;i++){
    var p=state.participants[i];
    var lo=Math.min(p.a,p.b),hi=Math.max(p.a,p.b);
    var key=lo+"-"+hi;
    if(seen[key]!==undefined){
      return{valid:false,breakAt:-1,
        reason:"Duplicate tile: participants "+(seen[key]+1)+" and "+(i+1)+" both drew "+lo+"-"+hi+". A set has only one of each tile."};
    }
    seen[key]=i;
  }
  for(var i=1;i<state.participants.length;i++){
    if(state.participants[i-1].b!==state.participants[i].a){
      return{valid:false,breakAt:i,reason:"Break at position "+(i+1)+": right("+state.participants[i-1].b+") \u2260 left("+state.participants[i].a+")"};
    }
  }
  return{valid:true,breakAt:-1,reason:"Valid chain of "+state.participants.length};
}

function buildChainString(){
  return state.participants.map(function(p){return p.a+"-"+p.b}).join(" \u2192 ");
}

function getFixSuggestion(breakAt){
  if(breakAt<1)return null;
  var prev=state.participants[breakAt-1];
  var curr=state.participants[breakAt];
  /* Would flipping curr fix the left connection? */
  if(prev.b===curr.b){
    return{
      msg:"Tile "+(breakAt+1)+" shows "+curr.a+"|"+curr.b+" but needs "+prev.b+" on the left. Flipping it to "+curr.b+"|"+curr.a+" would connect.",
      idx:breakAt
    };
  }
  /* Would flipping prev fix it? */
  if(prev.a===curr.a){
    return{
      msg:"Tile "+breakAt+" shows "+prev.a+"|"+prev.b+" but needs "+curr.a+" on the right. Flipping it to "+prev.b+"|"+prev.a+" would connect.",
      idx:breakAt-1
    };
  }
  return null;
}

/* ── Chain Visualization ──────────────────────────────── */
function renderChainViz(check){
  var viz=document.getElementById("chainViz");
  viz.innerHTML="";

  for(var i=0;i<state.participants.length;i++){
    var p=state.participants[i];
    if(!p.parsed)continue;

    /* Arrow between tiles */
    if(i>0){
      var arrow=document.createElement("div");
      arrow.className="chain-arrow";
      var connected=state.participants[i-1].b===p.a;
      arrow.classList.add(connected?"a-ok":"a-fail");
      arrow.textContent=connected?"\u2192":"\u2717";
      viz.appendChild(arrow);
    }

    /* Tile */
    var tileDiv=document.createElement("div");
    tileDiv.className="domino-tile";

    var face=document.createElement("div");
    face.className="tile-face";
    var leftOk=i===0||state.participants[i-1].b===p.a;
    var rightOk=i===state.participants.length-1||!state.participants[i+1]||!state.participants[i+1].parsed||p.b===state.participants[i+1].a;
    face.classList.add(leftOk&&rightOk?"t-ok":"t-broken");

    face.appendChild(buildPipHalf(p.a));
    face.appendChild(buildPipHalf(p.b));
    tileDiv.appendChild(face);

    var label=document.createElement("div");
    label.className="tile-label";
    label.textContent=tileName(p.a,p.b);
    tileDiv.appendChild(label);

    var roleLabel=document.createElement("div");
    roleLabel.className="tile-label";
    roleLabel.style.color="var(--neon-purple)";
    roleLabel.textContent=p.role||(i===0?"Authority":"Delegate L"+i);
    tileDiv.appendChild(roleLabel);

    viz.appendChild(tileDiv);
  }

  var cs=document.getElementById("chainStatus");
  cs.textContent=check.reason;
  cs.className="status-bar status-"+(check.valid?"ok":"err");

  /* Fix suggestion */
  var fixBox=document.getElementById("fixSuggestion");
  fixBox.innerHTML="";
  if(!check.valid&&check.breakAt>0){
    var fix=getFixSuggestion(check.breakAt);
    if(fix){
      var div=document.createElement("div");
      div.className="fix-box";
      var span=document.createElement("span");
      span.textContent="Tip: "+fix.msg;
      var btn=document.createElement("button");
      btn.className="btn btn-primary btn-sm";
      btn.textContent="Flip Tile "+(fix.idx+1);
      btn.onclick=(function(idx){return function(){applyFix(idx)}})(fix.idx);
      div.appendChild(span);
      div.appendChild(btn);
      fixBox.appendChild(div);
    }
  }
}

function applyFix(idx){
  flipTile(idx);
  syncAllInputs();
  var c=checkChain();
  state.valid=c.valid;
  renderChainViz(c);
  updateSealBtn();
  if(c.valid){
    computeSeal(function(){
      setStatus("Fixed! Valid chain of "+state.participants.length+". Ready to seal.","ok");
    });
  }
}

/* ── Seal Record ──────────────────────────────────────── */
function renderSealRecord(){
  setOut("chainFP",state.chainFingerprint,false);
  setOut("chainDominoFP",state.dominoFP,false);
  setOut("chainStr",state.chainString,false);
  setOut("chainHash",state.chainHashHex,false);
  var record=buildCeremonyRecord();
  setOut("ceremonyJSON",JSON.stringify(record,null,2),false);
}

function buildCeremonyRecord(){
  return{
    ceremony_type:"delegation_chain",
    chain:state.chainString,
    chain_hash:state.chainHashHex,
    chain_fingerprint:state.chainFingerprint,
    domino_fingerprint:state.dominoFP,
    participants:state.participants.map(function(p,i){
      return{position:i+1,role:p.role||(i===0?"Authority":"Delegate L"+i),tile:p.a+"-"+p.b};
    }),
    timestamp:new Date().toISOString(),
    valid:true
  };
}

/* ── Download / Copy / Load JSON ──────────────────────── */
function downloadJSON(){
  if(!state.sealed){setStatus("Seal the chain first.","warn");return}
  var record=buildCeremonyRecord();
  var json=JSON.stringify(record,null,2);
  var blob=new Blob([json],{type:"application/json"});
  var url=URL.createObjectURL(blob);
  var a=document.createElement("a");
  a.href=url;
  a.download="chain-record-"+state.chainFingerprint+".json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  setStatus("Record downloaded.","ok");
}

function copyJSON(btn){
  if(!state.sealed){setStatus("Seal the chain first.","warn");return}
  var record=buildCeremonyRecord();
  var json=JSON.stringify(record,null,2);
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(json).then(function(){
      if(btn){
        btn.textContent="COPIED!";btn.classList.add("copied");
        setTimeout(function(){btn.textContent="COPY JSON";btn.classList.remove("copied")},2000);
      }
      setStatus("JSON copied to clipboard.","ok");
    });
  }
}

function loadJSONFile(input){
  if(!input.files||!input.files[0])return;
  var reader=new FileReader();
  reader.onload=function(e){
    document.getElementById("verifyInput").value=e.target.result;
    setStatus("JSON loaded into verifier. Click Verify to check.","ok");
  };
  reader.readAsText(input.files[0]);
  input.value="";
}

/* ── Tab Switching ────────────────────────────────────── */
function switchTab(name){
  var tabs=document.querySelectorAll(".tab");
  var panels=document.querySelectorAll(".tab-panel");
  for(var i=0;i<tabs.length;i++){
    tabs[i].classList.toggle("active",tabs[i].getAttribute("data-tab")===name);
  }
  for(var i=0;i<panels.length;i++){
    panels[i].classList.toggle("active",panels[i].id==="tab-"+name);
  }
}

/* ── Chain Verifier ────────────────────────────────────── */
function verifyRecord(){
  var input=document.getElementById("verifyInput").value.trim();
  var banner=document.getElementById("verifyBanner");
  var details=document.getElementById("verifyDetails");

  if(!input){
    banner.style.display="none";
    details.innerHTML="";
    setStatus("Paste or load a ceremony record first.","warn");
    return;
  }

  var record;
  try{record=JSON.parse(input)}catch(e){
    banner.style.display="";
    banner.className="verify-banner fail";
    banner.textContent="\u2717 INVALID JSON";
    details.innerHTML="<div class='verify-check check-fail'><span>\u2717</span> "+e.message+"</div>";
    setStatus("Verification FAILED: invalid JSON.","err");
    return;
  }

  if(!record.chain||!record.chain_hash){
    banner.style.display="";
    banner.className="verify-banner fail";
    banner.textContent="\u2717 INCOMPLETE";
    details.innerHTML="<div class='verify-check check-fail'><span>\u2717</span> Missing required fields: chain, chain_hash</div>";
    setStatus("Verification FAILED: missing fields.","err");
    return;
  }

  /* Re-validate chain connectivity */
  var tiles=record.chain.split(" \u2192 ").map(function(t){
    var parts=t.trim().split("-");
    return{a:parseInt(parts[0],10),b:parseInt(parts[1],10)};
  });

  var chainValid=true;var breakIdx=-1;
  for(var i=1;i<tiles.length;i++){
    if(tiles[i-1].b!==tiles[i].a){chainValid=false;breakIdx=i;break}
  }

  /* Re-hash chain string */
  sha256Bytes(encoder.encode(record.chain)).then(function(hash){
    var computedHash=bytesToHex(hash);
    var hashMatch=computedHash===record.chain_hash;

    var checks=[];
    checks.push({pass:hashMatch,label:"Seal integrity",
      detail:hashMatch?"Computed seal matches recorded seal":"Seal mismatch (computed "+computedHash.substring(0,16)+"\u2026)"});
    checks.push({pass:chainValid,label:"Chain connectivity",
      detail:chainValid?"All tiles connect properly":"Break at position "+(breakIdx+1)});

    if(record.chain_fingerprint){
      var fpMatch=computedHash.substring(0,16)===record.chain_fingerprint;
      checks.push({pass:fpMatch,label:"Quick ID",detail:fpMatch?"Matches":"Mismatch"});
    }
    if(record.domino_fingerprint){
      var domFP=dominoFingerprint(computedHash);
      checks.push({pass:domFP===record.domino_fingerprint,label:"Domino name",
        detail:domFP===record.domino_fingerprint?"Matches":"Mismatch"});
    }

    var allPass=hashMatch&&chainValid;
    banner.style.display="";
    banner.className="verify-banner "+(allPass?"pass":"fail");
    banner.textContent=allPass?"\u2713 VERIFIED":"\u2717 FAILED";

    var html="<div class='verify-checks'>";
    for(var i=0;i<checks.length;i++){
      html+="<div class='verify-check "+(checks[i].pass?"check-pass":"check-fail")+"'>"+
        "<span>"+(checks[i].pass?"\u2713":"\u2717")+"</span> "+
        "<strong>"+checks[i].label+"</strong> &mdash; "+checks[i].detail+"</div>";
    }
    html+="</div>";
    details.innerHTML=html;
    setStatus(allPass?"Verification PASSED":"Verification FAILED",allPass?"ok":"err");
  });
}

/* ── Encrypt / Decrypt ─────────────────────────────────── */
function deriveChainKey(chainHashBytes,passphrase){
  var passBytes=encoder.encode(passphrase);
  return sha256Bytes(passBytes).then(function(saltBytes){
    return hkdfSha256(chainHashBytes,saltBytes,encoder.encode("EDGE/CHAIN/ENC"),32);
  }).then(function(keyBytes){
    return window.crypto.subtle.importKey("raw",keyBytes,{name:"AES-GCM"},false,["encrypt","decrypt"]);
  });
}

function encryptPayload(){
  if(!state.chainHashBytes||!state.valid){
    setStatus("Build and seal a valid chain first (steps 1\u20133).","warn");return;
  }
  var pass=document.getElementById("encPass").value;
  if(!pass){setStatus("Enter a passphrase.","warn");return}
  var plain=document.getElementById("encPlain").value;
  if(!plain){setStatus("Enter a message to lock.","warn");return}

  var iv=window.crypto.getRandomValues(new Uint8Array(12));
  var plainBytes=encoder.encode(plain);

  deriveChainKey(state.chainHashBytes,pass).then(function(key){
    return window.crypto.subtle.encrypt({name:"AES-GCM",iv:iv},key,plainBytes);
  }).then(function(cipherBuf){
    var cipher=new Uint8Array(cipherBuf);
    var combined=new Uint8Array(iv.length+cipher.length);
    combined.set(iv,0);combined.set(cipher,iv.length);
    var binary="";
    for(var i=0;i<combined.length;i++)binary+=String.fromCharCode(combined[i]);
    setOut("encOutput",btoa(binary),false);
    setStatus("Message locked. Chain: "+state.chainFingerprint+" ("+state.dominoFP+")","ok");
  }).catch(function(e){
    setStatus("Lock error: "+e.message,"err");
  });
}

function decryptPayload(){
  if(!state.chainHashBytes||!state.valid){
    setStatus("Build and seal a valid chain first (steps 1\u20133).","warn");return;
  }
  var pass=document.getElementById("decPass").value;
  if(!pass){setStatus("Enter the passphrase.","warn");return}
  var b64=document.getElementById("decCipher").value.trim();
  if(!b64){setStatus("Paste the locked text.","warn");return}

  var binary;
  try{binary=atob(b64)}catch(e){
    setStatus("Invalid base64 input.","err");return;
  }

  var combined=new Uint8Array(binary.length);
  for(var i=0;i<binary.length;i++)combined[i]=binary.charCodeAt(i);
  if(combined.length<29){
    /* 12 IV + 16 GCM tag + at least 1 byte ciphertext */
    setStatus("Locked text too short.","err");return;
  }

  var iv=combined.slice(0,12);
  var cipher=combined.slice(12);

  deriveChainKey(state.chainHashBytes,pass).then(function(key){
    return window.crypto.subtle.decrypt({name:"AES-GCM",iv:iv},key,cipher);
  }).then(function(plainBuf){
    var plaintext=new TextDecoder().decode(plainBuf);
    setOut("decOutput",plaintext,false);
    setStatus("Message unlocked successfully.","ok");
  }).catch(function(){
    setOut("decOutput","Decryption failed",true);
    setStatus("Could not unlock \u2014 wrong chain or passphrase.","err");
  });
}

/* ── Reset ─────────────────────────────────────────────── */
function resetAll(){
  state.participants=[
    {role:"",tile:"",a:-1,b:-1,parsed:false},
    {role:"",tile:"",a:-1,b:-1,parsed:false}
  ];
  clearSeal();

  var ids=["chainStr","chainHash","chainFP","chainDominoFP","ceremonyJSON"];
  for(var i=0;i<ids.length;i++)setOut(ids[i],"\u2014",true);
  setOut("encOutput","No output yet",true);
  setOut("decOutput","No output yet",true);

  document.getElementById("verifyInput").value="";
  document.getElementById("verifyBanner").style.display="none";
  document.getElementById("verifyDetails").innerHTML="";
  document.getElementById("encPass").value="";
  document.getElementById("encPlain").value="";
  document.getElementById("decPass").value="";
  document.getElementById("decCipher").value="";

  renderParticipants();
  showStep(1);
  setStatus("Ready \u2014 add participants and enter domino tiles, or try an example.","idle");
}

/* ── Init ──────────────────────────────────────────────── */
state.participants=[
  {role:"",tile:"",a:-1,b:-1,parsed:false},
  {role:"",tile:"",a:-1,b:-1,parsed:false}
];
renderParticipants();
</script>

</body>
</html>
