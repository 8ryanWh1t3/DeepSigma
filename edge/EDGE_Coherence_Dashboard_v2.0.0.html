<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDGE Coherence Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --accent: #f97316;
            --accent-glow: rgba(249, 115, 22, 0.4);
            --success: #22c55e;
            --success-glow: rgba(34, 197, 94, 0.4);
            --warning: #eab308;
            --warning-glow: rgba(234, 179, 8, 0.4);
            --danger: #ef4444;
            --danger-glow: rgba(239, 68, 68, 0.4);
            --info: #3b82f6;
            --info-glow: rgba(59, 130, 246, 0.4);
            --purple: #8b5cf6;
            
            --bg-primary: #030712;
            --bg-secondary: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --bg-input: #0f172a;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --border-hover: #475569;
        }

        .light-theme {
            --bg-primary: #f1f5f9;
            --bg-secondary: #e2e8f0;
            --bg-card: #ffffff;
            --bg-card-hover: #f8fafc;
            --bg-input: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --border-hover: #cbd5e1;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
            overflow: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* Layout */
        .app {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.3s;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar.collapsed .logo-text,
        .sidebar.collapsed .nav-text,
        .sidebar.collapsed .search-container,
        .sidebar.collapsed .sidebar-footer-content,
        .sidebar.collapsed .nav-label,
        .sidebar.collapsed .nav-badge {
            display: none;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent), #ea580c);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 12px;
            color: white;
            flex-shrink: 0;
        }

        .logo-text h1 {
            font-size: 14px;
            font-weight: 700;
        }

        .logo-text p {
            font-size: 10px;
            color: var(--text-muted);
        }

        .collapse-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .collapse-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .search-container {
            padding: 12px 16px;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 8px 10px 8px 32px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 12px;
        }

        .nav {
            flex: 1;
            padding: 8px;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 16px;
        }

        .nav-label {
            padding: 8px 12px 4px;
            font-size: 9px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .nav-item:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent);
            color: white;
        }

        .nav-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .nav-badge {
            margin-left: auto;
            padding: 2px 6px;
            background: var(--danger);
            color: white;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
        }

        .nav-item.active .nav-badge {
            background: rgba(255,255,255,0.3);
        }

        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
        }

        .sidebar-footer-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            background: var(--bg-card);
            border-radius: 6px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .toggle-switch {
            width: 36px;
            height: 20px;
            background: var(--border);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--accent);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(16px);
        }

        /* Main */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }

        /* Header */
        .header {
            padding: 12px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .page-title {
            font-size: 18px;
            font-weight: 700;
        }

        .header-tabs {
            display: flex;
            gap: 2px;
            background: var(--bg-card);
            padding: 3px;
            border-radius: 8px;
        }

        .header-tab {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-tab:hover {
            color: var(--text-primary);
        }

        .header-tab.active {
            background: var(--accent);
            color: white;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .live-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 16px;
            font-size: 10px;
            color: var(--success);
            font-weight: 600;
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .timestamp {
            font-family: 'SF Mono', 'Consolas', monospace;
            font-size: 11px;
            color: var(--text-muted);
        }

        .btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            border: none;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            justify-content: center;
        }

        /* Content */
        .content-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 16px;
        }

        .grid-3 {
            grid-template-columns: 260px 1fr 300px;
        }

        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .grid-2-1 {
            grid-template-columns: 2fr 1fr;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: var(--border-hover);
        }

        .card-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-body {
            padding: 16px;
        }

        .card-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-success { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .badge-warning { background: rgba(234, 179, 8, 0.15); color: var(--warning); }
        .badge-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .badge-info { background: rgba(59, 130, 246, 0.15); color: var(--info); }

        /* CI Gauge */
        .ci-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .ci-gauge {
            position: relative;
            width: 160px;
            height: 90px;
        }

        .gauge-track {
            fill: none;
            stroke: var(--border);
            stroke-width: 12;
        }

        .gauge-fill {
            fill: none;
            stroke: url(#ciGradient);
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 201;
            stroke-dashoffset: 201;
            transition: stroke-dashoffset 2s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 6px var(--success-glow));
        }

        .ci-value-box {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        .ci-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--success);
            line-height: 1;
        }

        .ci-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ci-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            padding: 4px 12px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 16px;
            font-size: 10px;
            font-weight: 700;
            color: var(--success);
            text-transform: uppercase;
        }

        .ci-trend {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .ci-trend-item {
            text-align: center;
        }

        .ci-trend-label {
            font-size: 9px;
            color: var(--text-muted);
        }

        .ci-trend-value {
            font-size: 13px;
            font-weight: 700;
            margin-top: 2px;
        }

        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .metric-card {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 14px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .metric-card.blue::before { background: var(--info); }
        .metric-card.yellow::before { background: var(--warning); }
        .metric-card.red::before { background: var(--danger); }
        .metric-card.orange::before { background: var(--accent); }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .metric-icon {
            font-size: 18px;
        }

        .metric-change {
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .metric-change.up { color: var(--success); }
        .metric-change.down { color: var(--danger); }

        .metric-value {
            font-size: 28px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 2px;
        }

        .metric-card.blue .metric-value { color: var(--info); }
        .metric-card.yellow .metric-value { color: var(--warning); }
        .metric-card.red .metric-value { color: var(--danger); }
        .metric-card.orange .metric-value { color: var(--accent); }

        .metric-label {
            font-size: 10px;
            color: var(--text-muted);
        }

        .metric-spark {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 20px;
            margin-top: 8px;
        }

        .spark-bar {
            flex: 1;
            background: currentColor;
            opacity: 0.25;
            border-radius: 1px;
        }

        .metric-card:hover .spark-bar {
            opacity: 0.4;
        }

        /* Activity */
        .activity-feed {
            max-height: 240px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .activity-item:hover {
            background: var(--bg-secondary);
            margin: 0 -16px;
            padding: 10px 16px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .activity-icon.create { background: rgba(34, 197, 94, 0.15); }
        .activity-icon.update { background: rgba(59, 130, 246, 0.15); }
        .activity-icon.challenge { background: rgba(239, 68, 68, 0.15); }
        .activity-icon.expire { background: rgba(234, 179, 8, 0.15); }

        .activity-content {
            flex: 1;
            min-width: 0;
        }

        .activity-title {
            font-size: 12px;
            font-weight: 600;
        }

        .activity-desc {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .activity-time {
            font-size: 10px;
            color: var(--text-muted);
            white-space: nowrap;
        }

        /* Bar Chart */
        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .bar-row {
            display: grid;
            grid-template-columns: 100px 1fr 40px;
            align-items: center;
            gap: 10px;
        }

        .bar-label {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bar-track {
            height: 20px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 4px;
            width: 0;
            transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bar-fill.blue { background: linear-gradient(90deg, #2563eb, #3b82f6); }
        .bar-fill.green { background: linear-gradient(90deg, #16a34a, #22c55e); }
        .bar-fill.yellow { background: linear-gradient(90deg, #ca8a04, #eab308); }
        .bar-fill.purple { background: linear-gradient(90deg, #7c3aed, #8b5cf6); }
        .bar-fill.pink { background: linear-gradient(90deg, #db2777, #ec4899); }
        .bar-fill.teal { background: linear-gradient(90deg, #0d9488, #14b8a6); }
        .bar-fill.orange { background: linear-gradient(90deg, #ea580c, #f97316); }

        .bar-value {
            font-size: 12px;
            font-weight: 700;
            text-align: right;
        }

        /* Donut */
        .donut-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .donut-chart {
            position: relative;
            width: 120px;
            height: 120px;
            flex-shrink: 0;
        }

        .donut-chart svg {
            transform: rotate(-90deg);
        }

        .donut-segment {
            fill: none;
            stroke-width: 16;
            stroke-dasharray: 0 314;
            transition: stroke-dasharray 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .donut-value {
            font-size: 22px;
            font-weight: 800;
        }

        .donut-label {
            font-size: 9px;
            color: var(--text-muted);
        }

        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .legend-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 2px;
        }

        .legend-dot.green { background: var(--success); }
        .legend-dot.yellow { background: var(--warning); }
        .legend-dot.red { background: var(--danger); }
        .legend-dot.gray { background: #64748b; }

        .legend-text {
            font-size: 11px;
            color: var(--text-secondary);
            flex: 1;
        }

        .legend-value {
            font-size: 11px;
            font-weight: 700;
        }

        /* Blast Radius - Interactive SVG */
        .blast-container {
            position: relative;
            height: 280px;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
        }

        .blast-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .blast-line {
            stroke: var(--border);
            stroke-width: 2;
            fill: none;
            stroke-dasharray: 5 3;
            animation: dashMove 1s linear infinite;
        }

        @keyframes dashMove {
            to { stroke-dashoffset: -8; }
        }

        .blast-node {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .blast-node:hover {
            transform: scale(1.1);
        }

        .node-circle {
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));
        }

        .node-text {
            fill: white;
            font-size: 9px;
            font-weight: 700;
            text-anchor: middle;
            dominant-baseline: middle;
        }

        .node-label {
            fill: var(--text-muted);
            font-size: 8px;
            text-anchor: middle;
        }

        .blast-legend {
            position: absolute;
            bottom: 12px;
            left: 12px;
            display: flex;
            gap: 16px;
        }

        .blast-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 10px;
            color: var(--text-muted);
        }

        .blast-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .blast-legend-dot.root { background: var(--danger); }
        .blast-legend-dot.level1 { background: var(--warning); }
        .blast-legend-dot.level2 { background: var(--info); }

        /* Calendar Widget */
        .calendar-widget {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-header {
            text-align: center;
            font-size: 9px;
            font-weight: 700;
            color: var(--text-muted);
            padding: 4px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg-card-hover);
        }

        .calendar-day.today {
            background: var(--accent);
            color: white;
            font-weight: 700;
        }

        .calendar-day.has-expiry::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--danger);
        }

        .calendar-day.muted {
            color: var(--text-muted);
        }

        /* Alerts */
        .alerts-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 3px solid;
            cursor: pointer;
            transition: all 0.2s;
        }

        .alert-item:hover {
            transform: translateX(4px);
        }

        .alert-item.critical { border-left-color: var(--danger); }
        .alert-item.warning { border-left-color: var(--warning); }

        .alert-icon {
            font-size: 14px;
        }

        .alert-content {
            flex: 1;
            min-width: 0;
        }

        .alert-title {
            font-size: 11px;
            font-weight: 700;
        }

        .alert-desc {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .alert-meta {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 3px;
        }

        .alert-actions {
            display: flex;
            gap: 4px;
        }

        .alert-btn {
            padding: 4px 8px;
            font-size: 9px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .alert-btn-primary {
            background: var(--accent);
            color: white;
            border: none;
        }

        .alert-btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .alert-btn:hover {
            transform: scale(1.05);
        }

        /* Goals */
        .goals-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .goal-row {
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .goal-row:hover {
            background: var(--bg-card-hover);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .goal-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .goal-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .goal-dot.green { background: var(--success); }
        .goal-dot.yellow { background: var(--warning); }

        .goal-title {
            font-size: 12px;
            font-weight: 600;
        }

        .goal-pct {
            font-size: 13px;
            font-weight: 800;
        }

        .goal-pct.green { color: var(--success); }
        .goal-pct.yellow { color: var(--warning); }

        .goal-bar {
            height: 5px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .dimension-fill {
            height: 100%;
            border-radius: 3px;
            width: 0;
            transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dimension-fill.green { background: var(--success); }
        .dimension-fill.yellow { background: var(--warning); }
        .dimension-fill.red { background: var(--danger); }

        .goal-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Claims Table */
        .table-wrapper {
            overflow-x: auto;
        }

        .claims-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .claims-table th {
            text-align: left;
            padding: 10px 12px;
            background: var(--bg-secondary);
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .claims-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .claims-table tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        .claims-table tr:hover td {
            background: var(--bg-secondary);
        }

        .claim-id {
            font-family: 'SF Mono', monospace;
            font-weight: 600;
            color: var(--accent);
        }

        .claim-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 700;
        }

        /* truthType badges (DeepSigma claim.schema.json) */
        .claim-type.observation { background: rgba(59, 130, 246, 0.15); color: var(--info); }
        .claim-type.inference { background: rgba(139, 92, 246, 0.15); color: var(--purple); }
        .claim-type.assumption { background: rgba(234, 179, 8, 0.15); color: var(--warning); }
        .claim-type.forecast { background: rgba(249, 115, 22, 0.15); color: var(--accent); }
        .claim-type.norm { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .claim-type.constraint { background: rgba(239, 68, 68, 0.15); color: var(--danger); }

        /* statusLight indicator (green/yellow/red) */
        .status-light {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            text-transform: capitalize;
        }

        .status-light::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-light.green::before { background: var(--success); box-shadow: 0 0 4px var(--success-glow); }
        .status-light.yellow::before { background: var(--warning); box-shadow: 0 0 4px var(--warning-glow); }
        .status-light.red::before { background: var(--danger); box-shadow: 0 0 4px var(--danger-glow); }

        /* Coherence Dimension bars */
        .dimension-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        .dimension-row:last-child { border-bottom: none; }
        .dimension-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dimension-name {
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .dimension-weight {
            font-size: 9px;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 1px 5px;
            border-radius: 3px;
        }
        .dimension-score {
            font-size: 13px;
            font-weight: 700;
        }
        .dimension-bar {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
        }
        .dimension-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 1s ease;
            width: 0;
        }
        .dimension-fill.green { background: var(--success); }
        .dimension-fill.yellow { background: var(--warning); }
        .dimension-fill.red { background: var(--danger); }

        /* Grade badge */
        .grade-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 16px;
            margin-left: 8px;
        }
        .grade-badge.A { background: rgba(34,197,94,0.2); color: var(--success); }
        .grade-badge.B { background: rgba(59,130,246,0.2); color: var(--info); }
        .grade-badge.C { background: rgba(234,179,8,0.2); color: var(--warning); }
        .grade-badge.D { background: rgba(249,115,22,0.2); color: var(--accent); }
        .grade-badge.F { background: rgba(239,68,68,0.2); color: var(--danger); }

        /* Drift panel styles */
        .drift-signal {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }
        .drift-signal:hover { background: var(--bg-card-hover); }
        .drift-signal.severity-red { border-left-color: var(--danger); }
        .drift-signal.severity-yellow { border-left-color: var(--warning); }
        .drift-signal.severity-green { border-left-color: var(--success); }
        .drift-type-badge {
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-card);
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        .drift-severity {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .drift-severity.red { background: var(--danger); }
        .drift-severity.yellow { background: var(--warning); }
        .drift-severity.green { background: var(--success); }
        .drift-content {
            flex: 1;
            min-width: 0;
        }
        .drift-title {
            font-size: 12px;
            font-weight: 600;
        }
        .drift-meta {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .drift-patch-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(139,92,246,0.15);
            color: var(--purple);
        }
        .drift-summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        .drift-summary-card {
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            text-align: center;
        }
        .drift-summary-value {
            font-size: 24px;
            font-weight: 800;
        }
        .drift-summary-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Graph edge colors (blast radius) */
        .blast-edge-depends { stroke: var(--info); }
        .blast-edge-contradicts { stroke: var(--danger); stroke-dasharray: 6,3; }
        .blast-edge-supersedes { stroke: var(--accent); stroke-dasharray: 3,3; }
        .blast-edge-supports { stroke: var(--success); }
        .blast-edge-patches { stroke: var(--purple); stroke-dasharray: 6,3; }

        .blast-legend-edge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: var(--text-secondary);
        }
        .blast-legend-line {
            width: 20px;
            height: 2px;
        }

        /* Half-life indicator */
        .halflife-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-secondary);
        }
        .halflife-badge.urgent { background: rgba(239,68,68,0.15); color: var(--danger); }
        .halflife-badge.warning { background: rgba(234,179,8,0.15); color: var(--warning); }
        .halflife-badge.ok { background: rgba(34,197,94,0.15); color: var(--success); }

        /* Confidence bar in table */
        .conf-bar {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .conf-bar-track {
            flex: 1;
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            overflow: hidden;
            min-width: 40px;
        }
        .conf-bar-fill {
            height: 100%;
            border-radius: 2px;
        }
        .conf-bar-value {
            font-size: 10px;
            font-weight: 600;
            min-width: 28px;
            text-align: right;
        }

        /* IRIS query results */
        .iris-result {
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 6px;
            border-left: 3px solid var(--accent);
        }
        .iris-result-title {
            font-size: 12px;
            font-weight: 600;
        }
        .iris-result-body {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .iris-provenance {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: toastIn 0.3s ease;
            min-width: 280px;
        }

        .toast.removing {
            animation: toastOut 0.3s ease forwards;
        }

        @keyframes toastIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes toastOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .toast-icon {
            font-size: 18px;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-size: 13px;
            font-weight: 600;
        }

        .toast-desc {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }

        .toast-close:hover {
            color: var(--text-primary);
        }

        .toast.success { border-left: 3px solid var(--success); }
        .toast.warning { border-left: 3px solid var(--warning); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast.info { border-left: 3px solid var(--info); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            border: 1px solid var(--border);
            transform: scale(0.95) translateY(20px);
            transition: all 0.3s;
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 700;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(85vh - 140px);
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Claim Detail */
        .claim-detail-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .detail-item {
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .detail-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 14px;
            font-weight: 600;
        }

        .claim-statement {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
            margin-bottom: 20px;
        }

        .claim-statement-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .claim-statement-text {
            font-size: 14px;
            line-height: 1.5;
        }

        .claim-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        /* Fullscreen */
        .fullscreen .sidebar {
            display: none;
        }

        .fullscreen .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .fullscreen .content-wrapper {
            padding-top: 70px;
        }

        /* Print */
        @media print {
            .sidebar, .header, .toast-container { display: none !important; }
            .content-wrapper { padding: 0 !important; }
            .card { break-inside: avoid; border: 1px solid #ddd !important; }
            body { background: white !important; color: black !important; }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .grid-3 { grid-template-columns: 1fr 1fr; }
            .grid-3 > *:nth-child(3) { grid-column: span 2; }
        }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .grid-3, .grid-2, .grid-2-1 { grid-template-columns: 1fr; }
            .grid-3 > *:nth-child(3) { grid-column: span 1; }
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 600px) {
            .header { flex-direction: column; gap: 10px; }
            .header-left, .header-right { width: 100%; justify-content: center; }
            .metrics-grid { grid-template-columns: 1fr; }
            .donut-container { flex-direction: column; }
            .claim-detail-grid { grid-template-columns: 1fr; }
        }

        /* ══════════════════════════════════════════════════════════════════
           V5 ADDITIONS - Command Palette, Compare, Context Menu, Undo, Mobile
           ══════════════════════════════════════════════════════════════════ */

        /* Command Palette */
        .cmd-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            padding-top: 12vh;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .cmd-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .cmd-palette {
            width: 90%;
            max-width: 560px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            transform: scale(0.96) translateY(-10px);
            transition: transform 0.2s ease;
        }

        .cmd-overlay.active .cmd-palette {
            transform: scale(1) translateY(0);
        }

        .cmd-input-wrapper {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            gap: 12px;
        }

        .cmd-input-icon {
            font-size: 18px;
            color: var(--text-muted);
        }

        .cmd-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
        }

        .cmd-input::placeholder {
            color: var(--text-muted);
        }

        .cmd-kbd {
            padding: 3px 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 10px;
            font-family: 'SF Mono', monospace;
            color: var(--text-muted);
        }

        .cmd-results {
            max-height: 360px;
            overflow-y: auto;
            padding: 8px;
        }

        .cmd-group {
            margin-bottom: 12px;
        }

        .cmd-group-label {
            padding: 8px 12px 6px;
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cmd-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .cmd-item:hover, .cmd-item.selected {
            background: var(--bg-secondary);
        }

        .cmd-item-icon {
            font-size: 16px;
            width: 24px;
            text-align: center;
        }

        .cmd-item-text {
            flex: 1;
            font-size: 13px;
        }

        .cmd-item-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .cmd-footer {
            padding: 12px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 20px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .cmd-footer span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            min-width: 180px;
            padding: 6px;
            z-index: 2500;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            display: none;
        }

        .context-menu.active {
            display: block;
            animation: ctxIn 0.15s ease;
        }

        @keyframes ctxIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .ctx-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .ctx-item:hover {
            background: var(--bg-secondary);
        }

        .ctx-item.danger {
            color: var(--danger);
        }

        .ctx-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .ctx-divider {
            height: 1px;
            background: var(--border);
            margin: 6px 0;
        }

        /* Compare Mode */
        .compare-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            z-index: 1500;
            transition: transform 0.3s ease;
        }

        .compare-bar.active {
            transform: translateX(-50%) translateY(0);
        }

        .compare-bar-text {
            font-size: 13px;
        }

        .compare-bar-count {
            font-weight: 700;
            color: var(--accent);
        }

        .compare-bar-btn {
            padding: 8px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .compare-bar-btn:hover {
            filter: brightness(1.1);
        }

        .compare-bar-btn:disabled {
            background: var(--border);
            cursor: not-allowed;
        }

        .compare-bar-clear {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
        }

        /* Compare View */
        .compare-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            padding: 20px 0;
        }

        .compare-card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .compare-card-header {
            padding: 14px 18px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .compare-card-title {
            font-size: 14px;
            font-weight: 700;
        }

        .compare-card-body {
            padding: 18px;
        }

        .compare-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .compare-row:last-child {
            border-bottom: none;
        }

        .compare-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .compare-value {
            font-size: 13px;
            font-weight: 600;
        }

        .compare-diff {
            background: rgba(239, 68, 68, 0.1);
            border: 1px dashed var(--danger);
            border-radius: 4px;
            padding: 2px 8px;
        }

        .compare-vs {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compare-vs-badge {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent), #ea580c);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            color: white;
        }

        /* Undo Bar */
        .undo-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            z-index: 1400;
            transition: transform 0.3s ease;
        }

        .undo-bar.active {
            transform: translateX(-50%) translateY(0);
        }

        .undo-text {
            font-size: 13px;
        }

        .undo-btn {
            padding: 6px 14px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .undo-timer {
            width: 28px;
            height: 28px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
        }

        /* Filter Presets */
        .filter-presets {
            display: flex;
            gap: 6px;
            margin-left: 16px;
        }

        .filter-preset {
            padding: 5px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-preset:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .filter-preset.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Mobile Bottom Nav */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 8px 0;
            z-index: 200;
        }

        .mobile-nav-items {
            display: flex;
            justify-content: space-around;
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 8px 16px;
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mobile-nav-item:hover, .mobile-nav-item.active {
            color: var(--accent);
        }

        .mobile-nav-icon {
            font-size: 20px;
        }

        /* Row selection for compare */
        .claims-table tr.compare-selected td {
            background: rgba(249, 115, 22, 0.1);
        }

        .claims-table tr.compare-selected td:first-child::before {
            content: '✓';
            margin-right: 8px;
            color: var(--accent);
            font-weight: 700;
        }

        /* ══════════════════════════════════════════════════════════════════
           V6 ADDITIONS - Sorting, Bulk Actions, Edit Modal
           ══════════════════════════════════════════════════════════════════ */

        /* Sortable Table Headers */
        .claims-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .claims-table th.sortable:hover {
            background: var(--bg-card-hover);
        }

        .claims-table th.sortable.asc .sort-icon,
        .claims-table th.sortable.desc .sort-icon {
            color: var(--accent);
        }

        .claims-table th.sortable.asc .sort-icon::after {
            content: '↑';
        }

        .claims-table th.sortable.desc .sort-icon::after {
            content: '↓';
        }

        .sort-icon {
            font-size: 10px;
            color: var(--text-muted);
            margin-left: 4px;
        }

        .th-checkbox {
            width: 40px;
            text-align: center;
        }

        .th-checkbox input,
        .row-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .claims-table tr.selected td {
            background: rgba(249, 115, 22, 0.08);
        }

        /* Bulk Action Bar */
        .bulk-action-bar {
            display: none;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(249, 115, 22, 0.05));
            border-bottom: 1px solid var(--border);
            justify-content: space-between;
            align-items: center;
            animation: slideDown 0.2s ease;
        }

        .bulk-action-bar.active {
            display: flex;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bulk-info {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .bulk-count {
            font-weight: 700;
            color: var(--accent);
            font-size: 15px;
        }

        .bulk-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .bulk-clear {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .bulk-clear:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        /* Table Footer */
        .table-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-info {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Edit Modal Additions */
        .edit-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .edit-form-grid .form-full {
            grid-column: span 2;
        }

        .edit-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .edit-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .edit-input,
        .edit-select,
        .edit-textarea {
            padding: 10px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
        }

        .edit-input:focus,
        .edit-select:focus,
        .edit-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .edit-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .confidence-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .confidence-bar input[type="range"] {
            flex: 1;
        }

        .confidence-bar-value {
            font-weight: 700;
            color: var(--accent);
            min-width: 40px;
        }

        @media (max-width: 900px) {
            .mobile-nav {
                display: block;
            }
            .content-wrapper {
                padding-bottom: 80px;
            }
            .filter-presets {
                display: none;
            }
            .compare-container {
                grid-template-columns: 1fr;
            }
            .compare-vs {
                padding: 16px 0;
            }
            .bulk-action-bar {
                flex-direction: column;
                gap: 10px;
            }
            .bulk-actions {
                flex-wrap: wrap;
            }
            .edit-form-grid {
                grid-template-columns: 1fr;
            }
            .edit-form-grid .form-full {
                grid-column: span 1;
            }
        }

        /* ══════════════════════════════════════════════════════════════════
           NEW CLAIM FORM STYLES
           ══════════════════════════════════════════════════════════════════ */

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.form-full {
            grid-column: span 2;
        }

        .form-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .form-hint {
            font-size: 10px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .section-header {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 8px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent);
        }

        .section-subtitle {
            font-size: 11px;
            color: var(--text-muted);
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .form-input::placeholder,
        .form-textarea::placeholder {
            color: var(--text-muted);
        }

        .form-input.readonly {
            background: var(--bg-secondary);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        .form-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
            line-height: 1.5;
        }

        .form-range {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            appearance: none;
            cursor: pointer;
            margin: 8px 0;
        }

        .form-range::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.4);
        }

        .confidence-control {
            display: flex;
            flex-direction: column;
        }

        .confidence-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            color: var(--text-muted);
        }

        .confidence-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
        }

        .status-toggle {
            display: flex;
            gap: 10px;
        }

        .status-option {
            cursor: pointer;
        }

        .status-option input {
            display: none;
        }

        .status-pill {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .status-pill.draft {
            background: rgba(234, 179, 8, 0.1);
            color: var(--warning);
        }

        .status-pill.active {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .status-option input:checked + .status-pill {
            border-color: currentColor;
        }

        .dependency-input {
            position: relative;
        }

        .dep-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .dep-suggestions.active {
            display: block;
        }

        .dep-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dep-suggestion:hover {
            background: var(--bg-secondary);
        }

        .dep-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .dep-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 11px;
            font-family: 'SF Mono', monospace;
        }

        .dep-tag-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            font-size: 14px;
            line-height: 1;
        }

        .dep-tag-remove:hover {
            color: var(--danger);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        /* Preview Panel */
        .claim-preview-panel {
            min-height: 200px;
        }

        .preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: var(--text-muted);
            text-align: center;
            gap: 10px;
        }

        .preview-claim {
            background: var(--bg-secondary);
            border-radius: 10px;
            border-left: 4px solid var(--accent);
            overflow: hidden;
        }

        .preview-claim-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-claim-id {
            font-family: 'SF Mono', monospace;
            font-weight: 700;
            color: var(--accent);
        }

        .preview-claim-body {
            padding: 16px;
        }

        .preview-claim-statement {
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .preview-claim-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .preview-meta-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .preview-meta-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .preview-meta-value {
            font-size: 11px;
            font-weight: 600;
        }

        .preview-task-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-card);
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px dashed var(--border);
        }

        .preview-task-badge {
            font-size: 10px;
            font-weight: 700;
            color: var(--accent);
            background: rgba(249, 115, 22, 0.1);
            padding: 3px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .preview-task-text {
            flex: 1;
            font-size: 12px;
            color: var(--text-primary);
        }

        .preview-task-thread {
            font-size: 10px;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* Type Guide */
        .type-guide {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .type-guide-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .type-guide-item .claim-type {
            min-width: 40px;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 1100px) {
            #newclaimContent .grid {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            .form-group.form-full {
                grid-column: span 1;
            }
            .form-actions {
                flex-direction: column;
            }
            .form-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="app" id="app">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo">EDGE</div>
                    <div class="logo-text">
                        <h1>Coherence Ops</h1>
                        <p>Coherence Ops</p>
                    </div>
                </div>
                <button class="collapse-btn" onclick="toggleSidebar()" title="Toggle Sidebar">◀</button>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <span class="search-icon">🔍</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search... (⌘K)">
                </div>
            </div>

            <nav class="nav">
                <div class="nav-section">
                    <div class="nav-label">Dashboard</div>
                    <div class="nav-item active" data-view="overview">
                        <span class="nav-icon">📊</span>
                        <span class="nav-text">Overview</span>
                    </div>
                    <div class="nav-item" data-view="claims">
                        <span class="nav-icon">📋</span>
                        <span class="nav-text">All Claims</span>
                        <span class="nav-badge">847</span>
                    </div>
                    <div class="nav-item" data-view="analysis">
                        <span class="nav-icon">🔬</span>
                        <span class="nav-text">Analysis</span>
                    </div>
                    <div class="nav-item" data-view="drift">
                        <span class="nav-icon">📡</span>
                        <span class="nav-text">Drift Signals</span>
                        <span class="nav-badge" style="background: var(--warning)">8</span>
                    </div>
                    <div class="nav-item" data-view="blast">
                        <span class="nav-icon">💥</span>
                        <span class="nav-text">Blast Radius</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Alerts</div>
                    <div class="nav-item" data-filter="red">
                        <span class="nav-icon">🔴</span>
                        <span class="nav-text">Red Signals</span>
                        <span class="nav-badge">2</span>
                    </div>
                    <div class="nav-item" data-filter="halflife">
                        <span class="nav-icon">⏳</span>
                        <span class="nav-text">Half-Life Warnings</span>
                        <span class="nav-badge" style="background: var(--warning)">5</span>
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="sidebar-footer-content">
                    <div class="toggle-row">
                        <span>🌙 Dark Mode</span>
                        <div class="toggle-switch active" id="themeToggle"></div>
                    </div>
                    <div class="toggle-row">
                        <span>🔔 Notifications</span>
                        <div class="toggle-switch active" id="notifToggle"></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <main class="main">
            <header class="header">
                <div class="header-left">
                    <h1 class="page-title">Dashboard</h1>
                    <div class="header-tabs">
                        <div class="header-tab active" data-tab="overview">Overview</div>
                        <div class="header-tab" data-tab="claims">Claims</div>
                        <div class="header-tab" data-tab="drift">Drift</div>
                        <div class="header-tab" data-tab="analysis">Analysis</div>
                        <div class="header-tab" data-tab="blast">Blast Radius</div>
                        <div class="header-tab" data-tab="compare">Compare</div>
                    </div>
                    <div class="filter-presets">
                        <div class="filter-preset active" data-filter="all">All</div>
                        <div class="filter-preset" data-filter="green">Green</div>
                        <div class="filter-preset" data-filter="yellow">Yellow</div>
                        <div class="filter-preset" data-filter="red">Red</div>
                    </div>
                </div>
                <div class="header-right">
                    <div class="live-badge">
                        <div class="live-dot"></div>
                        LIVE
                    </div>
                    <div class="timestamp" id="timestamp">--:--:--</div>
                    <button class="btn btn-secondary btn-icon" onclick="openCommandPalette()" title="Commands (⌘K)">⌘</button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleFullscreen()" title="Fullscreen (F11)">⛶</button>
                    <button class="btn btn-secondary" onclick="exportData()" title="Export">
                        <span>📥</span> Export
                    </button>
                    <button class="btn btn-primary" onclick="refreshDashboard()">
                        <span id="refreshIcon">⟳</span> Refresh
                    </button>
                </div>
            </header>

            <div class="content-wrapper">
                <!-- Overview -->
                <div class="content active" id="overviewContent">
                    <div class="grid grid-3" style="margin-bottom: 16px;">
                        <!-- CI Card with 4D Scoring -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Coherence Index</span>
                                <span class="card-badge badge-success" id="ciBadge">Healthy</span>
                            </div>
                            <div class="card-body">
                                <div class="ci-container">
                                    <div class="ci-gauge">
                                        <svg viewBox="0 0 160 90" width="160" height="90">
                                            <defs>
                                                <linearGradient id="ciGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                                    <stop offset="0%" style="stop-color:#22c55e"/>
                                                    <stop offset="100%" style="stop-color:#4ade80"/>
                                                </linearGradient>
                                            </defs>
                                            <path class="gauge-track" d="M 16 80 A 64 64 0 0 1 144 80"/>
                                            <path class="gauge-fill" id="ciGauge" d="M 16 80 A 64 64 0 0 1 144 80"/>
                                        </svg>
                                        <div class="ci-value-box">
                                            <span class="ci-value"><span id="ciValue">0</span><span class="grade-badge" id="ciGrade">-</span></span>
                                            <div class="ci-label">CI Score</div>
                                        </div>
                                    </div>
                                    <div class="ci-status">
                                        <div class="live-dot"></div>
                                        <span id="ciStatusText">System Healthy</span>
                                    </div>
                                    <div class="ci-trend">
                                        <div class="ci-trend-item">
                                            <div class="ci-trend-label">Target</div>
                                            <div class="ci-trend-value">&gt;75 (B)</div>
                                        </div>
                                        <div class="ci-trend-item">
                                            <div class="ci-trend-label">Change</div>
                                            <div class="ci-trend-value trend-up">+3.4%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Metrics + WHY -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Key Metrics</span>
                                <span class="card-badge badge-info">60s WHY: 96%</span>
                            </div>
                            <div class="card-body">
                                <div class="metrics-grid" id="metricsGrid"></div>
                            </div>
                        </div>

                        <!-- Activity + Calendar -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Activity</span>
                                <span style="font-size: 10px; color: var(--accent); cursor: pointer;">View All →</span>
                            </div>
                            <div class="card-body">
                                <div class="activity-feed" id="activityFeed"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-2" style="margin-bottom: 16px;">
                        <!-- Bar Chart -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Claims by Type</span>
                            </div>
                            <div class="card-body">
                                <div class="bar-chart" id="barChart"></div>
                            </div>
                        </div>

                        <!-- Donut: statusLight distribution -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Status Light Distribution</span>
                            </div>
                            <div class="card-body">
                                <div class="donut-container">
                                    <div class="donut-chart">
                                        <svg viewBox="0 0 120 120" width="120" height="120">
                                            <circle class="donut-segment" id="donutGreen" cx="60" cy="60" r="50" stroke="#22c55e"/>
                                            <circle class="donut-segment" id="donutYellow" cx="60" cy="60" r="50" stroke="#eab308"/>
                                            <circle class="donut-segment" id="donutRed" cx="60" cy="60" r="50" stroke="#ef4444"/>
                                        </svg>
                                        <div class="donut-center">
                                            <div class="donut-value" id="donutTotal">0</div>
                                            <div class="donut-label">Total</div>
                                        </div>
                                    </div>
                                    <div class="donut-legend" id="donutLegend">
                                        <div class="legend-row">
                                            <div class="legend-dot green"></div>
                                            <span class="legend-text">Green</span>
                                            <span class="legend-value" id="legendGreen">-</span>
                                        </div>
                                        <div class="legend-row">
                                            <div class="legend-dot yellow"></div>
                                            <span class="legend-text">Yellow</span>
                                            <span class="legend-value" id="legendYellow">-</span>
                                        </div>
                                        <div class="legend-row">
                                            <div class="legend-dot red"></div>
                                            <span class="legend-text">Red</span>
                                            <span class="legend-value" id="legendRed">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-2-1">
                        <!-- Coherence Dimensions -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Coherence Dimensions</span>
                                <span class="card-badge badge-info">4D Scoring</span>
                            </div>
                            <div class="card-body">
                                <div class="dimensions-list" id="dimensionsList"></div>
                            </div>
                        </div>

                        <!-- Drift-Derived Alerts -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Alerts</span>
                                <span class="card-badge badge-danger" id="alertCount">0</span>
                            </div>
                            <div class="card-body">
                                <div class="alerts-list" id="alertsList"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Claims -->
                <div class="content" id="claimsContent">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">All Claims</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" class="search-input" id="tableSearch" placeholder="Search claims..." style="width: 180px;" oninput="filterClaimsTable()">
                                <select class="search-input" style="width: auto; padding-left: 10px;" id="typeFilter" onchange="filterClaimsTable()">
                                    <option value="">All Types</option>
                                    <option value="observation">Observation</option>
                                    <option value="inference">Inference</option>
                                    <option value="assumption">Assumption</option>
                                    <option value="forecast">Forecast</option>
                                    <option value="norm">Norm</option>
                                    <option value="constraint">Constraint</option>
                                </select>
                                <select class="search-input" style="width: auto; padding-left: 10px;" id="statusFilter" onchange="filterClaimsTable()">
                                    <option value="">All Lights</option>
                                    <option value="green">Green</option>
                                    <option value="yellow">Yellow</option>
                                    <option value="red">Red</option>
                                </select>
                                <button class="btn btn-primary" onclick="switchTab('newclaim')">+ New Claim</button>
                            </div>
                        </div>
                        <!-- Bulk Action Bar -->
                        <div class="bulk-action-bar" id="bulkActionBar">
                            <div class="bulk-info">
                                <span class="bulk-count" id="bulkCount">0</span> claims selected
                            </div>
                            <div class="bulk-actions">
                                <button class="btn btn-secondary" onclick="bulkAction('extend')">📅 Extend 30d</button>
                                <button class="btn btn-secondary" onclick="bulkAction('export')">📥 Export</button>
                                <button class="btn btn-secondary" onclick="bulkAction('archive')" style="color: var(--danger);">🗑️ Archive</button>
                                <button class="bulk-clear" onclick="clearBulkSelection()">✕ Clear</button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table class="claims-table" id="claimsTableEl">
                                <thead>
                                    <tr>
                                        <th class="th-checkbox"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                        <th class="sortable" data-sort="claimId" onclick="sortTable('claimId')">Claim ID <span class="sort-icon">↕</span></th>
                                        <th class="sortable" data-sort="truthType" onclick="sortTable('truthType')">Truth Type <span class="sort-icon">↕</span></th>
                                        <th>Statement</th>
                                        <th class="sortable" data-sort="owner" onclick="sortTable('owner')">Owner <span class="sort-icon">↕</span></th>
                                        <th class="sortable" data-sort="statusLight" onclick="sortTable('statusLight')">Light <span class="sort-icon">↕</span></th>
                                        <th>Confidence</th>
                                        <th>Half-Life</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="claimsTable"></tbody>
                            </table>
                        </div>
                        <div class="table-footer">
                            <span class="table-info" id="tableInfo">Showing 26 claims</span>
                        </div>
                    </div>
                </div>

                <!-- Drift Signals -->
                <div class="content" id="driftContent">
                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card-header">
                            <span class="card-title">Drift Signal Summary</span>
                            <span class="card-badge badge-warning" id="driftTotalBadge">0</span>
                        </div>
                        <div class="card-body">
                            <div class="drift-summary-grid" id="driftSummaryGrid"></div>
                        </div>
                    </div>
                    <div class="grid grid-2">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Signals by Type</span>
                            </div>
                            <div class="card-body">
                                <div class="bar-chart" id="driftTypeChart"></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Active Drift Signals</span>
                            </div>
                            <div class="card-body">
                                <div class="drift-list" id="driftList"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis -->
                <div class="content" id="analysisContent">
                    <div class="grid grid-2">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Coherence Index (30 Days)</span>
                            </div>
                            <div class="card-body">
                                <svg id="trendChart" width="100%" height="180" viewBox="0 0 500 180">
                                    <defs>
                                        <linearGradient id="trendGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:#22c55e;stop-opacity:0.3"/>
                                            <stop offset="100%" style="stop-color:#22c55e;stop-opacity:0"/>
                                        </linearGradient>
                                    </defs>
                                </svg>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title" id="calendarTitle">Half-Life Calendar</span>
                            </div>
                            <div class="card-body">
                                <div class="calendar-widget" id="calendar"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Blast Radius -->
                <div class="content" id="blastContent">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Blast Radius Visualizer</span>
                            <div style="display: flex; gap: 8px;">
                                <select class="search-input" style="width: auto; padding-left: 10px;" id="blastSelect">
                                    <option value="ASM-2024-012">ASM-2024-012 - DBIDS Reliability</option>
                                    <option value="DLR-2024-089">DLR-2024-089 - Escort Policy</option>
                                    <option value="TRM-2024-034">TRM-2024-034 - Zone B Definition</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="blast-container" id="blastContainer"></div>
                        </div>
                    </div>
                </div>

                <!-- Compare View -->
                <div class="content" id="compareContent">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Claim Comparison</span>
                            <span style="font-size: 11px; color: var(--text-muted);">Select 2 claims from the Claims tab to compare</span>
                        </div>
                        <div class="card-body">
                            <div class="compare-container" id="compareContainer">
                                <div class="compare-card">
                                    <div class="compare-card-header">
                                        <span class="compare-card-title" id="compare1Title">Select first claim</span>
                                        <span class="claim-type" id="compare1Type">-</span>
                                    </div>
                                    <div class="compare-card-body" id="compare1Body">
                                        <p style="color: var(--text-muted); text-align: center; padding: 40px 0;">
                                            Go to Claims tab and click claims to select them for comparison
                                        </p>
                                    </div>
                                </div>
                                <div class="compare-vs">
                                    <div class="compare-vs-badge">VS</div>
                                </div>
                                <div class="compare-card">
                                    <div class="compare-card-header">
                                        <span class="compare-card-title" id="compare2Title">Select second claim</span>
                                        <span class="claim-type" id="compare2Type">-</span>
                                    </div>
                                    <div class="compare-card-body" id="compare2Body">
                                        <p style="color: var(--text-muted); text-align: center; padding: 40px 0;">
                                            Go to Claims tab and click claims to select them for comparison
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New Claim Form -->
                <div class="content" id="newclaimContent">
                    <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 20px;">
                        <!-- Main Form -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">➕ Create New Atomic Claim</span>
                                <span style="font-size: 10px; color: var(--text-muted);">Fields marked * are required</span>
                            </div>
                            <div class="card-body">
                                <div class="form-grid">
                                    <!-- Row 1: Truth Type & Auto ID -->
                                    <div class="form-group">
                                        <label class="form-label">Truth Type *</label>
                                        <select class="form-select" id="newClaimType" required onchange="generateClaimId()">
                                            <option value="">Select type...</option>
                                            <option value="observation">Observation - Directly observed fact</option>
                                            <option value="inference">Inference - Derived from reasoning</option>
                                            <option value="assumption">Assumption - Accepted without proof</option>
                                            <option value="forecast">Forecast - Future projection</option>
                                            <option value="norm">Norm - Policy or standard</option>
                                            <option value="constraint">Constraint - Hard boundary</option>
                                        </select>
                                        <span class="form-hint">Epistemic type per DeepSigma claim schema</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Claim ID</label>
                                        <input type="text" class="form-input readonly" id="newClaimId" placeholder="CLAIM-YYYY-NNNN" readonly>
                                        <span class="form-hint">Auto-generated: CLAIM-YYYY-NNNN</span>
                                    </div>

                                    <!-- Row 2: Statement (full width) -->
                                    <div class="form-group form-full">
                                        <label class="form-label">Claim Statement *</label>
                                        <textarea class="form-textarea" id="newClaimStatement" rows="3" required
                                            placeholder="Enter the atomic claim. Be specific and unambiguous."
                                            oninput="updateClaimPreview()"></textarea>
                                        <span class="form-hint">The core assertion. Should be verifiable and self-contained.</span>
                                    </div>

                                    <!-- Row 3: Confidence -->
                                    <div class="form-group">
                                        <label class="form-label">Confidence Score *</label>
                                        <div class="confidence-control">
                                            <input type="range" class="form-range" id="newClaimConfidence"
                                                min="0" max="100" value="75" step="1" oninput="updateConfidenceDisplay()">
                                            <div class="confidence-display">
                                                <span class="confidence-label">0.00</span>
                                                <span class="confidence-value" id="confidenceValue">0.75</span>
                                                <span class="confidence-label">1.00</span>
                                            </div>
                                        </div>
                                        <span class="form-hint">0.00-1.00 scale. Green >= 0.80, Red < 0.50</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Confidence Explanation</label>
                                        <textarea class="form-textarea" id="newClaimConfExplain" rows="2"
                                            placeholder="Why this confidence level?"
                                            oninput="updateClaimPreview()"></textarea>
                                        <span class="form-hint">Evidence basis for the confidence score</span>
                                    </div>

                                    <!-- ═══ SCOPE SECTION ═══ -->
                                    <div class="form-group form-full" style="margin-top: 8px; padding-top: 16px; border-top: 1px dashed var(--border);">
                                        <div class="section-header">
                                            <span class="section-title">📍 Scope &amp; Context</span>
                                            <span class="section-subtitle">Where and when does this claim apply?</span>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Scope: Where *</label>
                                        <input type="text" class="form-input" id="newClaimScopeWhere" required
                                            placeholder="e.g., Installation, Zone B, Gate 4"
                                            oninput="updateClaimPreview()">
                                        <span class="form-hint">Geographic or organizational scope</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Scope: When *</label>
                                        <input type="text" class="form-input" id="newClaimScopeWhen" required
                                            placeholder="e.g., FY25, Q1 2025, Ongoing"
                                            oninput="updateClaimPreview()">
                                        <span class="form-hint">Temporal scope of validity</span>
                                    </div>

                                    <!-- ═══ HALF-LIFE SECTION ═══ -->
                                    <div class="form-group form-full" style="margin-top: 8px; padding-top: 16px; border-top: 1px dashed var(--border);">
                                        <div class="section-header">
                                            <span class="section-title">⏳ Half-Life Configuration</span>
                                            <span class="section-subtitle">When does this claim need refreshing?</span>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Half-Life Value *</label>
                                        <input type="number" class="form-input" id="newClaimHLValue" min="1" value="30"
                                            oninput="updateClaimPreview()">
                                        <span class="form-hint">Time until confidence halves</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Half-Life Unit *</label>
                                        <select class="form-select" id="newClaimHLUnit" onchange="updateClaimPreview()">
                                            <option value="days" selected>Days</option>
                                            <option value="hours">Hours</option>
                                            <option value="ms">Milliseconds</option>
                                        </select>
                                        <span class="form-hint">Unit for the half-life period</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Refresh Trigger</label>
                                        <select class="form-select" id="newClaimHLTrigger" onchange="updateClaimPreview()">
                                            <option value="expiry" selected>Expiry</option>
                                            <option value="contradiction">Contradiction</option>
                                            <option value="new_source">New Source</option>
                                            <option value="schedule">Schedule</option>
                                        </select>
                                        <span class="form-hint">What triggers a review?</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Classification</label>
                                        <select class="form-select" id="newClaimClassification" onchange="updateClaimPreview()">
                                            <option value="internal" selected>Internal</option>
                                            <option value="public">Public</option>
                                            <option value="restricted">Restricted</option>
                                            <option value="secret">Secret</option>
                                        </select>
                                        <span class="form-hint">Information classification tag</span>
                                    </div>

                                    <!-- ═══ OWNERSHIP ═══ -->
                                    <div class="form-group form-full" style="margin-top: 8px; padding-top: 16px; border-top: 1px dashed var(--border);">
                                        <div class="section-header">
                                            <span class="section-title">👤 Ownership &amp; Source</span>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Claim Owner *</label>
                                        <select class="form-select" id="newClaimOwner" required onchange="updateClaimPreview()">
                                            <option value="">Select owner...</option>
                                            <option value="CPT Rodriguez">CPT Rodriguez - Physical Security</option>
                                            <option value="MAJ Thompson">MAJ Thompson - Access Control</option>
                                            <option value="SFC Williams">SFC Williams - Visitor Mgmt</option>
                                            <option value="CW3 Martinez">CW3 Martinez - Investigations</option>
                                            <option value="MSG Patterson">MSG Patterson - Operations</option>
                                        </select>
                                        <span class="form-hint">Position responsible for maintaining this claim</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Source Reference</label>
                                        <input type="text" class="form-input" id="newClaimSourceRef"
                                            placeholder="e.g., AR 190-13, gate-sensor-data-2024">
                                        <span class="form-hint">Primary source for this claim</span>
                                    </div>

                                    <!-- Row: Graph Dependencies -->
                                    <div class="form-group form-full">
                                        <label class="form-label">Depends On (Optional)</label>
                                        <div class="dependency-input">
                                            <input type="text" class="form-input" id="depSearchInput"
                                                placeholder="Search claims to link as dependencies...">
                                            <div class="dep-suggestions" id="depSuggestions"></div>
                                        </div>
                                        <div class="dep-tags" id="selectedDeps"></div>
                                        <span class="form-hint">graph.dependsOn — claims this depends on</span>
                                    </div>

                                    <!-- Tags -->
                                    <div class="form-group form-full">
                                        <label class="form-label">Tags (Optional)</label>
                                        <input type="text" class="form-input" id="newClaimTags"
                                            placeholder="security, zone-b, access-control">
                                        <span class="form-hint">Comma-separated for easier searching</span>
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="resetNewClaimForm()">
                                        🔄 Reset
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="saveClaimDraft()">
                                        💾 Save Draft
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="submitNewClaim()">
                                        ✅ Create Claim
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Preview Panel -->
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">📋 Live Preview</span>
                                </div>
                                <div class="card-body">
                                    <div id="claimPreview" class="claim-preview-panel">
                                        <div class="preview-placeholder">
                                            <span style="font-size: 48px; opacity: 0.3;">📋</span>
                                            <p>Fill in the form to preview your claim</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Reference -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">📖 Truth Type Guide</span>
                                </div>
                                <div class="card-body">
                                    <div class="type-guide">
                                        <div class="type-guide-item">
                                            <span class="claim-type observation">OBS</span>
                                            <span>Directly observed facts</span>
                                        </div>
                                        <div class="type-guide-item">
                                            <span class="claim-type inference">INF</span>
                                            <span>Derived from reasoning over evidence</span>
                                        </div>
                                        <div class="type-guide-item">
                                            <span class="claim-type assumption">ASM</span>
                                            <span>Accepted without current proof</span>
                                        </div>
                                        <div class="type-guide-item">
                                            <span class="claim-type forecast">FCT</span>
                                            <span>Future projections or predictions</span>
                                        </div>
                                        <div class="type-guide-item">
                                            <span class="claim-type norm">NRM</span>
                                            <span>Policies, standards, regulations</span>
                                        </div>
                                        <div class="type-guide-item">
                                            <span class="claim-type constraint">CON</span>
                                            <span>Hard boundaries and dependencies</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Modal</div>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- V5: Command Palette -->
    <div class="cmd-overlay" id="cmdOverlay" onclick="if(event.target === this) closeCommandPalette()">
        <div class="cmd-palette">
            <div class="cmd-input-wrapper">
                <span class="cmd-input-icon">🔍</span>
                <input type="text" class="cmd-input" id="cmdInput" placeholder="Search claims, IRIS queries (why, drift, status)...">
                <span class="cmd-kbd">ESC</span>
            </div>
            <div class="cmd-results" id="cmdResults"></div>
            <div class="cmd-footer">
                <span><kbd>↑↓</kbd> Navigate</span>
                <span><kbd>↵</kbd> Select</span>
                <span><kbd>ESC</kbd> Close</span>
            </div>
        </div>
    </div>

    <!-- V5: Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="ctx-item" onclick="ctxAction('view')">👁️ View Details</div>
        <div class="ctx-item" onclick="ctxAction('extend')">📅 Extend 30 Days</div>
        <div class="ctx-item" onclick="ctxAction('compare')">⚖️ Add to Compare</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item" onclick="ctxAction('challenge')">⚠️ Challenge Claim</div>
        <div class="ctx-item danger" onclick="ctxAction('archive')">🗑️ Archive</div>
    </div>

    <!-- V5: Compare Bar -->
    <div class="compare-bar" id="compareBar">
        <span class="compare-bar-text">Selected: <span class="compare-bar-count" id="compareCount">0</span>/2</span>
        <button class="compare-bar-btn" id="compareBtn" disabled onclick="goToCompare()">Compare Claims</button>
        <button class="compare-bar-clear" onclick="clearCompareSelection()" title="Clear">×</button>
    </div>

    <!-- V5: Undo Bar -->
    <div class="undo-bar" id="undoBar">
        <span class="undo-text" id="undoText">Action completed</span>
        <button class="undo-btn" onclick="undoLastAction()">Undo</button>
        <div class="undo-timer" id="undoTimer">5</div>
    </div>

    <!-- V5: Mobile Bottom Nav -->
    <nav class="mobile-nav">
        <div class="mobile-nav-items">
            <div class="mobile-nav-item active" data-tab="overview">
                <span class="mobile-nav-icon">📊</span>
                <span>Overview</span>
            </div>
            <div class="mobile-nav-item" data-tab="claims">
                <span class="mobile-nav-icon">📋</span>
                <span>Claims</span>
            </div>
            <div class="mobile-nav-item" data-tab="blast">
                <span class="mobile-nav-icon">💥</span>
                <span>Blast</span>
            </div>
            <div class="mobile-nav-item" onclick="openCommandPalette()">
                <span class="mobile-nav-icon">🔍</span>
                <span>Search</span>
            </div>
        </div>
    </nav>

    <script>
        // Escape HTML to prevent XSS
        function escapeHtml(s) {
            if (s == null) return '';
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        }

        // Persistence
        var STORAGE_KEY = 'ds_edge_coherence_v2';
        var DRAFT_KEY = 'ds_edge_coherence_draft_v2';

        function saveState() {
            try {
                var state = {
                    claims: data.claims,
                    theme: document.documentElement.classList.contains('light-theme') ? 'light' : 'dark',
                    notifications: notificationsEnabled,
                    version: '2.0.0'
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) { /* quota exceeded — silently fail */ }
        }

        function loadState() {
            try {
                var raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return;
                var state = JSON.parse(raw);
                if (state.claims && Array.isArray(state.claims)) {
                    data.claims = state.claims;
                    data.metrics[0].value = data.claims.length;
                }
                if (state.theme === 'light') document.body.classList.add('light-theme');
                if (typeof state.notifications === 'boolean') notificationsEnabled = state.notifications;
            } catch (e) { /* corrupt data — use defaults */ }
        }

        function saveDraft() {
            try {
                var form = {};
                ['newClaimType','newClaimId','newClaimStatement','newClaimConfidence','newClaimConfExplain',
                 'newClaimOwner','newClaimScopeWhere','newClaimScopeWhen',
                 'newClaimHLValue','newClaimHLUnit','newClaimHLTrigger','newClaimClassification',
                 'newClaimSourceRef','newClaimTags'].forEach(function(id) {
                    var el = document.getElementById(id);
                    if (el) form[id] = el.value;
                });
                localStorage.setItem(DRAFT_KEY, JSON.stringify(form));
            } catch (e) {}
        }

        function loadDraft() {
            try {
                var raw = localStorage.getItem(DRAFT_KEY);
                if (!raw) return false;
                var form = JSON.parse(raw);
                Object.keys(form).forEach(function(id) {
                    var el = document.getElementById(id);
                    if (el) el.value = form[id];
                });
                return true;
            } catch (e) { return false; }
        }

        function clearDraft() {
            try { localStorage.removeItem(DRAFT_KEY); } catch (e) {}
        }

        // ── Helper: derive statusLight per claim.schema.json ──
        function deriveStatusLight(claim) {
            var score = claim.confidence.score;
            var hasStrongSource = (claim.sources || []).some(function(s) { return s.reliability === 'high'; });
            var hasContradiction = (claim.graph.contradicts || []).length > 0;
            if (hasContradiction || score < 0.50) return 'red';
            if (score >= 0.80 && hasStrongSource) return 'green';
            return 'yellow';
        }

        // ── Helper: days remaining until half-life expiry ──
        function halfLifeDaysRemaining(claim) {
            if (!claim.halfLife || !claim.halfLife.expiresAt) return Infinity;
            var exp = new Date(claim.halfLife.expiresAt);
            var now = new Date();
            return Math.ceil((exp - now) / 86400000);
        }

        // ── Helper: grade from score (matches scoring.py) ──
        function ciGrade(score) {
            if (score >= 90) return 'A';
            if (score >= 75) return 'B';
            if (score >= 60) return 'C';
            if (score >= 40) return 'D';
            return 'F';
        }

        // ── Helper: short truthType label for table ──
        function truthTypeShort(tt) {
            var map = { observation:'OBS', inference:'INF', assumption:'ASM', forecast:'FCT', norm:'NRM', constraint:'CON' };
            return map[tt] || tt;
        }

        // ══════════════════════════════════════════════════════════════
        // DATA — Aligned with DeepSigma claim.schema.json + scoring.py
        // ══════════════════════════════════════════════════════════════
        const data = {
            // 4D Coherence Report (mirrors CoherenceScorer output)
            coherenceReport: {
                overall: 82.4,
                grade: 'B',
                dimensions: [
                    { name: 'policy_adherence', label: 'Policy Adherence', score: 88.0, weight: 0.25, details: { stamped: 22, total: 26 } },
                    { name: 'outcome_health', label: 'Outcome Health', score: 79.5, weight: 0.30, details: { success_rate: 0.85, verification_pass_rate: 0.72 } },
                    { name: 'drift_control', label: 'Drift Control', score: 85.0, weight: 0.25, details: { total_signals: 8, red_count: 1, recurring: 2 } },
                    { name: 'memory_completeness', label: 'Memory Completeness', score: 76.0, weight: 0.20, details: { episode_nodes: 19, expected: 25 } }
                ]
            },
            metrics: [
                { icon: '📋', value: 26, label: 'Total Claims', change: '+3', up: true, color: 'blue', spark: [22,23,22,24,23,25,26] },
                { icon: '⏳', value: 5, label: 'Half-Life Warnings', change: '+1', up: false, color: 'yellow', spark: [3,3,4,4,4,5,5] },
                { icon: '📡', value: 8, label: 'Drift Signals', change: '-2', up: true, color: 'orange', spark: [12,11,10,10,9,9,8] },
                { icon: '🔴', value: 4, label: 'Low Confidence', change: '-1', up: true, color: 'red', spark: [7,6,6,5,5,4,4] }
            ],
            types: [
                { name: 'Inference', value: 9, color: 'purple' },
                { name: 'Assumption', value: 7, color: 'yellow' },
                { name: 'Norm', value: 5, color: 'green' },
                { name: 'Constraint', value: 2, color: 'red' },
                { name: 'Observation', value: 2, color: 'blue' },
                { name: 'Forecast', value: 1, color: 'orange' }
            ],
            statusCounts: { green: 15, yellow: 7, red: 4 },
            activities: [
                { type: 'create', icon: '✅', title: 'CLAIM-2025-0001 sealed', desc: 'Badge renewal background check', time: '2m ago' },
                { type: 'drift', icon: '📡', title: 'DS-2024-003 detected', desc: 'Freshness drift: badge TTL stale', time: '15m ago' },
                { type: 'patch', icon: '🔧', title: 'Patch applied', desc: 'ttl_change for CLAIM-2024-0002', time: '1h ago' },
                { type: 'update', icon: '✏️', title: 'CLAIM-2024-0003 superseded', desc: 'Zone B definition updated v2', time: '2h ago' },
                { type: 'expire', icon: '⏳', title: 'CLAIM-2024-0005 half-life', desc: 'Confidence decaying, 3d remaining', time: '3h ago' },
                { type: 'create', icon: '✅', title: 'CLAIM-2024-0006 sealed', desc: 'Red Zone clearance definition', time: '5h ago' }
            ],
            // Drift Signals (mirrors DriftSignalCollector)
            driftSignals: [
                { driftId: 'DS-2024-001', driftType: 'freshness', severity: 'yellow', detectedAt: '2024-12-10T14:30:00Z', episodeId: 'EP-041', evidenceRefs: ['CLAIM-2024-0002'], recommendedPatchType: 'ttl_change', fingerprint: { key: 'badge-ttl-stale', version: '1' }, notes: 'Badge TTL assumption past half-life' },
                { driftId: 'DS-2024-002', driftType: 'verify', severity: 'red', detectedAt: '2024-12-12T09:15:00Z', episodeId: 'EP-042', evidenceRefs: ['CLAIM-2024-0001'], recommendedPatchType: 'verification_change', fingerprint: { key: 'escort-policy-unverified', version: '1' }, notes: 'Escort policy challenged, verification failed' },
                { driftId: 'DS-2024-003', driftType: 'freshness', severity: 'yellow', detectedAt: '2024-12-15T11:00:00Z', episodeId: 'EP-043', evidenceRefs: ['CLAIM-2024-0005'], recommendedPatchType: 'ttl_change', fingerprint: { key: 'badge-ttl-stale', version: '1' }, notes: 'Visitor badge validity assumption aging' },
                { driftId: 'DS-2024-004', driftType: 'outcome', severity: 'yellow', detectedAt: '2024-12-18T16:45:00Z', episodeId: 'EP-044', evidenceRefs: ['CLAIM-2024-0007'], recommendedPatchType: 'manual_review', fingerprint: { key: 'after-hours-outcome-drift', version: '1' }, notes: 'After-hours access outcomes diverging from policy' },
                { driftId: 'DS-2024-005', driftType: 'contention', severity: 'yellow', detectedAt: '2024-12-20T08:30:00Z', episodeId: 'EP-045', evidenceRefs: ['CLAIM-2024-0001', 'CLAIM-2024-0009'], recommendedPatchType: 'action_scope_tighten', fingerprint: { key: 'escort-ar190-contention', version: '1' }, notes: 'Contention between escort policy and AR 190-13 interpretation' },
                { driftId: 'DS-2024-006', driftType: 'time', severity: 'green', detectedAt: '2024-12-22T13:00:00Z', episodeId: 'EP-046', evidenceRefs: ['CLAIM-2024-0013'], recommendedPatchType: 'dte_change', fingerprint: { key: 'response-time-drift', version: '1' }, notes: 'Response time assumption within tolerance' },
                { driftId: 'DS-2024-007', driftType: 'bypass', severity: 'red', detectedAt: '2024-12-28T10:20:00Z', episodeId: 'EP-047', evidenceRefs: ['CLAIM-2024-0019'], recommendedPatchType: 'routing_change', fingerprint: { key: 'forensics-bypass', version: '1' }, notes: 'Investigation closed without forensics completion' },
                { driftId: 'DS-2024-008', driftType: 'fallback', severity: 'green', detectedAt: '2025-01-02T09:00:00Z', episodeId: 'EP-048', evidenceRefs: ['CLAIM-2024-0022'], recommendedPatchType: 'cache_bundle_change', fingerprint: { key: 'training-fallback', version: '1' }, notes: 'Training completion using fallback metric' }
            ],
            claims: [
                // ── Physical Security claims ──
                { claimId: 'CLAIM-2024-0001', statement: 'Contractors with valid DBIDS do not require escort in Zone B during business hours', scope: { where: 'Installation Zone B', when: 'FY25', context: 'Business hours 0700-1700' }, truthType: 'inference', confidence: { score: 0.72, explanation: 'DBIDS verification provides identity assurance but escort policy challenged by MAJ Thompson' }, statusLight: 'yellow', sources: [{ ref: 'AR-190-13', type: 'document', reliability: 'high' }], evidence: [{ ref: 'dbids-completion-rate-2024', type: 'record', summary: '94% completion within 24hrs' }], owner: 'CPT Rodriguez', halfLife: { value: 30, unit: 'days', expiresAt: '2025-03-15T00:00:00Z', refreshTrigger: 'contradiction' }, graph: { dependsOn: ['CLAIM-2024-0002', 'CLAIM-2024-0003', 'CLAIM-2024-0009'], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:a1b2c3d4e5f6', sealedAt: '2024-11-15T10:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['access-control', 'zone-b', 'contractor'], _thread: 'Access Control', _created: '2024-11-15T10:00:00Z' },
                { claimId: 'CLAIM-2024-0002', statement: 'DBIDS verification completes within 24 hours for standard requests', scope: { where: 'Installation', when: 'FY25' }, truthType: 'assumption', confidence: { score: 0.85, explanation: 'Based on 2023-2024 processing data showing 94% within 24hrs' }, statusLight: 'green', sources: [{ ref: 'dbids-metrics-2024', type: 'record', reliability: 'high' }], evidence: [{ ref: 'processing-time-analysis', type: 'record', summary: '94% completion rate' }], owner: 'CPT Rodriguez', halfLife: { value: 14, unit: 'days', expiresAt: '2025-02-28T00:00:00Z', refreshTrigger: 'expiry' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: ['CLAIM-2024-0001'], patches: [] }, seal: { hash: 'sha256:b2c3d4e5f6a7', sealedAt: '2024-10-20T08:30:00Z', version: 1 }, classificationTag: 'internal', tags: ['badge-ops', 'dbids'], _thread: 'Badge Operations', _created: '2024-10-20T08:30:00Z' },
                { claimId: 'CLAIM-2024-0003', statement: 'Zone B = Administrative areas accessible to credentialed personnel only', scope: { where: 'Installation', when: 'Ongoing' }, truthType: 'norm', confidence: { score: 0.95, explanation: 'AR 190-13 defines access control zones' }, statusLight: 'green', sources: [{ ref: 'AR-190-13', type: 'document', reliability: 'high' }], evidence: [{ ref: 'ar-190-13-ch4', type: 'document', summary: 'Zone classification standards' }], owner: 'CPT Rodriguez', halfLife: { value: 180, unit: 'days', expiresAt: '2025-06-01T00:00:00Z', refreshTrigger: 'new_source' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: ['CLAIM-2024-0001'], patches: [] }, seal: { hash: 'sha256:c3d4e5f6a7b8', sealedAt: '2024-09-15T14:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['perimeter', 'zone-b'], _thread: 'Perimeter Security', _created: '2024-09-15T14:00:00Z' },
                { claimId: 'CLAIM-2024-0004', statement: 'Installation access badges issued within 72 hours of approval', scope: { where: 'Installation Badge Office', when: 'FY25' }, truthType: 'inference', confidence: { score: 0.88, explanation: 'Badge production capacity supports timeline based on current equipment' }, statusLight: 'green', sources: [{ ref: 'badge-production-logs', type: 'record', reliability: 'high' }], evidence: [{ ref: 'production-capacity-report', type: 'record', summary: 'Current capacity supports 72hr timeline' }], owner: 'MAJ Thompson', halfLife: { value: 60, unit: 'days', expiresAt: '2025-05-20T00:00:00Z', refreshTrigger: 'expiry' }, graph: { dependsOn: ['CLAIM-2024-0002', 'CLAIM-2024-0008'], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:d4e5f6a7b8c9', sealedAt: '2024-10-25T11:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['badge-ops'], _thread: 'Badge Operations', _created: '2024-10-25T11:00:00Z' },
                { claimId: 'CLAIM-2024-0005', statement: 'Visitor badges valid for single day entry only', scope: { where: 'All gates', when: 'FY25' }, truthType: 'norm', confidence: { score: 0.90, explanation: 'Installation policy memorandum 2024-03' }, statusLight: 'green', sources: [{ ref: 'policy-memo-2024-03', type: 'document', reliability: 'high' }], evidence: [{ ref: 'visitor-badge-policy', type: 'document', summary: 'Single-day validity requirement' }], owner: 'SFC Williams', halfLife: { value: 7, unit: 'days', expiresAt: '2025-02-27T00:00:00Z', refreshTrigger: 'expiry' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:e5f6a7b8c9d0', sealedAt: '2024-11-01T09:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['visitor-mgmt'], _thread: 'Visitor Management', _created: '2024-11-01T09:00:00Z' },
                { claimId: 'CLAIM-2024-0006', statement: 'Red Zone = Restricted areas requiring SECRET clearance minimum', scope: { where: 'Installation', when: 'Ongoing' }, truthType: 'norm', confidence: { score: 0.98, explanation: 'Defined per DoD 5200.08-R Physical Security Program' }, statusLight: 'green', sources: [{ ref: 'DoD-5200.08-R', type: 'document', reliability: 'high' }], evidence: [{ ref: 'dod-5200-08r-sec3', type: 'document', summary: 'Clearance zone requirements' }], owner: 'MAJ Thompson', halfLife: { value: 365, unit: 'days', expiresAt: '2025-07-15T00:00:00Z', refreshTrigger: 'new_source' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:f6a7b8c9d0e1', sealedAt: '2024-08-01T10:00:00Z', version: 1 }, classificationTag: 'restricted', tags: ['perimeter', 'red-zone', 'clearance'], _thread: 'Perimeter Security', _created: '2024-08-01T10:00:00Z' },
                { claimId: 'CLAIM-2024-0007', statement: 'After-hours access requires supervisor pre-authorization and log entry', scope: { where: 'Installation', when: 'FY25' }, truthType: 'inference', confidence: { score: 0.65, explanation: 'Balances operational need with security, but challenged by CW3 Martinez' }, statusLight: 'yellow', sources: [{ ref: 'AR-190-13', type: 'document', reliability: 'high' }], evidence: [{ ref: 'after-hours-incident-log', type: 'record', summary: 'Incident analysis supports requirement' }], owner: 'CPT Rodriguez', halfLife: { value: 30, unit: 'days', expiresAt: '2025-03-28T00:00:00Z', refreshTrigger: 'contradiction' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:a7b8c9d0e1f2', sealedAt: '2024-11-20T13:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['access-control', 'after-hours'], _thread: 'Access Control', _created: '2024-11-20T13:00:00Z' },
                { claimId: 'CLAIM-2024-0008', statement: 'Badge issuance timeline depends on DBIDS verification completion', scope: { where: 'Badge Office', when: 'FY25' }, truthType: 'constraint', confidence: { score: 0.92, explanation: 'Sequential process dependency — badges cannot issue before identity verification' }, statusLight: 'green', sources: [{ ref: 'badge-process-sop', type: 'document', reliability: 'high' }], evidence: [{ ref: 'process-flow-diagram', type: 'document', summary: 'Sequential dependency documented' }], owner: 'SFC Williams', halfLife: { value: 90, unit: 'days', expiresAt: '2025-04-01T00:00:00Z', refreshTrigger: 'expiry' }, graph: { dependsOn: ['CLAIM-2024-0002'], contradicts: [], supersedes: null, supports: ['CLAIM-2024-0004'], patches: [] }, seal: { hash: 'sha256:b8c9d0e1f2a3', sealedAt: '2024-10-10T15:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['badge-ops', 'dependency'], _thread: 'Badge Operations', _created: '2024-10-10T15:00:00Z' },
                { claimId: 'CLAIM-2024-0009', statement: 'AR 190-13 governs all physical security access control decisions', scope: { where: 'All Army installations', when: 'Ongoing' }, truthType: 'norm', confidence: { score: 1.00, explanation: 'Primary regulatory authority for Army installation physical security' }, statusLight: 'green', sources: [{ ref: 'AR-190-13', type: 'document', reliability: 'high' }], evidence: [{ ref: 'hqda-policy-letter', type: 'document', summary: 'Regulatory authority confirmed' }], owner: 'MAJ Thompson', halfLife: { value: 365, unit: 'days', expiresAt: '2025-12-31T00:00:00Z', refreshTrigger: 'new_source' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: ['CLAIM-2024-0001'], patches: [] }, seal: { hash: 'sha256:c9d0e1f2a3b4', sealedAt: '2024-07-01T08:00:00Z', version: 1 }, classificationTag: 'public', tags: ['policy', 'ar-190-13'], _thread: 'Policy & Compliance', _created: '2024-07-01T08:00:00Z' },
                { claimId: 'CLAIM-2024-0010', statement: 'Peak gate traffic occurs 0700-0830 and 1630-1730 daily', scope: { where: 'All gates', when: 'FY25' }, truthType: 'observation', confidence: { score: 0.91, explanation: 'Based on 6-month traffic analysis from gate sensors' }, statusLight: 'green', sources: [{ ref: 'gate-sensor-data-2024', type: 'record', reliability: 'high' }], evidence: [{ ref: 'traffic-analysis-q1q2', type: 'record', summary: '6-month sensor data analysis' }], owner: 'SFC Williams', halfLife: { value: 60, unit: 'days', expiresAt: '2025-04-30T00:00:00Z', refreshTrigger: 'schedule' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:d0e1f2a3b4c5', sealedAt: '2024-11-05T12:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['access-control', 'traffic'], _thread: 'Access Control', _created: '2024-11-05T12:00:00Z' },
                // ── Law Enforcement claims ──
                { claimId: 'CLAIM-2024-0011', statement: 'All traffic stops require body camera activation before approach', scope: { where: 'Installation roadways', when: 'FY25' }, truthType: 'norm', confidence: { score: 0.96, explanation: 'HQDA guidance on law enforcement recording' }, statusLight: 'green', sources: [{ ref: 'hqda-le-recording-policy', type: 'document', reliability: 'high' }], evidence: [{ ref: 'bodycam-compliance-audit', type: 'record', summary: '98% compliance rate' }], owner: 'CW3 Martinez', halfLife: { value: 180, unit: 'days', expiresAt: '2025-05-15T00:00:00Z', refreshTrigger: 'new_source' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:e1f2a3b4c5d6', sealedAt: '2024-09-20T10:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['traffic', 'bodycam'], _thread: 'Traffic Enforcement', _created: '2024-09-20T10:00:00Z' },
                { claimId: 'CLAIM-2024-0012', statement: 'Use of Force = Any physical technique to control, restrain, or overcome resistance', scope: { where: 'Installation', when: 'Ongoing' }, truthType: 'norm', confidence: { score: 0.97, explanation: 'Aligned with DoD Law Enforcement Use of Force policy' }, statusLight: 'green', sources: [{ ref: 'dod-le-uof-policy', type: 'document', reliability: 'high' }], evidence: [{ ref: 'uof-policy-review', type: 'document', summary: 'Definition aligned with DoD standard' }], owner: 'CW3 Martinez', halfLife: { value: 365, unit: 'days', expiresAt: '2025-08-01T00:00:00Z', refreshTrigger: 'new_source' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:f2a3b4c5d6e7', sealedAt: '2024-08-15T14:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['patrol', 'use-of-force'], _thread: 'Patrol Operations', _created: '2024-08-15T14:00:00Z' },
                { claimId: 'CLAIM-2024-0013', statement: 'Average patrol response time under 5 minutes for Priority 1 calls', scope: { where: 'Installation', when: 'FY25' }, truthType: 'assumption', confidence: { score: 0.87, explanation: 'Based on 2024 Q1-Q3 data showing 4.2 minute average' }, statusLight: 'green', sources: [{ ref: 'dispatch-response-data', type: 'record', reliability: 'high' }], evidence: [{ ref: 'response-time-q1q3', type: 'record', summary: '4.2 min average response' }], owner: 'MSG Patterson', halfLife: { value: 30, unit: 'days', expiresAt: '2025-06-30T00:00:00Z', refreshTrigger: 'schedule' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:a3b4c5d6e7f8', sealedAt: '2024-10-01T09:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['patrol', 'response-time'], _thread: 'Emergency Response', _created: '2024-10-01T09:00:00Z' },
                { claimId: 'CLAIM-2024-0014', statement: 'Two-officer minimum for domestic disturbance responses', scope: { where: 'Installation housing', when: 'FY25' }, truthType: 'inference', confidence: { score: 0.94, explanation: 'Officer safety requirement based on incident analysis' }, statusLight: 'green', sources: [{ ref: 'incident-analysis-2024', type: 'record', reliability: 'high' }], evidence: [{ ref: 'domestic-incident-review', type: 'record', summary: 'Safety analysis supports 2-officer minimum' }], owner: 'CW3 Martinez', halfLife: { value: 90, unit: 'days', expiresAt: '2025-09-01T00:00:00Z', refreshTrigger: 'expiry' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:b4c5d6e7f8a9', sealedAt: '2024-09-10T11:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['patrol', 'domestic'], _thread: 'Patrol Operations', _created: '2024-09-10T11:00:00Z' },
                { claimId: 'CLAIM-2024-0015', statement: 'Community policing initiative reduced complaints by 34% in FY24', scope: { where: 'Installation', when: 'FY24' }, truthType: 'observation', confidence: { score: 0.89, explanation: 'Complaint tracking data comparison FY23 vs FY24' }, statusLight: 'green', sources: [{ ref: 'complaint-tracking-db', type: 'record', reliability: 'high' }], evidence: [{ ref: 'fy24-complaint-comparison', type: 'record', summary: '34% reduction documented' }], owner: 'MSG Patterson', halfLife: { value: 180, unit: 'days', expiresAt: '2025-12-31T00:00:00Z', refreshTrigger: 'schedule' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:c5d6e7f8a9b0', sealedAt: '2024-10-15T10:00:00Z', version: 1 }, classificationTag: 'public', tags: ['community', 'complaints'], _thread: 'Patrol Operations', _created: '2024-10-15T10:00:00Z' },
                // ── Corrections claims ──
                { claimId: 'CLAIM-2024-0016', statement: 'Confinement facility inspections conducted monthly minimum', scope: { where: 'Confinement facility', when: 'FY25' }, truthType: 'inference', confidence: { score: 0.93, explanation: 'Compliance requirement per AR 190-47' }, statusLight: 'green', sources: [{ ref: 'AR-190-47', type: 'document', reliability: 'high' }], evidence: [{ ref: 'inspection-log-2024', type: 'record', summary: 'Monthly inspections completed on schedule' }], owner: 'MSG Patterson', halfLife: { value: 30, unit: 'days', expiresAt: '2025-03-01T00:00:00Z', refreshTrigger: 'schedule' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:d6e7f8a9b0c1', sealedAt: '2024-11-10T10:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['corrections', 'inspection'], _thread: 'Policy & Compliance', _created: '2024-11-10T10:00:00Z' },
                { claimId: 'CLAIM-2024-0017', statement: 'Current confinement capacity sufficient for projected needs through FY26', scope: { where: 'Confinement facility', when: 'FY25-FY26' }, truthType: 'forecast', confidence: { score: 0.71, explanation: 'Based on trend analysis and population projections' }, statusLight: 'yellow', sources: [{ ref: 'population-projection-2024', type: 'record', reliability: 'medium' }], evidence: [{ ref: 'capacity-trend-analysis', type: 'record', summary: 'Trend analysis supports projection' }], owner: 'MSG Patterson', halfLife: { value: 60, unit: 'days', expiresAt: '2025-09-30T00:00:00Z', refreshTrigger: 'new_source' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:e7f8a9b0c1d2', sealedAt: '2024-11-25T14:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['corrections', 'capacity'], _thread: 'Resource Management', _created: '2024-11-25T14:00:00Z' },
                { claimId: 'CLAIM-2024-0018', statement: 'Maximum custody = Highest security classification requiring constant supervision', scope: { where: 'Confinement facility', when: 'Ongoing' }, truthType: 'norm', confidence: { score: 0.98, explanation: 'Per AR 190-47 custody classification standards' }, statusLight: 'green', sources: [{ ref: 'AR-190-47', type: 'document', reliability: 'high' }], evidence: [{ ref: 'custody-classification-guide', type: 'document', summary: 'Standard definition documented' }], owner: 'MSG Patterson', halfLife: { value: 365, unit: 'days', expiresAt: '2025-11-01T00:00:00Z', refreshTrigger: 'new_source' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:f8a9b0c1d2e3', sealedAt: '2024-08-20T10:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['corrections', 'classification'], _thread: 'Policy & Compliance', _created: '2024-08-20T10:00:00Z' },
                // ── Criminal Investigation claims ──
                { claimId: 'CLAIM-2024-0019', statement: 'Evidence chain of custody documented within 2 hours of collection', scope: { where: 'Evidence room', when: 'FY25' }, truthType: 'inference', confidence: { score: 0.95, explanation: 'Ensures evidence integrity for prosecution viability' }, statusLight: 'green', sources: [{ ref: 'evidence-sop-2024', type: 'document', reliability: 'high' }], evidence: [{ ref: 'evidence-intake-audit', type: 'record', summary: '97% compliance with 2hr window' }], owner: 'CW3 Martinez', halfLife: { value: 90, unit: 'days', expiresAt: '2025-04-15T00:00:00Z', refreshTrigger: 'expiry' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:a9b0c1d2e3f4', sealedAt: '2024-10-05T11:00:00Z', version: 1 }, classificationTag: 'restricted', tags: ['evidence', 'chain-of-custody'], _thread: 'Evidence Management', _created: '2024-10-05T11:00:00Z' },
                { claimId: 'CLAIM-2024-0020', statement: 'Digital forensics backlog cleared within 30 days of submission', scope: { where: 'Forensics lab', when: 'FY25' }, truthType: 'assumption', confidence: { score: 0.78, explanation: 'Based on current staffing and caseload analysis' }, statusLight: 'yellow', sources: [{ ref: 'forensics-workload-report', type: 'record', reliability: 'medium' }], evidence: [{ ref: 'backlog-trend-q3', type: 'record', summary: 'Current backlog trending within 30d' }], owner: 'CW3 Martinez', halfLife: { value: 30, unit: 'days', expiresAt: '2025-07-01T00:00:00Z', refreshTrigger: 'schedule' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:b0c1d2e3f4a5', sealedAt: '2024-10-20T13:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['forensics', 'backlog'], _thread: 'Criminal Investigations', _created: '2024-10-20T13:00:00Z' },
                { claimId: 'CLAIM-2024-0021', statement: 'Investigation timelines depend on digital forensics completion', scope: { where: 'CID office', when: 'FY25' }, truthType: 'constraint', confidence: { score: 0.84, explanation: 'Many cases require device analysis before closure' }, statusLight: 'yellow', sources: [{ ref: 'case-closure-analysis', type: 'record', reliability: 'medium' }], evidence: [{ ref: 'case-dependency-report', type: 'record', summary: '68% of cases require forensic analysis' }], owner: 'CW3 Martinez', halfLife: { value: 60, unit: 'days', expiresAt: '2025-03-10T00:00:00Z', refreshTrigger: 'expiry' }, graph: { dependsOn: ['CLAIM-2024-0020'], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:c1d2e3f4a5b6', sealedAt: '2024-11-01T15:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['investigations', 'forensics'], _thread: 'Criminal Investigations', _created: '2024-11-01T15:00:00Z' },
                // ── Workforce Development claims ──
                { claimId: 'CLAIM-2024-0022', statement: 'All new MPs complete 40-hour installation orientation within 30 days', scope: { where: 'Installation', when: 'FY25' }, truthType: 'inference', confidence: { score: 0.91, explanation: 'Ensures operational readiness and local policy familiarity' }, statusLight: 'green', sources: [{ ref: 'training-sop-2024', type: 'document', reliability: 'high' }], evidence: [{ ref: 'onboarding-completion-rate', type: 'record', summary: '96% completion within 30d window' }], owner: 'MSG Patterson', halfLife: { value: 90, unit: 'days', expiresAt: '2025-06-01T00:00:00Z', refreshTrigger: 'expiry' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:d2e3f4a5b6c7', sealedAt: '2024-10-01T09:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['training', 'onboarding'], _thread: 'Training & Readiness', _created: '2024-10-01T09:00:00Z' },
                { claimId: 'CLAIM-2024-0023', statement: 'Annual training completion rate will exceed 95% by end of FY25', scope: { where: 'Installation', when: 'FY25' }, truthType: 'forecast', confidence: { score: 0.48, explanation: 'Based on current trajectory but staffing gaps create risk' }, statusLight: 'red', sources: [{ ref: 'training-tracker-2024', type: 'record', reliability: 'medium' }], evidence: [{ ref: 'completion-trajectory', type: 'record', summary: 'Current rate 82%, trending up' }], owner: 'MSG Patterson', halfLife: { value: 30, unit: 'days', expiresAt: '2025-09-30T00:00:00Z', refreshTrigger: 'schedule' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:e3f4a5b6c7d8', sealedAt: '2024-11-15T10:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['training', 'forecast'], _thread: 'Training & Readiness', _created: '2024-11-15T10:00:00Z' },
                { claimId: 'CLAIM-2024-0024', statement: 'Certified = Completion of all mandatory training with passing scores', scope: { where: 'Installation', when: 'Ongoing' }, truthType: 'norm', confidence: { score: 0.96, explanation: 'Standard definition for personnel readiness reporting' }, statusLight: 'green', sources: [{ ref: 'readiness-reporting-guide', type: 'document', reliability: 'high' }], evidence: [{ ref: 'certification-standards', type: 'document', summary: 'Definition documented in readiness guide' }], owner: 'MSG Patterson', halfLife: { value: 365, unit: 'days', expiresAt: '2025-12-31T00:00:00Z', refreshTrigger: 'new_source' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:f4a5b6c7d8e9', sealedAt: '2024-07-15T08:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['training', 'certification'], _thread: 'Policy & Compliance', _created: '2024-07-15T08:00:00Z' },
                { claimId: 'CLAIM-2024-0025', statement: 'Cross-training program increased multi-role qualified personnel by 28%', scope: { where: 'Installation', when: 'FY24' }, truthType: 'observation', confidence: { score: 0.86, explanation: 'Personnel qualification database comparison' }, statusLight: 'green', sources: [{ ref: 'personnel-qual-db', type: 'record', reliability: 'high' }], evidence: [{ ref: 'cross-training-metrics', type: 'record', summary: '28% increase documented in qual DB' }], owner: 'MSG Patterson', halfLife: { value: 180, unit: 'days', expiresAt: '2025-06-30T00:00:00Z', refreshTrigger: 'schedule' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:a5b6c7d8e9f0', sealedAt: '2024-10-10T14:00:00Z', version: 1 }, classificationTag: 'public', tags: ['training', 'cross-training'], _thread: 'Training & Readiness', _created: '2024-10-10T14:00:00Z' },
                { claimId: 'CLAIM-2025-0001', statement: 'Badge renewal requires updated background check if >3 years since last', scope: { where: 'Badge Office', when: 'FY25' }, truthType: 'inference', confidence: { score: 0.93, explanation: 'Risk mitigation for personnel with outdated vetting' }, statusLight: 'green', sources: [{ ref: 'vetting-policy-2025', type: 'document', reliability: 'high' }], evidence: [{ ref: 'background-check-gap-analysis', type: 'record', summary: '12% of renewals have >3yr gap' }], owner: 'CPT Rodriguez', halfLife: { value: 90, unit: 'days', expiresAt: '2025-12-01T00:00:00Z', refreshTrigger: 'expiry' }, graph: { dependsOn: [], contradicts: [], supersedes: null, supports: [], patches: [] }, seal: { hash: 'sha256:b6c7d8e9f0a1', sealedAt: '2025-01-05T10:00:00Z', version: 1 }, classificationTag: 'internal', tags: ['badge-ops', 'background-check'], _thread: 'Badge Operations', _created: '2025-01-05T10:00:00Z' }
            ],
            ciTrend: [78,79,78,80,79,81,80,82,81,80,82,83,82,81,83,82,81,82,83,82,81,82,83,82,83,84,83,82,83,82.4],
            expiryDays: [3, 7, 14, 21, 28]
        };

        let notificationsEnabled = true;

        // Initialize
        function init() {
            loadState();

            // Recompute statusLight for all claims
            data.claims.forEach(function(c) { c.statusLight = deriveStatusLight(c); });
            // Recompute status counts
            data.statusCounts = { green: 0, yellow: 0, red: 0 };
            data.claims.forEach(function(c) { data.statusCounts[c.statusLight] = (data.statusCounts[c.statusLight] || 0) + 1; });

            updateTimestamp();
            setInterval(updateTimestamp, 1000);

            renderMetrics();
            renderActivity();
            renderBarChart();
            renderDonutChart();
            renderDimensions();
            renderAlerts();
            renderClaimsTable();
            renderTrendChart();
            renderCalendar();
            renderDriftPanel();
            populateBlastSelect();
            renderBlastRadius();

            animateDashboard();
            setupEventListeners();
            setupDependencySearch();

            // Demo notification
            setTimeout(() => showToast('info', 'Dashboard v2.0', 'DeepSigma-aligned coherence engine active'), 1000);
        }

        function updateTimestamp() {
            document.getElementById('timestamp').textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
        }

        // Render Functions
        function renderMetrics() {
            document.getElementById('metricsGrid').innerHTML = data.metrics.map(m => `
                <div class="metric-card ${m.color}" onclick="showMetricDetail('${m.label}')">
                    <div class="metric-header">
                        <span class="metric-icon">${m.icon}</span>
                        <span class="metric-change ${m.up ? 'up' : 'down'}">${m.up ? '↑' : '↓'} ${m.change}</span>
                    </div>
                    <div class="metric-value" data-target="${m.value}">0</div>
                    <div class="metric-label">${m.label}</div>
                    <div class="metric-spark">${m.spark.map(v => `<div class="spark-bar" style="height:${v}%"></div>`).join('')}</div>
                </div>
            `).join('');
        }

        function renderActivity() {
            document.getElementById('activityFeed').innerHTML = data.activities.map(a => `
                <div class="activity-item" onclick="showToast('info', '${a.title}', '${a.desc}')">
                    <div class="activity-icon ${a.type}">${a.icon}</div>
                    <div class="activity-content">
                        <div class="activity-title">${a.title}</div>
                        <div class="activity-desc">${a.desc}</div>
                    </div>
                    <div class="activity-time">${a.time}</div>
                </div>
            `).join('');
        }

        function renderBarChart() {
            const max = Math.max(...data.types.map(t => t.value));
            document.getElementById('barChart').innerHTML = data.types.map(t => `
                <div class="bar-row">
                    <span class="bar-label">${t.name}</span>
                    <div class="bar-track">
                        <div class="bar-fill ${t.color}" data-width="${(t.value/max)*100}"></div>
                    </div>
                    <span class="bar-value">${t.value}</span>
                </div>
            `).join('');
        }

        function renderDimensions() {
            var dims = data.coherenceReport.dimensions;
            document.getElementById('dimensionsList').innerHTML = dims.map(function(d) {
                var color = d.score >= 80 ? 'green' : d.score >= 60 ? 'yellow' : 'red';
                return '<div class="dimension-row" onclick="showDimensionDetail(\'' + escapeHtml(d.name) + '\')">' +
                    '<div class="dimension-header">' +
                        '<div class="dimension-name">' +
                            '<span>' + escapeHtml(d.label) + '</span>' +
                            '<span class="dimension-weight">w=' + d.weight.toFixed(2) + '</span>' +
                        '</div>' +
                        '<span class="dimension-score" style="color:var(--' + (color === 'green' ? 'success' : color === 'yellow' ? 'warning' : 'danger') + ')">' + d.score.toFixed(1) + '</span>' +
                    '</div>' +
                    '<div class="dimension-bar">' +
                        '<div class="dimension-fill ' + color + '" data-width="' + d.score + '"></div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function renderAlerts() {
            // Derive alerts from drift signals + half-life warnings + contradictions
            var alerts = [];

            // Red drift signals → critical alerts
            data.driftSignals.forEach(function(ds) {
                if (ds.severity === 'red') {
                    alerts.push({ type: 'critical', icon: '🔴', title: ds.driftId + ' ' + ds.driftType.toUpperCase(), desc: ds.notes, meta: 'Patch: ' + ds.recommendedPatchType });
                }
            });

            // Yellow drift signals → warnings
            data.driftSignals.forEach(function(ds) {
                if (ds.severity === 'yellow') {
                    alerts.push({ type: 'warning', icon: '🟡', title: ds.driftId + ' ' + ds.driftType, desc: ds.notes, meta: 'Patch: ' + ds.recommendedPatchType });
                }
            });

            // Claims near half-life expiry
            data.claims.forEach(function(c) {
                var daysLeft = halfLifeDaysRemaining(c);
                if (daysLeft <= 14 && daysLeft > 0) {
                    alerts.push({ type: 'warning', icon: '⏳', title: c.claimId + ' HALF-LIFE ' + daysLeft + 'D', desc: c.statement.substring(0, 50) + '...', meta: 'Owner: ' + c.owner });
                }
            });

            // Claims with contradictions
            data.claims.forEach(function(c) {
                if (c.graph.contradicts && c.graph.contradicts.length > 0) {
                    alerts.push({ type: 'critical', icon: '⚔️', title: c.claimId + ' CONTRADICTION', desc: 'Contradicts: ' + c.graph.contradicts.join(', '), meta: c.owner });
                }
            });

            // Sort: critical first
            alerts.sort(function(a, b) { return a.type === 'critical' && b.type !== 'critical' ? -1 : 1; });

            var countEl = document.getElementById('alertCount');
            if (countEl) countEl.textContent = alerts.length;

            document.getElementById('alertsList').innerHTML = alerts.slice(0, 8).map(function(a) {
                return '<div class="alert-item ' + a.type + '" onclick="showAlertDetail(\'' + escapeHtml(a.title) + '\')">' +
                    '<span class="alert-icon">' + a.icon + '</span>' +
                    '<div class="alert-content">' +
                        '<div class="alert-title">' + escapeHtml(a.title) + '</div>' +
                        '<div class="alert-desc">' + escapeHtml(a.desc) + '</div>' +
                        '<div class="alert-meta">' + escapeHtml(a.meta) + '</div>' +
                    '</div>' +
                    '<div class="alert-actions">' +
                        '<button class="alert-btn alert-btn-primary" onclick="event.stopPropagation(); handleAction(\'review\')">Review</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function renderClaimsTable() {
            document.getElementById('claimsTable').innerHTML = data.claims.map(function(c) {
                var daysLeft = halfLifeDaysRemaining(c);
                var hlClass = daysLeft <= 7 ? 'urgent' : daysLeft <= 30 ? 'warning' : 'ok';
                var hlText = daysLeft === Infinity ? '—' : daysLeft + 'd';
                var confColor = c.confidence.score >= 0.80 ? 'var(--success)' : c.confidence.score >= 0.50 ? 'var(--warning)' : 'var(--danger)';
                return '<tr onclick="showClaimDetail(\'' + escapeHtml(c.claimId) + '\')">' +
                    '<td><span class="claim-id">' + escapeHtml(c.claimId) + '</span></td>' +
                    '<td><span class="claim-type ' + escapeHtml(c.truthType) + '">' + escapeHtml(truthTypeShort(c.truthType)) + '</span></td>' +
                    '<td>' + escapeHtml(c.statement.substring(0, 45)) + '...</td>' +
                    '<td>' + escapeHtml(c.owner) + '</td>' +
                    '<td><span class="status-light ' + escapeHtml(c.statusLight) + '">' + escapeHtml(c.statusLight) + '</span></td>' +
                    '<td><div class="conf-bar"><div class="conf-bar-track"><div class="conf-bar-fill" style="width:' + (c.confidence.score * 100) + '%;background:' + confColor + '"></div></div><span class="conf-bar-value">' + c.confidence.score.toFixed(2) + '</span></div></td>' +
                    '<td><span class="halflife-badge ' + hlClass + '">' + escapeHtml(hlText) + '</span></td>' +
                    '<td><button class="btn btn-secondary btn-icon" onclick="event.stopPropagation(); showClaimDetail(\'' + escapeHtml(c.claimId) + '\')" title="View">👁️</button></td>' +
                '</tr>';
            }).join('');
        }

        function renderTrendChart() {
            const svg = document.getElementById('trendChart');
            const points = data.ciTrend.map((v, i) => ({
                x: (i / (data.ciTrend.length - 1)) * 480 + 10,
                y: 160 - ((v - 70) / 30) * 140
            }));
            
            const pathData = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
            const areaData = pathData + ` L ${points[points.length-1].x} 160 L ${points[0].x} 160 Z`;
            
            svg.innerHTML += `
                <path d="${areaData}" fill="url(#trendGradient)"/>
                <path d="${pathData}" fill="none" stroke="#22c55e" stroke-width="2"/>
                <circle cx="${points[points.length-1].x}" cy="${points[points.length-1].y}" r="5" fill="#22c55e"/>
            `;
        }

        function renderCalendar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const todayDate = now.getDate();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDay = new Date(year, month, 1).getDay();
            const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

            var titleEl = document.getElementById('calendarTitle');
            if (titleEl) titleEl.textContent = 'Half-Life Calendar - ' + monthNames[month] + ' ' + year;

            // Build half-life expiry days from claim data
            var expiryDaysSet = {};
            data.claims.forEach(function(c) {
                if (!c.halfLife || !c.halfLife.expiresAt) return;
                var parsed = new Date(c.halfLife.expiresAt);
                if (parsed && parsed.getFullYear() === year && parsed.getMonth() === month) {
                    var d = parsed.getDate();
                    if (!expiryDaysSet[d]) expiryDaysSet[d] = [];
                    expiryDaysSet[d].push({ claimId: c.claimId, statusLight: c.statusLight });
                }
            });

            const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            let html = days.map(d => '<div class="calendar-header">' + d + '</div>').join('');

            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day muted"></div>';
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const isToday = d === todayDate;
                const dayData = expiryDaysSet[d];
                const hasExpiry = !!dayData;
                // Color dot by worst statusLight on that day
                var dotColor = '';
                if (dayData) {
                    if (dayData.some(function(x) { return x.statusLight === 'red'; })) dotColor = 'red';
                    else if (dayData.some(function(x) { return x.statusLight === 'yellow'; })) dotColor = 'yellow';
                    else dotColor = 'green';
                }
                html += '<div class="calendar-day ' + (isToday ? 'today' : '') + ' ' + (hasExpiry ? 'has-expiry' : '') + '" ' +
                    'onclick="showDayDetail(' + d + ')" ' +
                    (dotColor ? 'style="border-bottom: 2px solid var(--' + (dotColor === 'green' ? 'success' : dotColor === 'yellow' ? 'warning' : 'danger') + ')"' : '') +
                    '>' + d + '</div>';
            }

            document.getElementById('calendar').innerHTML = html;
        }

        function renderDriftPanel() {
            var signals = data.driftSignals;
            if (!signals || signals.length === 0) return;

            // Summary grid
            var byType = {};
            var bySeverity = { green: 0, yellow: 0, red: 0 };
            signals.forEach(function(ds) {
                byType[ds.driftType] = (byType[ds.driftType] || 0) + 1;
                bySeverity[ds.severity] = (bySeverity[ds.severity] || 0) + 1;
            });

            var totalBadge = document.getElementById('driftTotalBadge');
            if (totalBadge) totalBadge.textContent = signals.length;

            var summaryGrid = document.getElementById('driftSummaryGrid');
            if (summaryGrid) {
                summaryGrid.innerHTML =
                    '<div class="drift-summary-card"><div class="drift-summary-value">' + signals.length + '</div><div class="drift-summary-label">Total Signals</div></div>' +
                    '<div class="drift-summary-card"><div class="drift-summary-value" style="color:var(--danger)">' + bySeverity.red + '</div><div class="drift-summary-label">Red (Critical)</div></div>' +
                    '<div class="drift-summary-card"><div class="drift-summary-value" style="color:var(--warning)">' + bySeverity.yellow + '</div><div class="drift-summary-label">Yellow</div></div>' +
                    '<div class="drift-summary-card"><div class="drift-summary-value" style="color:var(--success)">' + bySeverity.green + '</div><div class="drift-summary-label">Green</div></div>';
            }

            // Drift type bar chart
            var driftTypeChart = document.getElementById('driftTypeChart');
            if (driftTypeChart) {
                var allTypes = ['time','freshness','fallback','bypass','verify','outcome','fanout','contention'];
                var maxVal = Math.max.apply(null, allTypes.map(function(t) { return byType[t] || 0; }));
                if (maxVal === 0) maxVal = 1;
                driftTypeChart.innerHTML = allTypes.map(function(t) {
                    var val = byType[t] || 0;
                    return '<div class="bar-row">' +
                        '<span class="bar-label">' + t + '</span>' +
                        '<div class="bar-track"><div class="bar-fill orange" data-width="' + ((val / maxVal) * 100) + '"></div></div>' +
                        '<span class="bar-value">' + val + '</span>' +
                    '</div>';
                }).join('');
            }

            // Drift signal list
            var driftList = document.getElementById('driftList');
            if (driftList) {
                driftList.innerHTML = signals.map(function(ds) {
                    return '<div class="drift-signal severity-' + ds.severity + '" onclick="showDriftDetail(\'' + escapeHtml(ds.driftId) + '\')">' +
                        '<div class="drift-severity ' + ds.severity + '"></div>' +
                        '<div class="drift-content">' +
                            '<div class="drift-title">' + escapeHtml(ds.driftId) + ' <span class="drift-type-badge">' + escapeHtml(ds.driftType) + '</span></div>' +
                            '<div class="drift-meta">' + escapeHtml(ds.notes) + '</div>' +
                        '</div>' +
                        '<span class="drift-patch-badge">' + escapeHtml(ds.recommendedPatchType) + '</span>' +
                    '</div>';
                }).join('');
            }
        }

        function buildDependencyGraph() {
            // Build full graph adjacency from claim.graph edges
            var dependents = {}; // claimId -> [claimIds that depend on it]
            var allEdges = []; // { from, to, kind }
            data.claims.forEach(function(c) {
                var g = c.graph || {};
                (g.dependsOn || []).forEach(function(depId) {
                    if (!dependents[depId]) dependents[depId] = [];
                    dependents[depId].push(c.claimId);
                    allEdges.push({ from: c.claimId, to: depId, kind: 'dependsOn' });
                });
                (g.supports || []).forEach(function(supId) {
                    allEdges.push({ from: c.claimId, to: supId, kind: 'supports' });
                });
                (g.contradicts || []).forEach(function(conId) {
                    allEdges.push({ from: c.claimId, to: conId, kind: 'contradicts' });
                });
                if (g.supersedes) {
                    allEdges.push({ from: c.claimId, to: g.supersedes, kind: 'supersedes' });
                }
                (g.patches || []).forEach(function(pId) {
                    allEdges.push({ from: c.claimId, to: pId, kind: 'patches' });
                });
            });
            dependents._allEdges = allEdges;
            return dependents;
        }

        function populateBlastSelect() {
            var select = document.getElementById('blastSelect');
            if (!select) return;
            var depGraph = buildDependencyGraph();

            // Include claims that have graph edges
            var candidates = data.claims.filter(function(c) {
                var g = c.graph || {};
                return (depGraph[c.claimId] && depGraph[c.claimId].length > 0) ||
                    (g.dependsOn && g.dependsOn.length > 0) ||
                    (g.supports && g.supports.length > 0) ||
                    (g.contradicts && g.contradicts.length > 0) ||
                    g.supersedes;
            });

            if (candidates.length === 0) candidates = data.claims.slice(0, 10);

            select.innerHTML = candidates.map(function(c) {
                return '<option value="' + escapeHtml(c.claimId) + '">' + escapeHtml(c.claimId) + ' - ' + escapeHtml(c.statement.substring(0, 30)) + '</option>';
            }).join('');

            select.addEventListener('change', function() {
                renderBlastRadius(this.value);
            });
        }

        function renderBlastRadius(rootId) {
            var container = document.getElementById('blastContainer');
            if (!container) return;

            if (!rootId) {
                var select = document.getElementById('blastSelect');
                rootId = select ? select.value : (data.claims[0] || {}).claimId;
            }
            if (!rootId) { container.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:40px;">No claims available</p>'; return; }

            var depGraph = buildDependencyGraph();
            var allEdges = depGraph._allEdges || [];

            // Gather neighbors (all edge types)
            var rootClaim = data.claims.find(function(c) { return c.claimId === rootId; });
            var level1Set = {};
            // Dependents of root
            (depGraph[rootId] || []).forEach(function(id) { level1Set[id] = true; });
            // All graph edges from root
            if (rootClaim && rootClaim.graph) {
                var g = rootClaim.graph;
                (g.dependsOn || []).forEach(function(id) { level1Set[id] = true; });
                (g.supports || []).forEach(function(id) { level1Set[id] = true; });
                (g.contradicts || []).forEach(function(id) { level1Set[id] = true; });
                if (g.supersedes) level1Set[g.supersedes] = true;
                (g.patches || []).forEach(function(id) { level1Set[id] = true; });
            }
            var level1 = Object.keys(level1Set);

            // Level 2
            var level2Set = {};
            level1.forEach(function(l1Id) {
                (depGraph[l1Id] || []).forEach(function(id) {
                    if (id !== rootId && !level1Set[id]) level2Set[id] = true;
                });
                var l1Claim = data.claims.find(function(c) { return c.claimId === l1Id; });
                if (l1Claim && l1Claim.graph) {
                    (l1Claim.graph.dependsOn || []).forEach(function(id) {
                        if (id !== rootId && !level1Set[id]) level2Set[id] = true;
                    });
                }
            });
            var level2 = Object.keys(level2Set);

            // Layout
            var cx = 250, cy = 140, r1 = 100, r2 = 140;
            var rootNode = { id: rootId, x: cx, y: cy };

            function circlePos(arr, radius, centerX, centerY) {
                return arr.map(function(id, i) {
                    var angle = (2 * Math.PI * i / arr.length) - Math.PI / 2;
                    return { id: id, x: Math.round(centerX + radius * Math.cos(angle)), y: Math.round(centerY + radius * Math.sin(angle)) };
                });
            }

            var l1Nodes = circlePos(level1, r1, cx, cy);
            var l2Nodes = circlePos(level2, r2, cx, cy);
            var allNodesMap = {};
            allNodesMap[rootId] = rootNode;
            l1Nodes.forEach(function(n) { allNodesMap[n.id] = n; });
            l2Nodes.forEach(function(n) { allNodesMap[n.id] = n; });

            // Edge color classes
            var edgeClass = { dependsOn: 'blast-edge-depends', contradicts: 'blast-edge-contradicts', supersedes: 'blast-edge-supersedes', supports: 'blast-edge-supports', patches: 'blast-edge-patches' };

            // SVG
            var svg = '<svg class="blast-svg" viewBox="0 0 500 280">';

            // Draw edges with typed colors
            allEdges.forEach(function(e) {
                var fromNode = allNodesMap[e.from];
                var toNode = allNodesMap[e.to];
                if (!fromNode || !toNode) return;
                var cls = edgeClass[e.kind] || 'blast-line';
                svg += '<line class="blast-line ' + cls + '" x1="' + fromNode.x + '" y1="' + fromNode.y + '" x2="' + toNode.x + '" y2="' + toNode.y + '" stroke-width="2"/>';
            });

            // Fallback lines for nodes without typed edges
            l1Nodes.forEach(function(n) {
                var hasEdge = allEdges.some(function(e) {
                    return (e.from === rootId && e.to === n.id) || (e.from === n.id && e.to === rootId);
                });
                if (!hasEdge) {
                    svg += '<line class="blast-line blast-edge-depends" x1="' + rootNode.x + '" y1="' + rootNode.y + '" x2="' + n.x + '" y2="' + n.y + '" stroke-width="2"/>';
                }
            });

            // Level 2 nodes
            l2Nodes.forEach(function(n) {
                svg += '<g class="blast-node" onclick="showClaimDetail(\'' + escapeHtml(n.id) + '\')">' +
                    '<circle class="node-circle" cx="' + n.x + '" cy="' + n.y + '" r="22" fill="#3b82f6"/>' +
                    '<text class="node-text" x="' + n.x + '" y="' + (n.y + 1) + '" style="font-size:7px">' + escapeHtml(n.id.replace('CLAIM-','')) + '</text>' +
                '</g>';
            });

            // Level 1 nodes
            l1Nodes.forEach(function(n) {
                svg += '<g class="blast-node" onclick="showClaimDetail(\'' + escapeHtml(n.id) + '\')">' +
                    '<circle class="node-circle" cx="' + n.x + '" cy="' + n.y + '" r="26" fill="#eab308"/>' +
                    '<text class="node-text" x="' + n.x + '" y="' + (n.y + 1) + '" style="font-size:7px">' + escapeHtml(n.id.replace('CLAIM-','')) + '</text>' +
                '</g>';
            });

            // Root node
            svg += '<g class="blast-node" onclick="showClaimDetail(\'' + escapeHtml(rootNode.id) + '\')">' +
                '<circle class="node-circle" cx="' + rootNode.x + '" cy="' + rootNode.y + '" r="35" fill="#ef4444"/>' +
                '<text class="node-text" x="' + rootNode.x + '" y="' + (rootNode.y - 4) + '" style="font-size:7px">' + escapeHtml(rootId.replace('CLAIM-','').split('-')[0]) + '</text>' +
                '<text class="node-text" x="' + rootNode.x + '" y="' + (rootNode.y + 8) + '" style="font-size:7px">' + escapeHtml(rootId.replace('CLAIM-','').split('-')[1] || '') + '</text>' +
            '</g>';

            svg += '</svg>';

            // Legend with edge types
            svg += '<div class="blast-legend">' +
                '<div class="blast-legend-item"><div class="blast-legend-dot root"></div>Source</div>' +
                '<div class="blast-legend-item"><div class="blast-legend-dot level1"></div>Direct (' + level1.length + ')</div>' +
                '<div class="blast-legend-item"><div class="blast-legend-dot level2"></div>Indirect (' + level2.length + ')</div>' +
            '</div>' +
            '<div class="blast-legend" style="margin-top:6px;">' +
                '<div class="blast-legend-edge"><div class="blast-legend-line" style="background:var(--info)"></div>dependsOn</div>' +
                '<div class="blast-legend-edge"><div class="blast-legend-line" style="background:var(--success)"></div>supports</div>' +
                '<div class="blast-legend-edge"><div class="blast-legend-line" style="background:var(--danger)"></div>contradicts</div>' +
                '<div class="blast-legend-edge"><div class="blast-legend-line" style="background:var(--accent)"></div>supersedes</div>' +
                '<div class="blast-legend-edge"><div class="blast-legend-line" style="background:var(--purple)"></div>patches</div>' +
            '</div>';

            container.innerHTML = svg;
        }

        function renderDonutChart() {
            // Animated in animateDashboard
        }

        // Animation
        function animateDashboard() {
            var ciScore = data.coherenceReport.overall;
            var grade = data.coherenceReport.grade;

            // CI Gauge + Grade
            setTimeout(() => {
                document.getElementById('ciGauge').style.strokeDashoffset = 201 * (1 - ciScore / 100);
                animateNumber(document.getElementById('ciValue'), ciScore, 2000);
                var gradeEl = document.getElementById('ciGrade');
                if (gradeEl) { gradeEl.textContent = grade; gradeEl.className = 'grade-badge ' + grade; }
                var statusText = document.getElementById('ciStatusText');
                if (statusText) statusText.textContent = ciScore >= 75 ? 'System Healthy' : ciScore >= 60 ? 'Needs Attention' : 'Critical';
                var badge = document.getElementById('ciBadge');
                if (badge) {
                    badge.textContent = ciScore >= 75 ? 'Healthy' : ciScore >= 60 ? 'Warning' : 'Critical';
                    badge.className = 'card-badge ' + (ciScore >= 75 ? 'badge-success' : ciScore >= 60 ? 'badge-warning' : 'badge-danger');
                }
            }, 300);

            // Metrics
            setTimeout(() => {
                document.querySelectorAll('.metric-value[data-target]').forEach((el, i) => {
                    setTimeout(() => animateNumber(el, parseInt(el.dataset.target)), i * 100);
                });
            }, 400);

            // Bars
            setTimeout(() => {
                document.querySelectorAll('.bar-fill[data-width]').forEach((b, i) => {
                    setTimeout(() => b.style.width = b.dataset.width + '%', i * 80);
                });
            }, 600);

            // Donut (statusLight: green/yellow/red)
            const total = Object.values(data.statusCounts).reduce((a, b) => a + b, 0);
            const circumference = 2 * Math.PI * 50;
            setTimeout(() => {
                animateNumber(document.getElementById('donutTotal'), total, 1500);
                // Update legend
                var pct = function(v) { return total > 0 ? Math.round(v / total * 100) : 0; };
                var lg = document.getElementById('legendGreen'); if (lg) lg.textContent = data.statusCounts.green + ' (' + pct(data.statusCounts.green) + '%)';
                var ly = document.getElementById('legendYellow'); if (ly) ly.textContent = data.statusCounts.yellow + ' (' + pct(data.statusCounts.yellow) + '%)';
                var lr = document.getElementById('legendRed'); if (lr) lr.textContent = data.statusCounts.red + ' (' + pct(data.statusCounts.red) + '%)';

                let offset = 0;
                [
                    { id: 'donutGreen', value: data.statusCounts.green },
                    { id: 'donutYellow', value: data.statusCounts.yellow },
                    { id: 'donutRed', value: data.statusCounts.red }
                ].forEach((seg, i) => {
                    setTimeout(() => {
                        const el = document.getElementById(seg.id);
                        if (!el) return;
                        const len = circumference * (seg.value / total);
                        el.style.strokeDasharray = `${len} ${circumference}`;
                        el.style.strokeDashoffset = -offset;
                        offset += len;
                    }, i * 150);
                });
            }, 700);

            // Dimension bars
            setTimeout(() => {
                document.querySelectorAll('.dimension-fill[data-width]').forEach((f, i) => {
                    setTimeout(() => f.style.width = f.dataset.width + '%', i * 100);
                });
            }, 900);
        }

        function animateNumber(el, target, duration = 1500) {
            const start = performance.now();
            const isDecimal = !Number.isInteger(target);
            
            function update(now) {
                const progress = Math.min((now - start) / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 4);
                const current = target * eased;
                el.textContent = isDecimal ? current.toFixed(1) : Math.round(current);
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        // Event Listeners
        function setupEventListeners() {
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', function() {
                this.classList.toggle('active');
                document.body.classList.toggle('light-theme');
                showToast('info', 'Theme Changed', document.body.classList.contains('light-theme') ? 'Light mode' : 'Dark mode');
                saveState();
            });

            // Notifications toggle
            document.getElementById('notifToggle').addEventListener('click', function() {
                this.classList.toggle('active');
                notificationsEnabled = this.classList.contains('active');
                showToast('info', 'Notifications', notificationsEnabled ? 'Enabled' : 'Disabled');
                saveState();
            });

            // Tabs
            document.querySelectorAll('.header-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Nav items
            document.querySelectorAll('.nav-item[data-view]').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    this.classList.add('active');
                    switchTab(this.dataset.view);
                });
            });

            // Mobile nav items
            document.querySelectorAll('.mobile-nav-item[data-tab]').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.mobile-nav-item').forEach(n => n.classList.remove('active'));
                    this.classList.add('active');
                    switchTab(this.dataset.tab);
                });
            });

            // Filter presets
            document.querySelectorAll('.filter-preset').forEach(preset => {
                preset.addEventListener('click', function() {
                    document.querySelectorAll('.filter-preset').forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    applyFilter(this.dataset.filter);
                });
            });

            // Keyboard
            document.addEventListener('keydown', e => {
                // Escape closes everything
                if (e.key === 'Escape') {
                    closeModal();
                    closeCommandPalette();
                    hideContextMenu();
                }
                // Cmd/Ctrl+K opens command palette
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    openCommandPalette();
                }
                // Cmd/Ctrl+Z for undo
                if ((e.metaKey || e.ctrlKey) && e.key === 'z') {
                    e.preventDefault();
                    undoLastAction();
                }
                // Number keys for tabs (when not in input)
                if (!e.target.matches('input, select, textarea')) {
                    if (e.key === '1') switchTab('overview');
                    if (e.key === '2') switchTab('claims');
                    if (e.key === '3') switchTab('drift');
                    if (e.key === '4') switchTab('analysis');
                    if (e.key === '5') switchTab('blast');
                    if (e.key === '6') switchTab('compare');
                    if (e.key === 'r') refreshDashboard();
                    if (e.key === 't') document.getElementById('themeToggle').click();
                    if (e.key === 'F11') { e.preventDefault(); toggleFullscreen(); }
                }
            });

            // Command palette input
            document.getElementById('cmdInput').addEventListener('input', function() {
                renderCommandResults(this.value);
            });

            // Click outside closes context menu
            document.addEventListener('click', hideContextMenu);

            // Search
            document.getElementById('searchInput').addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length >= 2) {
                    const results = data.claims.filter(c =>
                        c.claimId.toLowerCase().includes(query) ||
                        c.statement.toLowerCase().includes(query)
                    );
                    if (results.length > 0) {
                        showToast('info', 'Search Results', `Found ${results.length} claim(s)`);
                    }
                }
            });
        }

        function switchTab(tab) {
            document.querySelectorAll('.header-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + 'Content').classList.add('active');
            if (tab === 'newclaim') loadDraft();
            if (tab === 'drift') renderDriftPanel();
        }

        // Actions
        function refreshDashboard() {
            const icon = document.getElementById('refreshIcon');
            icon.style.animation = 'spin 1s linear infinite';
            
            document.querySelectorAll('.bar-fill').forEach(b => b.style.width = '0');
            document.querySelectorAll('.dimension-fill').forEach(g => g.style.width = '0');
            document.getElementById('ciGauge').style.strokeDashoffset = 201;
            
            setTimeout(() => {
                icon.style.animation = '';
                animateDashboard();
                showToast('success', 'Dashboard Refreshed', 'Data updated');
            }, 1000);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        function toggleFullscreen() {
            document.getElementById('app').classList.toggle('fullscreen');
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function exportData() {
            const csv = ['ClaimID,TruthType,Statement,Owner,StatusLight,Confidence,HalfLifeDays,Scope'];
            data.claims.forEach(c => {
                var hlDays = halfLifeDaysRemaining(c);
                csv.push(c.claimId + ',' + c.truthType + ',"' + c.statement.replace(/"/g, '""') + '",' + c.owner + ',' + c.statusLight + ',' + c.confidence.score + ',' + (hlDays === Infinity ? '' : hlDays) + ',"' + (c.scope.where || '') + ' / ' + (c.scope.when || '') + '"');
            });

            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'edge_claims_export.csv';
            a.click();

            showToast('success', 'Export Complete', 'Claims exported to CSV');
        }

        function handleAction(action, id) {
            const actions = {
                review: 'Claim sent for review',
                extend: `Extended ${id} by 30 days`,
                challenge: `Challenge filed for ${id}`,
                archive: `${id} archived`
            };
            showToast('success', 'Action Complete', actions[action] || 'Action completed');
            if (id) saveState();
        }

        // Modals
        function showClaimDetail(id) {
            var claim = data.claims.find(function(c) { return c.claimId === id; });
            if (!claim) {
                claim = { claimId: id, truthType: 'observation', statement: 'Claim not found', owner: 'Unknown', statusLight: 'yellow', confidence: { score: 0, explanation: '' }, halfLife: { value: 30, unit: 'days' }, scope: {}, graph: { dependsOn: [], contradicts: [], supports: [] }, sources: [], evidence: [], seal: {} };
            }

            var daysLeft = halfLifeDaysRemaining(claim);
            var hlText = daysLeft === Infinity ? '—' : daysLeft + ' days remaining';
            var graphEdges = [];
            if (claim.graph.dependsOn && claim.graph.dependsOn.length) graphEdges.push('Depends on: ' + claim.graph.dependsOn.join(', '));
            if (claim.graph.supports && claim.graph.supports.length) graphEdges.push('Supports: ' + claim.graph.supports.join(', '));
            if (claim.graph.contradicts && claim.graph.contradicts.length) graphEdges.push('Contradicts: ' + claim.graph.contradicts.join(', '));
            if (claim.graph.supersedes) graphEdges.push('Supersedes: ' + claim.graph.supersedes);

            document.getElementById('modalTitle').textContent = claim.claimId;
            document.getElementById('modalBody').innerHTML =
                '<div class="claim-detail-grid">' +
                    '<div class="detail-item"><div class="detail-label">Truth Type</div><div class="detail-value"><span class="claim-type ' + escapeHtml(claim.truthType) + '">' + escapeHtml(claim.truthType) + '</span></div></div>' +
                    '<div class="detail-item"><div class="detail-label">Status Light</div><div class="detail-value"><span class="status-light ' + escapeHtml(claim.statusLight) + '">' + escapeHtml(claim.statusLight) + '</span></div></div>' +
                    '<div class="detail-item"><div class="detail-label">Confidence</div><div class="detail-value" style="font-weight:700;color:' + (claim.confidence.score >= 0.80 ? 'var(--success)' : claim.confidence.score >= 0.50 ? 'var(--warning)' : 'var(--danger)') + '">' + claim.confidence.score.toFixed(2) + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">Owner</div><div class="detail-value">' + escapeHtml(claim.owner) + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">Half-Life</div><div class="detail-value">' + escapeHtml(claim.halfLife.value + ' ' + claim.halfLife.unit) + ' (' + escapeHtml(hlText) + ')</div></div>' +
                    '<div class="detail-item"><div class="detail-label">Scope</div><div class="detail-value">' + escapeHtml((claim.scope.where || '') + ' / ' + (claim.scope.when || '')) + '</div></div>' +
                '</div>' +
                '<div class="claim-statement"><div class="claim-statement-label">Statement</div><div class="claim-statement-text">' + escapeHtml(claim.statement) + '</div></div>' +
                '<div class="claim-statement" style="border-left-color: var(--info);"><div class="claim-statement-label">Confidence Explanation</div><div class="claim-statement-text">' + escapeHtml(claim.confidence.explanation || '—') + '</div></div>' +
                (graphEdges.length > 0 ? '<div class="claim-statement" style="border-left-color: var(--purple);"><div class="claim-statement-label">Graph Edges</div><div class="claim-statement-text">' + graphEdges.map(function(e) { return escapeHtml(e); }).join('<br>') + '</div></div>' : '') +
                (claim.sources && claim.sources.length > 0 ? '<div class="claim-statement" style="border-left-color: var(--success);"><div class="claim-statement-label">Sources</div><div class="claim-statement-text">' + claim.sources.map(function(s) { return escapeHtml(s.ref) + ' (' + escapeHtml(s.reliability) + ')'; }).join('<br>') + '</div></div>' : '') +
                '<div style="margin-top:8px;font-size:10px;color:var(--text-muted);">Seal: ' + escapeHtml((claim.seal || {}).hash || '—') + ' | v' + ((claim.seal || {}).version || 1) + ' | ' + escapeHtml(claim.classificationTag || 'internal') + '</div>';

            document.getElementById('modalFooter').innerHTML =
                '<button class="btn btn-secondary" onclick="handleAction(\'archive\', \'' + escapeHtml(claim.claimId) + '\'); closeModal();">Archive</button>' +
                '<button class="btn btn-primary" onclick="closeModal();">Close</button>';
            document.getElementById('modalOverlay').classList.add('active');
        }

        function showMetricDetail(label) {
            document.getElementById('modalTitle').textContent = label;
            document.getElementById('modalBody').innerHTML = `<p>Detailed breakdown for ${escapeHtml(label)} coming soon.</p>`;
            document.getElementById('modalFooter').innerHTML = `<button class="btn btn-primary" onclick="closeModal()">Close</button>`;
            document.getElementById('modalOverlay').classList.add('active');
        }

        function showDimensionDetail(name) {
            var dim = data.coherenceReport.dimensions.find(function(d) { return d.name === name; });
            if (!dim) return;
            var detailHtml = Object.keys(dim.details).map(function(k) {
                return '<div class="detail-item"><div class="detail-label">' + escapeHtml(k) + '</div><div class="detail-value">' + escapeHtml(String(dim.details[k])) + '</div></div>';
            }).join('');
            document.getElementById('modalTitle').textContent = dim.label;
            document.getElementById('modalBody').innerHTML =
                '<div class="claim-detail-grid">' +
                    '<div class="detail-item"><div class="detail-label">Score</div><div class="detail-value" style="font-size:20px;font-weight:800;">' + dim.score.toFixed(1) + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">Weight</div><div class="detail-value">' + dim.weight.toFixed(2) + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">Weighted Contribution</div><div class="detail-value">' + (dim.score * dim.weight).toFixed(1) + '</div></div>' +
                    detailHtml +
                '</div>';
            document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" onclick="closeModal()">Close</button>';
            document.getElementById('modalOverlay').classList.add('active');
        }

        function showDriftDetail(driftId) {
            var ds = data.driftSignals.find(function(d) { return d.driftId === driftId; });
            if (!ds) return;
            document.getElementById('modalTitle').textContent = 'Drift Signal: ' + driftId;
            document.getElementById('modalBody').innerHTML =
                '<div class="claim-detail-grid">' +
                    '<div class="detail-item"><div class="detail-label">Type</div><div class="detail-value"><span class="drift-type-badge">' + escapeHtml(ds.driftType) + '</span></div></div>' +
                    '<div class="detail-item"><div class="detail-label">Severity</div><div class="detail-value"><span class="drift-severity ' + ds.severity + '" style="display:inline-block;width:10px;height:10px;"></span> ' + escapeHtml(ds.severity) + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">Detected</div><div class="detail-value">' + escapeHtml(new Date(ds.detectedAt).toLocaleDateString()) + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">Episode</div><div class="detail-value">' + escapeHtml(ds.episodeId) + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">Recommended Patch</div><div class="detail-value"><span class="drift-patch-badge">' + escapeHtml(ds.recommendedPatchType) + '</span></div></div>' +
                    '<div class="detail-item"><div class="detail-label">Fingerprint</div><div class="detail-value">' + escapeHtml(ds.fingerprint.key) + '</div></div>' +
                '</div>' +
                '<div class="claim-statement"><div class="claim-statement-label">Notes</div><div class="claim-statement-text">' + escapeHtml(ds.notes) + '</div></div>' +
                '<div class="claim-statement" style="border-left-color:var(--info);"><div class="claim-statement-label">Affected Claims</div><div class="claim-statement-text">' + (ds.evidenceRefs || []).map(function(r) { return escapeHtml(r); }).join(', ') + '</div></div>';
            document.getElementById('modalFooter').innerHTML =
                '<button class="btn btn-secondary" onclick="closeModal()">Close</button>' +
                '<button class="btn btn-primary" onclick="showToast(\'info\', \'Patch\', \'Applying ' + escapeHtml(ds.recommendedPatchType) + '\'); closeModal();">Apply Patch</button>';
            document.getElementById('modalOverlay').classList.add('active');
        }

        function showAlertDetail(title) {
            document.getElementById('modalTitle').textContent = 'Alert: ' + title;
            document.getElementById('modalBody').innerHTML = `<p>Alert details for "${escapeHtml(title)}"</p>`;
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Dismiss</button>
                <button class="btn btn-primary" onclick="handleAction('review'); closeModal();">Take Action</button>
            `;
            document.getElementById('modalOverlay').classList.add('active');
        }

        function showDayDetail(day) {
            var now = new Date();
            var year = now.getFullYear();
            var month = now.getMonth();
            var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

            // Find claims whose half-life expires on this day
            var expiring = data.claims.filter(function(c) {
                if (!c.halfLife || !c.halfLife.expiresAt) return false;
                var parsed = new Date(c.halfLife.expiresAt);
                return parsed && parsed.getFullYear() === year && parsed.getMonth() === month && parsed.getDate() === day;
            });

            document.getElementById('modalTitle').textContent = monthNames[month] + ' ' + day + ', ' + year;
            document.getElementById('modalBody').innerHTML = expiring.length > 0
                ? '<p>⏳ Claims reaching half-life on this day:</p><ul>' + expiring.map(function(c) {
                    return '<li><span class="status-light ' + escapeHtml(c.statusLight) + '">' + escapeHtml(c.statusLight) + '</span> ' +
                        escapeHtml(c.claimId) + ' — ' + escapeHtml(c.statement.substring(0, 40)) + '... (conf: ' + c.confidence.score.toFixed(2) + ')</li>';
                }).join('') + '</ul>'
                : '<p>No claims reaching half-life on this day.</p>';
            document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" onclick="closeModal()">Close</button>';
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal(event) {
            if (!event || event.target === document.getElementById('modalOverlay')) {
                document.getElementById('modalOverlay').classList.remove('active');
            }
        }

        // Toast
        function showToast(type, title, desc) {
            if (!notificationsEnabled && type !== 'error') return;
            
            const container = document.getElementById('toastContainer');
            const icons = { success: '✅', warning: '⚠️', error: '❌', info: 'ℹ️' };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <div class="toast-content">
                    <div class="toast-title">${escapeHtml(title)}</div>
                    <div class="toast-desc">${escapeHtml(desc)}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // CSS
        const style = document.createElement('style');
        style.textContent = '@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
        document.head.appendChild(style);

        // ══════════════════════════════════════════════════════════════════
        // V5 ADDITIONS - Command Palette, Compare, Context Menu, Undo
        // ══════════════════════════════════════════════════════════════════

        // V5 State
        let compareSelection = [];
        let undoStack = [];
        let undoTimerId = null;
        let contextTarget = null;

        // Command data
        const commandItems = [
            { icon: '📊', text: 'Go to Overview', key: '1', action: () => switchTab('overview') },
            { icon: '📋', text: 'Go to Claims', key: '2', action: () => switchTab('claims') },
            { icon: '⚡', text: 'Go to Drift', key: '3', action: () => switchTab('drift') },
            { icon: '🔬', text: 'Go to Analysis', key: '4', action: () => switchTab('analysis') },
            { icon: '💥', text: 'Go to Blast Radius', key: '5', action: () => switchTab('blast') },
            { icon: '⚖️', text: 'Go to Compare', key: '6', action: () => switchTab('compare') },
            { icon: '⟳', text: 'Refresh Dashboard', key: 'R', action: refreshDashboard },
            { icon: '🌙', text: 'Toggle Theme', key: 'T', action: () => document.getElementById('themeToggle').click() },
            { icon: '📥', text: 'Export CSV', key: 'E', action: exportData },
            { icon: '⛶', text: 'Toggle Fullscreen', key: 'F11', action: toggleFullscreen }
        ];

        // Command Palette
        function openCommandPalette() {
            document.getElementById('cmdOverlay').classList.add('active');
            document.getElementById('cmdInput').value = '';
            document.getElementById('cmdInput').focus();
            renderCommandResults('');
        }

        function closeCommandPalette() {
            document.getElementById('cmdOverlay').classList.remove('active');
        }

        function renderCommandResults(query) {
            const q = query.toLowerCase();
            let html = '';

            // IRIS query support
            if (q.startsWith('why ')) {
                html += renderIRISQuery('why', q.substring(4).trim());
            } else if (q.startsWith('drift ')) {
                html += renderIRISQuery('drift', q.substring(6).trim());
            } else if (q.startsWith('status ')) {
                html += renderIRISQuery('status', q.substring(7).trim());
            } else if (q.startsWith('changed ')) {
                html += renderIRISQuery('changed', q.substring(8).trim());
            } else if (q.startsWith('recall ')) {
                html += renderIRISQuery('recall', q.substring(7).trim());
            } else {
                // Commands section
                const filteredCommands = commandItems.filter(c => c.text.toLowerCase().includes(q));
                if (filteredCommands.length > 0) {
                    html += '<div class="cmd-group"><div class="cmd-group-label">Commands</div>';
                    filteredCommands.forEach((cmd, i) => {
                        html += '<div class="cmd-item" onclick="runCommand(' + i + ')">' +
                            '<span class="cmd-item-icon">' + cmd.icon + '</span>' +
                            '<span class="cmd-item-text">' + cmd.text + '</span>' +
                            '<span class="cmd-item-meta">' + cmd.key + '</span>' +
                        '</div>';
                    });
                    html += '</div>';
                }

                // Claims section
                if (q.length >= 2) {
                    const filteredClaims = data.claims.filter(c =>
                        c.claimId.toLowerCase().includes(q) ||
                        c.statement.toLowerCase().includes(q) ||
                        c.owner.toLowerCase().includes(q)
                    );
                    if (filteredClaims.length > 0) {
                        html += '<div class="cmd-group"><div class="cmd-group-label">Claims</div>';
                        filteredClaims.forEach(claim => {
                            html += '<div class="cmd-item" onclick="showClaimDetail(\'' + escapeHtml(claim.claimId) + '\'); closeCommandPalette();">' +
                                '<span class="cmd-item-icon">📋</span>' +
                                '<span class="cmd-item-text">' + escapeHtml(claim.claimId) + ' - ' + escapeHtml(claim.statement.substring(0, 35)) + '...</span>' +
                                '<span class="claim-type ' + escapeHtml(claim.truthType) + '">' + escapeHtml(truthTypeShort(claim.truthType)) + '</span>' +
                            '</div>';
                        });
                        html += '</div>';
                    }
                }
            }

            if (!html) {
                html = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No results. Try: why CLAIM-2024-0001, drift CLAIM-2024-0012, status, recall keyword</div>';
            }

            document.getElementById('cmdResults').innerHTML = html;
        }

        function renderIRISQuery(type, term) {
            var html = '<div class="cmd-group"><div class="cmd-group-label">IRIS: ' + escapeHtml(type.toUpperCase()) + '</div>';
            var t = term.toLowerCase();

            if (type === 'why') {
                var claim = data.claims.find(function(c) { return c.claimId.toLowerCase().includes(t); });
                if (claim) {
                    var evList = (claim.evidence || []).map(function(e) { return escapeHtml(e.summary || e.ref); }).join(', ') || 'No evidence';
                    var srcList = (claim.sources || []).map(function(s) { return escapeHtml(s.ref) + ' (' + escapeHtml(s.reliability) + ')'; }).join(', ') || 'No sources';
                    html += '<div class="iris-result">' +
                        '<div style="font-weight:600;">' + escapeHtml(claim.claimId) + ': ' + escapeHtml(claim.statement.substring(0, 60)) + '</div>' +
                        '<div style="margin-top:4px;font-size:11px;"><strong>Evidence:</strong> ' + evList + '</div>' +
                        '<div style="margin-top:2px;font-size:11px;"><strong>Sources:</strong> ' + srcList + '</div>' +
                        '<div style="margin-top:2px;font-size:11px;"><strong>Confidence:</strong> ' + claim.confidence.score.toFixed(2) + ' — ' + escapeHtml(claim.confidence.explanation) + '</div>' +
                    '</div>';
                } else {
                    html += '<div class="iris-result">No claim matching "' + escapeHtml(term) + '"</div>';
                }
            } else if (type === 'drift') {
                var signals = data.driftSignals.filter(function(d) {
                    return (d.evidenceRefs || []).some(function(r) { return r.toLowerCase().includes(t); }) || d.driftId.toLowerCase().includes(t);
                });
                if (signals.length > 0) {
                    signals.forEach(function(ds) {
                        html += '<div class="iris-result" onclick="showDriftDetail(\'' + escapeHtml(ds.driftId) + '\'); closeCommandPalette();" style="cursor:pointer;">' +
                            '<span class="drift-severity ' + ds.severity + '" style="display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;"></span>' +
                            '<strong>' + escapeHtml(ds.driftId) + '</strong> ' + escapeHtml(ds.driftType) + ' — ' + escapeHtml(ds.notes) +
                        '</div>';
                    });
                } else {
                    html += '<div class="iris-result">No drift signals matching "' + escapeHtml(term) + '"</div>';
                }
            } else if (type === 'status') {
                var counts = { green: 0, yellow: 0, red: 0 };
                data.claims.forEach(function(c) { counts[c.statusLight] = (counts[c.statusLight] || 0) + 1; });
                html += '<div class="iris-result">' +
                    '<div><span class="status-light green">green</span> ' + counts.green + ' claims</div>' +
                    '<div><span class="status-light yellow">yellow</span> ' + counts.yellow + ' claims</div>' +
                    '<div><span class="status-light red">red</span> ' + counts.red + ' claims</div>' +
                    '<div style="margin-top:4px;">Overall coherence: <strong>' + data.coherenceReport.overall + '</strong> (' + data.coherenceReport.grade + ')</div>' +
                '</div>';
            } else if (type === 'changed') {
                var changedClaims = data.claims.filter(function(c) {
                    return c.graph.supersedes || (c.graph.patches && c.graph.patches.length > 0);
                });
                if (changedClaims.length > 0) {
                    changedClaims.forEach(function(c) {
                        html += '<div class="iris-result" onclick="showClaimDetail(\'' + escapeHtml(c.claimId) + '\'); closeCommandPalette();" style="cursor:pointer;">' +
                            escapeHtml(c.claimId) + ' — ' + (c.graph.supersedes ? 'supersedes ' + escapeHtml(c.graph.supersedes) : 'has patches') +
                        '</div>';
                    });
                } else {
                    html += '<div class="iris-result">No changed claims found</div>';
                }
            } else if (type === 'recall') {
                var matches = data.claims.filter(function(c) {
                    return c.claimId.toLowerCase().includes(t) ||
                        c.statement.toLowerCase().includes(t) ||
                        c.owner.toLowerCase().includes(t) ||
                        (c.tags || []).some(function(tag) { return tag.toLowerCase().includes(t); });
                });
                matches.forEach(function(c) {
                    html += '<div class="iris-result" onclick="showClaimDetail(\'' + escapeHtml(c.claimId) + '\'); closeCommandPalette();" style="cursor:pointer;">' +
                        '<span class="status-light ' + escapeHtml(c.statusLight) + '" style="font-size:9px;">' + escapeHtml(c.statusLight) + '</span> ' +
                        escapeHtml(c.claimId) + ' — ' + escapeHtml(c.statement.substring(0, 50)) +
                    '</div>';
                });
                if (matches.length === 0) html += '<div class="iris-result">No results for "' + escapeHtml(term) + '"</div>';
            }

            html += '</div>';
            return html;
        }

        function runCommand(index) {
            closeCommandPalette();
            commandItems[index].action();
        }

        // Context Menu
        function showContextMenu(e, claimId) {
            e.preventDefault();
            e.stopPropagation();
            contextTarget = claimId;
            const menu = document.getElementById('contextMenu');
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';
            menu.classList.add('active');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
        }

        function ctxAction(action) {
            hideContextMenu();
            if (!contextTarget) return;

            switch (action) {
                case 'view':
                    showClaimDetail(contextTarget);
                    break;
                case 'extend':
                    doUndoableAction(`Extended ${contextTarget} by 30 days`);
                    break;
                case 'compare':
                    toggleCompareSelection(contextTarget);
                    break;
                case 'challenge':
                    doUndoableAction(`Challenged ${contextTarget}`);
                    break;
                case 'archive':
                    doUndoableAction(`Archived ${contextTarget}`);
                    break;
            }
        }

        // Compare Mode
        function toggleCompareSelection(claimId) {
            const index = compareSelection.indexOf(claimId);
            if (index >= 0) {
                compareSelection.splice(index, 1);
            } else if (compareSelection.length < 2) {
                compareSelection.push(claimId);
            } else {
                showToast('warning', 'Compare Limit', 'You can only compare 2 claims at a time');
                return;
            }
            updateCompareUI();
        }

        function updateCompareUI() {
            // Update compare bar
            const compareBar = document.getElementById('compareBar');
            const compareCount = document.getElementById('compareCount');
            const compareBtn = document.getElementById('compareBtn');
            
            compareCount.textContent = compareSelection.length;
            compareBtn.disabled = compareSelection.length !== 2;
            
            if (compareSelection.length > 0) {
                compareBar.classList.add('active');
            } else {
                compareBar.classList.remove('active');
            }

            // Update table row highlights
            document.querySelectorAll('.claims-table tr').forEach(row => {
                const id = row.querySelector('.claim-id')?.textContent;
                if (id && compareSelection.includes(id)) {
                    row.classList.add('compare-selected');
                } else {
                    row.classList.remove('compare-selected');
                }
            });
        }

        function clearCompareSelection() {
            compareSelection = [];
            updateCompareUI();
        }

        function goToCompare() {
            if (compareSelection.length !== 2) return;

            const claim1 = data.claims.find(c => c.claimId === compareSelection[0]);
            const claim2 = data.claims.find(c => c.claimId === compareSelection[1]);

            if (!claim1 || !claim2) return;

            document.getElementById('compare1Title').textContent = claim1.claimId;
            document.getElementById('compare1Type').textContent = truthTypeShort(claim1.truthType);
            document.getElementById('compare1Type').className = 'claim-type ' + claim1.truthType;
            document.getElementById('compare1Body').innerHTML = renderCompareCard(claim1, claim2);

            document.getElementById('compare2Title').textContent = claim2.claimId;
            document.getElementById('compare2Type').textContent = truthTypeShort(claim2.truthType);
            document.getElementById('compare2Type').className = 'claim-type ' + claim2.truthType;
            document.getElementById('compare2Body').innerHTML = renderCompareCard(claim2, claim1);

            switchTab('compare');
            document.getElementById('compareBar').classList.remove('active');
        }

        function renderCompareCard(claim, otherClaim) {
            var diff = function(a, b) { return a !== b ? 'compare-diff' : ''; };
            var hlA = halfLifeDaysRemaining(claim);
            var hlB = halfLifeDaysRemaining(otherClaim);
            return '<div class="compare-row">' +
                    '<span class="compare-label">Status Light</span>' +
                    '<span class="compare-value ' + diff(claim.statusLight, otherClaim.statusLight) + '">' +
                        '<span class="status-light ' + escapeHtml(claim.statusLight) + '">' + escapeHtml(claim.statusLight) + '</span>' +
                    '</span>' +
                '</div>' +
                '<div class="compare-row">' +
                    '<span class="compare-label">Truth Type</span>' +
                    '<span class="compare-value ' + diff(claim.truthType, otherClaim.truthType) + '">' +
                        '<span class="claim-type ' + escapeHtml(claim.truthType) + '">' + escapeHtml(claim.truthType) + '</span>' +
                    '</span>' +
                '</div>' +
                '<div class="compare-row">' +
                    '<span class="compare-label">Confidence</span>' +
                    '<span class="compare-value ' + diff(claim.confidence.score, otherClaim.confidence.score) + '">' + claim.confidence.score.toFixed(2) + '</span>' +
                '</div>' +
                '<div class="compare-row">' +
                    '<span class="compare-label">Owner</span>' +
                    '<span class="compare-value ' + diff(claim.owner, otherClaim.owner) + '">' + escapeHtml(claim.owner) + '</span>' +
                '</div>' +
                '<div class="compare-row">' +
                    '<span class="compare-label">Half-Life</span>' +
                    '<span class="compare-value ' + diff(hlA, hlB) + '">' + (hlA === Infinity ? '—' : hlA + 'd') + '</span>' +
                '</div>' +
                '<div class="compare-row">' +
                    '<span class="compare-label">Scope</span>' +
                    '<span class="compare-value">' + escapeHtml((claim.scope.where || '') + ' / ' + (claim.scope.when || '')) + '</span>' +
                '</div>' +
                '<div style="margin-top: 16px; padding: 14px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--accent);">' +
                    '<div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Statement</div>' +
                    '<div style="font-size: 13px; line-height: 1.5;">' + escapeHtml(claim.statement) + '</div>' +
                '</div>';
        }

        // Undo System
        function doUndoableAction(description) {
            undoStack.push({ description, timestamp: Date.now() });
            showUndoBar(description);
            showToast('success', 'Action Complete', description);
        }

        function showUndoBar(text) {
            const undoBar = document.getElementById('undoBar');
            const undoText = document.getElementById('undoText');
            const undoTimer = document.getElementById('undoTimer');

            undoText.textContent = text;
            undoBar.classList.add('active');

            // Clear previous timer
            if (undoTimerId) clearInterval(undoTimerId);

            // Countdown
            let countdown = 5;
            undoTimer.textContent = countdown;
            undoTimerId = setInterval(() => {
                countdown--;
                undoTimer.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(undoTimerId);
                    undoBar.classList.remove('active');
                }
            }, 1000);
        }

        function undoLastAction() {
            if (undoStack.length === 0) {
                showToast('info', 'Nothing to Undo', 'No recent actions');
                return;
            }

            const action = undoStack.pop();
            document.getElementById('undoBar').classList.remove('active');
            if (undoTimerId) clearInterval(undoTimerId);
            
            showToast('info', 'Undone', action.description);
        }

        // Filter
        function applyFilter(filter) {
            showToast('info', 'Filter Applied', filter === 'all' ? 'Showing all claims' : `Filtering by: ${filter}`);
            // In a real app, this would filter the claims table
        }

        // ══════════════════════════════════════════════════════════════════
        // V6 TABLE FUNCTIONS - Sorting, Filtering, Bulk Selection, Edit
        // ══════════════════════════════════════════════════════════════════

        // V6 State
        let currentSort = { column: null, direction: 'asc' };
        let bulkSelected = [];
        let filteredClaims = [];
        let editingClaimId = null;

        // Update renderClaimsTable with checkboxes and edit button
        renderClaimsTable = function(claimsToRender) {
            var claims = claimsToRender || filteredClaims.length > 0 ? filteredClaims : data.claims;
            if (!claimsToRender && filteredClaims.length === 0) claims = data.claims;

            document.getElementById('claimsTable').innerHTML = claims.map(function(c) {
                var isSelected = bulkSelected.indexOf(c.claimId) >= 0;
                var hlDays = halfLifeDaysRemaining(c);
                var hlLabel = hlDays === Infinity ? '—' : hlDays + 'd';
                return '<tr class="' + (isSelected ? 'selected' : '') + '" data-id="' + escapeHtml(c.claimId) + '" oncontextmenu="showContextMenu(event, \'' + escapeHtml(c.claimId) + '\')" onclick="showClaimDetail(\'' + escapeHtml(c.claimId) + '\')">' +
                    '<td class="th-checkbox"><input type="checkbox" class="row-checkbox" ' + (isSelected ? 'checked' : '') + ' onclick="toggleRowSelect(event, \'' + escapeHtml(c.claimId) + '\')"></td>' +
                    '<td><span class="claim-id">' + escapeHtml(c.claimId) + '</span></td>' +
                    '<td><span class="claim-type ' + escapeHtml(c.truthType) + '">' + escapeHtml(truthTypeShort(c.truthType)) + '</span></td>' +
                    '<td>' + escapeHtml(c.statement.substring(0, 50)) + '...</td>' +
                    '<td>' + escapeHtml(c.owner) + '</td>' +
                    '<td><span class="status-light ' + escapeHtml(c.statusLight) + '">' + escapeHtml(c.statusLight) + '</span></td>' +
                    '<td><div class="conf-bar" title="' + c.confidence.score.toFixed(2) + '"><div class="conf-bar-fill" style="width:' + (c.confidence.score * 100) + '%;background:' + (c.confidence.score >= 0.80 ? 'var(--success)' : c.confidence.score >= 0.50 ? 'var(--warning)' : 'var(--danger)') + ';"></div></div></td>' +
                    '<td><span class="halflife-badge ' + (hlDays <= 14 ? 'expiring' : '') + '">' + escapeHtml(hlLabel) + '</span></td>' +
                    '<td style="white-space:nowrap;">' +
                        '<button class="btn btn-secondary btn-icon" onclick="event.stopPropagation(); showClaimDetail(\'' + escapeHtml(c.claimId) + '\')" title="View">👁️</button> ' +
                        '<button class="btn btn-secondary btn-icon" onclick="event.stopPropagation(); editClaim(\'' + escapeHtml(c.claimId) + '\')" title="Edit">✏️</button>' +
                    '</td>' +
                '</tr>';
            }).join('');

            updateTableInfo(claims.length);
            updateBulkBar();
        };

        function updateTableInfo(count) {
            var info = document.getElementById('tableInfo');
            if (info) info.textContent = 'Showing ' + count + ' of ' + data.claims.length + ' claims';
        }

        // Sorting
        function sortTable(column) {
            var headers = document.querySelectorAll('.claims-table th.sortable');
            headers.forEach(function(h) { h.classList.remove('asc', 'desc'); });

            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            var header = document.querySelector('.claims-table th[data-sort="' + column + '"]');
            if (header) header.classList.add(currentSort.direction);

            var claims = filteredClaims.length > 0 ? filteredClaims.slice() : data.claims.slice();
            
            claims.sort(function(a, b) {
                var valA, valB;
                if (column === 'confidence') {
                    valA = a.confidence.score;
                    valB = b.confidence.score;
                } else if (column === 'halflife') {
                    valA = halfLifeDaysRemaining(a);
                    valB = halfLifeDaysRemaining(b);
                    if (valA === Infinity) valA = 99999;
                    if (valB === Infinity) valB = 99999;
                } else {
                    valA = a[column] || '';
                    valB = b[column] || '';
                }

                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            renderClaimsTable(claims);
        }

        // Filtering
        function filterClaimsTable() {
            var searchVal = (document.getElementById('tableSearch').value || '').toLowerCase();
            var typeVal = document.getElementById('typeFilter').value;
            var statusVal = document.getElementById('statusFilter').value;

            filteredClaims = data.claims.filter(function(c) {
                var matchSearch = !searchVal ||
                    c.claimId.toLowerCase().indexOf(searchVal) >= 0 ||
                    c.statement.toLowerCase().indexOf(searchVal) >= 0 ||
                    c.owner.toLowerCase().indexOf(searchVal) >= 0;
                var matchType = !typeVal || c.truthType === typeVal;
                var matchStatus = !statusVal || c.statusLight === statusVal;
                return matchSearch && matchType && matchStatus;
            });

            renderClaimsTable(filteredClaims);
        }

        // Bulk Selection
        function toggleRowSelect(event, claimId) {
            event.stopPropagation();
            var idx = bulkSelected.indexOf(claimId);
            if (idx >= 0) {
                bulkSelected.splice(idx, 1);
            } else {
                bulkSelected.push(claimId);
            }
            updateBulkBar();
            updateRowHighlights();
        }

        function toggleSelectAll() {
            var selectAllCheckbox = document.getElementById('selectAll');
            var claims = filteredClaims.length > 0 ? filteredClaims : data.claims;
            
            if (selectAllCheckbox.checked) {
                bulkSelected = claims.map(function(c) { return c.claimId; });
            } else {
                bulkSelected = [];
            }
            updateBulkBar();
            updateRowHighlights();
        }

        function updateRowHighlights() {
            document.querySelectorAll('.claims-table tbody tr').forEach(function(row) {
                var id = row.getAttribute('data-id');
                var checkbox = row.querySelector('.row-checkbox');
                var isSelected = bulkSelected.indexOf(id) >= 0;
                row.classList.toggle('selected', isSelected);
                if (checkbox) checkbox.checked = isSelected;
            });
            
            var selectAll = document.getElementById('selectAll');
            var claims = filteredClaims.length > 0 ? filteredClaims : data.claims;
            if (selectAll) {
                selectAll.checked = bulkSelected.length === claims.length && claims.length > 0;
            }
        }

        function updateBulkBar() {
            var bar = document.getElementById('bulkActionBar');
            var count = document.getElementById('bulkCount');
            if (bar && count) {
                count.textContent = bulkSelected.length;
                bar.classList.toggle('active', bulkSelected.length > 0);
            }
        }

        function clearBulkSelection() {
            bulkSelected = [];
            updateBulkBar();
            updateRowHighlights();
            document.getElementById('selectAll').checked = false;
        }

        function bulkAction(action) {
            if (bulkSelected.length === 0) return;
            
            var count = bulkSelected.length;
            switch (action) {
                case 'extend':
                    showToast('success', 'Bulk Extend', 'Extended ' + count + ' claims by 30 days');
                    doUndoableAction('Extended ' + count + ' claims');
                    break;
                case 'export':
                    exportSelectedClaims();
                    break;
                case 'archive':
                    showToast('warning', 'Bulk Archive', 'Archived ' + count + ' claims');
                    doUndoableAction('Archived ' + count + ' claims');
                    // Remove from data
                    data.claims = data.claims.filter(function(c) { return bulkSelected.indexOf(c.claimId) < 0; });
                    clearBulkSelection();
                    filterClaimsTable();
                    break;
            }
        }

        function exportSelectedClaims() {
            var selected = data.claims.filter(function(c) { return bulkSelected.indexOf(c.claimId) >= 0; });
            var csv = ['ClaimID,TruthType,Statement,Owner,StatusLight,Confidence,HalfLifeDays'];
            selected.forEach(function(c) {
                var hlDays = halfLifeDaysRemaining(c);
                csv.push(c.claimId + ',' + c.truthType + ',"' + c.statement.replace(/"/g, '""') + '",' + c.owner + ',' + c.statusLight + ',' + c.confidence.score + ',' + (hlDays === Infinity ? '' : hlDays));
            });

            var blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'edge_claims_selected_' + bulkSelected.length + '.csv';
            a.click();

            showToast('success', 'Export Complete', 'Exported ' + bulkSelected.length + ' claims');
        }

        // Edit Claim
        function editClaim(claimId) {
            var claim = data.claims.find(function(c) { return c.claimId === claimId; });
            if (!claim) return;

            editingClaimId = claimId;
            var truthTypes = ['observation','inference','assumption','forecast','norm','constraint'];
            var ttOptions = truthTypes.map(function(tt) {
                return '<option value="' + tt + '"' + (claim.truthType === tt ? ' selected' : '') + '>' + tt + '</option>';
            }).join('');

            var owners = ['CPT Rodriguez','MAJ Thompson','SFC Williams','CW3 Martinez','MSG Patterson'];
            var ownerOptions = owners.map(function(o) {
                return '<option value="' + o + '"' + (claim.owner === o ? ' selected' : '') + '>' + o + '</option>';
            }).join('');

            var confPct = Math.round(claim.confidence.score * 100);

            document.getElementById('modalTitle').textContent = 'Edit Claim: ' + claimId;
            document.getElementById('modalBody').innerHTML =
                '<div class="edit-form-grid">' +
                    '<div class="edit-field">' +
                        '<label class="edit-label">Truth Type</label>' +
                        '<select class="edit-select" id="editType">' + ttOptions + '</select>' +
                    '</div>' +
                    '<div class="edit-field">' +
                        '<label class="edit-label">Owner</label>' +
                        '<select class="edit-select" id="editOwner">' + ownerOptions + '</select>' +
                    '</div>' +
                    '<div class="edit-field form-full">' +
                        '<label class="edit-label">Statement</label>' +
                        '<textarea class="edit-textarea" id="editStatement" rows="3">' + escapeHtml(claim.statement) + '</textarea>' +
                    '</div>' +
                    '<div class="edit-field form-full">' +
                        '<label class="edit-label">Confidence Explanation</label>' +
                        '<textarea class="edit-textarea" id="editConfExplanation" rows="2">' + escapeHtml(claim.confidence.explanation || '') + '</textarea>' +
                    '</div>' +
                    '<div class="edit-field">' +
                        '<label class="edit-label">Confidence (0-100%)</label>' +
                        '<div class="confidence-bar">' +
                            '<input type="range" min="0" max="100" value="' + confPct + '" id="editConfidence" oninput="document.getElementById(\'editConfVal\').textContent = this.value + \'%\'">' +
                            '<span class="confidence-bar-value" id="editConfVal">' + confPct + '%</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="edit-field">' +
                        '<label class="edit-label">Half-Life (days)</label>' +
                        '<input type="number" class="edit-input" id="editHalfLife" value="' + (claim.halfLife.value || 30) + '" min="1">' +
                    '</div>' +
                    '<div class="edit-field">' +
                        '<label class="edit-label">Scope: Where</label>' +
                        '<input type="text" class="edit-input" id="editScopeWhere" value="' + escapeHtml(claim.scope.where || '') + '">' +
                    '</div>' +
                    '<div class="edit-field">' +
                        '<label class="edit-label">Scope: When</label>' +
                        '<input type="text" class="edit-input" id="editScopeWhen" value="' + escapeHtml(claim.scope.when || '') + '">' +
                    '</div>' +
                '</div>';

            document.getElementById('modalFooter').innerHTML =
                '<button class="btn btn-secondary" onclick="closeModal()">Cancel</button>' +
                '<button class="btn btn-primary" onclick="saveClaimEdit()">Save Changes</button>';

            document.getElementById('modalOverlay').classList.add('active');
        }

        function saveClaimEdit() {
            if (!editingClaimId) return;

            var claim = data.claims.find(function(c) { return c.claimId === editingClaimId; });
            if (!claim) return;

            claim.truthType = document.getElementById('editType').value;
            claim.owner = document.getElementById('editOwner').value;
            claim.statement = document.getElementById('editStatement').value;
            claim.confidence.explanation = document.getElementById('editConfExplanation').value;
            claim.confidence.score = parseInt(document.getElementById('editConfidence').value) / 100;
            claim.halfLife.value = parseInt(document.getElementById('editHalfLife').value) || 30;
            claim.scope.where = document.getElementById('editScopeWhere').value;
            claim.scope.when = document.getElementById('editScopeWhen').value;
            claim.statusLight = deriveStatusLight(claim);

            closeModal();
            filterClaimsTable();
            showToast('success', 'Claim Updated', editingClaimId + ' has been updated');
            saveState();
            doUndoableAction('Updated ' + editingClaimId);
            editingClaimId = null;
        }

        // ══════════════════════════════════════════════════════════════════
        // NEW CLAIM FORM FUNCTIONS
        // ══════════════════════════════════════════════════════════════════

        // Claim counter for sequential ID generation
        let claimCounter = 27; // next after 26 demo claims
        let selectedDependencies = [];
        let selectedSupports = [];
        let selectedContradicts = [];

        function generateClaimId() {
            const type = document.getElementById('newClaimType').value;
            const idField = document.getElementById('newClaimId');

            if (type) {
                const year = new Date().getFullYear();
                idField.value = 'CLAIM-' + year + '-' + String(claimCounter).padStart(4, '0');
            } else {
                idField.value = '';
            }
            updateClaimPreview();
        }

        function updateConfidenceDisplay() {
            const value = document.getElementById('newClaimConfidence').value;
            document.getElementById('confidenceValue').textContent = (value / 100).toFixed(2);
            updateClaimPreview();
        }

        function updateClaimPreview() {
            var truthType = document.getElementById('newClaimType').value;
            var id = document.getElementById('newClaimId').value;
            var statement = document.getElementById('newClaimStatement').value;
            var owner = document.getElementById('newClaimOwner').value;
            var confVal = document.getElementById('newClaimConfidence').value;
            var confScore = (confVal / 100).toFixed(2);
            var hlValue = document.getElementById('newClaimHalfLifeValue') ? document.getElementById('newClaimHalfLifeValue').value : '';
            var hlUnit = document.getElementById('newClaimHalfLifeUnit') ? document.getElementById('newClaimHalfLifeUnit').value : 'days';
            var scopeWhere = document.getElementById('newClaimScopeWhere') ? document.getElementById('newClaimScopeWhere').value : '';
            var scopeWhen = document.getElementById('newClaimScopeWhen') ? document.getElementById('newClaimScopeWhen').value : '';

            var preview = document.getElementById('claimPreview');

            if (!truthType && !statement) {
                preview.innerHTML = '<div class="preview-placeholder"><span style="font-size: 48px; opacity: 0.3;">📋</span><p>Fill in the form to preview your claim</p></div>';
                return;
            }

            var statusLight = confScore >= 0.80 ? 'green' : confScore < 0.50 ? 'red' : 'yellow';

            preview.innerHTML =
                '<div class="preview-claim">' +
                    '<div class="preview-claim-header">' +
                        '<span class="preview-claim-id">' + escapeHtml(id || '[ID]') + '</span>' +
                        '<div style="display:flex;gap:6px;">' +
                            '<span class="claim-type ' + escapeHtml(truthType || '') + '">' + escapeHtml(truthType ? truthTypeShort(truthType) : '?') + '</span>' +
                            '<span class="status-light ' + escapeHtml(statusLight) + '">' + escapeHtml(statusLight) + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="preview-claim-body">' +
                        '<div class="preview-claim-statement">' + (statement ? escapeHtml(statement) : '<em style="color:var(--text-muted)">Enter statement...</em>') + '</div>' +
                        '<div class="preview-claim-meta">' +
                            '<div class="preview-meta-item"><span class="preview-meta-label">Owner</span><span class="preview-meta-value">' + escapeHtml(owner || '—') + '</span></div>' +
                            '<div class="preview-meta-item"><span class="preview-meta-label">Scope</span><span class="preview-meta-value">' + escapeHtml((scopeWhere || '?') + ' / ' + (scopeWhen || '?')) + '</span></div>' +
                            '<div class="preview-meta-item"><span class="preview-meta-label">Half-Life</span><span class="preview-meta-value">' + escapeHtml((hlValue || '?') + ' ' + hlUnit) + '</span></div>' +
                            '<div class="preview-meta-item"><span class="preview-meta-label">Confidence</span><span class="preview-meta-value" style="color:' + (confScore >= 0.80 ? 'var(--success)' : confScore >= 0.50 ? 'var(--warning)' : 'var(--danger)') + '">' + escapeHtml(confScore) + '</span></div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
        }

        function resetNewClaimForm() {
            document.getElementById('newClaimType').value = '';
            document.getElementById('newClaimId').value = '';
            document.getElementById('newClaimStatement').value = '';
            if (document.getElementById('newClaimConfExplanation')) document.getElementById('newClaimConfExplanation').value = '';
            document.getElementById('newClaimOwner').value = '';
            document.getElementById('newClaimConfidence').value = 75;
            document.getElementById('confidenceValue').textContent = '0.75';
            if (document.getElementById('newClaimTags')) document.getElementById('newClaimTags').value = '';
            if (document.getElementById('newClaimScopeWhere')) document.getElementById('newClaimScopeWhere').value = '';
            if (document.getElementById('newClaimScopeWhen')) document.getElementById('newClaimScopeWhen').value = '';
            if (document.getElementById('newClaimHalfLifeValue')) document.getElementById('newClaimHalfLifeValue').value = '30';
            if (document.getElementById('newClaimHalfLifeUnit')) document.getElementById('newClaimHalfLifeUnit').value = 'days';
            if (document.getElementById('newClaimHalfLifeTrigger')) document.getElementById('newClaimHalfLifeTrigger').value = 'expiry';
            if (document.getElementById('newClaimClassification')) document.getElementById('newClaimClassification').value = 'internal';
            if (document.getElementById('newClaimSourceRef')) document.getElementById('newClaimSourceRef').value = '';
            selectedDependencies = [];
            selectedSupports = [];
            selectedContradicts = [];
            if (document.getElementById('selectedDeps')) document.getElementById('selectedDeps').innerHTML = '';
            updateClaimPreview();
            showToast('info', 'Form Reset', 'All fields cleared');
        }

        function saveClaimDraft() {
            var id = document.getElementById('newClaimId').value || 'DRAFT-' + Date.now();
            saveDraft();
            showToast('info', 'Draft Saved', id + ' saved locally');
            doUndoableAction('Saved draft: ' + id);
        }

        function submitNewClaim() {
            var truthType = document.getElementById('newClaimType').value;
            var statement = document.getElementById('newClaimStatement').value;
            var owner = document.getElementById('newClaimOwner').value;
            var confVal = parseInt(document.getElementById('newClaimConfidence').value);
            var confExplanation = document.getElementById('newClaimConfExplanation') ? document.getElementById('newClaimConfExplanation').value : '';
            var scopeWhere = document.getElementById('newClaimScopeWhere') ? document.getElementById('newClaimScopeWhere').value : '';
            var scopeWhen = document.getElementById('newClaimScopeWhen') ? document.getElementById('newClaimScopeWhen').value : '';
            var hlValue = document.getElementById('newClaimHalfLifeValue') ? parseInt(document.getElementById('newClaimHalfLifeValue').value) : 30;
            var hlUnit = document.getElementById('newClaimHalfLifeUnit') ? document.getElementById('newClaimHalfLifeUnit').value : 'days';
            var hlTrigger = document.getElementById('newClaimHalfLifeTrigger') ? document.getElementById('newClaimHalfLifeTrigger').value : 'expiry';
            var classification = document.getElementById('newClaimClassification') ? document.getElementById('newClaimClassification').value : 'internal';
            var sourceRef = document.getElementById('newClaimSourceRef') ? document.getElementById('newClaimSourceRef').value : '';

            if (!truthType || !statement || !owner) {
                showToast('error', 'Missing Fields', 'Please fill in Truth Type, Statement, and Owner');
                return;
            }

            var id = document.getElementById('newClaimId').value;
            var confScore = confVal / 100;

            var tagsRaw = document.getElementById('newClaimTags') ? document.getElementById('newClaimTags').value : '';
            var tags = tagsRaw.split(',').map(function(t) { return t.trim(); }).filter(Boolean);

            // Compute half-life expiry
            var now = new Date();
            var msPerUnit = hlUnit === 'hours' ? 3600000 : hlUnit === 'days' ? 86400000 : 1;
            var expiresAt = new Date(now.getTime() + hlValue * msPerUnit).toISOString();

            // Compute seal hash stub
            var sealInput = id + statement + truthType + confScore;
            var sealHash = 'sha256:' + Array.from(sealInput).reduce(function(h, c) { return ((h << 5) - h + c.charCodeAt(0)) | 0; }, 0).toString(16).replace('-', 'a');

            var newClaim = {
                claimId: id,
                statement: statement,
                scope: { where: scopeWhere, when: scopeWhen },
                truthType: truthType,
                confidence: { score: confScore, explanation: confExplanation },
                statusLight: 'yellow',
                sources: sourceRef ? [{ ref: sourceRef, type: 'document', reliability: 'medium' }] : [],
                evidence: [],
                owner: owner,
                halfLife: { value: hlValue, unit: hlUnit, expiresAt: expiresAt, refreshTrigger: hlTrigger },
                graph: { dependsOn: selectedDependencies.slice(), contradicts: selectedContradicts.slice(), supersedes: null, supports: selectedSupports.slice(), patches: [] },
                seal: { hash: sealHash, sealedAt: now.toISOString(), version: 1 },
                classificationTag: classification,
                tags: tags,
                _thread: '',
                _created: now.toISOString()
            };
            newClaim.statusLight = deriveStatusLight(newClaim);

            data.claims.unshift(newClaim);
            claimCounter++;

            data.metrics[0].value = data.claims.length;

            showToast('success', 'Claim Created', id + ' has been created');
            saveState();
            clearDraft();

            resetNewClaimForm();
            switchTab('claims');
            renderClaimsTable();
            renderMetrics();
        }

        // Dependency/supports/contradicts search for new claim form
        function setupDependencySearch() {
            var input = document.getElementById('depSearchInput');
            var suggestions = document.getElementById('depSuggestions');

            if (!input) return;

            input.addEventListener('input', function() {
                var q = this.value.toLowerCase();
                if (q.length < 2) {
                    suggestions.classList.remove('active');
                    return;
                }

                var matches = data.claims.filter(function(c) {
                    return c.claimId.toLowerCase().indexOf(q) >= 0 || c.statement.toLowerCase().indexOf(q) >= 0;
                }).slice(0, 5);

                if (matches.length > 0) {
                    suggestions.innerHTML = matches.map(function(c) {
                        return '<div class="dep-suggestion" onclick="addDependency(\'' + escapeHtml(c.claimId) + '\')">' +
                            '<span>' + escapeHtml(c.claimId) + '</span>' +
                            '<span class="claim-type ' + escapeHtml(c.truthType) + '">' + escapeHtml(truthTypeShort(c.truthType)) + '</span>' +
                        '</div>';
                    }).join('');
                    suggestions.classList.add('active');
                } else {
                    suggestions.classList.remove('active');
                }
            });

            input.addEventListener('blur', function() {
                setTimeout(function() { suggestions.classList.remove('active'); }, 200);
            });
        }

        function addDependency(claimId) {
            if (selectedDependencies.indexOf(claimId) >= 0) return;
            selectedDependencies.push(claimId);
            renderDependencyTags();
            document.getElementById('depSearchInput').value = '';
            document.getElementById('depSuggestions').classList.remove('active');
        }

        function removeDependency(claimId) {
            selectedDependencies = selectedDependencies.filter(function(id) { return id !== claimId; });
            renderDependencyTags();
        }

        function renderDependencyTags() {
            var container = document.getElementById('selectedDeps');
            container.innerHTML = selectedDependencies.map(function(id) {
                return '<span class="dep-tag">' + id + 
                    '<button class="dep-tag-remove" onclick="removeDependency(\'' + id + '\')" type="button">×</button>' +
                '</span>';
            }).join('');
        }

        // Add command for new claim
        commandItems.push({ icon: '➕', text: 'Create New Claim', key: 'N', action: function() { switchTab('newclaim'); } });

        // Init
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
