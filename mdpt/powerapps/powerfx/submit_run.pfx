// submit_run.pfx — MDPT Power App: Submit Prompt Run
// No tenant URLs. No secrets.

// === Form Validation ===
// Enable submit only when required fields are filled
SubmitRunBtn.DisplayMode:
If(
    !IsBlank(PlatformDropdown.Selected.Value) &&
    !IsBlank(FindingsInput.Text) &&
    !IsBlank(TablesScannedInput.Text),
    DisplayMode.Edit,
    DisplayMode.Disabled
)

// === SubmitRunBtn.OnSelect ===
// Create a new PromptRuns item
Patch(
    PromptRuns,
    Defaults(PromptRuns),
    {
        Title: varSelectedCap.Title & " — " & Text(Now(), "yyyy-mm-dd"),
        Run_ID: varNewRunID,
        // Capability_Ref is a lookup — set via Title or ID depending on list config
        Capability_Ref: LookUp(PromptCapabilities, Capability_ID = varSelectedCap.Capability_ID),
        User: {
            '@odata.type': "#Microsoft.Azure.Connectors.SharePoint.SPListExpandedUser",
            Claims: "i:0#.f|membership|" & User().Email,
            DisplayName: User().FullName,
            Email: User().Email
        },
        Run_Timestamp: Now(),
        LLM_Platform: {Value: PlatformDropdown.Selected.Value},
        Tables_Scanned: TablesScannedInput.Text,
        Rows_Analyzed: Value(RowsAnalyzedInput.Text),
        Findings_Summary: FindingsInput.Text,
        Actions_Proposed: Value(ActionsProposedInput.Text),
        Writeback_Rows: Value(WritebackRowsInput.Text),
        Drift_Detected: {Value: If(DriftToggle.Value, "Yes", "No")},
        Drift_Count: If(DriftToggle.Value, Value(DriftCountInput.Text), 0),
        Canon_Violations: Value(CanonViolationsInput.Text),
        Duration_Seconds: Value(DurationInput.Text),
        Status: {Value: "Complete"},
        Notes: NotesInput.Text
    }
);

// Show success notification
Notify("Run " & varNewRunID & " submitted successfully", NotificationType.Success);

// Navigate to RunHistory
Navigate(RunHistory, ScreenTransition.None)

// === After Submit: Reset Form ===
// Put in UseCapability.OnVisible or after Navigate
Reset(PlatformDropdown);
Reset(FindingsInput);
Reset(DriftToggle)
